<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan Preview</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background: #f8f9fa;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }

        .preview-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow-x: hidden;
        }

        @media (min-width: 768px) {
            .preview-container {
                padding: 40px;
            }
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .close-preview-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
        .theme-toggle-btn, .audio-toggle-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .theme-toggle-btn:hover, .audio-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .theme-toggle-btn:active, .audio-toggle-btn:active {
            transform: translateY(0);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a202c;
        }
        body.dark-mode .preview-container {
            background: #2d3748;
            color: #e2e8f0;
        }
        body.dark-mode .preview-header {
            border-bottom-color: #4a5568;
        }
        body.dark-mode .preview-header h1 {
            color: #f7fafc;
        }
        body.dark-mode .lesson-section {
            background: #374151;
            border-color: #4a5568;
        }
        body.dark-mode .section-title {
            background: linear-gradient(135deg, #374151, #4a5568);
            color: #f7fafc;
        }
        body.dark-mode .section-content {
            color: #e2e8f0;
        }
        body.dark-mode .table-section {
            background: linear-gradient(135deg, #2d3748, #374151);
        }
        body.dark-mode .table-section table {
            background: #374151;
            color: #e2e8f0;
        }
        body.dark-mode .table-section th {
            background: #4a5568;
        }
        body.dark-mode .table-section td {
            border-color: #4a5568;
        }
        body.dark-mode .image-text-carousel {
            background: linear-gradient(135deg, #4a5568, #5a6c7d);
        }

        .lesson-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Enhanced CSS for Lesson Preview Page */
.lesson-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
    border-radius: 12px 12px 0 0;
    margin-bottom: 0;
}

.lesson-header h1 {
    margin: 0 0 15px 0;
    font-size: 2.2rem;
    font-weight: 700;
}

.lesson-meta {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.meta-item {
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.lesson-section {
    margin-bottom: 35px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    border: 1px solid #e9ecef;
}

.section-title {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    color: #2c3e50;
    margin: 0;
    padding: 20px 25px;
    font-size: 1.4rem;
    font-weight: 600;
    border-bottom: 2px solid #3498db;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-content {
    padding: 25px;
    line-height: 1.7;
}

.objectives-list {
    list-style: none;
    padding: 0;
}

.objectives-list li {
    background: #f0f8ff;
    margin: 10px 0;
    padding: 15px 20px;
    border-radius: 8px;
    border-left: 4px solid #3498db;
    position: relative;
}

.objectives-list li:before {
    content: "‚úì";
    color: #27ae60;
    font-weight: bold;
    position: absolute;
    left: -15px;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #27ae60;
    font-size: 0.8rem;
}

.inspirational-quote {
    background: linear-gradient(135deg, #f3e5f5, #e1bee7);
    border: none;
    border-left: 5px solid #9c27b0;
    margin: 0;
    padding: 25px;
    font-style: italic;
    font-size: 1.2rem;
    text-align: center;
    border-radius: 8px;
    position: relative;
    color: #4a148c;
}

.inspirational-quote:before {
    content: """;
    font-size: 4rem;
    position: absolute;
    top: -10px;
    left: 20px;
    color: #9c27b0;
    opacity: 0.3;
}

.math-formula {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    padding: 20px;
    border-radius: 10px;
    margin: 15px 0;
    border: 2px solid #e0e0e0;
    text-align: center;
    font-size: 1.3rem;
    font-family: 'Times New Roman', serif;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
}

.math-formula:before {
    content: "üìê";
    position: absolute;
    top: -10px;
    left: 20px;
    background: white;
    padding: 0 10px;
    font-size: 1.2rem;
}

.step-by-step-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 0;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
}

.step-item {
    background: white;
    border-bottom: 2px solid #e9ecef;
    position: relative;
}

.step-item:last-child {
    border-bottom: none;
}

.step-header {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 15px 25px;
    display: flex;
    align-items: center;
}

.step-number {
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

.step-content {
    padding: 25px;
}

.step-text {
    margin-bottom: 10px;
    font-size: 1.05rem;
    line-height: 1.6;
}

.step-answer-preview {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
}

.step-answer-preview strong {
    color: #856404;
    display: block;
    margin-bottom: 8px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.worked-example {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 2px solid #ffc107;
    padding: 25px;
    border-radius: 12px;
    margin: 20px 0;
    position: relative;
    box-shadow: 0 4px 12px rgba(255,193,7,0.2);
}

.worked-example:before {
    content: "üí°";
    position: absolute;
    top: -15px;
    left: 20px;
    background: #ffc107;
    padding: 8px 12px;
    border-radius: 50%;
    font-size: 1.2rem;
}

.worked-example h4 {
    color: #856404;
    margin-bottom: 15px;
    font-size: 1.3rem;
    margin-top: 10px;
}

.example-content {
    background: rgba(255,255,255,0.8);
    padding: 20px;
    border-radius: 8px;
    line-height: 1.8;
    border: 1px solid rgba(255,193,7,0.3);
}

.graphs-container {
    display: grid;
    gap: 30px;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
}

.graph-container {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.graph-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.graph-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    color: #6c757d;
    font-size: 1.1rem;
}

.graph-info h4 {
    color: #3498db;
    margin: 15px 0 10px 0;
    font-size: 1.2rem;
}

.graph-info p {
    color: #6c757d;
    line-height: 1.6;
    margin: 0;
}

.practice-problems {
    background: #f0f8ff;
    border-radius: 12px;
    padding: 0;
    margin: 20px 0;
    overflow: hidden;
}

.problem {
    background: white;
    margin: 15px;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #27ae60;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    line-height: 1.6;
}

.problem strong {
    color: #27ae60;
    display: block;
    margin-bottom: 10px;
    font-size: 1.05rem;
}

.real-world-content,
.assessment-content {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #17a2b8;
    line-height: 1.7;
}

.fun-facts {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #4caf50;
}

.fun-facts ul {
    list-style: none;
    padding: 0;
}

.fun-facts li {
    background: white;
    margin: 10px 0;
    padding: 15px;
    border-radius: 8px;
    position: relative;
    padding-left: 45px;
}

.fun-facts li:before {
    content: "üåü";
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
}

.visual-aids {
    background: #f0f4f8;
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #3498db;
}

.visual-aids ul {
    list-style: none;
    padding: 0;
}

.visual-aids li {
    background: white;
    margin: 10px 0;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #3498db;
    position: relative;
    padding-left: 45px;
}

.visual-aids li:before {
    content: "üëÅÔ∏è";
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
}

.evaluation-preview {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border: 2px solid #2196f3;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
}

.evaluation-preview strong {
    color: #1976d2;
    font-size: 1.2rem;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .lesson-meta {
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }

    .section-content {
        padding: 10px 5px;
    }
    
    .graphs-container {
        grid-template-columns: 1fr;
    }
    
    .graph-container {
        padding: 15px;
    }
    
    .step-header {
        padding: 15px 20px;
    }
    
    .step-content {
        padding: 20px 15px;
    }
}

/* ============================================
   MOBILE RESPONSIVE FIXES
   ============================================ */

/* Base responsive adjustments */
@media (max-width: 768px) {
    body {
        padding: 5px;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }

    .lesson-section {
        padding: 10px 5px;
    }

    * {
        -webkit-tap-highlight-color: rgba(0,0,0,0);
        -webkit-touch-callout: none;
    }

    .preview-container {
        padding: 15px;
        margin: 0;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* FIXED: Compact header for mobile */
    .preview-header {
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 10px;
        gap: 15px;
    }

    .preview-header h1 {
        font-size: 1.3rem;
        margin: 0;
        width: 100%;
    }

    /* Mobile button group styling */
    .preview-header > div {
        width: 100%;
        justify-content: space-between;
        flex-wrap: nowrap;
    }

    .theme-toggle-btn, .audio-toggle-btn {
        padding: 12px;
        font-size: 1.1em;
        min-width: 45px;
        min-height: 45px;
    }

    .close-preview-btn {
        padding: 10px 16px;
        font-size: 0.85rem;
        white-space: nowrap;
    }
    
    /* FIXED: Compact lesson header */
    .lesson-header {
        padding: 20px 15px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }
    
    .lesson-header h1 {
        font-size: 1.5rem;
        margin-bottom: 12px;
        line-height: 1.3;
    }
    
    .lesson-meta {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
        margin-top: 12px;
    }
    
    .meta-item {
        padding: 6px 12px;
        font-size: 0.8rem;
        width: auto;
    }
    
    /* Section styling */
    .lesson-section {
        margin-bottom: 20px;
        border-radius: 8px;
    }
    
    .section-title {
        padding: 15px 18px;
        font-size: 1.1rem;
    }
    
    .section-content {
        padding: 8px 5px;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    
    /* FIXED: Image Carousel - Full Width & Proper Size */
    .image-carousel-container {
        padding: 15px 10px !important;
        margin: 20px 0 !important;
        border-radius: 8px !important;
    }
    
    .carousel-slide {
        padding: 15px 10px !important;
        min-height: 250px !important;
    }
    
    .carousel-slide img {
        max-width: 100% !important;
        max-height: 300px !important;
        width: auto !important;
        height: auto !important;
        object-fit: contain !important;
        margin: 0 auto !important;
        display: block !important;
    }
    
    /* FIXED: Navigation buttons - proper size and positioning */
    .image-carousel-container button {
        width: 45px !important;
        height: 45px !important;
        font-size: 1.2rem !important;
        border-radius: 50% !important;
        background: rgba(33, 150, 243, 0.95) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }
    
    .image-carousel-container button:active {
        transform: translateY(-50%) scale(0.95) !important;
    }
    
    /* Carousel header adjustments */
    .image-carousel-container > div:first-child {
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    /* Carousel counter */
    .image-carousel-container [id$="-counter"] {
        padding: 3px 10px;
        font-size: 0.8rem;
    }
    
    /* Carousel dots */
    .carousel-dot {
        width: 10px !important;
        height: 10px !important;
    }
    
    /* FIXED: YouTube Video - Full Width & Embedded Playback */
    .video-embed-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        background: #000;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .video-embed-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        border: 0;
        border-radius: 8px;
    }
    
    /* Graphs */
    .graphs-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .graph-container {
        padding: 15px;
    }
    
    .graph-container img {
        max-width: 100%;
        height: auto;
    }
    
    /* Step by step */
    .step-by-step-container {
        padding: 0;
        margin: 15px 0;
    }
    
    .step-header {
        padding: 12px 18px;
        font-size: 0.9rem;
    }
    
    .step-content {
        padding: 18px 15px;
        font-size: 0.9rem;
    }
    
    .step-text {
        font-size: 0.95rem;
        margin-bottom: 8px;
    }
    
    /* Worked examples */
    .worked-example {
        padding: 18px 15px;
        margin: 15px 0;
    }
    
    .worked-example h4 {
        font-size: 1.1rem;
        margin-bottom: 12px;
    }
    
    .example-content {
        padding: 15px;
        font-size: 0.9rem;
    }
    
    /* Math formulas */
    .math-formula {
        padding: 15px;
        margin: 12px 0;
        font-size: 1.1rem;
    }
    
    /* Objectives list */
    .objectives-list li {
        padding: 12px 15px;
        margin: 8px 0;
        font-size: 0.9rem;
    }
    
    /* Practice problems */
    .practice-problems {
        padding: 0;
    }
    
    .problem {
        margin: 12px;
        padding: 15px;
        font-size: 0.9rem;
    }
    
    /* Inspirational quote */
    .inspirational-quote {
        padding: 20px 15px;
        font-size: 1rem;
    }
    
    .inspirational-quote:before {
        font-size: 3rem;
        top: -5px;
        left: 10px;
    }
    
    /* Fun facts */
    .fun-facts li {
        padding: 12px 15px;
        padding-left: 40px;
        margin: 8px 0;
        font-size: 0.9rem;
    }
    
    /* Visual aids */
    .visual-aids li {
        padding: 12px 15px;
        padding-left: 40px;
        margin: 8px 0;
        font-size: 0.9rem;
    }
    
    /* Quiz sections */
    .quiz-question {
        margin-bottom: 15px;
    }
    
    .quiz-question > div:first-child {
        font-size: 1rem;
        padding: 12px;
    }
    
    .quiz-options label {
        padding: 10px 12px;
        margin: 6px 0;
        font-size: 0.9rem;
    }
    
    /* Quiz buttons */
    .quiz-question button {
        padding: 10px 18px;
        font-size: 0.9rem;
    }
    
    /* Spinner */
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
}

/* Extra small devices */
@media (max-width: 480px) {
    body {
        padding: 5px;
    }
    
    .preview-container {
        padding: 10px;
        border-radius: 8px;
    }
    
    .lesson-header h1 {
        font-size: 1.3rem;
    }
    
    .section-title {
        font-size: 1rem;
        padding: 12px 15px;
    }
    
    .section-content {
        padding: 15px 12px;
        font-size: 0.9rem;
    }
    
    .carousel-slide img {
        max-height: 250px !important;
    }
    
    .image-carousel-container button {
        width: 40px !important;
        height: 40px !important;
        font-size: 1rem !important;
    }
}

/* VIDEO FIXES - Desktop and Mobile */

/* Base video container */
.video-embed-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
    max-width: 100%;
    background: #000;
    border-radius: 12px;
    margin: 20px auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.video-embed-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
    border-radius: 12px;
}

/* DESKTOP: Constrain video width */
@media (min-width: 769px) {
    .video-embed-container {
        max-width: 800px; /* Limit maximum width on desktop */
        margin: 30px auto; /* Center it */
    }
    
    /* For videos in sections */
    .section-content .video-embed-container {
        max-width: 100%;
        margin: 20px 0;
    }
}

/* MOBILE: Full width responsive */
@media (max-width: 768px) {
    .video-embed-container {
        margin: 15px 0;
        border-radius: 8px;
        max-width: 100%;
    }
    
    .video-embed-container iframe {
        border-radius: 8px;
    }
}

/* Extra small devices */
@media (max-width: 480px) {
    .video-embed-container {
        margin: 12px 0;
        border-radius: 6px;
    }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.video-quiz-tab {
    transition: all 0.3s ease;
}

.video-quiz-tab:hover {
    transform: translateY(-2px);
}
    </style>
    <style>
/* Mobile-Optimized Image & Text Slideshow */
/* ============================================
   MOBILE IMAGE & TEXT CAROUSEL - FULL WIDTH FIX
   ============================================ */

/* Reset all constraining widths */
.image-text-carousel {
    width: 100% !important;
    max-width: 100% !important;
    margin: 20px 0 !important;
    padding: 0 !important;
    box-sizing: border-box;
}

.image-text-carousel * {
    box-sizing: border-box;
}

/* Carousel main container */
.image-text-carousel > div[style*="position: relative"] {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Image-only styles */
.image-only {
    width: 100% !important;
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
    margin: 0 auto !important;
    border-radius: 6px !important;
    background: #f9fafb !important;
    padding: 15px !important;
    box-sizing: border-box !important;
}

/* Text-only styles - Match section-content width */
.text-only {
    width: 100% !important;
    max-width: 100% !important;
    padding: 25px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    background: #f9fafb !important;
    border-radius: 6px !important;
    font-size: 1em !important;
    line-height: 1.7 !important;
    color: #374151 !important;
    text-align: left !important;
    white-space: normal !important;
    word-break: normal !important;
    overflow-wrap: break-word !important;
    hyphens: auto !important;
}

/* Mobile breakpoint */
@media (max-width: 768px) {
    .image-text-carousel {
        padding: 0 !important;
        margin: 15px 0 !important;
        border-radius: 8px !important;
    }

    /* Counter positioning */
    .image-text-carousel > div:first-child {
        padding: 0 5px 8px !important;
    }

    /* Image-only mobile styles */
    .image-only {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        padding: 5px !important;
    }

    /* Text-only mobile styles */
    .text-only {
        width: 100% !important;
        padding: 15px 5px !important;
        background: #f9fafb !important;
        border-radius: 6px !important;
        margin: 0 !important;
        line-height: 1.7 !important;
    }

    /* Navigation buttons */
    .carousel-nav-btn {
        width: 45px !important;
        height: 45px !important;
        font-size: 1.3rem !important;
        background: rgba(0, 0, 0, 0.6) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
    }

    .carousel-dot {
        width: 10px !important;
        height: 10px !important;
    }
}

@media (max-width: 480px) {
    .carousel-slide-content > div:last-child {
        padding: 15px 10px !important;
    }

    .carousel-slide-content > div:last-child > div {
        padding: 12px !important;
        font-size: 0.95em !important;
    }

    .carousel-nav-btn {
        width: 40px !important;
        height: 40px !important;
    }
}

/* Prevent overflow */
.image-text-carousel,
.image-text-carousel *:not(img) {
    overflow-wrap: break-word !important;
    word-wrap: break-word !important;
}

/* Story Carousel Wrapper Styles */
.story-carousel-wrapper {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 15px !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
}

.story-carousel-wrapper * {
    box-sizing: border-box !important;
}

.story-carousel-wrapper .image-text-carousel {
    width: 100% !important;
    max-width: 100% !important;
}

.story-carousel-wrapper .carousel-nav-btn {
    background: rgba(146, 64, 14, 0.8) !important;
}

.story-carousel-wrapper .carousel-dot {
    background: #d1d5db !important;
}

.story-carousel-wrapper .carousel-dot:hover {
    transform: scale(1.2) !important;
}

/* Mobile styles for story carousel */
@media (max-width: 768px) {
    .story-carousel-wrapper {
        padding: 10px !important;
        margin: 0 !important;
    }

    .story-sound-toggle {
        top: 10px !important;
        right: 10px !important;
        padding: 8px 12px !important;
        font-size: 1em !important;
    }
}

/* Ensure all sections don't overflow */
.lesson-section {
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
}

.section-content {
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
}

/* ============================================
   MOBILE RESPONSIVE FIXES FOR TABLE & FLOWCHART
   ============================================ */

/* Myth vs Reality Table - Mobile Responsive */
.myth-table-wrapper {
    position: relative;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    margin: 0 -20px;
    padding: 0 20px;
}

/* Scroll indicators (gradient fade at edges) */
.myth-table-wrapper::before,
.myth-table-wrapper::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 40px;
    pointer-events: none;
    z-index: 2;
    transition: opacity 0.3s ease;
}

.myth-table-wrapper::before {
    left: 0;
    background: linear-gradient(to right, rgba(255,255,255,0.9), transparent);
}

.myth-table-wrapper::after {
    right: 0;
    background: linear-gradient(to left, rgba(255,255,255,0.9), transparent);
}

body.dark-mode .myth-table-wrapper::before {
    background: linear-gradient(to right, rgba(45,55,72,0.9), transparent);
}

body.dark-mode .myth-table-wrapper::after {
    background: linear-gradient(to left, rgba(45,55,72,0.9), transparent);
}

/* Scroll hint indicator */
.scroll-hint {
    display: none;
    text-align: center;
    margin-top: 10px;
    color: #667eea;
    font-size: 14px;
    font-weight: 600;
    animation: bounce 2s infinite;
}

.scroll-hint-mobile {
    display: none;
}

.scroll-hint-desktop {
    display: inline;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateX(0); }
    40% { transform: translateX(10px); }
    60% { transform: translateX(5px); }
}

/* HTW Flowchart - Mobile Responsive Container */
.htw-scroll-container {
    position: relative;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    scroll-snap-type: x proximity;
}

.htw-scroll-container::-webkit-scrollbar {
    height: 8px;
}

.htw-scroll-container::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
}

.htw-scroll-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
}

/* Navigation dots for flowchart */
.htw-nav-dots {
    display: none;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
    padding: 10px;
}

.htw-nav-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ccc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.htw-nav-dot.active {
    background: #667eea;
    transform: scale(1.3);
}

/* Mobile breakpoint: max-width 768px */
@media (max-width: 768px) {
    /* Table mobile styles - optimized for 3-column view */
    .myth-table-wrapper {
        margin: 0 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }

    /* Mobile scroll hint - show mobile version */
    .scroll-hint {
        display: block;
    }

    .scroll-hint-desktop {
        display: none !important;
    }

    .scroll-hint-mobile {
        display: inline !important;
    }

    /* Flowchart mobile styles - Horizontal Scrolling Solution */
    .htw-flowchart {
        padding: 20px 10px !important;
        margin: 0 -15px !important;
        border-radius: 12px !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        position: relative;
        /* Enable touch scrolling - remove restrictive touch-action */
    }

    /* Inner white container maintains desktop width for horizontal scrolling */
    .htw-flowchart > div[style*="background: white"] {
        padding: 30px !important;
        min-width: 1200px !important;
        width: max-content;
    }

    .htw-flowchart h3 {
        font-size: 22px !important;
        margin-bottom: 25px !important;
    }

    /* Preserve horizontal flex layouts - NEVER stack vertically */
    .htw-flowchart [style*="display: flex"][style*="justify-content: space-around"] {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        justify-content: space-around !important;
    }

    .htw-flowchart [style*="display: flex"][style*="align-items: center"]:not([style*="flex-direction: column"]) {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
    }

    /* Fix vertical arrow connectors - ensure perfect centering */
    .htw-flowchart > div > div > div[style*="position: relative"][style*="width: 3px"] {
        display: block !important;
        width: 3px !important;
        height: 30px !important;
        margin-left: auto !important;
        margin-right: auto !important;
        position: relative !important;
    }

    /* Fix arrow heads - precise centering */
    .htw-flowchart > div > div > div[style*="position: relative"][style*="width: 3px"] > div {
        position: absolute !important;
        bottom: -8px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        margin: 0 !important;
    }

    /* Keep horizontal arrows visible and properly styled */
    .htw-flowchart [style*="font-size: 24px"][style*="color: #667eea"] {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-width: 30px !important;
    }

    /* Scroll indicator for mobile users */
    .htw-flowchart::after {
        content: "‚Üê Swipe to explore ‚Üí";
        position: sticky;
        left: 50%;
        transform: translateX(-50%);
        bottom: 15px;
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.9em;
        font-weight: 600;
        white-space: nowrap;
        pointer-events: none !important;
        opacity: 0.9;
        display: block;
        text-align: center;
        margin-top: 20px;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% {
            opacity: 0.9;
            transform: translateX(-50%) scale(1);
        }
        50% {
            opacity: 1;
            transform: translateX(-50%) scale(1.05);
        }
    }

    /* Ensure sub-sections maintain their flex properties */
    .htw-flowchart [style*="flex: 1"][style*="min-width: 280px"] {
        flex: 1 !important;
        min-width: 280px !important;
    }

    .htw-nav-dots {
        display: flex;
    }

    /* Position HTW quiz button below swipe indicator on mobile */
    .htw-quiz-button {
        margin-top: 60px !important; /* Add space below the swipe indicator */
        font-size: 14px !important;
        padding: 12px 20px !important;
    }
}

/* Small mobile breakpoint: max-width 480px */
@media (max-width: 480px) {
    /* Table extra small mobile styles - inherits from inline styles */
    .myth-table-wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Flowchart extra small mobile styles - maintain horizontal scroll */
    .htw-flowchart {
        padding: 15px 5px !important;
        margin: 0 -10px !important;
    }

    .htw-flowchart > div[style*="background: white"] {
        padding: 20px !important;
        min-width: 1100px !important;
    }

    .htw-flowchart h3 {
        font-size: 18px !important;
        margin-bottom: 20px !important;
    }

    /* Smaller scroll indicator for very small screens */
    .htw-flowchart::after {
        font-size: 0.8em !important;
        padding: 8px 16px !important;
    }
}

/* Tablet breakpoint: 769px - 1024px */
@media (min-width: 769px) and (max-width: 1024px) {
    .myth-display-table th,
    .myth-display-table td {
        padding: 12px;
        font-size: 13px;
    }

    .htw-flowchart [style*="width: 350px"] {
        width: 300px !important;
        height: 120px !important;
    }

    .htw-flowchart [style*="width: 400px"] {
        width: 350px !important;
    }

    .htw-flowchart [style*="width: 600px"] {
        width: 500px !important;
    }
}

/* Touch gesture support */
@media (hover: none) and (pointer: coarse) {
    /* Optimize for touch devices */
    .myth-table-wrapper,
    .htw-scroll-container {
        scroll-snap-type: x mandatory;
        scroll-padding: 20px;
    }

    .myth-display-table th {
        user-select: none;
        -webkit-user-select: none;
    }

    /* Larger touch targets */
    .htw-nav-dot {
        width: 12px;
        height: 12px;
        padding: 4px;
    }
}

/* Accessibility: Ensure keyboard navigation works */
.myth-table-wrapper:focus-within,
.htw-scroll-container:focus-within {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* Smooth transitions for better UX */
.myth-display-table,
.htw-flowchart > div > div {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* GPU acceleration for better performance */
.myth-table-wrapper,
.htw-scroll-container,
.myth-display-table,
.htw-flowchart {
    transform: translateZ(0);
    will-change: scroll-position;
}

/* Loading state for images in flowchart */
.htw-flowchart img {
    max-width: 100%;
    height: auto;
}

/* Current vs Future State - Scroll container */
.cf-scroll-container {
    position: relative;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    scroll-snap-type: x proximity;
}

.cf-scroll-container::-webkit-scrollbar {
    height: 8px;
}

.cf-scroll-container::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
}

.cf-scroll-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #4F7AF7 0%, #8B5CF6 100%);
    border-radius: 4px;
}

/* Navigation dots for current-future */
.cf-nav-dots {
    display: none;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
    padding: 10px;
}

.cf-nav-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ccc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.cf-nav-dot.active {
    background: #4F7AF7;
    transform: scale(1.3);
}

/* Mobile responsive styles for Current vs Future State section */
@media (max-width: 768px) {
    .current-future-section {
        padding: 20px 0 !important;
        margin: 20px 0 !important;
        max-width: 100% !important;
        overflow-x: auto !important;
        overflow-y: visible !important;
        -webkit-overflow-scrolling: touch !important;
        scroll-behavior: smooth !important;
        scroll-snap-type: x proximity !important;
    }

    .current-future-section::-webkit-scrollbar {
        height: 8px;
    }

    .current-future-section::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 4px;
    }

    .current-future-section::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #4F7AF7 0%, #8B5CF6 100%);
        border-radius: 4px;
    }

    /* Force horizontal scroll by setting min-width */
    .current-future-section > div {
        padding: 20px 15px !important;
        min-width: 1000px !important;
    }

    /* Keep diagram horizontal on mobile */
    .cf-diagram {
        flex-direction: row !important;
        gap: 0 !important;
        min-height: 200px !important;
    }

    /* Maintain desktop box sizes for horizontal scroll */
    .cf-current-box,
    .cf-future-box {
        width: 300px !important;
        height: 140px !important;
        font-size: 1.3em !important;
    }

    .cf-gap-circle {
        width: 180px !important;
        height: 180px !important;
        font-size: 1.6em !important;
    }

    /* Keep arrows visible on mobile */
    .cf-diagram > div[style*="flex: 1"] {
        display: block !important;
        flex: 0.3 !important;
    }

    /* Keep content in 3 columns for horizontal scroll */
    .cf-content {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 30px !important;
        margin-bottom: 40px !important;
        min-width: 1000px !important;
    }

    /* Keep status boxes in 2 columns for horizontal scroll */
    .cf-status-boxes {
        grid-template-columns: 1fr 1fr !important;
        gap: 30px !important;
        min-width: 1000px !important;
    }

    .cf-current-status,
    .cf-target-status {
        min-height: 160px !important;
        padding: 30px !important;
    }

    .cf-current-status h3,
    .cf-target-status h3 {
        font-size: 1.4em !important;
        margin-bottom: 15px !important;
    }

    .cf-current-status p,
    .cf-target-status p {
        font-size: 1em !important;
    }

    /* Show navigation dots on mobile */
    .cf-nav-dots {
        display: flex;
    }
}

/* Touch gesture support for current-future */
@media (hover: none) and (pointer: coarse) {
    .current-future-section {
        scroll-snap-type: x mandatory !important;
        scroll-padding: 20px !important;
    }

    .cf-nav-dot {
        width: 12px;
        height: 12px;
        padding: 4px;
    }
}

</style>
</head>
<body>
    <div class="preview-container" id="preview-container">
        <div class="preview-header">
            <h1>Lesson Plan Preview</h1>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button onclick="toggleTheme()" class="theme-toggle-btn" id="theme-toggle" title="Toggle Dark/Light Mode">
                    <span id="theme-icon">üåô</span>
                </button>
                <button onclick="toggleAudioMode()" class="audio-toggle-btn" id="audio-toggle" title="Toggle Audio Mode">
                    <span id="audio-icon">üîä</span>
                </button>
                <button onclick="window.close()" class="close-preview-btn">Close Preview</button>
            </div>
        </div>
        <div id="lesson-content">
            <div>Loading lesson plan...</div>
        </div>
    </div>
    
    
       <script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const lessonId = urlParams.get('id');
    
    if (!lessonId) {
        document.getElementById('lesson-content').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #e74c3c;">' +
            '<h3>No Lesson Plan ID</h3>' +
            '<p>Please provide a valid lesson plan ID in the URL</p>' +
            '</div>';
        return;
    }
    
    // Load lesson preview - NO auth check required
    loadLessonPreview(lessonId);

    // Initialize theme from localStorage
    const savedTheme = localStorage.getItem('lesson-theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
    }
});

// Theme toggle function
function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('theme-icon');

    body.classList.toggle('dark-mode');

    if (body.classList.contains('dark-mode')) {
        themeIcon.textContent = '‚òÄÔ∏è';
        localStorage.setItem('lesson-theme', 'dark');
    } else {
        themeIcon.textContent = 'üåô';
        localStorage.setItem('lesson-theme', 'light');
    }
}

// Audio mode toggle and text-to-speech
let audioMode = false;
let currentSpeech = null;

function toggleAudioMode() {
    audioMode = !audioMode;
    const audioIcon = document.getElementById('audio-icon');
    const audioToggle = document.getElementById('audio-toggle');

    if (audioMode) {
        audioIcon.textContent = 'üîá';
        audioToggle.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
        speakLessonContent();
    } else {
        audioIcon.textContent = 'üîä';
        audioToggle.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
        stopSpeech();
    }
}

function speakLessonContent() {
    if (!('speechSynthesis' in window)) {
        alert('Sorry, your browser does not support text-to-speech');
        audioMode = false;
        return;
    }

    stopSpeech();

    // Get all text content from lesson sections
    const lessonContent = document.getElementById('lesson-content');
    const sections = lessonContent.querySelectorAll('.section-content');

    let textToSpeak = '';
    sections.forEach((section, index) => {
        const sectionTitle = section.previousElementSibling?.textContent || '';
        textToSpeak += sectionTitle + '. ' + section.textContent.trim() + '. ';
    });

    if (textToSpeak) {
        currentSpeech = new SpeechSynthesisUtterance(textToSpeak);
        currentSpeech.rate = 0.9;
        currentSpeech.pitch = 1;
        currentSpeech.volume = 1;

        currentSpeech.onend = function() {
            audioMode = false;
            document.getElementById('audio-icon').textContent = 'üîä';
            document.getElementById('audio-toggle').style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
        };

        window.speechSynthesis.speak(currentSpeech);
    }
}

function stopSpeech() {
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
}

window.quizInstances = window.quizInstances || {};
function getAuthToken() {
    // Try to get token, but return null if not found (won't block access)
    return localStorage.getItem('token') || 
           sessionStorage.getItem('token') || 
           getCookie('token') || 
           null;  // Return null instead of redirecting
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function loadLessonPreview(lessonId) {
    const token = getAuthToken();
    
    // NO authentication check - allow anonymous access
    console.log('Loading lesson preview (public access):', lessonId);
    console.log('Token present:', token ? 'Yes' : 'No');
    
    document.getElementById('lesson-content').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Loading lesson plan...</p></div>';
    
    // Build headers - include token only if available
    const headers = {
        'Content-Type': 'application/json'
    };
    
    if (token) {
        headers['Authorization'] = 'Bearer ' + token;
        console.log('Using authenticated request');
    } else {
        console.log('Using anonymous request');
    }
    
    fetch('/api/lesson-preview/' + lessonId, {
        headers: headers
    })
    .then(function(response) {
        console.log('Response status:', response.status);
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('Lesson plan not found');
            }
            throw new Error('Server error: ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        console.log('Data received:', data);
        if (data.error) {
            throw new Error(data.error);
        }
        
        // CRITICAL: Check if data is valid
        if (!data || typeof data !== 'object') {
            throw new Error('Invalid data received from server');
        }
        
        console.log('Calling displayLessonPreviewComplete...');
        displayLessonPreviewComplete(data);
        console.log('displayLessonPreviewComplete completed');
    })
    .catch(function(error) {
        console.error('Error loading preview:', error);
        document.getElementById('lesson-content').innerHTML = 
            '<div style="color: #e74c3c; padding: 40px; text-align: center; background: white; border-radius: 12px; margin: 20px;">' +
            '<div style="font-size: 3em; margin-bottom: 20px;">‚ùå</div>' +
            '<h3>Error Loading Lesson Plan</h3>' +
            '<p style="margin: 20px 0; color: #666;">' + error.message + '</p>' +
            '<button onclick="loadLessonPreview(\'' + lessonId + '\')" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1em;">üîÑ Try Again</button>' +
            '</div>';
    });
}

// Add this function near the top of your script section, before other functions
function normalizeImageUrl(url) {
    if (!url) {
        console.warn('‚ö†Ô∏è normalizeImageUrl received empty URL');
        return '';
    }

    console.log('üîç [IMAGE DEBUG] Normalizing image URL:', url);

    // Already absolute URL (http/https)
    if (url.startsWith('http://') || url.startsWith('https://')) {
        console.log('‚úÖ Already absolute:', url);
        return url;
    }

    // CRITICAL FIX: Check if it's an S3 URL pattern first
    // Pattern: lesson_id_section_timestamp_hash.png
    const s3Pattern = /^[a-f0-9-]{36}_section_\d+_[a-f0-9]+\.(png|jpg|jpeg|gif|webp)$/i;

    if (s3Pattern.test(url) || url.includes('_section_')) {
        // This is an S3 stored image
        const s3Bucket = 'deciphersacad-lesson-images';
        const s3Region = 'eu-north-1';
        const s3Url = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/lesson_images/${url}`;
        console.log('‚úÖ S3 pattern detected, using S3 URL:', s3Url);
        return s3Url;
    }

    // S3 bucket path without https
    if (url.includes('.s3.') && url.includes('.amazonaws.com')) {
        const absoluteUrl = 'https://' + url;
        console.log('‚úÖ S3 URL converted:', absoluteUrl);
        return absoluteUrl;
    }

    // Starts with lesson_images/
    if (url.startsWith('lesson_images/')) {
        const s3Bucket = 'deciphersacad-lesson-images';
        const s3Region = 'eu-north-1';
        const absoluteUrl = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/${url}`;
        console.log('‚úÖ S3 lesson_images path:', absoluteUrl);
        return absoluteUrl;
    }

    // Starts with /static/
    if (url.startsWith('/static/')) {
        // Try S3 first for lesson images
        if (url.includes('lesson_images/')) {
            const filename = url.split('/').pop();
            if (s3Pattern.test(filename)) {
                const s3Bucket = 'deciphersacad-lesson-images';
                const s3Region = 'eu-north-1';
                const s3Url = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/lesson_images/${filename}`;
                console.log('‚úÖ Converting /static/ to S3:', s3Url);
                return s3Url;
            }
        }
        const absoluteUrl = window.location.origin + url;
        console.log('‚úÖ Converted /static/:', absoluteUrl);
        return absoluteUrl;
    }

    // Just filename - try S3 first
    if (!url.includes('/')) {
        if (s3Pattern.test(url)) {
            const s3Bucket = 'deciphersacad-lesson-images';
            const s3Region = 'eu-north-1';
            const s3Url = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/lesson_images/${url}`;
            console.log('‚úÖ Filename to S3:', s3Url);
            return s3Url;
        }
        const absoluteUrl = window.location.origin + '/static/lesson_images/' + url;
        console.log('‚úÖ Filename to local:', absoluteUrl);
        return absoluteUrl;
    }

    // Default: try S3
    const s3Bucket = 'deciphersacad-lesson-images';
    const s3Region = 'eu-north-1';
    const s3Url = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/lesson_images/${url}`;
    console.log('‚ö†Ô∏è Default S3 conversion:', s3Url);
    return s3Url;
}

// Enhanced image error handler with recovery
function handleImageLoadError(imgElement, originalUrl) {
    console.error('‚ùå [IMAGE DEBUG] Image failed to load:', originalUrl);
    console.error('‚ùå Current src:', imgElement.src);

    if (imgElement.dataset.attemptedRecovery === 'true') {
        console.error('‚ùå All recovery attempts failed');
        imgElement.outerHTML = `
            <div style="background: linear-gradient(135deg, #fee2e2, #fecaca);
                        border: 2px dashed #dc2626;
                        padding: 25px;
                        text-align: center;
                        border-radius: 8px;
                        color: #991b1b;
                        margin: 15px 0;">
                <div style="font-size: 2.5em; margin-bottom: 10px;">üì∑</div>
                <div style="font-weight: 600; margin-bottom: 8px;">Image Unavailable</div>
                <div style="font-size: 0.85em; color: #7f1d1d; word-break: break-all; max-width: 300px; margin: 0 auto;">
                    ${originalUrl.split('/').pop()}
                </div>
            </div>
        `;
        return;
    }

    const filename = originalUrl.split('/').pop().split('?')[0];
    const s3Pattern = /^[a-f0-9-]{36}_section_\d+_[a-f0-9]+\.(png|jpg|jpeg|gif|webp)$/i;

    if (s3Pattern.test(filename)) {
        const s3Bucket = 'deciphersacad-lesson-images';
        const s3Region = 'eu-north-1';
        const recoveryUrl = `https://${s3Bucket}.s3.${s3Region}.amazonaws.com/lesson_images/${filename}`;

        console.log('üîÑ [IMAGE DEBUG] Attempting S3 recovery:', recoveryUrl);
        imgElement.dataset.attemptedRecovery = 'true';
        imgElement.src = recoveryUrl;
    } else {
        const recoveryUrl = window.location.origin + '/static/lesson_images/' + filename;
        console.log('üîÑ [IMAGE DEBUG] Attempting local recovery:', recoveryUrl);
        imgElement.dataset.attemptedRecovery = 'true';
        imgElement.src = recoveryUrl;
    }
}

function formatMathNotation(text) {
    if (!text) return '';
    if (typeof text !== 'string') {
        if (Array.isArray(text)) {
            return text.map(function(item) { return formatMathNotation(item); }).join('<br>');
        }
        if (typeof text === 'object') {
            return JSON.stringify(text);
        }
        return String(text);
    }
    
    return text
        .replace(/\^2/g, '¬≤')
        .replace(/\^3/g, '¬≥')
        .replace(/\^4/g, '‚Å¥')
        .replace(/\^n/g, '‚Åø')
        .replace(/\^-1/g, '‚Åª¬π')
        .replace(/_1/g, '‚ÇÅ')
        .replace(/_2/g, '‚ÇÇ')
        .replace(/_n/g, '‚Çô')
        .replace(/\bpi\b/gi, 'œÄ')
        .replace(/\balpha\b/gi, 'Œ±')
        .replace(/\bbeta\b/gi, 'Œ≤')
        .replace(/\bgamma\b/gi, 'Œ≥')
        .replace(/\bdelta\b/gi, 'Œ¥')
        .replace(/\btheta\b/gi, 'Œ∏')
        .replace(/\+\/-/g, '¬±')
        .replace(/infinity/gi, '‚àû')
        .replace(/<=/g, '‚â§')
        .replace(/>=/g, '‚â•')
        .replace(/!=/g, '‚â†')
        .replace(/\*/g, '√ó')
        .replace(/sqrt/gi, '‚àö')
        .replace(/\bdeg\b/g, '¬∞')
        .replace(/m\^2/g, 'm¬≤')
        .replace(/m\^3/g, 'm¬≥')
        .replace(/cm\^2/g, 'cm¬≤')
        .replace(/s\^-1/g, 's‚Åª¬π');
}

function extractYouTubeId(url) {
    if (!url) return null;
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    var match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function extractQuizIdFromUrl(url) {
    if (!url) return null;
    
    console.log('üîç Extracting quiz ID from:', url);
    
    // If it's already just an ID (UUID format)
    var uuidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
    if (uuidPattern.test(url)) {
        console.log('‚úÖ Direct UUID match:', url);
        return url;
    }
    
    // Try to extract from URL query parameter
    try {
        var urlObj = new URL(url, window.location.origin);
        var id = urlObj.searchParams.get('id');
        if (id) {
            console.log('‚úÖ Extracted from query param:', id);
            return id;
        }
    } catch (e) {
        // Not a valid URL, continue with regex patterns
    }
    
    // Try various URL patterns
    var patterns = [
        /[?&]id=([a-f0-9-]{36})/i,
        /\/quiz\/([a-f0-9-]{36})/i,
        /\/quiz-page\/([a-f0-9-]{36})/i,
        /quiz[/-]([a-f0-9-]{36})/i,
        /([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i
    ];
    
    for (var i = 0; i < patterns.length; i++) {
        var match = url.match(patterns[i]);
        if (match && match[1]) {
            console.log('‚úÖ Extracted via pattern ' + i + ':', match[1]);
            return match[1];
        }
    }
    
    console.warn('‚ö†Ô∏è Could not extract quiz ID from:', url);
    return null;
}

function formatStepContentPreview(step) {
    if (!step) return '';
    
    var lines = step.split('\n').filter(function(line) { return line.trim(); });
    var content = '';
    
    lines.forEach(function(line) {
        var trimmedLine = line.trim();
        if (trimmedLine.toLowerCase().includes('answer:')) {
            var answer = trimmedLine.replace(/answer:\s*/i, '').trim();
            content += '<div class="step-answer-preview"><strong>Answer:</strong> ' + formatMathNotation(answer) + '</div>';
        } else {
            content += '<div class="step-text">' + formatMathNotation(trimmedLine) + '</div>';
        }
    });
    
    return content;
}

function loadGraphIntoContainer(graph, container) {
    var img = new Image();
    var loadingDiv = container.querySelector('.graph-loading');
    
    img.onload = function() {
        if (loadingDiv) loadingDiv.style.display = 'none';
        
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        img.style.marginBottom = '15px';
        
        var graphInfo = container.querySelector('.graph-info');
        container.insertBefore(img, graphInfo);
    };
    
    img.onerror = function() {
        if (loadingDiv) {
            loadingDiv.innerHTML = '<div style="color: #e74c3c; text-align: center;">Graph temporarily unavailable<br><small>Could not load: ' + graph.title + '</small></div>';
        }
    };
    
    img.src = graph.url;
}

function renderInteractiveQuiz(quizData, container) {
    var currentQuestion = 0;
    var userAnswers = {};
    var quizStartTime = Date.now();
    
    function renderQuestion() {
        var question = quizData.questions[currentQuestion];
        
        var html = '<div class="quiz-question" style="margin-bottom: 20px;">' +
            '<div style="font-size: 1.1em; font-weight: 600; margin-bottom: 15px;">' +
            '<span style="background: #10B981; color: white; padding: 4px 12px; border-radius: 4px; margin-right: 10px;">' +
            (currentQuestion + 1) + '/' + quizData.questions.length +
            '</span>' +
            question.text +
            '</div>' +
            '<div class="quiz-options">';
        
        if (question.type === 'paragraph') {
            var savedAnswer = userAnswers[currentQuestion] || '';
            html += '<textarea id="answer-' + currentQuestion + '" ' +
                'style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-height: 100px;" ' +
                'placeholder="Type your answer here..." ' +
                'onchange="window.quizInstances[\'' + quizData.id + '\'].saveAnswer(' + currentQuestion + ', this.value)">' +
                savedAnswer + '</textarea>';
        } else if (question.options) {
            question.options.forEach(function(option, index) {
                var checked = userAnswers[currentQuestion] === index ? 'checked' : '';
                html += '<label style="display: block; padding: 12px; margin: 8px 0; background: ' + (checked ? '#e8f5e9' : '#f8f9fa') + '; ' +
                    'border: 2px solid ' + (checked ? '#10B981' : '#e0e0e0') + '; border-radius: 8px; cursor: pointer;" ' +
                    'onclick="window.quizInstances[\'' + quizData.id + '\'].selectOption(' + currentQuestion + ', ' + index + ', this)">' +
                    '<input type="radio" name="q' + currentQuestion + '" value="' + index + '" ' + checked + ' style="margin-right: 10px;">' +
                    option.text +
                    '</label>';
            });
        }
        
        html += '</div>' +
            '<div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 10px;">' +
            '<button onclick="window.quizInstances[\'' + quizData.id + '\'].prevQuestion()" ' +
            (currentQuestion === 0 ? 'disabled' : '') +
            ' style="padding: 10px 20px; background: ' + (currentQuestion === 0 ? '#ccc' : '#95a5a6') + '; ' +
            'color: white; border: none; border-radius: 6px; cursor: ' + (currentQuestion === 0 ? 'not-allowed' : 'pointer') + ';">' +
            'Previous' +
            '</button>';
        
        if (currentQuestion < quizData.questions.length - 1) {
            html += '<button onclick="window.quizInstances[\'' + quizData.id + '\'].nextQuestion()" ' +
                'style="padding: 10px 20px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer;">' +
                'Next' +
                '</button>';
        } else {
            html += '<button onclick="window.quizInstances[\'' + quizData.id + '\'].submitQuiz()" ' +
                'style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">' +
                'Submit Quiz' +
                '</button>';
        }
        
        html += '</div></div>';
        container.innerHTML = html;
    }
    
    function submitQuizScore(quizId, score, maxScore, answers, timeTaken) {
        return fetch('/api/submit-quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                quiz_id: quizId,
                student_name: 'Preview User',
                score: score,
                max_score: maxScore,
                answers: answers,
                time_taken: timeTaken
            })
        }).then(function(response) { return response.json(); });
    }
    
    function generateAIFeedback(score, total, topic) {
        var percentage = (score / total) * 100;
        
        return fetch('/api/generate-quiz-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                score: score,
                total_questions: total,
                percentage: percentage,
                topic: topic
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) { return data.feedback; })
        .catch(function() {
            if (percentage >= 90) return "Outstanding performance! You've mastered this material.";
            if (percentage >= 70) return "Good work! You have a solid understanding with room for improvement.";
            if (percentage >= 50) return "You're making progress. Review the material and try again.";
            return "This topic needs more study. Don't give up - review and practice more.";
        });
    }
    
    function displayResults(score, total, percentage, feedback) {
        var html = '<div style="text-align: center; padding: 40px; background: white; border-radius: 8px;">' +
            '<div style="font-size: 3em; margin-bottom: 15px;">' +
            (percentage >= 80 ? 'üéâ' : percentage >= 60 ? 'üëç' : 'üìö') +
            '</div>' +
            '<h2 style="color: #10B981; margin-bottom: 10px;">Quiz Complete!</h2>' +
            '<p style="font-size: 1.2em; margin-bottom: 15px;">' +
            'Score: <strong style="color: ' + (percentage >= 80 ? '#10B981' : percentage >= 60 ? '#f59e0b' : '#e74c3c') + ';">' +
            score + '/' + total +
            '</strong></p>' +
            '<p style="font-size: 1.4em; font-weight: 600; color: ' + (percentage >= 80 ? '#10B981' : percentage >= 60 ? '#f59e0b' : '#e74c3c') + '; margin-bottom: 20px;">' +
            percentage + '%</p>';
        
        if (feedback) {
            html += '<div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3498db;">' +
                '<h3 style="color: #2c3e50; margin-bottom: 10px;">AI Feedback</h3>' +
                '<p style="color: #34495e; line-height: 1.6;">' + feedback + '</p>' +
                '</div>';
        }
        
        html += '<button onclick="location.reload()" ' +
            'style="margin-top: 20px; padding: 12px 24px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">' +
            'Try Again</button></div>';
        
        container.innerHTML = html;
    }
    
    return {
        saveAnswer: function(index, answer) {
            userAnswers[index] = answer;
        },
        
        selectOption: function(index, optionIndex, label) {
            userAnswers[index] = optionIndex;
            var labels = label.parentElement.querySelectorAll('label');
            labels.forEach(function(l) {
                l.style.background = '#f8f9fa';
                l.style.borderColor = '#e0e0e0';
            });
            label.style.background = '#e8f5e9';
            label.style.borderColor = '#10B981';
        },
        
        nextQuestion: function() {
            if (currentQuestion < quizData.questions.length - 1) {
                currentQuestion++;
                renderQuestion();
            }
        },
        
        prevQuestion: function() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        },
        
        submitQuiz: function() {
            var timeTaken = Math.floor((Date.now() - quizStartTime) / 1000);
            var score = 0;
            
            quizData.questions.forEach(function(question, index) {
                if (question.options && userAnswers[index] !== undefined) {
                    if (question.options[userAnswers[index]] && question.options[userAnswers[index]].isCorrect) {
                        score++;
                    }
                }
            });
            
            var percentage = Math.round((score / quizData.questions.length) * 100);
            
            submitQuizScore(quizData.id, score, quizData.questions.length, userAnswers, timeTaken)
                .then(function() {
                    return generateAIFeedback(score, quizData.questions.length, quizData.topic);
                })
                .then(function(feedback) {
                    displayResults(score, quizData.questions.length, percentage, feedback);
                })
                .catch(function(error) {
                    console.error('Submission error:', error);
                    displayResults(score, quizData.questions.length, percentage, null);
                });
        },
        
        init: function() {
            renderQuestion();
        }
    };
}

function formatCustomSectionContent(section) {
    var content = section.content;
    var type = section.type;
    
    if (!content) {
        return '<div style="color: #999; font-style: italic;">No content available</div>';
    }
    
    // TEXT CONTENT
    if (type === 'text' || type === 'ai_content') {
        return '<div class="text-content" style="line-height: 1.8; color: #374151;">' + 
               (typeof content === 'string' ? content : JSON.stringify(content)) + 
               '</div>';
    }
    
    // STORY SECTION
    if (type === 'story') {
        if (typeof content === 'object' && content.title) {
            const storyId = 'story-' + Math.random().toString(36).substr(2, 9);
            const slides = content.slides || [];
            const font = content.font || 'Georgia';
            const sound = content.sound || 'none';

            // Build carousel slides array
            let carouselSlides = [];

            // First slide: Book Cover with Author and Moral
            const coverSlide = {
                image: content.coverImage || '',
                text: `
                    <div style="font-family: ${font};">
                        <h2 style="color: #92400e; margin-bottom: 15px; font-size: 1.8em;">üìö ${content.title}</h2>
                        ${content.author ? `<p style="color: #78350f; font-style: italic; margin-bottom: 20px; font-size: 1.1em;">by ${content.author}</p>` : ''}
                        ${content.moral ? `
                            <div style="background: rgba(245, 158, 11, 0.2); padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b; margin-top: 20px;">
                                <strong style="color: #92400e; font-size: 1.1em;">üí° Moral of the Story:</strong>
                                <p style="color: #78350f; margin-top: 10px; font-style: italic; line-height: 1.6;">${content.moral}</p>
                            </div>
                        ` : ''}
                    </div>
                `
            };
            carouselSlides.push(coverSlide);

            // Add chapter slides
            slides.forEach((slide, index) => {
                carouselSlides.push({
                    image: slide.image_url || '',
                    text: slide.text ? `
                        <div style="font-family: ${font};">
                            <h4 style="color: #f59e0b; margin-bottom: 15px; font-size: 1.3em;">Chapter ${index + 1}</h4>
                            <p style="color: #1f2937; line-height: 1.8; font-size: 1.05em;">${slide.text}</p>
                        </div>
                    ` : `<h4 style="color: #f59e0b; font-family: ${font};">Chapter ${index + 1}</h4>`
                });
            });

            // Last slide: About Author (if exists)
            if (content.aboutAuthor) {
                carouselSlides.push({
                    image: '',
                    text: `
                        <div style="font-family: ${font};">
                            <h3 style="color: #92400e; margin-bottom: 15px; font-size: 1.5em;">‚úçÔ∏è About the Author</h3>
                            ${content.author ? `<h4 style="color: #78350f; margin-bottom: 10px;">${content.author}</h4>` : ''}
                            <p style="color: #1f2937; line-height: 1.8; font-size: 1.05em;">${content.aboutAuthor}</p>
                        </div>
                    `
                });
            }

            const totalSlides = carouselSlides.length;

            const storyHtml = `
                <div class="story-carousel-wrapper" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; position: relative;">
                    ${sound !== 'none' ? `
                        <button onclick="toggleStorySound('${storyId}')" class="story-sound-toggle" id="${storyId}_toggle"
                                style="position: absolute; top: 15px; right: 15px; background: rgba(245, 158, 11, 0.9); color: white; border: none; padding: 10px 15px; border-radius: 50%; cursor: pointer; font-size: 1.2em; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10;"
                                title="Click to play background sound">
                            <span id="${storyId}_icon">üîä</span>
                        </button>
                    ` : ''}

                    <div class="image-text-carousel" id="${storyId}" data-sound="${sound}">
                        ${totalSlides > 1 ? `
                            <div style="display: flex; justify-content: flex-end; padding: 0 10px 10px;">
                                <div id="${storyId}-counter" style="background: #92400e; color: white; padding: 6px 14px; border-radius: 14px; font-size: 0.9em; font-weight: 600;">
                                    1 / ${totalSlides}
                                </div>
                            </div>
                        ` : ''}

                        <div style="position: relative; background: white; border-radius: 12px; overflow: hidden; border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            ${carouselSlides.map((slide, index) => {
                                return `
                                    <div id="${storyId}-slide-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                                        ${slide.image && slide.image.trim() !== '' ? `
                                            <img class="image-only"
                                                 src="${slide.image}"
                                                 alt="${index === 0 ? 'Book Cover' : 'Chapter ' + index}"
                                                 onerror="this.style.display='none'">
                                        ` : ''}

                                        ${slide.text ? `
                                            <div class="text-only">
                                                ${slide.text}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}

                            ${totalSlides > 1 ? `
                                <button onclick="storyCarouselPrev('${storyId}', ${totalSlides})"
                                        class="carousel-nav-btn"
                                        style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(146, 64, 14, 0.8); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 100; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                                    ‚Üê
                                </button>
                                <button onclick="storyCarouselNext('${storyId}', ${totalSlides})"
                                        class="carousel-nav-btn"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(146, 64, 14, 0.8); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 100; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                                    ‚Üí
                                </button>
                            ` : ''}
                        </div>

                        ${totalSlides > 1 ? `
                            <div style="display: flex; justify-content: center; gap: 8px; margin-top: 15px; padding: 0 10px;">
                                ${carouselSlides.map((_, index) => `
                                    <div onclick="storyCarouselGoTo('${storyId}', ${index}, ${totalSlides})"
                                         class="carousel-dot"
                                         id="${storyId}-dot-${index}"
                                         style="width: 10px; height: 10px; border-radius: 50%; background: ${index === 0 ? '#92400e' : '#d1d5db'}; cursor: pointer; transition: all 0.3s ease;"></div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Initialize sound after rendering
            if (sound !== 'none') {
                setTimeout(() => initializeStorySound(storyId, sound), 100);
            }

            return storyHtml;
        }
        return '<div style="color: #999;">Invalid story format</div>';
    }
    
    // MYTH VS REALITY
    if (type === 'myth') {
        if (typeof content === 'object' && content.rows && Array.isArray(content.rows)) {
            return `
                <div class="myth-table-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; max-width: 1400px; margin: 0 auto;">
                    <style>
                        .myth-display-table {
                            width: 100%;
                            border-collapse: collapse;
                            background: white;
                            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                            border-radius: 12px;
                            overflow: hidden;
                        }

                        .myth-display-table thead {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        }

                        .myth-display-table th {
                            padding: 20px 15px;
                            text-align: center;
                            color: white;
                            font-size: 16px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            border: 2px solid white;
                        }

                        .myth-display-table td {
                            padding: 15px;
                            border: 2px solid #e0e0e0;
                            background: #f9f9f9;
                            vertical-align: top;
                            font-size: 14px;
                            line-height: 1.6;
                        }

                        .myth-display-table th:nth-child(1) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
                        .myth-display-table th:nth-child(2) { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                        .myth-display-table th:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
                        .myth-display-table th:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
                        .myth-display-table th:nth-child(5) { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

                        /* Discovery Row Styling */
                        .discovery-row .discovery-label {
                            font-weight: 700;
                            background: linear-gradient(135deg, #f093fb, #f5576c);
                            color: white;
                            vertical-align: middle;
                            white-space: nowrap;
                            text-align: center;
                            padding: 15px;
                            border: 2px solid white;
                        }

                        .discovery-row .discovery-input {
                            background: #fff !important;
                            padding: 10px !important;
                            border: 2px solid #e0e0e0;
                        }

                        .discovery-textarea {
                            width: 100%;
                            border: 2px solid #e5e7eb;
                            border-radius: 6px;
                            padding: 12px;
                            font-size: 14px;
                            font-family: inherit;
                            resize: vertical;
                            min-height: 100px;
                            transition: border-color 0.3s ease, box-shadow 0.3s ease;
                        }

                        .discovery-textarea:focus {
                            outline: none;
                            border-color: #667eea;
                            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                        }

                        /* Submit Button */
                        .submit-discovery-btn {
                            width: 100%;
                            padding: 16px;
                            margin-top: 20px;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                            transition: all 0.3s ease;
                        }

                        .submit-discovery-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
                        }

                        .submit-discovery-btn:active {
                            transform: translateY(0);
                        }

                        .submit-discovery-btn:disabled {
                            opacity: 0.6;
                            cursor: not-allowed;
                        }

                        /* Success message */
                        .discovery-success {
                            margin-top: 15px;
                            padding: 12px;
                            background: linear-gradient(135deg, #43e97b, #38f9d7);
                            color: white;
                            border-radius: 6px;
                            text-align: center;
                            font-weight: 600;
                            display: none;
                            animation: slideIn 0.3s ease;
                        }

                        @keyframes slideIn {
                            from {
                                opacity: 0;
                                transform: translateY(-10px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }

                        @media (max-width: 1200px) {
                            .myth-display-table th,
                            .myth-display-table td {
                                padding: 10px;
                                font-size: 13px;
                            }
                        }

                        /* ===== MOBILE RESPONSIVE STYLES ===== */
                        @media (max-width: 768px) {
                            /* Remove purple container bloat on mobile */
                            .myth-table-section {
                                padding: 0 !important;
                                background: none !important;
                                border-radius: 0 !important;
                                max-width: 100% !important;
                                margin: 0 !important;
                            }

                            /* Compact header - max 50px height */
                            .myth-table-section h2 {
                                font-size: 1.2em !important;
                                padding: 10px 15px !important;
                                margin: 0 0 10px 0 !important;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white !important;
                                border-radius: 8px;
                                text-align: left !important;
                                line-height: 1.3 !important;
                            }

                            /* Table container - full width, snap scrolling */
                            .myth-table-wrapper {
                                overflow-x: auto !important;
                                -webkit-overflow-scrolling: touch !important;
                                scroll-snap-type: x mandatory !important;
                                scroll-behavior: smooth !important;
                                margin: 0 !important;
                                padding: 0 !important;
                                position: relative !important;
                            }

                            /* Remove white gradient overlays on mobile */
                            .myth-table-wrapper::before,
                            .myth-table-wrapper::after {
                                display: none !important;
                                background: none !important;
                            }

                            /* 3-column mobile view with snap points - EXPANDED WIDTH */
                            .myth-display-table {
                                min-width: max-content !important;
                                width: 100% !important;
                            }

                            .myth-display-table th,
                            .myth-display-table td {
                                min-width: 45vw !important; /* Wider columns for better readability */
                                width: 45vw !important;
                                max-width: 45vw !important;
                                scroll-snap-align: start !important;
                                padding: 12px 10px !important;
                                font-size: 13px !important;
                                word-wrap: break-word !important;
                                overflow-wrap: break-word !important;
                            }

                            /* Sticky headers while scrolling */
                            .myth-display-table th {
                                position: sticky !important;
                                top: 0 !important;
                                z-index: 20 !important;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
                            }

                            /* Discovery Row Mobile Styling */
                            .discovery-row .discovery-label {
                                min-width: 45vw !important;
                                width: 45vw !important;
                                padding: 12px 10px !important;
                                font-size: 13px !important;
                            }

                            .discovery-row .discovery-input {
                                padding: 8px !important;
                            }

                            .discovery-textarea {
                                min-height: 80px;
                                font-size: 14px;
                                padding: 10px;
                            }

                            .discovery-textarea:focus {
                                border-color: #667eea;
                                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                            }

                            /* Submit button mobile styling */
                            .submit-discovery-btn {
                                width: 100%;
                                padding: 14px;
                                margin-top: 15px;
                                font-size: 16px;
                                border-radius: 8px;
                                touch-action: manipulation;
                            }

                            .submit-discovery-btn:active {
                                transform: translateY(1px);
                            }

                            /* Enhanced scroll hint */
                            .scroll-hint {
                                display: block !important;
                                text-align: center !important;
                                margin-top: 12px !important;
                                padding: 8px !important;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                                color: white !important;
                                font-size: 13px !important;
                                font-weight: 600 !important;
                                border-radius: 6px !important;
                                animation: pulse 2s infinite !important;
                            }

                            @keyframes pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.7; }
                            }

                            /* Column navigation dots */
                            .myth-column-dots {
                                display: flex !important;
                                justify-content: center !important;
                                gap: 8px !important;
                                margin-top: 15px !important;
                                padding: 10px !important;
                            }

                            .myth-column-dot {
                                width: 8px !important;
                                height: 8px !important;
                                border-radius: 50% !important;
                                background: #d1d5db !important;
                                transition: all 0.3s ease !important;
                                cursor: pointer !important;
                            }

                            .myth-column-dot.active {
                                background: #667eea !important;
                                transform: scale(1.3) !important;
                            }

                            .myth-column-dot.viewed {
                                background: #a5b4fc !important;
                            }
                        }

                        /* Extra small mobile - show 1.5-2 columns for better readability */
                        @media (max-width: 480px) {
                            .myth-display-table th,
                            .myth-display-table td {
                                min-width: 60vw !important; /* Even wider on small screens */
                                width: 60vw !important;
                                max-width: 60vw !important;
                                padding: 10px 8px !important;
                                font-size: 12px !important;
                            }

                            .myth-table-section h2 {
                                font-size: 1.1em !important;
                                padding: 8px 12px !important;
                            }

                            .scroll-hint {
                                font-size: 12px !important;
                                padding: 6px !important;
                            }

                            /* Discovery row adjustments for small screens */
                            .discovery-row .discovery-label {
                                min-width: 60vw !important;
                                width: 60vw !important;
                                padding: 10px 8px !important;
                                font-size: 12px !important;
                            }

                            .discovery-textarea {
                                font-size: 13px;
                                padding: 8px;
                            }

                            .submit-discovery-btn {
                                padding: 12px;
                                font-size: 15px;
                            }
                        }
                    </style>

                    <h2 style="text-align: center; color: white; margin-bottom: 30px; font-size: 28px;">Myth vs Reality</h2>

                    <div class="myth-table-wrapper" role="region" aria-label="Myth vs Reality Table" tabindex="0">
                        <table class="myth-display-table">
                            <thead>
                                <tr>
                                    <th>Subtopics</th>
                                    <th>Misconception</th>
                                    <th>The Flaw</th>
                                    <th>Data Check/Evidence</th>
                                    <th>Correct Interpretation</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${content.rows.map(row => `
                                    <tr>
                                        <td>${row.subtopic || ''}</td>
                                        <td>${row.misconception || ''}</td>
                                        <td>${row.flaw || ''}</td>
                                        <td>${row.evidence || ''}</td>
                                        <td>${row.interpretation || ''}</td>
                                    </tr>
                                `).join('')}
                                <tr class="discovery-row">
                                    <td class="discovery-label">Discovery</td>
                                    <td colspan="4" class="discovery-input">
                                        <textarea
                                            id="myth-discovery-textarea"
                                            class="discovery-textarea"
                                            placeholder="Write your discovery here... What insights did you gain from analyzing these myths and realities?"
                                            rows="4"
                                            aria-label="Discovery notes"></textarea>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="submit-discovery-btn" id="submit-discovery-btn" onclick="submitMythDiscovery()">
                        Submit Answer
                    </button>
                    <div class="discovery-success" id="discovery-success">
                        ‚úì Discovery saved successfully!
                    </div>
                    <div class="scroll-hint" aria-hidden="true">
                        <span class="scroll-hint-desktop">‚Üê Swipe to see more columns ‚Üí</span>
                        <span class="scroll-hint-mobile">üìä Swipe left to see all 5 columns ‚Üí</span>
                    </div>
                    <div class="myth-column-dots" style="display: none;">
                        <div class="myth-column-dot active" data-column="0" title="Subtopics"></div>
                        <div class="myth-column-dot" data-column="1" title="Misconception"></div>
                        <div class="myth-column-dot" data-column="2" title="The Flaw"></div>
                        <div class="myth-column-dot" data-column="3" title="Data Check/Evidence"></div>
                        <div class="myth-column-dot" data-column="4" title="Correct Interpretation"></div>
                    </div>
                </div>
            `;
        }
        // Fallback for old format
        else if (typeof content === 'object' && content.myth) {
            return `
                <div class="myth-section" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); padding: 25px; border-radius: 12px;">
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #7c3aed; margin-bottom: 10px;">‚ùå Myth</h4>
                        <p style="color: #6b21a8; font-style: italic;">${content.myth}</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #059669; margin-bottom: 10px;">‚úÖ Reality</h4>
                        <p style="color: #047857;">${content.reality || ''}</p>
                    </div>
                    ${content.why_believed ? `<div style="background: rgba(124, 58, 237, 0.1); padding: 12px; border-radius: 6px;"><strong style="color: #7c3aed;">Why believed:</strong> <span style="color: #6b21a8;">${content.why_believed}</span></div>` : ''}
                </div>
            `;
        }
        return '<div style="color: #999;">Invalid myth format</div>';
    }

    // VIDEO-QUIZ SECTION
    if (type === 'video_quiz') {
        if (typeof content === 'object' && content.video_url && content.quiz_url) {
            var videoUrl = content.video_url;
            var quizUrl = content.quiz_url;
            var videoId = extractYouTubeId(videoUrl);
            var quizId = extractQuizIdFromUrl(quizUrl);

            return `
            <div class="video-quiz-section" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 30px; border-radius: 16px; margin: 20px 0; border: 2px solid #3b82f6;">
                <h3 style="color: #1e40af; margin-bottom: 25px; text-align: center; font-size: 1.5em;">
                    üé¨ Watch & Learn, Then Test Your Knowledge üìù
                </h3>
                
                <!-- Video Section -->
                <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                        <span style="font-size: 1.8em;">üé•</span>
                        <h4 style="margin: 0; color: #dc2626; font-size: 1.2em;">Educational Video</h4>
                    </div>
                    
                    ${videoId ? `
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <iframe src="https://www.youtube.com/embed/${videoId}" 
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    ` : '<div style="color: #999; text-align: center; padding: 40px;">Video not available</div>'}
                </div>
                
                <!-- Divider -->
                <div style="display: flex; align-items: center; margin: 30px 0;">
                    <div style="flex: 1; height: 2px; background: linear-gradient(to right, transparent, #3b82f6, transparent);"></div>
                    <div style="padding: 0 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-weight: 700; border-radius: 20px; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);">
                        ‚¨áÔ∏è Now Test Yourself ‚¨áÔ∏è
                    </div>
                    <div style="flex: 1; height: 2px; background: linear-gradient(to left, transparent, #3b82f6, transparent);"></div>
                </div>
                
                <!-- Quiz Section -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                        <span style="font-size: 1.8em;">üìù</span>
                        <h4 style="margin: 0; color: #10b981; font-size: 1.2em;">Interactive Quiz</h4>
                    </div>
                    
                    ${quizId ? `
                        <div id="embedded-quiz-${quizId}" style="margin-top: 15px;">
                            <div id="quiz-container-${quizId}" style="padding: 20px; min-height: 300px;">
                                <div style="text-align: center;">
                                    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <p style="margin-top: 15px; color: #6b7280;">Loading quiz...</p>
                                </div>
                            </div>
                        </div>
                    ` : '<div style="color: #999; text-align: center; padding: 40px;">Quiz not available</div>'}
                </div>
            </div>
            `;
        }
        return '<div style="color: #999;">Invalid video-quiz format</div>';
    }
    // HOW THINGS WORK - FLOWCHART
    if (type === 'htw') {
        if (typeof content === 'object') {
            return `
                <div class="htw-flowchart" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; max-width: 1400px; margin: 0 auto;">
                    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <h3 style="text-align: center; color: #333; margin-bottom: 30px; font-size: 28px;">üîß How Things Work - System Flowchart</h3>

                        <div style="display: flex; flex-direction: column; align-items: center; gap: 30px;">

                            ${content.start ? `
                            <!-- START / ORIGIN (Oval) -->
                            <div style="width: 350px; height: 140px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 70px; color: white; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                                <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">START / ORIGIN</div>
                                <div style="font-size: 14px; font-weight: 600;">${content.start}</div>
                            </div>
                            <div style="position: relative; width: 3px; height: 30px; background: linear-gradient(to bottom, #667eea, #764ba2); margin: 0 auto;">
                                <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #764ba2;"></div>
                            </div>
                            ` : ''}

                            ${content.central ? `
                            <!-- CENTRAL ELEMENT (Rectangle) -->
                            <div style="width: 400px; min-height: 120px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                                <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">CENTRAL ELEMENT</div>
                                <div style="font-size: 14px; font-weight: 600;">${content.central}</div>
                            </div>
                            <div style="position: relative; width: 3px; height: 30px; background: linear-gradient(to bottom, #667eea, #764ba2); margin: 0 auto;">
                                <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #764ba2;"></div>
                            </div>
                            ` : ''}

                            ${content.process1 || content.process2 ? `
                            <!-- PROCESS STAGES (Parallelograms) -->
                            <div style="display: flex; justify-content: space-around; gap: 20px; width: 100%; max-width: 1200px; flex-wrap: wrap;">
                                ${content.process1 ? `
                                <div style="flex: 1; min-width: 280px; min-height: 100px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); transform: skewX(-10deg); border-radius: 8px; color: white; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4); display: flex; align-items: center; justify-content: center; padding: 20px;">
                                    <div style="transform: skewX(10deg); text-align: center;">
                                        <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px;">PROCESS STAGE 1</div>
                                        <div style="font-size: 14px;">${content.process1}</div>
                                    </div>
                                </div>
                                ` : ''}
                                ${content.process2 ? `
                                <div style="flex: 1; min-width: 280px; min-height: 100px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); transform: skewX(-10deg); border-radius: 8px; color: white; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4); display: flex; align-items: center; justify-content: center; padding: 20px;">
                                    <div style="transform: skewX(10deg); text-align: center;">
                                        <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px;">PROCESS STAGE 2</div>
                                        <div style="font-size: 14px;">${content.process2}</div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div style="position: relative; width: 3px; height: 30px; background: linear-gradient(to bottom, #667eea, #764ba2); margin: 0 auto;">
                                <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #764ba2;"></div>
                            </div>
                            ` : ''}

                            ${content.transformation || content.decision || content.alternate ? `
                            <!-- DECISION FLOW -->
                            <div style="display: flex; align-items: center; gap: 20px; justify-content: center; flex-wrap: wrap;">
                                ${content.transformation ? `
                                <div style="width: 300px; min-height: 100px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                                    <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px;">TRANSFORMATION</div>
                                    <div style="font-size: 14px;">${content.transformation}</div>
                                </div>
                                ` : ''}
                                ${content.decision ? `
                                <div style="font-size: 24px; color: #667eea; font-weight: bold;">‚Üí</div>
                                <div style="width: 180px; height: 180px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); transform: rotate(45deg); border-radius: 12px; box-shadow: 0 8px 20px rgba(250, 112, 154, 0.4); display: flex; align-items: center; justify-content: center;">
                                    <div style="transform: rotate(-45deg); width: 70%; text-align: center; color: white;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">DECISION?</div>
                                        <div style="font-size: 13px;">${content.decision}</div>
                                    </div>
                                </div>
                                ` : ''}
                                ${content.alternate ? `
                                <div style="font-size: 24px; color: #667eea; font-weight: bold;">‚Üí</div>
                                <div style="width: 300px; min-height: 100px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                                    <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px;">ALTERNATE PATH</div>
                                    <div style="font-size: 14px;">${content.alternate}</div>
                                </div>
                                ` : ''}
                            </div>
                            <div style="position: relative; width: 3px; height: 30px; background: linear-gradient(to bottom, #667eea, #764ba2); margin: 0 auto;">
                                <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #764ba2;"></div>
                            </div>
                            ` : ''}

                            ${content.applications ? `
                            <!-- APPLICATIONS -->
                            <div style="width: 600px; min-height: 100px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 12px; color: #333; box-shadow: 0 8px 20px rgba(252, 182, 159, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                                <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px; color: #8b4513; text-transform: uppercase;">REAL-WORLD APPLICATIONS</div>
                                <div style="font-size: 14px; font-weight: 600; color: #8b4513;">${content.applications}</div>
                            </div>
                            <div style="position: relative; width: 3px; height: 30px; background: linear-gradient(to bottom, #667eea, #764ba2); margin: 0 auto;">
                                <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #764ba2;"></div>
                            </div>
                            ` : ''}

                            ${content.solution ? `
                            <!-- FINAL SOLUTION (Circle) -->
                            <div style="width: 300px; height: 300px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(67, 233, 123, 0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center;">
                                <div style="font-size: 11px; font-weight: bold; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">FINAL PURPOSE</div>
                                <div style="font-size: 14px; font-weight: 600; line-height: 1.5;">${content.solution}</div>
                            </div>
                            ` : ''}

                        </div>

                        <!-- Interactive Quiz Button (Desktop Only) -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button id="htw-quiz-btn" class="htw-quiz-button" onclick="startHTWQuiz()" style="padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                                <span id="htw-quiz-btn-text">How does this concept work? üß†</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        return '<div style="color: #999; font-style: italic;">No flowchart data available</div>';
    }
    
    // FUTURE TECHNOLOGY - Current vs Future State Bridge Diagram
    if (type === 'future_tech') {
        if (typeof content === 'object' && content.current && content.gap && content.future) {
            return `
                <div class="current-future-section" style="
                    background: linear-gradient(135deg, #f8f9fa, #ffffff);
                    padding: 50px 30px;
                    border-radius: 20px;
                    max-width: 1400px;
                    margin: 30px auto;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                ">

                    <!-- Top Diagram Container -->
                    <div class="cf-diagram" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 50px;
                        position: relative;
                        min-height: 250px;
                    ">

                        <!-- Current State Box -->
                        <div class="cf-current-box" style="
                            width: 350px;
                            height: 160px;
                            background: linear-gradient(135deg, #4F7AF7, #5B8DF8);
                            border-radius: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.5em;
                            font-weight: 700;
                            box-shadow: 0 8px 20px rgba(79, 122, 247, 0.4);
                            position: relative;
                            z-index: 2;
                        ">
                            ${content.current.label}
                        </div>

                        <!-- Arrow 1 -->
                        <div style="
                            flex: 1;
                            height: 4px;
                            background: #9CA3AF;
                            position: relative;
                            margin: 0 -20px;
                            z-index: 1;
                        ">
                            <div style="
                                position: absolute;
                                right: -10px;
                                top: 50%;
                                transform: translateY(-50%);
                                width: 0;
                                height: 0;
                                border-left: 15px solid #9CA3AF;
                                border-top: 10px solid transparent;
                                border-bottom: 10px solid transparent;
                            "></div>
                        </div>

                        <!-- GAP Circle -->
                        <div class="cf-gap-circle" style="
                            width: 200px;
                            height: 200px;
                            background: linear-gradient(135deg, #7B5FE5, #9B7FE8);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.8em;
                            font-weight: 700;
                            box-shadow: 0 8px 25px rgba(123, 95, 229, 0.5);
                            position: relative;
                            z-index: 3;
                            flex-shrink: 0;
                        ">
                            ${content.gap.label}
                        </div>

                        <!-- Arrow 2 -->
                        <div style="
                            flex: 1;
                            height: 4px;
                            background: #9CA3AF;
                            position: relative;
                            margin: 0 -20px;
                            z-index: 1;
                        ">
                            <div style="
                                position: absolute;
                                right: -10px;
                                top: 50%;
                                transform: translateY(-50%);
                                width: 0;
                                height: 0;
                                border-left: 15px solid #9CA3AF;
                                border-top: 10px solid transparent;
                                border-bottom: 10px solid transparent;
                            "></div>
                        </div>

                        <!-- Future State Box -->
                        <div class="cf-future-box" style="
                            width: 350px;
                            height: 160px;
                            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
                            border-radius: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.5em;
                            font-weight: 700;
                            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
                            position: relative;
                            z-index: 2;
                        ">
                            ${content.future.label}
                        </div>
                    </div>

                    <!-- Middle Text Content -->
                    <div class="cf-content" style="
                        display: grid;
                        grid-template-columns: 1fr 1fr 1fr;
                        gap: 40px;
                        margin-bottom: 50px;
                    ">

                        <!-- Current State Content -->
                        <div class="cf-current-content">
                            ${content.current.title1 ? `
                                <div style="margin-bottom: 25px;">
                                    <h4 style="color: #4F7AF7; font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">
                                        ${content.current.title1}
                                    </h4>
                                    <p style="color: #6b7280; line-height: 1.6; font-size: 0.95em;">
                                        ${content.current.desc1}
                                    </p>
                                </div>
                            ` : ''}

                            ${content.current.title2 ? `
                                <div>
                                    <h4 style="color: #4F7AF7; font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">
                                        ${content.current.title2}
                                    </h4>
                                    <p style="color: #6b7280; line-height: 1.6; font-size: 0.95em;">
                                        ${content.current.desc2}
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        <!-- GAP Content -->
                        <div class="cf-gap-content" style="text-align: center;">
                            ${content.gap.title ? `
                                <div>
                                    <h4 style="color: #7B5FE5; font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">
                                        ${content.gap.title}
                                    </h4>
                                    <p style="color: #6b7280; line-height: 1.6; font-size: 0.95em;">
                                        ${content.gap.desc}
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Future State Content -->
                        <div class="cf-future-content">
                            ${content.future.title1 ? `
                                <div style="margin-bottom: 25px;">
                                    <h4 style="color: #8B5CF6; font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">
                                        ${content.future.title1}
                                    </h4>
                                    <p style="color: #6b7280; line-height: 1.6; font-size: 0.95em;">
                                        ${content.future.desc1}
                                    </p>
                                </div>
                            ` : ''}

                            ${content.future.title2 ? `
                                <div>
                                    <h4 style="color: #8B5CF6; font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">
                                        ${content.future.title2}
                                    </h4>
                                    <p style="color: #6b7280; line-height: 1.6; font-size: 0.95em;">
                                        ${content.future.desc2}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Bottom Status Boxes -->
                    <div class="cf-status-boxes" style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 40px;
                        margin-top: 40px;
                    ">

                        <!-- Current Status Box -->
                        ${content.current.status_title && content.current.status_desc ? `
                            <div class="cf-current-status" style="
                                background: linear-gradient(135deg, #4F7AF7, #5B8DF8);
                                border-radius: 12px;
                                padding: 30px;
                                box-shadow: 0 6px 18px rgba(79, 122, 247, 0.3);
                                min-height: 160px;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                            ">
                                <h3 style="
                                    color: white;
                                    font-size: 1.4em;
                                    font-weight: 700;
                                    margin-bottom: 15px;
                                    letter-spacing: 0.5px;
                                ">
                                    ${content.current.status_title}
                                </h3>
                                <p style="
                                    color: rgba(255, 255, 255, 0.95);
                                    line-height: 1.7;
                                    font-size: 1em;
                                ">
                                    ${content.current.status_desc}
                                </p>
                            </div>
                        ` : ''}

                        <!-- Target Status Box -->
                        ${content.future.status_title && content.future.status_desc ? `
                            <div class="cf-target-status" style="
                                background: linear-gradient(135deg, #8B5CF6, #A78BFA);
                                border-radius: 12px;
                                padding: 30px;
                                box-shadow: 0 6px 18px rgba(139, 92, 246, 0.3);
                                min-height: 160px;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                            ">
                                <h3 style="
                                    color: white;
                                    font-size: 1.4em;
                                    font-weight: 700;
                                    margin-bottom: 15px;
                                    letter-spacing: 0.5px;
                                ">
                                    ${content.future.status_title}
                                </h3>
                                <p style="
                                    color: rgba(255, 255, 255, 0.95);
                                    line-height: 1.7;
                                    font-size: 1em;
                                ">
                                    ${content.future.status_desc}
                                </p>
                            </div>
                        ` : ''}
                    </div>

                </div>
            `;
        }
        return '<div style="color: #999;">Invalid Current vs Future State format</div>';
    }
    
    // PUZZLE/BRAIN TEASER
    if (type === 'puzzle') {
        if (typeof content === 'object' && content.question) {
            return `
                <div class="puzzle-section" style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 25px; border-radius: 12px;">
                    <h3 style="color: #92400e; margin-bottom: 20px;">üß© Brain Teaser</h3>
                    <div style="margin-bottom: 15px;"><strong style="color: #78350f;">Question:</strong> <p style="color: #78350f; margin-top: 8px;">${content.question}</p></div>
                    ${content.hint ? `<details style="margin-top: 15px; cursor: pointer;"><summary style="color: #f59e0b; font-weight: 600;">üí° Need a hint?</summary><p style="color: #92400e; margin-top: 10px; padding-left: 15px;">${content.hint}</p></details>` : ''}
                    ${content.solution ? `<details style="margin-top: 15px; cursor: pointer;"><summary style="color: #10b981; font-weight: 600;">‚úÖ Show Solution</summary><p style="color: #047857; margin-top: 10px; padding-left: 15px; background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 6px;">${content.solution}</p></details>` : ''}
                </div>
            `;
        }
        return '<div style="color: #999;">Invalid puzzle format</div>';
    }
    
    // EDUCATIONAL GAME
    if (type === 'game') {
        if (typeof content === 'object' && content.name) {
            return `
                <div class="game-section" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 25px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                    <h3 style="color: #1e40af; margin-bottom: 20px;">üéÆ ${content.name}</h3>
                    ${content.type ? `<div style="margin-bottom: 10px;"><span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">${content.type}</span></div>` : ''}
                    ${content.instructions ? `<div style="margin-bottom: 15px; color: #1e3a8a;"><strong>How to Play:</strong><p style="margin-top: 8px;">${content.instructions}</p></div>` : ''}
                    ${content.link ? `<a href="${content.link}" target="_blank" style="display: inline-block; margin-top: 15px; padding: 12px 24px; background: #3b82f6; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">Play Game ‚Üí</a>` : ''}
                </div>
            `;
        }
        return '<div style="color: #999;">Invalid game format</div>';
    }
    
    // EDUCATIONAL MEME
    if (type === 'meme') {
        if (typeof content === 'object' && content.concept) {
            return `
                <div class="meme-section" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); padding: 25px; border-radius: 12px; text-align: center;">
                    <h3 style="color: #be185d; margin-bottom: 20px;">üòÇ ${content.concept}</h3>
                    ${content.image ? `<img src="${normalizeImageUrl(content.image)}" alt="Educational meme" style="max-width: 500px; width: 100%; height: auto; border-radius: 8px; margin-bottom: 15px;" onerror="handleImageLoadError(this, '${content.image}')">` : ''}
                    ${content.connection ? `<div style="color: #9f1239; font-style: italic; background: rgba(190, 24, 93, 0.1); padding: 12px; border-radius: 6px;">${content.connection}</div>` : ''}
                </div>
            `;
        }
        return '<div style="color: #999;">Invalid meme format</div>';
    }
    
    // LIST CONTENT
    if (type === 'list') {
        if (typeof content === 'object' && content.items && Array.isArray(content.items)) {
            var listType = content.type || 'numbered';
            var listStyle = listType === 'bullet' ? 'disc' : (listType === 'numbered' ? 'decimal' : 'lower-alpha');
            var listTag = listType === 'bullet' ? 'ul' : 'ol';
            
            return `
                <${listTag} style="list-style-type: ${listStyle}; padding-left: 30px; line-height: 2; color: #374151;">
                    ${content.items.map(item => `<li style="margin-bottom: 8px;">${item}</li>`).join('')}
                </${listTag}>
            `;
        }
        return '<div style="color: #999;">Invalid list format</div>';
    }
    
    // VIDEO CONTENT
    if (type === 'video') {
        var videoUrl = typeof content === 'string' ? content : (content.url || '');
        var videoId = extractYouTubeId(videoUrl);
        
        if (videoId) {
            return `
                <div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <iframe src="https://www.youtube.com/embed/${videoId}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
                </div>
            `;
        }
        return `<div style="color: #999;">Video URL: ${videoUrl}</div>`;
    }
    
    // LINK CONTENT
    if (type === 'link') {
        if (typeof content === 'object' && content.url) {
            return `
                <div class="link-card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                    <a href="${content.url}" target="_blank" style="color: #047857; font-weight: 600; font-size: 1.1em; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                        üîó ${content.description || content.url}
                        <span style="font-size: 0.8em;">‚Üó</span>
                    </a>
                    ${content.description && content.url !== content.description ? `<p style="color: #065f46; margin-top: 8px; font-size: 0.9em;">${content.url}</p>` : ''}
                </div>
            `;
        }
        return '<div style="color: #999;">Invalid link format</div>';
    }
    
    // IMAGE CONTENT (SINGLE OR CAROUSEL)
    if (type === 'image') {
        // Handle carousel format
        if (typeof content === 'object' && content.type === 'carousel' && content.images) {
            var carouselId = 'carousel-' + (section.id || Date.now());
            var images = content.images;
            
            return `
                <div class="image-carousel" id="${carouselId}" style="position: relative; max-width: 800px; margin: 20px auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin: 0;">üì∏ Image Gallery</h4>
                        <span id="${carouselId}-counter" style="background: #3498db; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em; font-weight: 600;">
                            1 / ${images.length}
                        </span>
                    </div>
                    
                    <div style="position: relative; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        ${images.map((img, index) => {
                            var imageUrl = typeof img === 'object' ? img.url : img;
                            var caption = typeof img === 'object' ? img.caption : '';
                            
                            return `
                                <div class="carousel-slide" id="${carouselId}-slide-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                                    <img src="${normalizeImageUrl(imageUrl)}" 
                                         alt="${caption || 'Slide ' + (index + 1)}" 
                                         style="width: 100%; height: auto; display: block;"
                                         onerror="handleImageLoadError(this, '${imageUrl}')">
                                    ${caption ? `<div style="padding: 15px; background: #f8f9fa; text-align: center; color: #555; font-size: 0.95em;">${caption}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        ${images.length > 1 ? `
                            <button onclick="carouselPrev('${carouselId}', ${images.length})" 
                                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                                ‚Äπ
                            </button>
                            <button onclick="carouselNext('${carouselId}', ${images.length})" 
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                                ‚Ä∫
                            </button>
                        ` : ''}
                    </div>
                    
                    ${images.length > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 8px; margin-top: 15px;">
                            ${images.map((_, index) => `
                                <div onclick="carouselGoTo('${carouselId}', ${index}, ${images.length})" 
                                     id="${carouselId}-dot-${index}" 
                                     class="carousel-dot"
                                     style="width: 10px; height: 10px; border-radius: 50%; background: ${index === 0 ? '#3498db' : '#cbd5e0'}; cursor: pointer; transition: all 0.3s;"></div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Handle array of images
        if (Array.isArray(content) && content.length > 0) {
            var carouselId = 'carousel-' + (section.id || Date.now());
            
            return `
                <div class="image-carousel" id="${carouselId}" style="position: relative; max-width: 800px; margin: 20px auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin: 0;">üì∏ Image Gallery</h4>
                        <span id="${carouselId}-counter" style="background: #3498db; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em; font-weight: 600;">
                            1 / ${content.length}
                        </span>
                    </div>
                    
                    <div style="position: relative; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        ${content.map((img, index) => {
                            var imageUrl = typeof img === 'object' ? img.url : img;
                            var caption = typeof img === 'object' ? img.caption : '';
                            
                            return `
                                <div class="carousel-slide" id="${carouselId}-slide-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                                    <img src="${normalizeImageUrl(imageUrl)}" 
                                         alt="${caption || 'Image ' + (index + 1)}" 
                                         style="width: 100%; height: auto; display: block;"
                                         onerror="handleImageLoadError(this, '${imageUrl}')">
                                    ${caption ? `<div style="padding: 15px; background: #f8f9fa; text-align: center; color: #555; font-size: 0.95em;">${caption}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        ${content.length > 1 ? `
                            <button onclick="carouselPrev('${carouselId}', ${content.length})" 
                                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                                ‚Äπ
                            </button>
                            <button onclick="carouselNext('${carouselId}', ${content.length})" 
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                                ‚Ä∫
                            </button>
                        ` : ''}
                    </div>
                    
                    ${content.length > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 8px; margin-top: 15px;">
                            ${content.map((_, index) => `
                                <div onclick="carouselGoTo('${carouselId}', ${index}, ${content.length})" 
                                     id="${carouselId}-dot-${index}" 
                                     class="carousel-dot"
                                     style="width: 10px; height: 10px; border-radius: 50%; background: ${index === 0 ? '#3498db' : '#cbd5e0'}; cursor: pointer; transition: all 0.3s;"></div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Handle single image string
        if (typeof content === 'string') {
            return `
                <div class="single-image" style="text-align: center; margin: 20px 0;">
                    <img src="${normalizeImageUrl(content)}" 
                         alt="Lesson image" 
                         style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
                         onerror="handleImageLoadError(this, '${content}')">
                </div>
            `;
        }
        
        return '<div style="color: #999;">No image available</div>';
    }

    // TABLE CONTENT
    if (type === 'table') {
        if (typeof content === 'object' && content.headers && content.rows) {
            return `
                <div class="table-section" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 25px; border-radius: 12px; overflow-x: auto;">
                    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">üìä</span>
                        <h3 style="margin: 0; color: #2e7d32;">Data Table</h3>
                    </div>
                    <div style="overflow-x: auto; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse; min-width: 400px;">
                            <thead>
                                <tr>
                                    ${content.headers.map(header => `
                                        <th style="padding: 12px 15px; background: #4caf50; color: white; border: 1px solid #45a049; text-align: left; font-weight: 600;">
                                            ${header || '‚Äî'}
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${content.rows.map((row, rowIndex) => `
                                    <tr style="background: ${rowIndex % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        ${row.map(cell => `
                                            <td style="padding: 12px 15px; border: 1px solid #ddd; color: #374151;">
                                                ${cell || '‚Äî'}
                                            </td>
                                        `).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        return '<div style="color: #999;">Invalid table format</div>';
    }

    // IMAGE & TEXT SLIDESHOW - Simplified to match text-only layout
if (type === 'image_text') {
    var slides = [];

    if (typeof content === 'object' && content.slides) {
        slides = content.slides;
    } else if (Array.isArray(content)) {
        slides = content;
    }

    if (slides.length === 0) {
        return '<div style="color: #999;">No slides available</div>';
    }

    var carouselId = 'imagetext-carousel-' + (section.id || Date.now());

    return `
        <div class="image-text-carousel" id="${carouselId}">
            ${slides.length > 1 ? `
                <div style="display: flex; justify-content: flex-end; padding: 0 15px 10px;">
                    <div id="${carouselId}-counter" style="background: #e5e7eb; color: #374151; padding: 6px 14px; border-radius: 14px; font-size: 0.9em; font-weight: 600;">
                        1 / ${slides.length}
                    </div>
                </div>
            ` : ''}

            <div style="position: relative; background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;">
                ${slides.map((slide, index) => {
                    var imageUrl = slide.image_url || slide.url || '';
                    var text = slide.text || '';

                    if (imageUrl && imageUrl.trim() !== '') {
                        imageUrl = normalizeImageUrl(imageUrl);
                    }

                    return `
                        <div id="${carouselId}-slide-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                            ${imageUrl && imageUrl.trim() !== '' ? `
                                <img class="image-only"
                                     src="${imageUrl}"
                                     alt="Slide ${index + 1}"
                                     onerror="handleImageLoadError(this, '${imageUrl}')">
                            ` : ''}

                            ${text ? `
                                <div class="text-only">${text}</div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}

                ${slides.length > 1 ? `
                    <button onclick="imageTextCarouselPrev('${carouselId}', ${slides.length})"
                            class="carousel-nav-btn"
                            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.6); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 100; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                        ‚Üê
                    </button>
                    <button onclick="imageTextCarouselNext('${carouselId}', ${slides.length})"
                            class="carousel-nav-btn"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.6); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 100; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                        ‚Üí
                    </button>
                ` : ''}
            </div>

            ${slides.length > 1 ? `
                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 15px; padding: 0 15px;">
                    ${slides.map((_, index) => `
                        <div onclick="imageTextCarouselGoTo('${carouselId}', ${index}, ${slides.length})"
                             class="carousel-dot"
                             id="${carouselId}-dot-${index}"
                             style="width: 10px; height: 10px; border-radius: 50%; background: ${index === 0 ? '#3b82f6' : '#d1d5db'}; cursor: pointer; transition: all 0.3s ease;"></div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

    // QUIZ SECTIONS (MULTIPLE CHOICE & MIXED)
    if (type === 'quiz_mc' || type === 'quiz_mixed') {
        var quizUrl = typeof content === 'string' ? content : '';
        
        if (quizUrl && quizUrl.trim()) {
            var quizId = extractQuizIdFromUrl(quizUrl);
            
            if (quizId) {
                var containerId = 'quiz-container-' + quizId;
                
                return `
                    <div id="embedded-quiz-${quizId}" style="border: 2px solid #10B981; border-radius: 12px; overflow: hidden; margin: 20px 0;">
                        <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 15px; text-align: center;">
                            <h3 style="margin: 0;">Interactive Quiz</h3>
                            <small style="opacity: 0.9;">ID: ${quizId}</small>
                        </div>
                        <div id="${containerId}" style="padding: 20px; min-height: 300px; background: white;">
                            <div style="text-align: center;">
                                <div class="spinner" style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #10B981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <p>Initializing quiz...</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        return '<div style="color: #999; text-align: center; padding: 20px;">No quiz link provided</div>';
    }
    
    // FALLBACK FOR UNKNOWN TYPES
    return '<div style="color: #999; font-style: italic;">Content type not supported: ' + type + '</div>';
}
function getCurrentSlideIndex(carouselId) {
    for (let i = 0; ; i++) {
        const slide = document.getElementById(`${carouselId}-slide-${i}`);

        // If slide doesn't exist, we've reached the end
        if (!slide) break;

        // Check if slide is visible
        if (slide.style.display === 'block') {
            return i;
        }
    }
    return 0;
}

function loadEmbeddedQuizzes(data) {
    console.log('üéØ loadEmbeddedQuizzes called');
    console.log('Data:', data);
    
    if (!data.custom_sections) {
        console.log('‚ö†Ô∏è No custom sections found');
        return;
    }
    
    let customSections = data.custom_sections;
    
    // Handle nested array
    if (Array.isArray(customSections) && customSections.length > 0 && Array.isArray(customSections[0])) {
        customSections = customSections[0];
    }
    
    console.log('üìã Processing ' + customSections.length + ' custom sections for quizzes');
    
    customSections.forEach(function(section, index) {
        console.log('üîç Section ' + index + ' type:', section.type);
        
        if (section.type === 'quiz_mc' || section.type === 'quiz_mixed') {
            var quizUrl = String(section.content || '');
            console.log('üìù Found quiz section with URL:', quizUrl);
            
            var quizId = extractQuizIdFromUrl(quizUrl);
            console.log('üÜî Extracted quiz ID:', quizId);
            
            if (quizId) {
                var containerId = 'quiz-container-' + quizId;
                var container = document.getElementById(containerId);
                
                console.log('üì¶ Looking for container:', containerId);
                console.log('üì¶ Container found:', !!container);
                
                if (container) {
                    console.log('‚úÖ Loading quiz into container...');
                    
                    // Show loading state
                    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Loading quiz...</p></div>';
                    
                    // Fetch and render quiz
                    fetch('/api/get-quiz-embed/' + quizId)
                        .then(function(response) {
                            console.log('üì° Quiz fetch response:', response.status);
                            if (!response.ok) {
                                throw new Error('Quiz not found: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(quizData) {
                            console.log('‚úÖ Quiz data received:', quizData);
                            
                            // Create quiz instance
                            var quizInstance = renderInteractiveQuizInSection(quizData, container, containerId);
                            window.quizInstances = window.quizInstances || {};
                            window.quizInstances[quizId] = quizInstance;
                            quizInstance.init();
                            
                            console.log('‚úÖ Quiz rendered successfully');
                        })
                        .catch(function(error) {
                            console.error('‚ùå Failed to load quiz:', error);
                            container.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">' +
                                '<i class="fas fa-exclamation-triangle"></i>' +
                                '<p>Failed to load quiz</p>' +
                                '<small>' + error.message + '</small>' +
                                '</div>';
                        });
                } else {
                    console.error('‚ùå Container not found for quiz:', quizId);
                    console.log('Available containers:', Array.from(document.querySelectorAll('[id^="quiz-container-"]')).map(el => el.id));
                }
            } else {
                console.warn('‚ö†Ô∏è Could not extract quiz ID from URL:', quizUrl);
            }
        }
    });
    
    console.log('üèÅ loadEmbeddedQuizzes completed');
    // In loadEmbeddedQuizzes function, after quiz renders:
setTimeout(() => {
    renderGeometryShapesInQuiz();
}, 500);
}

function displayLessonPreviewComplete(data) {
    console.log('=== DISPLAY LESSON PREVIEW DEBUG ===');
    console.log('Full data received:', data);
    console.log('Custom sections:', data.custom_sections);
    
    // Debug image carousel data
    if (data.custom_sections) {
        data.custom_sections.forEach(function(section, index) {
            if (section.type === 'image') {
                console.log('Image section ' + index + ':', section);
                console.log('Content:', section.content);
                if (section.content && section.content.images) {
                    section.content.images.forEach(function(img, imgIndex) {
                        console.log('  Image ' + imgIndex + ' URL:', img.url);
                    });
                }
            }
        });
    }
    console.log('====================================');
    
    var content = document.getElementById('lesson-content');
    
    // CRITICAL FIX: Initialize html variable
    var html = '';
    
    // Lesson header
    html += '<div class="lesson-header">' +
        '<h1>' + (data.title || 'Untitled Lesson') + '</h1>' +
        '<div class="lesson-meta">' +
        '<span class="meta-item">Subject: ' + (data.subject || 'Unknown') + '</span>' +
        '<span class="meta-item">Grade: ' + (data.grade_level || 'Unknown') + '</span>' +
        '<span class="meta-item">Duration: ' + (data.duration || 'Unknown') + ' minutes</span>' +
        '<span class="meta-item">Difficulty: ' + (data.difficulty || 'Unknown') + '</span>' +
        '</div></div>';
    
    // Learning Objectives
    if (data.objectives && data.objectives.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üìö Learning Objectives</h2><div class="section-content"><ul class="objectives-list">';
        if (Array.isArray(data.objectives)) {
            data.objectives.forEach(function(obj) {
                html += '<li>' + formatMathNotation(obj) + '</li>';
            });
        } else {
            html += '<li>' + formatMathNotation(data.objectives) + '</li>';
        }
        html += '</ul></div></div>';
    }
    
    // Inspirational Quote
    if (data.quote) {
        html += '<div class="lesson-section"><h2 class="section-title">üí¨ Inspirational Quote</h2><div class="section-content">' +
            '<blockquote class="inspirational-quote">"' + formatMathNotation(data.quote) + '"</blockquote></div></div>';
    }
    
    // Key Formulas
    if (data.key_formulas && data.key_formulas.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üî¢ Key Formulas</h2><div class="section-content">';
        if (Array.isArray(data.key_formulas)) {
            data.key_formulas.forEach(function(formula) {
                html += '<div class="math-formula">' + formatMathNotation(formula) + '</div>';
            });
        } else {
            html += '<div class="math-formula">' + formatMathNotation(data.key_formulas) + '</div>';
        }
        html += '</div></div>';
    }
    
    // Step-by-Step Solutions
    if (data.step_by_step && data.step_by_step.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üìù Step-by-Step Solutions</h2><div class="section-content"><div class="step-by-step-container">';
        if (Array.isArray(data.step_by_step)) {
            data.step_by_step.forEach(function(step, index) {
                html += '<div class="step-item"><div class="step-header"><span class="step-number">STEP ' + (index + 1) + '</span></div>' +
                    '<div class="step-content">' + formatStepContentPreview(step) + '</div></div>';
            });
        } else {
            html += '<div class="step-item"><div class="step-content">' + formatStepContentPreview(data.step_by_step) + '</div></div>';
        }
        html += '</div></div></div>';
    }
    
    // Worked Examples
    if (data.worked_examples && data.worked_examples.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üí° Worked Examples</h2><div class="section-content">';
        if (Array.isArray(data.worked_examples)) {
            data.worked_examples.forEach(function(example, index) {
                html += '<div class="worked-example"><h4>Example ' + (index + 1) + '</h4>' +
                    '<div class="example-content">' + formatMathNotation(example) + '</div></div>';
            });
        } else {
            html += '<div class="worked-example">' + formatMathNotation(data.worked_examples) + '</div>';
        }
        html += '</div></div>';
    }
    
    // Mathematical Graphs
    if (data.graphs && data.graphs.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üìä Mathematical Graphs</h2><div class="section-content"><div class="graphs-container">';
        data.graphs.forEach(function(graph, index) {
            html += '<div class="graph-container" id="preview-graph-' + index + '">' +
                '<div class="graph-loading">Loading graph...</div>' +
                '<div class="graph-info"><h4>' + graph.title + '</h4><p>' + formatMathNotation(graph.description) + '</p></div></div>';
        });
        html += '</div></div></div>';
    }
    
    // Practice Problems
    if (data.practice_problems && data.practice_problems.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üéØ Practice Problems</h2><div class="section-content"><div class="practice-problems">';
        if (Array.isArray(data.practice_problems)) {
            data.practice_problems.forEach(function(problem, index) {
                html += '<div class="problem"><strong>Problem ' + (index + 1) + ':</strong> ' + formatMathNotation(problem) + '</div>';
            });
        } else {
            html += '<div class="problem">' + formatMathNotation(data.practice_problems) + '</div>';
        }
        html += '</div></div></div>';
    }
    
    // Real-World Applications
    if (data.real_world_applications) {
        html += '<div class="lesson-section"><h2 class="section-title">üåç Real-World Applications</h2><div class="section-content">' +
            '<div class="real-world-content">' + formatMathNotation(data.real_world_applications) + '</div></div></div>';
    }
    
    // Assessment Methods
    if (data.assessment) {
        html += '<div class="lesson-section"><h2 class="section-title">üìã Assessment Methods</h2><div class="section-content">' +
            '<div class="assessment-content">' + formatMathNotation(data.assessment) + '</div></div></div>';
    }
    
    // Fun Facts
    if (data.fun_facts && data.fun_facts.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üåü Fun Facts</h2><div class="section-content"><div class="fun-facts">';
        if (Array.isArray(data.fun_facts)) {
            html += '<ul>';
            data.fun_facts.forEach(function(fact) {
                html += '<li>' + formatMathNotation(fact) + '</li>';
            });
            html += '</ul>';
        } else {
            html += '<p>' + formatMathNotation(data.fun_facts) + '</p>';
        }
        html += '</div></div></div>';
    }
    
    // Visual Aids
    if (data.visual_aids && data.visual_aids.length > 0) {
        html += '<div class="lesson-section"><h2 class="section-title">üëÅÔ∏è Visual Aids</h2><div class="section-content"><div class="visual-aids">';
        if (Array.isArray(data.visual_aids)) {
            html += '<ul>';
            data.visual_aids.forEach(function(aid) {
                html += '<li>' + formatMathNotation(aid) + '</li>';
            });
            html += '</ul>';
        } else {
            html += '<p>' + formatMathNotation(data.visual_aids) + '</p>';
        }
        html += '</div></div></div>';
    }
    
    // Interactive Evaluation
    if (data.interactive_evaluation && data.interactive_evaluation.questions) {
        html += '<div class="lesson-section"><h2 class="section-title">üìù Interactive Evaluation</h2><div class="section-content">' +
            '<div class="evaluation-preview"><p><strong>Evaluation with ' + data.interactive_evaluation.questions.length + ' questions</strong></p>' +
            '<p>This lesson includes an interactive evaluation to test understanding of the concepts covered.</p></div></div></div>';
    }
    
    // CUSTOM SECTIONS - FIXED
    var customSections = data.custom_sections || [];
    
    // Handle nested array
    if (Array.isArray(customSections) && customSections.length > 0) {
        // Check if first element is an array (nested)
        if (Array.isArray(customSections[0])) {
            console.warn('Detected nested array, flattening...');
            customSections = customSections[0];
        }
        
        console.log('Rendering ' + customSections.length + ' custom sections');
        
        customSections.forEach(function(section, index) {
            console.log('Rendering custom section ' + (index + 1) + ':', section);
            
            html += '<div class="lesson-section">' +
                '<h2 class="section-title">' + (section.title || 'Custom Section') + '</h2>' +
                '<div class="section-content">' + formatCustomSectionContent(section) + '</div>' +
                '</div>';
        });
    } else {
        console.log('No custom sections to render');
    }
    
    // CRITICAL FIX: Actually set the HTML content
    console.log('Setting HTML content, length:', html.length);
    content.innerHTML = html;
    console.log('HTML content set successfully');
    
    // Load graphs
    if (data.graphs && data.graphs.length > 0) {
        setTimeout(function() {
            data.graphs.forEach(function(graph, index) {
                var container = document.getElementById('preview-graph-' + index);
                if (container) {
                    loadGraphIntoContainer(graph, container);
                }
            });
        }, 100);
    }

    // Load embedded quizzes
    setTimeout(function() {
        loadEmbeddedQuizzes(data);
    }, 100);
    
    // MathJax rendering
    if (window.MathJax) {
        MathJax.typesetPromise([content]).catch(function(err) {
            console.error('MathJax rendering failed:', err);
        });
    }
    
    console.log('=== PREVIEW RENDERING COMPLETE ===');
}

// Carousel Navigation Functions
const carouselStates = {};

function initCarousel(carouselId, totalImages) {
    if (!carouselStates[carouselId]) {
        carouselStates[carouselId] = {
            currentIndex: 0,
            totalImages: totalImages
        };
    }
}

function carouselNext(carouselId, totalImages) {
    initCarousel(carouselId, totalImages);
    const state = carouselStates[carouselId];
    
    state.currentIndex = (state.currentIndex + 1) % totalImages;
    updateCarouselDisplay(carouselId, totalImages);
}

function carouselPrev(carouselId, totalImages) {
    initCarousel(carouselId, totalImages);
    const state = carouselStates[carouselId];
    
    state.currentIndex = (state.currentIndex - 1 + totalImages) % totalImages;
    updateCarouselDisplay(carouselId, totalImages);
}

function carouselGoTo(carouselId, index, totalImages) {
    initCarousel(carouselId, totalImages);
    const state = carouselStates[carouselId];
    
    state.currentIndex = index;
    updateCarouselDisplay(carouselId, totalImages);
}

function updateCarouselDisplay(carouselId, totalImages) {
    const state = carouselStates[carouselId];
    const currentIndex = state.currentIndex;
    
    // Hide all slides
    for (let i = 0; i < totalImages; i++) {
        const slide = document.getElementById(`${carouselId}-slide-${i}`);
        if (slide) {
            slide.style.display = 'none';
        }
    }
    
    // Show current slide with fade effect
    const currentSlide = document.getElementById(`${carouselId}-slide-${currentIndex}`);
    if (currentSlide) {
        currentSlide.style.display = 'block';
        currentSlide.style.animation = 'fadeIn 0.5s ease-in-out';
    }
    
    // Update counter
    const counter = document.getElementById(`${carouselId}-counter`);
    if (counter) {
        counter.textContent = `${currentIndex + 1} / ${totalImages}`;
    }
    
    // Update dots
    for (let i = 0; i < totalImages; i++) {
        const dot = document.getElementById(`${carouselId}-dot-${i}`);
        if (dot) {
            dot.style.background = i === currentIndex ? '#2196f3' : '#cbd5e0';
            dot.style.transform = i === currentIndex ? 'scale(1.2)' : 'scale(1)';
        }
    }
}

// Keyboard navigation for carousels
document.addEventListener('keydown', function(e) {
    // Find the currently visible carousel (if any)
    const activeCarousel = document.querySelector('.image-carousel-container:hover');
    if (!activeCarousel) return;
    
    const carouselId = activeCarousel.id;
    const state = carouselStates[carouselId];
    
    if (!state) return;
    
    if (e.key === 'ArrowRight') {
        e.preventDefault();
        carouselNext(carouselId, state.totalImages);
    } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        carouselPrev(carouselId, state.totalImages);
    }
});

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .carousel-dot:hover {
        transform: scale(1.2);
        background: #2196f3 !important;
    }
    
    .image-carousel-container button:hover {
        background: rgba(33, 150, 243, 1) !important;
        transform: translateY(-50%) scale(1.1);
    }
`;
document.head.appendChild(style);

// Image & Text Carousel Navigation
const imageTextCarouselStates = {};

function initImageTextCarousel(carouselId, totalSlides) {
    if (!imageTextCarouselStates[carouselId]) {
        imageTextCarouselStates[carouselId] = {
            currentIndex: 0,
            totalSlides: totalSlides
        };
    }
}

function imageTextCarouselNext(carouselId, totalSlides) {
    initImageTextCarousel(carouselId, totalSlides);
    const state = imageTextCarouselStates[carouselId];
    
    state.currentIndex = (state.currentIndex + 1) % totalSlides;
    updateImageTextCarouselDisplay(carouselId, totalSlides);
}

function imageTextCarouselPrev(carouselId, totalSlides) {
    initImageTextCarousel(carouselId, totalSlides);
    const state = imageTextCarouselStates[carouselId];
    
    state.currentIndex = (state.currentIndex - 1 + totalSlides) % totalSlides;
    updateImageTextCarouselDisplay(carouselId, totalSlides);
}

function imageTextCarouselGoTo(carouselId, index, totalSlides) {
    // Hide all slides
    for (let i = 0; i < totalSlides; i++) {
        const slide = document.getElementById(`${carouselId}-slide-${i}`);
        const dot = document.getElementById(`${carouselId}-dot-${i}`);

        if (slide) slide.style.display = 'none';
        if (dot) {
            dot.style.background = '#d1d5db';
            dot.style.transform = 'scale(1)';
        }
    }

    // Show selected slide
    const targetSlide = document.getElementById(`${carouselId}-slide-${index}`);
    const targetDot = document.getElementById(`${carouselId}-dot-${index}`);

    if (targetSlide) targetSlide.style.display = 'block';
    if (targetDot) {
        targetDot.style.background = '#3b82f6';
        targetDot.style.transform = 'scale(1.2)';
    }

    // Update counter
    const counter = document.getElementById(`${carouselId}-counter`);
    if (counter) {
        counter.textContent = `${index + 1} / ${totalSlides}`;
    }
}

function imageTextCarouselNext(carouselId, totalSlides) {
    const currentIndex = getCurrentSlideIndex(carouselId);
    const nextIndex = (currentIndex + 1) % totalSlides;
    imageTextCarouselGoTo(carouselId, nextIndex, totalSlides);
}

function imageTextCarouselPrev(carouselId, totalSlides) {
    const currentIndex = getCurrentSlideIndex(carouselId);
    const prevIndex = (currentIndex - 1 + totalSlides) % totalSlides;
    imageTextCarouselGoTo(carouselId, prevIndex, totalSlides);
}

function updateImageTextCarouselDisplay(carouselId, totalSlides) {
    const state = imageTextCarouselStates[carouselId];
    const currentIndex = state.currentIndex;

    // Hide all slides
    for (let i = 0; i < totalSlides; i++) {
        const slide = document.getElementById(`${carouselId}-slide-${i}`);
        if (slide) {
            slide.style.display = 'none';
        }
    }

    // Show current slide
    const currentSlide = document.getElementById(`${carouselId}-slide-${currentIndex}`);
    if (currentSlide) {
        currentSlide.style.display = 'block';
        currentSlide.style.animation = 'slideInFade 0.4s ease-in-out';
    }

    // Update counter
    const counter = document.getElementById(`${carouselId}-counter`);
    if (counter) {
        counter.textContent = `${currentIndex + 1} / ${totalSlides}`;
    }

    // Update dots
    for (let i = 0; i < totalSlides; i++) {
        const dot = document.getElementById(`${carouselId}-dot-${i}`);
        if (dot) {
            dot.style.background = i === currentIndex ? '#2196f3' : '#cbd5e0';
            dot.style.transform = i === currentIndex ? 'scale(1.3)' : 'scale(1)';
        }
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const activeCarousel = document.querySelector('.image-text-carousel:hover');
    if (!activeCarousel) return;
    
    const carouselId = activeCarousel.id;
    const state = imageTextCarouselStates[carouselId];
    
    if (!state) return;
    
    if (e.key === 'ArrowRight') {
        e.preventDefault();
        imageTextCarouselNext(carouselId, state.totalSlides);
    } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        imageTextCarouselPrev(carouselId, state.totalSlides);
    }
});

// Add animation
const animationStyle = document.createElement('style');
animationStyle.textContent = `
    @keyframes slideInFade {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
`;
document.head.appendChild(animationStyle);

function renderInteractiveQuizInSection(quizData, container, containerId) {
    console.log('üé® Rendering interactive quiz:', containerId);
    
    if (!quizData || !quizData.questions || quizData.questions.length === 0) {
        container.innerHTML = '<div style="color: #e74c3c; padding: 20px; text-align: center;">No quiz questions available</div>';
        return null;
    }
    
    const quizInstance = {
        currentQuestion: 0,
        userAnswers: {},
        quizData: quizData,
        containerId: containerId
    };
    
    // Store in global scope with safe key
    const instanceKey = containerId.replace(/[^a-zA-Z0-9]/g, '_');
    window[instanceKey] = quizInstance;
    
    quizInstance.renderQuestion = function() {
        if (this.currentQuestion >= this.quizData.questions.length) {
            this.currentQuestion = this.quizData.questions.length - 1;
        }
        
        const question = this.quizData.questions[this.currentQuestion];
        const qIndex = this.currentQuestion;
        const totalQuestions = this.quizData.questions.length;
        
        let html = `
            <div class="quiz-question-container" style="background: white; padding: 25px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                    <span style="background: #10B981; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.95em;">
                        Question ${qIndex + 1} of ${totalQuestions}
                    </span>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <p style="font-size: 1.1em; font-weight: 500; line-height: 1.6; color: #1f2937; margin: 0;">
                        ${escapeHtml(question.text)}
                    </p>
                </div>
        `;
        
        // Render options based on question type
        if (question.type === 'paragraph') {
            const savedAnswer = this.userAnswers[qIndex] || '';
            html += `
                <div style="margin: 20px 0;">
                    <textarea 
                        id="answer_${this.containerId}_${qIndex}"
                        style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; font-family: inherit; resize: vertical;"
                        placeholder="Type your answer here..."
                        onchange="window.${instanceKey}.userAnswers[${qIndex}] = this.value"
                    >${escapeHtml(savedAnswer)}</textarea>
                </div>
            `;
        } else if (question.options && question.options.length > 0) {
            html += '<div class="quiz-options-list" style="margin: 20px 0;">';
            
            question.options.forEach((option, index) => {
                const isSelected = this.userAnswers[qIndex] === index;
                const optionId = `opt_${this.containerId}_${qIndex}_${index}`;
                
                html += `
                    <label for="${optionId}" 
                           id="label_${optionId}"
                           style="display: flex; align-items: flex-start; gap: 12px; padding: 15px; margin-bottom: 12px; background: ${isSelected ? '#d1fae5' : '#f9fafb'}; border: 2px solid ${isSelected ? '#10B981' : '#e5e7eb'}; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" 
                               id="${optionId}"
                               name="q_${this.containerId}_${qIndex}" 
                               value="${index}"
                               ${isSelected ? 'checked' : ''}
                               onchange="window.${instanceKey}.selectOption(${qIndex}, ${index})"
                               style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; font-size: 1em; color: #374151; line-height: 1.5;">
                            ${escapeHtml(option.text)}
                        </span>
                    </label>
                `;
            });
            
            html += '</div>';
        }
        
        // Navigation buttons
        html += `
            <div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button 
                    onclick="window.${instanceKey}.prevQuestion()"
                    ${qIndex === 0 ? 'disabled' : ''}
                    style="padding: 12px 24px; background: ${qIndex === 0 ? '#cbd5e0' : '#6b7280'}; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: ${qIndex === 0 ? 'not-allowed' : 'pointer'}; transition: all 0.2s ease; font-size: 1em;">
                    ‚Üê Previous
                </button>
        `;
        
        if (qIndex < totalQuestions - 1) {
            html += `
                <button 
                    onclick="window.${instanceKey}.nextQuestion()"
                    style="padding: 12px 24px; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 1em; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);">
                    Next ‚Üí
                </button>
            `;
        } else {
            html += `
                <button 
                    onclick="window.${instanceKey}.submitQuiz()"
                    style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 1em; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);">
                    Submit Quiz
                </button>
            `;
        }
        
        html += '</div></div>';
        
        container.innerHTML = html;
    };
    
    quizInstance.selectOption = function(questionIndex, optionIndex) {
        this.userAnswers[questionIndex] = optionIndex;
        
        // Update visual feedback
        const labels = document.querySelectorAll(`label[id^="label_opt_${this.containerId}_${questionIndex}_"]`);
        labels.forEach((label, idx) => {
            if (idx === optionIndex) {
                label.style.background = '#d1fae5';
                label.style.borderColor = '#10B981';
            } else {
                label.style.background = '#f9fafb';
                label.style.borderColor = '#e5e7eb';
            }
        });
    };
    
    quizInstance.nextQuestion = function() {
        if (this.currentQuestion < this.quizData.questions.length - 1) {
            this.currentQuestion++;
            this.renderQuestion();
        }
    };
    
    quizInstance.prevQuestion = function() {
        if (this.currentQuestion > 0) {
            this.currentQuestion--;
            this.renderQuestion();
        }
    };
    
    quizInstance.submitQuiz = function() {
        let score = 0;
        let answeredCount = 0;
        
        this.quizData.questions.forEach((question, index) => {
            if (this.userAnswers[index] !== undefined) {
                answeredCount++;
                
                if (question.options && question.options[this.userAnswers[index]]?.isCorrect) {
                    score++;
                }
            }
        });
        
        const percentage = Math.round((score / this.quizData.questions.length) * 100);
        const emoji = percentage >= 80 ? 'üéâ' : percentage >= 60 ? 'üëç' : 'üìö';
        const color = percentage >= 80 ? '#10B981' : percentage >= 60 ? '#f59e0b' : '#ef4444';
        
        container.innerHTML = `
            <div style="text-align: center; padding: 50px 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 4em; margin-bottom: 20px;">${emoji}</div>
                <h2 style="color: ${color}; margin-bottom: 15px; font-size: 2em;">Quiz Complete!</h2>
                <p style="font-size: 1.2em; margin-bottom: 20px; color: #6b7280;">
                    You answered <strong>${answeredCount}</strong> out of <strong>${this.quizData.questions.length}</strong> questions
                </p>
                <div style="display: inline-block; padding: 20px 40px; background: ${color}; color: white; border-radius: 12px; margin-bottom: 25px;">
                    <div style="font-size: 3em; font-weight: 700;">${percentage}%</div>
                    <div style="font-size: 1.2em;">Score: ${score}/${this.quizData.questions.length}</div>
                </div>
                <div>
                    <button 
                        onclick="window.${instanceKey}.currentQuestion = 0; window.${instanceKey}.userAnswers = {}; window.${instanceKey}.renderQuestion();"
                        style="padding: 14px 28px; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.1em; box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s ease;">
                        üîÑ Try Again
                    </button>
                </div>
            </div>
        `;
    };
    
    quizInstance.init = function() {
        this.renderQuestion();
    };
    
    return quizInstance;
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Render geometry shapes in quiz questions
function renderGeometryShapesInQuiz() {
    console.log('üîç Checking for geometry shapes in quiz...');
    
    // Find all quiz containers
    const quizContainers = document.querySelectorAll('[id^="quiz-container-"]');
    
    quizContainers.forEach(container => {
        console.log('Found quiz container:', container.id);
        
        // Check if quiz data has geometry questions
        const quizId = container.id.replace('quiz-container-', '');
        
        // Get quiz data from window or fetch it
        if (window.currentQuizData && window.currentQuizData.questions) {
            window.currentQuizData.questions.forEach((question, index) => {
                if (question.shape_data || question.geometry_data) {
                    console.log(`Question ${index} has geometry data`);
                    
                    // Create shape container if it doesn't exist
                    const questionElement = container.querySelector(`[data-question-index="${index}"]`);
                    if (questionElement) {
                        renderShapeInQuizQuestion(questionElement, question, index);
                    }
                }
            });
        }
    });
}

function renderShapeInQuizQuestion(questionElement, question, index) {
    const shapeData = question.shape_data || question.geometry_data;
    
    if (!shapeData) return;
    
    // Create shape container
    let shapeContainer = questionElement.querySelector('.quiz-geometry-shape');
    
    if (!shapeContainer) {
        shapeContainer = document.createElement('div');
        shapeContainer.className = 'quiz-geometry-shape';
        shapeContainer.style.cssText = 'margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;';
        
        // Insert before options
        const optionsDiv = questionElement.querySelector('.quiz-options-list');
        if (optionsDiv) {
            questionElement.insertBefore(shapeContainer, optionsDiv);
        } else {
            questionElement.appendChild(shapeContainer);
        }
    }
    
    // Show loading
    shapeContainer.innerHTML = `
        <div style="padding: 20px;">
            <div class="spinner" style="margin: 0 auto 10px; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #10B981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #666;">Loading geometry shape...</p>
        </div>
    `;
    
    // Fetch and render shape
    fetch('/api/geometry/render-shape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            type: shapeData.shape_type || 'circle',
            measurements: shapeData,
            question_context: {
                text: question.text,
                hide_answer: true,
                is_preview: false
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.image) {
            shapeContainer.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; display: inline-block;">
                    <img src="${data.image}" 
                         alt="Geometry Shape" 
                         style="max-width: 400px; width: 100%; height: auto; border-radius: 6px;">
                </div>
            `;
        } else {
            throw new Error(data.error || 'Failed to render shape');
        }
    })
    .catch(error => {
        console.error('Shape rendering error:', error);
        shapeContainer.innerHTML = `
            <div style="color: #e74c3c; padding: 15px;">
                ‚ö†Ô∏è Could not load geometry shape
            </div>
        `;
    });
}

// ========================================
// Story Carousel Navigation Functions
// ========================================

function storyCarouselNext(carouselId, totalSlides) {
    const currentIndex = getCurrentSlideIndex(carouselId);
    const nextIndex = (currentIndex + 1) % totalSlides;
    storyCarouselGoTo(carouselId, nextIndex, totalSlides);
}

function storyCarouselPrev(carouselId, totalSlides) {
    const currentIndex = getCurrentSlideIndex(carouselId);
    const prevIndex = (currentIndex - 1 + totalSlides) % totalSlides;
    storyCarouselGoTo(carouselId, prevIndex, totalSlides);
}

function storyCarouselGoTo(carouselId, index, totalSlides) {
    // Hide all slides
    for (let i = 0; i < totalSlides; i++) {
        const slide = document.getElementById(`${carouselId}-slide-${i}`);
        const dot = document.getElementById(`${carouselId}-dot-${i}`);

        if (slide) slide.style.display = 'none';
        if (dot) {
            dot.style.background = '#d1d5db';
            dot.style.transform = 'scale(1)';
        }
    }

    // Show selected slide
    const targetSlide = document.getElementById(`${carouselId}-slide-${index}`);
    const targetDot = document.getElementById(`${carouselId}-dot-${index}`);

    if (targetSlide) targetSlide.style.display = 'block';
    if (targetDot) {
        targetDot.style.background = '#92400e';
        targetDot.style.transform = 'scale(1.2)';
    }

    // Update counter
    const counter = document.getElementById(`${carouselId}-counter`);
    if (counter) {
        counter.textContent = `${index + 1} / ${totalSlides}`;
    }
}

function getCurrentSlideIndex(carouselId) {
    const slides = document.querySelectorAll(`[id^="${carouselId}-slide-"]`);
    for (let i = 0; i < slides.length; i++) {
        if (slides[i].style.display !== 'none') {
            return i;
        }
    }
    return 0;
}

// ========================================
// Story Background Sound Functionality
// ========================================

// Store active audio instances
const storyAudioInstances = {};

// Sound file URLs with fallbacks - Using multiple sources for reliability
const soundUrls = {
    'forest': ['https://cdn.freesound.org/previews/156/156815_2538033-lq.mp3', 'https://actions.google.com/sounds/v1/ambiences/forest_with_birds.ogg'],
    'rain': ['https://cdn.freesound.org/previews/270/270534_5123851-lq.mp3', 'https://actions.google.com/sounds/v1/ambiences/rain_on_tent.ogg'],
    'ocean': ['https://cdn.freesound.org/previews/233/233156_4172131-lq.mp3', 'https://actions.google.com/sounds/v1/ambiences/ocean_waves.ogg'],
    'fireplace': ['https://cdn.freesound.org/previews/326/326845_5674468-lq.mp3', 'https://actions.google.com/sounds/v1/ambiences/fireplace.ogg'],
    'music-box': ['https://cdn.freesound.org/previews/411/411089_5121236-lq.mp3', 'https://actions.google.com/sounds/v1/tools/music_box.ogg'],
    'piano': ['https://cdn.freesound.org/previews/376/376415_5300401-lq.mp3', 'https://actions.google.com/sounds/v1/musical_instruments/piano_twinkle.ogg']
};

// Initialize background sound for a story
function initializeStorySound(storyId, soundType) {
    if (!soundUrls[soundType]) {
        console.warn('Unknown sound type:', soundType);
        return;
    }

    try {
        // Create audio element
        const audio = new Audio();
        audio.loop = true;
        audio.volume = 0.2; // Set to 20% volume for background
        audio.preload = 'metadata';
        audio.crossOrigin = 'anonymous';

        // Get URLs array for this sound type
        const urls = soundUrls[soundType];
        let currentUrlIndex = 0;

        // Try to load the audio with fallback
        const tryLoadAudio = () => {
            if (currentUrlIndex < urls.length) {
                audio.src = urls[currentUrlIndex];
                console.log(`Trying to load audio: ${urls[currentUrlIndex]}`);
            }
        };

        // Handle load errors - try next URL
        audio.addEventListener('error', (e) => {
            console.warn(`Failed to load audio from ${urls[currentUrlIndex]}:`, e);
            currentUrlIndex++;
            if (currentUrlIndex < urls.length) {
                tryLoadAudio();
            } else {
                console.error(`All audio sources failed for ${soundType}`);
            }
        });

        // Start loading
        tryLoadAudio();

        // Store the audio instance
        storyAudioInstances[storyId] = {
            audio: audio,
            playing: false,
            soundType: soundType,
            initialized: false,
            loadError: false
        };

        console.log(`Story sound initialized for ${storyId}: ${soundType}`);
    } catch (error) {
        console.error('Error initializing story sound:', error);
    }
}

// Toggle background sound on/off
function toggleStorySound(storyId) {
    let instance = storyAudioInstances[storyId];

    // Get sound type from data attribute if instance doesn't exist
    if (!instance) {
        const carousel = document.getElementById(storyId);
        const soundType = carousel ? carousel.dataset.sound : null;

        if (soundType && soundType !== 'none') {
            initializeStorySound(storyId, soundType);
            instance = storyAudioInstances[storyId];
        } else {
            console.warn('No sound configured for this story');
            return;
        }
    }

    const toggleBtn = document.getElementById(storyId + '_toggle');
    const icon = document.getElementById(storyId + '_icon');

    if (!instance.playing) {
        // Show loading state
        if (icon) icon.textContent = '‚è≥';
        if (toggleBtn) toggleBtn.disabled = true;

        // Play the sound
        const playPromise = instance.audio.play();

        if (playPromise !== undefined) {
            playPromise
                .then(() => {
                    instance.playing = true;
                    instance.initialized = true;
                    instance.loadError = false;
                    if (icon) icon.textContent = 'üîá';
                    if (toggleBtn) {
                        toggleBtn.style.background = 'rgba(239, 68, 68, 0.9)';
                        toggleBtn.title = 'Click to stop background sound';
                        toggleBtn.disabled = false;
                    }
                    console.log('‚úÖ Story sound playing:', storyId);
                })
                .catch(error => {
                    console.error('‚ùå Error playing story sound:', error);
                    instance.loadError = true;

                    // Try to provide more helpful error message
                    let errorMsg = 'Unable to play background sound. ';

                    if (error.name === 'NotAllowedError') {
                        errorMsg += 'Please interact with the page first (Chrome autoplay policy).';
                    } else if (error.name === 'NotSupportedError') {
                        errorMsg += 'Audio format not supported by your browser.';
                    } else if (error.name === 'AbortError') {
                        errorMsg += 'Audio loading was interrupted. Please try again.';
                    } else {
                        errorMsg += 'Error: ' + error.message;
                    }

                    console.error('Error details:', errorMsg);
                    alert(errorMsg);

                    // Reset icon state
                    if (icon) icon.textContent = 'üîä';
                    if (toggleBtn) {
                        toggleBtn.style.background = 'rgba(245, 158, 11, 0.9)';
                        toggleBtn.disabled = false;
                    }
                });
        }
    } else {
        // Pause the sound
        try {
            instance.audio.pause();
            instance.playing = false;
            if (icon) icon.textContent = 'üîä';
            if (toggleBtn) {
                toggleBtn.style.background = 'rgba(245, 158, 11, 0.9)';
                toggleBtn.title = 'Click to play background sound';
            }
            console.log('‚è∏Ô∏è Story sound paused:', storyId);
        } catch (error) {
            console.error('Error pausing audio:', error);
        }
    }
}

// Stop all story sounds when leaving the page
window.addEventListener('beforeunload', () => {
    Object.keys(storyAudioInstances).forEach(storyId => {
        const instance = storyAudioInstances[storyId];
        if (instance && instance.audio) {
            instance.audio.pause();
            instance.audio.currentTime = 0;
        }
    });
});

// ============================================
// MOBILE RESPONSIVE ENHANCEMENTS
// Touch Gestures & Scroll Indicators
// ============================================

function initMobileResponsiveFeatures() {
    // Initialize table scroll features
    initTableScrollFeatures();

    // Initialize flowchart mobile features
    initFlowchartMobileFeatures();
}

// Table scroll features with touch gestures
function initTableScrollFeatures() {
    const tableWrappers = document.querySelectorAll('.myth-table-wrapper');

    tableWrappers.forEach(wrapper => {
        let isScrolling = false;
        let startX = 0;
        let scrollLeft = 0;
        let velocityX = 0;
        let lastX = 0;
        let lastTime = 0;

        // Touch event handlers for smooth scrolling
        wrapper.addEventListener('touchstart', (e) => {
            isScrolling = true;
            startX = e.touches[0].pageX - wrapper.offsetLeft;
            scrollLeft = wrapper.scrollLeft;
            lastX = e.touches[0].pageX;
            lastTime = Date.now();
            velocityX = 0;

            // Stop any ongoing momentum scroll
            wrapper.style.scrollBehavior = 'auto';
        }, { passive: true });

        wrapper.addEventListener('touchmove', (e) => {
            if (!isScrolling) return;

            const x = e.touches[0].pageX - wrapper.offsetLeft;
            const walk = (x - startX) * 1.5; // Scroll speed multiplier
            wrapper.scrollLeft = scrollLeft - walk;

            // Calculate velocity for momentum
            const now = Date.now();
            const dt = now - lastTime;
            if (dt > 0) {
                velocityX = (e.touches[0].pageX - lastX) / dt;
            }
            lastX = e.touches[0].pageX;
            lastTime = now;
        }, { passive: true });

        wrapper.addEventListener('touchend', () => {
            isScrolling = false;

            // Apply momentum scrolling
            if (Math.abs(velocityX) > 0.5) {
                let momentum = velocityX * 100;
                const deceleration = 0.95;

                const momentumScroll = () => {
                    momentum *= deceleration;
                    wrapper.scrollLeft -= momentum;

                    if (Math.abs(momentum) > 0.5) {
                        requestAnimationFrame(momentumScroll);
                    } else {
                        wrapper.style.scrollBehavior = 'smooth';
                    }
                };

                requestAnimationFrame(momentumScroll);
            } else {
                wrapper.style.scrollBehavior = 'smooth';
            }
        }, { passive: true });

        // Update scroll indicators based on scroll position
        const updateScrollIndicators = () => {
            const scrollWidth = wrapper.scrollWidth;
            const clientWidth = wrapper.clientWidth;
            const scrollLeft = wrapper.scrollLeft;

            // Hide left indicator when at start
            if (wrapper.querySelector('::before')) {
                if (scrollLeft <= 10) {
                    wrapper.style.setProperty('--show-left-indicator', '0');
                } else {
                    wrapper.style.setProperty('--show-left-indicator', '1');
                }
            }

            // Hide right indicator when at end
            if (wrapper.querySelector('::after')) {
                if (scrollLeft >= scrollWidth - clientWidth - 10) {
                    wrapper.style.setProperty('--show-right-indicator', '0');
                } else {
                    wrapper.style.setProperty('--show-right-indicator', '1');
                }
            }

            // Update column indicator dots on mobile
            if (window.innerWidth <= 768) {
                const dotsContainer = wrapper.parentElement?.querySelector('.myth-column-dots');
                if (dotsContainer) {
                    const dots = dotsContainer.querySelectorAll('.myth-column-dot');
                    const table = wrapper.querySelector('.myth-display-table');

                    if (table && dots.length > 0) {
                        const columns = table.querySelectorAll('th');
                        const columnWidth = columns[0]?.offsetWidth || 0;

                        if (columnWidth > 0) {
                            // Calculate which column is currently most visible
                            const currentColumn = Math.round(scrollLeft / columnWidth);

                            // Update dot states
                            dots.forEach((dot, index) => {
                                dot.classList.remove('active');
                                if (index < currentColumn) {
                                    dot.classList.add('viewed');
                                }
                                if (index === currentColumn) {
                                    dot.classList.add('active');
                                    dot.classList.add('viewed');
                                }
                            });
                        }
                    }
                }
            }
        };

        wrapper.addEventListener('scroll', updateScrollIndicators, { passive: true });

        // Initial update
        setTimeout(updateScrollIndicators, 100);

        // Column dot click navigation (mobile only)
        if (window.innerWidth <= 768) {
            const dotsContainer = wrapper.parentElement?.querySelector('.myth-column-dots');
            if (dotsContainer) {
                // Show dots container on mobile
                dotsContainer.style.display = 'flex';

                const dots = dotsContainer.querySelectorAll('.myth-column-dot');
                dots.forEach((dot, index) => {
                    dot.addEventListener('click', () => {
                        const table = wrapper.querySelector('.myth-display-table');
                        if (table) {
                            const columns = table.querySelectorAll('th');
                            const columnWidth = columns[0]?.offsetWidth || 0;

                            if (columnWidth > 0) {
                                // Smooth scroll to the clicked column
                                wrapper.style.scrollBehavior = 'smooth';
                                wrapper.scrollLeft = index * columnWidth;

                                // Haptic feedback if supported
                                if (navigator.vibrate) {
                                    navigator.vibrate(10);
                                }
                            }
                        }
                    });
                });
            }
        }

        // Keyboard navigation support
        wrapper.addEventListener('keydown', (e) => {
            const scrollAmount = 200;

            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    wrapper.scrollLeft -= scrollAmount;
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    wrapper.scrollLeft += scrollAmount;
                    break;
                case 'Home':
                    e.preventDefault();
                    wrapper.scrollLeft = 0;
                    break;
                case 'End':
                    e.preventDefault();
                    wrapper.scrollLeft = wrapper.scrollWidth;
                    break;
            }
        });
    });
}

// Flowchart mobile features
function initFlowchartMobileFeatures() {
    const flowcharts = document.querySelectorAll('.htw-flowchart');

    flowcharts.forEach(flowchart => {
        // On mobile, ensure proper touch scrolling
        if (window.innerWidth <= 768) {
            // Add ARIA labels for accessibility
            flowchart.setAttribute('role', 'img');
            flowchart.setAttribute('aria-label', 'How Things Work - System Flowchart');

            // Optimize rendering
            const elements = flowchart.querySelectorAll('[style*="background: linear-gradient"]');
            elements.forEach(el => {
                el.style.willChange = 'transform';
            });
        }

        // Intersection Observer for lazy animation
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });

            const flowchartElements = flowchart.querySelectorAll('[style*="width:"]');
            flowchartElements.forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                observer.observe(el);
            });
        }
    });
}

// HTW Quiz Interactive Feature
let htwQuizMode = false;
let originalFlowchartContent = {};

function startHTWQuiz() {
    if (htwQuizMode) return; // Already in quiz mode

    htwQuizMode = true;
    const flowchart = document.querySelector('.htw-flowchart');
    if (!flowchart) return;

    // Store original content
    originalFlowchartContent = {};

    // Convert all flowchart text divs to editable textareas
    const allTextDivs = flowchart.querySelectorAll('[style*="font-size: 14px"]');
    allTextDivs.forEach((div, index) => {
        // Skip if it's a label (uppercase text)
        if (div.style.fontSize === '11px') return;

        // Store original content
        const uniqueId = `htw-editable-${index}`;
        originalFlowchartContent[uniqueId] = div.innerHTML;

        // Create textarea
        const textarea = document.createElement('textarea');
        textarea.id = uniqueId;
        textarea.className = 'htw-quiz-input';
        textarea.placeholder = 'Enter your answer here...';
        textarea.style.cssText = `
            width: 90%;
            min-height: 60px;
            padding: 8px;
            border: 2px solid white;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            resize: vertical;
        `;

        // Replace div content with textarea
        div.innerHTML = '';
        div.appendChild(textarea);
    });

    // Change button text and function
    const btn = document.getElementById('htw-quiz-btn');
    const btnText = document.getElementById('htw-quiz-btn-text');
    if (btn && btnText) {
        btnText.innerHTML = 'Submit Answer ‚úì';
        btn.onclick = submitHTWQuiz;
        btn.style.background = 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
    }
}

function submitHTWQuiz() {
    if (!htwQuizMode) return;

    // Collect all answers
    const answers = {};
    const inputs = document.querySelectorAll('.htw-quiz-input');
    inputs.forEach(input => {
        answers[input.id] = input.value;
    });

    // Show feedback
    let feedbackMessage = 'Great effort! üéâ\n\n';
    let answeredCount = 0;
    inputs.forEach(input => {
        if (input.value.trim()) answeredCount++;
    });

    if (answeredCount === inputs.length) {
        feedbackMessage += 'You completed all sections! This shows you understand how the system works.';
    } else if (answeredCount > inputs.length / 2) {
        feedbackMessage += `You answered ${answeredCount} out of ${inputs.length} sections. Good start!`;
    } else {
        feedbackMessage += `You answered ${answeredCount} out of ${inputs.length} sections. Try to complete more sections to show your understanding.`;
    }

    alert(feedbackMessage);

    // Reset quiz mode
    resetHTWQuiz();
}

function resetHTWQuiz() {
    htwQuizMode = false;
    const flowchart = document.querySelector('.htw-flowchart');
    if (!flowchart) return;

    // Restore original content
    Object.keys(originalFlowchartContent).forEach(id => {
        const element = document.getElementById(id);
        if (element && element.parentElement) {
            element.parentElement.innerHTML = originalFlowchartContent[id];
        }
    });

    // Reset button
    const btn = document.getElementById('htw-quiz-btn');
    const btnText = document.getElementById('htw-quiz-btn-text');
    if (btn && btnText) {
        btnText.innerHTML = 'How does <span class="htw-topic-name">this concept</span> work? üß†';
        btn.onclick = startHTWQuiz;
        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }

    originalFlowchartContent = {};
}

// Update topic name in quiz button based on lesson title
function updateHTWTopicName() {
    const lessonTitle = document.querySelector('h1, .lesson-title, #lesson-name');
    const topicSpan = document.querySelector('.htw-topic-name');

    if (lessonTitle && topicSpan) {
        let topicText = lessonTitle.textContent.trim();

        // Extract topic before " - " (e.g., "Fractions - Mathematics Lesson Plan" ‚Üí "Fractions")
        if (topicText.includes(' - ')) {
            topicText = topicText.split(' - ')[0].trim();
        }

        // Remove leading numbers (e.g., "1. Fractions" ‚Üí "Fractions")
        topicText = topicText.replace(/^[0-9.]+\s*/, '');

        // Limit length if too long
        topicText = topicText.length > 50 ? topicText.substring(0, 50) + '...' : topicText;

        topicSpan.textContent = topicText || 'this concept';
    }
}

// Call updateHTWTopicName when content loads
setTimeout(updateHTWTopicName, 500);

// Handle resize events with debouncing
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        initMobileResponsiveFeatures();
    }, 250);
}, { passive: true });

// Initialize on DOM content loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileResponsiveFeatures);
} else {
    initMobileResponsiveFeatures();
}

// Re-initialize when new content is loaded (for dynamic content)
const originalRenderSection = window.renderSection;
if (typeof originalRenderSection === 'function') {
    window.renderSection = function() {
        const result = originalRenderSection.apply(this, arguments);
        setTimeout(initMobileResponsiveFeatures, 100);
        return result;
    };
}

// Performance optimization: Use passive event listeners
if ('scrollRestoration' in window.history) {
    window.history.scrollRestoration = 'manual';
}

// Prevent overscroll on mobile devices
document.body.style.overscrollBehavior = 'contain';

// Add visual feedback for scroll hint
document.addEventListener('scroll', () => {
    const scrollHints = document.querySelectorAll('.scroll-hint');
    scrollHints.forEach(hint => {
        if (window.scrollY > 100) {
            hint.style.opacity = '0.5';
        } else {
            hint.style.opacity = '1';
        }
    });
}, { passive: true });

// Smooth scroll polyfill check
if (!('scrollBehavior' in document.documentElement.style)) {
    // Add smooth scroll polyfill for older browsers
    const smoothScroll = (element, to, duration) => {
        const start = element.scrollLeft;
        const change = to - start;
        const startTime = performance.now();

        const animateScroll = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const ease = progress * (2 - progress); // easeOutQuad

            element.scrollLeft = start + change * ease;

            if (progress < 1) {
                requestAnimationFrame(animateScroll);
            }
        };

        requestAnimationFrame(animateScroll);
    };

    // Override scroll behavior for tables
    document.querySelectorAll('.myth-table-wrapper').forEach(wrapper => {
        wrapper.addEventListener('keydown', (e) => {
            const scrollAmount = 200;

            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                smoothScroll(wrapper, wrapper.scrollLeft - scrollAmount, 300);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                smoothScroll(wrapper, wrapper.scrollLeft + scrollAmount, 300);
            }
        });
    });
}

// Add haptic feedback for supported devices
function triggerHapticFeedback() {
    if ('vibrate' in navigator) {
        navigator.vibrate(10); // 10ms vibration
    }
}

// Add haptic feedback to table scroll
document.querySelectorAll('.myth-table-wrapper').forEach(wrapper => {
    let lastScrollLeft = wrapper.scrollLeft;

    wrapper.addEventListener('scroll', () => {
        const scrollLeft = wrapper.scrollLeft;
        const scrollDiff = Math.abs(scrollLeft - lastScrollLeft);

        // Trigger haptic feedback every 100px scrolled
        if (scrollDiff > 100) {
            triggerHapticFeedback();
            lastScrollLeft = scrollLeft;
        }
    }, { passive: true });
});

console.log('Mobile responsive features initialized successfully');

// ===== MYTH DISCOVERY FUNCTIONALITY =====

// Auto-save discovery to localStorage as user types
function initializeMythDiscovery() {
    const textarea = document.getElementById('myth-discovery-textarea');
    if (!textarea) return;

    // Load saved discovery from localStorage
    const savedDiscovery = localStorage.getItem('myth-discovery');
    if (savedDiscovery) {
        textarea.value = savedDiscovery;
    }

    // Auto-save on input with debouncing
    let saveTimeout;
    textarea.addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            localStorage.setItem('myth-discovery', textarea.value);
            console.log('Discovery auto-saved to localStorage');
        }, 500); // Debounce for 500ms
    });

    // Save on blur (when user clicks away)
    textarea.addEventListener('blur', function() {
        localStorage.setItem('myth-discovery', textarea.value);
    });
}

// Submit discovery with validation
function submitMythDiscovery() {
    const textarea = document.getElementById('myth-discovery-textarea');
    const submitBtn = document.getElementById('submit-discovery-btn');
    const successMsg = document.getElementById('discovery-success');

    if (!textarea || !submitBtn || !successMsg) return;

    const discoveryText = textarea.value.trim();

    // Validate that discovery is not empty
    if (discoveryText === '') {
        // Shake animation for empty submission
        textarea.style.animation = 'shake 0.5s';
        textarea.focus();
        textarea.style.borderColor = '#ef4444';

        setTimeout(() => {
            textarea.style.animation = '';
            textarea.style.borderColor = '#e5e7eb';
        }, 500);

        return;
    }

    // Disable button during submission
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    // Save to localStorage
    localStorage.setItem('myth-discovery', discoveryText);
    localStorage.setItem('myth-discovery-submitted', new Date().toISOString());

    // Simulate submission (you can replace this with actual API call)
    setTimeout(() => {
        // Show success message
        successMsg.style.display = 'block';

        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Answer';

        // Optionally clear the textarea (commented out by default)
        // textarea.value = '';
        // localStorage.removeItem('myth-discovery');

        // Hide success message after 5 seconds
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 5000);

        // Haptic feedback for success
        triggerHapticFeedback();

        console.log('Discovery submitted successfully:', discoveryText);
    }, 1000);
}

// Add shake animation for validation
const shakeStyle = document.createElement('style');
shakeStyle.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
`;
document.head.appendChild(shakeStyle);

// Initialize discovery functionality when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeMythDiscovery);
} else {
    // DOM is already loaded
    setTimeout(initializeMythDiscovery, 100);
}

</script>
</body>
</html>