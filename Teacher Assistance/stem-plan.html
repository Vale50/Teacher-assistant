<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Lesson Plan Creator</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            }
        };

        // Global function for subject tab selection
        function selectSubject(element) {
            // Remove active class from all tabs
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Add active class to clicked tab
            element.classList.add('active');
            console.log('Selected subject:', element.dataset.subject);
        }
    </script>
    <style>
        :root {
            /* Color Variables - Same as original */
            --primary-color: #00bfff;
            --primary-dark: #00bfff;
            --secondary-color: #10B981;
            --accent-color: #f72585;
            --text-color: #1F2937;
            --light-bg: #F3F4F6;
            --white: #FFFFFF;
            --card-shadow: 
                0 2.8px 2.2px rgba(0, 0, 0, 0.034),
                0 6.7px 5.3px rgba(0, 0, 0, 0.048),
                0 12.5px 10px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
            --success-color: #4caf50;
            --bg-color: #f8f9fa;
        }

        /* Global Styles - Same as original */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            min-height: 100vh;
        }

        /* Header Styles - Same as original */
        header {
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
        }
        
        .nav-link:hover {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Container - Same as original */
        .container {
            max-width: 1600px;
            margin: 20px auto;
            background: linear-gradient(145deg, #ffffff, #f6f7f9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .container:hover {
            transform: translateY(-5px);
        }

        /* Navigation Buttons - Same as original */
        .nav-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-button {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(145deg, var(--accent-color), #d90166);
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Headings - Same as original */
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        /* Form Groups - Same as original */
        .form-group {
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-group h2 {
            color: var(--primary-dark);
            margin-top: 0;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        /* Form Elements - Same as original */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(247, 37, 133, 0.1);
        }

        /* Grid Layout - Same as original */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Subject Tabs */
        .subject-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .subject-tab {
            padding: 12px 20px;
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subject-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .subject-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        /* Sort Features Button */
        .sort-features-btn {
            background: linear-gradient(145deg, var(--secondary-color), #0d8f5f);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-features-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Content Features Section */
        .content-features {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px dashed #a0d2eb;
        }

        .content-features.show {
            display: block;
        }

        .features-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .select-all-container input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .select-all-container label {
            margin: 0;
            font-weight: 600;
            color: var(--primary-color);
            cursor: pointer;
        }

        /* Feature Options */
        .feature-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-item {
            position: relative;
        }

        .feature-checkbox {
            display: none;
        }

        .feature-label {
            display: block;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
        }

        .feature-checkbox:checked + .feature-label {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .feature-checkbox-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 3px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            transition: all 0.3s ease;
        }

        .feature-checkbox:checked + .feature-label .feature-checkbox-indicator {
            background: #fff;
            border-color: #fff;
            color: var(--accent-color);
        }

        .feature-checkbox:checked + .feature-label .feature-checkbox-indicator::after {
            content: "‚úì";
            font-weight: bold;
        }

        /* Button Styles - Same as original */
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transform: translateY(0);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(1px);
        }

        /* Siri-style Loading Animation - Same as original */
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .siri-orb {
            width: 100px;
            height: 40px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.2) 20%, 
                rgba(255,255,255,0.5) 50%, 
                rgba(255,255,255,0.2) 80%, 
                rgba(255,255,255,0) 100%);
            background-color: #3a0ca3;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 20px rgba(247, 37, 133, 0.6);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        .loading-text {
            margin-top: 15px;
            color: #3a0ca3;
            font-weight: 600;
        }

        /* Preview Section - Enhanced for Math */
        .lesson-plan-preview {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: none;
        }

        .lesson-plan-preview.show {
            display: block;
        }

        .preview-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .preview-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .preview-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Math-specific styles */
        .math-formula {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
            text-align: center;
            font-size: 1.2rem;
        }

        .step-by-step {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .step-by-step h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .step {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .worked-example {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .worked-example h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .graph-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .practice-problems {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .practice-problems h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        .problem {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid var(--secondary-color);
        }

        /* Error Message */
        .error-message {
            color: #f44336;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #ffebee;
            display: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .action-button {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
        }

        .download-btn {
            background-color: var(--success-color);
            color: white;
        }

        .download-btn:hover {
            background-color: #3d8b40;
        }

        .quiz-btn {
            background-color: var(--accent-color);
            color: white;
        }

        .quiz-btn:hover {
            background-color: #d90166;
        }

        /* Responsive Media Queries */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .feature-options {
                grid-template-columns: 1fr 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .subject-tabs {
                justify-content: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .form-group {
                padding: 15px;
            }
            
            .feature-options {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.75rem;
            }
        }

        /* Enhanced CSS for Interactive Evaluation */
.interactive-evaluation {
    margin-top: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.interactive-evaluation h2 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 20px;
    font-size: 2rem;
}

.evaluation-container {
    max-width: 1600px;
    margin: 0 auto;
}

.question {
    background: white;
    padding: 25px;
    margin-bottom: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.question:hover {
    transform: translateY(-3px);
}

.question-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.question-number {
    background: #3498db;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
}

.question-type {
    background: #ecf0f1;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    color: #7f8c8d;
    font-weight: 600;
}

.question-text {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 20px;
    line-height: 1.6;
}

/* Multiple Choice Styles */
.mc-options {
    display: grid;
    gap: 12px;
}

.mc-option {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.mc-option:hover {
    border-color: #3498db;
    background: #e3f2fd;
}

.mc-option.selected {
    border-color: #2980b9;
    background: #3498db;
    color: white;
}

.mc-option input[type="radio"] {
    position: absolute;
    opacity: 0;
}

/* Paragraph Response Styles */
.paragraph-input {
    width: 100%;
    min-height: 120px;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.3s ease;
}

.paragraph-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Drag and Drop Styles */
.drag-drop-container {
    display: grid;
    gap: 20px;
}

.drag-items {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    min-height: 120px;
    border: 2px dashed #bdc3c7;
}

.drag-item {
    background: #3498db;
    color: white;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 6px;
    cursor: grab;
    display: inline-block;
    font-weight: 500;
    transition: transform 0.2s ease;
    user-select: none;
}

.drag-item:hover {
    transform: scale(1.05);
}

.drag-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.drop-zone {
    background: #ecf0f1;
    border: 2px dashed #95a5a6;
    border-radius: 8px;
    padding: 15px;
    min-height: 60px;
    margin: 10px 0;
    position: relative;
    transition: all 0.3s ease;
}

.drop-zone.drag-over {
    border-color: #3498db;
    background: #e3f2fd;
}

.drop-zone .placeholder {
    color: #7f8c8d;
    font-style: italic;
    text-align: center;
    padding: 20px;
}

/* Matching specific styles */
.matching-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

.terms-column, .definitions-column {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.terms-column h4, .definitions-column h4 {
    margin-bottom: 15px;
    color: #2c3e50;
    text-align: center;
}

/* Ordering specific styles */
.ordering-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.ordered-list {
    background: white;
    border-radius: 8px;
    padding: 15px;
    min-height: 200px;
}

/* Evaluation Controls */
.evaluation-controls {
    text-align: center;
    margin: 30px 0;
}

.submit-evaluation-btn, .reset-evaluation-btn {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 0 10px;
}

.submit-evaluation-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
}

.reset-evaluation-btn {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

/* Results Styles */
.evaluation-results {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-top: 25px;
}

.score-display {
    text-align: center;
    margin-bottom: 30px;
}

.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    color: white;
    margin-bottom: 15px;
}

.score-excellent { background: linear-gradient(135deg, #2ecc71, #27ae60); }
.score-good { background: linear-gradient(135deg, #f39c12, #e67e22); }
.score-needs-improvement { background: linear-gradient(135deg, #e74c3c, #c0392b); }

.feedback-section {
    margin-top: 25px;
}

.question-feedback {
    background: #f8f9fa;
    padding: 20px;
    margin: 15px 0;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.question-feedback.correct {
    border-left-color: #2ecc71;
    background: #d5e8d4;
}

.question-feedback.incorrect {
    border-left-color: #e74c3c;
    background: #f8d7da;
}

.feedback-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.feedback-icon {
    margin-right: 10px;
    font-size: 1.2rem;
}

.feedback-text {
    line-height: 1.6;
}

/* Loading animation */
.loading-evaluation {
    text-align: center;
    padding: 40px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .matching-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .question {
        padding: 20px;
    }
    
    .submit-evaluation-btn, .reset-evaluation-btn {
        width: 100%;
        margin: 10px 0;
    }
}
/* YouTube Video Section */
.youtube-section {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.youtube-section h3 {
    color: #ff0000;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.youtube-embed-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-bottom: 15px;
}

.youtube-embed-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}

.youtube-edit-section {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 12px;
    flex-wrap: wrap;
}

.youtube-url-input {
    flex: 1;
    min-width: 250px;
    padding: 10px 15px;
    border: 2px solid #333;
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 0.9rem;
}

.youtube-url-input::placeholder {
    color: rgba(255,255,255,0.5);
}

.youtube-url-input:focus {
    outline: none;
    border-color: #ff0000;
}

.youtube-update-btn {
    background: linear-gradient(135deg, #ff0000, #cc0000);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.youtube-update-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255,0,0,0.3);
}

.youtube-auto-badge {
    background: rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.7);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    display: inline-block;
    margin-bottom: 10px;
}

/* Fix button specificity issues */
.sort-features-btn,
#generate-btn {
    width: auto !important;
    display: inline-flex !important;
    cursor: pointer !important;
    pointer-events: auto !important;
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed !important;
}

.container button {
    cursor: pointer;
}
/* Enhanced Step-by-Step Section Styling */
.step-by-step-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 0;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.step-item {
    background: white;
    border-bottom: 2px solid #e9ecef;
    position: relative;
    transition: all 0.3s ease;
}

.step-item:last-child {
    border-bottom: none;
    border-radius: 0 0 12px 12px;
}

.step-item:first-child {
    border-radius: 12px 12px 0 0;
}

.step-item:hover {
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
}

.step-header {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
}

.step-number {
    background: #007bff;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

.hide-intermediate-btn {
    background: #ff8c00;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.hide-intermediate-btn:hover {
    background: #e07b00;
    transform: translateY(-1px);
}

.step-content {
    padding: 25px;
    line-height: 1.8;
}

.step-main-content {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 20px;
    text-align: left;
}

.step-answer {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    position: relative;
}

.answer-label {
    background: #ffc107;
    color: #212529;
    padding: 6px 12px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 0.9rem;
    display: inline-block;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.answer-content {
    font-size: 1.2rem;
    font-weight: 600;
    color: #856404;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.7);
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    border: 2px solid rgba(255,193,7,0.3);
}

/* Intermediate Steps Styling */
.intermediate-steps {
    background: #fff5f5;
    border-top: 2px dashed #ffc107;
    margin-top: 10px;
}

.intermediate-header {
    background: #ff8c00;
    color: white;
    padding: 10px 20px;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

.intermediate-content {
    padding: 20px;
}

.intermediate-explanation {
    background: white;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    border-left: 4px solid #ff8c00;
    line-height: 1.6;
}

.limit-explanation {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    border: 1px dashed #6c757d;
    line-height: 1.6;
    font-style: italic;
}

.math-inline {
    background: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-family: 'Times New Roman', serif;
    font-style: normal;
    border: 1px solid #dee2e6;
    font-weight: 600;
}

/* Mathematical Formula Enhanced Styling */
.math-formula {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    padding: 20px;
    border-radius: 10px;
    margin: 15px 0;
    border: 2px solid #e0e0e0;
    text-align: center;
    font-size: 1.3rem;
    font-family: 'Times New Roman', serif;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
}

.math-formula::before {
    content: "üìê";
    position: absolute;
    top: -10px;
    left: 20px;
    background: white;
    padding: 0 10px;
    font-size: 1.2rem;
}

/* Graph Container Enhanced Styling */
.graph-container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    margin: 25px 0;
    border: 2px solid #e0e0e0;
    min-height: 350px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.graph-container:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.graph-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: #6c757d;
    padding: 20px;
}

.graph-loading::before {
    content: "üìä";
    margin-right: 10px;
    font-size: 1.5rem;
}

.graph-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    width: 100%;
}

.graph-info h4 {
    color: #007bff;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.graph-info p {
    color: #6c757d;
    line-height: 1.6;
    margin: 0;
}

/* Enhanced CSS for Step-by-Step Solutions Inside Worked Examples */

/* Step-by-step container within examples */
.step-by-step-in-example {
    background: #f0f8ff;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    border: 2px solid #3498db;
}

.step-by-step-in-example h5 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.2rem;
    font-weight: 600;
    text-align: center;
    background: #3498db;
    color: white;
    padding: 10px;
    border-radius: 8px;
    margin: -20px -20px 20px -20px;
}

.steps-container {
    background: white;
    border-radius: 10px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Individual step items */
.step-item-inline {
    background: white;
    border-bottom: 2px solid #e9ecef;
    position: relative;
    transition: all 0.3s ease;
}

.step-item-inline:last-child {
    border-bottom: none;
}

.step-item-inline:hover {
    box-shadow: inset 0 0 10px rgba(52, 152, 219, 0.1);
}

.step-header-inline {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
}

.step-number-inline {
    background: rgba(255,255,255,0.2);
    padding: 6px 12px;
    border-radius: 15px;
    font-weight: 700;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.hide-intermediate-btn-inline {
    background: #ff8c00;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.hide-intermediate-btn-inline:hover {
    background: #e07b00;
    transform: translateY(-1px);
}

.step-content-inline {
    padding: 20px;
    line-height: 1.6;
}

.step-main-content-inline {
    font-size: 1rem;
    color: #2c3e50;
    margin-bottom: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #3498db;
}

.step-answer-inline {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    position: relative;
}

.answer-label-inline {
    background: #ffc107;
    color: #212529;
    padding: 4px 10px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 0.8rem;
    display: inline-block;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.answer-content-inline {
    font-size: 1.1rem;
    font-weight: 600;
    color: #856404;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.7);
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    border: 1px solid rgba(255,193,7,0.3);
}

/* Intermediate Steps Styling for Inline */
.intermediate-steps-inline {
    background: #fff5f5;
    border-top: 2px dashed #ffc107;
    margin-top: 10px;
    animation: slideDownInline 0.3s ease-out;
}

.intermediate-header-inline {
    background: #ff8c00;
    color: white;
    padding: 8px 15px;
    font-weight: 700;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    text-align: center;
}

.intermediate-content-inline {
    padding: 15px;
}

.intermediate-explanation-inline {
    background: white;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 10px;
    border-left: 3px solid #ff8c00;
    line-height: 1.5;
    font-size: 0.95rem;
}

/* Animation for intermediate steps */
@keyframes slideDownInline {
    from {
        opacity: 0;
        max-height: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        max-height: 500px;
        transform: translateY(0);
    }
}

/* Enhanced Step-by-Step Section Styling to Match Screenshot */
.step-by-step-in-example {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 15px;
    padding: 20px;
    margin-top: 25px;
    border: 2px solid #2196f3;
    box-shadow: 0 8px 24px rgba(33, 150, 243, 0.2);
}

.step-by-step-in-example h5 {
    color: white;
    margin-bottom: 20px;
    font-size: 1.4rem;
    font-weight: 700;
    text-align: center;
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin: -20px -20px 25px -20px;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    letter-spacing: 0.5px;
}

.steps-container {
    background: white;
    border-radius: 12px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

/* Individual step items to match screenshot */
.step-item-inline {
    background: white;
    border-bottom: 3px solid #e3f2fd;
    position: relative;
    transition: all 0.3s ease;
    overflow: hidden;
}

.step-item-inline:last-child {
    border-bottom: none;
}

.step-item-inline:hover {
    box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.08);
    transform: translateX(2px);
}

/* Step header styling to match screenshot blue header */
.step-header-inline {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    font-weight: 600;
}

.step-number-inline {
    background: rgba(255,255,255,0.25);
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 800;
    font-size: 0.9rem;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.3);
}

/* Orange hide intermediate button to match screenshot */
.hide-intermediate-btn-inline {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    border: 1px solid rgba(255,255,255,0.2);
}

.hide-intermediate-btn-inline:hover {
    background: linear-gradient(135deg, #f57c00, #ef6c00);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
}

/* Step content area */
.step-content-inline {
    padding: 25px;
    line-height: 1.8;
    background: #fafafa;
    position: relative;
}

/* Main step description to match screenshot */
.step-main-content-inline {
    font-size: 1.1rem;
    color: #1565c0;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    border-radius: 8px;
    border-left: 5px solid #4caf50;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
}

/* Mathematical work display area */
.step-work-shown {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    font-size: 1.05rem;
    line-height: 2;
    color: #495057;
    border-left: 5px solid #6c757d;
    white-space: pre-line;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

/* Answer section to match screenshot yellow styling */
.step-answer-inline {
    background: linear-gradient(135deg, #fff9c4, #fff59d);
    border: 2px solid #ffeb3b;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    position: relative;
    box-shadow: 0 4px 12px rgba(255, 235, 59, 0.3);
}

.answer-label-inline {
    background: linear-gradient(135deg, #ffeb3b, #ffc107);
    color: #1a1a1a;
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 800;
    font-size: 0.85rem;
    display: inline-block;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
    border: 1px solid rgba(0,0,0,0.1);
}

.answer-content-inline {
    font-size: 1.3rem;
    font-weight: 700;
    color: #e65100;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.8);
    padding: 15px 20px;
    border-radius: 8px;
    text-align: center;
    border: 2px solid rgba(255,193,7,0.4);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    margin-top: 8px;
}

/* Intermediate Steps Styling */
.intermediate-steps-inline {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border-top: 3px dashed #ff9800;
    margin-top: 15px;
    animation: slideDownInline 0.4s ease-out;
    border-radius: 0 0 8px 8px;
}

.intermediate-header-inline {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
    padding: 12px 20px;
    font-weight: 800;
    font-size: 0.9rem;
    letter-spacing: 1px;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.intermediate-content-inline {
    padding: 20px;
}

.intermediate-explanation-inline {
    background: white;
    padding: 18px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #ff9800;
    line-height: 1.7;
    font-size: 1rem;
    color: #424242;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
}

/* Animation for intermediate steps */
@keyframes slideDownInline {
    from {
        opacity: 0;
        max-height: 0;
        transform: translateY(-15px);
    }
    to {
        opacity: 1;
        max-height: 800px;
        transform: translateY(0);
    }
}

/* Enhanced mathematical notation within steps */
.step-main-content-inline .math-inline,
.answer-content-inline .math-inline,
.intermediate-explanation-inline .math-inline,
.step-work-shown .math-inline {
    background: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-family: 'Times New Roman', serif;
    font-style: normal;
    border: 1px solid #dee2e6;
    font-weight: 600;
    margin: 0 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Highlight special mathematical elements */
.math-highlight-zero {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
}

.math-highlight {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid #ffc107;
    font-weight: 600;
}

/* Step progression visual indicators */
.step-item-inline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, #2196f3, #1976d2);
    transition: width 0.3s ease;
}

.step-item-inline:hover::before {
    width: 8px;
}

/* Enhanced Mathematical Work Display */
.step-work-shown {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    line-height: 2.2;
    color: #2c3e50;
    border-left: 5px solid #34495e;
    white-space: pre-line;
    box-shadow: 0 4px 12px rgba(52, 73, 94, 0.1);
    position: relative;
}

.step-work-shown::before {
    content: "üìù";
    position: absolute;
    top: -8px;
    left: 15px;
    background: white;
    padding: 4px 8px;
    border-radius: 50%;
    font-size: 1rem;
}

/* Responsive Design for Step-by-Step Solutions */
@media (max-width: 768px) {
    .step-header-inline {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 18px 15px;
    }
    
    .hide-intermediate-btn-inline {
        width: 100%;
        justify-content: center;
        font-size: 0.8rem;
        padding: 10px 16px;
    }
    
    .step-content-inline {
        padding: 20px 15px;
    }
    
    .step-answer-inline {
        padding: 15px;
        margin-top: 15px;
    }
    
    .answer-content-inline {
        font-size: 1.1rem;
        padding: 12px 15px;
    }
    
    .step-by-step-in-example {
        padding: 15px;
        margin-top: 20px;
    }
    
    .step-by-step-in-example h5 {
        margin: -15px -15px 20px -15px;
        font-size: 1.2rem;
        padding: 12px 15px;
    }
    
    .step-work-shown {
        font-size: 1rem;
        line-height: 2;
        padding: 15px;
    }
    
    .step-main-content-inline {
        font-size: 1rem;
        padding: 12px;
    }
}

@media (max-width: 480px) {
    .step-number-inline {
        font-size: 0.8rem;
        padding: 6px 12px;
    }
    
    .answer-label-inline {
        font-size: 0.75rem;
        padding: 5px 10px;
    }
    
    .intermediate-content-inline {
        padding: 15px;
    }
    
    .intermediate-explanation-inline {
        padding: 15px;
        font-size: 0.95rem;
    }
}

/* Additional enhancements to match screenshot exactly */
.worked-example {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 3px solid #ffc107;
    padding: 25px;
    border-radius: 15px;
    margin: 25px 0;
    position: relative;
    box-shadow: 0 8px 24px rgba(255,193,7,0.25);
    overflow: hidden;
}

.worked-example::before {
    content: "üí°";
    position: absolute;
    top: -15px;
    left: 25px;
    background: linear-gradient(135deg, #ffc107, #ff8f00);
    padding: 10px 15px;
    border-radius: 50%;
    font-size: 1.3rem;
    box-shadow: 0 4px 12px rgba(255,193,7,0.4);
    border: 2px solid white;
}

.worked-example h4 {
    color: #e65100;
    margin-bottom: 20px;
    font-size: 1.4rem;
    margin-top: 15px;
    text-align: center;
    background: rgba(255,255,255,0.6);
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.example-content {
    background: rgba(255,255,255,0.8);
    padding: 20px;
    border-radius: 10px;
    line-height: 1.8;
    border: 2px solid rgba(255,193,7,0.3);
    margin-bottom: 15px;
    font-size: 1.05rem;
    color: #2c3e50;
}

/* Mathematical formula enhanced styling */
.math-formula {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    padding: 25px;
    border-radius: 12px;
    margin: 20px 0;
    border: 3px solid #e0e0e0;
    text-align: center;
    font-size: 1.4rem;
    font-family: 'Times New Roman', serif;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    position: relative;
    color: #2c3e50;
    font-weight: 600;
}

.math-formula::before {
    content: "üìê";
    position: absolute;
    top: -12px;
    left: 25px;
    background: white;
    padding: 8px 12px;
    font-size: 1.2rem;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Toggle button states */
.hide-intermediate-btn-inline[data-state="hidden"] {
    background: linear-gradient(135deg, #4caf50, #388e3c);
}

.hide-intermediate-btn-inline[data-state="hidden"]:hover {
    background: linear-gradient(135deg, #388e3c, #2e7d32);
}

/* Mathematical symbol enhancements */
.math-symbol {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    font-weight: bold;
    color: #1976d2;
}

.math-limit {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    color: #7b1fa2;
}

.equation-equals {
    font-weight: bold;
    color: #d32f2f;
    margin: 0 5px;
}

/* Fraction styling */
.fraction {
    display: inline-block;
    vertical-align: middle;
    text-align: center;
}

.numerator {
    display: block;
    border-bottom: 1px solid #333;
    padding-bottom: 2px;
}

.denominator {
    display: block;
    padding-top: 2px;
}

/* Step connection lines for visual flow */
.step-item-inline:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 50%;
    bottom: -3px;
    transform: translateX(-50%);
    width: 80%;
    height: 3px;
    background: linear-gradient(90deg, transparent, #2196f3, transparent);
    z-index: 1;
}

/* Improved step numbering visual */
.step-number-inline {
    position: relative;
    z-index: 2;
}

.step-number-inline::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 120%;
    height: 120%;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    z-index: -1;
}

/* Enhanced hover effects */
.step-item-inline:hover .step-number-inline {
    transform: scale(1.05);
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

.step-item-inline:hover .hide-intermediate-btn-inline {
    transform: scale(1.02);
}

/* Print styles for step-by-step solutions */
@media print {
    .step-by-step-in-example {
        background: white !important;
        border: 2px solid #333 !important;
        page-break-inside: avoid;
    }
    
    .step-header-inline {
        background: #f0f0f0 !important;
        color: #333 !important;
    }
    
    .hide-intermediate-btn-inline {
        display: none !important;
    }
    
    .intermediate-steps-inline {
        display: block !important;
    }
}

/* Share Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.active {
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 0;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal-overlay.active .modal-content {
    transform: scale(1);
}

.modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 16px 16px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
}

.close-modal {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 28px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
}

.close-modal:hover {
    background: rgba(255, 255, 255, 0.3);
}

.modal-body {
    padding: 30px;
}

.share-link-container {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

#share-link-input {
    flex: 1;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Courier New', monospace;
}

.copy-btn {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.share-options {
    margin-top: 25px;
}

.share-options h4 {
    margin-bottom: 15px;
    color: #2c3e50;
}

.share-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
}

.share-option-btn {
    background: white;
    border: 2px solid #e9ecef;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    color: #495057;
}

.share-option-btn:hover {
    border-color: #3498db;
    color: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
}

.share-info {
    margin-top: 20px;
    padding: 15px;
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    border-radius: 6px;
}

.share-info p {
    margin: 0;
    font-size: 14px;
    color: #1565c0;
    line-height: 1.6;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    color: #e74c3c;
    background: #ffebee;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #e74c3c;
    margin: 20px 0;
}

.retry-btn {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    transition: all 0.3s ease;
}

.retry-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

/* Share Button Styling */
.share-btn {
    background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
    color: white !important;
}

.share-btn:hover {
    background: linear-gradient(135deg, #27ae60, #1e8449) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
}

/* QR Modal */
.qr-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.qr-modal-overlay.active {
    opacity: 1;
}

.qr-modal-content {
    background: white;
    border-radius: 16px;
    padding: 0;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.qr-body {
    padding: 30px;
    text-align: center;
}

.download-qr-btn {
    display: inline-block;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    margin-top: 15px;
    transition: all 0.3s ease;
}

.download-qr-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
    }
    
    .share-link-container {
        flex-direction: column;
    }
    
    .share-buttons {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <!-- Header Section-->
    <header>
        <div class="header-container">
            <a href="#" class="logo">
                <span class="logo-icon">üìö</span>
                <span>Decipher Learning</span>
            </a>
            
            <nav class="nav-links">
                <a href="https://deciph.ai.deciphersacad.online/welcome.html" class="nav-link">Home</a>
                <a href="https://deciph.ai.deciphersacad.online/dashboard.html" class="nav-link">Dashboard</a>
                <a href="https://deciph.ai.deciphersacad.online/performance.html" class="nav-link">Performance</a>
            </nav>
            
            <div class="user-menu">
                <!-- User menu content would go here -->
            </div>
        </div>
    </header>

    <div class="container">
        <div class="nav-container">
            <a href="/quiz-creator.html" class="nav-button">Quiz-Creator</a>
            <a href="/flashcard-creator" class="nav-button">Flashcard-Creator</a>
        </div>
        
        <h1>üßÆ Math Lesson Plan Creator</h1>
        
        <!-- Subject Selection -->
        <div class="form-group">
            <h2>Subject Selection</h2>
            <div class="subject-tabs">
                <div class="subject-tab active" data-subject="mathematics" onclick="selectSubject(this)">
                    üìê Mathematics
                </div>
                <div class="subject-tab" data-subject="physics" onclick="selectSubject(this)">
                    ‚öõÔ∏è Physics
                </div>
                <div class="subject-tab" data-subject="chemistry" onclick="selectSubject(this)">
                    üß™ Chemistry
                </div>
                <div class="subject-tab" data-subject="biology" onclick="selectSubject(this)">
                    üß¨ Biology
                </div>
                <div class="subject-tab" data-subject="general" onclick="selectSubject(this)">
                    üìä General
                </div>
            </div>
        </div>
        
        <!-- Basic Information -->
        <div class="form-group">
            <h2>Basic Information</h2>
            <div class="grid-2">
                <div>
                    <label for="topic">Specific Topic:</label>
                    <input type="text" id="topic" placeholder="e.g., Quadratic Equations, Newton's Laws, Chemical Bonding..." required>
                </div>
                <div>
                    <label for="grade-level">Grade Level:</label>
                    <select id="grade-level" required>
                        <option value="">Select Grade Level</option>
                        <option value="elementary-lower">Elementary School (1-2)</option>
                        <option value="elementary-upper">Elementary School (3-5)</option>
                        <option value="middle">Middle School (6-8)</option>
                        <option value="high">High School (9-12)</option>
                        <option value="college">College Level</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-2" style="margin-top: 15px;">
                <div>
                    <label for="duration">Lesson Duration (minutes):</label>
                    <input type="number" id="duration" min="15" max="180" value="50" required>
                </div>
                <div>
                    <label for="difficulty">Difficulty Level:</label>
                    <select id="difficulty">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Learning Objectives -->
        <div class="form-group">
            <h2>Learning Objectives</h2>
            <label for="objectives">What should students learn from this lesson?</label>
            <textarea id="objectives" placeholder="Describe the main learning objectives (optional - will be auto-generated based on topic)..."></textarea>
        </div>
        
        <!-- Content Features -->
        <div class="form-group">
            <h2>Content Features</h2>
            <button type="button" class="sort-features-btn" onclick="toggleContentFeatures()">
                <span>‚öôÔ∏è</span>
                <span>Sort Features</span>
            </button>
            
            <div class="content-features" id="content-features">
                <div class="features-header">
                    <h3 style="margin: 0; color: var(--primary-color);">Select Content Features</h3>
                    <div class="select-all-container">
                        <input type="checkbox" id="select-all" checked>
                        <label for="select-all">Select All</label>
                    </div>
                </div>
                
                <div class="feature-options">
                    <div class="feature-item">
                        <input type="checkbox" id="step-by-step" class="feature-checkbox" checked>
                        <label for="step-by-step" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üìù Step-by-Step Solutions
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="auto-graphs" class="feature-checkbox" checked>
                        <label for="auto-graphs" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üìä Auto-Generate Graphs
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="worked-examples" class="feature-checkbox" checked>
                        <label for="worked-examples" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üí° Worked Examples
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="practice-problems" class="feature-checkbox" checked>
                        <label for="practice-problems" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üéØ Practice Problems
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="key-formulas" class="feature-checkbox" checked>
                        <label for="key-formulas" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üî¢ Key Formulas
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="fun-facts" class="feature-checkbox" checked>
                        <label for="fun-facts" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üåü Fun Facts
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="inspirational-quotes" class="feature-checkbox" checked>
                        <label for="inspirational-quotes" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üí¨ Inspirational Quotes
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="real-world" class="feature-checkbox" checked>
                        <label for="real-world" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üåç Real-World Applications
                        </label>
                    </div>
                    
                    <div class="feature-item">
                        <input type="checkbox" id="visual-aids" class="feature-checkbox" checked>
                        <label for="visual-aids" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üëÅÔ∏è Visual Aids
                        </label>
                    </div>

                    <div class="feature-item">
                        <input type="checkbox" id="interactive-evaluation" class="feature-checkbox" checked>
                        <label for="interactive-evaluation" class="feature-label">
                       <div class="feature-checkbox-indicator"></div>
                           üìù Interactive Evaluation
                     </label>
                  </div>

                    <div class="feature-item">
                        <input type="checkbox" id="assessment" class="feature-checkbox" checked>
                        <label for="assessment" class="feature-label">
                            <div class="feature-checkbox-indicator"></div>
                            üìã Assessment Methods
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <button onclick="generateEnhancedMathLessonPlan()" id="generate-btn">Generate Math Lesson Plan</button>
        
        <div class="error-message" id="error-message"></div>
        <div class="loading" id="loading">
            <div class="siri-orb"></div>
            <div class="loading-text">Creating your comprehensive math lesson plan</div>
        </div>
        
        <div class="lesson-plan-preview" id="lesson-plan-preview"></div>
    </div>


    <script>
        let currentEvaluation = null;
        let userAnswers = {};
        let draggedElement = null;
        // Mathematical notation converter

// 2. Custom Network Error Class
class NetworkError extends Error {
    constructor(message, originalError = null) {
        super(message);
        this.name = 'NetworkError';
        this.originalError = originalError;
        this.isNetworkError = true;
    }
}

class DynamicStepGeneratorNoFallback {
    constructor() {
        this.apiEndpoint = 'https://seashell-app-onfk3.ondigitalocean.app/api/generate-dynamic-steps';
        this.cache = new Map();
        this.requestTimeout = 30000; // 30 seconds
    }

    async generateSteps(problemText, topic, gradeLevel, subject) {
        // Create cache key
        const cacheKey = this.createCacheKey(problemText, topic);
        
        // Check cache first
        if (this.cache.has(cacheKey)) {
            console.log('Using cached steps for problem');
            return this.cache.get(cacheKey);
        }

        try {
            // Request AI-generated steps with timeout
            const steps = await this.requestAIStepsWithTimeout({
                problem_text: problemText,
                topic: topic,
                grade_level: gradeLevel,
                subject: subject,
                include_verification: true,
                show_intermediate_work: true
            });

            if (steps && steps.length > 0) {
                // Cache successful results
                this.cacheResult(cacheKey, steps);
                return steps;
            } else {
                throw new Error('No steps generated from server');
            }

        } catch (error) {
            console.error('Dynamic step generation failed:', error);
            
            // Instead of fallback, throw network error
            throw new NetworkError('Failed to generate step-by-step solution. Please check your internet connection and try again.', error);
        }
    }

    async requestAIStepsWithTimeout(requestData) {
        const token = getAuthToken();
        if (!token) {
            throw new NetworkError('Authentication required. Please log in and try again.');
        }

        // Create timeout promise
        const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new NetworkError('Request timeout. Please check your internet connection and try again.')), this.requestTimeout)
        );

        try {
            // Create fetch promise
            const fetchPromise = fetch(this.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestData)
            });

            // Race against timeout
            const response = await Promise.race([fetchPromise, timeoutPromise]);

            if (!response.ok) {
                if (response.status >= 500) {
                    throw new NetworkError('Server error. Please try again in a moment.');
                } else if (response.status === 401) {
                    throw new NetworkError('Authentication expired. Please log in again and try again.');
                } else if (response.status === 429) {
                    throw new NetworkError('Too many requests. Please wait a moment and try again.');
                } else {
                    throw new NetworkError(`Network error (${response.status}). Please try again.`);
                }
            }

            const data = await response.json();
            return data.steps || [];

        } catch (error) {
            if (error instanceof NetworkError) {
                throw error;
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                throw new NetworkError('Network connection failed. Please check your internet connection and try again.');
            } else {
                throw new NetworkError('Failed to generate steps. Please try again.');
            }
        }
    }

    createCacheKey(problemText, topic) {
        const normalized = problemText.toLowerCase().replace(/\s+/g, ' ').trim();
        const hash = btoa(normalized + topic).substring(0, 20);
        return `${topic}_${hash}`;
    }

    cacheResult(cacheKey, steps) {
        if (this.cache.size >= 50) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        this.cache.set(cacheKey, steps);
    }
}
window.enhancedStepGenerator = new DynamicStepGeneratorNoFallback();

        function setupSubjectTabs() {
            const tabs = document.querySelectorAll('.subject-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                });
            });
        }

        function setupSelectAllFeatures() {
            const selectAllCheckbox = document.getElementById('select-all');
            const featureCheckboxes = document.querySelectorAll('.feature-checkbox');
            
            // Select all functionality
            selectAllCheckbox.addEventListener('change', function() {
                featureCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // Update select all when individual checkboxes change
            featureCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const allChecked = Array.from(featureCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(featureCheckboxes).some(cb => cb.checked);
                    
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                });
            });
        }

        function toggleContentFeatures() {
            const contentFeatures = document.getElementById('content-features');
            const button = document.querySelector('.sort-features-btn');
            
            if (contentFeatures.classList.contains('show')) {
                contentFeatures.classList.remove('show');
                button.innerHTML = '<span>‚öôÔ∏è</span><span>Sort Features</span>';
            } else {
                contentFeatures.classList.add('show');
                button.innerHTML = '<span>‚öôÔ∏è</span><span>Hide Features</span>';
            }
        }

    function buildYouTubeSection(lessonPlan) {
        if (!lessonPlan.youtube_video || !lessonPlan.youtube_video.embed_url) {
            return '';
        }

        const yt = lessonPlan.youtube_video;
        const autoBadge = yt.auto_selected
            ? '<span class="youtube-auto-badge">Auto-selected based on topic</span>'
            : '<span class="youtube-auto-badge">Custom video</span>';
        const currentUrl = yt.url || '';

        return `
            <div class="preview-section youtube-section" id="youtube-video-section">
                <h3><span style="font-size:1.5rem;">&#9654;</span> Video Lesson</h3>
                ${autoBadge}
                <div class="youtube-embed-wrapper">
                    <iframe
                        id="youtube-player"
                        src="${yt.embed_url}?rel=0&modestbranding=1"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>
                <div class="youtube-edit-section">
                    <input type="text"
                        class="youtube-url-input"
                        id="youtube-url-input"
                        placeholder="Paste a YouTube URL to change the video..."
                        value="${currentUrl}">
                    <button class="youtube-update-btn" onclick="updateYouTubeVideo()">
                        Update Video
                    </button>
                </div>
            </div>
        `;
    }

    function updateYouTubeVideo() {
        const urlInput = document.getElementById('youtube-url-input');
        const newUrl = urlInput.value.trim();

        if (!newUrl) {
            alert('Please enter a YouTube URL');
            return;
        }

        // Extract video ID from various YouTube URL formats
        let videoId = null;
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
            /^([a-zA-Z0-9_-]{11})$/
        ];

        for (const pattern of patterns) {
            const match = newUrl.match(pattern);
            if (match) {
                videoId = match[1];
                break;
            }
        }

        if (!videoId) {
            alert('Invalid YouTube URL. Please use a valid YouTube link.');
            return;
        }

        // Update the iframe
        const iframe = document.getElementById('youtube-player');
        if (iframe) {
            iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`;
        }

        // Update the input to show the clean URL
        urlInput.value = `https://www.youtube.com/watch?v=${videoId}`;

        // Save to backend if we have a lesson plan ID
        const lessonPlanId = window.currentLessonPlanId;
        if (lessonPlanId) {
            const token = getAuthToken();
            if (token) {
                fetch('/api/update-lesson-youtube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        lesson_plan_id: lessonPlanId,
                        youtube_url: newUrl
                    })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Update the badge
                        const badge = document.querySelector('.youtube-auto-badge');
                        if (badge) badge.textContent = 'Custom video';
                    }
                })
                .catch(err => console.error('Failed to save YouTube URL:', err));
            }
        }
    }

    function addInteractiveEvaluation(evaluationData) {
    const previewDiv = document.getElementById('lesson-plan-preview');
    
    // Create the interactive evaluation HTML
    const evaluationHTML = `
        <div class="interactive-evaluation" id="interactive-evaluation">
            <h2>üìù Interactive Evaluation</h2>
            <p>Test your understanding of the concepts covered in this lesson.</p>
            
            <div class="evaluation-container">
                <div class="question-container" id="question-container">
                    <!-- Questions will be dynamically loaded here -->
                </div>
                
                <div class="evaluation-controls">
                    <button onclick="submitEvaluation()" class="submit-evaluation-btn" id="submit-btn">
                        Submit Evaluation
                    </button>
                    <button onclick="resetEvaluation()" class="reset-evaluation-btn" id="reset-btn" style="display: none;">
                        Try Again
                    </button>
                </div>
                
                <div class="evaluation-results" id="evaluation-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            </div>
        </div>
    `;
    
    // Append to the lesson plan preview
    previewDiv.insertAdjacentHTML('beforeend', evaluationHTML);
    
    // Display the evaluation questions
    displayInteractiveEvaluation(evaluationData);
}

function addOtherLessonSections(lessonPlan, html) {
    // Add real world applications (only if content exists and is not empty)
    if (lessonPlan.real_world_applications &&
        ((typeof lessonPlan.real_world_applications === 'string' && lessonPlan.real_world_applications.trim()) ||
         (Array.isArray(lessonPlan.real_world_applications) && lessonPlan.real_world_applications.length > 0))) {
        let rwaContent = '';
        if (typeof lessonPlan.real_world_applications === 'string') {
            // Convert newlines to <br> and format as paragraphs
            rwaContent = formatMathNotation(lessonPlan.real_world_applications.replace(/\n/g, '<br>'));
        } else {
            rwaContent = lessonPlan.real_world_applications.map(app =>
                `<div style="margin-bottom: 15px;">${formatMathNotation(app)}</div>`
            ).join('');
        }
        html += `
            <div class="preview-section">
                <h3>üåç Real-World Applications</h3>
                <div class="preview-item" style="line-height: 1.8;">
                    ${rwaContent}
                </div>
            </div>
        `;
    }

    // Add assessment methods (only if content exists)
    if (lessonPlan.assessment &&
        ((typeof lessonPlan.assessment === 'string' && lessonPlan.assessment.trim()) ||
         (Array.isArray(lessonPlan.assessment) && lessonPlan.assessment.length > 0))) {
        let assessContent = '';
        if (typeof lessonPlan.assessment === 'string') {
            assessContent = `<p style="line-height: 1.8;">${formatMathNotation(lessonPlan.assessment.replace(/\n/g, '<br>'))}</p>`;
        } else {
            assessContent = `<ul>${lessonPlan.assessment.map(method =>
                `<li>${formatMathNotation(method)}</li>`
            ).join('')}</ul>`;
        }
        html += `
            <div class="preview-section">
                <h3>üìã Assessment Methods</h3>
                <div class="preview-item">
                    ${assessContent}
                </div>
            </div>
        `;
    }

    // Add fun facts (only if content exists)
    if (lessonPlan.fun_facts &&
        ((Array.isArray(lessonPlan.fun_facts) && lessonPlan.fun_facts.length > 0) ||
         (typeof lessonPlan.fun_facts === 'string' && lessonPlan.fun_facts.trim()))) {
        html += `
            <div class="preview-section">
                <h3>üåü Fun Facts</h3>
                <div class="preview-item">
                    <ul>
                        ${Array.isArray(lessonPlan.fun_facts)
                          ? lessonPlan.fun_facts.map(fact => `<li>${formatMathNotation(fact)}</li>`).join('')
                          : `<li>${formatMathNotation(lessonPlan.fun_facts)}</li>`}
                    </ul>
                </div>
            </div>
        `;
    }

    return html;
}

function displayEnhancedMathLessonPlanNoFallback(lessonPlan) {
    const previewDiv = document.getElementById('lesson-plan-preview');

    if (lessonPlan.id) {
        window.currentLessonPlanId = lessonPlan.id;
        previewDiv.dataset.planId = lessonPlan.id;
    }

    let html = buildBasicLessonHTML(lessonPlan);

    previewDiv.innerHTML = html;
    previewDiv.classList.add('show');

    // Load dynamic content (graphs, etc.)
    loadDynamicContent(lessonPlan);

    if (window.MathJax) {
        MathJax.typesetPromise([previewDiv]).catch((err) => {
            console.error('MathJax rendering failed:', err);
        });
    }

    setTimeout(() => {
        previewDiv.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}
// Enhanced error handling for the main generation function
async function generateEnhancedMathLessonPlanNoFallback() {
    // Validate required fields
    const topic = document.getElementById('topic')?.value?.trim();
    const gradeLevel = document.getElementById('grade-level')?.value;
    const subjectTab = document.querySelector('.subject-tab.active');
    const subject = subjectTab?.dataset?.subject || 'mathematics';
    
    if (!topic || !gradeLevel) {
        showNetworkError('Please fill in the required fields: Topic and Grade Level', false);
        return;
    }
    
    const duration = document.getElementById('duration')?.value || '50';
    const difficulty = document.getElementById('difficulty')?.value || 'intermediate';
    const objectives = document.getElementById('objectives')?.value?.trim() || '';
    
    // Get selected features
    const features = {
        stepByStep: document.getElementById('step-by-step')?.checked || false,
        autoGraphs: document.getElementById('auto-graphs')?.checked || false,
        workedExamples: document.getElementById('worked-examples')?.checked || false,
        practiceProblems: document.getElementById('practice-problems')?.checked || false,
        keyFormulas: document.getElementById('key-formulas')?.checked || false,
        funFacts: document.getElementById('fun-facts')?.checked || false,
        inspirationalQuotes: document.getElementById('inspirational-quotes')?.checked || false,
        realWorld: document.getElementById('real-world')?.checked || false,
        visualAids: document.getElementById('visual-aids')?.checked || false,
        assessment: document.getElementById('assessment')?.checked || false,
        interactiveEvaluation: document.getElementById('interactive-evaluation')?.checked || false
    };
    
    // Show loading state
    setLoadingState(true);
    
    const token = getAuthToken();
    if (!token) {
        console.error('‚ùå No auth token found');
        showNetworkError('Your session has expired. Please log in to continue.', true);
        setLoadingState(false);
        return;
    }
    
    console.log('‚úÖ Auth token found, proceeding with request');
    
    const requestData = {
        subject: subject,
        topic: topic,
        grade_level: gradeLevel,
        duration: duration,
        difficulty: difficulty,
        objectives: objectives,
        features: features,
        lesson_type: 'math',
        topic_category: categorizeTopic(topic)
    };
    
    try {
        console.log('Sending request to generate lesson plan...');
        
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/generate-math-lesson-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            console.error('Server response status:', response.status);
            
            const errorText = await response.text();
            console.error('Server error details:', errorText);
            
            if (response.status >= 500) {
                throw new NetworkError('Server error. Please try again in a moment.');
            } else if (response.status === 401) {
                clearAllTokens();
                throw new NetworkError('Your session has expired. Please log in again.');
            } else if (response.status === 429) {
                throw new NetworkError('Too many requests. Please wait a moment and try again.');
            } else {
                throw new NetworkError(`Request failed (${response.status}). Please try again.`);
            }
        }
        
        const data = await response.json();
        
        if (data.lesson_plan) {
            window.currentLessonPlanId = data.lesson_plan_id;
            
            // Display lesson plan with proper error handling
            await displayEnhancedMathLessonPlanNoFallback(data.lesson_plan);
            
            if (data.lesson_plan_id) {
                const previewDiv = document.getElementById('lesson-plan-preview');
                if (previewDiv) {
                    previewDiv.dataset.planId = data.lesson_plan_id;
                }
            }
        } else {
            throw new NetworkError('Invalid response from server. Please try again.');
        }
        
    } catch (error) {
        console.error('Error generating lesson plan:', error);
        
        if (error instanceof NetworkError || error.isNetworkError) {
            showNetworkError(error.message, error.message.includes('log in'));
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            showNetworkError('Network connection failed. Please check your internet connection and try again.', false);
        } else {
            showNetworkError('Failed to generate lesson plan. Please check your connection and try again.', false);
        }
    } finally {
        setLoadingState(false);
    }
}

// ===== 2. TOPIC CATEGORIZATION FUNCTION =====
function categorizeTopic(topic) {
    const topicLower = topic.toLowerCase();
    
    if (topicLower.includes('quadratic') || topicLower.includes('parabola')) {
        return 'quadratic';
    } else if (topicLower.includes('linear') || topicLower.includes('slope')) {
        return 'linear';
    } else if (topicLower.includes('trigonometry') || topicLower.includes('sine') || topicLower.includes('cosine')) {
        return 'trigonometry';
    } else if (topicLower.includes('logarithm') || topicLower.includes('exponential')) {
        return 'exponential_logarithmic';
    } else if (topicLower.includes('polynomial') || topicLower.includes('cubic')) {
        return 'polynomial';
    } else if (topicLower.includes('calculus') || topicLower.includes('derivative')) {
        return 'calculus';
    } else if (topicLower.includes('geometry') || topicLower.includes('triangle') || topicLower.includes('circle')) {
        return 'geometry';
    } else if (topicLower.includes('statistics') || topicLower.includes('probability')) {
        return 'statistics';
    } else {
        return 'algebra';
    }
}
// Make sure you're calling displayMathLessonPlan, NOT displayMathLessonPlanEnhanced
// ===== 3. ENHANCED LESSON PLAN DISPLAY (REMOVES STEP NUMBERING) =====
function displayEnhancedMathLessonPlan(lessonPlan) {
    const previewDiv = document.getElementById('lesson-plan-preview');
    const isConceptual = lessonPlan.content_type === 'conceptual';

    // Store lesson plan ID for editing
    if (lessonPlan.id) {
        window.currentLessonPlanId = lessonPlan.id;
        previewDiv.dataset.planId = lessonPlan.id;
    }

    // Build HTML for the lesson plan with enhanced formatting
    let html = `
        <h2>${formatMathNotation(lessonPlan.title)}</h2>
        <div class="preview-section">
            <h3>üìã Overview</h3>
            <div class="preview-item">
                <p><strong>Subject:</strong> ${lessonPlan.subject}</p>
                <p><strong>Grade Level:</strong> ${lessonPlan.grade_level}</p>
                <p><strong>Duration:</strong> ${lessonPlan.duration}</p>
                <p><strong>Difficulty:</strong> ${lessonPlan.difficulty}</p>
            </div>
        </div>
    `;

    // Add learning objectives
    if (lessonPlan.objectives) {
        html += `
            <div class="preview-section">
                <h3>üéØ Learning Objectives</h3>
                <div class="preview-item">
                    <ul>
                        ${Array.isArray(lessonPlan.objectives)
                          ? lessonPlan.objectives.map(obj => `<li>${formatMathNotation(obj)}</li>`).join('')
                          : `<li>${formatMathNotation(lessonPlan.objectives)}</li>`}
                    </ul>
                </div>
            </div>
        `;
    }

    // Add inspirational quote
    if (lessonPlan.quote) {
        html += `
            <div class="preview-section">
                <h3>üí¨ Inspirational Quote</h3>
                <div class="preview-item" style="background: #f3e5f5; border-left: 4px solid #9c27b0; font-style: italic; text-align: center; padding: 25px;">
                    "${formatMathNotation(lessonPlan.quote)}"
                </div>
            </div>
        `;
    }

    // Add key formulas / key concepts
    if (lessonPlan.key_formulas) {
        const formulasTitle = isConceptual ? 'üìö Key Concepts' : 'üî¢ Key Formulas';
        html += `
            <div class="preview-section">
                <h3>${formulasTitle}</h3>
                <div class="preview-item">
                    ${Array.isArray(lessonPlan.key_formulas)
                      ? lessonPlan.key_formulas.map(formula =>
                          `<div class="math-formula">${formatMathNotation(formula)}</div>`
                        ).join('')
                      : `<div class="math-formula">${formatMathNotation(lessonPlan.key_formulas)}</div>`}
                </div>
            </div>
        `;
    }

    // Solution method (only for calculation-based content)
    if (!isConceptual && lessonPlan.solution_method) {
        html += `
            <div class="preview-section">
                <h3>üìù Solution Method</h3>
                <div class="preview-item">
                    <div class="solution-method-container">
                        ${formatSolutionMethod(lessonPlan.solution_method)}
                    </div>
                </div>
            </div>
        `;
    }

    // Worked examples / Illustrative examples
    if (lessonPlan.worked_examples) {
        const examplesTitle = isConceptual ? 'üí° Illustrative Examples' : 'üí° Worked Examples';
        html += `
            <div class="preview-section">
                <h3>${examplesTitle}</h3>
                <div class="preview-item">
                    ${Array.isArray(lessonPlan.worked_examples)
                      ? lessonPlan.worked_examples.map((example, index) =>
                          `<div class="worked-example">
                            <h4>Example ${index + 1}</h4>
                            <div class="example-content">${formatWorkedExample(example)}</div>
                          </div>`
                        ).join('')
                      : `<div class="worked-example">
                          <div class="example-content">${formatWorkedExample(lessonPlan.worked_examples)}</div>
                        </div>`}
                </div>
            </div>
        `;
    }

    // Add graphs with enhanced error handling
    if (lessonPlan.graphs && lessonPlan.graphs.length > 0) {
        html += `
            <div class="preview-section">
                <h3>üìä Mathematical Graphs</h3>
                <div class="preview-item">
                    ${lessonPlan.graphs.map((graph, index) =>
                        `<div class="graph-container" id="graph-${index}">
                            <div class="graph-loading" id="loading-${index}">üìä Loading graph...</div>
                            <div class="graph-error" id="error-${index}" style="display: none;">
                                ‚ö†Ô∏è Graph failed to load. <button onclick="retryGraph(${index}, '${graph.url}', '${graph.title}')">Try Again</button>
                            </div>
                            <div class="graph-info">
                                <h4>${graph.title}</h4>
                                <p>${formatMathNotation(graph.description)}</p>
                            </div>
                        </div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
}

function generateActionButtons() {
    return `
        <div class="action-buttons">
            ${window.currentLessonPlanId ? 
                `<button onclick="editLessonPlan('${window.currentLessonPlanId}')" class="action-button edit-btn">
                    ‚úèÔ∏è Edit Lesson Plan
                </button>
                <button onclick="shareLessonPlan('${window.currentLessonPlanId}')" class="action-button share-btn">
                    üîó Share Lesson
                </button>` : 
                `<button onclick="alert('This lesson plan needs to be saved first')" class="action-button edit-btn disabled" style="opacity: 0.6;">
                    üíæ Save First
                </button>`
            }
            <button onclick="generateMoreExamples()" class="action-button quiz-btn">
                ‚ûï Generate More Examples
            </button>
            <button onclick="generateQuiz()" class="action-button quiz-btn">
                üìù Create Quiz
            </button>
            <button onclick="downloadLesson()" class="action-button download-btn">
                üíæ Download Lesson
            </button>
        </div>
    `;
}

// Make sure this CSS is applied for the step generation loading state
const additionalStepCSS = `
.loading-examples {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 30px;
    color: #666;
    font-style: italic;
}

.loading-examples::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.step-generation-error {
    background: #ffebee;
    color: #c62828;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e57373;
    text-align: center;
    margin-top: 15px;
}
`;

// Inject the additional CSS
const additionalStyleElement = document.createElement('style');
additionalStyleElement.textContent = additionalStepCSS;
document.head.appendChild(additionalStyleElement);

function generateDynamicStepsForExample(example, topic) {
    // Use AI to generate steps dynamically
    return generateAISteps(example, topic);
}

async function generateAISteps(example, topic) {
    try {
        const response = await fetch('/api/generate-example-steps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                example_text: example,
                topic: topic,
                request_type: 'step_by_step_solution'
            })
        });
        
        if (!response.ok) throw new Error('Failed to generate steps');
        
        const data = await response.json();
        return formatAIStepsHTML(data.steps);
        
    } catch (error) {
        console.error('Error generating AI steps:', error);
        return '<div class="step-error">Unable to generate step-by-step solution</div>';
    }
}

function formatAIStepsHTML(steps) {
    if (!steps || !Array.isArray(steps)) return '';
    
    let stepHtml = `
        <div class="step-by-step-in-example">
            <h5>Step-by-Step Solution:</h5>
            <div class="steps-container">
    `;
    
    steps.forEach((step, stepIndex) => {
        stepHtml += `
            <div class="step-item-inline">
                <div class="step-header-inline">
                    <span class="step-number-inline">STEP ${stepIndex + 1}</span>
                    <button class="hide-intermediate-btn-inline" onclick="toggleIntermediateStepsInline(0, ${stepIndex})" type="button">
                        üü† Show details
                    </button>
                </div>
                <div class="step-content-inline">
                    <div class="step-main-content-inline">${step.description}</div>
                    <div class="step-answer-inline">
                        <div class="answer-label-inline">Result:</div>
                        <div class="answer-content-inline">${step.answer}</div>
                    </div>
                </div>
                <div class="intermediate-steps-inline" id="intermediate-0-${stepIndex}" style="display: none;">
                    <div class="intermediate-header-inline">DETAILED WORK:</div>
                    <div class="intermediate-content-inline">
                        <div class="intermediate-explanation-inline">${step.work}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    stepHtml += '</div></div>';
    return stepHtml;
}
// Extract equations from text
function extractEquationsFromText(text) {
    const equations = [];
    
    // Pattern to match equations like "2x + 5 = 17", "y = 3x - 2", etc.
    const equationPattern = /([a-zA-Z0-9\+\-\*\/\(\)\s]+)\s*=\s*([a-zA-Z0-9\+\-\*\/\(\)\s]+)/g;
    let match;
    
    while ((match = equationPattern.exec(text)) !== null) {
        equations.push({
            left: match[1].trim(),
            right: match[2].trim(),
            full: match[0].trim()
        });
    }
    
    return equations;
}

// Updated function to extract numbers without step labels
function extractNumbersFromText(text) {
    const numbers = [];
    const coordinates = [];
    
    // Clean the text first
    const cleanText = text.replace(/Step\s+\d+:\s*/gi, '').replace(/Step\s+\d+\s+/gi, ' ');
    
    // Extract coordinates like (2, 3), (5, 7)
    const coordPattern = /\((\d+),\s*(\d+)\)/g;
    let coordMatch;
    while ((coordMatch = coordPattern.exec(cleanText)) !== null) {
        coordinates.push([parseInt(coordMatch[1]), parseInt(coordMatch[2])]);
    }
    
    // Extract standalone numbers
    const numberPattern = /\b\d+(\.\d+)?\b/g;
    let numMatch;
    while ((numMatch = numberPattern.exec(cleanText)) !== null) {
        numbers.push(parseFloat(numMatch[0]));
    }
    
    return { numbers, coordinates };
}

// Identify the type of mathematical problem
function identifyProblemType(text) {
    const textLower = text.toLowerCase();
    
    if (textLower.includes('point') && (textLower.includes('slope') || textLower.includes('line'))) {
        return 'point_slope';
    } else if (textLower.includes('slope') && textLower.includes('calculate')) {
        return 'slope_calculation';
    } else if (textLower.includes('solve') && /\d*[a-zA-Z]\s*[\+\-]\s*\d+\s*=\s*\d+/.test(text)) {
        return 'linear_equation';
    } else if (textLower.includes('system') || (textLower.includes('equation') && textLower.includes('two'))) {
        return 'system_equations';
    }
    
    return 'generic';
}

// Determine if an example should get dynamic steps
function shouldGenerateDynamicSteps(exampleText) {
    const indicators = [
        /solve|find|calculate|determine/i,
        /equation|formula|expression/i,
        /=|\+|\-|\*|\/|\^/,
        /\d+[a-zA-Z]|\d+\s*[a-zA-Z]/,  // Numbers with variables
        /\([^)]*\)/  // Parentheses indicating mathematical expressions
    ];
    
    return indicators.some(pattern => pattern.test(exampleText));
}
    
/**
 * Enhanced Mathematical Analyzer for dynamic problem recognition
 */
class MathematicalAnalyzer {
    constructor() {
        this.patterns = {
            linear: /\b\d*[a-zA-Z]\s*[+\-]\s*\d+\s*=\s*\d+/,
            quadratic: /\b\d*[a-zA-Z]\^?2|[a-zA-Z]¬≤/,
            slope: /slope|point.*point|coordinate/i,
            trigonometry: /sin|cos|tan|angle|triangle/i,
            logarithm: /log|ln|exponential/i,
            calculus: /derivative|integral|limit/i,
            geometry: /area|perimeter|volume|radius|diameter/i,
            statistics: /mean|median|mode|standard deviation|probability/i
        };
    }

    identifyProblemType(problemText) {
        const text = problemText.toLowerCase();
        
        for (const [type, pattern] of Object.entries(this.patterns)) {
            if (pattern.test(text)) {
                return `${type}_equation`;
            }
        }
        
        return 'generic';
    }

    extractElements(problemText) {
        const numbers = this.extractNumbers(problemText);
        const variables = this.extractVariables(problemText);
        const operations = this.extractOperations(problemText);
        
        return {
            given: numbers.concat(variables),
            toFind: this.identifyTarget(problemText),
            formulas: this.suggestFormulas(problemText),
            setup: this.generateSetup(problemText),
            calculations: this.generateCalculations(numbers, operations),
            simplification: this.generateSimplification(problemText),
            verification: this.generateVerification(problemText),
            interpretation: this.generateInterpretation(problemText),
            result: numbers.length > 0 ? numbers[numbers.length - 1] : 'Result',
            finalAnswer: this.generateFinalAnswer(problemText)
        };
    }

    extractNumbers(text) {
        const matches = text.match(/-?\d+(?:\.\d+)?/g);
        return matches ? matches.map(Number) : [];
    }

    extractVariables(text) {
        const matches = text.match(/\b[a-zA-Z]\b/g);
        return matches ? [...new Set(matches)] : [];
    }

    extractOperations(text) {
        const operations = [];
        if (text.includes('+')) operations.push('addition');
        if (text.includes('-')) operations.push('subtraction');
        if (text.includes('*') || text.includes('√ó')) operations.push('multiplication');
        if (text.includes('/') || text.includes('√∑')) operations.push('division');
        return operations;
    }

    identifyTarget(text) {
        if (text.includes('solve')) return 'Solution for variable';
        if (text.includes('find')) return 'Unknown value';
        if (text.includes('calculate')) return 'Calculated result';
        return 'Answer';
    }

    suggestFormulas(text) {
        const formulas = [];
        if (this.patterns.linear.test(text)) formulas.push('ax + b = c');
        if (this.patterns.quadratic.test(text)) formulas.push('ax¬≤ + bx + c = 0');
        if (this.patterns.slope.test(text)) formulas.push('m = (y‚ÇÇ - y‚ÇÅ)/(x‚ÇÇ - x‚ÇÅ)');
        return formulas.length > 0 ? formulas : ['Apply relevant mathematical principles'];
    }

    generateSetup(text) {
        return 'Set up the equation based on the given information';
    }

    generateCalculations(numbers, operations) {
        if (numbers.length >= 2 && operations.length > 0) {
            return `Using numbers: ${numbers.join(', ')}\nOperations: ${operations.join(', ')}`;
        }
        return 'Perform the required mathematical operations';
    }

    generateSimplification(text) {
        return 'Simplify the expression and combine like terms';
    }

    generateVerification(text) {
        return 'Substitute the answer back into the original equation';
    }

    generateInterpretation(text) {
        return 'Interpret the result in the context of the problem';
    }

    generateFinalAnswer(text) {
        return 'Final answer with appropriate units and format';
    }
}

/**
 * Enhanced Equation Extractor for linear equations
 */
class EquationExtractor {
    extractLinearEquation(problemText) {
        const equationMatch = problemText.match(/([^=]+)=([^=]+)/);
        if (!equationMatch) return null;

        const leftSide = equationMatch[1].trim();
        const rightSide = equationMatch[2].trim();
        const original = `${leftSide} = ${rightSide}`;

        // Parse left side for variable and coefficient
        const variableMatch = leftSide.match(/([+-]?\d*)([a-zA-Z])/);
        const constantMatch = leftSide.match(/([+-]?\d+)(?![a-zA-Z])/);

        if (!variableMatch) return null;

        const coefficient = variableMatch[1] === '' || variableMatch[1] === '+' ? 1 : 
                          variableMatch[1] === '-' ? -1 : parseInt(variableMatch[1]);
        const variable = variableMatch[2];
        const constant = constantMatch ? parseInt(constantMatch[1]) : 0;
        const rightValue = parseInt(rightSide);

        // Generate solution steps
        const isolatedRight = rightValue - constant;
        const solution = isolatedRight / coefficient;

        return {
            original,
            variable,
            coefficient,
            constant,
            rightValue,
            isolationWork: this.generateIsolationWork(variable, coefficient, constant, rightValue),
            variableTerm: `${coefficient}${variable}`,
            rightSide: isolatedRight,
            divisionWork: this.generateDivisionWork(coefficient, variable, isolatedRight),
            solution,
            verification: this.generateVerification(original, variable, solution),
            verificationSubstitution: this.generateVerificationSubstitution(coefficient, variable, constant, solution, rightValue)
        };
    }

    generateIsolationWork(variable, coefficient, constant, rightValue) {
        if (constant === 0) return 'No constants to move';
        
        const operation = constant > 0 ? 'subtract' : 'add';
        const absConstant = Math.abs(constant);
        
        return `${operation} ${absConstant} from both sides:
${coefficient}${variable} ${constant > 0 ? '+' : '-'} ${absConstant} ${constant > 0 ? '-' : '+'} ${absConstant} = ${rightValue} ${constant > 0 ? '-' : '+'} ${absConstant}
${coefficient}${variable} = ${rightValue - constant}`;
    }

    generateDivisionWork(coefficient, variable, rightSide) {
        if (coefficient === 1) return `${variable} is already isolated`;
        
        return `Divide both sides by ${coefficient}:
${coefficient}${variable} √∑ ${coefficient} = ${rightSide} √∑ ${coefficient}
${variable} = ${rightSide / coefficient}`;
    }

    generateVerification(original, variable, solution) {
        return `Substitute ${variable} = ${solution} into: ${original}
Check: Left side = Right side ‚úì`;
    }

    generateVerificationSubstitution(coefficient, variable, constant, solution, rightValue) {
        const leftResult = coefficient * solution + constant;
        return `${coefficient}(${solution}) + ${constant} = ${rightValue}
${leftResult} = ${rightValue} ‚úì`;
    }
}

/**
 * Format dynamic steps into HTML
 */
function formatDynamicStepsHTML(steps, exampleIndex) {
    if (!steps || steps.length === 0) return '';
    
    let stepHtml = `
        <div class="step-by-step-in-example">
            <h5>Step-by-Step Solution:</h5>
            <div class="steps-container">
    `;
    
    steps.forEach((step, stepIndex) => {
        // Ensure step has all required properties
        const description = step.description || step.text || `Step ${stepIndex + 1}`;
        const work = step.work || step.mathematicalWork || '';
        const result = step.result || step.answer || '';
        const reasoning = step.reasoning || '';
        const hints = Array.isArray(step.hints) ? step.hints : [];
        const commonMistakes = Array.isArray(step.common_mistakes) ? step.common_mistakes : [];
        
        const hasIntermediateContent = (hints.length > 0) || 
                                      (commonMistakes.length > 0) ||
                                      (reasoning && reasoning.length > 0);
        
        stepHtml += `
            <div class="step-item-inline">
                <div class="step-header-inline">
                    <span class="step-number-inline">STEP ${stepIndex + 1}</span>
                    ${hasIntermediateContent ? `
                        <button class="hide-intermediate-btn-inline" onclick="toggleIntermediateStepsInline(${exampleIndex}, ${stepIndex})" type="button">
                            üü† Show details
                        </button>
                    ` : ''}
                </div>
                <div class="step-content-inline">
                    <div class="step-main-content-inline">${formatMathNotation(description)}</div>
                    
                    ${work ? `
                    <div class="step-work-shown">
${formatMathNotation(work)}
                    </div>
                    ` : ''}
                    
                    ${reasoning ? `
                    <div class="step-reasoning">
                        <strong>Reasoning:</strong> ${formatMathNotation(reasoning)}
                    </div>
                    ` : ''}
                    
                    ${result ? `
                    <div class="step-answer-inline">
                        <div class="answer-label-inline">RESULT:</div>
                        <div class="answer-content-inline">${formatMathNotation(result)}</div>
                    </div>
                    ` : ''}
                </div>
                
                ${hasIntermediateContent ? `
                <div class="intermediate-steps-inline" id="intermediate-${exampleIndex}-${stepIndex}" style="display: none;">
                    <div class="intermediate-header-inline">DETAILED INSIGHTS:</div>
                    <div class="intermediate-content-inline">
                        ${hints.length > 0 ? `
                        <div class="intermediate-explanation-inline">
                            <strong>üí° Helpful Hints:</strong><br>
                            ${hints.map(hint => `‚Ä¢ ${formatMathNotation(hint)}`).join('<br>')}
                        </div>
                        ` : ''}
                        
                        ${commonMistakes.length > 0 ? `
                        <div class="intermediate-explanation-inline">
                            <strong>‚ö†Ô∏è Common Mistakes to Avoid:</strong><br>
                            ${commonMistakes.map(mistake => `‚Ä¢ ${formatMathNotation(mistake)}`).join('<br>')}
                        </div>
                        ` : ''}
                        
                        ${reasoning ? `
                        <div class="intermediate-explanation-inline">
                            <strong>üìö Mathematical Reasoning:</strong><br>
                            ${formatMathNotation(reasoning)}
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    });
    
    stepHtml += `
            </div>
        </div>
    `;
    
    return stepHtml;
}

// Enhanced CSS for dynamic steps
const dynamicStepCSS = `
.step-reasoning {
    background: #e8f4fd;
    padding: 12px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 3px solid #2196f3;
    font-style: italic;
}

.key-point {
    background: #fff3e0;
    padding: 12px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 3px solid #ff9800;
    font-weight: 500;
}

.step-work-shown {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    line-height: 2.2;
    color: #2c3e50;
    border-left: 5px solid #34495e;
    white-space: pre-line;
    box-shadow: 0 4px 12px rgba(52, 73, 94, 0.1);
    position: relative;
}

.step-work-shown::before {
    content: "üî¢";
    position: absolute;
    top: -8px;
    left: 15px;
    background: white;
    padding: 4px 8px;
    border-radius: 50%;
    font-size: 1rem;
    border: 2px solid #34495e;
}
`;

// Inject the dynamic step CSS
const dynamicStyleElement = document.createElement('style');
dynamicStyleElement.textContent = dynamicStepCSS;
document.head.appendChild(dynamicStyleElement);

// Add this at the beginning of your script section

// Interactive evaluation helper functions
function selectMCOption(questionId, optionText, element) {
    // Remove selected class from all options in this question
    const allOptions = element.closest('.mc-options').querySelectorAll('.mc-option');
    allOptions.forEach(opt => opt.classList.remove('selected'));
    
    // Add selected class to clicked option
    element.classList.add('selected');
    
    // Save answer
    if (!userAnswers[questionId]) {
        userAnswers[questionId] = {};
    }
    userAnswers[questionId] = optionText;
}

function saveParagraphAnswer(questionId, value) {
    if (!userAnswers[questionId]) {
        userAnswers[questionId] = '';
    }
    userAnswers[questionId] = value;
}

// Make sure these are defined before use
window.selectMCOption = selectMCOption;
window.saveParagraphAnswer = saveParagraphAnswer;

// Update the formatSolutionMethod function to remove step numbering properly
function formatSolutionMethod(method) {
    if (!method) return '';
    
    // Remove step numbering and format as flowing content
    let formatted = method
        .replace(/Step\s+\d+[:\s]*/gi, '') // Remove "Step 1:", "Step 2:", etc.
        .replace(/^\d+\.\s*/gm, '') // Remove numbered list items
        .split('\n')
        .filter(line => line.trim())
        .map(line => `<p class="method-step">${formatMathNotation(line.trim())}</p>`)
        .join('');
    
    return formatted;
}

// Enhanced formatWorkedExample function that uses dynamic steps
async function formatWorkedExampleNoFallback(example, index = 0) {
    if (!example) return '';

    // Clean the example
    let cleaned = example.replace(/Example\s+\d+[:\s]*/gi, '');

    // Convert newlines to <br> tags for proper line break display
    cleaned = cleaned.replace(/\n/g, '<br>');
    
    // Check if this example needs step-by-step breakdown
    if (cleaned.length > 50 && shouldGenerateDynamicSteps(cleaned)) {
        try {
            console.log(`Generating dynamic steps for example ${index + 1}`);
            
            // Get current lesson context
            const topic = window.currentTopic || document.getElementById('topic')?.value || 'mathematics';
            const gradeLevel = document.getElementById('grade-level')?.value || 'high';
            const subject = document.querySelector('.subject-tab.active')?.dataset?.subject || 'mathematics';
            
            // Initialize the dynamic step generator
            const stepGenerator = window.enhancedStepGenerator || new DynamicStepGeneratorNoFallback();
            
            // Generate dynamic steps - this will throw NetworkError if it fails
            const steps = await stepGenerator.generateSteps(cleaned, topic, gradeLevel, subject);
            
            console.log(`Generated ${steps.length} dynamic steps for example ${index + 1}`);
            const stepsHTML = formatDynamicStepsHTML(steps, index);
            return `
                <div class="example-content">${formatMathNotation(cleaned)}</div>
                ${stepsHTML}
            `;
            
        } catch (error) {
            console.error(`Error generating dynamic steps for example ${index + 1}:`, error);
            
            // Return network error display instead of fallback
            return createNetworkErrorExampleHTML(cleaned, error);
        }
    }
    
    // For simple examples that don't need step-by-step breakdown
    return `<div class="example-content">${formatMathNotation(cleaned)}</div>`;
}

// Enhanced generateDynamicMathSteps with better error handling
async function generateDynamicMathSteps(exampleText, exampleIndex) {
    try {
        console.log(`Attempting AI step generation for example ${exampleIndex + 1}`);
        const aiSteps = await generateAIStepsForExample(exampleText);
        if (aiSteps && aiSteps.length > 0) {
            console.log(`AI generated ${aiSteps.length} steps for example ${exampleIndex + 1}`);
            return formatMathStepsHTML(aiSteps, exampleIndex);
        }
    } catch (error) {
        console.error(`AI step generation failed for example ${exampleIndex + 1}:`, error);
    }
    
    // Fallback: Analyze the mathematical content and generate appropriate steps
    console.log(`Using mathematical analysis fallback for example ${exampleIndex + 1}`);
    const mathSteps = analyzeMathematicalContent(exampleText);
    return formatMathStepsHTML(mathSteps, exampleIndex);
}

// Fixed generateAIStepsForExample with better error handling
async function generateAIStepsForExample(exampleText) {
    const token = getAuthToken();
    if (!token) {
        throw new Error('No authentication token available');
    }
    
    const topic = document.getElementById('topic')?.value?.trim() || 'mathematics';
    const subjectTab = document.querySelector('.subject-tab.active');
    const subject = subjectTab?.dataset?.subject || 'mathematics';
    
    try {
        console.log('Making API request to generate example steps...');
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/generate-example-steps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                example_text: exampleText,
                topic: topic,
                subject: subject,
                request_type: 'step_by_step_solution',
                format: 'detailed_steps'
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('API response received:', data);
        
        if (data.steps && Array.isArray(data.steps)) {
            return data.steps;
        } else {
            console.warn('API response does not contain valid steps array:', data);
            return [];
        }
        
    } catch (error) {
        console.error('Error in generateAIStepsForExample:', error);
        throw error;
    }
}

// 5. Network error display functions
function showNetworkError(message, showLoginOption = false) {
    const errorDiv = document.getElementById('error-message');
    if (!errorDiv) return;
    
    errorDiv.innerHTML = `
        <div class="network-error-container">
            <div class="network-error-icon">‚ö†Ô∏è</div>
            <div class="network-error-message">${message}</div>
            <div class="network-error-actions">
                <button onclick="retryLastAction()" class="retry-button">
                    üîÑ Try Again
                </button>
                ${showLoginOption ? `
                    <a href="/index.html" class="login-button">
                        üîë Log In
                    </a>
                ` : ''}
            </div>
        </div>
    `;
    
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth' });
}

function createNetworkErrorExampleHTML(cleaned, error) {
    const errorMessage = error instanceof NetworkError ? error.message : 'Network error occurred. Please try again.';
    
    return `
        <div class="example-content">${formatMathNotation(cleaned)}</div>
        <div class="step-generation-network-error">
            <div class="network-error-container">
                <div class="network-error-icon">üåê</div>
                <div class="network-error-message">
                    Step-by-step solution could not be loaded.<br>
                    ${errorMessage}
                </div>
                <div class="network-error-actions">
                    <button onclick="retryStepGeneration(this)" class="retry-button">
                        üîÑ Retry Steps
                    </button>
                </div>
            </div>
        </div>
    `;
}

// 6. Interactive evaluation without fallbacks
async function validateAndFixDragDropEvaluationNoFallback(evaluationData) {
    if (!evaluationData || !evaluationData.questions) {
        throw new NetworkError('Evaluation data missing. Please try generating the lesson plan again.');
    }

    for (let question of evaluationData.questions) {
        if (question.type === 'drag_drop_matching') {
            if (!question.pairs || question.pairs.length === 0) {
                throw new NetworkError('Interactive evaluation data incomplete. Please try again.');
            }
        }
        
        if (question.type === 'drag_drop_ordering') {
            if (!question.items || question.items.length === 0) {
                throw new NetworkError('Interactive evaluation data incomplete. Please try again.');
            }
        }
    }
}

// 7. Retry functions
function retryLastAction() {
    // Clear error message
    const errorDiv = document.getElementById('error-message');
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    
    // Retry the lesson plan generation
    generateEnhancedMathLessonPlanNoFallback();
}

async function retryStepGeneration(button) {
    const errorContainer = button.closest('.step-generation-network-error');
    const exampleContent = errorContainer.previousElementSibling;
    
    if (!exampleContent) return;
    
    // Show loading in button
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Retrying...';
    button.disabled = true;
    
    try {
        // Extract example text
        const exampleText = exampleContent.textContent || exampleContent.innerText;
        
        // Get context
        const topic = window.currentTopic || 'mathematics';
        const gradeLevel = document.getElementById('grade-level')?.value || 'high';
        const subject = document.querySelector('.subject-tab.active')?.dataset?.subject || 'mathematics';
        
        // Retry step generation
        const stepGenerator = new DynamicStepGeneratorNoFallback();
        const steps = await stepGenerator.generateSteps(exampleText, topic, gradeLevel, subject);
        
        // Replace error with steps
        const stepsHTML = formatDynamicStepsHTML(steps, 0);
        errorContainer.outerHTML = stepsHTML;
        
    } catch (error) {
        // Update error message
        const errorMessage = error instanceof NetworkError ? error.message : 'Still unable to load steps. Please try again.';
        const messageDiv = errorContainer.querySelector('.network-error-message');
        if (messageDiv) {
            messageDiv.innerHTML = `Step-by-step solution could not be loaded.<br>${errorMessage}`;
        }
        
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// 8. Enhanced CSS for network errors
const networkErrorCSS = `
.network-error-container {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    border: 2px solid #f44336;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
}

.network-error-icon {
    font-size: 3rem;
    margin-bottom: 15px;
}

.network-error-message {
    color: #c62828;
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 20px;
    line-height: 1.5;
}

.network-error-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.retry-button {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
}

.retry-button:hover:not(:disabled) {
    background: linear-gradient(135deg, #d32f2f, #c62828);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
}

.retry-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.login-button {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.login-button:hover {
    background: linear-gradient(135deg, #1976d2, #1565c0);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
}

.step-generation-network-error {
    margin: 20px 0;
}
`;

// Inject the CSS
const networkErrorStyleElement = document.createElement('style');
networkErrorStyleElement.textContent = networkErrorCSS;
document.head.appendChild(networkErrorStyleElement);

// 9. Initialize the no-fallback system
window.generateEnhancedMathLessonPlan = generateEnhancedMathLessonPlanNoFallback;
window.formatWorkedExample = formatWorkedExampleNoFallback;
window.NetworkError = NetworkError;

console.log('Network Error System Initialized - No Fallback Logic');
console.log('System will show "try again" prompts instead of fallback content');

function generateEnhancedMathLessonPlan() {
    return generateEnhancedMathLessonPlanNoFallback();
}

// Analyze mathematical content to generate appropriate steps
function analyzeMathematicalContent(text) {
    const elements = extractMathematicalElements(text);
    const problemType = identifyMathProblemType(text);
    
    switch (problemType) {
        case 'linear_equation':
            return generateLinearEquationSteps(elements, text);
        case 'quadratic_equation':
            return generateQuadraticSteps(elements, text);
        case 'slope_calculation':
            return generateSlopeSteps(elements, text);
        case 'system_equations':
            return generateSystemSteps(elements, text);
        case 'trigonometry':
            return generateTrigSteps(elements, text);
        case 'logarithm':
            return generateLogSteps(elements, text);
        default:
            return generateGenericMathSteps(text, elements);
    }
}

// Enhanced mathematical element extraction
function extractMathematicalElements(text) {
    const elements = {
        equations: [],
        numbers: [],
        coordinates: [],
        variables: [],
        operations: [],
        functions: []
    };
    
    // Extract equations (e.g., "2x + 3 = 7", "y = mx + b")
    const equationPattern = /([a-zA-Z0-9\+\-\*\/\(\)\^\s]+)\s*=\s*([a-zA-Z0-9\+\-\*\/\(\)\^\s]+)/g;
    let match;
    while ((match = equationPattern.exec(text)) !== null) {
        elements.equations.push({
            left: match[1].trim(),
            right: match[2].trim(),
            full: match[0].trim()
        });
    }
    
    // Extract coordinates like (2, 3), (-1, 5)
    const coordPattern = /\((-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)\)/g;
    while ((match = coordPattern.exec(text)) !== null) {
        elements.coordinates.push([parseFloat(match[1]), parseFloat(match[2])]);
    }
    
    // Extract standalone numbers
    const numberPattern = /-?\d+(?:\.\d+)?/g;
    while ((match = numberPattern.exec(text)) !== null) {
        elements.numbers.push(parseFloat(match[0]));
    }
    
    // Extract variables
    const variablePattern = /\b[a-zA-Z]\b/g;
    while ((match = variablePattern.exec(text)) !== null) {
        if (!elements.variables.includes(match[0])) {
            elements.variables.push(match[0]);
        }
    }
    
    // Extract functions
    const functionPattern = /(sin|cos|tan|log|ln|sqrt|exp)\s*\(/gi;
    while ((match = functionPattern.exec(text)) !== null) {
        if (!elements.functions.includes(match[1].toLowerCase())) {
            elements.functions.push(match[1].toLowerCase());
        }
    }
    
    return elements;
}

// Identify the type of mathematical problem
function identifyMathProblemType(text) {
    const textLower = text.toLowerCase();
    
    if (textLower.includes('quadratic') || textLower.includes('x¬≤') || textLower.includes('x^2')) {
        return 'quadratic_equation';
    } else if (textLower.includes('slope') && (textLower.includes('point') || textLower.includes('coordinate'))) {
        return 'slope_calculation';
    } else if (textLower.includes('system') || (textLower.includes('equation') && textLower.includes('two'))) {
        return 'system_equations';
    } else if (textLower.includes('solve') && /\d*[a-zA-Z]\s*[\+\-]\s*\d+\s*=\s*\d+/.test(text)) {
        return 'linear_equation';
    } else if (textLower.includes('sin') || textLower.includes('cos') || textLower.includes('tan') || textLower.includes('trigonometry')) {
        return 'trigonometry';
    } else if (textLower.includes('log') || textLower.includes('logarithm') || textLower.includes('exponential')) {
        return 'logarithm';
    }
    
    return 'generic';
}

// Enhanced function to generate steps with actual mathematical work
function generateLinearEquationSteps(elements, text) {
    if (elements.equations.length === 0) {
        return generateGenericMathSteps(text, elements);
    }
    
    const equation = elements.equations[0];
    const steps = [];
    
    // Parse equation: 2x - 3 = 5x + 1
    const leftMatch = equation.left.match(/(-?\d*)([a-zA-Z])\s*([\+\-])\s*(\d+)/);
    const rightMatch = equation.right.match(/(-?\d*)([a-zA-Z])\s*([\+\-])\s*(\d+)/) || 
                      equation.right.match(/^(-?\d+)$/);
    
    if (leftMatch) {
        const leftCoeff = leftMatch[1] === '' ? '1' : (leftMatch[1] === '-' ? '-1' : leftMatch[1]);
        const variable = leftMatch[2];
        const leftOp = leftMatch[3];
        const leftConst = leftMatch[4];
        
        let rightCoeff = '0';
        let rightConst = equation.right.trim();
        
        if (rightMatch && rightMatch.length > 4) {
            rightCoeff = rightMatch[1] === '' ? '1' : (rightMatch[1] === '-' ? '-1' : rightMatch[1]);
            rightConst = rightMatch[4];
        }
        
        // STEP 1: Collect variable terms
        steps.push({
            description: `Collect all variable terms on one side and constants on the other`,
            work: `Starting equation: ${equation.full}

Subtract ${rightCoeff !== '0' ? rightCoeff + variable : '0'} from both sides:
${leftCoeff}${variable} ${leftOp} ${leftConst} - ${rightCoeff !== '0' ? rightCoeff + variable : '0'} = ${rightConst} ${rightCoeff !== '0' ? '- ' + rightCoeff + variable : ''}

Simplifying:
${leftCoeff !== rightCoeff ? (parseInt(leftCoeff) - parseInt(rightCoeff)) + variable : variable} ${leftOp} ${leftConst} = ${rightConst}`,
            answer: `${leftCoeff !== rightCoeff ? (parseInt(leftCoeff) - parseInt(rightCoeff)) + variable : variable} ${leftOp} ${leftConst} = ${rightConst}`
        });
        
        const finalCoeff = leftCoeff !== rightCoeff ? (parseInt(leftCoeff) - parseInt(rightCoeff)) : parseInt(leftCoeff);
        const rightSide = leftOp === '+' ? parseInt(rightConst) - parseInt(leftConst) : parseInt(rightConst) + parseInt(leftConst);
        
        // STEP 2: Isolate variable term
        steps.push({
            description: `${leftOp === '+' ? 'Subtract' : 'Add'} ${leftConst} ${leftOp === '+' ? 'from' : 'to'} both sides`,
            work: `${finalCoeff}${variable} ${leftOp} ${leftConst} ${leftOp === '+' ? '-' : '+'} ${leftConst} = ${rightConst} ${leftOp === '+' ? '-' : '+'} ${leftConst}

The ${leftOp === '+' ? '+' : '-'}${leftConst} terms cancel out on the left:
${finalCoeff}${variable} + 0 = ${rightSide}

Simplified:
${finalCoeff}${variable} = ${rightSide}`,
            answer: `${finalCoeff}${variable} = ${rightSide}`
        });
        
        // STEP 3: Solve for variable
        if (finalCoeff !== 1) {
            const solution = rightSide / finalCoeff;
            steps.push({
                description: `Divide both sides by ${finalCoeff} to isolate ${variable}`,
                work: `${finalCoeff}${variable} = ${rightSide}

Divide both sides by ${finalCoeff}:
${finalCoeff}${variable} √∑ ${finalCoeff} = ${rightSide} √∑ ${finalCoeff}

Simplifying:
${variable} = ${solution}`,
                answer: `${variable} = ${solution}`
            });
        }
        
        // STEP 4: Verify solution
        const finalSolution = rightSide / finalCoeff;
        steps.push({
            description: `Verify the solution by substituting back into the original equation`,
            work: `Original equation: ${equation.full}
Substitute ${variable} = ${finalSolution}:

Left side: ${leftCoeff}(${finalSolution}) ${leftOp} ${leftConst}
= ${parseInt(leftCoeff) * finalSolution} ${leftOp} ${leftConst}
= ${parseInt(leftCoeff) * finalSolution + (leftOp === '+' ? parseInt(leftConst) : -parseInt(leftConst))}

Right side: ${rightConst}

Check: ${parseInt(leftCoeff) * finalSolution + (leftOp === '+' ? parseInt(leftConst) : -parseInt(leftConst))} = ${rightConst} ‚úì`,
            answer: `Solution verified: ${variable} = ${finalSolution}`
        });
    }
    
    return steps.length > 0 ? steps : generateGenericMathSteps(text, elements);
}

// Enhanced CSS for mathematical work display
const enhancedStepCSS = `
.step-work-shown {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    line-height: 2.2;
    color: #2c3e50;
    border-left: 5px solid #34495e;
    white-space: pre-line;
    box-shadow: 0 4px 12px rgba(52, 73, 94, 0.1);
    position: relative;
}

.step-work-shown::before {
    content: "üìù";
    position: absolute;
    top: -8px;
    left: 15px;
    background: white;
    padding: 4px 8px;
    border-radius: 50%;
    font-size: 1rem;
}

/* Enhanced mathematical notation within work */
.step-work-shown .math-inline {
    background: #fff3cd;
    padding: 3px 8px;
    border-radius: 4px;
    font-family: 'Times New Roman', serif;
    font-weight: 600;
    border: 1px solid #ffc107;
    margin: 0 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
`;

// Inject the enhanced CSS
const enhancedStyleElement = document.createElement('style');
enhancedStyleElement.textContent = enhancedStepCSS;
document.head.appendChild(enhancedStyleElement);

// Generate steps for quadratic equations
function generateQuadraticSteps(elements, text) {
    const steps = [
        {
            description: `Identify the quadratic equation and write it in standard form`,
            work: `Standard form: ax¬≤ + bx + c = 0
Rearrange the equation if necessary
Identify the coefficients a, b, and c`,
            answer: `Quadratic equation in standard form identified`
        },
        {
            description: `Determine the best solution method (factoring, completing the square, or quadratic formula)`,
            work: `Check if the equation can be factored easily
If not, consider completing the square
The quadratic formula works for all quadratic equations: x = (-b ¬± ‚àö(b¬≤ - 4ac)) / 2a`,
            answer: `Solution method selected`
        },
        {
            description: `Apply the chosen method to solve for the variable`,
            work: `Calculate the discriminant: b¬≤ - 4ac
If discriminant > 0: two real solutions
If discriminant = 0: one real solution  
If discriminant < 0: two complex solutions
Apply the quadratic formula or factoring`,
            answer: `Solutions calculated`
        },
        {
            description: `Verify the solutions and interpret the results`,
            work: `Substitute each solution back into the original equation
Check that both sides are equal
Interpret the solutions in the context of the problem`,
            answer: `Solutions verified and interpreted`
        }
    ];
    
    return steps;
}

// Generate steps for slope calculations
function generateSlopeSteps(elements, text) {
    if (elements.coordinates.length >= 2) {
        const [x1, y1] = elements.coordinates[0];
        const [x2, y2] = elements.coordinates[1];
        const slope = (y2 - y1) / (x2 - x1);
        
        return [
            {
                description: `Identify the two points and recall the slope formula`,
                work: `Point 1: (${x1}, ${y1})
Point 2: (${x2}, ${y2})
Slope formula: m = (y‚ÇÇ - y‚ÇÅ) / (x‚ÇÇ - x‚ÇÅ)
This formula gives us the rate of change between two points`,
                answer: `Points identified: (${x1}, ${y1}) and (${x2}, ${y2})`
            },
            {
                description: `Substitute the coordinate values into the slope formula`,
                work: `m = (y‚ÇÇ - y‚ÇÅ) / (x‚ÇÇ - x‚ÇÅ)
m = (${y2} - ${y1}) / (${x2} - ${x1})
Substitute the y-coordinates in the numerator
Substitute the x-coordinates in the denominator`,
                answer: `m = (${y2} - ${y1}) / (${x2} - ${x1})`
            },
            {
                description: `Calculate the differences in the numerator and denominator`,
                work: `Numerator: ${y2} - ${y1} = ${y2 - y1}
Denominator: ${x2} - ${x1} = ${x2 - x1}
m = ${y2 - y1} / ${x2 - x1}`,
                answer: `m = ${y2 - y1} / ${x2 - x1}`
            },
            {
                description: `Simplify the fraction to get the final slope`,
                work: `m = ${y2 - y1} / ${x2 - x1}
${x2 - x1 !== 1 ? `m = ${slope}` : `m = ${y2 - y1}`}
${slope > 0 ? 'Positive slope: line rises from left to right' : slope < 0 ? 'Negative slope: line falls from left to right' : 'Zero slope: horizontal line'}`,
                answer: `Slope = ${slope}`
            }
        ];
    }
    
    return generateGenericMathSteps(text, elements);
}

// Generate steps for trigonometry problems
function generateTrigSteps(elements, text) {
    return [
        {
            description: `Identify the trigonometric function and given information`,
            work: `Determine which trigonometric ratio to use: sin, cos, or tan
Identify the known sides or angles
Set up the relationship using SOH-CAH-TOA if working with right triangles`,
            answer: `Trigonometric setup identified`
        },
        {
            description: `Set up the trigonometric equation`,
            work: `Write the equation using the appropriate trig function
For example: sin(Œ∏) = opposite/hypotenuse
Substitute known values into the equation`,
            answer: `Trigonometric equation established`
        },
        {
            description: `Solve for the unknown using inverse trigonometric functions`,
            work: `Use inverse functions (arcsin, arccos, arctan) when solving for angles
Use algebraic manipulation when solving for sides
Pay attention to the domain and range of the functions`,
            answer: `Solution calculated using inverse trig functions`
        },
        {
            description: `Check the reasonableness of the answer`,
            work: `Verify that angles are within expected ranges
Check that side lengths are positive and reasonable
Consider the context of the problem`,
            answer: `Solution verified and interpreted`
        }
    ];
}

// Generate generic mathematical steps when specific parsing fails
function generateGenericMathSteps(text, elements) {
    const hasEquations = elements && elements.equations && elements.equations.length > 0;
    const hasNumbers = elements && elements.numbers && elements.numbers.length > 0;
    const hasCoordinates = elements && elements.coordinates && elements.coordinates.length > 0;
    
    return [
        {
            description: `Read and analyze the mathematical problem`,
            work: `Carefully read the problem statement
Identify what information is given
Determine what needs to be found
${hasEquations ? `Equation identified: ${elements.equations[0].full}` : ''}
${hasCoordinates ? `Coordinates found: ${elements.coordinates.map(coord => `(${coord[0]}, ${coord[1]})`).join(', ')}` : ''}`,
            answer: `Problem analyzed and key information identified`
        },
        {
            description: `Choose the appropriate mathematical method or formula`,
            work: `Select the relevant mathematical principle
${hasEquations ? `Work with the equation: ${elements.equations[0].full}` : 'Set up the necessary equations or relationships'}
${hasNumbers ? `Key numbers: ${elements.numbers.slice(0, 5).join(', ')}${elements.numbers.length > 5 ? '...' : ''}` : ''}
Plan the solution approach step by step`,
            answer: `Solution method selected and equations set up`
        },
        {
            description: `Execute the mathematical calculations`,
            work: `Perform the necessary operations in logical order
Show all algebraic manipulations clearly
Simplify expressions step by step
${hasNumbers ? `Calculate using: ${elements.numbers.slice(0, 3).join(', ')}${elements.numbers.length > 3 ? '...' : ''}` : 'Apply mathematical operations systematically'}`,
            answer: `Calculations completed and expressions simplified`
        },
        {
            description: `Verify the solution and state the final answer`,
            work: `Check the solution by substitution if possible
Verify that the answer makes sense in context
Express the answer with appropriate units or formatting
Consider alternative solution methods as verification`,
            answer: `Solution verified and final answer determined`
        }
    ];
}

// // Enhanced function to format steps with actual mathematical work
function formatMathStepsHTML(steps, exampleIndex) {
    if (!steps || steps.length === 0) return '';
    
    let stepHtml = `
        <div class="step-by-step-in-example">
            <h5>Step-by-Step Solution:</h5>
            <div class="steps-container">
    `;
    
    steps.forEach((step, stepIndex) => {
        stepHtml += `
            <div class="step-item-inline">
                <div class="step-header-inline">
                    <span class="step-number-inline">STEP ${stepIndex + 1}</span>
                    <button class="hide-intermediate-btn-inline" onclick="toggleIntermediateStepsInline(${exampleIndex}, ${stepIndex})" type="button">
                        üü† Hide intermediate steps
                    </button>
                </div>
                <div class="step-content-inline">
                    <div class="step-main-content-inline">${formatMathNotation(step.description)}</div>
                    
                    <!-- ENHANCED: Add mathematical work section -->
                    <div class="step-work-shown">
${formatMathNotation(step.work)}
                    </div>
                    
                    <div class="step-answer-inline">
                        <div class="answer-label-inline">ANSWER:</div>
                        <div class="answer-content-inline">${formatMathNotation(step.answer)}</div>
                    </div>
                </div>
                <div class="intermediate-steps-inline" id="intermediate-${exampleIndex}-${stepIndex}" style="display: none;">
                    <div class="intermediate-header-inline">DETAILED WORK:</div>
                    <div class="intermediate-content-inline">
                        <div class="intermediate-explanation-inline">
                            <strong>Mathematical reasoning:</strong><br>
                            ${formatMathNotation(step.work)}<br><br>
                            <strong>Key concepts applied:</strong><br>
                            ${generateKeyConceptsForStep(step, stepIndex)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    stepHtml += `
            </div>
        </div>
    `;
    
    return stepHtml;
}

// Generate key mathematical concepts for each step
function generateKeyConceptsForStep(step, stepIndex) {
    const stepDescription = step.description.toLowerCase();
    
    if (stepDescription.includes('identify') || stepDescription.includes('analyze')) {
        return "Problem identification and mathematical reasoning techniques";
    } else if (stepDescription.includes('isolate') || stepDescription.includes('subtract') || stepDescription.includes('add')) {
        return "Algebraic manipulation using inverse operations and properties of equality";
    } else if (stepDescription.includes('divide') || stepDescription.includes('multiply')) {
        return "Multiplication and division properties of equality";
    } else if (stepDescription.includes('substitute') || stepDescription.includes('verify')) {
        return "Solution verification through substitution and logical reasoning";
    } else if (stepDescription.includes('slope') || stepDescription.includes('coordinate')) {
        return "Coordinate geometry principles and slope calculation methods";
    } else if (stepDescription.includes('quadratic') || stepDescription.includes('formula')) {
        return "Quadratic equations and discriminant analysis";
    } else if (stepDescription.includes('trigonometric') || stepDescription.includes('sin') || stepDescription.includes('cos')) {
        return "Trigonometric ratios and inverse trigonometric functions";
    } else {
        return "Fundamental mathematical problem-solving strategies";
    }
}

// Toggle function for intermediate steps
function toggleIntermediateStepsInline(exampleIndex, stepIndex) {
    const intermediateDiv = document.getElementById(`intermediate-${exampleIndex}-${stepIndex}`);
    const button = event.target;
    
    if (!intermediateDiv) {
        console.error(`No intermediate div found for example ${exampleIndex}, step ${stepIndex}`);
        return;
    }
    
    if (intermediateDiv.style.display === 'none' || !intermediateDiv.style.display) {
        // Show intermediate steps
        intermediateDiv.style.display = 'block';
        button.innerHTML = 'üü† Hide intermediate steps';
        button.setAttribute('data-state', 'shown');
        
        // Add smooth animation
        intermediateDiv.style.opacity = '0';
        intermediateDiv.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            intermediateDiv.style.transition = 'all 0.4s ease';
            intermediateDiv.style.opacity = '1';
            intermediateDiv.style.transform = 'translateY(0)';
        }, 10);
        
    } else {
        // Hide intermediate steps
        intermediateDiv.style.transition = 'all 0.4s ease';
        intermediateDiv.style.opacity = '0';
        intermediateDiv.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            intermediateDiv.style.display = 'none';
            button.innerHTML = 'üü† Show intermediate steps';
            button.setAttribute('data-state', 'hidden');
        }, 400);
    }
}

// Update the main lesson plan display function to use dynamic steps
async function displayEnhancedMathLessonPlanNoFallback(lessonPlan) {
    const previewDiv = document.getElementById('lesson-plan-preview');
    
    if (lessonPlan.id) {
        window.currentLessonPlanId = lessonPlan.id;
        previewDiv.dataset.planId = lessonPlan.id;
    }
    
    // Build basic HTML first
    let html = buildBasicLessonHTML(lessonPlan);
    
    // Display immediately
    previewDiv.innerHTML = html;
    previewDiv.classList.add('show');
    
    // NOW handle worked examples with dynamic steps (only for calculation-based content)
    const isConceptual = lessonPlan.content_type === 'conceptual';
    if (!isConceptual && lessonPlan.worked_examples) {
        try {
            console.log('Generating worked examples with dynamic steps...');

            const topic = window.currentTopic || document.getElementById('topic')?.value || 'mathematics';
            const gradeLevel = document.getElementById('grade-level')?.value || 'high';
            const subject = document.querySelector('.subject-tab.active')?.dataset?.subject || 'mathematics';

            // Store context for step generator
            window.currentTopic = topic;

            // Find worked examples section in the displayed HTML
            const examplesSection = Array.from(previewDiv.querySelectorAll('.preview-section'))
                .find(section => {
                    const h3 = section.querySelector('h3');
                    return h3 && (h3.textContent.includes('Worked Examples') || h3.textContent.includes('Illustrative Examples'));
                });

            if (examplesSection) {
                const examplesContent = examplesSection.querySelector('.preview-item');

                if (examplesContent) {
                    // Show loading state
                    examplesContent.innerHTML = '<div class="loading-examples">üìù Generating detailed step-by-step solutions...</div>';

                    // Generate examples with dynamic steps
                    const examplesHTML = await generateWorkedExamplesWithDynamicSteps(
                        lessonPlan.worked_examples,
                        topic,
                        gradeLevel,
                        subject
                    );

                    // Update with generated examples
                    examplesContent.innerHTML = examplesHTML;
                    console.log('‚úÖ Successfully updated worked examples');
                }
            }
        } catch (error) {
            console.error('Error generating dynamic examples:', error);

            // Show network error for worked examples section
            const examplesSection = Array.from(previewDiv.querySelectorAll('.preview-section'))
                .find(section => {
                    const h3 = section.querySelector('h3');
                    return h3 && (h3.textContent.includes('Worked Examples') || h3.textContent.includes('Illustrative Examples'));
                });

            if (examplesSection) {
                const examplesContent = examplesSection.querySelector('.preview-item');
                if (examplesContent) {
                    examplesContent.innerHTML = `
                        <div class="step-generation-network-error">
                            <div class="network-error-container">
                                <div class="network-error-icon">üåê</div>
                                <div class="network-error-message">
                                    Step-by-step solutions could not be loaded.<br>
                                    ${error instanceof NetworkError ? error.message : 'Network error occurred. Please try again.'}
                                </div>
                                <div class="network-error-actions">
                                    <button onclick="retryWorkedExamples()" class="retry-button">
                                        üîÑ Retry Loading Steps
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }
    }
    
    // Load graphs with retry
    if (lessonPlan.graphs && lessonPlan.graphs.length > 0) {
        setTimeout(() => {
            lessonPlan.graphs.forEach((graph, index) => {
                loadGraphWithRetry(graph, index);
            });
        }, 100);
    }
    
    // Add interactive evaluation
    if (lessonPlan.interactive_evaluation) {
        setTimeout(() => {
            addInteractiveEvaluation(lessonPlan.interactive_evaluation);
        }, 200);
    }
    
    // Render MathJax
    if (window.MathJax) {
        MathJax.typesetPromise([previewDiv]).catch((err) => {
            console.error('MathJax rendering failed:', err);
        });
    }
    
    // Scroll to lesson plan
    setTimeout(() => {
        previewDiv.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}


// Fixed buildBasicLessonHTML function
function buildBasicLessonHTML(lessonPlan) {
    let html = `
        <h2>${formatMathNotation(lessonPlan.title || 'Math Lesson Plan')}</h2>
        <div class="preview-section">
            <h3>üìã Overview</h3>
            <div class="preview-item">
                <p><strong>Subject:</strong> ${lessonPlan.subject || 'Mathematics'}</p>
                <p><strong>Grade Level:</strong> ${lessonPlan.grade_level || 'Not specified'}</p>
                <p><strong>Duration:</strong> ${lessonPlan.duration || 'Not specified'}</p>
                <p><strong>Difficulty:</strong> ${lessonPlan.difficulty || 'Not specified'}</p>
            </div>
        </div>
    `;

    // Add other sections (objectives, quote, formulas, step-by-step method)
    html = addBasicLessonSections(lessonPlan, html);

    // Add Lesson Notes BEFORE examples
    if (lessonPlan.lesson_notes && lessonPlan.lesson_notes.trim()) {
        const notesContent = lessonPlan.lesson_notes.replace(/\n/g, '<br>');
        html += `
            <div class="preview-section">
                <h3>üìñ Lesson Notes</h3>
                <div class="preview-item" style="line-height: 1.8; font-size: 1rem;">
                    ${formatMathNotation(notesContent)}
                </div>
            </div>
        `;
    }

    // Add YouTube Video section (after lesson notes, before examples)
    html += buildYouTubeSection(lessonPlan);

    // Add placeholder for worked examples / illustrative examples
    if (lessonPlan.worked_examples &&
        ((Array.isArray(lessonPlan.worked_examples) && lessonPlan.worked_examples.length > 0) ||
         (typeof lessonPlan.worked_examples === 'string' && lessonPlan.worked_examples.trim()))) {
        const isConceptual = lessonPlan.content_type === 'conceptual';
        const examplesTitle = isConceptual ? 'üí° Illustrative Examples' : 'üí° Worked Examples';

        if (isConceptual) {
            // For conceptual content, render examples directly without step-by-step generation
            html += `
                <div class="preview-section">
                    <h3>${examplesTitle}</h3>
                    <div class="preview-item">
                        ${Array.isArray(lessonPlan.worked_examples)
                          ? lessonPlan.worked_examples.map((example, index) =>
                              `<div class="worked-example">
                                <h4>Example ${index + 1}</h4>
                                <div class="example-content">${formatWorkedExample(example)}</div>
                              </div>`
                            ).join('')
                          : `<div class="worked-example">
                              <div class="example-content">${formatWorkedExample(lessonPlan.worked_examples)}</div>
                            </div>`}
                    </div>
                </div>
            `;
        } else {
            // For calculation content, show loading placeholder for step-by-step generation
            html += `
                <div class="preview-section">
                    <h3>${examplesTitle}</h3>
                    <div class="preview-item">
                        <div class="loading-examples" style="text-align: center; padding: 20px; color: #666;">
                            üìù Generating step-by-step solutions...
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Continue with other sections...
    html = addRemainingLessonSections(lessonPlan, html);
    html += generateActionButtons();

    return html;
}

// Generate worked examples with dynamic steps
async function generateWorkedExamplesWithDynamicSteps(workedExamples, topic, gradeLevel, subject) {
    let examplesHTML = '';
    
    try {
        if (Array.isArray(workedExamples)) {
            for (let i = 0; i < workedExamples.length; i++) {
                console.log(`Processing example ${i + 1} with dynamic steps...`);
                
                try {
                    const exampleHTML = await formatWorkedExampleNoFallback(workedExamples[i], i, topic, gradeLevel, subject);
                    examplesHTML += `
                        <div class="worked-example">
                            <h4>Example ${i + 1}</h4>
                            ${exampleHTML}
                        </div>
                    `;
                } catch (exampleError) {
                    console.error(`Error processing example ${i + 1}:`, exampleError);
                    
                    // Show error for this specific example
                    examplesHTML += `
                        <div class="worked-example">
                            <h4>Example ${i + 1}</h4>
                            <div class="example-content">${formatMathNotation(workedExamples[i])}</div>
                            ${createNetworkErrorExampleHTML(workedExamples[i], exampleError)}
                        </div>
                    `;
                }
            }
        } else {
            console.log('Processing single example with dynamic steps...');
            const exampleHTML = await formatWorkedExampleNoFallback(workedExamples, 0, topic, gradeLevel, subject);
            examplesHTML = `
                <div class="worked-example">
                    <h4>Example 1</h4>
                    ${exampleHTML}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error in generateWorkedExamplesWithDynamicSteps:', error);
        throw error; // Re-throw to be caught by caller
    }
    
    return examplesHTML;
}

async function retryWorkedExamples() {
    const previewDiv = document.getElementById('lesson-plan-preview');
    const examplesSection = Array.from(previewDiv.querySelectorAll('.preview-section'))
        .find(section => {
            const h3 = section.querySelector('h3');
            return h3 && h3.textContent.includes('Worked Examples');
        });
    
    if (!examplesSection) return;
    
    const examplesContent = examplesSection.querySelector('.preview-item');
    if (!examplesContent) return;
    
    // Show loading
    examplesContent.innerHTML = '<div class="loading-examples">üìù Retrying step-by-step solutions...</div>';
    
    try {
        // Get lesson plan data
        const lessonPlanId = previewDiv.dataset.planId;
        if (!lessonPlanId) {
            throw new Error('No lesson plan ID found');
        }
        
        const token = getAuthToken();
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/math-lesson-plans/${lessonPlanId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        const lessonPlan = data.lesson_plan;
        
        if (lessonPlan && lessonPlan.content && lessonPlan.content.worked_examples) {
            const topic = window.currentTopic || document.getElementById('topic')?.value || 'mathematics';
            const gradeLevel = document.getElementById('grade-level')?.value || 'high';
            const subject = document.querySelector('.subject-tab.active')?.dataset?.subject || 'mathematics';
            
            const examplesHTML = await generateWorkedExamplesWithDynamicSteps(
                lessonPlan.content.worked_examples,
                topic,
                gradeLevel,
                subject
            );
            
            examplesContent.innerHTML = examplesHTML;
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([examplesContent]);
            }
        }
    } catch (error) {
        console.error('Retry failed:', error);
        examplesContent.innerHTML = `
            <div class="step-generation-network-error">
                <div class="network-error-container">
                    <div class="network-error-icon">‚ùå</div>
                    <div class="network-error-message">
                        Retry failed. Please refresh the page and try again.
                    </div>
                </div>
            </div>
        `;
    }
}

// Make retry function global
window.retryWorkedExamples = retryWorkedExamples;

// Enhanced CSS for dynamic steps
const enhancedDynamicCSS = `
.dynamic-steps-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 30px;
    background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
    border-radius: 10px;
    margin: 20px 0;
    border: 2px dashed #3498db;
}

.loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-text {
    color: #2c3e50;
    font-weight: 600;
    font-style: italic;
}

.step-generation-notice {
    background: #e8f5e8;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #4caf50;
    margin: 15px 0;
    color: #2e7d32;
}

.step-generation-error {
    background: #ffebee;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #f44336;
    margin: 15px 0;
    color: #c62828;
}

.step-reasoning {
    background: #e8f4fd;
    padding: 15px;
    border-radius: 8px;
    margin: 12px 0;
    border-left: 4px solid #2196f3;
    font-style: italic;
    line-height: 1.6;
}

.key-point {
    background: #fff3e0;
    padding: 15px;
    border-radius: 8px;
    margin: 12px 0;
    border-left: 4px solid #ff9800;
    font-weight: 500;
    line-height: 1.6;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Enhanced step header for dynamic steps */
.step-header-inline {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    font-weight: 600;
    position: relative;
}

.step-header-inline::before {
    content: 'ü§ñ';
    margin-right: 10px;
    font-size: 1.2em;
}

/* Enhanced intermediate content for dynamic steps */
.intermediate-explanation-inline {
    background: white;
    padding: 18px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #ff9800;
    line-height: 1.7;
    font-size: 1rem;
    color: #424242;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
}
`;

// Inject enhanced CSS
const enhancedDynamicStyleElement = document.createElement('style');
enhancedDynamicStyleElement.textContent = enhancedDynamicCSS;
document.head.appendChild(enhancedDynamicStyleElement);

// Initialize the enhanced dynamic step generator

// Update the main generation function to use the dynamic system
const originalGenerateFunction = window.generateEnhancedMathLessonPlan;
window.generateEnhancedMathLessonPlan = async function() {
    // Call original function but with dynamic steps enabled
    return originalGenerateFunction.call(this);
};

// Export for global use
window.displayEnhancedMathLessonPlanWithDynamicSteps = displayEnhancedMathLessonPlanWithDynamicSteps;

// Add missing addBasicLessonSections function
function addBasicLessonSections(lessonPlan, html) {
    const isConceptual = lessonPlan.content_type === 'conceptual';

    // Add learning objectives
    if (lessonPlan.objectives) {
        html += `
            <div class="preview-section">
                <h3>üéØ Learning Objectives</h3>
                <div class="preview-item">
                    <ul>
                        ${Array.isArray(lessonPlan.objectives)
                          ? lessonPlan.objectives.map(obj => `<li>${formatMathNotation(obj)}</li>`).join('')
                          : `<li>${formatMathNotation(lessonPlan.objectives)}</li>`}
                    </ul>
                </div>
            </div>
        `;
    }

    // Add inspirational quote
    if (lessonPlan.quote) {
        html += `
            <div class="preview-section">
                <h3>üí¨ Inspirational Quote</h3>
                <div class="preview-item" style="background: #f3e5f5; border-left: 4px solid #9c27b0; font-style: italic; text-align: center; padding: 25px;">
                    "${formatMathNotation(lessonPlan.quote)}"
                </div>
            </div>
        `;
    }

    // Add key formulas / key concepts
    if (lessonPlan.key_formulas) {
        const formulasTitle = isConceptual ? 'üìö Key Concepts' : 'üî¢ Key Formulas';
        html += `
            <div class="preview-section">
                <h3>${formulasTitle}</h3>
                <div class="preview-item">
                    ${Array.isArray(lessonPlan.key_formulas)
                      ? lessonPlan.key_formulas.map(formula =>
                          `<div class="math-formula">${formatMathNotation(formula)}</div>`
                        ).join('')
                      : `<div class="math-formula">${formatMathNotation(lessonPlan.key_formulas)}</div>`}
                </div>
            </div>
        `;
    }

    // Add solution method (only for calculation-based content)
    if (!isConceptual && lessonPlan.solution_method) {
        html += `
            <div class="preview-section">
                <h3>üìù Solution Method</h3>
                <div class="preview-item">
                    <div class="solution-method-container">
                        ${formatSolutionMethod(lessonPlan.solution_method)}
                    </div>
                </div>
            </div>
        `;
    }

    return html;
}

// Add missing addRemainingLessonSections function
function addRemainingLessonSections(lessonPlan, html) {
    // Add graphs section - hidden by default, only shown if graphs load successfully
    if (lessonPlan.graphs && lessonPlan.graphs.length > 0) {
        html += `
            <div class="preview-section graphs-section" id="graphs-section" style="display: none;">
                <h3>üìä Mathematical Graphs</h3>
                <div class="preview-item">
                    ${lessonPlan.graphs.map((graph, index) =>
                        `<div class="graph-container" id="graph-${index}">
                            <div class="graph-loading" id="loading-${index}">üìä Loading graph...</div>
                            <div class="graph-info" style="display: none;">
                                <h4>${graph.title}</h4>
                                <p>${formatMathNotation(graph.description || '')}</p>
                            </div>
                        </div>`
                    ).join('')}
                </div>
            </div>
        `;
    }

    // Add practice problems / review questions (only if content exists)
    const isConceptual = lessonPlan.content_type === 'conceptual';
    if (lessonPlan.practice_problems &&
        ((Array.isArray(lessonPlan.practice_problems) && lessonPlan.practice_problems.length > 0) ||
         (typeof lessonPlan.practice_problems === 'string' && lessonPlan.practice_problems.trim()))) {
        const problemsTitle = isConceptual ? 'üéØ Review Questions' : 'üéØ Practice Problems';
        const itemLabel = isConceptual ? 'Question' : 'Problem';
        html += `
            <div class="preview-section">
                <h3>${problemsTitle}</h3>
                <div class="practice-problems">
                    ${Array.isArray(lessonPlan.practice_problems)
                      ? lessonPlan.practice_problems.map((problem, index) =>
                          `<div class="problem">
                            <strong>${itemLabel} ${index + 1}:</strong> ${formatMathNotation(problem)}
                          </div>`
                        ).join('')
                      : `<div class="problem">${formatMathNotation(lessonPlan.practice_problems)}</div>`}
                </div>
            </div>
        `;
    }

    // Add other sections using the existing function
    return addOtherLessonSections(lessonPlan, html);
}


function loadDynamicContent(lessonPlan) {
    // Load graphs after HTML is set
    if (lessonPlan.graphs && lessonPlan.graphs.length > 0) {
        let graphsLoaded = 0;
        let graphsFailed = 0;
        const totalGraphs = lessonPlan.graphs.length;

        setTimeout(() => {
            lessonPlan.graphs.forEach((graph, index) => {
                loadGraphWithRetry(graph, index, () => {
                    // On success callback
                    graphsLoaded++;
                    // Show graphs section only when at least one graph loads
                    const graphsSection = document.getElementById('graphs-section');
                    if (graphsSection) graphsSection.style.display = '';
                }, () => {
                    // On failure callback - hide the individual container
                    graphsFailed++;
                    const container = document.getElementById(`graph-${index}`);
                    if (container) container.style.display = 'none';
                    // If ALL graphs failed, keep the whole section hidden
                    if (graphsFailed === totalGraphs) {
                        const graphsSection = document.getElementById('graphs-section');
                        if (graphsSection) graphsSection.style.display = 'none';
                    }
                });
            });
        }, 100);
    }

    // Add interactive evaluation if available
    if (lessonPlan.interactive_evaluation) {
        setTimeout(() => {
            addInteractiveEvaluation(lessonPlan.interactive_evaluation);
        }, 200);
    }
}

function loadGraphWithRetry(graph, index, onSuccess, onFailure) {
    const img = new Image();
    const loadingDiv = document.getElementById(`loading-${index}`);
    const container = document.getElementById(`graph-${index}`);

    // If graph has no URL, hide silently
    if (!graph.url) {
        if (container) container.style.display = 'none';
        if (onFailure) onFailure();
        return;
    }

    let retryCount = 0;
    const maxRetries = 3;

    function attemptLoad() {
        img.onload = function() {
            if (loadingDiv) loadingDiv.style.display = 'none';

            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            img.style.marginBottom = '15px';

            // Show the graph info
            const graphInfo = container.querySelector('.graph-info');
            if (graphInfo) {
                graphInfo.style.display = '';
                container.insertBefore(img, graphInfo);
            } else {
                container.appendChild(img);
            }

            if (onSuccess) onSuccess();
        };

        img.onerror = function() {
            retryCount++;
            if (retryCount < maxRetries) {
                console.log(`Graph load failed, retrying (${retryCount}/${maxRetries})...`);
                setTimeout(() => attemptLoad(), 1000 * retryCount);
            } else {
                // Silently hide the failed graph - no error message shown
                if (container) container.style.display = 'none';
                if (onFailure) onFailure();
            }
        };

        const separator = graph.url.includes('?') ? '&' : '?';
        img.src = graph.url + `${separator}t=${Date.now()}`;
    }

    attemptLoad();
}

// Add this after storing currentLessonPlanId

async function renderGeometryShape(shapeConfig, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    try {
        const response = await fetch('/api/geometry/render-shape', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(shapeConfig)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.image) {
            container.innerHTML = `
                <img src="${data.image}" alt="${shapeConfig.title}" 
                     class="shape-image" style="max-width: 100%; height: auto; border-radius: 8px;">
            `;
        } else {
            throw new Error(data.error || 'Failed to render shape');
        }
        
    } catch (error) {
        console.error(`Error rendering ${shapeConfig.title}:`, error);
        container.innerHTML = `
            <div class="shape-error">
                Failed to load ${shapeConfig.title}
                <button onclick="renderGeometryShape(${JSON.stringify(shapeConfig)}, '${containerId}')" 
                        style="display: block; margin: 10px auto; padding: 5px 10px; background: #f72585; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Retry
                </button>
            </div>
        `;
    }
}

// ===== 6. ENHANCED GRAPH LOADING WITH RETRY =====
function loadGraphWithRetry(graph, index) {
    const img = new Image();
    const loadingDiv = document.getElementById(`loading-${index}`);
    const errorDiv = document.getElementById(`error-${index}`);
    const container = document.getElementById(`graph-${index}`);
    
    let retryCount = 0;
    const maxRetries = 3;
    
    function attemptLoad() {
        img.onload = function() {
            if (loadingDiv) loadingDiv.style.display = 'none';
            if (errorDiv) errorDiv.style.display = 'none';
            
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            img.style.marginBottom = '15px';
            
            const graphInfo = container.querySelector('.graph-info');
            container.insertBefore(img, graphInfo);
        };
        
        img.onerror = function() {
            retryCount++;
            if (retryCount < maxRetries) {
                console.log(`Graph load failed, retrying (${retryCount}/${maxRetries})...`);
                setTimeout(() => attemptLoad(), 1000 * retryCount);
            } else {
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = `
                        ‚ö†Ô∏è Graph failed to load after ${maxRetries} attempts. 
                        <button onclick="retryGraph(${index}, '${graph.url}', '${graph.title}')">Try Again</button>
                    `;
                }
            }
        };
        
        img.src = graph.url + `&t=${Date.now()}`; // Add timestamp to prevent caching issues
    }
    
    attemptLoad();
}
const additionalCSS = `
/* Solution Method Styling */
.solution-method-container {
    background: #f0f8ff;
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid #3498db;
}

.method-step {
    margin: 15px 0;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border-left: 3px solid #2ecc71;
    line-height: 1.6;
}

/* Worked Example Styling */
.example-problem {
    background: #fff3cd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid #ffc107;
}

.example-solution {
    background: #e8f5e8;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #28a745;
}

/* Geometry Shapes Styling */
.geometry-shapes-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
}

.shapes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.shape-container {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
}

.shape-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.shape-image-container {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
}

.shape-loading {
    color: #6c757d;
    font-style: italic;
}

.shape-error {
    color: #e74c3c;
    text-align: center;
    padding: 20px;
}

.shape-image {
    transition: transform 0.3s ease;
    cursor: pointer;
}

.shape-image:hover {
    transform: scale(1.05);
}
`;

// Inject the additional CSS
const style = document.createElement('style');
style.textContent = additionalCSS;
document.head.appendChild(style);

// Enhanced mathematical notation formatter
function formatMathNotation(text) {
    if (!text) return text;
    
    return text
        // Handle derivative notation
        .replace(/d\/dx/g, '<span class="math-symbol">d/dx</span>')
        .replace(/lim\s*h‚Üí0/g, '<span class="math-limit">lim<sub>h‚Üí0</sub></span>')
        .replace(/lim\s*h->0/g, '<span class="math-limit">lim<sub>h‚Üí0</sub></span>')
        
        // Enhanced superscripts - handle more cases
        .replace(/\^2/g, '¬≤')
        .replace(/\^3/g, '¬≥')
        .replace(/\^4/g, '‚Å¥')
        .replace(/\^5/g, '‚Åµ')
        .replace(/\^n/g, '‚Åø')
        .replace(/\^-1/g, '‚Åª¬π')
        .replace(/\^-2/g, '‚Åª¬≤')
        .replace(/\^(-?\d+)/g, (match, exp) => {
            const superscripts = {
                '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥', '5': '‚Åµ',
                '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ', '-': '‚Åª'
            };
            return exp.split('').map(char => superscripts[char] || char).join('');
        })
        
        // Enhanced subscripts
        .replace(/_1/g, '‚ÇÅ')
        .replace(/_2/g, '‚ÇÇ')
        .replace(/_3/g, '‚ÇÉ')
        .replace(/_n/g, '‚Çô')
        .replace(/_i/g, '·µ¢')
        .replace(/_0/g, '‚ÇÄ')
        .replace(/_(\d+)/g, (match, num) => {
            const subscripts = {
                '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ',
                '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ'
            };
            return num.split('').map(char => subscripts[char] || char).join('');
        })
        
        // Greek letters
        .replace(/\bpi\b/gi, 'œÄ')
        .replace(/\balpha\b/gi, 'Œ±')
        .replace(/\bbeta\b/gi, 'Œ≤')
        .replace(/\bgamma\b/gi, 'Œ≥')
        .replace(/\bdelta\b/gi, 'Œ¥')
        .replace(/\btheta\b/gi, 'Œ∏')
        .replace(/\blambda\b/gi, 'Œª')
        .replace(/\bmu\b/gi, 'Œº')
        .replace(/\bsigma\b/gi, 'œÉ')
        .replace(/\bomega\b/gi, 'œâ')
        
        // Enhanced mathematical symbols
        .replace(/\+\/-/g, '¬±')
        .replace(/\+-/g, '¬±')
        .replace(/infinity/gi, '‚àû')
        .replace(/<=/g, '‚â§')
        .replace(/>=/g, '‚â•')
        .replace(/!=/g, '‚â†')
        .replace(/\*/g, '√ó')
        .replace(/\bdiv\b/g, '√∑')
        .replace(/sqrt\(/g, '‚àö(')
        .replace(/\bdeg\b/g, '¬∞')
        
        // Simplified fraction notation - use Unicode characters for common fractions
        .replace(/\b1\/2\b/g, '¬Ω')
        .replace(/\b1\/3\b/g, '‚Öì')
        .replace(/\b2\/3\b/g, '‚Öî')
        .replace(/\b1\/4\b/g, '¬º')
        .replace(/\b3\/4\b/g, '¬æ')
        .replace(/\b1\/5\b/g, '‚Öï')
        .replace(/\b1\/8\b/g, '‚Öõ')
        // Leave other fractions as plain text (e.g., 5/7 stays as 5/7)
        
        // Units with superscripts
        .replace(/m\^2/g, 'm¬≤')
        .replace(/m\^3/g, 'm¬≥')
        .replace(/cm\^2/g, 'cm¬≤')
        .replace(/cm\^3/g, 'cm¬≥')
        .replace(/km\^2/g, 'km¬≤')
        .replace(/s\^-1/g, 's‚Åª¬π')
        
        // Keep equations simple - no HTML wrapping that can break rendering
        // Leave = signs and expressions as plain text for better compatibility
        
        // Format step equations nicely
        .replace(/Step\s+(\d+):/gi, '<strong class="step-marker">Step $1:</strong>')
        
        // Clean up multiple spaces and formatting
        .replace(/\s+/g, ' ')
        .trim();
}

// Additional CSS for enhanced mathematical formatting
const enhancedMathCSS = `
/* Enhanced mathematical notation styles */
.math-symbol {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    font-weight: bold;
    color: #1976d2;
    background: rgba(25, 118, 210, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
}

.math-limit {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    color: #7b1fa2;
    background: rgba(123, 31, 162, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
}

.equation-equals {
    font-weight: bold;
    color: #d32f2f;
    margin: 0 5px;
    font-size: 1.1em;
}

.math-expression {
    font-family: 'Courier New', monospace;
    background: rgba(0, 150, 136, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
}

.math-variable {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    font-weight: bold;
    color: #1976d2;
    font-size: 1.1em;
}

.math-value {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: #2e7d32;
}

.math-highlight-zero {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
}

.math-highlight-undefined {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.step-marker {
    color: #1976d2;
    font-size: 1.1em;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* Enhanced fraction styling */
.fraction {
    display: inline-block;
    vertical-align: middle;
    text-align: center;
    font-family: 'Times New Roman', serif;
    margin: 0 3px;
}

.numerator {
    display: block;
    border-bottom: 2px solid #333;
    padding-bottom: 2px;
    font-weight: 600;
}

.denominator {
    display: block;
    padding-top: 2px;
    font-weight: 600;
}

/* Step work container enhancements */
.step-work-shown {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    line-height: 2.2;
    color: #2c3e50;
    border-left: 5px solid #34495e;
    white-space: pre-line;
    box-shadow: 0 4px 12px rgba(52, 73, 94, 0.1);
    position: relative;
}

.step-work-shown::before {
    content: "üî¢";
    position: absolute;
    top: -8px;
    left: 15px;
    background: white;
    padding: 4px 8px;
    border-radius: 50%;
    font-size: 1rem;
    border: 2px solid #34495e;
}

.step-main-content-inline {
    font-size: 1.1rem;
    color: #1565c0;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    border-radius: 8px;
    border-left: 5px solid #4caf50;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
}

.answer-content-inline {
    font-size: 1.3rem;
    font-weight: 700;
    color: #e65100;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.8);
    padding: 15px 20px;
    border-radius: 8px;
    text-align: center;
    border: 2px solid rgba(255,193,7,0.4);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    margin-top: 8px;
}
`;

// Inject the enhanced mathematical CSS
const mathStyleElement = document.createElement('style');
mathStyleElement.textContent = enhancedMathCSS;
document.head.appendChild(mathStyleElement);

// Generate default visual aids based on topic
function generateDefaultVisualAids(topic) {
    const topicLower = (topic || '').toLowerCase();
    
    if (topicLower.includes('linear')) {
        return [
            "Coordinate grid paper for plotting linear equations",
            "Colored pencils for graphing different lines",
            "Ruler for drawing straight lines accurately",
            "Calculator for computing slope and intercepts",
            "Interactive graphing software or apps"
        ];
    } else if (topicLower.includes('quadratic')) {
        return [
            "Parabola templates for sketching quadratic functions",
            "Graphing calculator for exploring quadratic relationships",
            "Algebra tiles for factoring quadratic expressions",
            "Coordinate plane worksheets",
            "Online graphing tools for dynamic visualization"
        ];
    } else if (topicLower.includes('fraction')) {
        return [
            "Fraction circles and bars for visual representation",
            "Number line for comparing fractions",
            "Pie charts for fraction visualization",
            "Fraction manipulatives and blocks",
            "Interactive fraction apps and websites"
        ];
    } else {
        return [
            "Graphing calculator for mathematical computations",
            "Coordinate grid paper for plotting relationships", 
            "Mathematical manipulatives for hands-on learning",
            "Interactive whiteboard for dynamic demonstrations",
            "Online mathematical simulation tools"
        ];
    }
}

// Simple graph loading without complex dependencies
function loadGraphSimple(graph, index) {
    const img = new Image();
    const loadingDiv = document.getElementById(`loading-${index}`);
    const errorDiv = document.getElementById(`error-${index}`);
    const container = document.getElementById(`graph-${index}`);
    
    img.onload = function() {
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (errorDiv) errorDiv.style.display = 'none';
        
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        img.style.marginBottom = '15px';
        
        const graphInfo = container.querySelector('.graph-info');
        container.insertBefore(img, graphInfo);
    };
    
    img.onerror = function() {
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (errorDiv) errorDiv.style.display = 'block';
    };
    
    img.src = graph.url;
}

// Retry graph loading
function retryGraph(index, url, title) {
    const loadingDiv = document.getElementById(`loading-${index}`);
    const errorDiv = document.getElementById(`error-${index}`);
    
    if (loadingDiv) {
        loadingDiv.style.display = 'block';
        loadingDiv.textContent = 'üìä Retrying...';
    }
    if (errorDiv) errorDiv.style.display = 'none';
    
    loadGraphSimple({url: url, title: title}, index);
}

// Toggle intermediate steps for inline steps
function toggleIntermediateStepsInline(exampleIndex, stepIndex) {
    const intermediateDiv = document.getElementById(`intermediate-${exampleIndex}-${stepIndex}`);
    const button = event.target;
    
    if (!intermediateDiv) return;
    
    if (intermediateDiv.style.display === 'none' || !intermediateDiv.style.display) {
        intermediateDiv.style.display = 'block';
        button.innerHTML = 'üü† Hide intermediate steps';
    } else {
        intermediateDiv.style.display = 'none';
        button.innerHTML = 'üü† Show intermediate steps';
    }
}

function formatStepContent(step) {
    if (!step) return '';
    
    // Split step into lines and process each line
    const lines = step.split('\n').filter(line => line.trim());
    let mainContent = '';
    let answer = '';
    let hasAnswer = false;
    
    lines.forEach(line => {
        const trimmedLine = line.trim();
        if (trimmedLine.toLowerCase().includes('answer:')) {
            answer = trimmedLine.replace(/answer:\s*/i, '').trim();
            hasAnswer = true;
        } else if (trimmedLine.toLowerCase().includes('solution:')) {
            answer = trimmedLine.replace(/solution:\s*/i, '').trim();
            hasAnswer = true;
        } else {
            mainContent += formatMathNotation(trimmedLine) + '<br>';
        }
    });
    
    // Format the step content with proper styling
    let formattedContent = `
        <div class="step-main-content">
            ${formatMathNotation(mainContent)}
        </div>
    `;
    
    if (hasAnswer && answer) {
        formattedContent += `
            <div class="step-answer">
                <div class="answer-label">Answer:</div>
                <div class="answer-content">${formatMathNotation(answer)}</div>
            </div>
        `;
    }
    
    return formattedContent;
}

// Generate intermediate steps for complex mathematical problems
function generateIntermediateSteps(step, stepIndex) {
    // Extract mathematical content to create realistic intermediate steps
    const stepContent = step.toLowerCase();
    
    let intermediateContent = '';
    
    if (stepContent.includes('derivative') || stepContent.includes('limit')) {
        intermediateContent = `
            <div class="intermediate-content">
                <div class="intermediate-explanation">
                    <strong>Possible derivation:</strong><br>
                    The limit definition of the derivative for a function f(x) is:<br>
                    <div class="equation-display">
                        <span class="math-inline">d/dx f(x) = lim<sub>h‚Üí0</sub> [f(x + h) - f(x)]/h</span>
                    </div>
                </div>
                <div class="limit-explanation">
                    Let f(x) = -2. Then:<br>
                    f(x + h) = -2<br><br>
                    Substitute f(x + h) and f(x) into the limit definition:<br>
                    <div class="equation-display">
                        d/dx(-2) = lim<sub>h‚Üí0</sub> <span class="fraction"><span class="numerator">-2 - (-2)</span><span class="denominator">h</span></span>
                    </div><br>
                    Combine like terms in the numerator:<br>
                    <div class="equation-display">
                        = lim<sub>h‚Üí0</sub> <span class="fraction"><span class="numerator">0</span><span class="denominator">h</span></span>
                    </div><br>
                    The limit of any constant is that constant:<br>
                    <div class="equation-display">
                        = lim<sub>h‚Üí0</sub> 0 = <strong>0</strong>
                    </div>
                </div>
            </div>
        `;
    } else if (stepContent.includes('quadratic') || stepContent.includes('parabola')) {
        intermediateContent = `
            <div class="intermediate-content">
                <div class="intermediate-explanation">
                    <strong>Quadratic Form Analysis:</strong><br>
                    For a quadratic function y = ax¬≤ + bx + c:<br>
                    ‚Ä¢ The vertex is at x = -b/(2a)<br>
                    ‚Ä¢ The y-intercept is at (0, c)<br>
                    ‚Ä¢ The axis of symmetry is x = -b/(2a)
                </div>
            </div>
        `;
    } else {
        intermediateContent = `
            <div class="intermediate-content">
                <div class="intermediate-explanation">
                    <strong>Step-by-step breakdown:</strong><br>
                    ${formatMathNotation(step.substring(0, 150))}...
                </div>
            </div>
        `;
    }
    
    return intermediateContent;
}


// Toggle intermediate steps visibility with smooth animation
function toggleIntermediateSteps(stepIndex) {
    const intermediateDiv = document.getElementById(`intermediate-${stepIndex}`);
    const button = event.target;
    
    if (!intermediateDiv) {
        console.error(`No intermediate div found for step ${stepIndex}`);
        return;
    }
    
    if (intermediateDiv.style.display === 'none' || !intermediateDiv.style.display) {
        // Show intermediate steps
        intermediateDiv.style.display = 'block';
        button.innerHTML = 'üü† Hide intermediate steps';
        button.style.background = '#e07b00';
        
        // Add smooth animation
        intermediateDiv.style.opacity = '0';
        intermediateDiv.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            intermediateDiv.style.transition = 'all 0.3s ease';
            intermediateDiv.style.opacity = '1';
            intermediateDiv.style.transform = 'translateY(0)';
        }, 10);
        
    } else {
        // Hide intermediate steps
        intermediateDiv.style.transition = 'all 0.3s ease';
        intermediateDiv.style.opacity = '0';
        intermediateDiv.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            intermediateDiv.style.display = 'none';
            button.innerHTML = 'üü† Show intermediate steps';
            button.style.background = '#ff8c00';
        }, 300);
    }
}

// FIXED: Graph generation with proper error handling
function generate_math_graphs(topic, subject, grade_level) {
    const graphs = [];
    const topic_lower = topic.toLowerCase();
    const lesson_timestamp = Date.now();
    
    // Generate unique graph IDs for this lesson
    const generateGraphId = () => `${topic_lower.replace(/\s+/g, '_')}_${lesson_timestamp}_${Math.random().toString(36).substr(2, 9)}`;
    
    // Determine appropriate graph types based on topic
    if (topic_lower.includes('quadratic') || topic_lower.includes('parabola')) {
        const graph_id = generateGraphId();
        graphs.push({
            'title': `Quadratic Function: ${topic}`,
            'type': 'quadratic',
            'url': `/api/math-graph/${graph_id}?type=quadratic&formula=y=x¬≤-2x+1&x_min=-2&x_max=4&y_min=-1&y_max=9`,
            'description': `Graph of a quadratic function showing the parabolic shape, vertex, and key features related to ${topic}.`
        });
        
    } else if (topic_lower.includes('linear') || topic_lower.includes('slope')) {
        const graph_id = generateGraphId();
        graphs.push({
            'title': `Linear Function Example`,
            'type': 'linear',
            'url': `/api/math-graph/${graph_id}?type=linear&formula=y=2x+3&x_min=-5&x_max=5&y_min=-7&y_max=13`,
            'description': `Linear function graph demonstrating ${topic} concepts including slope, y-intercept, and rate of change.`
        });
        
    } else if (topic_lower.includes('exponential') || topic_lower.includes('growth')) {
        const graph_id = generateGraphId();
        graphs.push({
            'title': `Exponential Function`,
            'type': 'exponential', 
            'url': `/api/math-graph/${graph_id}?type=exponential&formula=y=2^x&x_min=-3&x_max=5&y_min=0&y_max=32`,
            'description': `Exponential function showing ${topic} behavior with rapid increase or decrease.`
        });
    }
    
    // Always add a coordinate system graph as reference
    const coord_graph_id = generateGraphId();
    graphs.push({
        'title': `Coordinate System for ${topic}`,
        'type': 'coordinate',
        'url': `/api/math-graph/${coord_graph_id}?type=linear&formula=y=x&x_min=-5&x_max=5&y_min=-5&y_max=5`,
        'description': `Coordinate plane for plotting and analyzing mathematical concepts in ${topic}.`
    });
    
    return graphs;
}
        
         // Add this for debugging
function debugButtonClick() {
    console.log('Button clicked successfully');
    console.log('Topic:', document.getElementById('topic').value);
    console.log('Grade Level:', document.getElementById('grade-level').value);
}

// Temporarily modify the generate button to test:
// <button onclick="debugButtonClick(); generateMathLessonPlan()" id="generate-btn">Generate Math Lesson Plan</button>

function editLessonPlan(lessonId) {
    // Navigate to the editor page with the lesson plan ID
    window.location.href = `/math-edit?id=${lessonId}`;
}

async function shareLessonPlan(lessonId) {
    // Publish the lesson plan and get shareable URL
    const token = getAuthToken();
    if (!token) {
        alert('Please login to share lesson plans');
        return;
    }

    try {
        // Show loading state
        const shareBtn = document.querySelector('.share-btn');
        if (shareBtn) {
            shareBtn.innerHTML = '‚è≥ Generating share link...';
            shareBtn.disabled = true;
        }

        const response = await fetch(`/api/publish-lesson-plan/${lessonId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();

        if (response.ok && data.public_url) {
            // Copy to clipboard
            await navigator.clipboard.writeText(data.public_url);

            // Show success message with option to open
            const openNow = confirm(`Share link copied to clipboard!\n\n${data.public_url}\n\nWould you like to open it in a new tab?`);

            if (openNow) {
                window.open(data.public_url, '_blank');
            }
        } else {
            alert('Failed to generate share link: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error sharing lesson plan:', error);
        alert('Failed to share lesson plan. Please try again.');
    } finally {
        // Reset button state
        const shareBtn = document.querySelector('.share-btn');
        if (shareBtn) {
            shareBtn.innerHTML = 'üîó Share Lesson';
            shareBtn.disabled = false;
        }
    }
}

// Make shareLessonPlan globally accessible
window.shareLessonPlan = shareLessonPlan;

        function generateMoreExamples() {
            const topic = document.getElementById('topic').value.trim();
            const subject = document.querySelector('.subject-tab.active').dataset.subject;
            
            if (!topic) {
                alert('Please generate a lesson plan first');
                return;
            }
            
            // Show loading
            setLoadingState(true);
            
            const token = getAuthToken();
            if (!token) {
                showError('Please login to generate more examples');
                setLoadingState(false);
                return;
            }
            
            // Request more examples from the backend
            fetch('https://seashell-app-onfk3.ondigitalocean.app/api/generate-more-examples', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    subject: subject,
                    topic: topic,
                    count: 3
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.examples) {
                    // Add new examples to the existing lesson plan
                    addMoreExamplesToDisplay(data.examples);
                }
            })
            .catch(error => {
                console.error('Error generating more examples:', error);
                showError('Failed to generate more examples');
            })
            .finally(() => {
                setLoadingState(false);
            });
        }

        function generateQuiz() {
            const topic = document.getElementById('topic').value.trim();
            const gradeLevel = document.getElementById('grade-level').value;
            const subject = document.querySelector('.subject-tab.active').dataset.subject;
            
            if (!topic || !gradeLevel) {
                alert('Please generate a lesson plan first');
                return;
            }
            
            // Redirect to quiz creator with lesson plan context
            const params = new URLSearchParams({
                lessonPlanTopic: topic,
                lessonPlanGrade: gradeLevel,
                lessonPlanSubject: subject
            });
            
            window.location.href = `/quiz-creator.html?${params.toString()}`;
        }

        function downloadLesson() {
            const previewDiv = document.getElementById('lesson-plan-preview');
            const planId = previewDiv.dataset.planId;
            
            if (!planId) {
                // Fallback: download current content as HTML
                downloadCurrentContent();
                return;
            }
            
            const token = getAuthToken();
            if (!token) {
                showError('Please login to download lesson plans');
                return;
            }
            
            // Download from server
            const downloadUrl = `https://seashell-app-onfk3.ondigitalocean.app/api/download-lesson-plan/${planId}?format=pdf`;
            
            fetch(downloadUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to download lesson plan');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Math_Lesson_Plan_${planId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error downloading lesson plan:', error);
                showError('Failed to download lesson plan');
            });
        }

        function downloadCurrentContent() {
            const previewDiv = document.getElementById('lesson-plan-preview');
            const content = previewDiv.innerHTML;
            const topic = document.getElementById('topic').value.trim() || 'Math_Lesson';
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${topic} - Math Lesson Plan</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .preview-section { margin-bottom: 20px; }
                        .preview-section h3 { color: #00bfff; margin-bottom: 10px; }
                        .math-formula { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 5px; }
                        .step-by-step { background: #e8f5e8; padding: 15px; border-radius: 5px; }
                        .worked-example { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${topic.replace(/\s+/g, '_')}_Lesson_Plan.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function addMoreExamplesToDisplay(examples) {
            const previewDiv = document.getElementById('lesson-plan-preview');
            const existingExamples = previewDiv.querySelector('.preview-section:has(h3:contains("Worked Examples"))');
            
            if (existingExamples) {
                const examplesContainer = existingExamples.querySelector('.preview-item');
                examples.forEach((example, index) => {
                    const exampleHtml = `
                        <div class="worked-example">
                            <h4>Additional Example ${index + 1}</h4>
                            ${formatMathNotation(example)}
                        </div>
                    `;
                    examplesContainer.insertAdjacentHTML('beforeend', exampleHtml);
                });
            }
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([previewDiv]);
            }
        }

        // Helper functions
        function setLoadingState(isLoading) {
            const generateBtn = document.getElementById('generate-btn');
            const loadingDiv = document.getElementById('loading');
            
            if (generateBtn) {
                generateBtn.disabled = isLoading;
            }
            
            if (loadingDiv) {
                loadingDiv.style.display = isLoading ? 'block' : 'none';
            }
            
            if (!isLoading) {
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }

       function getAuthToken() {
    // Check all possible token locations
    const token = localStorage.getItem('token') || 
                  sessionStorage.getItem('token') || 
                  getCookie('token');
    
    console.log('üîë Token check:', token ? 'Found' : 'Not found');
    
    if (!token) {
        console.error('‚ùå No authentication token found');
        console.log('Storage check:', {
            localStorage: localStorage.getItem('token'),
            sessionStorage: sessionStorage.getItem('token'),
            cookie: getCookie('token')
        });
    }
    
    return token;
}

// Add right after the getAuthToken function
function debugAuth() {
    console.log('=== AUTH DEBUG ===');
    console.log('Current URL:', window.location.href);
    console.log('localStorage.token:', localStorage.getItem('token'));
    console.log('sessionStorage.token:', sessionStorage.getItem('token'));
    console.log('All localStorage keys:', Object.keys(localStorage));
    console.log('All sessionStorage keys:', Object.keys(sessionStorage));
    console.log('Document.cookie:', document.cookie);
    console.log('================');
}

// Call it on page load
debugAuth();


        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function clearAllTokens() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('token');
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        }

        function showLoginOption() {
            const container = document.querySelector('.container');
            if (!container || document.getElementById('login-option')) return;
            
            const loginOption = document.createElement('div');
            loginOption.id = 'login-option';
            loginOption.className = 'form-group';
            loginOption.style.textAlign = 'center';
            loginOption.style.marginBottom = '20px';
            loginOption.style.padding = '15px';
            loginOption.style.background = '#f9fafb';
            loginOption.style.borderRadius = '8px';
            loginOption.style.border = '1px solid #e5e7eb';
            
            loginOption.innerHTML = `
                <h3 style="margin-bottom: 10px; color: #4361ee;">Login Required</h3>
                <p style="margin-bottom: 15px;">You need to log in to create lesson plans.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <a href="/index.html" class="nav-button" style="flex: 1; max-width: 150px; text-decoration: none; text-align: center; padding: 10px; background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white; border-radius: 8px; font-weight: 600;">Login</a>
                </div>
            `;
            
            container.insertBefore(loginOption, container.firstChild);
        }

        function displayInteractiveEvaluation(evaluationData) {
    currentEvaluation = evaluationData;
    userAnswers = {};
    
    const evaluationSection = document.getElementById('interactive-evaluation');
    const questionContainer = document.getElementById('question-container');
    
    questionContainer.innerHTML = '';
    
    if (!evaluationData || !evaluationData.questions) {
        evaluationSection.style.display = 'none';
        return;
    }
    
    evaluationData.questions.forEach((question, index) => {
        const questionElement = createQuestionElement(question, index + 1);
        questionContainer.appendChild(questionElement);
    });
    
    evaluationSection.style.display = 'block';
    
    // Scroll to evaluation
    setTimeout(() => {
        evaluationSection.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

function createQuestionElement(question, questionNumber) {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question';
    questionDiv.dataset.questionId = question.id;
    
    const questionHeader = `
        <div class="question-header">
            <div class="question-number">${questionNumber}</div>
            <div class="question-type">${getQuestionTypeLabel(question.type)}</div>
        </div>
        <div class="question-text">${question.question}</div>
    `;
    
    let questionContent = '';
    
    switch (question.type) {
        case 'multiple_choice':
            questionContent = createMultipleChoiceContent(question);
            break;
        case 'paragraph':
            questionContent = createParagraphContent(question);
            break;
        case 'drag_drop_matching':
            questionContent = createMatchingContent(question);
            break;
        case 'drag_drop_ordering':
            questionContent = createOrderingContent(question);
            break;
    }
    
    questionDiv.innerHTML = questionHeader + questionContent;
    
    return questionDiv;
}

function getQuestionTypeLabel(type) {
    const labels = {
        'multiple_choice': 'Multiple Choice',
        'paragraph': 'Paragraph Response',
        'drag_drop_matching': 'Drag & Drop Matching',
        'drag_drop_ordering': 'Drag & Drop Ordering'
    };
    return labels[type] || type;
}

function createMultipleChoiceContent(question) {
    let content = '<div class="mc-options">';
    
    question.options.forEach((option, index) => {
        content += `
            <div class="mc-option" onclick="selectMCOption('${question.id}', '${option.text}', this)">
                <input type="radio" name="${question.id}" value="${option.text}">
                <span>${option.text}</span>
            </div>
        `;
    });
    
    content += '</div>';
    return content;
}

function createParagraphContent(question) {
    return `
        <div class="paragraph-container">
            <textarea 
                class="paragraph-input" 
                placeholder="Type your detailed explanation here..."
                onchange="saveParagraphAnswer('${question.id}', this.value)"
                oninput="saveParagraphAnswer('${question.id}', this.value)"
            ></textarea>
        </div>
    `;
}

// Fixed Drag and Drop Interactive Evaluation Functions

function createMatchingContent(question) {
    // Extract terms and definitions from the question data
    const pairs = question.pairs || [];
    const terms = pairs.map(pair => pair.term);
    const definitions = pairs.map(pair => pair.definition);
    
    // Shuffle definitions for matching challenge
    const shuffledDefinitions = [...definitions].sort(() => Math.random() - 0.5);
    
    let content = `
        <div class="matching-container">
            <div class="terms-column">
                <h4>Drag these items:</h4>
                <div class="drag-items" id="terms-${question.id}">
    `;
    
    // Add draggable terms
    terms.forEach(term => {
        content += `
            <div class="drag-item" draggable="true" data-value="${term}" 
                 ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                ${term}
            </div>
        `;
    });
    
    content += `
                </div>
            </div>
            <div class="definitions-column">
                <h4>Drop to match with definitions:</h4>
    `;
    
    // Add drop zones with definitions
    shuffledDefinitions.forEach((definition, index) => {
        content += `
            <div class="drop-zone" data-definition="${definition}" 
                 ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${question.id}')"
                 ondragleave="handleDragLeave(event)"
                 id="drop-${question.id}-${index}">
                <div class="placeholder">Drop matching term here</div>
                <div class="definition-text">${definition}</div>
            </div>
        `;
    });
    
    content += `
            </div>
        </div>
    `;
    
    return content;
}

function createOrderingContent(question) {
    // Extract items from the question data
    const items = question.items || [];
    
    // Shuffle items for ordering challenge
    const shuffledItems = [...items].sort(() => Math.random() - 0.5);
    
    let content = `
        <div class="ordering-container">
            <div class="drag-items-section">
                <h4>Drag these steps (in random order):</h4>
                <div class="drag-items" id="items-${question.id}">
    `;
    
    // Add draggable items
    shuffledItems.forEach(item => {
        const stepText = typeof item === 'object' ? item.step : item;
        content += `
            <div class="drag-item" draggable="true" data-value="${stepText}" 
                 ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                ${stepText}
            </div>
        `;
    });
    
    content += `
                </div>
            </div>
            <div class="ordered-list-section">
                <h4>Drop here in correct order:</h4>
                <div class="ordered-list" id="ordered-${question.id}" 
                     ondragover="handleDragOver(event)" ondrop="handleOrderDrop(event, '${question.id}')"
                     ondragleave="handleDragLeave(event)">
                    <div class="placeholder">Drag steps here in the correct sequence (1st, 2nd, 3rd...)</div>
                </div>
            </div>
        </div>
    `;
    
    return content;
}

// Enhanced drag and drop event handlers


function handleDragStart(event) {
    draggedElement = event.target;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/html', event.target.outerHTML);
    
    // Add visual feedback
    setTimeout(() => {
        if (draggedElement) {
            draggedElement.style.opacity = '0.5';
        }
    }, 0);
}

function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    event.target.style.opacity = '1';
    
    // Remove drag-over effects from all drop zones
    document.querySelectorAll('.drop-zone, .ordered-list').forEach(zone => {
        zone.classList.remove('drag-over');
    });
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    
    const dropZone = event.currentTarget;
    dropZone.classList.add('drag-over');
}

function handleDragLeave(event) {
    const dropZone = event.currentTarget;
    const rect = dropZone.getBoundingClientRect();
    const x = event.clientX;
    const y = event.clientY;
    
    // Only remove drag-over if mouse is actually outside the drop zone
    if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        dropZone.classList.remove('drag-over');
    }
}

function handleDrop(event, questionId) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    if (draggedElement) {
        const dropZone = event.currentTarget;
        const definition = dropZone.dataset.definition;
        const term = draggedElement.dataset.value;
        
        // Clear placeholder
        const placeholder = dropZone.querySelector('.placeholder');
        if (placeholder) placeholder.style.display = 'none';
        
        // Remove any existing term in this drop zone
        const existingTerm = dropZone.querySelector('.dropped-term');
        if (existingTerm) {
            existingTerm.remove();
        }
        
        // Add the dropped term
        const termElement = document.createElement('div');
        termElement.className = 'dropped-term';
        termElement.innerHTML = `
            <strong>${term}</strong>
            <button onclick="removeMatch(this, '${questionId}')" class="remove-match">√ó</button>
        `;
        
        // Insert before definition text
        const definitionText = dropZone.querySelector('.definition-text');
        dropZone.insertBefore(termElement, definitionText);
        
        // Save to answers
        if (!userAnswers[questionId]) userAnswers[questionId] = {};
        userAnswers[questionId][term] = definition;
        
        // Hide the original dragged element
        draggedElement.style.display = 'none';
        
        console.log(`Matched: ${term} -> ${definition}`);
    }
}

function handleOrderDrop(event, questionId) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    if (draggedElement) {
        const orderedList = event.currentTarget;
        const step = draggedElement.dataset.value;
        
        // Clear placeholder if it's the first item
        const placeholder = orderedList.querySelector('.placeholder');
        if (placeholder && orderedList.children.length === 1) {
            placeholder.style.display = 'none';
        }
        
        // Get current step count (excluding placeholder)
        const currentSteps = orderedList.querySelectorAll('.ordered-step').length;
        const stepNumber = currentSteps + 1;
        
        // Add the step to ordered list
        const stepElement = document.createElement('div');
        stepElement.className = 'ordered-step';
        stepElement.innerHTML = `
            <span class="step-number">${stepNumber}</span>
            <span class="step-text">${step}</span>
            <button onclick="removeStep(this, '${questionId}')" class="remove-step">√ó</button>
        `;
        orderedList.appendChild(stepElement);
        
        // Update answers array
        if (!userAnswers[questionId]) userAnswers[questionId] = [];
        userAnswers[questionId].push(step);
        
        // Hide the original dragged element
        draggedElement.style.display = 'none';
        
        console.log(`Added step ${stepNumber}: ${step}`);
    }
}

function removeMatch(button, questionId) {
    const dropZone = button.closest('.drop-zone');
    const termElement = button.parentElement;
    const term = termElement.querySelector('strong').textContent;
    
    // Remove from answers
    if (userAnswers[questionId] && userAnswers[questionId][term]) {
        delete userAnswers[questionId][term];
    }
    
    // Show placeholder again if needed
    const placeholder = dropZone.querySelector('.placeholder');
    if (placeholder) placeholder.style.display = 'block';
    
    // Remove the dropped term
    termElement.remove();
    
    // Show the original term again
    const originalTerm = document.querySelector(`[data-value="${term}"]`);
    if (originalTerm && originalTerm.classList.contains('drag-item')) {
        originalTerm.style.display = 'inline-block';
    }
    
    console.log(`Removed match: ${term}`);
}

function removeStep(button, questionId) {
    const orderedList = button.closest('.ordered-list');
    const stepElement = button.parentElement;
    const stepText = stepElement.querySelector('.step-text').textContent;
    
    // Remove from answers
    if (userAnswers[questionId]) {
        const index = userAnswers[questionId].indexOf(stepText);
        if (index > -1) {
            userAnswers[questionId].splice(index, 1);
        }
    }
    
    // Remove the step
    stepElement.remove();
    
    // Show the original step again
    const originalStep = document.querySelector(`[data-value="${stepText}"]`);
    if (originalStep && originalStep.classList.contains('drag-item')) {
        originalStep.style.display = 'inline-block';
    }
    
    // Renumber remaining steps
    const steps = orderedList.querySelectorAll('.ordered-step');
    steps.forEach((step, index) => {
        const numberSpan = step.querySelector('.step-number');
        if (numberSpan) numberSpan.textContent = index + 1;
    });
    
    // Show placeholder if no steps remain
    if (steps.length === 0) {
        const placeholder = orderedList.querySelector('.placeholder');
        if (placeholder) placeholder.style.display = 'block';
    }
    
    console.log(`Removed step: ${stepText}`);
}

// Enhanced CSS for better drag and drop experience
const enhancedDragDropCSS = `
/* Enhanced Drag and Drop Styles */
.matching-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
}

.terms-column, .definitions-column {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #e9ecef;
}

.terms-column h4, .definitions-column h4 {
    margin-bottom: 15px;
    color: #2c3e50;
    text-align: center;
    font-weight: 600;
    background: white;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.drag-items {
    min-height: 120px;
    padding: 15px;
    background: white;
    border: 2px dashed #bdc3c7;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-start;
    align-content: flex-start;
}

.drag-item {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: grab;
    display: inline-block;
    font-weight: 500;
    transition: all 0.3s ease;
    user-select: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 2px solid transparent;
}

.drag-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    background: linear-gradient(135deg, #2980b9, #1c5985);
}

.drag-item:active {
    cursor: grabbing;
}

.drag-item.dragging {
    opacity: 0.5;
    transform: rotate(3deg) scale(1.05);
}

.drop-zone {
    background: white;
    border: 2px dashed #95a5a6;
    border-radius: 8px;
    padding: 15px;
    min-height: 80px;
    margin: 10px 0;
    position: relative;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.drop-zone.drag-over {
    border-color: #3498db;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.drop-zone .placeholder {
    color: #7f8c8d;
    font-style: italic;
    text-align: center;
    padding: 15px;
    border: 1px dashed #bdc3c7;
    border-radius: 6px;
    background: #ecf0f1;
}

.definition-text {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    font-weight: 500;
    color: #2c3e50;
}

.dropped-term {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.remove-match, .remove-step {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
}

.remove-match:hover, .remove-step:hover {
    background: rgba(255,255,255,0.4);
}

/* Ordering specific styles */
.ordering-container {
    margin-top: 20px;
}

.drag-items-section, .ordered-list-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 2px solid #e9ecef;
}

.drag-items-section h4, .ordered-list-section h4 {
    margin-bottom: 15px;
    color: #2c3e50;
    text-align: center;
    font-weight: 600;
    background: white;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.ordered-list {
    background: white;
    border: 2px dashed #95a5a6;
    border-radius: 8px;
    padding: 15px;
    min-height: 200px;
    transition: all 0.3s ease;
}

.ordered-list.drag-over {
    border-color: #3498db;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.ordered-step {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    padding: 12px 15px;
    margin: 8px 0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.ordered-step:hover {
    transform: translateX(3px);
}

.step-number {
    background: rgba(255,255,255,0.2);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    flex-shrink: 0;
}

.step-text {
    flex: 1;
    line-height: 1.4;
}

/* Responsive Design */
@media (max-width: 768px) {
    .matching-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .drag-item {
        padding: 10px 12px;
        font-size: 14px;
    }
    
    .drop-zone, .ordered-list {
        min-height: 60px;
        padding: 12px;
    }
}

/* Touch device support */
@media (hover: none) {
    .drag-item:hover {
        transform: none;
    }
    
    .drag-item:active {
        transform: scale(1.1);
    }
}
`;

// Inject the enhanced CSS
const dragDropStyleElement = document.createElement('style');
dragDropStyleElement.textContent = enhancedDragDropCSS;
document.head.appendChild(dragDropStyleElement);

// Export functions for global use
window.createMatchingContent = createMatchingContent;
window.createOrderingContent = createOrderingContent;
window.handleDragStart = handleDragStart;
window.handleDragEnd = handleDragEnd;
window.handleDragOver = handleDragOver;
window.handleDragLeave = handleDragLeave;
window.handleDrop = handleDrop;
window.handleOrderDrop = handleOrderDrop;
window.removeMatch = removeMatch;
window.removeStep = removeStep;

console.log('‚úÖ Enhanced Drag and Drop Evaluation System Loaded');

function submitEvaluation() {
    if (!currentEvaluation) return;
    
    // Validate that all questions are answered
    const unansweredQuestions = [];
    currentEvaluation.questions.forEach(question => {
        if (!userAnswers[question.id] || 
            (typeof userAnswers[question.id] === 'string' && !userAnswers[question.id].trim()) ||
            (typeof userAnswers[question.id] === 'object' && Object.keys(userAnswers[question.id]).length === 0) ||
            (Array.isArray(userAnswers[question.id]) && userAnswers[question.id].length === 0)) {
            unansweredQuestions.push(question.id);
        }
    });
    
    if (unansweredQuestions.length > 0) {
        alert(`Please answer all questions before submitting. Missing: ${unansweredQuestions.length} questions.`);
        return;
    }
    
    // Show loading
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;
    
    // Submit to backend
    const token = getAuthToken();
    if (!token) {
        alert('Please login to submit evaluation');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
    }
    
    fetch('/api/submit-evaluation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            evaluation_id: currentEvaluation.evaluation_id,
            answers: userAnswers
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        displayEvaluationResults(data);
    })
    .catch(error => {
        console.error('Error submitting evaluation:', error);
        alert('Failed to submit evaluation: ' + error.message);
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

function displayEvaluationResults(results) {
    const resultsContainer = document.getElementById('evaluation-results');
    const submitBtn = document.getElementById('submit-btn');
    const resetBtn = document.getElementById('reset-btn');
    
    // Hide submit button, show reset button
    submitBtn.style.display = 'none';
    resetBtn.style.display = 'inline-block';
    
    // Determine score category
    let scoreClass = 'score-needs-improvement';
    let scoreMessage = 'Keep practicing!';
    
    if (results.score >= 80) {
        scoreClass = 'score-excellent';
        scoreMessage = 'Excellent work!';
    } else if (results.score >= 60) {
        scoreClass = 'score-good';
        scoreMessage = 'Good job!';
    }
    
    let resultsHTML = `
        <div class="score-display">
            <div class="score-circle ${scoreClass}">
                ${Math.round(results.score)}%
            </div>
            <h3>${scoreMessage}</h3>
            <p>You scored ${Math.round(results.score)}% on this evaluation.</p>
        </div>
        
        <div class="feedback-section">
            <h3>Detailed Feedback</h3>
    `;
    
    // Add feedback for each question
    currentEvaluation.questions.forEach((question, index) => {
        const feedback = results.feedback[question.id];
        if (feedback) {
            const isCorrect = feedback.correct;
            const icon = isCorrect ? '‚úÖ' : '‚ùå';
            
            resultsHTML += `
                <div class="question-feedback ${isCorrect ? 'correct' : 'incorrect'}">
                    <div class="feedback-header">
                        <span class="feedback-icon">${icon}</span>
                        <strong>Question ${index + 1}: ${getQuestionTypeLabel(question.type)}</strong>
                    </div>
                    <div class="feedback-text">
                        <p><strong>Your answer:</strong> ${formatUserAnswer(userAnswers[question.id], question.type)}</p>
                        <p><strong>Feedback:</strong> ${feedback.explanation}</p>
                        ${!isCorrect && feedback.correct_answer ? `<p><strong>Correct answer:</strong> ${formatUserAnswer(feedback.correct_answer, question.type)}</p>` : ''}
                        ${feedback.suggestions ? `<p><strong>Suggestions:</strong> ${feedback.suggestions}</p>` : ''}
                    </div>
                </div>
            `;
        }
    });
    
    resultsHTML += '</div>';
    
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
    
    // Scroll to results
    setTimeout(() => {
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

function formatUserAnswer(answer, questionType) {
    if (!answer) return 'No answer provided';
    
    switch (questionType) {
        case 'multiple_choice':
            return answer;
        case 'paragraph':
            return answer.length > 100 ? answer.substring(0, 100) + '...' : answer;
        case 'drag_drop_matching':
            if (typeof answer === 'object') {
                return Object.entries(answer).map(([term, def]) => `${term} ‚Üí ${def}`).join(', ');
            }
            return 'Invalid answer format';
        case 'drag_drop_ordering':
            if (Array.isArray(answer)) {
                return answer.join(' ‚Üí ');
            }
            return 'Invalid answer format';
        default:
            return String(answer);
    }
}

function resetEvaluation() {
    userAnswers = {};
    
    // Reset UI
    document.getElementById('evaluation-results').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'inline-block';
    document.getElementById('reset-btn').style.display = 'none';
    
    // Clear all answers
    document.querySelectorAll('.mc-option').forEach(option => {
        option.classList.remove('selected');
        option.querySelector('input').checked = false;
    });
    
    document.querySelectorAll('.paragraph-input').forEach(textarea => {
        textarea.value = '';
    });
    
    document.querySelectorAll('.dropped-term').forEach(term => term.remove());
    document.querySelectorAll('.ordered-step').forEach(step => step.remove());
    
    document.querySelectorAll('.drag-item').forEach(item => {
        item.style.display = 'inline-block';
    });
    
    document.querySelectorAll('.placeholder').forEach(placeholder => {
        placeholder.style.display = 'block';
    });
    
    // Scroll back to evaluation
    document.getElementById('interactive-evaluation').scrollIntoView({ behavior: 'smooth' });
}

// Add drag and drop event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize subject tabs click functionality
    setupSubjectTabs();

    // Initialize select all features functionality
    setupSelectAllFeatures();

    // Prevent default drag behaviors on document
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
    });

    document.addEventListener('drop', function(e) {
        e.preventDefault();
    });
});

// Helper function to get auth token
function getAuthToken() {
    return localStorage.getItem('token') || sessionStorage.getItem('token') || getCookie('token');
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// Add this to your existing lesson plan display function
function addEditButtonToLessonPlan(lessonPlanId) {
    const actionButtons = document.querySelector('.action-buttons');
    if (actionButtons) {
        const editButton = document.createElement('button');
        editButton.className = 'action-button edit-btn';
        editButton.innerHTML = '‚úèÔ∏è Edit Lesson Plan';
        editButton.onclick = () => navigateToEditor(lessonPlanId);
        
        // Insert as first button
        actionButtons.insertBefore(editButton, actionButtons.firstChild);
    }
}

function navigateToEditor(lessonPlanId) {
    // Navigate to the editor page with the lesson plan ID
    window.location.href = `/math-edit?id=${lessonPlanId}`;
}

// Add CSS for edit button
const editButtonCSS = `
.edit-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
    color: white !important;
}

.edit-btn:hover {
    background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(142, 68, 173, 0.3);
}
`;

// Inject CSS
style.textContent = editButtonCSS;
document.head.appendChild(style);

// Update your displayMathLessonPlan function to include the edit button
function displayMathLessonPlanWithEdit(lessonPlan) {
    
    // Add edit button after displaying the lesson plan
    addEditButtonToLessonPlan(lessonPlan.id);
    
    // Add interactive evaluation if available
    if (lessonPlan.interactive_evaluation) {
        displayInteractiveEvaluation(lessonPlan.interactive_evaluation);
    }
}

// Ensure the function is globally available
window.generateEnhancedMathLessonPlan = function() {
    console.log('Button clicked - function called');
    
    // Call your actual implementation
    if (typeof generateEnhancedMathLessonPlanNoFallback === 'function') {
        return generateEnhancedMathLessonPlanNoFallback();
    } else {
        console.error('generateEnhancedMathLessonPlanNoFallback not found');
        alert('System not properly loaded. Please refresh the page.');
    }
};

console.log('Function assigned to window');
    </script>
    <script src="math-share-url.js"></script>
</body>
</html>