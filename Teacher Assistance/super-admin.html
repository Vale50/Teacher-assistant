<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super-Admin Dashboard - Deciph.AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüíº</text></svg>" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #DC2626;
            --primary-dark: #B91C1C;
            --secondary-color: #059669;
            --accent-color: #D97706;
            --text-color: #1F2937;
            --light-bg: #F9FAFB;
            --white: #FFFFFF;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --red-500: #EF4444;
            --green-500: #10B981;
            --blue-500: #3B82F6;
            --yellow-500: #F59E0B;
            --purple-500: #8B5CF6;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            z-index: 1000;
            transform: translateX(0);
            transition: var(--transition);
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-logo-icon {
            font-size: 2rem;
        }

        .sidebar-logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            display: block;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: white;
            text-decoration: none;
            color: white;
        }

        .nav-item i {
            margin-right: 0.75rem;
            width: 20px;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Mobile overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.show {
            display: block;
            opacity: 1;
        }

        .admin-info {
            flex: 1;
        }

        .admin-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .admin-role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .logout-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
            padding: 0.5rem;
            border-radius: 8px;
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--gray-100);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn:hover {
            background: var(--primary-dark);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.students::before { background: var(--blue-500); }
        .stat-card.tasks::before { background: var(--green-500); }
        .stat-card.acard::before { background: var(--yellow-500); }
        .stat-card.activity::before { background: var(--purple-500); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .stat-card.students .stat-icon { color: var(--blue-500); }
        .stat-card.tasks .stat-icon { color: var(--green-500); }
        .stat-card.acard .stat-icon { color: var(--yellow-500); }
        .stat-card.activity .stat-icon { color: var(--purple-500); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-increase {
            color: var(--green-500);
        }

        .stat-decrease {
            color: var(--red-500);
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            color: inherit;
        }

        .action-btn:hover {
            border-color: var(--primary-color);
            background: white;
            transform: translateY(-2px);
            text-decoration: none;
            color: inherit;
        }

        .action-btn.assign-task { border-color: var(--green-500); }
        .action-btn.assign-task:hover { border-color: var(--green-500); background: rgba(16, 185, 129, 0.05); }

        .action-btn.credit-acard { border-color: var(--yellow-500); }
        .action-btn.credit-acard:hover { border-color: var(--yellow-500); background: rgba(245, 158, 11, 0.05); }

        .action-btn.view-students { border-color: var(--blue-500); }
        .action-btn.view-students:hover { border-color: var(--blue-500); background: rgba(59, 130, 246, 0.05); }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .action-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Tables */
        .data-table {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--green-500);
            color: white;
        }

        .btn-success:hover {
            background: #0ea271;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green-500);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--yellow-500);
        }

        .status-completed {
            background: rgba(59, 130, 246, 0.1);
            color: var(--blue-500);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red-500);
        }

        /* Forms */
        .form-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Schedule Section Styles */
        .schedule-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .schedule-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-300);
            transition: var(--transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .days-selector {
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .days-selector.active {
            display: grid;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .day-checkbox:hover {
            border-color: var(--primary-color);
        }

        .day-checkbox input:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .day-checkbox input {
            margin: 0;
        }

        /* Task File Input */
        .task-file-section {
            background: var(--blue-50);
            border: 1px dashed var(--blue-300);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .task-file-info {
            font-size: 0.875rem;
            color: var(--blue-700);
            margin-bottom: 0.5rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--green-500);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            z-index: 9999;
            transform: translateX(400px);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--red-500);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .header {
                padding: 1rem;
            }

            .days-selector {
                grid-template-columns: 1fr;
            }
        }
/* Task action buttons */
.task-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.task-action-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 500;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
}

.task-action-btn.view {
    background: var(--gray-500);
    color: white;
}

.task-action-btn.edit {
    background: var(--blue-500);
    color: white;
}

.task-action-btn.delete {
    background: var(--red-500);
    color: white;
}

.task-action-btn.complete {
    background: var(--green-500);
    color: white;
}

.task-action-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* Edit task modal specific styles */
.edit-link-section {
    background: var(--gray-50);
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.5rem;
}

.edit-link-info {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.5rem;
}
        /* Add these styles to the existing admin dashboard CSS */

.analytics-header {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.analytics-title-section h2 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.analytics-subtitle {
    color: var(--gray-600);
    font-size: 1rem;
    margin: 0;
}

.analytics-filters {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-input {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.875rem;
}

.analytics-overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.analytics-stat-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.analytics-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.analytics-stat-card.primary::before { background: var(--blue-500); }
.analytics-stat-card.success::before { background: var(--green-500); }
.analytics-stat-card.warning::before { background: var(--yellow-500); }
.analytics-stat-card.info::before { background: var(--purple-500); }
.analytics-stat-card.accent::before { background: var(--primary-color); }
.analytics-stat-card.golden::before { background: linear-gradient(90deg, #FFD700, #FFA500); }

.analytics-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.analytics-stat-card .stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.analytics-stat-card.primary .stat-icon { color: var(--blue-500); }
.analytics-stat-card.success .stat-icon { color: var(--green-500); }
.analytics-stat-card.warning .stat-icon { color: var(--yellow-500); }
.analytics-stat-card.info .stat-icon { color: var(--purple-500); }
.analytics-stat-card.accent .stat-icon { color: var(--primary-color); }
.analytics-stat-card.golden .stat-icon { color: #FF8C00; }

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.stat-sublabel {
    font-size: 0.75rem;
    color: var(--gray-500);
}

.analytics-content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.analytics-section {
    background: white;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    overflow: hidden;
}

.analytics-section.full-width {
    grid-column: 1 / -1;
}

.analytics-section .section-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.analytics-section .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
}

.task-types-analytics {
    padding: 1.5rem 2rem;
}

.task-type-analytics-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-radius: 8px;
    background: var(--gray-50);
    margin-bottom: 1rem;
    border: 1px solid var(--gray-200);
}

.task-type-analytics-item:last-child {
    margin-bottom: 0;
}

.task-type-info {
    flex: 1;
}

.task-type-name {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
    text-transform: capitalize;
}

.task-type-stats {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.task-type-metrics {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.task-type-metric {
    text-align: center;
}

.metric-value {
    font-weight: 700;
    color: var(--primary-color);
    display: block;
}

.metric-label {
    font-size: 0.7rem;
    color: var(--gray-500);
}

.school-performance-list {
    padding: 1.5rem 2rem;
    max-height: 400px;
    overflow-y: auto;
}

.school-performance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-radius: 8px;
    background: var(--gray-50);
    margin-bottom: 0.75rem;
    border: 1px solid var(--gray-200);
}

.school-info h4 {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.school-stats {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.school-score {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--green-500);
}

.top-performers-list {
    padding: 1.5rem 2rem;
    max-height: 400px;
    overflow-y: auto;
}

.top-performer-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background: var(--gray-50);
    margin-bottom: 0.75rem;
    border: 1px solid var(--gray-200);
}

.performer-rank {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
}

.performer-rank.gold { background: #FFD700; color: #8B4513; }
.performer-rank.silver { background: #C0C0C0; color: #444; }
.performer-rank.bronze { background: #CD7F32; color: white; }

.performer-info {
    flex: 1;
}

.performer-name {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.performer-details {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.performer-score {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--green-500);
}

.time-analysis-content {
    padding: 1.5rem 2rem;
}

.time-metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.time-metric-card {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--gray-200);
}

.time-metric-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.time-metric-label {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.time-lists {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.time-list {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--gray-200);
}

.time-list h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.75rem;
}

.time-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-200);
}

.time-list-item:last-child {
    border-bottom: none;
}

.time-item-info {
    flex: 1;
}

.time-item-task {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-color);
}

.time-item-student {
    font-size: 0.7rem;
    color: var(--gray-500);
}

.time-item-duration {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary-color);
}

.recent-submissions-table {
    padding: 1.5rem 2rem;
}

.recent-submissions-table table {
    width: 100%;
}

.recent-submissions-table th {
    background: var(--gray-50);
    padding: 0.75rem;
    font-weight: 600;
    color: var(--gray-700);
    border-bottom: 2px solid var(--gray-200);
}

.recent-submissions-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--gray-200);
}

.student-info {
    display: flex;
    flex-direction: column;
}

.student-name {
    font-weight: 600;
    color: var(--text-color);
}

.student-grade {
    font-size: 0.75rem;
    color: var(--gray-500);
}

.task-info {
    display: flex;
    flex-direction: column;
}

.task-title {
    font-weight: 600;
    color: var(--text-color);
}

.task-type {
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: capitalize;
}

.score-display {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.score-percentage {
    font-weight: 700;
    font-size: 1rem;
}

.score-percentage.excellent { color: var(--green-500); }
.score-percentage.good { color: var(--blue-500); }
.score-percentage.fair { color: var(--yellow-500); }
.score-percentage.poor { color: var(--red-500); }

.score-points {
    font-size: 0.75rem;
    color: var(--gray-500);
}

.time-spent {
    font-weight: 600;
    color: var(--purple-500);
}

.rewards-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.points-reward {
    font-size: 0.8rem;
    color: var(--blue-500);
    font-weight: 600;
}

.acard-reward {
    font-size: 0.8rem;
    color: var(--yellow-500);
    font-weight: 600;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .analytics-header {
        flex-direction: column;
        align-items: stretch;
    }

    .analytics-filters {
        justify-content: center;
    }

    .analytics-overview-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .analytics-content-grid {
        grid-template-columns: 1fr;
    }

    .time-lists {
        grid-template-columns: 1fr;
    }

    .time-metric-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .recent-submissions-table {
        overflow-x: auto;
    }

    .analytics-stat-card {
        padding: 1rem;
    }

    .stat-number {
        font-size: 1.5rem;
    }
}

/* Add this CSS to your existing admin dashboard styles */
        .link-type-selector {
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .link-type-tabs {
            display: flex;
            background: var(--gray-100);
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }

        .link-type-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--gray-600);
        }

        .link-type-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .link-type-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.7);
        }

        .link-option {
            display: none;
            margin-top: 1rem;
        }

        .link-option.active {
            display: block;
        }

        .url-validator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .url-validator.valid {
            color: var(--green-500);
        }

        .url-validator.invalid {
            color: var(--red-500);
        }

        .url-validator.empty {
            color: var(--gray-500);
        }

        .external-link-preview {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--blue-500);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .external-link-preview.show {
            display: block;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--blue-500);
            margin-bottom: 0.5rem;
        }

        .preview-url {
            font-family: monospace;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            word-break: break-all;
            font-size: 0.875rem;
        }

        .link-type-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
            border-left: 3px solid var(--blue-500);
        }

        .task-file-section {
            background: var(--blue-50);
            border: 1px dashed var(--blue-300);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .common-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .common-link-btn {
            padding: 0.75rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            font-size: 0.875rem;
        }

        .common-link-btn:hover {
            border-color: var(--blue-500);
            background: rgba(59, 130, 246, 0.05);
        }

        .common-link-btn.selected {
            border-color: var(--blue-500);
            background: rgba(59, 130, 246, 0.1);
            color: var(--blue-500);
        }

        .common-link-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .common-link-url {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-family: monospace;
        }

        /* Admin Management Specific Styles */
.admin-create-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.grade-section-badge {
    background: var(--purple-500);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.admin-assignment-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.resource-input-group {
    background: var(--gray-50);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    position: relative;
}

.resource-input-group:hover {
    border-color: var(--primary-color);
}

.resource-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--gray-300);
}

.resource-group-title {
    color: var(--primary-color);
    font-weight: 700;
    font-size: 1.1rem;
}

.remove-resource-btn {
    background: var(--red-500);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: var(--transition);
}

.remove-resource-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.task-file-group,
.resource-url-group {
    transition: var(--transition);
}

.admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.admin-stat-card {
    background: linear-gradient(135deg, var(--blue-500), var(--purple-500));
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
}

.admin-stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.admin-stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
}

.admin-action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.admin-action-btn {
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
}

.admin-action-btn.edit {
    background: var(--blue-500);
    color: white;
}

.admin-action-btn.view {
    background: var(--gray-500);
    color: white;
}

.admin-action-btn.toggle {
    background: var(--yellow-500);
    color: white;
}

.admin-action-btn:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}

.student-assignment-preview {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid var(--blue-500);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    display: none;
}

.student-assignment-preview.show {
    display: block;
}

.assigned-student-item {
    background: white;
    padding: 0.5rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
}

.grade-filter-section {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

/* Super Admin Navigation Enhancement */
.super-admin-nav-section {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 1rem;
    padding-top: 1rem;
}

.super-admin-nav-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 0.5rem;
    padding: 0 1.5rem;
}

/* Enhanced Modal Styles */
.modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.modal-section {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.modal-section-title {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

/* Resource Type Indicators */
.resource-type-internal_file {
    background: rgba(139, 92, 246, 0.1);
    color: var(--purple-500);
}

.resource-type-external_link {
    background: rgba(59, 130, 246, 0.1);
    color: var(--blue-500);
}

.resource-type-common_link {
    background: rgba(245, 158, 11, 0.1);
    color: var(--yellow-500);
}

/* Admin Status Badges */
.admin-status-active {
    background: rgba(16, 185, 129, 0.1);
    color: var(--green-500);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.admin-status-inactive {
    background: rgba(239, 68, 68, 0.1);
    color: var(--red-500);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .resource-input-group {
        padding: 1rem;
    }
    
    .admin-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .modal-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-action-buttons {
        flex-direction: column;
    }
}
/* Add these styles to your admin dashboard CSS */

/* Messages Badge */
.message-count-badge {
    background: var(--red-500);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-left: 0.5rem;
}

.nav-item {
    position: relative;
}

/* Messages Page */
.messages-header {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-left h2 {
    margin: 0 0 0.5rem 0;
    color: var(--text-color);
}

.header-left p {
    margin: 0;
    color: var(--gray-600);
}

/* Message Tabs */
.message-tabs {
    background: white;
    border-radius: 16px;
    padding: 1rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    gap: 1rem;
}

.tab-btn {
    background: var(--gray-100);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn.active {
    background: var(--primary-color);
    color: white;
}

.tab-btn:hover:not(.active) {
    background: var(--gray-200);
}

.tab-count {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: bold;
}

.tab-btn:not(.active) .tab-count {
    background: var(--primary-color);
    color: white;
}

/* Message Filters */
.message-filters {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
}

/* Messages Container */
.messages-container {
    background: white;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    overflow: hidden;
}

.messages-list {
    max-height: 600px;
    overflow-y: auto;
}

.message-item {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.message-item:hover {
    background: var(--gray-50);
}

.message-item.unread {
    background: rgba(59, 130, 246, 0.05);
    border-left: 4px solid var(--blue-500);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.message-sender {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.message-subject {
    font-size: 1rem;
    color: var(--text-color);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.message-preview {
    color: var(--gray-600);
    font-size: 0.9rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.message-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.8rem;
    color: var(--gray-500);
}

.message-type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.message-type-general {
    background: rgba(107, 114, 128, 0.1);
    color: var(--gray-600);
}

.message-type-announcement {
    background: rgba(59, 130, 246, 0.1);
    color: var(--blue-500);
}

.message-type-urgent {
    background: rgba(239, 68, 68, 0.1);
    color: var(--red-500);
}

.message-type-reminder {
    background: rgba(245, 158, 11, 0.1);
    color: var(--yellow-500);
}

.priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 600;
}

.priority-high {
    background: rgba(245, 158, 11, 0.1);
    color: var(--yellow-500);
}

.priority-urgent {
    background: rgba(239, 68, 68, 0.1);
    color: var(--red-500);
}

.messages-empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-500);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Compose Modal Styles */
.message-modal {
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--gray-200);
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 1rem;
}

.recipient-tabs {
    display: flex;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--gray-200);
}

.recipient-tabs .tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--gray-600);
    cursor: pointer;
    transition: var(--transition);
    border-bottom: 2px solid transparent;
}

.recipient-tabs .tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: none;
}

.recipient-section {
    margin-top: 1rem;
}

.recipient-filters {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.recipient-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.recipients-grid {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 1rem;
}

.recipient-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 0.5rem;
}

.recipient-item:hover {
    background: var(--gray-50);
}

.recipient-item.selected {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid var(--blue-500);
}

.recipient-checkbox {
    margin-right: 1rem;
}

.recipient-info {
    flex: 1;
}

.recipient-name {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.recipient-details {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.selected-recipients {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.selected-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.selected-item {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.selected-item .remove-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 0;
    margin: 0;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
}

.character-count {
    text-align: right;
    font-size: 0.8rem;
    color: var(--gray-500);
    margin-top: 0.5rem;
}

/* Pagination */
.pagination-container {
    background: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--gray-200);
}

.page-info {
    color: var(--gray-600);
    font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .messages-header {
        flex-direction: column;
        align-items: stretch;
    }

    .message-tabs {
        flex-direction: column;
    }

    .message-filters {
        flex-direction: column;
        align-items: stretch;
    }

    .recipient-filters {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .message-modal {
        width: 95%;
        margin: 1rem;
    }

    .recipient-actions {
        flex-direction: column;
    }
}

/* Loading states */
.loading-messages {
    text-align: center;
    padding: 2rem;
    color: var(--gray-500);
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Bulk Assignment Styles */
.bulk-task-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: var(--transition);
}

.bulk-task-card:hover {
    border-color: var(--primary-color);
    box-shadow: var(--card-shadow);
}

.bulk-task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--gray-200);
}

.bulk-task-number {
    background: var(--primary-color);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

.bulk-remove-btn {
    background: var(--red-500);
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.bulk-remove-btn:hover {
    background: #DC2626;
    transform: scale(1.1);
}

.bulk-student-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    padding: 1rem;
    transition: var(--transition);
    cursor: pointer;
}

.bulk-student-card:hover {
    border-color: var(--primary-color);
    background: rgba(5, 150, 105, 0.05);
}

.bulk-student-card.selected {
    border-color: var(--primary-color);
    background: rgba(5, 150, 105, 0.1);
}

.assignment-summary {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Subject Assignment Styles */
.subject-checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.subject-checkbox-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
}

.subject-checkbox-item:hover {
    border-color: var(--primary-color);
    background: var(--gray-50);
}

.subject-checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 1rem;
    cursor: pointer;
}

.subject-checkbox-item.checked {
    border-color: var(--primary-color);
    background: rgba(220, 38, 38, 0.05);
}

.subject-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: var(--primary-color);
    color: white;
    border-radius: 20px;
    margin: 0.25rem;
    font-size: 0.875rem;
}

.subject-chip .remove-btn {
    margin-left: 0.5rem;
    cursor: pointer;
    font-weight: bold;
}

.subject-chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.student-checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
}

.student-checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    cursor: pointer;
    transition: var(--transition);
}

.student-checkbox-item:hover {
    border-color: var(--primary-color);
}

.student-checkbox-item input[type="checkbox"] {
    margin-right: 0.5rem;
}

.student-checkbox-item.checked {
    border-color: var(--primary-color);
    background: rgba(220, 38, 38, 0.05);
}

    </style>
</head>
<body>
  <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span class="sidebar-logo-icon">üë®‚Äçüíº</span>
                <span class="sidebar-logo-text">Admin Portal</span>
            </div>
            <div class="sidebar-subtitle">Deciph.AI Management</div>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-page="dashboard">
                <i>üìä</i> Dashboard
            </a>
            <a href="#" class="nav-item" data-page="students">
                <i>üë•</i> Students
            </a>
            <a href="#" class="nav-item" data-page="tasks">
                <i>üìã</i> Tasks
            </a>
            <a href="#" class="nav-item" data-page="assign-task">
                <i>‚ûï</i> Assign Task
            </a>
            <a href="#" class="nav-item" data-page="subject-assignment">
                <i>üìö</i> Subject Assignment
            </a>
            <a href="#" class="nav-item" data-page="skill-assignment">
                <i>üéØ</i> Skill Assignment
            </a>
            <a href="#" class="nav-item" data-page="acard">
                <i>üí≥</i> A-Card Management
            </a>
            <a href="#" class="nav-item" data-page="withdrawals">
               <i>üí∞</i> Withdrawals
             <span class="withdrawal-count-badge" id="withdrawalCountBadge" style="display: none;">0</span>
            </a>
            <a href="#" class="nav-item" data-page="circles">
                <i>üí¨</i> Circle Control
            </a>
            <a href="#" class="nav-item" data-page="analytics">
                <i>üìà</i> Analytics
            </a>
            <!-- ADD THIS NEW LINE FOR SOCIAL MEDIA -->
            <a href="#" class="nav-item" data-page="social-media-assign">
                <i>üì±</i> Skills acquisition
            </a>
            <a href="#" class="nav-item" data-page="messages">
                <i>‚úâÔ∏è</i> Messages <span class="msg-count-badge" id="msgCountBadge" style="display: none;">0</span>
            </a>
            <a href="/support-dashboard" class="nav-item" target="_blank" rel="noopener noreferrer">
                <i>üí¨</i> Support
            </a>
            <!-- 1. Added admin management nav item as instructed -->
            <a href="#" class="nav-item" data-page="admin-management" id="adminManagementNav" style="display: none;">
                <i>üë•</i> Admin Management
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-profile">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div class="admin-info">
                    <div class="admin-name" id="adminName">Admin User</div>
                    <div class="admin-role" id="adminRole">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i>üö™</i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <button class="refresh-btn" id="refreshBtn">
                    <span>üîÑ</span>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Dashboard Page -->
            <div class="page-content active" id="dashboard-page">
                <!-- Dashboard Stats -->
                <div class="stats-grid">
                    <div class="stat-card students">
                        <div class="stat-header">
                            <div class="stat-icon">üë•</div>
                        </div>
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                        <div class="stat-change stat-increase">
                            <span>‚Üë</span>
                            <span id="activeStudents">0 active this week</span>
                        </div>
                    </div>

                    <div class="stat-card tasks">
                        <div class="stat-header">
                            <div class="stat-icon">üìã</div>
                        </div>
                        <div class="stat-value" id="totalTasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                        <div class="stat-change stat-increase">
                            <span>‚Üë</span>
                            <span id="pendingTasks">0 pending</span>
                        </div>
                    </div>

                    <div class="stat-card acard">
                        <div class="stat-header">
                            <div class="stat-icon">üí≥</div>
                        </div>
                        <div class="stat-value" id="totalAcard">‚Ç≥0</div>
                        <div class="stat-label">A-Card Value</div>
                        <div class="stat-change stat-increase">
                            <span>üí∞</span>
                            <span>In circulation</span>
                        </div>
                    </div>

                    <div class="stat-card activity">
                        <div class="stat-header">
                            <div class="stat-icon">üìà</div>
                        </div>
                        <div class="stat-value" id="completedTasks">0</div>
                        <div class="stat-label">Completed Tasks</div>
                        <div class="stat-change stat-increase">
                            <span>‚úÖ</span>
                            <span>This week</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="section-header">
                        <h2 class="section-title">Quick Actions</h2>
                    </div>
                    
                    <div class="actions-grid">
                        <div class="action-btn assign-task" data-page="assign-task">
                            <span class="action-icon">üìù</span>
                            <div class="action-title">Assign New Task</div>
                            <div class="action-description">Create and assign tasks to students</div>
                        </div>

                        <div class="action-btn credit-acard" data-page="acard">
                            <span class="action-icon">üí≥</span>
                            <div class="action-title">Credit A-Card</div>
                            <div class="action-description">Add credits to student accounts</div>
                        </div>
                        
                        <div class="action-btn view-students" data-page="students">
                            <span class="action-icon">üë•</span>
                            <div class="action-title">View Students</div>
                            <div class="action-description">Manage student accounts</div>
                        </div>

                        <div class="action-btn" data-page="circles">
                            <span class="action-icon">üí¨</span>
                            <div class="action-title">Circle Control</div>
                            <div class="action-description">Manage student chat circles</div>
                        </div>
                    </div>
                </div>
            </div>
                      
<!-- Add this page to your admin dashboard -->
<div class="page-content" id="withdrawals-page">
    <div class="data-table">
        <div class="table-header">
            <h2 class="table-title">Withdrawal Requests</h2>
            <div class="table-controls">
                <select class="filter-select" id="withdrawalStatusFilter">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <select class="filter-select" id="withdrawalTypeFilter">
                    <option value="">All Types</option>
                    <option value="cash">Cash</option>
                    <option value="gift">Gift</option>
                </select>
                <button class="btn btn-primary" id="refreshWithdrawals">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div class="table-container">
            <table id="withdrawalsTable">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Details</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="withdrawalsTableBody">
                    <!-- Withdrawal requests will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
            <!-- Students Page -->
            <div class="page-content" id="students-page">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Students Management</h2>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="studentsSearch" placeholder="Search students...">
                            <select class="filter-select" id="gradeFilter">
                                <option value="">All Grades</option>
                                <option value="K">Kindergarten</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                            <button class="btn btn-primary" id="exportStudents">
                                üìä Export
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Grade</th>
                                    <th>School</th>
                                    <th>Points</th>
                                    <th>A-Card Balance</th>
                                    <th>Pending Tasks</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tasks Page -->
            <div class="page-content" id="tasks-page">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Tasks Management</h2>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="tasksSearch" placeholder="Search tasks...">
                            <select class="filter-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="expired">Expired</option>
                            </select>
                            <select class="filter-select" id="taskTypeFilter">
                                <option value="">All Types</option>
                                <option value="quiz">Quiz</option>
                                <option value="game">Game</option>
                                <option value="story">Story</option>
                                <option value="video">Video</option>
                                <option value="debate">Debate</option>
                            </select>
                            <button class="btn btn-primary" id="exportTasks">
                                üìä Export
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tasksTable">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Student</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Points</th>
                                    <th>A-Card Credit</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody">
                                <!-- Tasks will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Enhanced Assign Task Page -->
            <div class="page-content" id="assign-task-page">
                <div class="form-section">
                    <div class="section-header">
                        <h2 class="section-title">Assign New Task</h2>
                    </div>

                    <!-- Assignment Mode Toggle -->
                    <div class="assignment-mode-toggle" style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button type="button" class="btn btn-primary" id="superAdminSingleModeBtn" onclick="switchSuperAdminMode('single')">
                                üìù Single Task
                            </button>
                            <button type="button" class="btn btn-secondary" id="superAdminBulkModeBtn" onclick="switchSuperAdminMode('bulk')">
                                üìã Bulk Tasks
                            </button>
                        </div>
                    </div>

                    <!-- Single Task Mode -->
                    <div id="superAdminSingleTaskMode">
                    <form id="assignTaskForm">
                        <div class="form-grid">
                            <!-- Task Type with All Subjects -->
                            <div class="form-group">
                                <label class="form-label">Task Type</label>
                                <select class="form-input" id="taskType" required>
                                    <option value="">Select Task Type</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="english-language">English Language</option>
                                    <option value="business-studies">Business Studies</option>
                                    <option value="physics">Physics</option>
                                    <option value="chemistry">Chemistry</option>
                                    <option value="biology">Biology</option>
                                    <option value="economics">Economics</option>
                                    <option value="technical-engineering">Technical Engineering</option>
                                    <option value="media-literacy">Media Literacy</option>
                                    <option value="computer">Computer</option>
                                    <option value="humanities">Humanities</option>
                                    <option value="basic-science">Basic Science</option>
                                    <option value="social-studies">Social Studies</option>
                                    <option value="quiz">Quiz</option>
                                    <option value="story">Story</option>
                                    <option value="video">Video</option>
                                    <option value="debate">Debate</option>
                                    <option value="coding">Coding</option>
                                    <option value="graphics">Graphics</option>
                                    <option value="video-editing">Video Editing</option>
                                    <option value="graphics-design">Graphics Design</option>
                                    <option value="social-media">Social Media</option>
                                </select>
                            </div>

                            <!-- Task Title -->
                            <div class="form-group">
                                <label class="form-label">Task Title</label>
                                <input type="text" class="form-input" id="taskTitle" required placeholder="Enter task title">
                            </div>

                           <!-- Task Link Input -->
<div class="form-group">
    <label class="form-label">Task Link (Optional)</label>
    <select class="form-input" id="taskLinkType">
        <option value="">Select Link Type</option>
        <option value="internal">Internal Task (deciph.ai.deciphersacad.online)</option>
        <option value="external">External Link (YouTube, Website, etc.)</option>
    </select>
    
    <!-- Internal Task File -->
    <div id="internalTaskSection" style="margin-top: 0.5rem; display: none;">
        <input type="text" class="form-input" id="taskFile" placeholder="e.g., fractions, algebra, essay-writing">
        <div class="task-file-section">
            <div class="task-file-info">
                üí° <strong>Internal Task Usage:</strong> Enter a specific topic/file name.
            </div>
            <div class="task-file-info">
                Example: If you enter "fractions", students will be redirected to:
                <code>https://deciph.ai.deciphersacad.online/fractions</code>
            </div>
        </div>
    </div>
    
    <!-- External Link -->
    <div id="externalLinkSection" style="margin-top: 0.5rem; display: none;">
        <input type="url" class="form-input" id="externalLink" placeholder="https://example.com or https://youtube.com/watch?v=...">
        <div class="task-file-section">
            <div class="task-file-info">
                üí° <strong>External Link Usage:</strong> Enter any valid URL (YouTube, educational sites, etc.)
            </div>
            <div class="task-file-info">
                Students will be directed to this exact URL when they access the task.
            </div>
        </div>
    </div>
</div>

                            <!-- Class Link (Zoom) Section - Optional -->
                            <div class="form-group" id="classLinkSection">
                                <label class="form-label">Class Link - Zoom (Optional)</label>
                                <input type="url" class="form-input" id="classLinkUrl" placeholder="https://zoom.us/j/... or any meeting link">
                                <div style="margin-top: 0.5rem;">
                                    <label class="form-label" style="font-size: 0.85rem;">Class Start Time</label>
                                    <input type="datetime-local" class="form-input" id="classStartTime" placeholder="Set class start time">
                                </div>
                                <div class="task-file-section" style="margin-top: 0.5rem;">
                                    <div class="task-file-info">
                                        <strong>Class Link Info:</strong> This is optional. If provided, students will see a countdown timer and a "Start Lesson" button on their task page. The button activates 5 minutes before the scheduled class time. This link is separate from the task link above.
                                    </div>
                                </div>
                            </div>

                            <!-- Points and A-Card -->
                            <div class="form-group">
                                <label class="form-label">Points Reward</label>
                                <input type="number" class="form-input" id="pointsReward" min="0" placeholder="0">
                            </div>

                            <div class="form-group">
                                <label class="form-label">A-Card Credit (‚Ç≥)</label>
                                <input type="number" class="form-input" id="acardCredit" min="0" step="0.01" placeholder="0.00">
                            </div>

                            <!-- Select Students -->
                            <div class="form-group">
                                <label class="form-label">Select Students</label>
                                <select class="form-input" id="studentSelect" multiple size="6">
                                    <!-- Students will be loaded here -->
                                </select>
                                <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                                    Hold Ctrl/Cmd to select multiple students
                                </small>
                            </div>
                        </div>

                        <!-- Task Schedule Section -->
                        <div class="schedule-section">
                            <div class="schedule-toggle">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="weeklySchedule">
                                    <span class="toggle-slider"></span>
                                </label>
                                <label for="weeklySchedule" style="font-weight: 600; cursor: pointer;">
                                    Enable Weekly Schedule (Assign tasks across multiple days)
                                </label>
                            </div>
                            
                            <!-- Single Task Assignment -->
                            <div id="singleTaskSection">
                                <div class="form-group">
                                    <label class="form-label">Due Date (Optional)</label>
                                    <input type="datetime-local" class="form-input" id="dueDate">
                                </div>
                            </div>

                            <!-- Weekly Task Assignment -->
                            <div id="weeklyTaskSection" class="days-selector">
                                <div class="day-checkbox">
                                    <input type="checkbox" id="monday" value="monday">
                                    <label for="monday">Monday</label>
                                </div>
                                <div class="day-checkbox">
                                    <input type="checkbox" id="tuesday" value="tuesday">
                                    <label for="tuesday">Tuesday</label>
                                </div>
                                <div class="day-checkbox">
                                    <input type="checkbox" id="wednesday" value="wednesday">
                                    <label for="wednesday">Wednesday</label>
                                </div>
                                <div class="day-checkbox">
                                    <input type="checkbox" id="thursday" value="thursday">
                                    <label for="thursday">Thursday</label>
                                </div>
                                <div class="day-checkbox">
                                    <input type="checkbox" id="friday" value="friday">
                                    <label for="friday">Friday</label>
                                </div>
                            </div>

                            <!-- Week Start Date for Weekly Tasks -->
                            <div id="weekStartSection" style="display: none; margin-top: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Week Start Date</label>
                                    <input type="date" class="form-input" id="weekStartDate">
                                    <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                                        Select the Monday of the week when tasks should start
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Task Description -->
                        <div class="form-group">
                            <label class="form-label">Task Description</label>
                            <textarea class="form-input form-textarea" id="taskDescription" placeholder="Enter detailed task description..."></textarea>
                        </div>

                        <!-- Task Data -->
                        <div class="form-group">
                            <label class="form-label">Task Data (JSON - Optional)</label>
                            <textarea class="form-input form-textarea" id="taskData" placeholder='{"subject": "math", "difficulty": "medium", "additional_info": {}}'></textarea>
                            <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                                Optional: Additional task configuration in JSON format
                            </small>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                üìù Assign Task(s)
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                üîÑ Reset Form
                            </button>
                        </div>
                    </form>
                    </div>
                    <!-- End Single Task Mode -->

                    <!-- Bulk Task Mode -->
                    <div id="superAdminBulkTaskMode" style="display: none;">
                        <!-- Task Builder -->
                        <div class="task-builder" id="superAdminBulkTaskBuilder">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Tasks to Assign</h4>
                            <div id="superAdminBulkTasksContainer"></div>
                            <button type="button" class="btn btn-secondary" onclick="addSuperAdminBulkTask()" style="margin: 1rem 0;">
                                ‚ûï Add Another Task
                            </button>
                        </div>

                        <!-- Student Selection -->
                        <div class="bulk-student-selection" style="margin: 2rem 0;">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Select Students</h4>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="selectAllSuperAdminBulkStudents()">‚úì Select All</button>
                                <button type="button" class="btn btn-secondary" onclick="deselectAllSuperAdminBulkStudents()">‚úó Deselect All</button>
                                <button type="button" class="btn btn-secondary" onclick="selectByGradeSuperAdminBulk()">üéì Select by Grade</button>
                                <button type="button" class="btn btn-secondary" onclick="selectBySkillSuperAdminBulk('Graphics Design')">üé® Select Graphics</button>
                                <button type="button" class="btn btn-secondary" onclick="selectBySkillSuperAdminBulk('Coding')">üíª Select Coding</button>
                                <button type="button" class="btn btn-secondary" onclick="selectBySkillSuperAdminBulk('Video Editing')">üé• Select Video Editing</button>
                            </div>

                            <!-- Search by Name -->
                            <div style="margin-bottom: 1rem;">
                                <div class="form-group" style="margin: 0;">
                                    <input type="text"
                                           id="superAdminBulkStudentSearch"
                                           class="form-input"
                                           placeholder="üîç Search students by name..."
                                           oninput="filterSuperAdminBulkStudents()"
                                           style="max-width: 400px;">
                                </div>
                            </div>

                            <div id="superAdminBulkStudentGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;"></div>
                        </div>

                        <!-- Assignment Summary -->
                        <div id="superAdminBulkAssignmentSummary" class="assignment-summary" style="display: none; background: var(--primary-color); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; margin-bottom: 1.5rem;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700;" id="superAdminBulkTotalTasks">0</div>
                                    <div style="opacity: 0.9; font-size: 0.875rem;">Tasks</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700;" id="superAdminBulkTotalStudents">0</div>
                                    <div style="opacity: 0.9; font-size: 0.875rem;">Students</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700;" id="superAdminBulkTotalAssignments">0</div>
                                    <div style="opacity: 0.9; font-size: 0.875rem;">Total Assignments</div>
                                </div>
                            </div>
                            <button class="btn" onclick="performSuperAdminBulkAssignment()" id="superAdminBulkAssignBtn" style="background: white; color: var(--primary-color); margin: 0 auto; display: block;" disabled>
                                üöÄ Assign All Tasks
                            </button>
                        </div>
                    </div>
                    <!-- End Bulk Task Mode -->
                </div>
            </div>

            <!-- Subject Assignment Page -->
            <div class="page-content" id="subject-assignment-page">
                <div class="subject-assignment-section">
                    <div class="section-header">
                        <h2 class="section-title">Subject Assignment</h2>
                        <p style="color: var(--gray-600);">Assign subjects to students for their personalized dashboard</p>
                    </div>

                    <!-- Assignment Mode Toggle -->
                    <div class="assignment-mode-toggle" style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary" id="subjectSingleModeBtn" onclick="switchSubjectMode('single')">
                                Single Student
                            </button>
                            <button class="btn btn-secondary" id="subjectBulkModeBtn" onclick="switchSubjectMode('bulk')">
                                Multiple Students
                            </button>
                        </div>
                    </div>

                    <!-- Single Student Mode -->
                    <div id="singleStudentSubjectMode">
                        <!-- Step 1: Select Student -->
                        <div id="singleSubjectStep1">
                            <div class="form-grid">
                                <!-- Search and Filter Section -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label">Search Student</label>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                        <input type="text"
                                               class="form-input"
                                               id="singleStudentSearchInput"
                                               placeholder="üîç Search by name, email, or school..."
                                               oninput="filterSingleStudentDropdown()"
                                               style="flex: 1; min-width: 250px;">
                                        <select class="form-input" id="singleStudentGradeFilter" onchange="filterSingleStudentDropdown()" style="min-width: 150px;">
                                            <option value="">All Grades</option>
                                            <option value="1">Grade 1</option>
                                            <option value="2">Grade 2</option>
                                            <option value="3">Grade 3</option>
                                            <option value="4">Grade 4</option>
                                            <option value="5">Grade 5</option>
                                            <option value="6">Grade 6</option>
                                            <option value="7">Grade 7</option>
                                            <option value="8">Grade 8</option>
                                            <option value="9">Grade 9</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Student Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Student</label>
                                    <select class="form-input" id="subjectStudentSelect" required onchange="loadStudentCurrentSubjects()">
                                        <option value="">Choose a student...</option>
                                        <!-- Students will be loaded here -->
                                    </select>
                                    <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;" id="studentCountDisplay"></small>
                                </div>
                            </div>

                            <!-- Current Subjects Display -->
                            <div id="currentSubjectsPanel" style="display: none; margin: 2rem 0; padding: 1.5rem; background: var(--background-color); border-radius: 8px; border: 1px solid var(--border-color);">
                                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Current Subjects:</h4>
                                <div id="currentSubjectsList" class="subject-chips-container"></div>
                            </div>

                            <!-- Next Button -->
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="goToSingleSubjectStep2()">
                                    Next: Select Subjects ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Select Subjects -->
                        <div id="singleSubjectStep2" style="display: none;">
                            <form id="assignSubjectForm">
                                <!-- Selected Student Info -->
                                <div style="margin-bottom: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Assigning subjects to:</div>
                                    <div id="selectedStudentInfo" style="color: var(--gray-600);"></div>
                                </div>

                                <!-- Subject Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Subjects to Assign</label>
                                    <div id="subjectCheckboxGrid" class="subject-checkbox-grid">
                                        <!-- Subject checkboxes will be loaded here -->
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="goToSingleSubjectStep1()">
                                        ‚Üê Back
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Assign Selected Subjects
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearSubjectForm()">
                                        Clear Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Bulk Assignment Mode -->
                    <div id="bulkStudentSubjectMode" style="display: none;">
                        <!-- Step 1: Select Students -->
                        <div id="bulkSubjectStep1">
                            <div class="form-grid">
                                <!-- Multiple Students Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Students</label>

                                    <!-- Search and Filter Controls -->
                                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                            <input type="text"
                                                   class="form-input"
                                                   id="bulkStudentSearchInput"
                                                   placeholder="üîç Search by name, email, or school..."
                                                   oninput="filterBulkStudentCheckboxes()"
                                                   style="flex: 1; min-width: 250px;">
                                            <select class="form-input" id="bulkStudentGradeFilter" onchange="filterBulkStudentCheckboxes()" style="min-width: 150px;">
                                                <option value="">All Grades</option>
                                                <option value="1">Grade 1</option>
                                                <option value="2">Grade 2</option>
                                                <option value="3">Grade 3</option>
                                                <option value="4">Grade 4</option>
                                                <option value="5">Grade 5</option>
                                                <option value="6">Grade 6</option>
                                                <option value="7">Grade 7</option>
                                                <option value="8">Grade 8</option>
                                                <option value="9">Grade 9</option>
                                                <option value="10">Grade 10</option>
                                                <option value="11">Grade 11</option>
                                                <option value="12">Grade 12</option>
                                            </select>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllSubjectStudents()">
                                                ‚úì Select All
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllSubjectStudents()">
                                                ‚úó Clear All
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectFilteredSubjectStudents()">
                                                ‚úì Select Filtered
                                            </button>
                                        </div>
                                    </div>

                                    <div id="bulkSubjectStudentCheckboxGrid" class="student-checkbox-grid" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px;">
                                        <!-- Student checkboxes will be loaded here -->
                                    </div>
                                    <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                        <span id="selectedSubjectStudentCount" style="color: var(--gray-600); font-size: 0.875rem;"></span>
                                        <span id="filteredSubjectStudentCount" style="color: var(--gray-600); font-size: 0.875rem;"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Next Button -->
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="goToBulkSubjectStep2()">
                                    Next: Select Subjects ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Select Subjects -->
                        <div id="bulkSubjectStep2" style="display: none;">
                            <form id="bulkAssignSubjectForm">
                                <!-- Selected Students Summary -->
                                <div style="margin-bottom: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Bulk assigning subjects to:</div>
                                    <div id="selectedStudentsInfo" style="color: var(--gray-600);"></div>
                                </div>

                                <!-- Subject Selection for Bulk -->
                                <div class="form-group">
                                    <label class="form-label">Select Subjects to Assign</label>
                                    <div id="bulkSubjectCheckboxGrid" class="subject-checkbox-grid">
                                        <!-- Subject checkboxes will be loaded here -->
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="goToBulkSubjectStep1()">
                                        ‚Üê Back
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Bulk Assign Subjects
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearBulkSubjectForm()">
                                        Clear Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Assignment Results -->
                    <div id="subjectAssignmentResults" style="display: none; margin-top: 2rem;"></div>
                </div>
            </div>

            <!-- Skill Assignment Page -->
            <div class="page-content" id="skill-assignment-page">
                <div class="skill-assignment-section">
                    <div class="section-header">
                        <h2 class="section-title">Skill Assignment</h2>
                        <p style="color: var(--gray-600);">Assign technical and creative skills to students</p>
                    </div>

                    <!-- Assignment Mode Toggle -->
                    <div class="assignment-mode-toggle" style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary" id="skillSingleModeBtn" onclick="switchSkillMode('single')">
                                Single Student
                            </button>
                            <button class="btn btn-secondary" id="skillBulkModeBtn" onclick="switchSkillMode('bulk')">
                                Multiple Students
                            </button>
                        </div>
                    </div>

                    <!-- Single Student Mode -->
                    <div id="skillSingleMode">
                        <!-- Step 1: Select Student -->
                        <div id="singleSkillStep1">
                            <div class="form-group">
                                <label class="form-label">Select Student</label>
                                <select class="form-input" id="singleSkillStudentSelect" required>
                                    <option value="">Choose a student...</option>
                                    <!-- Students will be loaded here -->
                                </select>
                            </div>

                            <!-- Currently Assigned Skills Display -->
                            <div id="currentSkillsDisplay" style="display: none; margin-top: 2rem;">
                                <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Currently Assigned Skills</h4>
                                <div id="currentSkillsList" class="subject-chips-container"></div>
                            </div>

                            <!-- Next Button -->
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="goToSingleSkillStep2()">
                                    Next: Select Skills ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Select Skills -->
                        <div id="singleSkillStep2" style="display: none;">
                            <form id="assignSkillForm">
                                <!-- Selected Student Info -->
                                <div style="margin-bottom: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Assigning skills to:</div>
                                    <div id="selectedStudentInfoSkill" style="color: var(--gray-600);"></div>
                                </div>

                                <!-- Skill Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Skills to Assign</label>
                                    <div id="skillCheckboxGrid" class="subject-checkbox-grid">
                                        <!-- Skill checkboxes will be loaded here -->
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="goToSingleSkillStep1()">
                                        ‚Üê Back
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Assign Selected Skills
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearSkillForm()">
                                        Clear Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Bulk Student Mode -->
                    <div id="skillBulkMode" style="display: none;">
                        <!-- Step 1: Select Students -->
                        <div id="bulkSkillStep1">
                            <div class="form-grid">
                                <!-- Multiple Students Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Students</label>

                                    <!-- Search and Filter Controls -->
                                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                            <input type="text"
                                                   class="form-input"
                                                   id="bulkSkillStudentSearchInput"
                                                   placeholder="üîç Search by name, email, or school..."
                                                   oninput="filterBulkSkillStudentCheckboxes()"
                                                   style="flex: 1; min-width: 250px;">
                                            <select class="form-input" id="bulkSkillStudentGradeFilter" onchange="filterBulkSkillStudentCheckboxes()" style="min-width: 150px;">
                                                <option value="">All Grades</option>
                                                <option value="1">Grade 1</option>
                                                <option value="2">Grade 2</option>
                                                <option value="3">Grade 3</option>
                                                <option value="4">Grade 4</option>
                                                <option value="5">Grade 5</option>
                                                <option value="6">Grade 6</option>
                                                <option value="7">Grade 7</option>
                                                <option value="8">Grade 8</option>
                                                <option value="9">Grade 9</option>
                                                <option value="10">Grade 10</option>
                                                <option value="11">Grade 11</option>
                                                <option value="12">Grade 12</option>
                                            </select>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllSkillStudents()">
                                                ‚úì Select All
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllSkillStudents()">
                                                ‚úó Clear All
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectFilteredSkillStudents()">
                                                ‚úì Select Filtered
                                            </button>
                                        </div>
                                    </div>

                                    <div id="bulkSkillStudentCheckboxGrid" class="student-checkbox-grid" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px;">
                                        <!-- Student checkboxes will be loaded here -->
                                    </div>
                                    <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                        <span id="selectedSkillStudentCount" style="color: var(--gray-600); font-size: 0.875rem;"></span>
                                        <span id="filteredSkillStudentCount" style="color: var(--gray-600); font-size: 0.875rem;"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Next Button -->
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="goToBulkSkillStep2()">
                                    Next: Select Skills ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Select Skills -->
                        <div id="bulkSkillStep2" style="display: none;">
                            <form id="bulkAssignSkillForm">
                                <!-- Selected Students Summary -->
                                <div style="margin-bottom: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Bulk assigning skills to:</div>
                                    <div id="selectedStudentsInfoSkill" style="color: var(--gray-600);"></div>
                                </div>

                                <!-- Skill Selection for Bulk -->
                                <div class="form-group">
                                    <label class="form-label">Select Skills to Assign</label>
                                    <div id="bulkSkillCheckboxGrid" class="subject-checkbox-grid">
                                        <!-- Skill checkboxes will be loaded here -->
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="goToBulkSkillStep1()">
                                        ‚Üê Back
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Bulk Assign Skills
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearBulkSkillForm()">
                                        Clear Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Assignment Results -->
                    <div id="skillAssignmentResults" style="display: none; margin-top: 2rem;"></div>
                </div>
            </div>

            <!-- A-Card Management Page -->
            <div class="page-content" id="acard-page">
                <div class="form-section">
                    <div class="section-header">
                        <h2 class="section-title">A-Card Credit Management</h2>
                    </div>

                    <form id="acardCreditForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Credit Amount ($)</label>
                                <input type="number" class="form-input" id="creditAmount" min="0.01" step="0.01" required placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Select Students</label>
                                <select class="form-input" id="acardStudentSelect" multiple size="8" required>
                                    <!-- Students will be loaded here -->
                                </select>
                                <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                                    Hold Ctrl/Cmd to select multiple students
                                </small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="creditDescription" required placeholder="Enter reason for credit...">
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                üí≥ Credit A-Card
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                üîÑ Reset Form
                            </button>
                        </div>
                    </form>
                </div>

                <!-- A-Card Transactions -->
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Recent A-Card Transactions</h2>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="transactionsSearch" placeholder="Search transactions...">
                            <select class="filter-select" id="transactionTypeFilter">
                                <option value="">All Types</option>
                                <option value="manual_credit">Manual Credit</option>
                                <option value="task_reward">Task Reward</option>
                                <option value="debit">Debit</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Balance After</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Circle Control Page -->
            <div class="page-content" id="circles-page">
                <div class="circle-controls">
                    <div class="section-header">
                        <h2 class="section-title">Study Circle Control</h2>
                        <div class="table-controls">
                            <button class="btn btn-success" id="unlockAllCircles">
                                üîì Unlock All Circles
                            </button>
                            <button class="btn btn-primary" id="lockAllCircles">
                                üîí Lock All Circles
                            </button>
                        </div>
                    </div>

                    <div id="circlesList">
                        <!-- School circles will be loaded here -->
                    </div>
                </div>

                <!-- Circle Activity Log -->
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Circle Activity Log</h2>
                    </div>
                    <div class="table-container">
                        <table id="circleActivityTable">
                            <thead>
                                <tr>
                                    <th>School</th>
                                    <th>Action</th>
                                    <th>Admin</th>
                                    <th>Timestamp</th>
                                    <th>Students Notified</th>
                                </tr>
                            </thead>
                            <tbody id="circleActivityTableBody">
                                <!-- Activity will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div class="page-content" id="analytics-page">
                <!-- Analytics Header with Filters -->
                <div class="analytics-header">
                    <div class="analytics-title-section">
                        <h2 class="analytics-main-title">üìä Comprehensive Analytics</h2>
                        <p class="analytics-subtitle">Complete overview of all student task performance</p>
                    </div>
                    
                    <div class="analytics-filters">
                        <select class="filter-select" id="schoolFilter">
                            <option value="">All Schools</option>
                        </select>
                        <select class="filter-select" id="gradeFilterAnalytics">
                            <option value="">All Grades</option>
                            <option value="K">Kindergarten</option>
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                        <input type="date" class="filter-input" id="dateFromFilter" placeholder="From Date">
                        <input type="date" class="filter-input" id="dateToFilter" placeholder="To Date">
                        <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
                    </div>
                </div>

                <!-- Overview Stats Grid -->
                <div class="analytics-overview-grid">
                    <div class="analytics-stat-card primary">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalStudentsAnalytics">0</div>
                            <div class="stat-label">Total Students</div>
                            <div class="stat-sublabel" id="activeStudentsAnalytics">0 active</div>
                        </div>
                    </div>
                    
                    <div class="analytics-stat-card success">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalTasksAnalytics">0</div>
                            <div class="stat-label">Total Tasks</div>
                            <div class="stat-sublabel" id="completedTasksAnalytics">0 completed</div>
                        </div>
                    </div>
                    
                    <div class="analytics-stat-card warning">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-content">
                            <div class="stat-number" id="avgTimeAnalytics">0m</div>
                            <div class="stat-label">Avg Time</div>
                            <div class="stat-sublabel">per task</div>
                        </div>
                    </div>
                    
                    <div class="analytics-stat-card info">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="avgScoreAnalytics">0%</div>
                            <div class="stat-label">Avg Score</div>
                            <div class="stat-sublabel">across all tasks</div>
                        </div>
                    </div>
                    
                    <div class="analytics-stat-card accent">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalPointsAnalytics">0</div>
                            <div class="stat-label">Points Awarded</div>
                            <div class="stat-sublabel">total distributed</div>
                        </div>
                    </div>
                    
                    <div class="analytics-stat-card golden">
                        <div class="stat-icon">üí≥</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalAcardAnalytics">$0</div>
                            <div class="stat-label">A-Card Distributed</div>
                            <div class="stat-sublabel">total value</div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Content Grid -->
                <div class="analytics-content-grid">
                    <!-- Task Types Analysis -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">üìù Task Types Performance</h3>
                        </div>
                        <div class="task-types-analytics" id="taskTypesAnalytics">
                            <!-- Task types will be populated here -->
                        </div>
                    </div>

                    <!-- Grade Performance -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">üéì Grade Performance</h3>
                        </div>
                        <div class="grade-performance-chart">
                            <canvas id="gradePerformanceChart" style="height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- School Performance -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">üè´ School Performance</h3>
                        </div>
                        <div class="school-performance-list" id="schoolPerformanceList">
                            <!-- School performance will be populated here -->
                        </div>
                    </div>

                    <!-- Completion Trends -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">üìà Completion Trends (Last 7 Days)</h3>
                        </div>
                        <div class="completion-trends-chart">
                            <canvas id="completionTrendsChart" style="height: 250px;"></canvas>
                        </div>
                    </div>

                    <!-- Score Distribution -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">üìä Score Distribution</h3>
                        </div>
                        <div class="score-distribution-chart">
                            <canvas id="scoreDistributionChart" style="height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- Top Performers -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">üèÜ Top Performers</h3>
                        </div>
                        <div class="top-performers-list" id="topPerformersList">
                            <!-- Top performers will be populated here -->
                        </div>
                    </div>

                    <!-- Recent Submissions -->
                    <div class="analytics-section full-width">
                        <div class="section-header">
                            <h3 class="section-title">üïí Recent Submissions</h3>
                            <button class="btn btn-secondary" id="exportSubmissionsBtn">üìä Export</button>
                        </div>
                        <div class="recent-submissions-table">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Task</th>
                                            <th>Type</th>
                                            <th>Score</th>
                                            <th>Time</th>
                                            <th>Completed</th>
                                            <th>Rewards</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentSubmissionsBody">
                                        <!-- Recent submissions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Time Analysis -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3 class="section-title">‚è∞ Time Analysis</h3>
                        </div>
                        <div class="time-analysis-content" id="timeAnalysisContent">
                            <!-- Time analysis will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
<div class="page-content" id="social-media-assign-page">
    <div class="form-section">
        <div class="section-header">
            <h2 class="section-title">Assign Social Media Skill Task</h2>
            <p style="color: var(--gray-600); margin-top: 0.5rem;">
                Assign specialized tasks to social media management students
            </p>
        </div>

        <form id="assignSocialMediaTaskForm">
            <div class="form-grid">
                <!-- Skill Category -->
                <div class="form-group">
                    <label class="form-label">Skill Category</label>
                    <select class="form-input" id="smSkillCategory" required>
                        <option value="">Select Skill Category</option>
                        <option value="social-media">Social Media Management</option>
                        <option value="video-editing">Video Editing</option>
                        <option value="graphics-design">Graphics Design</option>
                        <option value="coding">Coding</option>
                    </select>
                </div>

                <!-- Task Title -->
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="smTaskTitle" required placeholder="Enter task title">
                </div>

                <!-- Week Number -->
                <div class="form-group">
                    <label class="form-label">Week Number (Optional)</label>
                    <select class="form-input" id="smWeekNumber">
                        <option value="">No specific week</option>
                        <option value="1">Week 1</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                    </select>
                </div>

                <!-- Day Number -->
                <div class="form-group">
                    <label class="form-label">Day Number (Optional)</label>
                    <select class="form-input" id="smDayNumber">
                        <option value="">No specific day</option>
                        <option value="1">Day 1</option>
                        <option value="2">Day 2</option>
                        <option value="3">Day 3</option>
                        <option value="4">Day 4</option>
                        <option value="5">Day 5</option>
                    </select>
                </div>

                <!-- Lesson Type -->
                <div class="form-group">
                    <label class="form-label">Lesson Type</label>
                    <select class="form-input" id="smLessonType">
                        <option value="lesson">Lesson</option>
                        <option value="live">Live Session</option>
                                <option value="practical">Practical</option>
                            </select>
                        </div>

                        <!-- Duration -->
                        <div class="form-group">
                            <label class="form-label">Duration</label>
                            <input type="text" class="form-input" id="smDuration" placeholder="e.g., 45 min">
                        </div>

                        <!-- Video URL -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Video/Content URL</label>
                            <input type="url" class="form-input" id="smVideoUrl" placeholder="https://example.com/video-lesson">
                        </div>

                        <!-- Zoom Passcode (for live sessions) -->
                        <div class="form-group">
                            <label class="form-label">Zoom Passcode (if applicable)</label>
                            <input type="text" class="form-input" id="smZoomPasscode" placeholder="Enter passcode">
                        </div>

                        <!-- Access Code -->
                        <div class="form-group">
                            <label class="form-label">Access Code (Optional)</label>
                            <input type="text" class="form-input" id="smAccessCode" placeholder="e.g., SMMC1">
                        </div>

                        <!-- Points Reward -->
                        <div class="form-group">
                            <label class="form-label">Points Reward</label>
                            <input type="number" class="form-input" id="smPointsReward" min="0" placeholder="0">
                        </div>

                        <!-- Due Date -->
                        <div class="form-group">
                            <label class="form-label">Due Date (Optional)</label>
                            <input type="datetime-local" class="form-input" id="smDueDate">
                        </div>
                    </div>

                    <!-- Social Media Students Selection -->
                    <div class="form-group" style="margin-top: 2rem;">
                        <label class="form-label">Select Social Media Students</label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-secondary" id="smSelectAllBtn">
                                ‚úÖ Select All
                            </button>
                            <button type="button" class="btn btn-secondary" id="smDeselectAllBtn">
                                ‚ùå Deselect All
                            </button>
                            <button type="button" class="btn btn-primary" id="smRefreshStudentsBtn">
                                üîÑ Refresh Students
                            </button>
                        </div>
                        <select class="form-input" id="smStudentSelect" multiple size="8" style="font-family: inherit;">
                            <!-- Social media students will be loaded here -->
                        </select>
                        <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                            Hold Ctrl/Cmd to select multiple students. Showing only Social Media Management students.
                        </small>
                        <div id="smSelectedCount" style="margin-top: 0.5rem; color: var(--primary-color); font-weight: 600;">
                            0 students selected
                        </div>
                    </div>

                    <!-- Task Description -->
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <textarea class="form-input form-textarea" id="smTaskDescription" placeholder="Enter detailed task description..." rows="4"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary">
                            üìù Assign Skill Task
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            üîÑ Reset Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Recent Social Media Assignments -->
            <div class="data-table">
                <div class="table-header">
                    <h2 class="table-title">Recent Social Media Assignments</h2>
                    <div class="table-controls">
                        <select class="filter-select" id="smStatusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-primary" id="smRefreshAssignments">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="smAssignmentsTable">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Student</th>
                                <th>Category</th>
                                <th>Week/Day</th>
                                <th>Status</th>
                                <th>Points</th>
                                <th>Assigned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="smAssignmentsTableBody">
                            <!-- Assignments will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Social Media Student Management -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">Social Media Student Management</h2>
                    <button class="btn btn-success" id="createSMStudentBtn">
                        üë§ Create New Student
                    </button>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Social Media Students</h3>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="smStudentsSearch" placeholder="Search students...">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="smStudentsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Skill Level</th>
                                    <th>Tasks Completed</th>
                                    <th>Total Points</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="smStudentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
            <!-- 2. Admin Management Page - Added before closing container div -->
            <div class="page-content" id="admin-management-page">
                <!-- Admin Dashboard Stats for Super Admin -->
                <div class="admin-stats-grid">
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalAdminsCount">0</div>
                        <div class="admin-stat-label">Total Admins</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="activeAdminsCount">0</div>
                        <div class="admin-stat-label">Active Admins</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalResourcesAssigned">0</div>
                        <div class="admin-stat-label">Resources Assigned</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalStudentsAssigned">0</div>
                        <div class="admin-stat-label">Students Assigned</div>
                    </div>
                </div>

                <!-- Create New Admin Section -->
                <div class="admin-create-section">
                    <div class="section-header">
                        <h2 class="section-title">Create New Admin Account</h2>
                        <p style="color: var(--gray-600);">Create admin accounts for different grade sections</p>
                    </div>

                    <form id="createAdminForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Admin Name</label>
                                <input type="text" class="form-input" id="newAdminName" required placeholder="Enter admin's full name">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="newAdminEmail" required placeholder="admin@school.edu">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="newAdminPassword" required placeholder="Minimum 6 characters">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Grade Section</label>
                                <select class="form-input" id="newAdminGradeSection" required>
                                    <option value="">Select grade section</option>
                                    <option value="1-3">Grade 1-3 (Primary)</option>
                                    <option value="4-6">Grade 4-6 (Elementary)</option>
                                    <option value="7-9">Grade 7-9 (Middle School)</option>
                                    <option value="10-12">Grade 10-12 (High School)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Max A-Card Amount per Task (‚Ç≥)</label>
                                <input type="number" class="form-input" id="newAdminMaxAcard" min="0" step="0.01" value="5.00" placeholder="5.00">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select class="form-input" id="newAdminRole">
                                    <option value="admin">Admin</option>
                                    <option value="senior_admin">Senior Admin</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                üë§ Create Admin Account
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                üîÑ Reset Form
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Admins Table -->
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Admin Accounts</h2>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="adminsSearch" placeholder="Search admins...">
                            <button class="btn btn-primary" id="refreshAdmins">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="adminsTable">
                            <thead>
                                <tr>
                                    <th>Admin</th>
                                    <th>Grade Section</th>
                                    <th>Students</th>
                                    <th>Resources</th>
                                    <th>Max A-Card</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTableBody">
                                <!-- Admins will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Assign Students Section -->
                <div class="admin-assignment-section">
                    <div class="section-header">
                        <h2 class="section-title">Assign Students to Admin</h2>
                        <p style="color: var(--gray-600);">Assign students to specific admins based on grade sections</p>
                    </div>

                    <form id="assignStudentsForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Select Admin</label>
                                <select class="form-input" id="targetAdmin" required>
                                    <option value="">Choose admin...</option>
                                    <!-- Admins will be loaded here -->
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Grade Section Filter</label>
                                <select class="form-input" id="gradeSectionFilter">
                                    <option value="">All Grades</option>
                                    <option value="1-3">Grade 1-3</option>
                                    <option value="4-6">Grade 4-6</option>
                                    <option value="7-9">Grade 7-9</option>
                                    <option value="10-12">Grade 10-12</option>
                                </select>
                            </div>
                        </div>

                        <div class="grade-filter-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4>Available Students</h4>
                                <span id="studentsCount" style="color: var(--gray-600); font-size: 0.875rem;">0 students found</span>
                            </div>
                            
                            <div class="form-group">
                                <select class="form-input" id="studentsToAssign" multiple size="8" required>
                                    <!-- Students will be loaded here -->
                                </select>
                                <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                                    Hold Ctrl/Cmd to select multiple students
                                </small>
                            </div>
                        </div>

                        <div class="student-assignment-preview" id="assignmentPreview">
                            <h4 style="color: var(--blue-500); margin-bottom: 1rem;">Assignment Preview:</h4>
                            <div id="assignmentPreviewContent"></div>
                        </div>

                        <div style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                üë• Assign Students
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="previewAssignment()">
                                üëÅÔ∏è Preview Assignment
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Assign Resources Section -->
                <div class="admin-assignment-section">
                    <div class="section-header">
                        <h2 class="section-title">Assign Resources to Admin</h2>
                        <p style="color: var(--gray-600);">Assign files and links to admin's grade section</p>
                    </div>

                    <form id="assignResourcesForm">
                        <div class="form-group">
                            <label class="form-label">Select Admin</label>
                            <select class="form-input" id="resourceTargetAdmin" required>
                                <option value="">Choose admin...</option>
                                <!-- Admins will be loaded here -->
                            </select>
                        </div>

                        <div id="resourcesContainer">
                            <div class="resource-input-group">
                                <div class="resource-group-header">
                                    <h4 class="resource-group-title">Resource #1</h4>
                                    <button type="button" class="remove-resource-btn" onclick="removeResourceGroup(this)" style="display: none;">
                                        ‚ùå Remove
                                    </button>
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Resource Type</label>
                                        <select class="form-input resource-type" required>
                                            <option value="">Select type...</option>
                                            <option value="internal_file">Internal File (Deciph.AI)</option>
                                            <option value="external_link">External Link</option>
                                            <option value="common_link">Common Link</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Resource Title</label>
                                        <input type="text" class="form-input resource-title" required placeholder="Enter resource title">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Subject Category</label>
                                        <select class="form-input resource-category" required>
                                            <option value="">Select category...</option>
                                            <option value="mathematics">Mathematics</option>
                                            <option value="english">English</option>
                                            <option value="science">Science</option>
                                            <option value="history">History</option>
                                            <option value="computer">Computer</option>
                                            <option value="general">General</option>
                                        </select>
                                    </div>

                                    <div class="form-group task-file-group" style="display: none;">
                                        <label class="form-label">Task File Name</label>
                                        <input type="text" class="form-input task-file" placeholder="e.g., fractions, algebra">
                                        <small style="color: var(--gray-600); margin-top: 0.25rem; display: block;">
                                            Will create: https://deciph.ai.deciphersacad.online/<strong>[filename]</strong>
                                        </small>
                                    </div>

                                    <div class="form-group resource-url-group" style="display: none;">
                                        <label class="form-label">Resource URL</label>
                                        <input type="url" class="form-input resource-url" placeholder="https://example.com/resource">
                                    </div>

                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-input resource-description" rows="2" placeholder="Describe this resource..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <button type="button" class="btn btn-secondary" id="addResourceBtn">
                                ‚ûï Add Another Resource
                            </button>
                        </div>

                        <div style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                üìö Assign Resources
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                üîÑ Reset Form
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Resource Management Section -->
                <div class="admin-assignment-section" style="margin-top: 3rem;">
                    <div class="section-header">
                        <h2 class="section-title">Manage Admin Resources</h2>
                        <p style="color: var(--gray-600);">View, edit, and delete resources assigned to admins</p>
                    </div>

                    <!-- Resource Filters -->
                    <div class="form-grid" style="margin-bottom: 2rem;">
                        <div class="form-group">
                            <label class="form-label">Filter by Admin</label>
                            <select class="form-input" id="resourceAdminFilter">
                                <option value="">All Admins</option>
                                <!-- Admins will be loaded here -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Filter by Resource Type</label>
                            <select class="form-input" id="resourceTypeFilter">
                                <option value="">All Types</option>
                                <option value="internal_file">Internal File</option>
                                <option value="external_link">External Link</option>
                                <option value="common_link">Common Link</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Filter by Subject</label>
                            <select class="form-input" id="resourceSubjectFilter">
                                <option value="">All Subjects</option>
                                <option value="mathematics">Mathematics</option>
                                <option value="english">English</option>
                                <option value="science">Science</option>
                                <option value="history">History</option>
                                <option value="computer">Computer</option>
                                <option value="general">General</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="applyResourceFilters" style="margin-top: 1.5rem;">
                                üîç Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Resources Table -->
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Admin Resources</h3>
                            <div class="table-controls">
                                <input type="text" class="search-input" id="resourcesSearch" placeholder="Search resources...">
                                <button class="btn btn-primary" id="refreshResources">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="adminResourcesTable">
                                <thead>
                                    <tr>
                                        <th>Resource</th>
                                        <th>Admin</th>
                                        <th>Type</th>
                                        <th>Subject</th>
                                        <th>URL/File</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminResourcesTableBody">
                                    <!-- Resources will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Student Details Modal -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Student Details</h3>
                <button class="modal-close" data-modal="studentModal">&times;</button>
            </div>
            <div class="modal-body" id="studentModalBody">
                <!-- Student details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Task Details</h3>
                <button class="modal-close" data-modal="taskModal">&times;</button>
            </div>
            <div class="modal-body" id="taskModalBody">
                <!-- Task details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="completeTaskBtn" style="display: none;">
                    ‚úÖ Mark Complete
                </button>
                <button class="btn btn-secondary" data-modal="taskModal">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- 3. Admin Settings Modal - Added before closing body tag -->
    <div class="modal" id="adminSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Admin Settings</h3>
                <button class="modal-close" onclick="closeAdminModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editAdminForm">
                    <input type="hidden" id="editAdminId">
                    
                    <div class="modal-grid">
                        <div class="modal-section">
                            <div class="modal-section-title">Basic Information</div>
                            <div class="form-group">
                                <label class="form-label">Admin Name</label>
                                <input type="text" class="form-input" id="editAdminName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="editAdminEmail" readonly style="background: var(--gray-100);">
                            </div>
                        </div>

                        <div class="modal-section">
                            <div class="modal-section-title">Assignment Settings</div>
                            <div class="form-group">
                                <label class="form-label">Grade Section</label>
                                <select class="form-input" id="editAdminGradeSection" required>
                                    <option value="1-3">Grade 1-3 (Primary)</option>
                                    <option value="4-6">Grade 4-6 (Elementary)</option>
                                    <option value="7-9">Grade 7-9 (Middle School)</option>
                                    <option value="10-12">Grade 10-12 (High School)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max A-Card Amount per Task (‚Ç≥)</label>
                                <input type="number" class="form-input" id="editAdminMaxAcard" min="0" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Account Status</label>
                        <select class="form-input" id="editAdminStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary">
                            üíæ Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeAdminModal()">
                            ‚ùå Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Messages Page -->
    <div class="page-content" id="messages-page">
        <div class="messages-container" id="messagesContainer">
            <div class="messages-header">
                <div style="display:flex;align-items:center;gap:16px;">
                    <h3 style="margin:0;">Student Messages</h3>
                    <span class="unread-msg-badge" id="msgUnreadBadge" style="display:none;background:#e74c3c;color:#fff;padding:3px 10px;border-radius:12px;font-size:13px;">0 unread</span>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="showComposeMessage()">+ New Message</button>
                    <button class="btn btn-secondary" onclick="showBroadcastMessage()">Broadcast All</button>
                </div>
            </div>

            <!-- Tabs -->
            <div style="display:flex;gap:0;border-bottom:2px solid #e1e5e9;margin:16px 0;">
                <button class="msg-tab active" data-msg-tab="students" onclick="switchMsgTab('students')">Students</button>
                <button class="msg-tab" data-msg-tab="inbox" onclick="switchMsgTab('inbox')">Inbox</button>
                <button class="msg-tab" data-msg-tab="sent" onclick="switchMsgTab('sent')">Sent</button>
                <button class="msg-tab" data-msg-tab="conversation" onclick="switchMsgTab('conversation')" id="conversationTab" style="display:none;">Conversation</button>
            </div>

            <!-- Students Tab -->
            <div class="msg-tab-content active" id="msg-students-tab">
                <div style="margin-bottom:16px;display:flex;gap:10px;">
                    <input type="text" id="studentSearchInput" placeholder="Search students by name or email..." style="flex:1;padding:10px 14px;border:1px solid #dce1e6;border-radius:6px;font-size:14px;" />
                    <button class="btn btn-primary" onclick="searchStudentsForMessages()">Search</button>
                </div>
                <div id="msgStudentsList" class="messages-list"></div>
            </div>

            <!-- Inbox Tab -->
            <div class="msg-tab-content" id="msg-inbox-tab">
                <div id="msgInboxList" class="messages-list"></div>
            </div>

            <!-- Sent Tab -->
            <div class="msg-tab-content" id="msg-sent-tab">
                <div id="msgSentList" class="messages-list"></div>
            </div>

            <!-- Conversation Tab -->
            <div class="msg-tab-content" id="msg-conversation-tab">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h4 id="conversationTitle" style="margin:0;">Conversation</h4>
                    <button class="btn btn-secondary" onclick="switchMsgTab('students')">Back to Students</button>
                </div>
                <div id="conversationMessages" style="background:#f5f6fa;border-radius:8px;padding:16px;max-height:450px;overflow-y:auto;margin-bottom:16px;display:flex;flex-direction:column;gap:10px;"></div>
                <form onsubmit="sendConversationReply(event)" style="display:flex;gap:10px;align-items:flex-end;">
                    <textarea id="conversationReplyInput" placeholder="Type your message..." rows="3" style="flex:1;padding:10px 14px;border:1px solid #dce1e6;border-radius:8px;font-size:14px;resize:none;font-family:inherit;"></textarea>
                    <button type="submit" class="btn btn-primary" id="conversationSendBtn">Send</button>
                </form>
            </div>
        </div>

        <!-- Compose Message Modal -->
        <div id="composeMessageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;">
            <div style="background:#fff;border-radius:12px;padding:28px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3 style="margin:0;" id="composeModalTitle">New Message</h3>
                    <button onclick="closeComposeModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                </div>
                <form onsubmit="handleSendMessage(event)">
                    <div id="recipientField" style="margin-bottom:14px;">
                        <label style="display:block;font-weight:600;font-size:13px;color:#7f8c8d;margin-bottom:6px;">TO (STUDENT)</label>
                        <select id="composeRecipient" style="width:100%;padding:10px;border:1px solid #dce1e6;border-radius:6px;font-size:14px;">
                            <option value="">-- Select a student --</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:12px;margin-bottom:14px;">
                        <div style="flex:1;">
                            <label style="display:block;font-weight:600;font-size:13px;color:#7f8c8d;margin-bottom:6px;">TYPE</label>
                            <select id="composeType" style="width:100%;padding:10px;border:1px solid #dce1e6;border-radius:6px;">
                                <option value="general">General</option>
                                <option value="announcement">Announcement</option>
                                <option value="urgent">Urgent</option>
                                <option value="reminder">Reminder</option>
                            </select>
                        </div>
                        <div style="flex:1;">
                            <label style="display:block;font-weight:600;font-size:13px;color:#7f8c8d;margin-bottom:6px;">PRIORITY</label>
                            <select id="composePriority" style="width:100%;padding:10px;border:1px solid #dce1e6;border-radius:6px;">
                                <option value="normal">Normal</option>
                                <option value="low">Low</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom:14px;">
                        <label style="display:block;font-weight:600;font-size:13px;color:#7f8c8d;margin-bottom:6px;">SUBJECT</label>
                        <input type="text" id="composeSubject" placeholder="Enter subject..." maxlength="200" required style="width:100%;padding:10px;border:1px solid #dce1e6;border-radius:6px;font-size:14px;box-sizing:border-box;" />
                    </div>
                    <div style="margin-bottom:14px;">
                        <label style="display:block;font-weight:600;font-size:13px;color:#7f8c8d;margin-bottom:6px;">MESSAGE</label>
                        <textarea id="composeBody" placeholder="Write your message..." rows="6" required style="width:100%;padding:10px;border:1px solid #dce1e6;border-radius:6px;font-size:14px;resize:vertical;font-family:inherit;box-sizing:border-box;"></textarea>
                    </div>
                    <div id="composeError" style="display:none;background:#fde8e8;color:#e74c3c;padding:10px;border-radius:6px;margin-bottom:14px;font-size:14px;"></div>
                    <div id="composeSuccess" style="display:none;background:#e8f5e9;color:#27ae60;padding:10px;border-radius:6px;margin-bottom:14px;font-size:14px;"></div>
                    <div style="display:flex;justify-content:flex-end;gap:10px;">
                        <button type="button" class="btn btn-secondary" onclick="closeComposeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="composeSendBtn">Send Message</button>
                    </div>
                    <input type="hidden" id="composeBroadcast" value="false" />
                </form>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>
    <script>
     // Global variables
let allResources = [];
let currentAdmin = null;
let studentsData = [];
let tasksData = [];
let circlesData = [];
let withdrawalsData = [];

// Add these global variables for super admin functionality
let allAdmins = [];
let allStudents = [];
let resourceCounter = 1;
let selectedStudentsPreview = [];
let socialMediaStudents = [];
let socialMediaTasks = [];

// Add analytics global variables
let analyticsData = null;
let analyticsCharts = {};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    // Ensure loading overlay is hidden initially
    hideLoading();

    // Failsafe: Auto-hide loading after 10 seconds if it's still showing
    setTimeout(() => {
        hideLoading();
    }, 10000);

    checkAuthentication();
    setupEventListeners();
    loadDashboardData();
    
    // Initialize super admin features and external link feature
    const currentAdmin = JSON.parse(localStorage.getItem('admin_user') || '{}');
    if (currentAdmin.role) {
        console.log('Super Admin features enabled');
        // Auto-load initial data if on admin management page
        setTimeout(() => {
            if (document.querySelector('.nav-item[data-page="admin-management"]')?.classList.contains('active')) {
                loadAllAdmins();
                loadStudentsByGrade();
                updateAdminStats();
            }
        }, 1000);
    }
    
    // Initialize external link feature after DOM loads
    setTimeout(() => {
        initializeExternalLinkFeature();
        
        // Override form reset
        const resetButton = document.querySelector('#assignTaskForm button[type="reset"]');
        if (resetButton) {
            resetButton.addEventListener('click', function(e) {
                e.preventDefault();
                originalResetForm();
            });
        }
    }, 1000);
});

function checkAuthentication() {
    const token = getAdminToken();
    if (!token) {
        window.location.href = '/super-login';
        return;
    }

    // Load admin data from localStorage
    const adminData = localStorage.getItem('admin_user');
    if (adminData) {
        currentAdmin = JSON.parse(adminData);
        isSuperAdmin = currentAdmin.role === 'super_admin';
        updateAdminUI();
    }
}

function getAdminToken() {
    return localStorage.getItem('admin_token') || 
           sessionStorage.getItem('admin_token') || 
           getCookie('admin_token');
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function updateAdminUI() {
    if (currentAdmin) {
        const initials = currentAdmin.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        document.getElementById('adminAvatar').textContent = initials;
        document.getElementById('adminName').textContent = currentAdmin.name;
        document.getElementById('adminRole').textContent = currentAdmin.role || 'Administrator';
    }
}

function setupEventListeners() {
    // Sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            const page = this.getAttribute('data-page');
            if (page) {
                e.preventDefault();
                navigateToPage(page);
            }

            // Close mobile menu when clicking nav items
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.add('collapsed');
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
        });
    });

    // Action buttons
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const page = this.getAttribute('data-page');
            if (page) {
                navigateToPage(page);
            }
        });
    });

    // Sidebar toggle with mobile support
    let isMobileMenuOpen = false;

    document.getElementById('sidebarToggle').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const overlay = document.getElementById('mobileOverlay');
        const isMobile = window.innerWidth <= 768;

        if (isMobile) {
            isMobileMenuOpen = !isMobileMenuOpen;

            if (isMobileMenuOpen) {
                sidebar.classList.remove('collapsed');
                sidebar.classList.add('show');
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.add('collapsed');
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        } else {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
    });

    // Close menu when clicking overlay
    document.getElementById('mobileOverlay').addEventListener('click', function() {
        if (window.innerWidth <= 768 && isMobileMenuOpen) {
            document.getElementById('sidebarToggle').click();
        }
    });

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadDashboardData();
        loadCurrentPageData();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Forms
    document.getElementById('assignTaskForm').addEventListener('submit', handleAssignTask);
    document.getElementById('acardCreditForm').addEventListener('submit', handleAcardCredit);

    // Task link type change
    document.getElementById('taskLinkType').addEventListener('change', function() {
        const linkType = this.value;
        document.getElementById('internalTaskSection').style.display = linkType === 'internal' ? 'block' : 'none';
        document.getElementById('externalLinkSection').style.display = linkType === 'external' ? 'block' : 'none';
        
        // Clear fields when switching
        if (linkType !== 'internal') document.getElementById('taskFile').value = '';
        if (linkType !== 'external') document.getElementById('externalLink').value = '';
    });

    // Weekly schedule toggle
    document.getElementById('weeklySchedule').addEventListener('change', function() {
        const weeklySection = document.getElementById('weeklyTaskSection');
        const singleSection = document.getElementById('singleTaskSection');
        const weekStartSection = document.getElementById('weekStartSection');
        
        if (this.checked) {
            weeklySection.classList.add('active');
            singleSection.style.display = 'none';
            weekStartSection.style.display = 'block';
        } else {
            weeklySection.classList.remove('active');
            singleSection.style.display = 'block';
            weekStartSection.style.display = 'none';
        }
    });

    // Circle controls
    document.getElementById('unlockAllCircles').addEventListener('click', () => toggleAllCircles(true));
    document.getElementById('lockAllCircles').addEventListener('click', () => toggleAllCircles(false));

    // Modal close
    document.querySelectorAll('.modal-close, [data-modal]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.getAttribute('data-modal') || this.closest('.modal').id;
            closeModal(modalId);
        });
    });

    // Search and filters
    setupSearchAndFilters();
    
// Setup super admin event listeners
setupSuperAdminEventListeners();
}

function setupSuperAdminEventListeners() {
    // Show admin management nav for super admin
    const currentAdmin = JSON.parse(localStorage.getItem('admin_user') || '{}');
    if (currentAdmin.role) {
        document.getElementById('adminManagementNav').style.display = 'block';
    }

    // Create Admin Form
    const createAdminForm = document.getElementById('createAdminForm');
    if (createAdminForm) {
        createAdminForm.addEventListener('submit', handleCreateAdmin);
    }

    // Assign Students Form
    const assignStudentsForm = document.getElementById('assignStudentsForm');
    if (assignStudentsForm) {
        assignStudentsForm.addEventListener('submit', handleAssignStudents);
    }

    // Assign Resources Form
    const assignResourcesForm = document.getElementById('assignResourcesForm');
    if (assignResourcesForm) {
        assignResourcesForm.addEventListener('submit', handleAssignResources);
    }

    // Edit Admin Form
    const editAdminForm = document.getElementById('editAdminForm');
    if (editAdminForm) {
        editAdminForm.addEventListener('submit', handleEditAdmin);
    }

    // Add Resource Button
    const addResourceBtn = document.getElementById('addResourceBtn');
    if (addResourceBtn) {
        addResourceBtn.addEventListener('click', addResourceGroup);
    }

    // Grade Section Filter
    const gradeSectionFilter = document.getElementById('gradeSectionFilter');
    if (gradeSectionFilter) {
        gradeSectionFilter.addEventListener('change', loadStudentsByGrade);
    }

    // Resource type change handlers
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('resource-type')) {
            handleResourceTypeChange(e.target);
        }
    });

    // Refresh admins button
    const refreshAdmins = document.getElementById('refreshAdmins');
    if (refreshAdmins) {
        refreshAdmins.addEventListener('click', loadAllAdmins);
    }

    // Students selection preview
    const studentsToAssign = document.getElementById('studentsToAssign');
    if (studentsToAssign) {
        studentsToAssign.addEventListener('change', updateAssignmentPreview);
    }

    // Target admin change
    const targetAdmin = document.getElementById('targetAdmin');
    if (targetAdmin) {
        targetAdmin.addEventListener('change', updateAssignmentPreview);
    }

    // Resource management event listeners
    setupResourceManagementEventListeners();
}

function navigateToPage(page) {
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        }
    });

    // Hide all pages
    document.querySelectorAll('.page-content').forEach(content => {
        content.classList.remove('active');
    });

    // Show selected page
    const pageElement = document.getElementById(page + '-page');
    if (pageElement) {
        pageElement.classList.add('active');
        
        // Update page title
        const pageTitle = document.getElementById('pageTitle');
        const pageTitles = {
            'dashboard': 'Dashboard',
            'students': 'Students Management',
            'tasks': 'Tasks Management',
            'assign-task': 'Assign New Task',
            'acard': 'A-Card Management',
            'circles': 'Circle Control',
            'analytics': 'Analytics',
            'admin-management': 'Admin Management',
            'messages': 'Student Messages'
        };
        pageTitle.textContent = pageTitles[page] || 'Dashboard';

        // Load page-specific data
        loadPageData(page);
    }
    
    // Setup analytics when navigating to analytics page
    if (page === 'analytics') {
        setTimeout(() => {
            setupAnalyticsEventListeners();
            loadAnalytics();
        }, 500);
    }
}

function loadPageData(page) {
    switch(page) {
        case 'students':
            loadStudents();
            break;
        case 'tasks':
            loadTasks();
            break;
        case 'assign-task':
            loadStudentsForTaskAssignment();
            break;
        case 'acard':
            loadStudentsForAcard();
            loadTransactions();
            break;
        case 'circles':
            loadCircles();
            break;
        case 'analytics':
            loadAnalytics();
            break;
        case 'admin-management':
    if (currentAdmin?.role) {
        loadAllAdmins().then(() => {
            // Wait for admins to load first
            populateResourceFilterDropdowns();
            loadAdminResources();
        });
        loadStudentsByGrade();
        updateAdminStats();
    }
    break;
        case 'messages':
            loadMessagesPage();
            break;
    }
}

function loadCurrentPageData() {
    const activePage = document.querySelector('.nav-item.active');
    if (activePage) {
        const page = activePage.getAttribute('data-page');
        loadPageData(page);
    }
}

async function loadDashboardData() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/dashboard/stats', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            updateDashboardStats(data.stats);
        } else {
            throw new Error('Failed to load dashboard data');
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Failed to load dashboard data. Using mock data.', 'error');
        // Load mock data for development
        updateDashboardStats({
            total_students: 150,
            active_students: 89,
            total_tasks: 45,
            pending_tasks: 12,
            completed_tasks: 33,
            total_acard_value: 1250.75,
            recent_registrations: 8,
            recent_task_assignments: 15
        });
    } finally {
        hideLoading();
    }
}

function updateDashboardStats(stats) {
    document.getElementById('totalStudents').textContent = stats.total_students || 0;
    document.getElementById('activeStudents').textContent = `${stats.active_students || 0} active this week`;
    document.getElementById('totalTasks').textContent = stats.total_tasks || 0;
    document.getElementById('pendingTasks').textContent = `${stats.pending_tasks || 0} pending`;
    document.getElementById('totalAcard').textContent = `${(stats.total_acard_value || 0).toFixed(2)}`;
    document.getElementById('completedTasks').textContent = stats.completed_tasks || 0;
}

async function loadStudents() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/students?per_page=100', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            studentsData = data.students || [];
            renderStudentsTable(studentsData);
        } else {
            throw new Error('Failed to load students');
        }
    } catch (error) {
        console.error('Error loading students:', error);
        showNotification('Failed to load students. Using mock data.', 'error');
        // Load mock data for development
        loadMockStudents();
    } finally {
        hideLoading();
    }
}

function loadMockStudents() {
    studentsData = [
        {
            id: 1,
            name: "Alice Johnson",
            email: "alice@school.edu",
            grade_level: "5",
            school_name: "Lincoln Elementary",
            total_points: 250,
            acard_balance: 15.50,
            pending_tasks: 2,
            is_active: true
        },
        {
            id: 2,
            name: "Bob Smith",
            email: "bob@school.edu",
            grade_level: "8",
            school_name: "Washington Middle School",
            total_points: 180,
            acard_balance: 22.75,
            pending_tasks: 1,
            is_active: true
        }
    ];
    renderStudentsTable(studentsData);
}

function renderStudentsTable(students) {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = '';

    students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${student.email}</div>
                </div>
            </td>
            <td>Grade ${student.grade_level}</td>
            <td>${student.school_name}</td>
            <td>${student.total_points || 0}</td>
            <td>${(student.acard_balance || 0).toFixed(2)}</td>
            <td>${student.pending_tasks || 0}</td>
            <td>
                <span class="status-badge ${student.is_active ? 'status-active' : 'status-inactive'}">
                    ${student.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-secondary" onclick="viewStudent(${student.id})">
                    üëÅÔ∏è View
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function loadTasks() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/tasks?per_page=100', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            tasksData = data.tasks || [];
            renderTasksTable(tasksData);
        } else {
            throw new Error('Failed to load tasks');
        }
    } catch (error) {
        console.error('Error loading tasks:', error);
        showNotification('Failed to load tasks. Using mock data.', 'error');
        loadMockTasks();
    } finally {
        hideLoading();
    }
}

function loadMockTasks() {
    tasksData = [
        {
            id: 1,
            title: "Math Assignment - Fractions",
            task_type: "mathematics",
            status: "pending",
            points_reward: 50,
            acard_credit: 2.50,
            student: { id: 1, name: "Alice Johnson", grade_level: "5" },
            assigned_at: new Date().toISOString(),
            due_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
            task_data: { task_file: "fractions" }
        }
    ];
    renderTasksTable(tasksData);
}

// Replace the actions column in your renderTasksTable function
function renderTasksTable(tasks) {
    const tbody = document.getElementById('tasksTableBody');
    tbody.innerHTML = '';

    tasks.forEach(task => {
        const row = document.createElement('tr');
        const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date';
        const taskData = task.task_data || {};
        const taskFile = taskData.task_file;
        
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${task.task_title || task.title}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${task.task_description || task.description || ''}</div>
                    ${taskFile ? `<div style="font-size: 0.75rem; color: var(--blue-500); font-weight: 500;">File: ${taskFile}</div>` : ''}
                </div>
            </td>
            <td>
                <div>
                    <div>${task.student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">Grade ${task.student.grade_level}</div>
                </div>
            </td>
            <td>
                <span style="text-transform: capitalize;">${task.task_type.replace('_', ' ')}</span>
            </td>
            <td>
                <span class="status-badge status-${task.status}">
                    ${task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ')}
                </span>
            </td>
            <td>${task.points_reward || 0}</td>
            <td>${(task.acard_credit || 0).toFixed(2)}</td>
            <td>${dueDate}</td>
            <td>
                <div class="task-actions">
                    <button class="task-action-btn view" onclick="viewTask(${task.id})">
                        üëÅÔ∏è View
                    </button>
                    ${task.status !== 'completed' ? `
                        <button class="task-action-btn edit" onclick="editTask(${task.id})">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="task-action-btn delete" onclick="deleteTask(${task.id})">
                            üóëÔ∏è Delete
                        </button>
                    ` : ''}
                    ${task.status === 'pending' ? `
                        <button class="task-action-btn complete" onclick="completeTask(${task.id})">
                            ‚úÖ Complete
                        </button>
                    ` : ''}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function loadStudentsForTaskAssignment() {
    if (studentsData.length === 0) {
        await loadStudents();
    }
    populateStudentSelect('studentSelect', studentsData);
}

async function loadStudentsForAcard() {
    if (studentsData.length === 0) {
        await loadStudents();
    }
    populateStudentSelect('acardStudentSelect', studentsData);
}

function populateStudentSelect(selectId, students) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';

    students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.name} (Grade ${student.grade_level}) - ${student.school_name}`;
        select.appendChild(option);
    });
}

// Updated task assignment function with external link support and class link
async function handleAssignTask(e) {
    e.preventDefault();

    const selectedStudents = Array.from(document.getElementById('studentSelect').selectedOptions)
        .map(option => parseInt(option.value));

    if (selectedStudents.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    const isWeeklySchedule = document.getElementById('weeklySchedule').checked;
    const taskType = document.getElementById('taskType').value;

    // Get link configuration from the new UI
    const linkConfig = getCurrentTaskLinkConfig();

    // Get class link configuration (optional)
    const classLinkUrl = document.getElementById('classLinkUrl')?.value.trim() || '';
    const classStartTime = document.getElementById('classStartTime')?.value || '';

    let classLinkConfig = null;
    if (classLinkUrl) {
        try {
            new URL(classLinkUrl); // Validate URL
            classLinkConfig = {
                url: classLinkUrl,
                start_time: classStartTime || null
            };
        } catch (error) {
            showNotification('Please enter a valid class link URL', 'error');
            return;
        }

        if (!classStartTime) {
            showNotification('Please set a class start time for the class link', 'error');
            return;
        }
    }

    // Allow assignment if either link_config or classLinkConfig is provided (or neither for basic tasks)
    // No longer require link_config to be mandatory

    // Build base task data
    const baseTaskData = {
        student_ids: selectedStudents,
        task_type: taskType,
        task_title: document.getElementById('taskTitle').value,
        task_description: document.getElementById('taskDescription').value,
        points_reward: parseInt(document.getElementById('pointsReward').value) || 0,
        acard_credit: parseFloat(document.getElementById('acardCredit').value) || 0,
        task_data: {
            link_config: linkConfig || null,  // Pass the link configuration to backend (now optional)
            class_link: classLinkConfig  // Pass class link configuration (optional)
        }
    };

    // Parse additional task data JSON if provided
    const taskDataJson = document.getElementById('taskData').value.trim();
    if (taskDataJson) {
        try {
            const additionalData = JSON.parse(taskDataJson);
            baseTaskData.task_data = { ...baseTaskData.task_data, ...additionalData };
        } catch (error) {
            showNotification('Invalid JSON in task data field', 'error');
            return;
        }
    }

    showLoading();
    
    try {
        if (isWeeklySchedule) {
            await handleWeeklyTaskAssignment(baseTaskData);
        } else {
            await handleSingleTaskAssignment(baseTaskData);
        }
    } catch (error) {
        console.error('Error assigning tasks:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function handleSingleTaskAssignment(taskData) {
    // Add due date for single task
    const dueDate = document.getElementById('dueDate').value;
    if (dueDate) {
        try {
            const dueDateObj = new Date(dueDate);
            if (dueDateObj.getHours() === 0 && dueDateObj.getMinutes() === 0) {
                // Set to end of day if time not specified
                dueDateObj.setHours(23, 59, 59, 999);
            }
            taskData.due_date = dueDateObj.toISOString();
        } catch (error) {
            throw new Error('Invalid due date format');
        }
    }
    
    console.log('Assigning single task:', {
        title: taskData.task_title,
        due_date: taskData.due_date,
        students: taskData.student_ids.length,
        link_config: taskData.task_data.link_config
    });
    
    const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/assign-task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAdminToken()}`
        },
        body: JSON.stringify(taskData)
    });

    if (response.ok) {
        const result = await response.json();
        console.log('Single task assigned successfully:', result);
        showNotification(`Task assigned to ${result.assigned_tasks?.length || taskData.student_ids.length} students successfully!`);
        document.getElementById('assignTaskForm').reset();
        resetTaskLinkConfiguration();
    } else {
        const error = await response.json();
        console.error('Single task assignment failed:', error);
        throw new Error(error.error || 'Failed to assign task');
    }
}

async function handleWeeklyTaskAssignment(baseTaskData) {
    const selectedDays = [];
    const dayCheckboxes = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
    
    dayCheckboxes.forEach(day => {
        if (document.getElementById(day).checked) {
            selectedDays.push(day);
        }
    });

    if (selectedDays.length === 0) {
        throw new Error('Please select at least one day for weekly schedule');
    }

    const weekStartDate = document.getElementById('weekStartDate').value;
    if (!weekStartDate) {
        throw new Error('Please select a week start date');
    }

    // Ensure the week start date is actually a Monday
    const weekStart = new Date(weekStartDate);
    const dayOfWeekForWeekStart = weekStart.getDay();
    
    console.log('Selected week start date:', weekStart.toDateString());
    console.log('Day of week for selected date:', dayOfWeekForWeekStart);
    
    // If the selected date is not a Monday, adjust it to the Monday of that week
    if (dayOfWeekForWeekStart !== 1) {
        const daysFromMonday = dayOfWeekForWeekStart === 0 ? 6 : dayOfWeekForWeekStart - 1;
        weekStart.setDate(weekStart.getDate() - daysFromMonday);
        console.log('Adjusted to Monday:', weekStart.toDateString());
    }
    
    let tasksAssigned = 0;

    // Correct day offset calculation
    const dayIndexMap = {
        'monday': 0,
        'tuesday': 1,
        'wednesday': 2,
        'thursday': 3,
        'friday': 4
    };

    console.log('Creating tasks for days:', selectedDays);
    console.log('Week structure will be:');
    selectedDays.forEach(day => {
        const dayOffset = dayIndexMap[day];
        const dayDate = new Date(weekStart);
        dayDate.setDate(weekStart.getDate() + dayOffset);
        console.log(`  ${day}: ${dayDate.toDateString()} (offset: +${dayOffset} days)`);
    });

    // Create tasks for each selected day
    for (const day of selectedDays) {
        const dayOffset = dayIndexMap[day];
        
        // Calculate the correct due date
        const taskDueDate = new Date(weekStart);
        taskDueDate.setDate(weekStart.getDate() + dayOffset);
        taskDueDate.setHours(23, 59, 59, 999); // End of day
        
        console.log(`\nüìÖ Creating task for ${day}:`, {
            day: day,
            weekStart: weekStart.toDateString(),
            dayOffset: dayOffset,
            calculatedDate: taskDueDate.toDateString(),
            calculatedDay: taskDueDate.toLocaleDateString('en-US', { weekday: 'long' }),
            ISO: taskDueDate.toISOString()
        });
        
        // Verification: Check if the calculated day matches the intended day
        const calculatedDayName = taskDueDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        if (calculatedDayName !== day) {
            console.error(`üö® DATE CALCULATION ERROR!`);
            console.error(`  Intended: ${day}`);
            console.error(`  Calculated: ${calculatedDayName}`);
            console.error(`  Date: ${taskDueDate.toDateString()}`);
            throw new Error(`Date calculation error: intended ${day}, got ${calculatedDayName}`);
        }

        // Create task data for this day
        const dayTaskData = {
            ...baseTaskData,
            task_title: `${baseTaskData.task_title} - ${day.charAt(0).toUpperCase() + day.slice(1)}`,
            due_date: taskDueDate.toISOString(),
            task_data: {
                ...baseTaskData.task_data,
                schedule_type: 'weekly',
                scheduled_day: day,
                week_start: weekStart.toISOString(),
                calculated_date_verification: {
                    intended_day: day,
                    calculated_day: calculatedDayName,
                    calculated_date: taskDueDate.toDateString(),
                    matches: calculatedDayName === day
                }
            }
        };

        console.log(`üìù Sending task assignment for ${day}:`, {
            title: dayTaskData.task_title,
            due_date: dayTaskData.due_date,
            verification: dayTaskData.task_data.calculated_date_verification
        });

        try {
            const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/assign-task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAdminToken()}`
                },
                body: JSON.stringify(dayTaskData)
            });

            if (response.ok) {
                const result = await response.json();
                console.log(`‚úÖ Task assigned successfully for ${day}:`, result);
                tasksAssigned += result.assigned_tasks?.length || baseTaskData.student_ids.length;
            } else {
                const error = await response.json();
                console.error(`‚ùå Failed to assign task for ${day}:`, error);
                throw new Error(`Failed to assign task for ${day}: ${error.error}`);
            }
        } catch (fetchError) {
            console.error(`üåê Network error assigning task for ${day}:`, fetchError);
            throw new Error(`Network error assigning task for ${day}: ${fetchError.message}`);
        }
    }

    showNotification(`‚úÖ Weekly tasks assigned! ${tasksAssigned} total tasks created across ${selectedDays.length} days.`);
    document.getElementById('assignTaskForm').reset();
    resetTaskLinkConfiguration();
}

// Helper function to reset task link configuration
function resetTaskLinkConfiguration() {
    // Reset to internal tab
    document.querySelectorAll('.link-type-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    const internalTab = document.querySelector('.link-type-tab[data-type="internal"]');
    if (internalTab) internalTab.classList.add('active');
    
    // Show internal option, hide others
    document.querySelectorAll('.link-option').forEach(option => {
        option.classList.remove('active');
    });
    const internalOption = document.getElementById('internal-option');
    if (internalOption) internalOption.classList.add('active');
    
    // Clear all inputs
    const taskFileInput = document.getElementById('taskFile');
    if (taskFileInput) taskFileInput.value = '';
    const externalUrlInput = document.getElementById('externalTaskUrl');
    if (externalUrlInput) externalUrlInput.value = '';
    const customCommonInput = document.getElementById('customCommonUrl');
    if (customCommonInput) customCommonInput.value = '';
    
    // Clear selected common links
    document.querySelectorAll('.common-link-btn.selected').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Hide previews
    const externalPreview = document.getElementById('externalLinkPreview');
    if (externalPreview) externalPreview.classList.remove('show');
    
    // Reset class link fields
    const classLinkUrlInput = document.getElementById('classLinkUrl');
    if (classLinkUrlInput) classLinkUrlInput.value = '';
    const classStartTimeInput = document.getElementById('classStartTime');
    if (classStartTimeInput) classStartTimeInput.value = '';

    // Reset weekly schedule
    document.getElementById('weeklySchedule').checked = false;
    document.getElementById('weeklyTaskSection').classList.remove('active');
    document.getElementById('singleTaskSection').style.display = 'block';
    document.getElementById('weekStartSection').style.display = 'none';
}

async function handleAcardCredit(e) {
    e.preventDefault();
    
    const selectedStudents = Array.from(document.getElementById('acardStudentSelect').selectedOptions)
        .map(option => parseInt(option.value));

    if (selectedStudents.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    const creditAmount = parseFloat(document.getElementById('creditAmount').value);
    if (isNaN(creditAmount)) {
        showNotification('Please enter a valid amount', 'error');
        return;
    }

    const creditData = {
        student_ids: selectedStudents,
        amount: creditAmount,
        description: document.getElementById('creditDescription').value.trim()
    };

    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/acard/credit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(creditData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to credit A-Card');
        }

        const result = await response.json();
        showNotification(`A-Card credited for ${result.credited_students?.length || selectedStudents.length} students successfully!`);
        document.getElementById('acardCreditForm').reset();
        loadTransactions(); // Refresh transactions
    } catch (error) {
        console.error('Error crediting A-Card:', error);
        showNotification(error.message || 'Failed to credit A-Card', 'error');
    } finally {
        hideLoading();
    }
}

async function loadTransactions() {
    // Mock implementation - replace with actual API call
    const transactions = [
        {
            student: { name: "Alice Johnson" },
            transaction_type: "manual_credit",
            amount: 10.00,
            description: "Good behavior reward",
            balance_after: 25.50,
            created_at: new Date().toISOString()
        }
    ];
    renderTransactionsTable(transactions);
}

function renderTransactionsTable(transactions) {
    const tbody = document.getElementById('transactionsTableBody');
    tbody.innerHTML = '';

    transactions.forEach(transaction => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${transaction.student.name}</td>
            <td>
                <span style="text-transform: capitalize;">
                    ${transaction.transaction_type.replace('_', ' ')}
                </span>
            </td>
            <td>${transaction.amount.toFixed(2)}</td>
            <td>${transaction.description}</td>
            <td>${transaction.balance_after.toFixed(2)}</td>
            <td>${new Date(transaction.created_at).toLocaleDateString()}</td>
        `;
        tbody.appendChild(row);
    });
}

async function loadCircles() {
    // Mock implementation - in real app, this would fetch actual circle data
    const schools = [
        { name: "Lincoln Elementary", students: 45, isLocked: false },
        { name: "Washington Middle School", students: 67, isLocked: true },
        { name: "Roosevelt High School", students: 123, isLocked: false }
    ];
    
    circlesData = schools;
    renderCircles(schools);
}

function renderCircles(schools) {
    const container = document.getElementById('circlesList');
    container.innerHTML = '';

    schools.forEach((school, index) => {
        const schoolDiv = document.createElement('div');
        schoolDiv.className = 'school-circle';
        schoolDiv.innerHTML = `
            <div class="school-info">
                <div class="school-name">${school.name}</div>
                <div class="school-stats">${school.students} students ‚Ä¢ ${school.isLocked ? 'Chat Locked' : 'Chat Open'}</div>
            </div>
            <button class="circle-toggle ${school.isLocked ? '' : 'unlocked'}" 
                    onclick="toggleCircle(${index})" 
                    data-school="${school.name}">
                ${school.isLocked ? 'üîí Locked' : 'üîì Unlocked'}
            </button>
        `;
        container.appendChild(schoolDiv);
    });
}

async function toggleCircle(index) {
    const school = circlesData[index];
    const newStatus = !school.isLocked;
    
    // Update local data
    circlesData[index].isLocked = newStatus;
    
    // Re-render circles
    renderCircles(circlesData);
    
    // Show notification
    const action = newStatus ? 'locked' : 'unlocked';
    showNotification(`${school.name} chat circle ${action} successfully!`);
    
    // Add to activity log
    addCircleActivity(school.name, newStatus ? 'Locked' : 'Unlocked', school.students);
}

async function toggleAllCircles(unlock) {
    circlesData.forEach(school => {
        school.isLocked = !unlock;
    });
    
    renderCircles(circlesData);
    
    const action = unlock ? 'unlocked' : 'locked';
    showNotification(`All chat circles ${action} successfully!`);
    
    // Add to activity log for all schools
    for (const school of circlesData) {
        addCircleActivity(school.name, unlock ? 'Unlocked' : 'Locked', school.students);
    }
}

function addCircleActivity(schoolName, action, studentsNotified) {
    const tbody = document.getElementById('circleActivityTableBody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${schoolName}</td>
        <td>
            <span class="status-badge ${action === 'Locked' ? 'status-inactive' : 'status-active'}">
                ${action}
            </span>
        </td>
        <td>${currentAdmin?.name || 'Admin'}</td>
        <td>${new Date().toLocaleString()}</td>
        <td>${studentsNotified}</td>
    `;
    tbody.insertBefore(row, tbody.firstChild);
}

async function viewStudent(studentId) {
    showLoading();
    try {
        const student = studentsData.find(s => s.id === studentId);
        if (student) {
            document.getElementById('studentModalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <h4>Personal Information</h4>
                        <p><strong>Name:</strong> ${student.name}</p>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <p><strong>Grade:</strong> ${student.grade_level}</p>
                        <p><strong>School:</strong> ${student.school_name}</p>
                    </div>
                    <div>
                        <h4>Academic Progress</h4>
                        <p><strong>Total Points:</strong> ${student.total_points || 0}</p>
                        <p><strong>A-Card Balance:</strong> ${(student.acard_balance || 0).toFixed(2)}</p>
                        <p><strong>Pending Tasks:</strong> ${student.pending_tasks || 0}</p>
                        <p><strong>Status:</strong> ${student.is_active ? 'Active' : 'Inactive'}</p>
                    </div>
                </div>
                <div>
                    <h4>Recent Activity</h4>
                    <p style="color: var(--gray-600); font-style: italic;">Loading recent activities...</p>
                </div>
            `;
            openModal('studentModal');
        }
    } catch (error) {
        console.error('Error viewing student:', error);
        showNotification('Failed to load student details', 'error');
    } finally {
        hideLoading();
    }
}

async function viewTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (task) {
        const isWeeklyTask = task.task_data && task.task_data.schedule_type === 'weekly';
        const scheduledDay = task.task_data && task.task_data.scheduled_day;
        const taskFile = task.task_data && task.task_data.task_file;
        
        document.getElementById('taskModalBody').innerHTML = `
            <div style="margin-bottom: 2rem;">
                <h4>${task.task_title || task.title}</h4>
                <p style="margin: 1rem 0;">${task.task_description || task.description || 'No description provided'}</p>
                
                ${taskFile ? `
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h5 style="color: var(--blue-500); margin-bottom: 0.5rem;">üîó External Task</h5>
                        <p><strong>Task File:</strong> ${taskFile}</p>
                        <p><strong>URL:</strong> <code>https://deciph.ai.deciphersacad.online/${taskFile}</code></p>
                    </div>
                ` : ''}
                
                ${isWeeklyTask ? `
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h5 style="color: var(--blue-500); margin-bottom: 0.5rem;">üìÖ Weekly Schedule</h5>
                        <p><strong>Scheduled Day:</strong> ${scheduledDay ? scheduledDay.charAt(0).toUpperCase() + scheduledDay.slice(1) : 'N/A'}</p>
                        <p><strong>Week Start:</strong> ${task.task_data.week_start ? new Date(task.task_data.week_start).toLocaleDateString() : 'N/A'}</p>
                    </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    <div>
                        <p><strong>Student:</strong> ${task.student.name}</p>
                        <p><strong>Type:</strong> ${task.task_type}</p>
                        <p><strong>Status:</strong> ${task.status}</p>
                    </div>
                    <div>
                        <p><strong>Points:</strong> ${task.points_reward || 0}</p>
                        <p><strong>A-Card Credit:</strong> ${(task.acard_credit || 0).toFixed(2)}</p>
                        <p><strong>Due Date:</strong> ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date'}</p>
                    </div>
                </div>
                
                ${task.completion_data && task.completion_data.score ? `
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h5 style="margin-bottom: 0.5rem;">üìä Completion Results</h5>
                        <p><strong>Score:</strong> ${task.completion_data.score}/${task.completion_data.max_score || 100}</p>
                        <p><strong>Time Spent:</strong> ${Math.floor((task.completion_data.time_spent || 0) / 60)} minutes</p>
                    </div>
                ` : ''}
            </div>
        `;
        
        const completeBtn = document.getElementById('completeTaskBtn');
        if (task.status === 'pending') {
            completeBtn.style.display = 'block';
            completeBtn.onclick = () => completeTask(task.id);
        } else {
            completeBtn.style.display = 'none';
        }
        
        openModal('taskModal');
    }
}

async function completeTask(taskId) {
    if (!confirm('Are you sure you want to mark this task as completed?')) {
        return;
    }

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/task/${taskId}/complete`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            showNotification('Task marked as completed successfully!');
            closeModal('taskModal');
            loadTasks(); // Refresh tasks table
            loadDashboardData(); // Refresh dashboard stats
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to complete task');
        }
    } catch (error) {
        console.error('Error completing task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function setupSearchAndFilters() {
    // Students search
    const studentsSearch = document.getElementById('studentsSearch');
    if (studentsSearch) {
        studentsSearch.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = studentsData.filter(student => 
                student.name.toLowerCase().includes(query) ||
                student.email.toLowerCase().includes(query) ||
                student.school_name.toLowerCase().includes(query)
            );
            renderStudentsTable(filtered);
        });
    }

    // Grade filter
    const gradeFilter = document.getElementById('gradeFilter');
    if (gradeFilter) {
        gradeFilter.addEventListener('change', function(e) {
            const grade = e.target.value;
            const filtered = grade ? studentsData.filter(student => student.grade_level === grade) : studentsData;
            renderStudentsTable(filtered);
    });
    }

    // Tasks search
    const tasksSearch = document.getElementById('tasksSearch');
    if (tasksSearch) {
        tasksSearch.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = tasksData.filter(task => 
                (task.task_title || task.title).toLowerCase().includes(query) ||
                task.student.name.toLowerCase().includes(query)
            );
            renderTasksTable(filtered);
        });
    }

    // Status filter
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function(e) {
            const status = e.target.value;
            const filtered = status ? tasksData.filter(task => task.status === status) : tasksData;
            renderTasksTable(filtered);
        });
    }

    // Task type filter
    const taskTypeFilter = document.getElementById('taskTypeFilter');
    if (taskTypeFilter) {
        taskTypeFilter.addEventListener('change', function(e) {
            const type = e.target.value;
            const filtered = type ? tasksData.filter(task => task.task_type === type) : tasksData;
            renderTasksTable(filtered);
        });
    }
}

// Super Admin Management Functions
async function handleCreateAdmin(e) {
    e.preventDefault();
    
    const adminData = {
        name: document.getElementById('newAdminName').value,
        email: document.getElementById('newAdminEmail').value,
        password: document.getElementById('newAdminPassword').value,
        grade_section: document.getElementById('newAdminGradeSection').value,
        max_acard_amount: parseFloat(document.getElementById('newAdminMaxAcard').value) || 5.00,
        role: document.getElementById('newAdminRole').value
    };

    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/create-admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(adminData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(`Admin account created successfully for ${result.admin.name}`);
            document.getElementById('createAdminForm').reset();
            loadAllAdmins();
            updateAdminStats();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create admin');
        }
    } catch (error) {
        console.error('Error creating admin:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function loadAllAdmins() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/admins', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            allAdmins = data.admins;
            renderAdminsTable();
            populateAdminSelects();
        } else {
            throw new Error('Failed to load admins');
        }
    } catch (error) {
        console.error('Error loading admins:', error);
        showNotification('Failed to load admins', 'error');
    } finally {
        hideLoading();
    }
}

function renderAdminsTable() {
    const tbody = document.getElementById('adminsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    allAdmins.forEach(admin => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${admin.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${admin.email}</div>
                </div>
            </td>
            <td>
                <span class="grade-section-badge">Grade ${admin.grade_section || 'N/A'}</span>
            </td>
            <td>${admin.assigned_students || 0}</td>
            <td>${admin.resources_count || 0}</td>
            <td>$${(admin.max_acard_amount || 0).toFixed(2)}</td>
            <td>
                <span class="admin-status-${admin.is_active ? 'active' : 'inactive'}">
                    ${admin.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <div class="admin-action-buttons">
                    <button class="admin-action-btn edit" onclick="editAdmin(${admin.id})">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="admin-action-btn view" onclick="viewAdminDetails(${admin.id})">
                        üëÅÔ∏è View
                    </button>
                    <button class="admin-action-btn toggle" onclick="toggleAdminStatus(${admin.id})">
                        ${admin.is_active ? 'üîí Disable' : 'üîì Enable'}
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function populateAdminSelects() {
    const selects = ['targetAdmin', 'resourceTargetAdmin'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">Choose admin...</option>';
            allAdmins.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.id;
                option.textContent = `${admin.name} (Grade ${admin.grade_section})`;
                select.appendChild(option);
            });
        }
    });
}

async function loadStudentsByGrade() {
    const gradeSection = document.getElementById('gradeSectionFilter')?.value || '';
    
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/students-by-grade?grade_section=${gradeSection}`, {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            allStudents = data.students;
            populateStudentsToAssign();
        } else {
            throw new Error('Failed to load students');
        }
    } catch (error) {
        console.error('Error loading students:', error);
        showNotification('Failed to load students', 'error');
    }
}

function populateStudentsToAssign() {
    const select = document.getElementById('studentsToAssign');
    const count = document.getElementById('studentsCount');
    
    if (!select) return;
    
    select.innerHTML = '';
    allStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.name} (Grade ${student.grade_level}) - ${student.school_name}`;
        select.appendChild(option);
    });

    if (count) {
        count.textContent = `${allStudents.length} students found`;
    }
}

// Replace your handleAssignStudents function with this debug version
async function handleAssignStudents(e) {
    e.preventDefault();
    
    const adminId = document.getElementById('targetAdmin').value;
    const studentIds = Array.from(document.getElementById('studentsToAssign').selectedOptions)
        .map(option => parseInt(option.value));

    // Debug: Log the values being sent
    console.log('Debug - Admin ID:', adminId);
    console.log('Debug - Student IDs:', studentIds);
    console.log('Debug - Admin ID type:', typeof adminId);
    console.log('Debug - Student IDs types:', studentIds.map(id => typeof id));

    if (!adminId || studentIds.length === 0) {
        showNotification('Please select an admin and at least one student', 'error');
        return;
    }

    // Make sure admin_id is an integer
    const adminIdInt = parseInt(adminId);
    if (isNaN(adminIdInt)) {
        showNotification('Invalid admin ID format', 'error');
        return;
    }

    const requestData = {
        admin_id: adminIdInt,  // Ensure it's an integer
        student_ids: studentIds
    };

    console.log('Debug - Sending data:', requestData);

    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/assign-students', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(requestData)
        });

        console.log('Debug - Response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Debug - Success result:', result);
            showNotification(result.message);
            document.getElementById('assignStudentsForm').reset();
            document.getElementById('assignmentPreview').classList.remove('show');
            loadAllAdmins();
            updateAdminStats();
        } else {
            const error = await response.json();
            console.log('Debug - Error response:', error);
            throw new Error(error.error || 'Failed to assign students');
        }
    } catch (error) {
        console.error('Debug - Fetch error:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function updateAssignmentPreview() {
    const adminSelect = document.getElementById('targetAdmin');
    const studentsSelect = document.getElementById('studentsToAssign');
    const preview = document.getElementById('assignmentPreview');
    const content = document.getElementById('assignmentPreviewContent');

    if (!adminSelect || !studentsSelect || !preview || !content) return;
    
    if (!adminSelect.value || studentsSelect.selectedOptions.length === 0) {
        preview.classList.remove('show');
        return;
    }

    const selectedAdmin = allAdmins.find(a => a.id == adminSelect.value);
    const selectedStudents = Array.from(studentsSelect.selectedOptions).map(option => ({
        id: option.value,
        name: option.textContent
    }));

    content.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <strong>Admin:</strong> ${selectedAdmin ? selectedAdmin.name : 'Unknown'}
            <span class="grade-section-badge" style="margin-left: 0.5rem;">Grade ${selectedAdmin ? selectedAdmin.grade_section : 'N/A'}</span>
        </div>
        <div>
            <strong>Students to Assign (${selectedStudents.length}):</strong>
            <div style="max-height: 150px; overflow-y: auto; margin-top: 0.5rem;">
                ${selectedStudents.map(student => `
                    <div class="assigned-student-item">
                        <span>${student.name}</span>
                        <small style="color: var(--gray-600);">ID: ${student.id}</small>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    preview.classList.add('show');
}

function previewAssignment() {
    updateAssignmentPreview();
    const preview = document.getElementById('assignmentPreview');
    if (preview && preview.classList.contains('show')) {
        showNotification('Assignment preview updated below the form');
    } else {
        showNotification('Please select an admin and students first', 'error');
    }
}

function addResourceGroup() {
    resourceCounter++;
    const container = document.getElementById('resourcesContainer');
    
    const resourceGroup = document.createElement('div');
    resourceGroup.className = 'resource-input-group';
    
    resourceGroup.innerHTML = `
        <div class="resource-group-header">
            <h4 class="resource-group-title">Resource #${resourceCounter}</h4>
            <button type="button" class="remove-resource-btn" onclick="removeResourceGroup(this)">
                ‚ùå Remove
            </button>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Resource Type</label>
                <select class="form-input resource-type" required>
                    <option value="">Select type...</option>
                    <option value="internal_file">Internal File (Deciph.AI)</option>
                    <option value="external_link">External Link</option>
                    <option value="common_link">Common Link</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Resource Title</label>
                <input type="text" class="form-input resource-title" required placeholder="Enter resource title">
            </div>

            <div class="form-group">
                <label class="form-label">Subject Category</label>
                <select class="form-input resource-category" required>
                    <option value="">Select category...</option>
                    <option value="mathematics">Mathematics</option>
                    <option value="english">English</option>
                    <option value="science">Science</option>
                    <option value="history">History</option>
                    <option value="computer">Computer</option>
                    <option value="general">General</option>
                </select>
            </div>

            <div class="form-group task-file-group" style="display: none;">
                <label class="form-label">Task File Name</label>
                <input type="text" class="form-input task-file" placeholder="e.g., fractions, algebra">
                <small style="color: var(--gray-600); margin-top: 0.25rem; display: block;">
                    Will create: https://deciph.ai.deciphersacad.online/<strong>[filename]</strong>
                </small>
            </div>

            <div class="form-group resource-url-group" style="display: none;">
                <label class="form-label">Resource URL</label>
                <input type="url" class="form-input resource-url" placeholder="https://example.com/resource">
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label">Description</label>
                <textarea class="form-input resource-description" rows="2" placeholder="Describe this resource..."></textarea>
            </div>
        </div>
    `;
    
    container.appendChild(resourceGroup);
    
    // Show remove button on first group now that there are multiple
    const firstGroup = container.querySelector('.resource-input-group .remove-resource-btn');
    if (firstGroup) {
        firstGroup.style.display = 'inline-block';
    }
}

function removeResourceGroup(button) {
    const container = document.getElementById('resourcesContainer');
    const resourceGroup = button.closest('.resource-input-group');
    
    if (container.querySelectorAll('.resource-input-group').length > 1) {
        resourceGroup.remove();
        
        // Hide remove button if only one group left
        if (container.querySelectorAll('.resource-input-group').length === 1) {
            const lastRemoveBtn = container.querySelector('.remove-resource-btn');
            if (lastRemoveBtn) {
                lastRemoveBtn.style.display = 'none';
            }
        }
        
        // Update resource numbers
        const groups = container.querySelectorAll('.resource-input-group');
        groups.forEach((group, index) => {
            const title = group.querySelector('.resource-group-title');
            if (title) {
                title.textContent = `Resource #${index + 1}`;
            }
        });
        
        resourceCounter = groups.length;
    } else {
        showNotification('At least one resource is required', 'error');
    }
}

function handleResourceTypeChange(selectElement) {
    const resourceGroup = selectElement.closest('.resource-input-group');
    const taskFileGroup = resourceGroup.querySelector('.task-file-group');
    const resourceUrlGroup = resourceGroup.querySelector('.resource-url-group');
    
    // Hide all specific inputs
    taskFileGroup.style.display = 'none';
    resourceUrlGroup.style.display = 'none';
    
    // Clear values
    const taskFileInput = resourceGroup
    .querySelector('.task-file');
    const resourceUrlInput = resourceGroup.querySelector('.resource-url');
    if (taskFileInput) taskFileInput.value = '';
    if (resourceUrlInput) resourceUrlInput.value = '';
    
    // Show relevant input based on type
    switch (selectElement.value) {
        case 'internal_file':
            taskFileGroup.style.display = 'block';
            break;
        case 'external_link':
        case 'common_link':
            resourceUrlGroup.style.display = 'block';
            break;
    }
}

// Replace your handleAssignResources function with this debug version

async function handleAssignResources(e) {
    e.preventDefault();
    
    const adminId = document.getElementById('resourceTargetAdmin').value;
    console.log('DEBUG - Admin ID:', adminId);
    
    if (!adminId) {
        showNotification('Please select an admin', 'error');
        return;
    }

    // Collect all resource data
    const resourceGroups = document.querySelectorAll('.resource-input-group');
    console.log('DEBUG - Found resource groups:', resourceGroups.length);
    
    const resources = [];

    for (let i = 0; i < resourceGroups.length; i++) {
        const group = resourceGroups[i];
        console.log(`DEBUG - Processing group ${i}:`, group);
        
        const resourceType = group.querySelector('.resource-type')?.value;
        const resourceTitle = group.querySelector('.resource-title')?.value;
        const resourceCategory = group.querySelector('.resource-category')?.value;
        const resourceDescription = group.querySelector('.resource-description')?.value;

        console.log(`DEBUG - Group ${i} values:`, {
            resourceType,
            resourceTitle,
            resourceCategory,
            resourceDescription
        });

        if (!resourceType || !resourceTitle || !resourceCategory) {
            console.log(`DEBUG - Group ${i} missing required fields`);
            showNotification(`Please fill in all required fields for resource ${i + 1}`, 'error');
            return;
        }

        const resourceData = {
            resource_type: resourceType,
            resource_title: resourceTitle,
            subject_category: resourceCategory,
            description: resourceDescription
        };

        // Add type-specific data
        if (resourceType === 'internal_file') {
            const taskFile = group.querySelector('.task-file')?.value;
            console.log(`DEBUG - Group ${i} task file:`, taskFile);
            if (taskFile) {
                resourceData.task_file = taskFile;
                resourceData.resource_url = `https://deciph.ai.deciphersacad.online/${taskFile}`;
            }
        } else {
            const resourceUrl = group.querySelector('.resource-url')?.value;
            console.log(`DEBUG - Group ${i} resource URL:`, resourceUrl);
            if (resourceUrl) {
                resourceData.resource_url = resourceUrl;
            }
        }

        resources.push(resourceData);
        console.log(`DEBUG - Added resource ${i}:`, resourceData);
    }

    if (resources.length === 0) {
        showNotification('Please add at least one resource', 'error');
        return;
    }

    const requestData = {
        admin_id: parseInt(adminId),
        resources: resources
    };

    console.log('DEBUG - Final request data:', requestData);

    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/assign-resources', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(requestData)
        });

        console.log('DEBUG - Response status:', response.status);

        if (response.ok) {
            const result = await response.json();
            console.log('DEBUG - Success result:', result);
            showNotification(result.message);
            document.getElementById('assignResourcesForm').reset();
            resetResourceGroups();
            loadAllAdmins();
            updateAdminStats();
        } else {
            const error = await response.json();
            console.log('DEBUG - Error response:', error);
            throw new Error(error.error || 'Failed to assign resources');
        }
    } catch (error) {
        console.error('DEBUG - Request error:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function resetResourceGroups() {
    const container = document.getElementById('resourcesContainer');
    const allGroups = container.querySelectorAll('.resource-input-group');
    
    // Remove all but the first group
    for (let i = 1; i < allGroups.length; i++) {
        allGroups[i].remove();
    }
    
    // Reset first group
    const firstGroup = container.querySelector('.resource-input-group');
    if (firstGroup) {
        firstGroup.querySelector('.resource-group-title').textContent = 'Resource #1';
        firstGroup.querySelector('.remove-resource-btn').style.display = 'none';
        firstGroup.querySelectorAll('.form-input').forEach(input => {
            if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            } else {
                input.value = '';
            }
        });
        // Hide conditional groups
        firstGroup.querySelector('.task-file-group').style.display = 'none';
        firstGroup.querySelector('.resource-url-group').style.display = 'none';
    }
    
    resourceCounter = 1;
}

function editAdmin(adminId) {
    const admin = allAdmins.find(a => a.id === adminId);
    if (!admin) return;

    // Populate edit form
    document.getElementById('editAdminId').value = admin.id;
    document.getElementById('editAdminName').value = admin.name;
    document.getElementById('editAdminEmail').value = admin.email;
    document.getElementById('editAdminGradeSection').value = admin.grade_section || '';
    document.getElementById('editAdminMaxAcard').value = admin.max_acard_amount || 0;
    document.getElementById('editAdminStatus').value = admin.is_active.toString();

    // Show modal
    document.getElementById('adminSettingsModal').classList.add('active');
}

async function handleEditAdmin(e) {
    e.preventDefault();
    
    const adminId = document.getElementById('editAdminId').value;
    const updateData = {
        name: document.getElementById('editAdminName').value,
        grade_section: document.getElementById('editAdminGradeSection').value,
        max_acard_amount: parseFloat(document.getElementById('editAdminMaxAcard').value),
        is_active: document.getElementById('editAdminStatus').value === 'true'
    };

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/admin/${adminId}/settings`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(result.message);
            closeAdminModal();
            loadAllAdmins();
            updateAdminStats();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update admin');
        }
    } catch (error) {
        console.error('Error updating admin:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function closeAdminModal() {
    document.getElementById('adminSettingsModal').classList.remove('active');
}

function viewAdminDetails(adminId) {
    const admin = allAdmins.find(a => a.id === adminId);
    if (admin) {
        const details = `
Admin: ${admin.name}
Email: ${admin.email}
Grade Section: ${admin.grade_section}
Students Assigned: ${admin.assigned_students || 0}
Resources Available: ${admin.resources_count || 0}
Max A-Card per Task: ${admin.max_acard_amount || 0}
Status: ${admin.is_active ? 'Active' : 'Inactive'}
Created: ${admin.created_at ? new Date(admin.created_at).toLocaleDateString() : 'Unknown'}
Last Login: ${admin.last_login ? new Date(admin.last_login).toLocaleDateString() : 'Never'}
        `;
        alert(details); // Replace with better modal if needed
    }
}

async function toggleAdminStatus(adminId) {
    const admin = allAdmins.find(a => a.id === adminId);
    if (!admin) return;

    const newStatus = !admin.is_active;
    const confirmMessage = `Are you sure you want to ${newStatus ? 'enable' : 'disable'} ${admin.name}?`;
    
    if (!confirm(confirmMessage)) return;

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/admin/${adminId}/settings`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify({ is_active: newStatus })
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(`Admin ${newStatus ? 'enabled' : 'disabled'} successfully`);
            loadAllAdmins();
            updateAdminStats();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update admin status');
        }
    } catch (error) {
        console.error('Error toggling admin status:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function updateAdminStats() {
    if (allAdmins.length === 0) return;

    const totalAdmins = allAdmins.length;
    const activeAdmins = allAdmins.filter(a => a.is_active).length;
    const totalResources = allAdmins.reduce((sum, a) => sum + (a.resources_count || 0), 0);
    const totalStudents = allAdmins.reduce((sum, a) => sum + (a.assigned_students || 0), 0);

    // Update stats display
    const statsElements = {
        totalAdminsCount: document.getElementById('totalAdminsCount'),
        activeAdminsCount: document.getElementById('activeAdminsCount'),
        totalResourcesAssigned: document.getElementById('totalResourcesAssigned'),
        totalStudentsAssigned: document.getElementById('totalStudentsAssigned')
    };

    if (statsElements.totalAdminsCount) statsElements.totalAdminsCount.textContent = totalAdmins;
    if (statsElements.activeAdminsCount) statsElements.activeAdminsCount.textContent = activeAdmins;
    if (statsElements.totalResourcesAssigned) statsElements.totalResourcesAssigned.textContent = totalResources;
    if (statsElements.totalStudentsAssigned) statsElements.totalStudentsAssigned.textContent = totalStudents;
}

// Analytics Functions
// Safe element getter with null checking
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Element with id '${id}' not found`);
    }
    return element;
}

// Safe text content setter
function safeSetText(elementId, text) {
    const element = safeGetElement(elementId);
    if (element) {
        element.textContent = text;
    }
}

// Safe HTML setter
function safeSetHTML(elementId, html) {
    const element = safeGetElement(elementId);
    if (element) {
        element.innerHTML = html;
    }
}

// Load comprehensive analytics
async function loadAnalytics() {
    // Check if we're on the analytics page first
    const analyticsPage = document.getElementById('analytics-page');
    if (!analyticsPage || !analyticsPage.classList.contains('active')) {
        console.log('Analytics page not active, skipping load');
        return;
    }

    showLoading();
    try {
        // Get filter values with safe element access
        const filters = {
            school: safeGetElement('schoolFilter')?.value || '',
            grade: safeGetElement('gradeFilterAnalytics')?.value || '',
            date_from: safeGetElement('dateFromFilter')?.value || '',
            date_to: safeGetElement('dateToFilter')?.value || ''
        };

        // Build query parameters
        const queryParams = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
            if (value) queryParams.append(key, value);
        });

        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/analytics/comprehensive?${queryParams}`, {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            analyticsData = await response.json();
            updateAnalyticsDisplay(analyticsData);
            initializeAnalyticsCharts();
        } else {
            throw new Error('Failed to load analytics');
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        showNotification('Failed to load analytics. Using sample data.', 'error');
        loadMockAnalytics();
    } finally {
        hideLoading();
    }
}

function loadMockAnalytics() {
    analyticsData = {
        overview: {
            total_students: 150,
            total_tasks: 45,
            avg_time_spent: 1920, // seconds
            avg_score: 75,
            total_points_awarded: 1250,
            total_acard_distributed: 150.50,
            completed_tasks: 30
        },
        task_types: {
            mathematics: { total: 15, completed: 12, pending: 3, avg_score: 80, avg_time: 1800 },
            english: { total: 10, completed: 8, pending: 2, avg_score: 85, avg_time: 2100 }
        },
        school_performance: {
            "Lincoln Elementary": { total_tasks: 20, completed_tasks: 18, avg_score: 82 },
            "Washington Middle": { total_tasks: 15, completed_tasks: 12, avg_score: 78 }
        },
        top_performers: [
            { name: "Alice Johnson", grade: "5", school: "Lincoln Elementary", completed_tasks: 5, total_tasks: 5, avg_score: 95 }
        ],
        recent_submissions: [
            {
                student_name: "Alice Johnson",
                student_grade: "5",
                school_name: "Lincoln Elementary",
                task_title: "Math Fractions",
                task_type: "mathematics",
                status: "completed",
                completion_data: { score: 90, max_score: 100, time_spent: 1800 },
                completed_at: new Date().toISOString(),
                points_reward: 50,
                acard_credit: 2.50
            }
        ],
        time_analysis: {
            avg_time_by_type: { mathematics: 1800, english: 2100 },
            fastest_completions: [
                { task_title: "Quick Math", student_name: "Bob Smith", time_spent: 600 }
            ],
            longest_completions: [
                { task_title: "Essay Writing", student_name: "Alice Johnson", time_spent: 3600 }
            ]
        },
        completion_trends: [
            { date: new Date().toISOString(), completed_tasks: 5 }
        ],
        score_distribution: {
            excellent: 10,
            good: 15,
            fair: 8,
            needs_improvement: 2
        },
        grade_performance: {
            "5": { avg_score: 85 },
            "8": { avg_score: 78 }
        }
    };
    updateAnalyticsDisplay(analyticsData);
    initializeAnalyticsCharts();
}

// Update analytics display with safe element access
function updateAnalyticsDisplay(data) {
    if (!data || !data.overview) {
        console.error('Invalid analytics data received');
        return;
    }

    // Update overview stats with safe setters
    safeSetText('totalStudentsAnalytics', data.overview.total_students || 0);
    safeSetText('totalTasksAnalytics', data.overview.total_tasks || 0);
    safeSetText('avgTimeAnalytics', `${Math.round((data.overview.avg_time_spent || 0) / 60)}m`);
    safeSetText('avgScoreAnalytics', `${Math.round(data.overview.avg_score || 0)}%`);
    safeSetText('totalPointsAnalytics', (data.overview.total_points_awarded || 0).toLocaleString());
    safeSetText('totalAcardAnalytics', `$${(data.overview.total_acard_distributed || 0).toFixed(2)}`);
    
    // Update sublabels
    const activeStudents = Object.keys(data.task_types || {}).length > 0 ? 
        Math.round((data.overview.total_students || 0) * 0.8) : 0;
    safeSetText('activeStudentsAnalytics', `${activeStudents} active`);
    safeSetText('completedTasksAnalytics', `${data.overview.completed_tasks || 0} completed`);

    // Update sections with safe checking
    if (data.task_types) updateTaskTypesAnalytics(data.task_types);
    if (data.school_performance) updateSchoolPerformance(data.school_performance);
    if (data.top_performers) updateTopPerformers(data.top_performers);
    if (data.recent_submissions) updateRecentSubmissions(data.recent_submissions);
    if (data.time_analysis) updateTimeAnalysis(data.time_analysis);
}

// Update task types analytics with safe element access
function updateTaskTypesAnalytics(taskTypes) {
    const container = safeGetElement('taskTypesAnalytics');
    if (!container) return;

    if (Object.keys(taskTypes).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 2rem;">No task data available</div>';
        return;
    }

    container.innerHTML = '';
    Object.entries(taskTypes).forEach(([type, data]) => {
        const completionRate = data.total > 0 ? (data.completed / data.total * 100) : 0;
        
        const item = document.createElement('div');
        item.className = 'task-type-analytics-item';
        item.innerHTML = `
            <div class="task-type-info">
                <div class="task-type-name">${type.replace('_', ' ')}</div>
                <div class="task-type-stats">${data.total} total ‚Ä¢ ${data.completed} completed ‚Ä¢ ${data.pending} pending</div>
            </div>
            <div class="task-type-metrics">
                <div class="task-type-metric">
                    <span class="metric-value">${Math.round(completionRate)}%</span>
                    <span class="metric-label">Completion</span>
                </div>
                <div class="task-type-metric">
                    <span class="metric-value">${Math.round(data.avg_score || 0)}%</span>
                    <span class="metric-label">Avg Score</span>
                </div>
                <div class="task-type-metric">
                    <span class="metric-value">${Math.round((data.avg_time || 0) / 60)}m</span>
                    <span class="metric-label">Avg Time</span>
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Update school performance with safe element access
function updateSchoolPerformance(schoolData) {
    const container = safeGetElement('schoolPerformanceList');
    if (!container) return;

    if (Object.keys(schoolData).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 2rem;">No school data available</div>';
        return;
    }

    container.innerHTML = '';
    const schools = Object.entries(schoolData)
        .sort((a, b) => (b[1].avg_score || 0) - (a[1].avg_score || 0))
        .slice(0, 10);

    schools.forEach(([schoolName, data]) => {
        const completionRate = data.total_tasks > 0 ? (data.completed_tasks / data.total_tasks * 100) : 0;
        
        const item = document.createElement('div');
        item.className = 'school-performance-item';
        item.innerHTML = `
            <div class="school-info">
                <h4>${schoolName}</h4>
                <div class="school-stats">${data.total_tasks} tasks ‚Ä¢ ${Math.round(completionRate)}% completion rate</div>
            </div>
            <div class="school-score">${Math.round(data.avg_score || 0)}%</div>
        `;
        container.appendChild(item);
    });
}

// Update top performers with safe element access
function updateTopPerformers(performers) {
    const container = safeGetElement('topPerformersList');
    if (!container) return;

    if (!performers || performers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 2rem;">No performance data available</div>';
        return;
    }

    container.innerHTML = '';
    performers.slice(0, 10).forEach((performer, index) => {
        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
        
        const item = document.createElement('div');
        item.className = 'top-performer-item';
        item.innerHTML = `
            <div class="performer-rank ${rankClass}">${index + 1}</div>
            <div class="performer-info">
                <div class="performer-name">${performer.name || 'Unknown'}</div>
                <div class="performer-details">Grade ${performer.grade || 'N/A'} ‚Ä¢ ${performer.school || 'Unknown School'} ‚Ä¢ ${performer.completed_tasks || 0}/${performer.total_tasks || 0} tasks</div>
            </div>
            <div class="performer-score">${Math.round(performer.avg_score || 0)}%</div>
        `;
        container.appendChild(item);
    });
}

// Update recent submissions with safe element access
function updateRecentSubmissions(submissions) {
    const tbody = safeGetElement('recentSubmissionsBody');
    if (!tbody) return;

    if (!submissions || submissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray-500); padding: 2rem;">No submissions available</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    submissions.slice(0, 20).forEach(submission => {
        const completionData = submission.completion_data || {};
        const score = completionData.score || 0;
        const maxScore = completionData.max_score || 100;
        const scorePercentage = maxScore > 0 ? (score / maxScore * 100) : 0;
        
        let scoreClass = 'poor';
        if (scorePercentage >= 90) scoreClass = 'excellent';
        else if (scorePercentage >= 70) scoreClass = 'good';
        else if (scorePercentage >= 50) scoreClass = 'fair';

        const timeSpent = completionData.time_spent || 0;
        const timeDisplay = timeSpent > 0 ? `${Math.floor(timeSpent / 60)}m ${timeSpent % 60}s` : 'N/A';
        
        const completedDate = submission.completed_at ? 
            new Date(submission.completed_at).toLocaleDateString() : 'N/A';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="student-info">
                    <div class="student-name">${submission.student_name || 'Unknown'}</div>
                    <div class="student-grade">Grade ${submission.student_grade || 'N/A'} ‚Ä¢ ${submission.school_name || 'Unknown School'}</div>
                </div>
            </td>
            <td>
                <div class="task-info">
                    <div class="task-title">${submission.task_title || 'Unknown Task'}</div>
                    <div class="task-type">${(submission.task_type || 'unknown').replace('_', ' ')}</div>
                </div>
            </td>
            <td>
                <span class="status-badge status-${submission.status || 'unknown'}">
                    ${(submission.task_type || 'unknown').replace('_', ' ')}
                </span>
            </td>
            <td>
                <div class="score-display">
                    <span class="score-percentage ${scoreClass}">${Math.round(scorePercentage)}%</span>
                    <span class="score-points">${score}/${maxScore}</span>
                </div>
            </td>
            <td>
                <span class="time-spent">${timeDisplay}</span>
            </td>
            <td>${completedDate}</td>
            <td>
                <div class="rewards-info">
                    <div class="points-reward">üèÜ ${submission.points_reward || 0} pts</div>
                    <div class="acard-reward">üí≥ $${(submission.acard_credit || 0).toFixed(2)}</div>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update time analysis with safe element access
function updateTimeAnalysis(timeData) {
    const container = safeGetElement('timeAnalysisContent');
    if (!container) return;
    
    // Create metrics grid
    const metricsGrid = document.createElement('div');
    metricsGrid.className = 'time-metric-grid';
    
    // Average time by type
    const avgTimeByType = timeData.avg_time_by_type || {};
    const avgTimes = Object.values(avgTimeByType);
    const overallAvg = avgTimes.length > 0 ? avgTimes.reduce((a, b) => a + b, 0) / avgTimes.length : 0;
    
    metricsGrid.innerHTML = `
        <div class="time-metric-card">
            <div class="time-metric-value">${Math.round(overallAvg / 60)}m</div>
            <div class="time-metric-label">Overall Average</div>
        </div>
        <div class="time-metric-card">
            <div class="time-metric-value">${Object.keys(avgTimeByType).length}</div>
            <div class="time-metric-label">Task Types</div>
        </div>
        <div class="time-metric-card">
            <div class="time-metric-value">${(timeData.fastest_completions || []).length}</div>
            <div class="time-metric-label">Fast Completions</div>
        </div>
        <div class="time-metric-card">
            <div class="time-metric-value">${(timeData.longest_completions || []).length}</div>
            <div class="time-metric-label">Long Completions</div>
        </div>
    `;
    
    // Create time lists
    const timeLists = document.createElement('div');
    timeLists.className = 'time-lists';
    
    // Fastest completions
    const fastestList = document.createElement('div');
    fastestList.className = 'time-list';
    fastestList.innerHTML = '<h4>‚ö° Fastest Completions</h4>';
    
    (timeData.fastest_completions || []).slice(0, 5).forEach(completion => {
        const item = document.createElement('div');
        item.className = 'time-list-item';
        item.innerHTML = `
            <div class="time-item-info">
                <div class="time-item-task">${completion.task_title || 'Unknown Task'}</div>
                <div class="time-item-student">${completion.student_name || 'Unknown Student'}</div>
            </div>
            <div class="time-item-duration">${Math.floor((completion.time_spent || 0) / 60)}m ${(completion.time_spent || 0) % 60}s</div>
        `;
        fastestList.appendChild(item);
    });
    
    // Longest completions
    const longestList = document.createElement('div');
    longestList.className = 'time-list';
    longestList.innerHTML = '<h4>üêå Longest Completions</h4>';
    
    (timeData.longest_completions || []).slice(0, 5).forEach(completion => {
        const item = document.createElement('div');
        item.className = 'time-list-item';
        item.innerHTML = `
            <div class="time-item-info">
                <div class="time-item-task">${completion.task_title || 'Unknown Task'}</div>
                <div class="time-item-student">${completion.student_name || 'Unknown Student'}</div>
            </div>
            <div class="time-item-duration">${Math.floor((completion.time_spent || 0) / 60)}m ${(completion.time_spent || 0) % 60}s</div>
        `;
        longestList.appendChild(item);
    });
    
    timeLists.appendChild(fastestList);
    timeLists.appendChild(longestList);
    
    container.innerHTML = '';
    container.appendChild(metricsGrid);
    container.appendChild(timeLists);
}

// Initialize analytics charts with safe element access
function initializeAnalyticsCharts() {
    if (!analyticsData) return;

    // Destroy existing charts
    Object.values(analyticsCharts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    analyticsCharts = {};

    // Grade Performance Chart
    const gradeCtx = safeGetElement('gradePerformanceChart')?.getContext('2d');
    if (gradeCtx && analyticsData.grade_performance) {
        const gradeData = analyticsData.grade_performance;
        const grades = Object.keys(gradeData).sort();
        const scores = grades.map(grade => Math.round(gradeData[grade].avg_score || 0));
        
        analyticsCharts.gradeChart = new Chart(gradeCtx, {
            type: 'bar',
            data: {
                labels: grades.map(g => `Grade ${g}`),
                datasets: [{
                    label: 'Average Score (%)',
                    data: scores,
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Completion Trends Chart
    const trendsCtx = safeGetElement('completionTrendsChart')?.getContext('2d');
    if (
        trendsCtx && analyticsData.completion_trends) {
        const trends = analyticsData.completion_trends;
        const dates = trends.map(trend => new Date(trend.date).toLocaleDateString());
        const completions = trends.map(trend => trend.completed_tasks || 0);
        
        analyticsCharts.trendsChart = new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Completed Tasks',
                    data: completions,
                    borderColor: 'rgba(16, 185, 129, 1)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Score Distribution Chart
    const scoreCtx = safeGetElement('scoreDistributionChart')?.getContext('2d');
    if (scoreCtx && analyticsData.score_distribution) {
        const distribution = analyticsData.score_distribution;
        
        analyticsCharts.scoreChart = new Chart(scoreCtx, {
            type: 'doughnut',
            data: {
                labels: ['Excellent (90-100%)', 'Good (70-89%)', 'Fair (50-69%)', 'Needs Improvement (<50%)'],
                datasets: [{
                    data: [
                        distribution.excellent || 0,
                        distribution.good || 0,
                        distribution.fair || 0,
                        distribution.needs_improvement || 0
                    ],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

// Export submissions data with safe checking
function exportSubmissions() {
    if (!analyticsData || !analyticsData.recent_submissions) {
        showNotification('No data available for export', 'error');
        return;
    }

    const submissions = analyticsData.recent_submissions;
    
    // Convert to CSV
    const headers = ['Student Name', 'Grade', 'School', 'Task Title', 'Task Type', 'Score', 'Time Spent', 'Completed Date', 'Points', 'A-Card Credit'];
    const csvContent = [
        headers.join(','),
        ...submissions.map(sub => {
            const completionData = sub.completion_data || {};
            const score = completionData.score || 0;
            const maxScore = completionData.max_score || 100;
            const scorePercentage = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
            const timeSpent = completionData.time_spent || 0;
            const timeDisplay = timeSpent > 0 ? `${Math.floor(timeSpent / 60)}m ${timeSpent % 60}s` : 'N/A';
            const completedDate = sub.completed_at ? new Date(sub.completed_at).toLocaleDateString() : 'N/A';
            
            return [
                `"${sub.student_name || 'Unknown'}"`,
                `"${sub.student_grade || 'N/A'}"`,
                `"${sub.school_name || 'Unknown'}"`,
                `"${sub.task_title || 'Unknown'}"`,
                `"${(sub.task_type || 'unknown').replace('_', ' ')}"`,
                `"${scorePercentage}% (${score}/${maxScore})"`,
                `"${timeDisplay}"`,
                `"${completedDate}"`,
                sub.points_reward || 0,
                (sub.acard_credit || 0).toFixed(2)
            ].join(',');
        })
    ].join('\n');

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `task_submissions_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showNotification('Submissions data exported successfully!', 'success');
}

// Set up analytics event listeners with safe element access
function setupAnalyticsEventListeners() {
    // Apply filters button
    const applyFiltersBtn = safeGetElement('applyFiltersBtn');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', loadAnalytics);
    }

    // Export submissions button
    const exportBtn = safeGetElement('exportSubmissionsBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportSubmissions);
    }

    // Auto-load schools for filter
    loadSchoolsForFilter();
}

async function loadWithdrawals() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/withdrawals?per_page=50', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            withdrawalsData = data.withdrawals; // Store in global variable
            renderWithdrawalsTable(withdrawalsData);
            updateWithdrawalBadge(withdrawalsData);
        } else {
            throw new Error('Failed to load withdrawals');
        }
    } catch (error) {
        console.error('Error loading withdrawals:', error);
        showNotification('Failed to load withdrawal requests', 'error');
    } finally {
        hideLoading();
    }
}

function renderWithdrawalsTable(withdrawals) {
    const tbody = document.getElementById('withdrawalsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    withdrawals.forEach(withdrawal => {
        const row = document.createElement('tr');
        const statusClass = withdrawal.status === 'pending' ? 'status-pending' : 
                           withdrawal.status === 'approved' ? 'status-active' : 'status-inactive';
        
        let detailsHtml = '';
        if (withdrawal.type === 'cash') {
            detailsHtml = `
                <div>
                    <strong>Location:</strong> ${withdrawal.location}<br>
                    <strong>Bank:</strong> ${withdrawal.bank_details?.bankName || withdrawal.bank_details?.bank_name || 'N/A'}
                </div>
            `;
        } else if (withdrawal.type === 'gift') {
            detailsHtml = `
                <div>
                    <strong>Gift:</strong> ${withdrawal.gift_name}<br>
                    <strong>Phone:</strong> ${withdrawal.phone_number}
                </div>
            `;
        }
        
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${withdrawal.student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">
                        Grade ${withdrawal.student.grade_level} ‚Ä¢ ${withdrawal.student.school_name}
                    </div>
                </div>
            </td>
            <td>
                <span style="text-transform: capitalize; font-weight: 600;">
                    ${withdrawal.type}
                </span>
            </td>
            <td>‚Ç≥${withdrawal.amount.toFixed(2)}</td>
            <td>${detailsHtml}</td>
            <td>
                <span class="status-badge ${statusClass}">
                    ${withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1)}
                </span>
            </td>
            <td>${new Date(withdrawal.created_at).toLocaleDateString()}</td>
            <td>
                <div class="task-actions">
                    <button class="task-action-btn view" onclick="viewWithdrawal(${withdrawal.id})">
                        üëÅÔ∏è View
                    </button>
                    ${withdrawal.status === 'pending' && isSuperAdmin ? `
                        <button class="task-action-btn complete" onclick="approveWithdrawal(${withdrawal.id})">
                            ‚úÖ Approve
                        </button>
                        <button class="task-action-btn delete" onclick="rejectWithdrawal(${withdrawal.id})">
                            ‚ùå Reject
                        </button>
                    ` : ''}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateWithdrawalBadge(withdrawals) {
    const pendingCount = withdrawals.filter(w => w.status === 'pending').length;
    const badge = document.getElementById('withdrawalCountBadge');
    
    if (badge) {
        if (pendingCount > 0) {
            badge.textContent = pendingCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
}

function viewWithdrawal(withdrawalId) {
    // Find withdrawal data
    const withdrawal = withdrawalsData.find(w => w.id === withdrawalId);
    if (!withdrawal) return;
    
    let detailsHtml = `
        <div style="margin-bottom: 2rem;">
            <h4>Withdrawal Request #${withdrawal.id}</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                <div>
                    <p><strong>Student:</strong> ${withdrawal.student.name}</p>
                    <p><strong>Type:</strong> ${withdrawal.type}</p>
                    <p><strong>Amount:</strong> ‚Ç≥${withdrawal.amount.toFixed(2)}</p>
                    <p><strong>Status:</strong> ${withdrawal.status}</p>
                    <p><strong>Requested:</strong> ${new Date(withdrawal.created_at).toLocaleDateString()}</p>
                </div>
                <div>
                    <p><strong>School:</strong> ${withdrawal.student.school_name}</p>
                    <p><strong>Grade:</strong> ${withdrawal.student.grade_level}</p>
                    <p><strong>Email:</strong> ${withdrawal.student.email}</p>
                    ${withdrawal.approved_at ? `<p><strong>Approved:</strong> ${new Date(withdrawal.approved_at).toLocaleDateString()}</p>` : ''}
                </div>
            </div>
        </div>
    `;
    
    if (withdrawal.type === 'cash') {
        detailsHtml += `
            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h5>Banking Details</h5>
                <p><strong>Location:</strong> ${withdrawal.location}</p>
                <p><strong>Account Holder:</strong> ${withdrawal.bank_details?.fullName || withdrawal.bank_details?.full_name || 'N/A'}</p>
                <p><strong>Bank:</strong> ${withdrawal.bank_details?.bankName || withdrawal.bank_details?.bank_name || 'N/A'}</p>
                
                ${withdrawal.location === 'usa' ? `
                    <p><strong>Account Number:</strong> ${withdrawal.bank_details?.accountNumber || 'N/A'}</p>
                    <p><strong>Routing Number:</strong> ${withdrawal.bank_details?.routingNumber || 'N/A'}</p>
                    <p><strong>Account Type:</strong> ${withdrawal.bank_details?.accountType || 'N/A'}</p>
                ` : ''}
                
                ${withdrawal.location === 'uk' ? `
                    <p><strong>Sort Code:</strong> ${withdrawal.bank_details?.sortCode || 'N/A'}</p>
                    <p><strong>Account Number:</strong> ${withdrawal.bank_details?.accountNumber || 'N/A'}</p>
                ` : ''}
                
                ${withdrawal.location === 'nigeria' ? `
                    <p><strong>Account Number:</strong> ${withdrawal.bank_details?.accountNumber || 'N/A'}</p>
                ` : ''}
            </div>
        `;
    } else if (withdrawal.type === 'gift') {
        detailsHtml += `
            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h5>Gift Details</h5>
                <p><strong>Gift Item:</strong> ${withdrawal.gift_name}</p>
                <p><strong>Phone Number:</strong> ${withdrawal.phone_number}</p>
                <p><strong>Delivery Address:</strong></p>
                <div style="background: white; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                    ${withdrawal.delivery_address}
                </div>
                ${withdrawal.special_instructions ? `
                    <p style="margin-top: 1rem;"><strong>Special Instructions:</strong></p>
                    <div style="background: white; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                        ${withdrawal.special_instructions}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    if (withdrawal.admin_notes) {
        detailsHtml += `
            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h5>Admin Notes</h5>
                <p>${withdrawal.admin_notes}</p>
            </div>
        `;
    }
    
    document.getElementById('taskModalBody').innerHTML = detailsHtml;
    
    // Hide complete button for withdrawal modal
    document.getElementById('completeTaskBtn').style.display = 'none';
    
    openModal('taskModal');
}

async function approveWithdrawal(withdrawalId) {
    const notes = prompt('Enter approval notes (optional):') || '';
    
    if (!confirm('Are you sure you want to approve this withdrawal request?')) {
        return;
    }
    
    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/withdrawal/${withdrawalId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify({ admin_notes: notes })
        });

        if (response.ok) {
            showNotification('Withdrawal request approved successfully!');
            loadWithdrawals(); // Refresh table
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to approve withdrawal');
        }
    } catch (error) {
        console.error('Error approving withdrawal:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function rejectWithdrawal(withdrawalId) {
    const reason = prompt('Enter rejection reason:');
    
    if (!reason || reason.trim() === '') {
        alert('Please provide a reason for rejection');
        return;
    }
    
    if (!confirm('Are you sure you want to reject this withdrawal request? The amount will be refunded to the student.')) {
        return;
    }
    
    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/withdrawal/${withdrawalId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify({ admin_notes: reason })
        });

        if (response.ok) {
            showNotification('Withdrawal request rejected and amount refunded to student');
            loadWithdrawals(); // Refresh table
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to reject withdrawal');
        }
    } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Update your existing loadPageData function to include withdrawals
const originalLoadPageData = loadPageData;
loadPageData = function(page) {
    originalLoadPageData(page);
    
    if (page === 'withdrawals') {
        loadWithdrawals();
    }
};

// Add withdrawal badge styles
const withdrawalBadgeStyles = `
    .withdrawal-count-badge {
        background: var(--red-500);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-left: 0.5rem;
        position: absolute;
        top: -8px;
        right: -8px;
    }
    
    .nav-item {
        position: relative;
    }
`;

// Add the styles to the document
const withdrawalStyleSheet = document.createElement('style');
withdrawalStyleSheet.textContent = withdrawalBadgeStyles;
document.head.appendChild(withdrawalStyleSheet);

// Update dashboard stats to include withdrawal information
const originalUpdateDashboardStats = updateDashboardStats;
updateDashboardStats = function(stats) {
    originalUpdateDashboardStats(stats);
    
    // Update withdrawal badge if stats include pending withdrawals
    if (stats.pending_withdrawals !== undefined) {
        updateWithdrawalBadge([{ status: 'pending' }].repeat(stats.pending_withdrawals));
    }
};

// Auto-refresh withdrawals every 2 minutes for admins
if (typeof getAdminToken === 'function' && getAdminToken()) {
    setInterval(() => {
        const activePage = document.querySelector('.nav-item.active');
        if (activePage && activePage.getAttribute('data-page') === 'withdrawals') {
            loadWithdrawals();
        }
    }, 2 * 60 * 1000);
}

// Load schools for filter dropdown with safe element access
async function loadSchoolsForFilter() {
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/students?per_page=1000', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const schools = [...new Set(data.students.map(s => s.school_name).filter(Boolean))];
            
            const schoolFilter = safeGetElement('schoolFilter');
            if (schoolFilter) {
                schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school;
                    option.textContent = school;
                    schoolFilter.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading schools for filter:', error);
    }
}

// External Link Feature Functions
function initializeExternalLinkFeature() {
    // Find the task file input section in the assign task form
    const taskFileGroup = document.querySelector('#assign-task-page .form-group:has(#taskFile)');
    
    if (!taskFileGroup) {
        console.error('Task file input not found');
        return;
    }

    // Replace the existing task file section with the new link selector
    taskFileGroup.innerHTML = `
        <label class="form-label">Task Link</label>
        <div class="link-type-selector">
            <div class="link-type-description">
                Choose how students will access this task. You can use internal Deciph.AI files or assign external links to any website.
            </div>
            
            <div class="link-type-tabs">
                <button type="button" class="link-type-tab active" data-type="internal">
                    üìÅ Internal File
                </button>
                <button type="button" class="link-type-tab" data-type="external">
                    üîó External Link
                </button>
                <button type="button" class="link-type-tab" data-type="common">
                    ‚≠ê Common Links
                </button>
            </div>

            <!-- Internal File Option -->
            <div class="link-option active" id="internal-option">
                <input type="text" class="form-input" id="taskFile" placeholder="e.g., fractions, algebra, essay-writing">
                <div class="task-file-section">
                    <div class="task-file-info">
                        üí° <strong>Internal File Usage:</strong> Enter a specific topic/file name for Deciph.AI tasks.
                    </div>
                    <div class="task-file-info">
                        Example: If you enter "fractions", students will be redirected to:
                        <code>https://deciph.ai.deciphersacad.online/fractions</code>
                    </div>
                </div>
            </div>

            <!-- External Link Option -->
            <div class="link-option" id="external-option">
                <input type="url" class="form-input" id="externalTaskUrl" placeholder="https://example.com/your-task-link">
                <div class="url-validator" id="urlValidator">
                    <span>üí° Enter any valid URL (must start with http:// or https://)</span>
                </div>
                <div class="external-link-preview" id="externalLinkPreview">
                    <div class="preview-header">
                        üîó External Task Preview
                    </div>
                    <div class="preview-url" id="previewUrl"></div>
                </div>
            </div>

            <!-- Common Links Option -->
            <div class="link-option" id="common-option">
                <div class="common-links-grid" id="commonLinksGrid">
                    <!-- Common links will be populated here -->
                </div>
                <div style="margin-top: 1rem;">
                    <input type="url" class="form-input" id="customCommonUrl" placeholder="Or enter a custom URL..." style="margin-top: 0.5rem;">
                </div>
            </div>
        </div>
    `;

    // Initialize common links
    initializeCommonLinks();

    // Set up event listeners
    setupLinkTypeEventListeners();
}

// Set up event listeners for the link type selector
function setupLinkTypeEventListeners() {
    // Tab switching
    document.querySelectorAll('.link-type-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            switchLinkType(type);
        });
    });

    // External URL validation
    const externalUrlInput = document.getElementById('externalTaskUrl');
    if (externalUrlInput) {
        externalUrlInput.addEventListener('input', validateExternalUrl);
    }

    // Custom common URL input
    const customCommonInput = document.getElementById('customCommonUrl');
    if (customCommonInput) {
        customCommonInput.addEventListener('input', function() {
            // Clear selected common links when typing custom URL
            document.querySelectorAll('.common-link-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
        });
    }
}

// Switch between link types
function switchLinkType(type) {
    // Update tabs
    document.querySelectorAll('.link-type-tab').forEach(tab => {
        tab.classList.toggle('active', tab.getAttribute('data-type') === type);
    });

    // Update options
    document.querySelectorAll('.link-option').forEach(option => {
        option.classList.remove('active');
    });
    
    const activeOption = document.getElementById(`${type}-option`);
    if (activeOption) {
        activeOption.classList.add('active');
    }

    // Clear other inputs when switching
    if (type !== 'internal') {
        const taskFileInput = document.getElementById('taskFile');
        if (taskFileInput) taskFileInput.value = '';
    }
    if (type !== 'external') {
        const externalUrlInput = document.getElementById('externalTaskUrl');
        if (externalUrlInput) {
            externalUrlInput.value = '';
            const preview = document.getElementById('externalLinkPreview');
            if (preview) preview.classList.remove('show');
        }
    }
    if (type !== 'common') {
        const customCommonInput = document.getElementById('customCommonUrl');
        if (customCommonInput) customCommonInput.value = '';
        document.querySelectorAll('.common-link-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
    }
}

// Validate external URL
function validateExternalUrl() {
    const input = document.getElementById('externalTaskUrl');
    const validator = document.getElementById('urlValidator');
    const preview = document.getElementById('externalLinkPreview');
    const previewUrl = document.getElementById('previewUrl');
    
    const url = input.value.trim();
    
    if (!url) {
        validator.className = 'url-validator empty';
        validator.innerHTML = '<span>üí° Enter any valid URL (must start with http:// or https://)</span>';
        preview.classList.remove('show');
        return;
    }

    try {
        const urlObj = new URL(url);
        if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
            validator.className = 'url-validator valid';
            validator.innerHTML = '<span>‚úÖ Valid URL</span>';
            previewUrl.textContent = url;
            preview.classList.add('show');
        } else {
            throw new Error('Invalid protocol');
        }
    } catch (error) {
        validator.className = 'url-validator invalid';
        validator.innerHTML = '<span>‚ùå Please enter a valid URL starting with http:// or https://</span>';
        preview.classList.remove('show');
    }
}

// Initialize common links
function initializeCommonLinks() {
    const commonLinks = [
        {
            name: 'Khan Academy Math',
            url: 'https://www.khanacademy.org/math',
            description: 'Math lessons and exercises'
        },
        {
            name: 'Coursera',
            url: 'https://www.coursera.org',
            description: 'Online courses'
        },
        {
            name: 'edX',
            url: 'https://www.edx.org',
            description: 'University-level courses'
        },
        {
            name: 'Duolingo',
            url: 'https://www.duolingo.com',
            description: 'Language learning'
        },
        {
            name: 'Code.org',
            url: 'https://code.org/learn',
            description: 'Learn to code'
        },
        {
            name: 'TED-Ed',
            url: 'https://ed.ted.com',
            description: 'Educational videos'
        },
        {
            name: 'NASA Education',
            url: 'https://www.nasa.gov/audience/foreducators/',
            description: 'Space and science education'
        },
        {
            name: 'National Geographic Kids',
            url: 'https://kids.nationalgeographic.com',
            description: 'Geography and nature'
        }
    ];

    const grid = document.getElementById('commonLinksGrid');
    if (!grid) return;

    grid.innerHTML = '';
    
    commonLinks.forEach(link => {
        const linkBtn = document.createElement('div');
        linkBtn.className = 'common-link-btn';
        linkBtn.innerHTML = `
            <div class="common-link-name">${link.name}</div>
            <div class="common-link-url">${link.url}</div>
        `;
        
        linkBtn.addEventListener('click', function() {
            // Toggle selection
            const wasSelected = this.classList.contains('selected');
            
            // Clear all selections
            document.querySelectorAll('.common-link-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Clear custom URL
            const customInput = document.getElementById('customCommonUrl');
            if (customInput) customInput.value = '';
            
            // Select this one if it wasn't selected
            if (!wasSelected) {
                this.classList.add('selected');
            }
        });
        
        grid.appendChild(linkBtn);
    });
}

function getCurrentTaskLinkConfig() {
    const activeTab = document.querySelector('.link-type-tab.active');
    if (!activeTab) return null;

    const type = activeTab.getAttribute('data-type');
    let config = { type: type };

    switch (type) {
        case 'internal':
            const taskFile = document.getElementById('taskFile')?.value.trim();
            if (taskFile) {
                config.task_file = taskFile;
                config.external_url = `https://deciph.ai.deciphersacad.online/${taskFile}`;
            }
            break;

        case 'external':
            const externalUrl = document.getElementById('externalTaskUrl')?.value.trim();
            if (externalUrl) {
                try {
                    new URL(externalUrl); // Validate URL
                    config.external_url = externalUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;

        case 'common':
            const selectedCommonLink = document.querySelector('.common-link-btn.selected');
            const customCommonUrl = document.getElementById('customCommonUrl')?.value.trim();
            
            if (selectedCommonLink) {
                const url = selectedCommonLink.querySelector('.common-link-url').textContent;
                config.external_url = url;
            } else if (customCommonUrl) {
                try {
                    new URL(customCommonUrl); // Validate URL
                    config.external_url = customCommonUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;
    }

    return config;
}

// Reset form function to clear link configurations
const originalResetForm = function() {
    document.getElementById('assignTaskForm').reset();
    switchLinkType('internal');
    document.getElementById('weeklyTaskSection').classList.remove('active');
    document.getElementById('singleTaskSection').style.display = 'block';
    document.getElementById('weekStartSection').style.display = 'none';
};

// Validation helper for task assignment
function validateTaskAssignment() {
    const linkConfig = getCurrentTaskLinkConfig();
    
    if (!linkConfig) {
        showNotification('Please configure a valid task link', 'error');
        return false;
    }

    // Additional validation based on type
    if (linkConfig.type === 'external' && !linkConfig.external_url) {
        showNotification('Please enter a valid external URL', 'error');
        return false;
    }

    if (linkConfig.type === 'common' && !linkConfig.external_url) {
        showNotification('Please select a common link or enter a custom URL', 'error');
        return false;
    }

    return true;
}

// Utility Functions
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function showLoading() {
    document.getElementById('loading').classList.add('show');
}

function hideLoading() {
    document.getElementById('loading').classList.remove('show');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    notificationText.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        // Clear admin data
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        sessionStorage.removeItem('admin_token');
        sessionStorage.setItem('admin_just_logged_out', 'true');
        
        // Clear cookies
        document.cookie = 'admin_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        
        // Redirect to login
        window.location.href = '/super-login';
    }
}

// Modal close handlers
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
    }
});

// Keyboard support for modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

// Auto-refresh dashboard every 5 minutes
setInterval(() => {
    if (document.querySelector('.nav-item.active').getAttribute('data-page') === 'dashboard') {
        loadDashboardData();
    }
}, 5 * 60 * 1000);

// Auto-refresh analytics every 5 minutes when on analytics page
setInterval(() => {
    const activePage = document.querySelector('.nav-item.active');
    if (activePage && activePage.getAttribute('data-page') === 'analytics') {
        loadAnalytics();
    }
}, 5 * 60 * 1000);

// Additional styles for circle controls
const circleControlsStyles = `
    .circle-controls {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .school-circle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .school-info {
        flex: 1;
    }

    .school-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .school-stats {
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .circle-toggle {
        background: var(--red-500);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .circle-toggle.unlocked {
        background: var(--green-500);
    }

    .circle-toggle:hover {
        opacity: 0.9;
    }
`;

// Add the styles to the document
const styleSheet = document.createElement('style');
styleSheet.textContent = circleControlsStyles;
document.head.appendChild(styleSheet);

// Test function for weekly task dates
function testWeeklyTaskDates() {
    console.log('üß™ TESTING WEEKLY TASK DATE CALCULATIONS');
    console.log('=========================================');
    
    // Test with this week
    const testWeekStart = new Date('2025-08-04'); // Monday Aug 4, 2025
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
    
    console.log('Test week start (should be Monday):', testWeekStart.toDateString());
    console.log('Day of week:', testWeekStart.getDay()); // Should be 1 for Monday
    
    days.forEach((day, index) => {
        const taskDate = new Date(testWeekStart);
        taskDate.setDate(testWeekStart.getDate() + index);
        
        const calculatedDayName = taskDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        const isCorrect = calculatedDayName === day;
        
        console.log(`${day}:`, {
            calculated_date: taskDate.toDateString(),
            calculated_day: calculatedDayName,
            correct: isCorrect ? '‚úÖ' : '‚ùå'
        });
    });
}

// Date verification function
function verifyTaskDate(intendedDay, calculatedDate) {
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const calculatedDayIndex = calculatedDate.getDay();
    const calculatedDayName = dayNames[calculatedDayIndex];
    
    console.log('üìÖ Date Verification:', {
        intended: intendedDay,
        calculated: calculatedDayName,
        date: calculatedDate.toDateString(),
        matches: calculatedDayName === intendedDay.toLowerCase()
    });
    
    return calculatedDayName === intendedDay.toLowerCase();
}

// Function to get the next occurrence of a specific weekday
function getNextWeekdayDate(startDate, targetDay) {
    const dayMap = {
        'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 0
    };
    
    const targetDayIndex = dayMap[targetDay.toLowerCase()];
    const startDayIndex = startDate.getDay();
    
    let daysToAdd = targetDayIndex - startDayIndex;
    if (daysToAdd < 0) daysToAdd += 7; // Next week
    
    const resultDate = new Date(startDate);
    resultDate.setDate(startDate.getDate() + daysToAdd);
    
    return resultDate;
}

// Expose functions for testing and integration
window.externalLinkFeature = {
    initializeExternalLinkFeature,
    getCurrentTaskLinkConfig,
    validateTaskAssignment,
    switchLinkType
};

console.log('Complete integrated admin dashboard loaded successfully!');
console.log('üìã Task assignment functions updated. Run testWeeklyTaskDates() to verify calculations.');
console.log('External link assignment feature loaded successfully!');

// Add these functions to your existing admin dashboard script

// Edit task function
async function editTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    // Populate edit modal with existing data
    const taskData = task.task_data || {};
    
    document.getElementById('editTaskId').value = task.id;
    document.getElementById('editTaskTitle').value = task.task_title || task.title;
    document.getElementById('editTaskDescription').value = task.task_description || task.description;
    document.getElementById('editPointsReward').value = task.points_reward || 0;
    document.getElementById('editAcardCredit').value = task.acard_credit || 0;
    
    // Set due date
    if (task.due_date) {
        const dueDate = new Date(task.due_date);
        const localDateTime = new Date(dueDate.getTime() - dueDate.getTimezoneOffset() * 60000);
        document.getElementById('editDueDate').value = localDateTime.toISOString().slice(0, 16);
    } else {
        document.getElementById('editDueDate').value = '';
    }
    
    // Set link configuration
    const linkType = taskData.link_type || 'internal';
    document.getElementById('editTaskLinkType').value = linkType;
    toggleEditLinkType(linkType);
    
    if (linkType === 'internal' && taskData.task_file) {
        document.getElementById('editTaskFile').value = taskData.task_file;
    } else if (taskData.external_url) {
        document.getElementById('editExternalLink').value = taskData.external_url;
    }
    
    openModal('editTaskModal');
}

// Toggle edit link type
function toggleEditLinkType(type) {
    document.getElementById('editInternalSection').style.display = type === 'internal' ? 'block' : 'none';
    document.getElementById('editExternalSection').style.display = type === 'external' ? 'block' : 'none';
    
    // Clear fields when switching
    if (type !== 'internal') document.getElementById('editTaskFile').value = '';
    if (type !== 'external') document.getElementById('editExternalLink').value = '';
}

// Handle edit task form submission
async function handleEditTask(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('editTaskId').value;
    const linkType = document.getElementById('editTaskLinkType').value;
    
    // Build link configuration
    const linkConfig = { type: linkType };
    
    if (linkType === 'internal') {
        const taskFile = document.getElementById('editTaskFile').value.trim();
        if (taskFile) {
            linkConfig.task_file = taskFile;
            linkConfig.external_url = `https://deciph.ai.deciphersacad.online/${taskFile}`;
        }
    } else if (linkType === 'external') {
        const externalUrl = document.getElementById('editExternalLink').value.trim();
        if (externalUrl) {
            linkConfig.external_url = externalUrl;
        }
    }
    
    const updateData = {
        task_title: document.getElementById('editTaskTitle').value,
        task_description: document.getElementById('editTaskDescription').value,
        points_reward: parseInt(document.getElementById('editPointsReward').value) || 0,
        acard_credit: parseFloat(document.getElementById('editAcardCredit').value) || 0,
        due_date: document.getElementById('editDueDate').value || null,
        task_data: {
            link_config: linkConfig
        }
    };

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/task/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification('Task updated successfully!');
            closeModal('editTaskModal');
            loadTasks(); // Refresh tasks table
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update task');
        }
    } catch (error) {
        console.error('Error updating task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Delete task function
async function deleteTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    const confirmMessage = `Are you sure you want to delete the task "${task.task_title || task.title}"?\n\nThis action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/task/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(result.message);
            loadTasks(); // Refresh tasks table
            loadDashboardData(); // Refresh dashboard stats
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete task');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Add event listener for edit task link type change
document.addEventListener('DOMContentLoaded', function() {
    const editLinkTypeSelect = document.getElementById('editTaskLinkType');
    if (editLinkTypeSelect) {
        editLinkTypeSelect.addEventListener('change', function() {
            toggleEditLinkType(this.value);
        });
    }
    
    // Add event listener for edit task form
    const editTaskForm = document.getElementById('editTaskForm');
    if (editTaskForm) {
        editTaskForm.addEventListener('submit', handleEditTask);
    }
});

// Resource Management Functions


function setupResourceManagementEventListeners() {
    // Apply resource filters button
    const applyResourceFilters = document.getElementById('applyResourceFilters');
    if (applyResourceFilters) {
        applyResourceFilters.addEventListener('click', loadAdminResources);
    }

    // Refresh resources button
    const refreshResources = document.getElementById('refreshResources');
    if (refreshResources) {
        refreshResources.addEventListener('click', loadAdminResources);
    }

    // Resource search
    const resourcesSearch = document.getElementById('resourcesSearch');
    if (resourcesSearch) {
        resourcesSearch.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = allResources.filter(resource => 
                resource.resource_title.toLowerCase().includes(query) ||
                resource.admin_name.toLowerCase().includes(query) ||
                resource.subject_category.toLowerCase().includes(query)
            );
            renderResourcesTable(filtered);
        });
    }

    // Edit resource form
    const editResourceForm = document.getElementById('editResourceForm');
    if (editResourceForm) {
        editResourceForm.addEventListener('submit', handleEditResource);
    }

    // Populate filter dropdowns
    populateResourceFilterDropdowns();
}

async function loadAdminResources() {
    showLoading();
    try {
        // Get filter values
        const adminFilter = document.getElementById('resourceAdminFilter')?.value || '';
        const typeFilter = document.getElementById('resourceTypeFilter')?.value || '';
        const subjectFilter = document.getElementById('resourceSubjectFilter')?.value || '';

        // Build query parameters
        const queryParams = new URLSearchParams();
        if (adminFilter) queryParams.append('admin_id', adminFilter);
        if (typeFilter) queryParams.append('resource_type', typeFilter);
        if (subjectFilter) queryParams.append('subject_category', subjectFilter);

        console.log('Loading resources with filters:', { adminFilter, typeFilter, subjectFilter });

        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/resources?${queryParams}`, {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Resources loaded:', data);
            allResources = data.resources || [];
            renderResourcesTable(allResources);
        } else {
            const errorData = await response.text();
            console.error('Error response:', errorData);
            throw new Error(`Server error: ${response.status} - ${errorData}`);
        }
    } catch (error) {
        console.error('Error loading resources:', error);
        showNotification(`Failed to load resources: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

function renderResourcesTable(resources) {
    const tbody = document.getElementById('adminResourcesTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    if (resources.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-500); padding: 2rem;">No resources found</td></tr>';
        return;
    }

    resources.forEach(resource => {
        const row = document.createElement('tr');
        
        // Format URL/File display
        let urlDisplay = '';
        if (resource.resource_type === 'internal_file' && resource.task_file) {
            urlDisplay = `<code>${resource.task_file}</code><br><small style="color: var(--gray-500);">deciph.ai.deciphersacad.online/${resource.task_file}</small>`;
        } else if (resource.resource_url) {
            const shortUrl = resource.resource_url.length > 40 ? 
                resource.resource_url.substring(0, 40) + '...' : resource.resource_url;
            urlDisplay = `<a href="${resource.resource_url}" target="_blank" style="color: var(--blue-500);">${shortUrl}</a>`;
        }

        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${resource.resource_title}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${resource.description || 'No description'}</div>
                </div>
            </td>
            <td>
                <div>
                    <div style="font-weight: 600;">${resource.admin_name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">Grade ${resource.grade_section}</div>
                </div>
            </td>
            <td>
                <span class="status-badge resource-type-${resource.resource_type}">
                    ${resource.resource_type.replace('_', ' ')}
                </span>
            </td>
            <td>
                <span style="text-transform: capitalize; font-weight: 600;">
                    ${resource.subject_category}
                </span>
            </td>
            <td>${urlDisplay}</td>
            <td>
                <span class="status-badge ${resource.is_active ? 'status-active' : 'status-inactive'}">
                    ${resource.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>${new Date(resource.created_at).toLocaleDateString()}</td>
            <td>
                <div class="admin-action-buttons">
                    <button class="admin-action-btn view" onclick="viewResource(${resource.id})">
                        üëÅÔ∏è View
                    </button>
                    <button class="admin-action-btn edit" onclick="editResource(${resource.id})">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="admin-action-btn toggle" onclick="deleteResource(${resource.id})">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function populateResourceFilterDropdowns() {
    // Populate admin filter
    const adminFilter = document.getElementById('resourceAdminFilter');
    if (adminFilter) {
        adminFilter.innerHTML = '<option value="">All Admins</option>';
        // Only populate if allAdmins is loaded
        if (allAdmins && allAdmins.length > 0) {
            allAdmins.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.id;
                option.textContent = `${admin.name} (Grade ${admin.grade_section || 'N/A'})`;
                adminFilter.appendChild(option);
            });
        }
    }
}

async function viewResource(resourceId) {
    const resource = allResources.find(r => r.id === resourceId);
    if (!resource) {
        showNotification('Resource not found', 'error');
        return;
    }

    let urlInfo = '';
    if (resource.resource_type === 'internal_file' && resource.task_file) {
        urlInfo = `
            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h5 style="color: var(--purple-500); margin-bottom: 0.5rem;">üìÅ Internal File</h5>
                <p><strong>Task File:</strong> ${resource.task_file}</p>
                <p><strong>Full URL:</strong> <a href="https://deciph.ai.deciphersacad.online/${resource.task_file}" target="_blank">https://deciph.ai.deciphersacad.online/${resource.task_file}</a></p>
            </div>
        `;
    } else if (resource.resource_url) {
        urlInfo = `
            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h5 style="color: var(--blue-500); margin-bottom: 0.5rem;">üîó External Link</h5>
                <p><strong>URL:</strong> <a href="${resource.resource_url}" target="_blank">${resource.resource_url}</a></p>
            </div>
        `;
    }

    document.getElementById('resourceViewModalBody').innerHTML = `
        <div style="margin-bottom: 2rem;">
            <h4>${resource.resource_title}</h4>
            <p style="margin: 1rem 0; color: var(--gray-600);">${resource.description || 'No description provided'}</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                <div>
                    <p><strong>Type:</strong> ${resource.resource_type.replace('_', ' ')}</p>
                    <p><strong>Subject:</strong> ${resource.subject_category}</p>
                    <p><strong>Status:</strong> ${resource.is_active ? 'Active' : 'Inactive'}</p>
                </div>
                <div>
                    <p><strong>Admin:</strong> ${resource.admin_name}</p>
                    <p><strong>Grade Section:</strong> ${resource.grade_section}</p>
                    <p><strong>Created:</strong> ${new Date(resource.created_at).toLocaleDateString()}</p>
                </div>
            </div>
            
            ${urlInfo}
            
            ${resource.created_by_name ? `
                <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p><strong>Created by:</strong> ${resource.created_by_name}</p>
                    ${resource.updated_at && resource.updated_at !== resource.created_at ? 
                        `<p><strong>Last updated:</strong> ${new Date(resource.updated_at).toLocaleDateString()}</p>` : ''
                    }
                </div>
            ` : ''}
        </div>
    `;
    
    openModal('resourceViewModal');
}

async function editResource(resourceId) {
    const resource = allResources.find(r => r.id === resourceId);
    if (!resource) {
        showNotification('Resource not found', 'error');
        return;
    }

    // Populate edit form
    document.getElementById('editResourceId').value = resource.id;
    document.getElementById('editResourceTitle').value = resource.resource_title;
    document.getElementById('editResourceType').value = resource.resource_type;
    document.getElementById('editResourceSubject').value = resource.subject_category;
    document.getElementById('editResourceDescription').value = resource.description || '';
    document.getElementById('editResourceStatus').value = resource.is_active.toString();

    // Set type-specific fields
    if (resource.resource_type === 'internal_file' && resource.task_file) {
        document.getElementById('editResourceTaskFile').value = resource.task_file;
        document.getElementById('editResourceUrl').value = '';
    } else if (resource.resource_url) {
        document.getElementById('editResourceUrl').value = resource.resource_url;
        document.getElementById('editResourceTaskFile').value = '';
    }

    // Show/hide appropriate fields
    handleEditResourceTypeChange();

    openModal('resourceEditModal');
}

function handleEditResourceTypeChange() {
    const resourceType = document.getElementById('editResourceType').value;
    const taskFileGroup = document.getElementById('editTaskFileGroup');
    const resourceUrlGroup = document.getElementById('editResourceUrlGroup');

    if (resourceType === 'internal_file') {
        taskFileGroup.style.display = 'block';
        resourceUrlGroup.style.display = 'none';
    } else {
        taskFileGroup.style.display = 'none';
        resourceUrlGroup.style.display = 'block';
    }
}

async function handleEditResource(e) {
    e.preventDefault();
    
    const resourceId = document.getElementById('editResourceId').value;
    const resourceType = document.getElementById('editResourceType').value;
    
    const updateData = {
        resource_title: document.getElementById('editResourceTitle').value,
        resource_type: resourceType,
        subject_category: document.getElementById('editResourceSubject').value,
        description: document.getElementById('editResourceDescription').value,
        is_active: document.getElementById('editResourceStatus').value === 'true'
    };

    // Add type-specific fields
    if (resourceType === 'internal_file') {
        const taskFile = document.getElementById('editResourceTaskFile').value.trim();
        if (taskFile) {
            updateData.task_file = taskFile;
            updateData.resource_url = `https://deciph.ai.deciphersacad.online/${taskFile}`;
        }
    } else {
        const resourceUrl = document.getElementById('editResourceUrl').value.trim();
        if (resourceUrl) {
            updateData.resource_url = resourceUrl;
        }
    }

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/resource/${resourceId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification('Resource updated successfully!');
            closeModal('resourceEditModal');
            loadAdminResources(); // Refresh resources table
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update resource');
        }
    } catch (error) {
        console.error('Error updating resource:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function deleteResource(resourceId) {
    const resource = allResources.find(r => r.id === resourceId);
    if (!resource) {
        showNotification('Resource not found', 'error');
        return;
    }

    const confirmMessage = `Are you sure you want to delete the resource "${resource.resource_title}"?\n\nThis will remove it from ${resource.admin_name}'s available resources.\n\nThis action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/resource/${resourceId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            showNotification('Resource deleted successfully!');
            loadAdminResources(); // Refresh resources table
            updateAdminStats(); // Update stats
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete resource');
        }
    } catch (error) {
        console.error('Error deleting resource:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// =====================================================
// SUBJECT ASSIGNMENT MANAGEMENT FOR SUPER ADMIN
// =====================================================

let allSubjects = [];
let currentSubjectMode = 'single';

// Load all subjects from backend
async function loadSubjects() {
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/subjects', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();

        if (response.ok && data.subjects) {
            allSubjects = data.subjects;
            console.log('‚úÖ Loaded ' + allSubjects.length + ' subjects for assignment');
            renderSubjectCheckboxes();
            renderBulkSubjectCheckboxes();
        } else {
            console.error('Failed to load subjects:', data);
            showNotification('Failed to load subjects: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error loading subjects:', error);
        showNotification('Failed to load subjects', 'error');
    }
}

// Render subject checkboxes for single mode
function renderSubjectCheckboxes() {
    const container = document.getElementById('subjectCheckboxGrid');
    if (!container) {
        console.error('‚ùå subjectCheckboxGrid container not found');
        return;
    }

    console.log('‚úÖ Rendering ' + allSubjects.length + ' subjects in single mode grid');
    container.innerHTML = allSubjects.map(subject => `
        <label class="subject-checkbox-item" data-subject-id="${subject.id}">
            <input type="checkbox" name="subject_ids" value="${subject.id}"
                   onchange="toggleSubjectCheckbox(this)">
            <div>
                <div style="font-weight: 600;">${subject.name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-600);">${subject.description || ''}</div>
            </div>
        </label>
    `).join('');
}

// Render subject checkboxes for bulk mode
function renderBulkSubjectCheckboxes() {
    const container = document.getElementById('bulkSubjectCheckboxGrid');
    if (!container) {
        console.error('‚ùå bulkSubjectCheckboxGrid container not found');
        return;
    }

    console.log('‚úÖ Rendering ' + allSubjects.length + ' subjects in bulk mode grid');
    container.innerHTML = allSubjects.map(subject => `
        <label class="subject-checkbox-item" data-subject-id="${subject.id}">
            <input type="checkbox" name="bulk_subject_ids" value="${subject.id}"
                   onchange="toggleSubjectCheckbox(this)">
            <div>
                <div style="font-weight: 600;">${subject.name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-600);">${subject.description || ''}</div>
            </div>
        </label>
    `).join('');
}

// Toggle subject checkbox visual state
function toggleSubjectCheckbox(checkbox) {
    const label = checkbox.closest('.subject-checkbox-item');
    if (checkbox.checked) {
        label.classList.add('checked');
    } else {
        label.classList.remove('checked');
    }
}

// Switch between single and bulk subject assignment modes
function switchSubjectMode(mode) {
    currentSubjectMode = mode;
    const singleBtn = document.getElementById('subjectSingleModeBtn');
    const bulkBtn = document.getElementById('subjectBulkModeBtn');
    const singleMode = document.getElementById('singleStudentSubjectMode');
    const bulkMode = document.getElementById('bulkStudentSubjectMode');

    if (mode === 'single') {
        singleBtn.classList.add('btn-primary');
        singleBtn.classList.remove('btn-secondary');
        bulkBtn.classList.remove('btn-primary');
        bulkBtn.classList.add('btn-secondary');
        singleMode.style.display = 'block';
        bulkMode.style.display = 'none';
        // Reset to step 1
        goToSingleSubjectStep1();
    } else {
        bulkBtn.classList.add('btn-primary');
        bulkBtn.classList.remove('btn-secondary');
        singleBtn.classList.remove('btn-primary');
        singleBtn.classList.add('btn-secondary');
        bulkMode.style.display = 'block';
        singleMode.style.display = 'none';
        loadBulkSubjectStudents();
        // Reset to step 1
        goToBulkSubjectStep1();
    }
}

// Single Student Mode - Step Navigation
function goToSingleSubjectStep2() {
    const studentSelect = document.getElementById('subjectStudentSelect');
    const selectedStudentId = studentSelect.value;

    if (!selectedStudentId) {
        showNotification('Please select a student first', 'error');
        return;
    }

    // Get selected student info
    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
    const studentInfo = selectedOption.textContent;

    // Update student info display
    document.getElementById('selectedStudentInfo').textContent = studentInfo;

    // Ensure subjects are loaded and rendered
    if (allSubjects.length === 0) {
        console.log('‚ö†Ô∏è No subjects loaded, loading now...');
        loadSubjects().then(() => {
            console.log('‚úÖ Subjects loaded, showing step 2');
            document.getElementById('singleSubjectStep1').style.display = 'none';
            document.getElementById('singleSubjectStep2').style.display = 'block';
        });
    } else {
        console.log('‚úÖ Subjects already loaded (' + allSubjects.length + '), rendering again...');
        renderSubjectCheckboxes();
        // Hide step 1, show step 2
        document.getElementById('singleSubjectStep1').style.display = 'none';
        document.getElementById('singleSubjectStep2').style.display = 'block';
    }
}

function goToSingleSubjectStep1() {
    // Show step 1, hide step 2
    document.getElementById('singleSubjectStep1').style.display = 'block';
    document.getElementById('singleSubjectStep2').style.display = 'none';
}

// Bulk Assignment Mode - Step Navigation
function goToBulkSubjectStep2() {
    const selectedCheckboxes = document.querySelectorAll('input[name="bulk_student_ids"]:checked');

    if (selectedCheckboxes.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    // Get selected students info
    const selectedCount = selectedCheckboxes.length;
    const studentNames = Array.from(selectedCheckboxes).slice(0, 5).map(cb => {
        const label = cb.closest('.student-checkbox-item');
        return label.querySelector('span').textContent;
    });

    let infoText = `${selectedCount} student(s) selected`;
    if (selectedCount <= 5) {
        infoText += ': ' + studentNames.join(', ');
    } else {
        infoText += ': ' + studentNames.join(', ') + `, and ${selectedCount - 5} more...`;
    }

    // Update students info display
    document.getElementById('selectedStudentsInfo').textContent = infoText;

    // Ensure subjects are loaded and rendered
    if (allSubjects.length === 0) {
        console.log('‚ö†Ô∏è No subjects loaded, loading now...');
        loadSubjects().then(() => {
            console.log('‚úÖ Subjects loaded, showing step 2');
            document.getElementById('bulkSubjectStep1').style.display = 'none';
            document.getElementById('bulkSubjectStep2').style.display = 'block';
        });
    } else {
        console.log('‚úÖ Subjects already loaded (' + allSubjects.length + '), rendering again...');
        renderBulkSubjectCheckboxes();
        // Hide step 1, show step 2
        document.getElementById('bulkSubjectStep1').style.display = 'none';
        document.getElementById('bulkSubjectStep2').style.display = 'block';
    }
}

function goToBulkSubjectStep1() {
    // Show step 1, hide step 2
    document.getElementById('bulkSubjectStep1').style.display = 'block';
    document.getElementById('bulkSubjectStep2').style.display = 'none';
}

// Store all students data for filtering
let allStudentsForSubjects = [];

// Load students for bulk subject assignment
async function loadBulkSubjectStudents() {
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/students?per_page=1000', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();

        if (response.ok && data.students) {
            allStudentsForSubjects = data.students;
            renderBulkStudentCheckboxes(allStudentsForSubjects);
        }
    } catch (error) {
        console.error('Error loading students:', error);
        showNotification('Failed to load students', 'error');
    }
}

// Render bulk student checkboxes
function renderBulkStudentCheckboxes(students) {
    const container = document.getElementById('bulkSubjectStudentCheckboxGrid');
    container.innerHTML = students.map(student => `
        <label class="student-checkbox-item"
               data-student-id="${student.id}"
               data-student-name="${(student.name || '').toLowerCase()}"
               data-student-email="${(student.email || '').toLowerCase()}"
               data-student-grade="${student.grade_level || ''}"
               data-student-school="${(student.school_name || '').toLowerCase()}">
            <input type="checkbox" name="bulk_student_ids" value="${student.id}"
                   onchange="toggleStudentCheckbox(this); updateSelectedStudentCount()">
            <span>${student.name} (${student.email})</span>
        </label>
    `).join('');
    updateSelectedStudentCount();
    updateFilteredStudentCount();
}

// Toggle student checkbox visual state
function toggleStudentCheckbox(checkbox) {
    const label = checkbox.closest('.student-checkbox-item');
    if (checkbox.checked) {
        label.classList.add('checked');
    } else {
        label.classList.remove('checked');
    }
}

// Update selected student count
function updateSelectedStudentCount() {
    const checkboxes = document.querySelectorAll('input[name="bulk_student_ids"]:checked');
    const countEl = document.getElementById('selectedSubjectStudentCount');
    if (countEl) {
        countEl.textContent = `${checkboxes.length} student(s) selected`;
    }
}

// Select all students
function selectAllSubjectStudents() {
    document.querySelectorAll('input[name="bulk_student_ids"]').forEach(cb => {
        cb.checked = true;
        toggleStudentCheckbox(cb);
    });
    updateSelectedStudentCount();
}

// Clear all student selections
function clearAllSubjectStudents() {
    document.querySelectorAll('input[name="bulk_student_ids"]').forEach(cb => {
        cb.checked = false;
        toggleStudentCheckbox(cb);
    });
    updateSelectedStudentCount();
}

// Load current subjects for a student
async function loadStudentCurrentSubjects() {
    const studentSelect = document.getElementById('subjectStudentSelect');
    const studentId = studentSelect.value;

    const panel = document.getElementById('currentSubjectsPanel');
    const listContainer = document.getElementById('currentSubjectsList');

    if (!studentId) {
        panel.style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/subjects`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();

        if (response.ok && data.subjects) {
            if (data.subjects.length > 0) {
                panel.style.display = 'block';
                listContainer.innerHTML = data.subjects.map(ss => `
                    <span class="subject-chip" style="background-color: ${ss.icon_color};">
                        ${ss.display_name}
                        <span class="remove-btn" onclick="removeSubject(${studentId}, ${ss.subject_id})">&times;</span>
                    </span>
                `).join('');
            } else {
                panel.style.display = 'block';
                listContainer.innerHTML = '<p style="color: var(--gray-500);">No subjects assigned yet</p>';
            }
        }
    } catch (error) {
        console.error('Error loading student subjects:', error);
    }
}

// Remove a subject from a student
async function removeSubject(studentId, subjectId) {
    if (!confirm('Are you sure you want to remove this subject?')) return;

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/subjects/${subjectId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            showNotification('Subject removed successfully', 'success');
            loadStudentCurrentSubjects();
        } else {
            throw new Error('Failed to remove subject');
        }
    } catch (error) {
        console.error('Error removing subject:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Handle single subject assignment form submission
document.addEventListener('DOMContentLoaded', function() {
    const assignSubjectForm = document.getElementById('assignSubjectForm');
    if (assignSubjectForm) {
        assignSubjectForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentId = document.getElementById('subjectStudentSelect').value;
            const subjectCheckboxes = document.querySelectorAll('input[name="subject_ids"]:checked');
            const subjectIds = Array.from(subjectCheckboxes).map(cb => parseInt(cb.value));

            if (!studentId) {
                showNotification('Please select a student', 'error');
                return;
            }

            if (subjectIds.length === 0) {
                showNotification('Please select at least one subject', 'error');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/subjects/assign`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAdminToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subject_ids: subjectIds })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(`Successfully assigned ${data.assigned?.length || 0} subject(s)`, 'success');
                    clearSubjectForm();
                    loadStudentCurrentSubjects();
                } else {
                    throw new Error(data.error || 'Failed to assign subjects');
                }
            } catch (error) {
                console.error('Error assigning subjects:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoading();
            }
        });
    }

    // Handle bulk subject assignment form submission
    const bulkAssignSubjectForm = document.getElementById('bulkAssignSubjectForm');
    if (bulkAssignSubjectForm) {
        bulkAssignSubjectForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentCheckboxes = document.querySelectorAll('input[name="bulk_student_ids"]:checked');
            const studentIds = Array.from(studentCheckboxes).map(cb => parseInt(cb.value));

            const subjectCheckboxes = document.querySelectorAll('input[name="bulk_subject_ids"]:checked');
            const subjectIds = Array.from(subjectCheckboxes).map(cb => parseInt(cb.value));

            if (studentIds.length === 0) {
                showNotification('Please select at least one student', 'error');
                return;
            }

            if (subjectIds.length === 0) {
                showNotification('Please select at least one subject', 'error');
                return;
            }

            showLoading();
            try {
                const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/subjects/bulk-assign', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAdminToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_ids: studentIds,
                        subject_ids: subjectIds
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const resultsDiv = document.getElementById('subjectAssignmentResults');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <div style="padding: 1.5rem; background: white; border-radius: 8px; border: 1px solid var(--border-color);">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Bulk Assignment Results</h3>
                            <p><strong>Total Students:</strong> ${data.total_students}</p>
                            <p><strong>Successful Assignments:</strong> ${data.successful_assignments}</p>
                            <p><strong>Failed Assignments:</strong> ${data.failed_assignments}</p>
                            ${data.details && data.details.length > 0 ? `
                                <div style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                                    ${data.details.map(d => `
                                        <div style="padding: 0.5rem; margin: 0.5rem 0; background: ${
                                            d.status === 'success' ? '#dcfce7' : '#fee2e2'
                                        }; border-radius: 4px;">
                                            <strong>${d.student_name}</strong>: ${d.status}
                                            ${d.subjects ? ` - ${d.subjects.join(', ')}` : ''}
                                            ${d.message ? ` - ${d.message}` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    showNotification('Bulk assignment completed', 'success');
                    clearBulkSubjectForm();
                } else {
                    throw new Error(data.error || 'Failed to bulk assign subjects');
                }
            } catch (error) {
                console.error('Error bulk assigning subjects:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoading();
            }
        });
    }
});

// Update filtered student count
function updateFilteredStudentCount() {
    const visibleItems = document.querySelectorAll('#bulkSubjectStudentCheckboxGrid .student-checkbox-item:not([style*="display: none"])');
    const countEl = document.getElementById('filteredSubjectStudentCount');
    if (countEl) {
        countEl.textContent = `Showing ${visibleItems.length} of ${allStudentsForSubjects.length} students`;
    }
}

// Filter bulk student checkboxes
function filterBulkStudentCheckboxes() {
    const searchInput = document.getElementById('bulkStudentSearchInput');
    const gradeFilter = document.getElementById('bulkStudentGradeFilter');

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const gradeValue = gradeFilter ? gradeFilter.value : '';

    const items = document.querySelectorAll('#bulkSubjectStudentCheckboxGrid .student-checkbox-item');

    items.forEach(item => {
        const name = item.getAttribute('data-student-name') || '';
        const email = item.getAttribute('data-student-email') || '';
        const school = item.getAttribute('data-student-school') || '';
        const grade = item.getAttribute('data-student-grade') || '';

        const matchesSearch = searchTerm === '' ||
                            name.includes(searchTerm) ||
                            email.includes(searchTerm) ||
                            school.includes(searchTerm);

        const matchesGrade = gradeValue === '' || grade === gradeValue;

        if (matchesSearch && matchesGrade) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });

    updateFilteredStudentCount();
}

// Filter single student dropdown
function filterSingleStudentDropdown() {
    const searchInput = document.getElementById('singleStudentSearchInput');
    const gradeFilter = document.getElementById('singleStudentGradeFilter');
    const studentSelect = document.getElementById('subjectStudentSelect');

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const gradeValue = gradeFilter ? gradeFilter.value : '';

    const options = studentSelect.querySelectorAll('option');
    let visibleCount = 0;

    options.forEach(option => {
        if (option.value === '') {
            // Keep the placeholder option
            return;
        }

        const text = option.textContent.toLowerCase();
        const grade = option.getAttribute('data-grade') || '';

        const matchesSearch = searchTerm === '' || text.includes(searchTerm);
        const matchesGrade = gradeValue === '' || grade === gradeValue;

        if (matchesSearch && matchesGrade) {
            option.style.display = '';
            visibleCount++;
        } else {
            option.style.display = 'none';
        }
    });

    const countDisplay = document.getElementById('studentCountDisplay');
    if (countDisplay) {
        countDisplay.textContent = `Showing ${visibleCount} student(s)`;
    }
}

// Select only filtered students
function selectFilteredSubjectStudents() {
    const items = document.querySelectorAll('#bulkSubjectStudentCheckboxGrid .student-checkbox-item:not([style*="display: none"])');
    items.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) {
            checkbox.checked = true;
            toggleStudentCheckbox(checkbox);
        }
    });
    updateSelectedStudentCount();
}

// Load all students into a select dropdown with filter support
async function loadAllStudentsIntoSelect(selectId) {
    try {
        // Use existing studentsData if available
        if (studentsData && studentsData.length > 0) {
            populateStudentSelectWithFilter(selectId, studentsData);
        } else {
            // Load students fresh
            await loadStudents();
            populateStudentSelectWithFilter(selectId, studentsData);
        }
    } catch (error) {
        console.error('Error loading students into select:', error);
    }
}

// Populate student select with data attributes for filtering
function populateStudentSelectWithFilter(selectId, students) {
    const select = document.getElementById(selectId);
    if (!select) return;

    // Keep the first option (placeholder)
    const placeholder = select.querySelector('option[value=""]');
    select.innerHTML = '';
    if (placeholder) {
        select.appendChild(placeholder);
    }

    students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.name} (Grade ${student.grade_level}) - ${student.school_name}`;
        option.setAttribute('data-grade', student.grade_level || '');
        select.appendChild(option);
    });

    // Trigger filter to show count
    if (selectId === 'subjectStudentSelect') {
        filterSingleStudentDropdown();
    }
}

// Clear single subject form
function clearSubjectForm() {
    document.getElementById('subjectStudentSelect').value = '';
    document.querySelectorAll('input[name="subject_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSubjectCheckbox(cb);
    });
    document.getElementById('currentSubjectsPanel').style.display = 'none';
    // Reset to step 1
    goToSingleSubjectStep1();
}

// Clear bulk subject form
function clearBulkSubjectForm() {
    clearAllSubjectStudents();
    document.querySelectorAll('input[name="bulk_subject_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSubjectCheckbox(cb);
    });
    document.getElementById('subjectAssignmentResults').style.display = 'none';
    // Reset to step 1
    goToBulkSubjectStep1();
}

// Initialize subject assignment when navigating to the page
const originalShowPage = window.showPage;
window.showPage = function(page) {
    if (typeof originalShowPage === 'function') {
        originalShowPage(page);
    }

    if (page === 'subject-assignment') {
        loadSubjects();
        // Load students for single mode
        loadAllStudentsIntoSelect('subjectStudentSelect');
    }

    if (page === 'skill-assignment') {
        loadSkills();
        loadAllStudentsIntoSelect('singleSkillStudentSelect');
    }
};

console.log('‚úÖ Subject assignment functions loaded for super admin');

// =====================================================
// SKILL ASSIGNMENT MANAGEMENT FOR SUPER ADMIN
// =====================================================

let allSkills = [];
let currentSkillMode = 'single';
let selectedSkillStudentId = null;
let selectedSkillStudentsIds = [];
let allStudentsForSkills = [];

// Load all skills from backend
async function loadSkills() {
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/skills', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();

        if (response.ok && data.skills) {
            allSkills = data.skills;
            console.log('‚úÖ Loaded ' + allSkills.length + ' skills for assignment');
            renderSkillCheckboxes();
            renderBulkSkillCheckboxes();
        } else {
            console.error('Failed to load skills:', data);
            showNotification('Failed to load skills: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error loading skills:', error);
        showNotification('Failed to load skills', 'error');
    }
}

// Render skill checkboxes for single mode
function renderSkillCheckboxes() {
    const container = document.getElementById('skillCheckboxGrid');
    if (!container) {
        console.error('‚ùå skillCheckboxGrid container not found');
        return;
    }

    console.log('‚úÖ Rendering ' + allSkills.length + ' skills in grid');
    container.innerHTML = allSkills.map(skill => `
        <label class="subject-checkbox-item" data-skill-id="${skill.id}">
            <input type="checkbox" name="skill_ids" value="${skill.id}"
                   onchange="toggleSkillCheckbox(this)">
            <div>
                <div style="font-weight: 600; color: ${skill.icon_color};">${skill.name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-600);">${skill.description || ''}</div>
                <span style="font-size: 0.75rem; background: ${skill.icon_color}20; color: ${skill.icon_color}; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; margin-top: 0.25rem;">${skill.category || 'general'}</span>
            </div>
        </label>
    `).join('');
}

// Render skill checkboxes for bulk mode
function renderBulkSkillCheckboxes() {
    const container = document.getElementById('bulkSkillCheckboxGrid');
    if (!container) {
        console.error('‚ùå bulkSkillCheckboxGrid container not found');
        return;
    }

    console.log('‚úÖ Rendering ' + allSkills.length + ' skills in bulk mode grid');
    container.innerHTML = allSkills.map(skill => `
        <label class="subject-checkbox-item" data-skill-id="${skill.id}">
            <input type="checkbox" name="bulk_skill_ids" value="${skill.id}"
                   onchange="toggleSkillCheckbox(this)">
            <div>
                <div style="font-weight: 600; color: ${skill.icon_color};">${skill.name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-600);">${skill.description || ''}</div>
                <span style="font-size: 0.75rem; background: ${skill.icon_color}20; color: ${skill.icon_color}; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; margin-top: 0.25rem;">${skill.category || 'general'}</span>
            </div>
        </label>
    `).join('');
}

// Toggle skill checkbox visual state
function toggleSkillCheckbox(checkbox) {
    const label = checkbox.closest('.subject-checkbox-item');
    if (checkbox.checked) {
        label.classList.add('checked');
    } else {
        label.classList.remove('checked');
    }
}

// Switch between single and bulk skill assignment modes
function switchSkillMode(mode) {
    currentSkillMode = mode;
    const singleBtn = document.getElementById('skillSingleModeBtn');
    const bulkBtn = document.getElementById('skillBulkModeBtn');
    const singleMode = document.getElementById('skillSingleMode');
    const bulkMode = document.getElementById('skillBulkMode');

    if (mode === 'single') {
        singleBtn.classList.remove('btn-secondary');
        singleBtn.classList.add('btn-primary');
        bulkBtn.classList.remove('btn-primary');
        bulkBtn.classList.add('btn-secondary');
        singleMode.style.display = 'block';
        bulkMode.style.display = 'none';
        loadAllStudentsIntoSelect('singleSkillStudentSelect');
    } else {
        singleBtn.classList.remove('btn-primary');
        singleBtn.classList.add('btn-secondary');
        bulkBtn.classList.remove('btn-secondary');
        bulkBtn.classList.add('btn-primary');
        singleMode.style.display = 'none';
        bulkMode.style.display = 'block';
        loadBulkSkillStudentCheckboxes();
    }
}

// Load students into checkbox grid for bulk skill assignment
async function loadBulkSkillStudentCheckboxes() {
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/students', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            allStudentsForSkills = data.students || [];
            renderBulkSkillStudentCheckboxes();
        } else {
            console.error('Failed to load students for skill assignment');
        }
    } catch (error) {
        console.error('Error loading students for skill assignment:', error);
    }
}

// Render student checkboxes for bulk skill assignment
function renderBulkSkillStudentCheckboxes() {
    const container = document.getElementById('bulkSkillStudentCheckboxGrid');
    if (!container) return;

    container.innerHTML = allStudentsForSkills.map(student => `
        <label class="student-checkbox-item"
               data-student-id="${student.id}"
               data-student-name="${(student.first_name + ' ' + student.last_name).toLowerCase()}"
               data-student-email="${(student.email || '').toLowerCase()}"
               data-student-school="${(student.school_name || '').toLowerCase()}"
               data-student-grade="${student.grade || ''}">
            <input type="checkbox" name="bulk_skill_student_ids" value="${student.id}"
                   onchange="toggleSkillStudentCheckbox(this); updateSelectedSkillStudentCount();">
            <div class="student-checkbox-info">
                <div class="student-checkbox-name">${student.first_name} ${student.last_name}</div>
                <div class="student-checkbox-details">${student.email || 'No email'} ‚Ä¢ Grade ${student.grade || 'N/A'} ‚Ä¢ ${student.school_name || 'No school'}</div>
            </div>
        </label>
    `).join('');

    updateSelectedSkillStudentCount();
    updateFilteredSkillStudentCount();
}

// Toggle student checkbox visual state for skills
function toggleSkillStudentCheckbox(checkbox) {
    const label = checkbox.closest('.student-checkbox-item');
    if (checkbox.checked) {
        label.classList.add('checked');
    } else {
        label.classList.remove('checked');
    }
}

// Update selected student count for skills
function updateSelectedSkillStudentCount() {
    const checkboxes = document.querySelectorAll('input[name="bulk_skill_student_ids"]:checked');
    const countEl = document.getElementById('selectedSkillStudentCount');
    if (countEl) {
        countEl.textContent = `${checkboxes.length} student(s) selected`;
    }
}

// Update filtered student count for skills
function updateFilteredSkillStudentCount() {
    const visibleItems = document.querySelectorAll('#bulkSkillStudentCheckboxGrid .student-checkbox-item:not([style*="display: none"])');
    const countEl = document.getElementById('filteredSkillStudentCount');
    if (countEl) {
        countEl.textContent = `Showing ${visibleItems.length} of ${allStudentsForSkills.length} students`;
    }
}

// Select all skill students
function selectAllSkillStudents() {
    document.querySelectorAll('input[name="bulk_skill_student_ids"]').forEach(cb => {
        cb.checked = true;
        toggleSkillStudentCheckbox(cb);
    });
    updateSelectedSkillStudentCount();
}

// Clear all skill student selections
function clearAllSkillStudents() {
    document.querySelectorAll('input[name="bulk_skill_student_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSkillStudentCheckbox(cb);
    });
    updateSelectedSkillStudentCount();
}

// Select only filtered skill students
function selectFilteredSkillStudents() {
    document.querySelectorAll('#bulkSkillStudentCheckboxGrid .student-checkbox-item').forEach(item => {
        if (item.style.display !== 'none') {
            const checkbox = item.querySelector('input[name="bulk_skill_student_ids"]');
            if (checkbox) {
                checkbox.checked = true;
                toggleSkillStudentCheckbox(checkbox);
            }
        }
    });
    updateSelectedSkillStudentCount();
}

// Filter bulk skill student checkboxes
function filterBulkSkillStudentCheckboxes() {
    const searchInput = document.getElementById('bulkSkillStudentSearchInput');
    const gradeFilter = document.getElementById('bulkSkillStudentGradeFilter');

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const gradeValue = gradeFilter ? gradeFilter.value : '';

    const items = document.querySelectorAll('#bulkSkillStudentCheckboxGrid .student-checkbox-item');

    items.forEach(item => {
        const name = item.getAttribute('data-student-name') || '';
        const email = item.getAttribute('data-student-email') || '';
        const school = item.getAttribute('data-student-school') || '';
        const grade = item.getAttribute('data-student-grade') || '';

        const matchesSearch = searchTerm === '' ||
                            name.includes(searchTerm) ||
                            email.includes(searchTerm) ||
                            school.includes(searchTerm);

        const matchesGrade = gradeValue === '' || grade === gradeValue;

        if (matchesSearch && matchesGrade) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });

    updateFilteredSkillStudentCount();
}

// Single Mode - Step navigation
function goToSingleSkillStep2() {
    const studentSelect = document.getElementById('singleSkillStudentSelect');
    selectedSkillStudentId = studentSelect.value;

    if (!selectedSkillStudentId) {
        showNotification('Please select a student first', 'error');
        return;
    }

    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
    const studentName = selectedOption.text;

    document.getElementById('selectedStudentInfoSkill').textContent = studentName;
    document.getElementById('singleSkillStep1').style.display = 'none';
    document.getElementById('singleSkillStep2').style.display = 'block';

    loadCurrentSkills(selectedSkillStudentId);
}

function goToSingleSkillStep1() {
    document.getElementById('singleSkillStep2').style.display = 'none';
    document.getElementById('singleSkillStep1').style.display = 'block';
}

// Load current skills for a student
async function loadCurrentSkills(studentId) {
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/skills`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const display = document.getElementById('currentSkillsDisplay');
            const listContainer = document.getElementById('currentSkillsList');

            if (data.skills && data.skills.length > 0) {
                display.style.display = 'block';
                listContainer.innerHTML = data.skills.map(ss => `
                    <span class="subject-chip" style="background-color: ${ss.icon_color};">
                        ${ss.display_name}
                        <span class="remove-btn" onclick="removeSkill(${studentId}, ${ss.skill_id})">&times;</span>
                    </span>
                `).join('');
            } else {
                display.style.display = 'block';
                listContainer.innerHTML = '<p style="color: var(--gray-600);">No skills assigned yet</p>';
            }
        }
    } catch (error) {
        console.error('Error loading current skills:', error);
    }
}

// Remove a skill from a student
async function removeSkill(studentId, skillId) {
    if (!confirm('Are you sure you want to remove this skill?')) return;

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/skills/${skillId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            showNotification('Skill removed successfully!');
            loadCurrentSkills(studentId);
        } else {
            const data = await response.json();
            throw new Error(data.error || 'Failed to remove skill');
        }
    } catch (error) {
        console.error('Error removing skill:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Bulk Mode - Step navigation
async function goToBulkSkillStep2() {
    const selectedCheckboxes = document.querySelectorAll('input[name="bulk_skill_student_ids"]:checked');
    selectedSkillStudentsIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (selectedSkillStudentsIds.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    // Get student names from selected checkboxes
    const studentNames = Array.from(selectedCheckboxes).map(cb => {
        const label = cb.closest('.student-checkbox-item');
        return label.querySelector('.student-checkbox-name').textContent;
    });

    document.getElementById('selectedStudentsInfoSkill').innerHTML =
        `<strong>${selectedSkillStudentsIds.length} students selected:</strong><br>` +
        studentNames.join(', ');

    document.getElementById('bulkSkillStep1').style.display = 'none';
    document.getElementById('bulkSkillStep2').style.display = 'block';

    // Ensure skills are loaded before rendering
    if (!allSkills || allSkills.length === 0) {
        console.log('‚è≥ Skills not loaded yet, loading now...');
        await loadSkills();
    }

    // Small delay to ensure DOM is ready
    setTimeout(() => {
        console.log('üéØ Rendering ' + allSkills.length + ' skills in bulk mode');
        renderBulkSkillCheckboxes();
    }, 100);
}

function goToBulkSkillStep1() {
    document.getElementById('bulkSkillStep2').style.display = 'none';
    document.getElementById('bulkSkillStep1').style.display = 'block';
}

// Handle single skill assignment form
const assignSkillForm = document.getElementById('assignSkillForm');
if (assignSkillForm) {
    assignSkillForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const checkedSkills = Array.from(document.querySelectorAll('input[name="skill_ids"]:checked')).map(cb => parseInt(cb.value));

        if (checkedSkills.length === 0) {
            showNotification('Please select at least one skill', 'error');
            return;
        }

        showLoading();
        try {
            const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${selectedSkillStudentId}/skills/assign`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getAdminToken()}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    skill_ids: checkedSkills
                })
            });

            const data = await response.json();

            if (response.ok) {
                const resultsDiv = document.getElementById('skillAssignmentResults');
                resultsDiv.innerHTML = `
                    <div style="padding: 1.5rem; background: var(--green-50); border-radius: 8px; border-left: 4px solid var(--green-500);">
                        <h4 style="color: var(--green-700); margin-bottom: 1rem;">‚úÖ Assignment Successful</h4>
                        ${data.assigned.length > 0 ? `<p><strong>Assigned:</strong> ${data.assigned.join(', ')}</p>` : ''}
                        ${data.skipped.length > 0 ? `<p><strong>Skipped (already assigned):</strong> ${data.skipped.join(', ')}</p>` : ''}
                        ${data.errors.length > 0 ? `<p style="color: var(--red-600);"><strong>Errors:</strong> ${data.errors.join(', ')}</p>` : ''}
                    </div>
                `;
                resultsDiv.style.display = 'block';

                showNotification('Skills assigned successfully!');
                clearSkillForm();
            } else {
                throw new Error(data.error || 'Failed to assign skills');
            }
        } catch (error) {
            console.error('Error assigning skills:', error);
            showNotification(error.message, 'error');
        } finally {
            hideLoading();
        }
    });
}

// Handle bulk skill assignment form
const bulkAssignSkillForm = document.getElementById('bulkAssignSkillForm');
if (bulkAssignSkillForm) {
    bulkAssignSkillForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const checkedSkills = Array.from(document.querySelectorAll('input[name="bulk_skill_ids"]:checked')).map(cb => parseInt(cb.value));

        if (checkedSkills.length === 0) {
            showNotification('Please select at least one skill', 'error');
            return;
        }

        showLoading();
        try {
            const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/skills/bulk-assign', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getAdminToken()}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    student_ids: selectedSkillStudentsIds.map(id => parseInt(id)),
                    skill_ids: checkedSkills
                })
            });

            const data = await response.json();

            if (response.ok) {
                const resultsDiv = document.getElementById('skillAssignmentResults');
                resultsDiv.innerHTML = `
                    <div style="padding: 1.5rem; background: var(--green-50); border-radius: 8px; border-left: 4px solid var(--green-500);">
                        <h4 style="color: var(--green-700); margin-bottom: 1rem;">‚úÖ Bulk Assignment Successful</h4>
                        <p><strong>Total Students:</strong> ${data.total_students}</p>
                        <p><strong>Total Skills:</strong> ${data.total_skills}</p>
                        <p><strong>Successful Assignments:</strong> ${data.successful_assignments}</p>
                        <p><strong>Failed Assignments:</strong> ${data.failed_assignments}</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';

                showNotification('Skills assigned successfully to multiple students!');
                clearBulkSkillForm();
            } else {
                throw new Error(data.error || 'Failed to bulk assign skills');
            }
        } catch (error) {
            console.error('Error bulk assigning skills:', error);
            showNotification(error.message, 'error');
        } finally {
            hideLoading();
        }
    });
}

function clearSkillForm() {
    document.querySelectorAll('input[name="skill_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSkillCheckbox(cb);
    });
    document.getElementById('skillAssignmentResults').style.display = 'none';
    goToSingleSkillStep1();
}

function clearBulkSkillForm() {
    selectedSkillStudentsIds = [];
    // Clear student selections
    document.querySelectorAll('input[name="bulk_skill_student_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSkillStudentCheckbox(cb);
    });
    updateSelectedSkillStudentCount();
    // Clear skill selections
    document.querySelectorAll('input[name="bulk_skill_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSkillCheckbox(cb);
    });
    document.getElementById('skillAssignmentResults').style.display = 'none';
    goToBulkSkillStep1();
}

console.log('‚úÖ Skill assignment functions loaded for super admin');

    </script>
    </script>
    <script>
       // Setup social media event listeners - FIXED VERSION
function setupSocialMediaEventListeners() {
    console.log('üìù Setting up social media event listeners...');
    
    // Task assignment form - CRITICAL FIX
    const smTaskForm = document.getElementById('assignSocialMediaTaskForm');
    if (smTaskForm) {
        // Remove any existing listeners by cloning
        const newForm = smTaskForm.cloneNode(true);
        smTaskForm.parentNode.replaceChild(newForm, smTaskForm);
        
        // Add fresh listener
        newForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üéØ Social media form submitted!');
            
            // Call the handler
            await handleAssignSocialMediaTask(e);
        });
        console.log('‚úÖ Social media form handler attached');
    } else {
        console.error('‚ùå Social media form not found');
    }

    // Student selection helpers
    const selectAllBtn = document.getElementById('smSelectAllBtn');
    if (selectAllBtn) {
        selectAllBtn.onclick = (e) => {
            e.preventDefault();
            selectAllSMStudents(true);
        };
        console.log('‚úÖ Select all button configured');
    }

    const deselectAllBtn = document.getElementById('smDeselectAllBtn');
    if (deselectAllBtn) {
        deselectAllBtn.onclick = (e) => {
            e.preventDefault();
            selectAllSMStudents(false);
        };
        console.log('‚úÖ Deselect all button configured');
    }

    const refreshStudentsBtn = document.getElementById('smRefreshStudentsBtn');
    if (refreshStudentsBtn) {
        refreshStudentsBtn.onclick = (e) => {
            e.preventDefault();
            loadSocialMediaStudents();
        };
        console.log('‚úÖ Refresh students button configured');
    }

    // Student select change
    const studentSelect = document.getElementById('smStudentSelect');
    if (studentSelect) {
        studentSelect.addEventListener('change', updateSelectedCount);
        console.log('‚úÖ Student select change handler attached');
    }

    // Create student button
    const createStudentBtn = document.getElementById('createSMStudentBtn');
    if (createStudentBtn) {
        createStudentBtn.onclick = (e) => {
            e.preventDefault();
            showCreateSMStudentModal();
        };
        console.log('‚úÖ Create student button configured');
    }

    // Refresh assignments
    const refreshAssignments = document.getElementById('smRefreshAssignments');
    if (refreshAssignments) {
        refreshAssignments.onclick = (e) => {
            e.preventDefault();
            loadSocialMediaAssignments();
        };
        console.log('‚úÖ Refresh assignments button configured');
    }

    // Status filter
    const statusFilter = document.getElementById('smStatusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', filterSocialMediaAssignments);
        console.log('‚úÖ Status filter configured');
    }

    // Students search
    const studentsSearch = document.getElementById('smStudentsSearch');
    if (studentsSearch) {
        studentsSearch.addEventListener('input', filterSocialMediaStudents);
        console.log('‚úÖ Students search configured');
    }
    
    console.log('‚úÖ All social media event listeners configured successfully!');
}


// Load social media students
async function loadSocialMediaStudents() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/students', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            socialMediaStudents = data.students || [];
            populateSMStudentSelect();
            renderSMStudentsTable();
            console.log(`‚úÖ Loaded ${socialMediaStudents.length} social media students`);
        } else {
            throw new Error('Failed to load social media students');
        }
    } catch (error) {
        console.error('Error loading social media students:', error);
        showNotification('Failed to load social media students', 'error');
    } finally {
        hideLoading();
    }
}

// Populate student select dropdown
function populateSMStudentSelect() {
    const select = document.getElementById('smStudentSelect');
    if (!select) return;

    select.innerHTML = '';

    if (socialMediaStudents.length === 0) {
        select.innerHTML = '<option value="" disabled>No students available</option>';
        updateSelectedCount();
        return;
    }

    socialMediaStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.full_name} (${student.username}) - ${student.skill_level}`;
        if (!student.is_active) {
            option.textContent += ' [INACTIVE]';
            option.style.color = 'var(--gray-400)';
        }
        select.appendChild(option);
    });

    updateSelectedCount();
}

// Select/Deselect all students
function selectAllSMStudents(select) {
    const studentSelect = document.getElementById('smStudentSelect');
    if (!studentSelect) return;

    const options = studentSelect.options;
    for (let i = 0; i < options.length; i++) {
        options[i].selected = select;
    }
    updateSelectedCount();
}

// Update selected students count
function updateSelectedCount() {
    const studentSelect = document.getElementById('smStudentSelect');
    const countDisplay = document.getElementById('smSelectedCount');
    if (!studentSelect || !countDisplay) return;

    const selectedCount = Array.from(studentSelect.selectedOptions).length;
    countDisplay.textContent = `${selectedCount} student${selectedCount !== 1 ? 's' : ''} selected`;
}

// Fixed task assignment handler with better validation
async function handleAssignSocialMediaTask(e) {
    e.preventDefault();
    console.log('üöÄ Task assignment initiated');
    
    // Get selected category
    const selectedCategory = document.getElementById('smSkillCategory')?.value;
    
    if (!selectedCategory) {
        showNotification('‚ö†Ô∏è Please select a skill category first', 'error');
        return;
    }
    
    // Verify category matches loaded students
    if (selectedCategory !== currentSkillCategory) {
        showNotification('‚ö†Ô∏è Skill category changed. Please refresh the students list.', 'error');
        document.getElementById('smSkillCategory').value = currentSkillCategory || '';
        return;
    }
    
    // Get selected students
    const studentSelect = document.getElementById('smStudentSelect');
    const selectedStudents = Array.from(studentSelect?.selectedOptions || [])
        .filter(opt => !opt.disabled)
        .map(option => parseInt(option.value));

    console.log('Selected student IDs:', selectedStudents);
    console.log('Skill category:', selectedCategory);

    if (selectedStudents.length === 0) {
        console.error('‚ùå No students selected');
        showNotification('Please select at least one student', 'error');
        return;
    }
    
    // Validate all required fields
    const taskTitle = document.getElementById('smTaskTitle')?.value?.trim();
    if (!taskTitle) {
        showNotification('Please enter a task title', 'error');
        return;
    }

    // Build task data
    const taskData = {
        student_ids: selectedStudents,
        task_type: selectedCategory,
        skill_category: selectedCategory,
        task_title: taskTitle,
        task_description: document.getElementById('smTaskDescription')?.value?.trim() || '',
        week_number: parseInt(document.getElementById('smWeekNumber')?.value) || null,
        day_number: parseInt(document.getElementById('smDayNumber')?.value) || null,
        lesson_type: document.getElementById('smLessonType')?.value || 'lesson',
        video_url: document.getElementById('smVideoUrl')?.value?.trim() || null,
        zoom_passcode: document.getElementById('smZoomPasscode')?.value?.trim() || null,
        duration: document.getElementById('smDuration')?.value?.trim() || null,
        access_code: document.getElementById('smAccessCode')?.value?.trim() || null,
        points_reward: parseInt(document.getElementById('smPointsReward')?.value) || 0,
        due_date: document.getElementById('smDueDate')?.value || null
    };

    console.log('üì¶ Task data to submit:', taskData);

    showLoading();
    
    try {
        console.log('üì° Sending request to API...');
        
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/assign-tasks',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            }
        );

        console.log('üì• Response status:', response.status);
        const result = await response.json();

        if (response.ok && result.success) {
            console.log('‚úÖ Success! Result:', result);
            showNotification(`‚úÖ Task assigned to ${result.assigned_tasks.length} students successfully!`);
            
            // Reset form
            document.getElementById('assignSocialMediaTaskForm').reset();
            updateSelectedCount();
            
            // Reload data
            await loadSocialMediaAssignments();
            
            // Reset category selection
            currentSkillCategory = null;
            resetStudentSection();
        } else {
            // Handle error with details
            console.error('‚ùå Server error:', result);
            
            let errorMessage = result.error || 'Failed to assign task';
            
            if (result.missing_details) {
                errorMessage += '\n\nMissing students:';
                result.missing_details.forEach(detail => {
                    errorMessage += `\n‚Ä¢ ${detail.name || `ID ${detail.id}`}: ${detail.reason}`;
                });
            }
            
            throw new Error(errorMessage);
        }
    } catch (error) {
        console.error('‚ùå Error assigning social media task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Load social media assignments
async function loadSocialMediaAssignments() {
    showLoading();
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/tasks', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            socialMediaTasks = data.tasks || [];
            renderSMAssignmentsTable(socialMediaTasks);
        } else {
            throw new Error('Failed to load assignments');
        }
    } catch (error) {
        console.error('Error loading assignments:', error);
        showNotification('Failed to load assignments', 'error');
    } finally {
        hideLoading();
    }
}

// Render social media assignments table
function renderSMAssignmentsTable(tasks) {
    const tbody = document.getElementById('smAssignmentsTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-500); padding: 2rem;">No assignments found</td></tr>';
        return;
    }

    tasks.forEach(task => {
        const row = document.createElement('tr');
        const statusClass = task.status === 'completed' ? 'status-completed' : 
                           task.status === 'in_progress' ? 'status-pending' : 'status-active';

        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${task.task_title}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${task.lesson_type || 'Lesson'}</div>
                </div>
            </td>
            <td>
                <div>
                    <div>${task.student_info?.name || 'Unknown'}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${task.student_info?.email || ''}</div>
                </div>
            </td>
            <td>
                <span style="text-transform: capitalize; font-weight: 600;">
                    ${task.skill_category.replace('-', ' ')}
                </span>
            </td>
            <td>
                ${task.week_number ? `Week ${task.week_number}` : '‚Äî'} / 
                ${task.day_number ? `Day ${task.day_number}` : '‚Äî'}
            </td>
            <td>
                <span class="status-badge ${statusClass}">
                    ${task.status === 'completed' ? 'Completed' : 
                      task.status === 'in_progress' ? 'In Progress' : 'Pending'}
                </span>
            </td>
            <td>${task.points_reward || 0}</td>
            <td>${new Date(task.assigned_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-secondary btn-sm" onclick="viewSMTask(${task.id})">
                    üëÅÔ∏è View
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Render social media students table
function renderSMStudentsTable() {
    const tbody = document.getElementById('smStudentsTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (socialMediaStudents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-500); padding: 2rem;">No students found</td></tr>';
        return;
    }

    socialMediaStudents.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${student.full_name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">ID: ${student.id}</div>
                </div>
            </td>
            <td>${student.username}</td>
            <td>${student.email}</td>
            <td>
                <span class="status-badge" style="background: rgba(139, 92, 246, 0.1); color: var(--purple-500);">
                    ${student.skill_level}
                </span>
            </td>
            <td>${student.total_tasks_completed || 0}</td>
            <td>${student.total_points || 0}</td>
            <td>
                <span class="status-badge ${student.is_active ? 'status-active' : 'status-inactive'}">
                    ${student.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-secondary btn-sm" onclick="viewSMStudent(${student.id})">
                    üëÅÔ∏è View
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Filter assignments by status
function filterSocialMediaAssignments() {
    const statusFilter = document.getElementById('smStatusFilter')?.value;
    const filtered = statusFilter ? 
        socialMediaTasks.filter(task => task.status === statusFilter) : 
        socialMediaTasks;
    renderSMAssignmentsTable(filtered);
}

// Filter students by search
function filterSocialMediaStudents() {
    const search = document.getElementById('smStudentsSearch')?.value.toLowerCase() || '';
    const tbody = document.getElementById('smStudentsTableBody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

// View social media task details
function viewSMTask(taskId) {
    const task = socialMediaTasks.find(t => t.id === taskId);
    if (!task) return;

    const details = `
Task: ${task.task_title}
Student: ${task.student_info?.name || 'Unknown'}
Category: ${task.skill_category}
Status: ${task.status}
Points: ${task.points_reward || 0}
Week/Day: ${task.week_number ? `Week ${task.week_number}` : '‚Äî'} / ${task.day_number ? `Day ${task.day_number}` : '‚Äî'}
Video URL: ${task.video_url || 'N/A'}
Assigned: ${new Date(task.assigned_at).toLocaleString()}
    `.trim();
    
    alert(details);
}

// View social media student details
function viewSMStudent(studentId) {
    const student = socialMediaStudents.find(s => s.id === studentId);
    if (!student) return;

    const details = `
Name: ${student.full_name}
Username: ${student.username}
Email: ${student.email}
Skill Level: ${student.skill_level}
Tasks Completed: ${student.total_tasks_completed || 0}
Total Points: ${student.total_points || 0}
Status: ${student.is_active ? 'Active' : 'Inactive'}
    `.trim();
    
    alert(details);
}

// Show create student modal
function showCreateSMStudentModal() {
    alert('Create Student Modal - This feature needs to be implemented with a proper modal.');
}

// Initialize social media management - FIXED VERSION
function initializeSocialMediaManagement() {
    console.log('üöÄ Initializing Social Media Management...');
    
    // CRITICAL: Setup event listeners FIRST
    setupSocialMediaEventListeners();
    
    // Then load data
    loadSocialMediaStudents();
    loadSocialMediaAssignments();
    
    console.log('‚úÖ Social Media Management initialized successfully!');
}

// Update the navigation function to properly initialize
const originalNavigateToPage = navigateToPage;
navigateToPage = function(page) {
    originalNavigateToPage(page);
    
    if (page === 'social-media-assign') {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
            initializeSocialMediaManagement();
        }, 100);
    }
};

console.log('‚úÖ Social Media Task Assignment Module Loaded');

// ==================== SUPER ADMIN BULK TASK ASSIGNMENT ====================

// Bulk assignment variables for super admin
let superAdminBulkTasks = [];
let superAdminSelectedBulkStudents = new Set();
let superAdminBulkTaskCounter = 0;
let superAdminCurrentMode = 'single';

// Mode switching for super admin
function switchSuperAdminMode(mode) {
    superAdminCurrentMode = mode;
    const singleMode = document.getElementById('superAdminSingleTaskMode');
    const bulkMode = document.getElementById('superAdminBulkTaskMode');
    const singleBtn = document.getElementById('superAdminSingleModeBtn');
    const bulkBtn = document.getElementById('superAdminBulkModeBtn');

    if (mode === 'single') {
        singleMode.style.display = 'block';
        bulkMode.style.display = 'none';
        singleBtn.className = 'btn btn-primary';
        bulkBtn.className = 'btn btn-secondary';
    } else {
        singleMode.style.display = 'none';
        bulkMode.style.display = 'block';
        singleBtn.className = 'btn btn-secondary';
        bulkBtn.className = 'btn btn-primary';
        initializeSuperAdminBulkMode();
    }
}

function initializeSuperAdminBulkMode() {
    if (superAdminBulkTasks.length === 0) {
        addSuperAdminBulkTask();
    }
    renderSuperAdminBulkStudents();
    updateSuperAdminBulkSummary();
}

function addSuperAdminBulkTask() {
    superAdminBulkTaskCounter++;
    const task = {
        id: superAdminBulkTaskCounter,
        task_type: 'mathematics',
        task_title: '',
        task_description: '',
        points_reward: 0,
        acard_credit: 0.0,
        due_date: '',
        link_type: 'internal',
        task_file: '',
        external_url: '',
        link_config: null,
        class_link_url: '',
        class_start_time: ''
    };

    superAdminBulkTasks.push(task);
    renderSuperAdminBulkTasks();
}

function removeSuperAdminBulkTask(taskId) {
    superAdminBulkTasks = superAdminBulkTasks.filter(t => t.id !== taskId);
    renderSuperAdminBulkTasks();
    updateSuperAdminBulkSummary();
}

function renderSuperAdminBulkTasks() {
    const container = document.getElementById('superAdminBulkTasksContainer');
    container.innerHTML = '';

    superAdminBulkTasks.forEach((task, index) => {
        const taskCard = document.createElement('div');
        taskCard.className = 'bulk-task-card';
        taskCard.innerHTML = `
            <div class="bulk-task-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="bulk-task-number">${index + 1}</div>
                    <h4 style="margin: 0;">Task ${index + 1}</h4>
                </div>
                ${superAdminBulkTasks.length > 1 ? `<button class="bulk-remove-btn" onclick="removeSuperAdminBulkTask(${task.id})">√ó</button>` : ''}
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Task Type</label>
                    <select class="form-input" onchange="updateSuperAdminBulkTask(${task.id}, 'task_type', this.value)">
                        <option value="mathematics" ${task.task_type === 'mathematics' ? 'selected' : ''}>Mathematics</option>
                        <option value="english-language" ${task.task_type === 'english-language' ? 'selected' : ''}>English Language</option>
                        <option value="business-studies" ${task.task_type === 'business-studies' ? 'selected' : ''}>Business Studies</option>
                        <option value="physics" ${task.task_type === 'physics' ? 'selected' : ''}>Physics</option>
                        <option value="chemistry" ${task.task_type === 'chemistry' ? 'selected' : ''}>Chemistry</option>
                        <option value="biology" ${task.task_type === 'biology' ? 'selected' : ''}>Biology</option>
                        <option value="economics" ${task.task_type === 'economics' ? 'selected' : ''}>Economics</option>
                        <option value="technical-engineering" ${task.task_type === 'technical-engineering' ? 'selected' : ''}>Technical Engineering</option>
                        <option value="media-literacy" ${task.task_type === 'media-literacy' ? 'selected' : ''}>Media Literacy</option>
                        <option value="computer" ${task.task_type === 'computer' ? 'selected' : ''}>Computer</option>
                        <option value="humanities" ${task.task_type === 'humanities' ? 'selected' : ''}>Humanities</option>
                        <option value="basic-science" ${task.task_type === 'basic-science' ? 'selected' : ''}>Basic Science</option>
                        <option value="social-studies" ${task.task_type === 'social-studies' ? 'selected' : ''}>Social Studies</option>
                        <option value="quiz" ${task.task_type === 'quiz' ? 'selected' : ''}>Quiz</option>
                        <option value="story" ${task.task_type === 'story' ? 'selected' : ''}>Story</option>
                        <option value="video" ${task.task_type === 'video' ? 'selected' : ''}>Video</option>
                        <option value="debate" ${task.task_type === 'debate' ? 'selected' : ''}>Debate</option>
                        <option value="coding" ${task.task_type === 'coding' ? 'selected' : ''}>Coding</option>
                        <option value="graphics" ${task.task_type === 'graphics' ? 'selected' : ''}>Graphics</option>
                        <option value="video-editing" ${task.task_type === 'video-editing' ? 'selected' : ''}>Video Editing</option>
                        <option value="graphics-design" ${task.task_type === 'graphics-design' ? 'selected' : ''}>Graphics Design</option>
                        <option value="social-media" ${task.task_type === 'social-media' ? 'selected' : ''}>Social Media</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" value="${task.task_title}"
                           onchange="updateSuperAdminBulkTask(${task.id}, 'task_title', this.value)"
                           placeholder="Enter task title">
                </div>

                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="datetime-local" class="form-input" value="${task.due_date}"
                           onchange="updateSuperAdminBulkTask(${task.id}, 'due_date', this.value)">
                </div>

                <div class="form-group">
                    <label class="form-label">Points</label>
                    <input type="number" class="form-input" value="${task.points_reward}" min="0"
                           onchange="updateSuperAdminBulkTask(${task.id}, 'points_reward', parseInt(this.value) || 0)">
                </div>

                <div class="form-group">
                    <label class="form-label">A-Card (‚Ç≥)</label>
                    <input type="number" class="form-input" value="${task.acard_credit}" min="0" step="0.01"
                           onchange="updateSuperAdminBulkTask(${task.id}, 'acard_credit', parseFloat(this.value) || 0)">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input form-textarea"
                          onchange="updateSuperAdminBulkTask(${task.id}, 'task_description', this.value)"
                          placeholder="Enter task description">${task.task_description}</textarea>
            </div>

            <!-- Task Link Configuration -->
            <div class="form-group">
                <label class="form-label">Task Link Configuration</label>
                <div class="link-type-selector">
                    <div class="link-type-description">
                        Choose how students will access this task. You can use internal Deciph.AI files, external links, or common educational platforms.
                    </div>

                    <div class="link-type-tabs">
                        <button type="button" class="link-type-tab ${task.link_type === 'internal' ? 'active' : ''}" data-type="internal" onclick="switchSuperAdminBulkLinkType(${task.id}, 'internal')">
                            üìÅ Internal File
                        </button>
                        <button type="button" class="link-type-tab ${task.link_type === 'external' ? 'active' : ''}" data-type="external" onclick="switchSuperAdminBulkLinkType(${task.id}, 'external')">
                            üîó External Link
                        </button>
                        <button type="button" class="link-type-tab ${task.link_type === 'common' ? 'active' : ''}" data-type="common" onclick="switchSuperAdminBulkLinkType(${task.id}, 'common')">
                            ‚≠ê Common Links
                        </button>
                    </div>

                    <!-- Internal File Option -->
                    <div class="link-option ${task.link_type === 'internal' ? 'active' : ''}" id="superadmin-bulk-internal-option-${task.id}">
                        <input type="text" class="form-input" id="superAdminBulkTaskFile_${task.id}" value="${task.task_file || ''}"
                               onchange="updateSuperAdminBulkTask(${task.id}, 'task_file', this.value)"
                               placeholder="e.g., fractions, algebra, essay-writing">
                        <div class="task-file-section">
                            <div class="task-file-info">
                                üí° <strong>Internal File Usage:</strong> Enter a specific topic/file name for Deciph.AI tasks.
                            </div>
                            <div class="task-file-info">
                                Example: If you enter "fractions", students will be redirected to:
                                <code>https://deciph.ai.deciphersacad.online/fractions</code>
                            </div>
                        </div>
                    </div>

                    <!-- External Link Option -->
                    <div class="link-option ${task.link_type === 'external' ? 'active' : ''}" id="superadmin-bulk-external-option-${task.id}">
                        <input type="url" class="form-input" id="superAdminBulkExternalTaskUrl_${task.id}" value="${task.link_type === 'external' ? (task.external_url || '') : ''}"
                               onchange="updateSuperAdminBulkTask(${task.id}, 'external_url', this.value)"
                               placeholder="https://example.com/your-task-link" oninput="validateSuperAdminBulkExternalUrl(${task.id})">
                        <div class="url-validator empty" id="superAdminBulkUrlValidator_${task.id}">
                            <span>üí° Enter any valid URL (must start with http:// or https://)</span>
                        </div>
                        <div class="external-link-preview" id="superAdminBulkExternalLinkPreview_${task.id}">
                            <div class="preview-header">
                                üîó External Task Preview
                            </div>
                            <div class="preview-url" id="superAdminBulkPreviewUrl_${task.id}"></div>
                        </div>
                    </div>

                    <!-- Common Links Option -->
                    <div class="link-option ${task.link_type === 'common' ? 'active' : ''}" id="superadmin-bulk-common-option-${task.id}">
                        <div class="common-links-grid" id="superAdminBulkCommonLinksGrid_${task.id}">
                            ${getSuperAdminCommonLinksHTML(task.id)}
                        </div>
                        <div style="margin-top: 1rem;">
                            <input type="url" class="form-input" id="superAdminBulkCustomCommonUrl_${task.id}"
                                   onchange="updateSuperAdminBulkTask(${task.id}, 'external_url', this.value)"
                                   placeholder="Or enter a custom URL...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Link (Zoom) for Bulk Task - Optional -->
            <div class="form-group">
                <label class="form-label">Class Link - Zoom (Optional)</label>
                <input type="url" class="form-input" id="superAdminBulkClassLink_${task.id}" value="${task.class_link_url || ''}"
                       onchange="updateSuperAdminBulkTask(${task.id}, 'class_link_url', this.value)"
                       placeholder="https://zoom.us/j/... or any meeting link">
                <div style="margin-top: 0.5rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Class Start Time</label>
                    <input type="datetime-local" class="form-input" id="superAdminBulkClassStartTime_${task.id}" value="${task.class_start_time || ''}"
                           onchange="updateSuperAdminBulkTask(${task.id}, 'class_start_time', this.value)">
                </div>
                <div class="task-file-section" style="margin-top: 0.5rem;">
                    <div class="task-file-info">
                        Optional: Students see a countdown and "Start Lesson" button that activates 5 min before class.
                    </div>
                </div>
            </div>
        `;
        container.appendChild(taskCard);
    });

    // Initialize common links for all tasks after rendering
    superAdminBulkTasks.forEach(task => {
        initializeSuperAdminBulkCommonLinks(task.id);
    });
}

function updateSuperAdminBulkTask(taskId, field, value) {
    const task = superAdminBulkTasks.find(t => t.id === taskId);
    if (task) {
        task[field] = value;
        updateSuperAdminBulkSummary();
    }
}

function renderSuperAdminBulkStudents(searchFilter = '') {
    const grid = document.getElementById('superAdminBulkStudentGrid');
    grid.innerHTML = '';

    // Normalize search filter
    const normalizedFilter = searchFilter.toLowerCase().trim();

    // Filter students based on search term
    const filteredStudents = studentsData.filter(student => {
        // Skip students with null/undefined names
        if (!student.name) return false;

        if (!normalizedFilter) return true; // Show all if no filter

        const studentName = student.name.toLowerCase();
        const studentEmail = (student.email || '').toLowerCase();
        const studentSchool = (student.school_name || '').toLowerCase();

        return studentName.includes(normalizedFilter) ||
               studentEmail.includes(normalizedFilter) ||
               studentSchool.includes(normalizedFilter);
    });

    // Display filtered students
    filteredStudents.forEach(student => {
        const studentCard = document.createElement('div');
        studentCard.className = `bulk-student-card ${superAdminSelectedBulkStudents.has(student.id) ? 'selected' : ''}`;
        studentCard.innerHTML = `
            <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                <input type="checkbox" ${superAdminSelectedBulkStudents.has(student.id) ? 'checked' : ''}
                       onchange="toggleSuperAdminBulkStudent(${student.id})" style="margin-right: 0.75rem;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-600);">Grade ${student.grade_level} ‚Ä¢ ${student.school_name}</div>
                </div>
            </label>
        `;
        grid.appendChild(studentCard);
    });

    // Show count of filtered results
    if (normalizedFilter && filteredStudents.length !== studentsData.length) {
        const resultInfo = document.createElement('div');
        resultInfo.style.cssText = 'grid-column: 1 / -1; text-align: center; color: var(--gray-600); padding: 1rem; font-size: 0.875rem;';
        resultInfo.textContent = `Showing ${filteredStudents.length} of ${studentsData.length} students`;
        grid.appendChild(resultInfo);
    }
}

function filterSuperAdminBulkStudents() {
    const searchInput = document.getElementById('superAdminBulkStudentSearch');
    const searchTerm = searchInput ? searchInput.value : '';
    renderSuperAdminBulkStudents(searchTerm);
}

function toggleSuperAdminBulkStudent(studentId) {
    if (superAdminSelectedBulkStudents.has(studentId)) {
        superAdminSelectedBulkStudents.delete(studentId);
    } else {
        superAdminSelectedBulkStudents.add(studentId);
    }
    renderSuperAdminBulkStudents();
    updateSuperAdminBulkSummary();
}

function selectAllSuperAdminBulkStudents() {
    studentsData.forEach(student => superAdminSelectedBulkStudents.add(student.id));
    renderSuperAdminBulkStudents();
    updateSuperAdminBulkSummary();
}

function deselectAllSuperAdminBulkStudents() {
    superAdminSelectedBulkStudents.clear();
    renderSuperAdminBulkStudents();
    updateSuperAdminBulkSummary();
}

function selectByGradeSuperAdminBulk() {
    const grade = prompt("Enter grade level:");
    if (grade) {
        studentsData.forEach(student => {
            if (student.grade_level === grade) {
                superAdminSelectedBulkStudents.add(student.id);
            }
        });
        renderSuperAdminBulkStudents();
        updateSuperAdminBulkSummary();
    }
}

async function selectBySkillSuperAdminBulk(skill) {
    try {
        showLoading();

        // Fetch quiz-mas registrations for the specified skill
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/super-admin/quiz-mas-registrations?skill=${encodeURIComponent(skill)}`, {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch quiz-mas registrations');
        }

        const data = await response.json();
        const registrations = data.registrations || [];

        // Extract all child names from registrations
        const studentNamesWithSkill = new Set();
        registrations.forEach(reg => {
            if (reg.children && Array.isArray(reg.children)) {
                reg.children.forEach(child => {
                    if (child.name) {
                        // Add normalized name (lowercase, trimmed) for better matching
                        studentNamesWithSkill.add(child.name.toLowerCase().trim());
                    }
                });
            }
        });

        // Match students in studentsData with quiz-mas registrations by name
        let selectedCount = 0;
        studentsData.forEach(student => {
            if (!student.name) return; // Skip students with null/undefined names
            const studentName = student.name.toLowerCase().trim();
            if (studentNamesWithSkill.has(studentName)) {
                superAdminSelectedBulkStudents.add(student.id);
                selectedCount++;
            }
        });

        hideLoading();

        if (selectedCount > 0) {
            showNotification(`‚úÖ Selected ${selectedCount} students with ${skill} skill`, 'success');
        } else {
            showNotification(`‚ÑπÔ∏è No students found with ${skill} skill`, 'info');
        }

        renderSuperAdminBulkStudents();
        updateSuperAdminBulkSummary();

    } catch (error) {
        console.error('Error selecting students by skill:', error);
        hideLoading();
        showNotification('Failed to select students by skill. Please try again.', 'error');
    }
}

function updateSuperAdminBulkSummary() {
    const summary = document.getElementById('superAdminBulkAssignmentSummary');
    const assignBtn = document.getElementById('superAdminBulkAssignBtn');

    const validTasks = superAdminBulkTasks.filter(t => t.task_title && t.task_type);
    const totalStudents = superAdminSelectedBulkStudents.size;
    const totalAssignments = validTasks.length * totalStudents;

    document.getElementById('superAdminBulkTotalTasks').textContent = validTasks.length;
    document.getElementById('superAdminBulkTotalStudents').textContent = totalStudents;
    document.getElementById('superAdminBulkTotalAssignments').textContent = totalAssignments;

    summary.style.display = totalAssignments > 0 ? 'block' : 'none';
    assignBtn.disabled = totalAssignments === 0;
}

// Super Admin Bulk Task Link Configuration Functions
function switchSuperAdminBulkLinkType(taskId, type) {
    const task = superAdminBulkTasks.find(t => t.id === taskId);
    if (task) {
        task.link_type = type;
        renderSuperAdminBulkTasks();
    }
}

function getSuperAdminCommonLinksHTML(taskId) {
    return ''; // Placeholder, will be populated by initializeSuperAdminBulkCommonLinks
}

function initializeSuperAdminBulkCommonLinks(taskId) {
    const commonLinks = [
        {
            name: 'Khan Academy Math',
            url: 'https://www.khanacademy.org/math',
            description: 'Math lessons and exercises'
        },
        {
            name: 'Coursera',
            url: 'https://www.coursera.org',
            description: 'Online courses'
        },
        {
            name: 'edX',
            url: 'https://www.edx.org',
            description: 'University-level courses'
        },
        {
            name: 'Duolingo',
            url: 'https://www.duolingo.com',
            description: 'Language learning'
        },
        {
            name: 'Code.org',
            url: 'https://code.org',
            description: 'Coding tutorials'
        },
        {
            name: 'TED-Ed',
            url: 'https://ed.ted.com',
            description: 'Educational videos'
        },
        {
            name: 'NASA Education',
            url: 'https://www.nasa.gov/stem',
            description: 'STEM resources'
        },
        {
            name: 'National Geographic Kids',
            url: 'https://kids.nationalgeographic.com',
            description: 'Science and nature'
        }
    ];

    const grid = document.getElementById(`superAdminBulkCommonLinksGrid_${taskId}`);
    if (!grid) return;

    grid.innerHTML = '';

    commonLinks.forEach(link => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'common-link-btn';
        btn.onclick = () => selectSuperAdminCommonLink(taskId, btn, link.url);
        btn.innerHTML = `
            <div class="common-link-name">${link.name}</div>
            <div class="common-link-url">${link.url}</div>
            <div class="common-link-description">${link.description}</div>
        `;
        grid.appendChild(btn);
    });
}

function selectSuperAdminCommonLink(taskId, button, url) {
    const wasSelected = button.classList.contains('selected');

    // Clear all selections in this task's grid
    const grid = document.getElementById(`superAdminBulkCommonLinksGrid_${taskId}`);
    if (grid) {
        grid.querySelectorAll('.common-link-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
    }

    // Clear custom URL input
    const customInput = document.getElementById(`superAdminBulkCustomCommonUrl_${taskId}`);
    if (customInput) customInput.value = '';

    // Toggle selection
    if (!wasSelected) {
        button.classList.add('selected');
        updateSuperAdminBulkTask(taskId, 'external_url', url);
    } else {
        updateSuperAdminBulkTask(taskId, 'external_url', '');
    }
}

function validateSuperAdminBulkExternalUrl(taskId) {
    const input = document.getElementById(`superAdminBulkExternalTaskUrl_${taskId}`);
    const validator = document.getElementById(`superAdminBulkUrlValidator_${taskId}`);
    const preview = document.getElementById(`superAdminBulkExternalLinkPreview_${taskId}`);
    const previewUrl = document.getElementById(`superAdminBulkPreviewUrl_${taskId}`);

    if (!input || !validator) return;

    const url = input.value.trim();

    if (!url) {
        validator.className = 'url-validator empty';
        validator.innerHTML = '<span>üí° Enter any valid URL (must start with http:// or https://)</span>';
        if (preview) preview.classList.remove('show');
        return;
    }

    try {
        const urlObj = new URL(url);
        if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
            validator.className = 'url-validator valid';
            validator.innerHTML = '<span>‚úÖ Valid URL</span>';
            if (previewUrl) previewUrl.textContent = url;
            if (preview) preview.classList.add('show');
        } else {
            throw new Error('Invalid protocol');
        }
    } catch (error) {
        validator.className = 'url-validator invalid';
        validator.innerHTML = '<span>‚ùå Please enter a valid URL starting with http:// or https://</span>';
        if (preview) preview.classList.remove('show');
    }
}

function getSuperAdminBulkTaskLinkConfig(taskId) {
    const task = superAdminBulkTasks.find(t => t.id === taskId);
    if (!task) return null;

    let config = { type: task.link_type };

    switch (task.link_type) {
        case 'internal':
            const taskFile = task.task_file?.trim();
            if (taskFile) {
                config.task_file = taskFile;
                config.external_url = `https://deciph.ai.deciphersacad.online/${taskFile}`;
            }
            break;

        case 'external':
            const externalUrl = task.external_url?.trim();
            if (externalUrl) {
                try {
                    new URL(externalUrl); // Validate URL
                    config.external_url = externalUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;

        case 'common':
            const commonUrl = task.external_url?.trim();
            if (commonUrl) {
                try {
                    new URL(commonUrl); // Validate URL
                    config.external_url = commonUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;
    }

    return config;
}

async function performSuperAdminBulkAssignment() {
    const validTasks = superAdminBulkTasks.filter(t => t.task_title && t.task_type);
    const selectedStudentIds = Array.from(superAdminSelectedBulkStudents);

    if (validTasks.length === 0) {
        showNotification('Please create at least one valid task', 'error');
        return;
    }

    if (selectedStudentIds.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    showLoading();
    try {
        const bulkData = {
            tasks: validTasks.map(task => {
                let taskData = {};

                // Check for link configuration
                const linkConfig = getSuperAdminBulkTaskLinkConfig(task.id);

                if (linkConfig && (linkConfig.external_url || linkConfig.task_file)) {
                    // Use link configuration from the bulk task
                    if (linkConfig.task_file) {
                        taskData.task_file = linkConfig.task_file;
                    }
                    if (linkConfig.external_url) {
                        taskData.external_url = linkConfig.external_url;
                    }
                    taskData.link_type = linkConfig.type;
                    taskData.is_external = true;
                }

                // Add class link data if provided
                if (task.class_link_url) {
                    taskData.class_link = {
                        url: task.class_link_url,
                        start_time: task.class_start_time || null
                    };
                    taskData.has_class_link = true;
                    if (!taskData.is_external) {
                        taskData.is_external = true;
                    }
                }

                return {
                    task_type: task.task_type,
                    task_title: task.task_title,
                    task_description: task.task_description,
                    points_reward: task.points_reward || 0,
                    acard_credit: task.acard_credit || 0,
                    due_date: task.due_date || null,
                    task_data: taskData
                };
            }),
            student_ids: selectedStudentIds
        };

        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/bulk-assign-tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(bulkData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(
                `‚úÖ Successfully assigned ${result.total_assignments} tasks to ${result.students_count} students!`,
                'success'
            );

            // Reset bulk form
            superAdminBulkTasks = [];
            superAdminSelectedBulkStudents.clear();
            superAdminBulkTaskCounter = 0;
            addSuperAdminBulkTask();
            renderSuperAdminBulkStudents();
            updateSuperAdminBulkSummary();
        } else {
            const error = await response.json();
            console.error('Bulk assignment failed:', error);
            throw new Error(error.error || 'Failed to assign tasks');
        }
    } catch (error) {
        console.error('Error in bulk assignment:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

console.log('‚úÖ Super Admin Bulk Task Assignment Module Loaded');
        </script>
    <!-- Edit Task Modal -->
<div class="modal" id="editTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Task</h3>
            <button class="modal-close" data-modal="editTaskModal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" id="editTaskTitle" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="datetime-local" class="form-input" id="editDueDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Points Reward</label>
                        <input type="number" class="form-input" id="editPointsReward" min="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">A-Card Credit (‚Ç≥)</label>
                        <input type="number" class="form-input" id="editAcardCredit" min="0" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Task Link Type</label>
                    <select class="form-input" id="editTaskLinkType">
                        <option value="internal">Internal Task (deciph.ai.deciphersacad.online)</option>
                        <option value="external">External Link</option>
                    </select>
                    
                    <div id="editInternalSection" class="edit-link-section">
                        <div class="edit-link-info">Internal Deciph.AI task file</div>
                        <input type="text" class="form-input" id="editTaskFile" placeholder="e.g., fractions, algebra">
                    </div>
                    
                    <div id="editExternalSection" class="edit-link-section" style="display: none;">
                        <div class="edit-link-info">External website URL</div>
                        <input type="url" class="form-input" id="editExternalLink" placeholder="https://example.com">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Task Description</label>
                    <textarea class="form-input form-textarea" id="editTaskDescription" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" form="editTaskForm" class="btn btn-primary">
                üíæ Save Changes
            </button>
            <button class="btn btn-secondary" data-modal="editTaskModal">
                ‚ùå Cancel
            </button>
        </div>
    </div>
</div>

<!-- Resource View Modal -->
<div class="modal" id="resourceViewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Resource Details</h3>
            <button class="modal-close" onclick="closeModal('resourceViewModal')">&times;</button>
        </div>
        <div class="modal-body" id="resourceViewModalBody">
            <!-- Resource details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('resourceViewModal')">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Resource Edit Modal -->
<div class="modal" id="resourceEditModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Resource</h3>
            <button class="modal-close" onclick="closeModal('resourceEditModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editResourceForm">
                <input type="hidden" id="editResourceId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Resource Title</label>
                        <input type="text" class="form-input" id="editResourceTitle" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Resource Type</label>
                        <select class="form-input" id="editResourceType" required onchange="handleEditResourceTypeChange()">
                            <option value="internal_file">Internal File (Deciph.AI)</option>
                            <option value="external_link">External Link</option>
                            <option value="common_link">Common Link</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Subject Category</label>
                        <select class="form-input" id="editResourceSubject" required>
                            <option value="mathematics">Mathematics</option>
                            <option value="english">English</option>
                            <option value="science">Science</option>
                            <option value="history">History</option>
                            <option value="computer">Computer</option>
                            <option value="general">General</option>
                        </select>
                    </div>

                    <div class="form-group" id="editTaskFileGroup">
                        <label class="form-label">Task File Name</label>
                        <input type="text" class="form-input" id="editResourceTaskFile" placeholder="e.g., fractions, algebra">
                        <small style="color: var(--gray-600); margin-top: 0.25rem; display: block;">
                            Will create: https://deciph.ai.deciphersacad.online/<strong>[filename]</strong>
                        </small>
                    </div>

                    <div class="form-group" id="editResourceUrlGroup">
                        <label class="form-label">Resource URL</label>
                        <input type="url" class="form-input" id="editResourceUrl" placeholder="https://example.com/resource">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="editResourceDescription" rows="3" placeholder="Describe this resource..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="editResourceStatus">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" form="editResourceForm" class="btn btn-primary">
                üíæ Save Changes
            </button>
            <button class="btn btn-secondary" onclick="closeModal('resourceEditModal')">
                ‚ùå Cancel
            </button>
        </div>
    </div>
</div>

<style>
/* Messages Page Styles */
.msg-tab {
    background: none;
    border: none;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #7f8c8d;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}
.msg-tab:hover { color: #2c3e50; }
.msg-tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
.msg-tab-content { display: none; }
.msg-tab-content.active { display: block; }
.msg-count-badge {
    background: #e74c3c; color: #fff; padding: 2px 7px;
    border-radius: 10px; font-size: 11px; font-weight: 700; margin-left: 4px;
}
.msg-student-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 18px; background: #fff; border-bottom: 1px solid #eee;
    cursor: pointer; transition: background 0.15s;
}
.msg-student-item:hover { background: #f8f9fa; }
.msg-student-name { font-weight: 600; color: #2c3e50; font-size: 15px; }
.msg-student-email { font-size: 13px; color: #7f8c8d; }
.msg-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 18px; background: #fff; border-bottom: 1px solid #eee;
    cursor: pointer; transition: background 0.15s;
}
.msg-item:hover { background: #f8f9fa; }
.msg-item.unread { background: #f0f4ff; border-left: 3px solid #667eea; }
.msg-item-sender { font-weight: 600; color: #2c3e50; font-size: 14px; }
.msg-item-subject { font-size: 14px; color: #34495e; margin-top: 3px; }
.msg-item-preview { font-size: 13px; color: #95a5a6; margin-top: 3px; }
.msg-item-time { font-size: 12px; color: #95a5a6; white-space: nowrap; }
.msg-unread-dot { width: 9px; height: 9px; border-radius: 50%; background: #667eea; display: inline-block; }
.conv-bubble {
    max-width: 75%; padding: 12px 16px; border-radius: 12px;
    font-size: 14px; line-height: 1.5;
}
.conv-bubble.sent {
    align-self: flex-end; background: #667eea; color: #fff;
    border-bottom-right-radius: 4px;
}
.conv-bubble.received {
    align-self: flex-start; background: #fff; color: #2c3e50;
    border: 1px solid #e1e5e9; border-bottom-left-radius: 4px;
}
.conv-bubble-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 4px; gap: 12px; font-size: 12px;
}
.conv-bubble.sent .conv-bubble-header { color: rgba(255,255,255,0.8); }
.conv-bubble.received .conv-bubble-header { color: #667eea; }
.conv-bubble-body { white-space: pre-wrap; }
</style>

<script>
// ============================================
// Super-Admin Messaging Functions
// ============================================
const MSG_API_BASE = 'https://seashell-app-onfk3.ondigitalocean.app';
let currentConversationStudentId = null;

function getMsgHeaders() {
    const token = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token') || getCookie('admin_token');
    return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
}

async function loadMessagesPage() {
    searchStudentsForMessages();
    loadMsgUnreadCount();
}

async function loadMsgUnreadCount() {
    try {
        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/unread-count`, { headers: getMsgHeaders() });
        const data = await res.json();
        const count = data.unread_count || 0;
        const badge = document.getElementById('msgCountBadge');
        const unreadBadge = document.getElementById('msgUnreadBadge');
        if (count > 0) {
            if (badge) { badge.textContent = count; badge.style.display = 'inline'; }
            if (unreadBadge) { unreadBadge.textContent = count + ' unread'; unreadBadge.style.display = 'inline'; }
        } else {
            if (badge) badge.style.display = 'none';
            if (unreadBadge) unreadBadge.style.display = 'none';
        }
    } catch (err) { console.error('Unread count error:', err); }
}

function switchMsgTab(tab) {
    document.querySelectorAll('.msg-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.msg-tab-content').forEach(c => c.classList.remove('active'));
    const tabBtn = document.querySelector(`.msg-tab[data-msg-tab="${tab}"]`);
    const tabContent = document.getElementById(`msg-${tab}-tab`);
    if (tabBtn) tabBtn.classList.add('active');
    if (tabContent) tabContent.classList.add('active');

    if (tab === 'students') searchStudentsForMessages();
    else if (tab === 'inbox') loadMsgInbox();
    else if (tab === 'sent') loadMsgSent();
    else if (tab === 'conversation' && currentConversationStudentId) loadConversation(currentConversationStudentId);
}

async function searchStudentsForMessages() {
    const search = document.getElementById('studentSearchInput')?.value || '';
    try {
        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/students?search=${encodeURIComponent(search)}`, { headers: getMsgHeaders() });
        const data = await res.json();
        const list = document.getElementById('msgStudentsList');
        if (!data.students || data.students.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:#95a5a6;">No students found</div>';
            return;
        }
        list.innerHTML = data.students.map(s => `
            <div class="msg-student-item" onclick="openStudentConversation(${s.id}, '${(s.name || 'Student').replace(/'/g, "\\'")}')">
                <div>
                    <div class="msg-student-name">${s.name || 'Unnamed'}</div>
                    <div class="msg-student-email">${s.email}${s.grade_level ? ' | Grade ' + s.grade_level : ''}</div>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    ${s.unread_count > 0 ? '<span style="background:#e74c3c;color:#fff;padding:2px 8px;border-radius:10px;font-size:12px;">' + s.unread_count + ' new</span>' : ''}
                    ${s.last_message_at ? '<span style="font-size:12px;color:#95a5a6;">' + new Date(s.last_message_at).toLocaleDateString() + '</span>' : ''}
                    <button class="btn btn-primary" style="padding:6px 14px;font-size:12px;" onclick="event.stopPropagation();showComposeMessageTo(${s.id},'${(s.name || 'Student').replace(/'/g, "\\'")}')">Message</button>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error('Search students error:', err);
        document.getElementById('msgStudentsList').innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c;">Failed to load students</div>';
    }
}

async function loadMsgInbox() {
    const list = document.getElementById('msgInboxList');
    list.innerHTML = '<div style="text-align:center;padding:30px;color:#95a5a6;">Loading...</div>';
    try {
        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/inbox`, { headers: getMsgHeaders() });
        const data = await res.json();
        if (!data.messages || data.messages.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:#95a5a6;">No messages in inbox</div>';
            return;
        }
        list.innerHTML = data.messages.map(m => `
            <div class="msg-item ${!m.is_read ? 'unread' : ''}" onclick="openStudentConversation(${m.sender_id}, '${(m.sender_name || 'Student').replace(/'/g, "\\'")}')">
                <div style="flex:1;min-width:0;">
                    <div class="msg-item-sender">${m.sender_name}</div>
                    <div class="msg-item-subject">${m.subject}</div>
                    <div class="msg-item-preview">${m.message_body.length > 100 ? m.message_body.substring(0, 100) + '...' : m.message_body}</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;margin-left:12px;">
                    <span class="msg-item-time">${m.time_ago}</span>
                    ${!m.is_read ? '<span class="msg-unread-dot"></span>' : ''}
                </div>
            </div>
        `).join('');
    } catch (err) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c;">Failed to load inbox</div>';
    }
}

async function loadMsgSent() {
    const list = document.getElementById('msgSentList');
    list.innerHTML = '<div style="text-align:center;padding:30px;color:#95a5a6;">Loading...</div>';
    try {
        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/sent`, { headers: getMsgHeaders() });
        const data = await res.json();
        if (!data.messages || data.messages.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:#95a5a6;">No sent messages</div>';
            return;
        }
        list.innerHTML = data.messages.map(m => `
            <div class="msg-item">
                <div style="flex:1;min-width:0;">
                    <div class="msg-item-sender">To: ${m.recipient_name}</div>
                    <div class="msg-item-subject">${m.subject}</div>
                    <div class="msg-item-preview">${m.message_body.length > 100 ? m.message_body.substring(0, 100) + '...' : m.message_body}</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;margin-left:12px;">
                    <span class="msg-item-time">${m.time_ago}</span>
                    ${m.is_broadcast ? '<span style="background:#3498db;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">Broadcast</span>' : ''}
                </div>
            </div>
        `).join('');
    } catch (err) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c;">Failed to load sent messages</div>';
    }
}

function openStudentConversation(studentId, studentName) {
    currentConversationStudentId = studentId;
    document.getElementById('conversationTitle').textContent = 'Conversation with ' + studentName;
    document.getElementById('conversationTab').style.display = 'inline-block';
    switchMsgTab('conversation');
}

async function loadConversation(studentId) {
    const container = document.getElementById('conversationMessages');
    container.innerHTML = '<div style="text-align:center;padding:30px;color:#95a5a6;">Loading...</div>';
    try {
        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/conversation/${studentId}`, { headers: getMsgHeaders() });
        const data = await res.json();
        if (!data.messages || data.messages.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#95a5a6;">No messages yet. Start the conversation!</div>';
            return;
        }
        container.innerHTML = data.messages.map(m => `
            <div class="conv-bubble ${m.sender_type === 'super_admin' ? 'sent' : 'received'}">
                <div class="conv-bubble-header">
                    <span style="font-weight:600;">${m.sender_name}</span>
                    <span>${m.time_ago}</span>
                </div>
                ${m.subject && m.subject !== 'Reply' ? '<div style="font-weight:600;margin-bottom:4px;font-size:13px;">' + m.subject + '</div>' : ''}
                <div class="conv-bubble-body">${m.message_body}</div>
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
        loadMsgUnreadCount();
    } catch (err) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#e74c3c;">Failed to load conversation</div>';
    }
}

async function sendConversationReply(e) {
    e.preventDefault();
    const input = document.getElementById('conversationReplyInput');
    const btn = document.getElementById('conversationSendBtn');
    const text = input.value.trim();
    if (!text || !currentConversationStudentId) return;

    btn.disabled = true;
    btn.textContent = 'Sending...';
    try {
        await fetch(`${MSG_API_BASE}/api/messages/admin/send`, {
            method: 'POST',
            headers: getMsgHeaders(),
            body: JSON.stringify({
                recipient_id: currentConversationStudentId,
                subject: 'Reply',
                message_body: text,
                message_type: 'general',
                priority: 'normal',
                is_broadcast: false
            })
        });
        input.value = '';
        loadConversation(currentConversationStudentId);
    } catch (err) {
        alert('Failed to send message');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Send';
    }
}

async function showComposeMessage() {
    const modal = document.getElementById('composeMessageModal');
    modal.style.display = 'flex';
    document.getElementById('composeModalTitle').textContent = 'New Message';
    document.getElementById('recipientField').style.display = 'block';
    document.getElementById('composeBroadcast').value = 'false';
    document.getElementById('composeSubject').value = '';
    document.getElementById('composeBody').value = '';
    document.getElementById('composeError').style.display = 'none';
    document.getElementById('composeSuccess').style.display = 'none';

    // Load students into the dropdown
    try {
        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/students`, { headers: getMsgHeaders() });
        const data = await res.json();
        const select = document.getElementById('composeRecipient');
        select.innerHTML = '<option value="">-- Select a student --</option>';
        (data.students || []).forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.name || 'Unnamed'} (${s.email})</option>`;
        });
    } catch (err) { console.error('Failed to load students for compose:', err); }
}

function showComposeMessageTo(studentId, studentName) {
    showComposeMessage().then(() => {
        document.getElementById('composeRecipient').value = studentId;
    });
}

function showBroadcastMessage() {
    const modal = document.getElementById('composeMessageModal');
    modal.style.display = 'flex';
    document.getElementById('composeModalTitle').textContent = 'Broadcast to All Students';
    document.getElementById('recipientField').style.display = 'none';
    document.getElementById('composeBroadcast').value = 'true';
    document.getElementById('composeSubject').value = '';
    document.getElementById('composeBody').value = '';
    document.getElementById('composeError').style.display = 'none';
    document.getElementById('composeSuccess').style.display = 'none';
}

function closeComposeModal() {
    document.getElementById('composeMessageModal').style.display = 'none';
}

async function handleSendMessage(e) {
    e.preventDefault();
    const isBroadcast = document.getElementById('composeBroadcast').value === 'true';
    const recipientId = document.getElementById('composeRecipient').value;
    const subject = document.getElementById('composeSubject').value.trim();
    const body = document.getElementById('composeBody').value.trim();
    const type = document.getElementById('composeType').value;
    const priority = document.getElementById('composePriority').value;
    const errorEl = document.getElementById('composeError');
    const successEl = document.getElementById('composeSuccess');
    const btn = document.getElementById('composeSendBtn');

    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    if (!subject || !body) {
        errorEl.textContent = 'Subject and message are required';
        errorEl.style.display = 'block';
        return;
    }
    if (!isBroadcast && !recipientId) {
        errorEl.textContent = 'Please select a student';
        errorEl.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Sending...';

    try {
        const payload = {
            subject, message_body: body,
            message_type: type, priority,
            is_broadcast: isBroadcast
        };
        if (!isBroadcast) payload.recipient_id = parseInt(recipientId);

        const res = await fetch(`${MSG_API_BASE}/api/messages/admin/send`, {
            method: 'POST',
            headers: getMsgHeaders(),
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            successEl.textContent = isBroadcast ? 'Broadcast sent to all students!' : 'Message sent successfully!';
            successEl.style.display = 'block';
            setTimeout(() => closeComposeModal(), 1500);
        } else {
            errorEl.textContent = data.error || 'Failed to send message';
            errorEl.style.display = 'block';
        }
    } catch (err) {
        errorEl.textContent = 'Failed to send message';
        errorEl.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Send Message';
    }
}

// Poll for unread messages every 30 seconds
setInterval(loadMsgUnreadCount, 30000);
// Initial load
setTimeout(loadMsgUnreadCount, 2000);

console.log('Messaging functions loaded for super admin');
</script>

</body>
</html>