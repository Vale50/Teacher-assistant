<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry Quiz Creator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìê</text></svg>" type="image/svg+xml">
<link rel="stylesheet" href="edit-question.css">

    <style>
        /* Root Variables.*/
        :root {
            --primary-color: #10B981;
            --primary-dark: #059669;
            --secondary-color: #F59E0B;
            --accent-color: #3B82F6;
            --text-color: #1F2937;
            --light-bg: #F3F4F6;
            --white: #FFFFFF;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
            --form-shadow: 
                0 2.8px 2.2px rgba(0, 0, 0, 0.034),
                0 6.7px 5.3px rgba(0, 0, 0, 0.048),
                0 12.5px 10px rgba(0, 0, 0, 0.06);
            --bg-color: #f0f2f5;
        }

        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            min-height: 100vh;
        }

        /* Header Styles */
        header {
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition);
        }
        
        .user-info:hover {
            background-color: var(--light-bg);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-name {
            font-weight: 600;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
        }
        
        .nav-link:hover {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 2rem;
            background-color: var(--white);
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            width: 200px;
            z-index: 100;
            overflow: hidden;
            display: none;
        }
        
        .dropdown-menu.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-color);
            transition: var(--transition);
        }
        
        .dropdown-item:hover {
            background-color: var(--light-bg);
        }
        
        .dropdown-item i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        /* Container Styles */
        .container {
            max-width: 1600px;
            margin: 20px auto;
            background: linear-gradient(145deg, #ffffff, #f6f7f9);
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--form-shadow);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        h1, h2, h3, h4 {
            margin-bottom: 15px;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Question Type Styles */
        .question-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .type-checkbox {
            display: none;
        }

        .type-label {
            display: block;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .type-checkbox:checked + .type-label {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* Geometry Section */
        .geometry-section {
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(16, 185, 129, 0.02);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 1.2em;
        }

        .toggle-section-btn {
            background: var(--light-bg);
            border: 1px solid #240c0c;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-section-btn:hover {
            background: #e0e0e0;
        }

        /* Geometry Type Styles */
        .geometry-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .geometry-type-checkbox {
            display: none;
        }

        .geometry-type-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
            min-height: 120px;
        }

        .geometry-type-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .geometry-type-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .geometry-type-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .geometry-type-checkbox:checked + .geometry-type-label {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
        }

        .geometry-type-checkbox:checked + .geometry-type-label .geometry-type-icon {
            color: var(--primary-color);
        }

        /* Show More Button */
        .show-more-btn {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .show-more-btn:hover {
            background: linear-gradient(135deg, #dcedc8, #aed581);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
        }

        /* Mode Selector Styles */
        .mode-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-option {
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        /* Button Styles */
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transform: translateY(0);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(1px);
        }

        /* Nav Button Styles */
        .nav-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-button {
            flex: 1;
            min-width: 120px;
            background: linear-gradient(18deg, #10B981, #34D399);
            color: white;
            padding: 12px;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Loading and Status Styles */
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error-message {
            color: #f44336;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #ffebee;
            display: none;
        }

        /* Quiz Preview Styles */
        .quiz-preview {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: none;
        }

        .question-preview {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .question-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .question-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: auto;
        }

        .options-preview {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-preview {
            padding: 8px 12px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .correct-option {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        /* Quiz Link Styles */
        .quiz-link {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            display: none;
        }

        .quiz-url {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .quiz-url input {
            flex: 1;
            min-width: 200px;
        }

        .quiz-url button {
            width: auto;
            padding: 10px 20px;
        }

        /* Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Media Queries */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
                border-radius: 15px;
            }

            .form-group {
                padding: 15px;
                margin-bottom: 15px;
            }

            .header-container {
                flex-wrap: wrap;
                padding: 10px;
            }
            
            .nav-links {
                order: 3;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }

            .question-types, .geometry-types {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .type-label, .geometry-type-label {
                padding: 12px 8px;
                font-size: 14px;
            }

            input[type="text"],
            input[type="number"],
            select,
            textarea {
                padding: 10px;
                font-size: 14px;
            }

            button {
                padding: 12px;
                font-size: 14px;
            }

            .nav-button {
                padding: 10px;
                font-size: 14px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            .user-menu {
                margin-left: auto;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .dropdown-menu {
                right: 10px;
                width: 180px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .form-group {
                padding: 12px;
            }

            .geometry-types {
                grid-template-columns: 1fr;
            }

            .nav-container {
                flex-direction: column;
            }

            .nav-button {
                width: 100%;
            }
            
            .header-container {
                padding: 8px;
            }
            
            .user-name {
                display: none;
            }
            
            .nav-link {
                font-size: 14px;
                padding: 4px 0;
            }

        .collapsed-items {
            display: none;
        }

        .collapsed-items.show {
            display: contents;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-collapsed {
            opacity: 0.6;
        }

        .section-content {
            transition: all 0.3s ease;
        }

        .section-content.collapsed {
            display: none;
        }
        }
        .geometry-types {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
}
/* Enhanced Grid Layout for Geometry Types */
.geometry-types {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

/* Ensure collapsed items integrate properly into the grid */
.collapsed-items {
    display: none;
    grid-column: 1 / -1; /* Span all columns */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}

.collapsed-items.show {
    display: grid;
}

/* Show More Button spans full width */
.show-more-btn {
    grid-column: 1 / -1; /* Span all columns */
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--primary-color);
    font-weight: 600;
    margin-top: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Ensure responsive behavior */
@media (max-width: 768px) {
    .geometry-types {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .collapsed-items {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}

@media (max-width: 480px) {
    .geometry-types {
        grid-template-columns: 1fr 1fr;
    }
    
    .collapsed-items {
        grid-template-columns: 1fr 1fr;
    }
}
/* Shape container styling */
.shape-container {
    margin: 15px 0;
    padding: 15px;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    text-align: center;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 150px;
}

.shape-container svg {
    max-width: 100%;
    height: auto;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-radius: 6px;
}

/* Question preview styling */
.question-preview .question-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.question-preview .shape-container {
    background-color: #ffffff;
    border: 2px solid #e5e7eb;
    margin: 10px 0;
}

/* Enhanced question container for shapes */
.question-container {
    position: relative;
}

.question-container .shape-container {
    margin-top: 10px;
    margin-bottom: 15px;
}

/* Math notation improvements */
.math-notation {
    font-family: 'Times New Roman', serif;
    font-style: normal;
}

/* Improved mathematical symbols */
.mathematical-expression {
    display: inline-block;
    vertical-align: middle;
    font-family: 'Times New Roman', 'DejaVu Serif', serif;
    font-size: 1.1em;
}

/* Superscript styling */
.superscript {
    position: relative;
    top: -0.5em;
    font-size: 0.8em;
    vertical-align: super;
}

/* Subscript styling */
.subscript {
    position: relative;
    top: 0.5em;
    font-size: 0.8em;
    vertical-align: sub;
}

/* Fraction styling */
.fraction {
    display: inline-block;
    vertical-align: middle;
    text-align: center;
    font-family: 'Times New Roman', serif;
}

.fraction .numerator {
    display: block;
    border-bottom: 1px solid #333;
    padding-bottom: 2px;
}

.fraction .denominator {
    display: block;
    padding-top: 2px;
}

/* Special mathematical symbols */
.math-symbol {
    font-family: 'Arial Unicode MS', 'DejaVu Sans', sans-serif;
    font-size: 1.1em;
}

/* SVG shape styling improvements */
.shape-container svg {
    transition: transform 0.3s ease;
}

.shape-container svg:hover {
    transform: scale(1.05);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .shape-container {
        min-height: 120px;
        padding: 10px;
    }
    
    .shape-container svg {
        max-width: 90%;
    }
}

/* Quiz preview specific styling */
.quiz-preview .shape-container {
    background-color: #fafbfc;
    border: 1px solid #d1d5db;
}

/* Auto-navigation mode shape container */
#current-question .shape-container {
    margin: 20px 0;
    background-color: #ffffff;
    border: 2px solid #10b981;
    border-radius: 12px;
}

/* Shape visibility animation */
.shape-container {
    opacity: 0;
    animation: fadeInShape 0.5s ease-in-out forwards;
}

@keyframes fadeInShape {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Enhanced MathJax styling */
.MathJax {
    color: inherit !important;
}

/* Ensure proper math rendering in options */
.option-container .MathJax {
    display: inline !important;
}

/* Question text with math notation */
.question-text .MathJax {
    margin: 0 2px;
}

/* Mathematical expression wrapper */
.math-expression {
    background-color: rgba(16, 185, 129, 0.05);
    border-radius: 4px;
    padding: 2px 4px;
    margin: 0 2px;
    font-weight: 500;
}
/* Shape container styles */
.shape-preview-container,
.student-shape-container,
.current-question-shape-container {
    margin: 15px 0;
    padding: 15px;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    text-align: center;
    min-height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.geometry-shape-container {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.geometry-shape-image {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
}

.shape-info h4 {
    color: var(--primary-color);
    margin: 10px 0 5px 0;
    font-size: 1.1em;
}

.measurement-list {
    margin-top: 8px;
    font-size: 0.9em;
}

.measurement-item {
    margin: 3px 0;
}

.measurement-label {
    font-weight: 500;
    color: #374151;
}

.measurement-value {
    font-weight: 600;
    color: var(--primary-color);
    margin-left: 5px;
}

/* Loading and error styles */
.geometry-loading {
    padding: 20px;
    text-align: center;
    color: #6B7280;
}

.loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

.geometry-error {
    padding: 15px;
    text-align: center;
    color: #dc2626;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 6px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ADD to your existing CSS: */
.shape-container {
    margin: 15px 0;
    min-height: 100px;
    border-radius: 8px;
    overflow: hidden;
}

.geometry-shape-display img:hover {
    transform: scale(1.02);
    transition: transform 0.2s ease;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* ==================== PRINT FEATURE STYLES ==================== */

/* Action Buttons Container */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.action-buttons button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-print-preview {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
}

.btn-print-preview:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
}

.btn-print-direct {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    box-shadow: 0 4px 6px rgba(79, 172, 254, 0.3);
}

.btn-print-direct:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(79, 172, 254, 0.4);
}

/* Print Modal Styles */
.print-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.print-modal.active {
    display: flex;
}

.print-modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.print-modal-header {
    padding: 20px 30px;
    border-bottom: 2px solid var(--light-bg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
    border-radius: 16px 16px 0 0;
}

.print-modal-header h2 {
    margin: 0;
    font-size: 24px;
}

.close-modal-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.close-modal-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.print-modal-body {
    padding: 30px;
    max-height: calc(90vh - 160px);
    overflow-y: auto;
}

.print-modal-footer {
    padding: 20px 30px;
    border-top: 2px solid var(--light-bg);
    display: flex;
    gap: 15px;
    justify-content: space-between;
    background: var(--light-bg);
    border-radius: 0 0 16px 16px;
}

.modal-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
}

.modal-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
}

.modal-btn-secondary {
    background: white;
    color: var(--text-color);
    border: 2px solid var(--light-bg);
}

.modal-btn-secondary:hover {
    background: var(--light-bg);
}

/* Edit Mode Styles */
.edit-mode-btn {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.edit-mode-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
}

.save-edit-btn {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}

.save-edit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
}

.cancel-edit-btn {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
}

.cancel-edit-btn:hover {
    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
}

/* Editable field styling */
.editable-field {
    border: 2px dashed transparent;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    cursor: text;
    min-height: 20px;
}

.editable-field:hover {
    border-color: #e3f2fd;
    background-color: #f5f5f5;
}

.editable-field:focus {
    outline: none;
    border-color: var(--primary-color);
    background-color: #fff;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.editable-field:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
}

/* Edit mode indicator */
.edit-mode {
    position: relative;
}

.edit-mode::before {
    content: '‚úèÔ∏è EDIT MODE - Click any text to edit';
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
    color: #000;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    z-index: 10;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    font-size: 14px;
}

/* Action buttons in edit mode */
.add-item-btn {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    margin: 10px 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
}

.add-item-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
}

.delete-question-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
}

.delete-question-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}

/* Save success message */
.save-success-message {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    animation: slideDown 0.3s ease;
    transition: opacity 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Print Preview Content Styles */
.print-preview-content {
    background: white;
    padding: 40px;
}

.print-quiz-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid var(--primary-color);
}

.print-quiz-title {
    font-size: 28px;
    color: var(--primary-color);
    margin-bottom: 15px;
}

.print-quiz-metadata {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 15px;
    font-size: 14px;
}

.print-student-info {
    margin: 20px 0;
    padding: 15px;
    background: var(--light-bg);
    border-radius: 8px;
}

.print-student-table {
    width: 100%;
    border-collapse: collapse;
}

.print-student-table td {
    padding: 8px;
}

.print-info-label {
    font-weight: 600;
    white-space: nowrap;
    width: 120px;
}

.print-info-fill {
    border-bottom: 2px solid #333;
    width: 100%;
}

.print-instructions {
    margin: 25px 0;
    padding: 15px;
    background: #fffbea;
    border-left: 4px solid var(--secondary-color);
    border-radius: 4px;
}

.print-instructions h3 {
    font-size: 18px;
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.print-instructions ul {
    margin-left: 20px;
}

.print-instructions li {
    margin-bottom: 5px;
}

.print-question-item {
    margin: 25px 0;
    padding: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    page-break-inside: avoid;
}

.print-question-header {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.print-question-number {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 18px;
    min-width: 30px;
}

.print-question-text {
    font-size: 16px;
    font-weight: 500;
    line-height: 1.5;
    flex: 1;
}

.print-question-options {
    margin-left: 40px;
}

.print-option-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
}

.print-option-marker {
    width: 18px;
    height: 18px;
    border: 2px solid #333;
    flex-shrink: 0;
    margin-top: 2px;
}

.print-option-marker.radio {
    border-radius: 50%;
}

.print-option-marker.checkbox {
    border-radius: 3px;
}

.print-option-text {
    font-size: 15px;
    line-height: 1.4;
}

.print-select-all-note {
    font-style: italic;
    color: #666;
    margin-bottom: 10px;
    font-size: 14px;
}

.print-answer-space {
    margin-left: 40px;
    margin-top: 10px;
}

.print-answer-line {
    border-bottom: 1px solid #333;
    height: 30px;
    margin-bottom: 8px;
}

.print-quiz-footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid #ddd;
    text-align: center;
    color: #666;
}

/* Geometry shape in print */
.print-geometry-shape {
    margin: 20px 0;
    padding: 15px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    text-align: center;
}

.print-geometry-shape img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
}

/* Print Media Query */
@media print {
    body {
        background: white !important;
    }

    .container,
    .action-buttons,
    .print-modal-header,
    .print-modal-footer,
    header,
    .no-print,
    button {
        display: none !important;
    }

    .print-modal {
        display: block !important;
        position: static !important;
        background: none !important;
        padding: 0 !important;
    }

    .print-modal-content {
        box-shadow: none !important;
        max-width: 100% !important;
        max-height: none !important;
        border-radius: 0 !important;
        overflow: visible !important;
    }

    .print-modal-body {
        padding: 0 !important;
    }

    .print-preview-content {
        padding: 20px !important;
    }

    .print-question-item {
        page-break-inside: avoid !important;
    }

    .print-quiz-header {
        page-break-after: avoid !important;
    }
    
    .add-item-btn,
    .delete-question-btn,
    .edit-mode::before,
    .save-success-message {
        display: none !important;
    }
    
    .editable-field {
        border: none !important;
        background: none !important;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .action-buttons {
        flex-direction: column;
    }

    .print-quiz-metadata {
        grid-template-columns: 1fr;
    }
    
    .edit-mode::before {
        font-size: 12px;
        padding: 8px;
    }
}
/* Print Preview - Make Editable */
.print-preview-content {
    outline: none;
    min-height: 400px;
}

.print-preview-content:focus {
    outline: 2px solid #10B981;
    outline-offset: 4px;
}

/* Editable indicator */
.print-preview-content::before {
    content: "‚úèÔ∏è Click anywhere to edit text";
    display: block;
    padding: 8px 12px;
    background: #FEF3C7;
    border: 2px solid #F59E0B;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 14px;
    font-weight: 600;
    color: #92400E;
    text-align: center;
}

/* Size control buttons */
.print-controls {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
}

.size-btn {
    padding: 8px 16px;
    border: 2px solid #d1d5db;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.size-btn:hover {
    border-color: #10B981;
    background: #f0fdf4;
}

.size-btn.active {
    background: #10B981;
    color: white;
    border-color: #10B981;
}

/* Make images resizable */
.print-geometry-shape img {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.print-geometry-shape img:hover {
    transform: scale(1.02);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15) !important;
}

/* Editing state */
.print-preview-content[contenteditable="true"] .print-question-text,
.print-preview-content[contenteditable="true"] .print-option-text,
.print-preview-content[contenteditable="true"] .print-quiz-title {
    cursor: text;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s ease;
}

.print-preview-content[contenteditable="true"] .print-question-text:hover,
.print-preview-content[contenteditable="true"] .print-option-text:hover,
.print-preview-content[contenteditable="true"] .print-quiz-title:hover {
    background: #FEF3C7;
}

/* Print media query - hide edit indicator when printing */
@media print {
    .print-preview-content::before {
        display: none !important;
    }
    
    .print-controls {
        display: none !important;
    }
}
  </style>
  <link rel="stylesheet" href="edit-question.css">
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="header-container">
            <a href="#" class="logo">
                <span class="logo-icon">üìê</span>
                <span>Geometry Quiz Creator</span>
            </a>
            
            <nav class="nav-links">
                <a href="#" class="nav-link">Home</a>
                <a href="/dashboard.html" class="nav-link">Dashboard</a>
                <a href="/performance.html" class="nav-link">Performance</a>
            </nav>
            
            <div class="user-menu">
                <div class="user-info" id="userInfoDropdown">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span class="user-name" id="userName">Username</span>
                </div>
                
                <div class="dropdown-menu" id="userDropdown">
                    <a href="/profile.html" class="dropdown-item">
                        <i>üë§</i> My Profile
                    </a>
                    <a href="/performance.html" class="dropdown-item">
                        <i>üìä</i> Performance
                    </a>
                    <a href="/index.html" class="dropdown-item" id="logoutBtn">
                        <i>üö™</i> Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="nav-container">
            <a href="/quiz-creator" class="nav-button">Math Quiz Creator</a>
            <a href="/lesson-plan" class="nav-button">Lesson Planner</a>
        </div>
        
        <h1>Geometry Quiz Creator</h1>
        
        <!-- Quiz Assignment Section -->
        <div class="form-group">
            <h2>Quiz Assignment</h2>
            <label for="student-count">Number of Students:</label>
            <select id="student-count" required>
                <option value="1">1 student</option>
                <option value="2-5">2-5 students</option>
                <option value="6-10">6-10 students</option>
                <option value="11-20">11-20 students</option>
                <option value="custom">Custom</option>
            </select>
            
            <div id="custom-count-container" style="margin-top: 15px; display: none;">
                <label for="custom-student-count">Enter Custom Number:</label>
                <input type="number" id="custom-student-count" min="1" max="100" value="1">
            </div>
            
            <div id="quiz-mode-container" style="margin-top: 20px; display: none;">
                <label for="quiz-mode">Quiz Mode:</label>
                <div class="quiz-mode-options">
                    <div class="mode-option">
                        <input type="radio" id="mode-relaxed" name="quiz-mode-type" value="relaxed" checked>
                        <label for="mode-relaxed">
                            <div class="mode-title">Relaxed (Normal)</div>
                            <div class="mode-description">Standard quiz format for individual assessment.</div>
                        </label>
                    </div>
                    
                    <div class="mode-option">
                        <input type="radio" id="mode-competition" name="quiz-mode-type" value="competition">
                        <label for="mode-competition">
                            <div class="mode-title">Competition</div>
                            <div class="mode-description">Competitive mode with a leaderboard and winners board.</div>
                        </label>
                    </div>
                </div>
            </div>
            
            <p class="form-hint">Students will enter their names before starting the quiz.</p>
        </div>

        <!-- Academy Information Section -->
        <div class="form-group">
            <h2>Academy Information</h2>
            <label for="academy-name">Academy Name (Optional):</label>
            <input type="text" id="academy-name" placeholder="Enter your academy name (optional)">
            <p class="form-hint">If provided, this will be displayed as "[Your Entry] Academy" at the top of the quiz</p>
        </div>
        
        <!-- Grade Level Section -->
        <div class="form-group">
            <label for="grade-level">Grade Level:</label>
            <select id="grade-level" required>
                <option value="">Select Grade Level</option>
                <option value="elementary">Elementary School (1-5)</option>
                <option value="middle">Middle School (6-8)</option>
                <option value="high">High School (9-12)</option>
                <option value="college">College Level</option>
            </select>
            <div class="grade-description" id="grade-description"></div>
        </div>
        
        <!-- Content Source Section -->
        <div class="form-group">
            <h2>Content Source</h2>
            <div class="content-source-tabs">
                <div class="source-tab active" data-source="topic">Topic-Based</div>
                <div class="source-tab" data-source="text">Text Input</div>
            </div>
            
            <!-- Topic-based (default) -->
            <div id="topic-source" class="source-content" style="display: block;">
                <label for="topic-input">Geometry Topic:</label>
                <input type="text" id="topic-input" placeholder="e.g., Triangles, Circles, Polygons, Volume & Surface Area..." required>
            </div>
            
            <!-- Text input -->
            <div id="text-source" class="source-content" style="display: none;">
                <label for="content-text">Enter Geometry Content (max 1000 characters):</label>
                <textarea id="content-text" rows="6" maxlength="1000" placeholder="Paste or type geometry content here..."></textarea>
                <div class="char-counter"><span id="char-count">0</span>/1000</div>
            </div>
        </div>
        
        <!-- Question Types Section -->
        <div class="form-group">
            <h2>Question Types</h2>
            <div class="question-types">
                <div>
                    <input type="checkbox" id="type-multiple" class="type-checkbox" value="multiple_choice" checked>
                    <label for="type-multiple" class="type-label">Multiple Choice</label>
                </div>
                <div>
                    <input type="checkbox" id="type-truefalse" class="type-checkbox" value="true_false">
                    <label for="type-truefalse" class="type-label">True/False</label>
                </div>
                <div>
                    <input type="checkbox" id="type-paragraph" class="type-checkbox" value="paragraph">
                    <label for="type-paragraph" class="type-label">Paragraph</label>
                </div>
            </div>
        </div>
        
        <!-- Geometry Section -->
        <div class="form-group geometry-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">üìê</span>
                    Geometry & Shapes
                </h2>
                <button class="toggle-section-btn" onclick="toggleSection('geometry')">
                    <span>‚ñ≤</span>
                    <span>Minimize</span>
                </button>
            </div>
            <div class="section-content" id="geometry-content">
                <p>Select the types of geometric shapes and concepts to include:</p>
                
        <div class="geometry-types">
            <!-- Always visible - First 3 shapes -->
            <div>
                <input type="checkbox" id="geom-triangles" class="geometry-type-checkbox" value="triangles">
                <label for="geom-triangles" class="geometry-type-label">
                    <span class="geometry-type-icon">üìê</span>
                    <span class="geometry-type-title">Triangles</span>
                    <span class="geometry-type-desc">Properties, types, and calculations of triangles</span>
                </label>
            </div>
            
            <div>
                <input type="checkbox" id="geom-quadrilaterals" class="geometry-type-checkbox" value="quadrilaterals">
                <label for="geom-quadrilaterals" class="geometry-type-label">
                    <span class="geometry-type-icon">‚ñ≠</span>
                    <span class="geometry-type-title">Quadrilaterals</span>
                    <span class="geometry-type-desc">Rectangles, squares, parallelograms, trapezoids</span>
                </label>
            </div>
            
            <div>
                <input type="checkbox" id="geom-circles" class="geometry-type-checkbox" value="circles">
                <label for="geom-circles" class="geometry-type-label">
                    <span class="geometry-type-icon">‚≠ï</span>
                    <span class="geometry-type-title">Circles</span>
                    <span class="geometry-type-desc">Circumference, area, radius, diameter, sectors</span>
                </label>
            </div>
            
            <!-- Collapsible items - Hidden by default -->
            <div class="collapsed-items" id="geometry-collapsed">
                <div>
                    <input type="checkbox" id="geom-polygons" class="geometry-type-checkbox" value="polygons">
                    <label for="geom-polygons" class="geometry-type-label">
                        <span class="geometry-type-icon">‚¨ü</span>
                        <span class="geometry-type-title">Polygons</span>
                        <span class="geometry-type-desc">Hexagons, pentagons, octagons, and other polygons</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-3d-shapes" class="geometry-type-checkbox" value="3d_shapes">
                    <label for="geom-3d-shapes" class="geometry-type-label">
                        <span class="geometry-type-icon">üì¶</span>
                        <span class="geometry-type-title">3D Shapes</span>
                        <span class="geometry-type-desc">Cubes, spheres, cylinders, cones</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-volume-surface" class="geometry-type-checkbox" value="volume_surface">
                    <label for="geom-volume-surface" class="geometry-type-label">
                        <span class="geometry-type-icon">üìè</span>
                        <span class="geometry-type-title">Volume & Surface Area</span>
                        <span class="geometry-type-desc">Calculating volume and surface area of 3D shapes</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-angles" class="geometry-type-checkbox" value="angles">
                    <label for="geom-angles" class="geometry-type-label">
                        <span class="geometry-type-icon">‚à†</span>
                        <span class="geometry-type-title">Angles</span>
                        <span class="geometry-type-desc">Acute, obtuse, right angles, angle relationships</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-similarity" class="geometry-type-checkbox" value="similarity">
                    <label for="geom-similarity" class="geometry-type-label">
                        <span class="geometry-type-icon">‚âÖ</span>
                        <span class="geometry-type-title">Similarity & Congruence</span>
                        <span class="geometry-type-desc">Similar and congruent shapes, proportions</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-symmetry" class="geometry-type-checkbox" value="symmetry">
                    <label for="geom-symmetry" class="geometry-type-label">
                        <span class="geometry-type-icon">ü™û</span>
                        <span class="geometry-type-title">Symmetry</span>
                        <span class="geometry-type-desc">Lines of symmetry, rotational symmetry</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-coordinate" class="geometry-type-checkbox" value="coordinate_geometry">
                    <label for="geom-coordinate" class="geometry-type-label">
                        <span class="geometry-type-icon">üéØ</span>
                        <span class="geometry-type-title">Coordinate Geometry</span>
                        <span class="geometry-type-desc">Points, lines, and shapes on coordinate plane</span>
                    </label>
                </div>
                
                <div>
                    <input type="checkbox" id="geom-transformations" class="geometry-type-checkbox" value="transformations">
                    <label for="geom-transformations" class="geometry-type-label">
                        <span class="geometry-type-icon">üîÑ</span>
                        <span class="geometry-type-title">Transformations</span>
                        <span class="geometry-type-desc">Reflection, rotation, translation, dilation</span>
                    </label>
                </div>
            </div>
            
            <!-- Show More Button -->
            <button class="show-more-btn" onclick="toggleMoreItems('geometry')">
                <span>‚ñº</span>
                <span id="geometry-btn-text">Show More Shapes</span>
            </button>
        </div>
    </div>
</div>
        
        <!-- Quiz Parameters Section -->
        <div class="form-group">
            <h2>Quiz Parameters</h2>
            <div>
                <label for="num-questions">Number of Questions:</label>
                <input type="number" id="num-questions" min="1" max="20" value="5">
            </div>
            
            <div>
                <label for="time-limit">Time Limit (minutes):</label>
                <input type="number" id="time-limit" min="1" max="180" value="30">
            </div>
        </div>
        
        <!-- Quiz Display Section -->
        <div class="form-group">
            <h2>Quiz Display</h2>
            <div class="mode-selector">
                <div class="mode-option">
                    <input type="radio" id="mode-list" name="quiz-mode" class="type-checkbox" value="list" checked>
                    <label for="mode-list" class="type-label">List Mode </label>
                </div>
                <div class="mode-option">
                    <input type="radio" id="mode-auto" name="quiz-mode" class="type-checkbox" value="auto">
                    <label for="mode-auto" class="type-label">Autonavigation </label>
                </div>
            </div>
        </div>
        
        <!-- Submit Section -->
        <button id="generate-btn" class="generate-button">Generate Geometry Quiz</button>
        
        <!-- Status Indicators -->
        <div class="error-message" id="error-message"></div>
        <div class="loading" id="loading">Creating your geometry quiz</div>
        <div class="quiz-preview" id="quiz-preview"></div>
        <div class="quiz-link" id="quiz-link"></div>

        <!-- Quiz Management Section -->
        <div class="form-group" id="quiz-management">
            <h2>Quiz Management</h2>
            <p>View scores and analytics for your geometry quizzes</p>
            
            <div class="dashboard-actions">
                <button id="scores-btn" class="dashboard-btn" style="background: linear-gradient(145deg, #10B981, #059669);">
                    <span style="margin-right: 8px;">üìä</span> View Quiz Scores
                </button>
                <button id="analytics-btn" class="dashboard-btn" style="background: linear-gradient(145deg, #3B82F6, #1D4ED8);">
                    <span style="margin-right: 8px;">üìà</span> View Analytics
                </button>
            </div>
        </div>
    </div>

    <script>



        // Grade level descriptions for geometry
        const gradeLevelDescriptions = {
            'elementary': 'Basic shapes, angles, and simple area/perimeter calculations',
            'middle': 'Geometric properties, area/volume formulas, and coordinate geometry',
            'high': 'Advanced geometry, trigonometry, and geometric proofs',
            'college': 'Complex geometric concepts including analytic geometry and transformations'
        };

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing geometry quiz creator...");
            
            // Initialize student count handler
            const studentCountSelect = document.getElementById('student-count');
            const customCountContainer = document.getElementById('custom-count-container');
            const quizModeContainer = document.getElementById('quiz-mode-container');
            
            if (studentCountSelect) {
                studentCountSelect.addEventListener('change', function() {
                    console.log("Student count changed to:", this.value);
                    
                    // Show/hide custom count input
                    if (this.value === 'custom') {
                        customCountContainer.style.display = 'block';
                    } else {
                        customCountContainer.style.display = 'none';
                    }
                    
                    // Show/hide quiz mode options
                    if (this.value !== '1') {
                        quizModeContainer.style.display = 'block';
                    } else {
                        quizModeContainer.style.display = 'none';
                        // Reset to relaxed mode when only 1 student
                        document.getElementById('mode-relaxed').checked = true;
                    }
                });
            }
            
            // Initialize content source tabs
            const sourceTabs = document.querySelectorAll('.source-tab');
            
            sourceTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log("Source tab clicked:", this.getAttribute('data-source'));
                    
                    // Remove active class from all tabs
                    sourceTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Get source type from data attribute
                    const sourceType = this.getAttribute('data-source');
                    
                    // Hide all source content sections
                    document.querySelectorAll('.source-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Show the selected content section
                    const contentSection = document.getElementById(`${sourceType}-source`);
                    if (contentSection) {
                        contentSection.style.display = 'block';
                    }
                });
            });
            
            // Initialize character counter for text input
            const contentTextarea = document.getElementById('content-text');
            const charCount = document.getElementById('char-count');
            
            if (contentTextarea && charCount) {
                contentTextarea.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                    
                    // Change color when approaching limit
                    if (this.value.length > 800) {
                        charCount.style.color = this.value.length > 900 ? '#f44336' : '#ff9800';
                    } else {
                        charCount.style.color = '#666';
                    }
                });
            }
            
            // Initialize grade level description
            const gradeSelect = document.getElementById('grade-level');
            if (gradeSelect) {
                gradeSelect.addEventListener('change', function() {
                    const description = gradeLevelDescriptions[this.value] || '';
                    const descriptionElement = document.getElementById('grade-description');
                    if (descriptionElement) {
                        descriptionElement.textContent = description;
                    }
                });
            }
            
            // Add click event to generate button
            document.getElementById('generate-btn').addEventListener('click', generateGeometryQuiz);
            
            // Add click events to dashboard buttons
            document.getElementById('scores-btn').addEventListener('click', showScoresDashboard);
            document.getElementById('analytics-btn').addEventListener('click', showAnalyticsDashboard);
        });

        // Function to show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Function to set loading state
        function setLoadingState(isLoading) {
            const generateBtn = document.getElementById('generate-btn');
            const loadingDiv = document.getElementById('loading');
            generateBtn.disabled = isLoading;
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            if (!isLoading) {
                document.getElementById('error-message').style.display = 'none';
            }
        }

        // Function to get authentication token
        function getAuthToken() {
            // Try multiple storage locations for better mobile compatibility
            return localStorage.getItem('token') || 
                sessionStorage.getItem('token') || 
                getCookie('token');
        }

        // Helper function to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Function to show login option
        function showLoginOption() {
            const container = document.querySelector('.container');
            if (!container) return;
            
            // Check if login option already exists
            if (document.getElementById('login-option')) return;
            
            const loginOption = document.createElement('div');
            loginOption.id = 'login-option';
            loginOption.className = 'form-group';
            loginOption.style.textAlign = 'center';
            loginOption.style.marginBottom = '20px';
            loginOption.style.padding = '15px';
            loginOption.style.background = '#f9fafb';
            loginOption.style.borderRadius = '8px';
            loginOption.style.border = '1px solid #e5e7eb';
            
            loginOption.innerHTML = `
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Login Required</h3>
                <p style="margin-bottom: 15px;">You need to log in to create geometry quizzes.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <a href="/index.html" class="nav-button" style="flex: 1; max-width: 150px; text-decoration: none; text-align: center; padding: 10px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: 8px; font-weight: 600;">Login</a>
                </div>
            `;
            
            // Insert at the top of the container
            container.insertBefore(loginOption, container.firstChild);
        }

        // Toggle section visibility
        function toggleSection(sectionName) {
            const content = document.getElementById(`${sectionName}-content`);
            const button = document.querySelector(`[onclick="toggleSection('${sectionName}')"]`);
            const buttonText = button.querySelector('span:last-child');
            const buttonIcon = button.querySelector('span:first-child');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.display = 'block';
                buttonText.textContent = 'Minimize';
                buttonIcon.textContent = '‚ñ≤';
                button.parentElement.parentElement.classList.remove('section-collapsed');
            } else {
                content.classList.add('collapsed');
                content.style.display = 'none';
                buttonText.textContent = 'Expand';
                buttonIcon.textContent = '‚ñº';
                button.parentElement.parentElement.classList.add('section-collapsed');
            }
        }

        // Toggle more items visibility
        function toggleMoreItems(category) {
            const collapsedItems = document.getElementById(`${category}-collapsed`);
            const button = document.querySelector(`[onclick="toggleMoreItems('${category}')"]`);
            const buttonText = document.getElementById(`${category}-btn-text`);
            const buttonIcon = button.querySelector('span:first-child');
            
            if (collapsedItems.classList.contains('show')) {
                collapsedItems.classList.remove('show');
                buttonText.textContent = `Show More ${category === 'geometry' ? 'Shapes' : 'Items'}`;
                buttonIcon.textContent = '‚ñº';
            } else {
                collapsedItems.classList.add('show');
                buttonText.textContent = `Show Less ${category === 'geometry' ? 'Shapes' : 'Items'}`;
                buttonIcon.textContent = '‚ñ≤';
            }
        }

        // Generate geometry quiz function
        function generateGeometryQuiz() {
            // Clear any previous error messages
            const errorMessageDiv = document.getElementById('error-message');
            errorMessageDiv.textContent = '';
            errorMessageDiv.style.display = 'none';
            
            // Get form values
            const gradeLevel = document.getElementById('grade-level').value;
            const academyName = document.getElementById('academy-name').value.trim();
            const numQuestions = document.getElementById('num-questions').value;
            const timeLimit = document.getElementById('time-limit').value;
            
            // Validate required fields with clear error messages
            let hasErrors = false;
            
            if (!gradeLevel) {
                showError('Please select a grade level');
                document.getElementById('grade-level').focus();
                document.getElementById('grade-level').style.borderColor = '#f44336';
                hasErrors = true;
            }
            
            // Get content source
            const activeTab = document.querySelector('.source-tab.active');
            const activeSourceTab = activeTab ? activeTab.getAttribute('data-source') : 'topic';
            
            let topic = '';
            let contentText = '';
            let sourceType = 'topic';
            
            // Get content based on selected source
            if (activeSourceTab === 'topic') {
                const topicInput = document.getElementById('topic-input');
                topic = topicInput ? topicInput.value.trim() : '';
                
                if (!topic) {
                    showError(hasErrors ? 'Please select a grade level and enter a geometry topic' : 'Please enter a geometry topic');
                    document.getElementById('topic-input').focus();
                    document.getElementById('topic-input').style.borderColor = '#f44336';
                    hasErrors = true;
                }
                
                sourceType = 'topic';
            } else if (activeSourceTab === 'text') {
                const textArea = document.getElementById('content-text');
                contentText = textArea ? textArea.value.trim() : '';
                
                if (!contentText) {
                    showError(hasErrors ? 'Please select a grade level and enter geometry content' : 'Please enter geometry content');
                    document.getElementById('content-text').focus();
                    document.getElementById('content-text').style.borderColor = '#f44336';
                    hasErrors = true;
                }
                
                topic = `Geometry Content: ${contentText.substring(0, 30)}${contentText.length > 30 ? '...' : ''}`;
                sourceType = 'text';
            }
            
            // If there are validation errors, stop here
            if (hasErrors) {
                return;
            }
            
            // Reset input styling now that validation passed
            document.getElementById('grade-level').style.borderColor = '';
            if (document.getElementById('topic-input')) {
                document.getElementById('topic-input').style.borderColor = '';
            }
            if (document.getElementById('content-text')) {
                document.getElementById('content-text').style.borderColor = '';
            }
            
            // Show loading state
            setLoadingState(true);
            
            // Get student count
            let studentCount = 1;
            const studentCountSelect = document.getElementById('student-count');
            if (studentCountSelect) {
                if (studentCountSelect.value === 'custom') {
                    const customCount = document.getElementById('custom-student-count').value;
                    studentCount = parseInt(customCount) || 1;
                } else {
                    studentCount = studentCountSelect.value; // Store as string like "2-5", "6-10", etc.
                }
            }
            
            // Get quiz mode type
            let quizModeType = 'relaxed'; // Default
            const modeTypeRadio = document.querySelector('input[name="quiz-mode-type"]:checked');
            if (modeTypeRadio) {
                quizModeType = modeTypeRadio.value;
            }
            
            // Get selected question types
            let types = ['multiple_choice']; // Default
            try {
                const typeCheckboxes = document.querySelectorAll('.type-checkbox:checked');
                if (typeCheckboxes && typeCheckboxes.length > 0) {
                    types = Array.from(typeCheckboxes)
                        .filter(cb => cb.name !== 'quiz-mode')
                        .map(cb => cb.value);
                }
            } catch (e) {
                console.error('Error getting question types:', e);
            }
            
            // Get selected geometry types
            let geometryTypes = [];
            try {
                const geometryTypeCheckboxes = document.querySelectorAll('.geometry-type-checkbox:checked');
                if (geometryTypeCheckboxes && geometryTypeCheckboxes.length > 0) {
                    geometryTypes = Array.from(geometryTypeCheckboxes).map(cb => cb.value);
                }
            } catch (e) {
                console.error('Error getting geometry types:', e);
            }
            
            // Get quiz display mode
            let displayMode = 'list'; // Default
            try {
                const modeRadio = document.querySelector('input[name="quiz-mode"]:checked');
                if (modeRadio) {
                    displayMode = modeRadio.value;
                }
            } catch (e) {
                console.error('Error getting quiz display mode:', e);
            }
            
            // Get authentication token
            const token = getAuthToken();
            if (!token) {
                showError('Please login to generate quizzes');
                setLoadingState(false);
                showLoginOption();
                return;
            }
            
            // Prepare request data
            const requestData = {
                topic: topic,
                grade_level: gradeLevel,
                time_limit: parseInt(timeLimit),
                numQuestions: parseInt(numQuestions),
                title: `${topic} Geometry Quiz`,
                types: types,
                mode: displayMode,
                quiz_mode_type: quizModeType,
                academy_name: academyName,
                student_count: studentCount,
                content_text: contentText,
                source_type: sourceType,
                geometry_types: geometryTypes
            };
            
            console.log("Sending geometry quiz generation request:", requestData);
            
            // Send request to API
            fetch('/api/generate-geometry-quiz-atomic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.status === 401) {
                    console.error('Authentication failed');
                    showLoginOption();
                    throw new Error('Your session has expired. Please log in again.');
                }
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error("Error response:", text);
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.error || `Server error: ${response.status}`);
                        } catch (e) {
                            throw new Error(`Server error: ${response.status}. This might be due to a missing database table. Please contact support.`);
                        }
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Response:', data);
                
                // Show quiz preview
                if (data.quiz_data && data.quiz_data.questions) {
                    showQuizPreview(data.quiz_data, data.quiz_id);
                }
                
                // Generate the quiz URL with appropriate mode parameters
                let quizUrl = `/geometry-quiz.html?id=${data.quiz_id}`;
                
                // Add mode parameter if not relaxed (default)
                if (quizModeType !== 'relaxed') {
                    quizUrl += `&mode=${quizModeType}`;
                }
                
                // Only add academy parameter if an academy name was provided
                if (academyName && academyName.trim() !== '') {
                    quizUrl += `&academy=${encodeURIComponent(academyName)}`;
                }

                                // Show success message with link
                // Show success message with link AND print buttons
document.getElementById('quiz-link').innerHTML = 
document.getElementById('quiz-link').style.display = 'block';

// ‚≠ê IMPORTANT: Call this to store the quiz data for printing
if (data.quiz_data) {
    updateQuizDataForPrint(data.quiz_data);
} else if (data.quiz) {
    updateQuizDataForPrint(data.quiz);
} else {
    updateQuizDataForPrint(data);
}

// Scroll to the success message
document.getElementById('quiz-link').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error generating quiz:', error);
                showError(error.message || 'Failed to generate quiz. Please try again.');
            })
            .finally(() => {
                setLoadingState(false);
            });
        }

        // Function to render mathematical notation
        function renderMathNotation(text) {
            if (!text) return '';
            
            // Replace common math notation
            let formattedText = text;
            
            // Replace squared notation
            formattedText = formattedText.replace(/(\w+)¬≤/g, '$1¬≤');
            formattedText = formattedText.replace(/(\w+)¬≥/g, '$1¬≥');
            
            // Replace basic operators
            formattedText = formattedText.replace(/√ó/g, '√ó');
            formattedText = formattedText.replace(/√∑/g, '√∑');
            formattedText = formattedText.replace(/¬±/g, '¬±');
            
            // Handle square roots
            formattedText = formattedText.replace(/‚àö(\w+)/g, '‚àö$1');
            
            return formattedText;
        }

  function showQuizPreview(quizData, quizId) {
    const previewDiv = document.getElementById('quiz-preview');
    const topic = quizData.topic || '';
    const gradeLevel = quizData.grade_level || '';
    
    // CRITICAL: Store quiz data globally for shape rendering
    window.currentQuizData = quizData;
    window.quizData = quizData;
    
    let html = `
        <div class="preview-header">
            <h3>Geometry Quiz Preview</h3>
            <p>
                ${quizData.title} | 
                Level: ${quizData.grade_level} | 
                Time: ${quizData.time_limit} min
            </p>
        </div>
        <div class="questions-preview">
    `;
    
    if (quizData.questions && quizData.questions.length > 0) {
        quizData.questions.forEach((question, index) => {
            html += `
                <div class="question-preview" id="question-${question.id || index}">
                    <div class="question-header">
                        <h4>Q${index + 1}</h4>
                        <div class="question-actions">
                            <button class="action-btn edit-btn" data-index="${index}">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="action-btn regenerate-btn" data-id="${question.id || index}" data-quiz="${quizId}" data-topic="${topic}" data-grade="${gradeLevel}">
                                üîÑ Regenerate
                            </button>
                        </div>
                    </div>
                    <div class="question-content">
                        <div class="question-text-section">
                            <p class="question-text">${renderMathNotation(question.text)}</p>
                        </div>
                        
                        <!-- CRITICAL: Shape container with correct ID -->
                        <div id="shape-container-${index}" class="shape-container">
                            <div class="shape-loading">Loading geometry shape...</div>
                        </div>
                    </div>
            `;
            
            if (question.type !== 'paragraph' && question.options && question.options.length > 0) {
                html += `<div class="options-preview">`;
                
                question.options.forEach((option, optIndex) => {
                    const isCorrect = option.isCorrect ? 'correct-option' : '';
                    html += `
                        <div class="option-preview ${isCorrect}">
                            <span class="option-letter">${String.fromCharCode(65 + optIndex)})</span>
                            <span class="option-text">${renderMathNotation(option.text)}</span>
                            ${option.isCorrect ? '<span class="correct-marker">‚úì</span>' : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else if (question.type === 'paragraph') {
                html += `
                    <div class="paragraph-preview option-preview">
                        <em>Paragraph question - student will provide a written response</em>
                    </div>
                `;
            }
            
            html += `</div>`;
        });
    } else {
        html += `<p class="no-questions">No questions generated</p>`;
    }
    
    html += `</div>`;
    
    previewDiv.innerHTML = html;
    previewDiv.style.display = 'block';
    
    // CRITICAL: Render shapes after HTML is inserted
    setTimeout(() => {
        console.log("Rendering shapes for quiz preview");
        
        quizData.questions.forEach((question, index) => {
            renderGeometryShapeInPreview(question, index);
        });
        
        // Render math notation if available
        if (typeof reprocessMathNotation === 'function') {
            reprocessMathNotation();
        }
    }, 100);
    
    // Add event listeners for regenerate buttons
    const regenerateButtons = previewDiv.querySelectorAll('.regenerate-btn');
    regenerateButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const questionId = this.getAttribute('data-id');
            const quizId = this.getAttribute('data-quiz');
            const topic = this.getAttribute('data-topic');
            const gradeLevel = this.getAttribute('data-grade');
            regenerateQuestion(quizId, questionId, topic, gradeLevel);
        });
    });
    
    // Scroll to the preview
    setTimeout(() => {
        previewDiv.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

function renderGeometryShapeInPreview(question, index) {
    const shapeContainer = document.getElementById(`shape-container-${index}`);
    if (!shapeContainer) {
        console.error(`Shape container not found: shape-container-${index}`);
        return;
    }
    
    console.log(`Checking question ${index} for shape data:`, question);
    
    // Check multiple possible locations for shape data
    let shapeData = question.shape_data || 
                   question.shapeData || 
                   question.geometry_data ||
                   question.geometryData;
    
    // If no shape data but has geometry info, try to create basic data
    if (!shapeData && question.requires_geometry && question.geometry_type) {
        // Map category names to specific shape types
        const categoryToShape = {
            'circles': 'circle',
            'triangles': 'triangle',
            'quadrilaterals': 'rectangle',
            'polygons': 'polygon',
            '3d_shapes': 'cube',
            'angles': 'complementary_angles',
            'volume_surface': 'cylinder'
        };
        const mappedType = categoryToShape[question.geometry_type] || question.geometry_type;
        shapeData = {
            ai_assigned: true,
            shape_type: mappedType,
            radius: 5,
            validation_passed: true
        };
        console.log(`Created fallback shape data for Q${index}:`, shapeData);
    }

    // If still no shape data but question has geometry keywords, try to analyze
    if (!shapeData && question.text && hasGeometryKeywords(question.text)) {
        shapeData = analyzeQuestionForShapeData(question.text);
        console.log(`Analyzed question text for shape data Q${index}:`, shapeData);
    }

    // If still no shape data, show no geometry message
    if (!shapeData || !shapeData.ai_assigned) {
        console.log(`No shape data for Q${index}`);
        shapeContainer.innerHTML = `
            <div style="padding: 15px; font-style: italic; color: #718096; text-align: center;">
                <span>No geometry shape required for this question</span>
            </div>
        `;
        return;
    }
    
    console.log(`Rendering shape for Q${index} with data:`, shapeData);
    
    // Show loading
    shapeContainer.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; padding: 25px;">
            <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #10B981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 10px; color: #666;">Rendering geometry shape...</p>
        </div>
    `;
    
    // Prepare the API request
    const requestData = {
        type: shapeData.shape_type,
        measurements: shapeData,
        question_context: {
            text: question.text,
            hide_answer: true,
            is_preview: true
        }
    };
    
    console.log(`API request for Q${index}:`, requestData);
    
    // Make the API call
    fetch('/api/geometry/render-shape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log(`API response status for Q${index}:`, response.status);
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log(`API response data for Q${index}:`, data);
        
        if (data.success && data.image) {
            shapeContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                    <h4 style="color: #10B981; margin: 0 0 15px 0; text-align: center; font-size: 1.1rem;">
                        ${shapeData.shape_type.charAt(0).toUpperCase() + shapeData.shape_type.slice(1)}
                    </h4>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="${data.image}" 
                             alt="${shapeData.shape_type}" 
                             style="width: 100%; height: auto; border-radius: 8px; cursor: pointer;"
                             onclick="enlargeShapeImage('${data.image}', '${shapeData.shape_type}')" />
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #10B981;">
                        <p style="font-size: 12px; color: #047857; text-align: center; margin: 0;">
                            Shape successfully rendered
                        </p>
                    </div>
                </div>
            `;
            console.log(`‚úÖ Shape rendered successfully for Q${index}`);
        } else {
            throw new Error(data.error || 'No image returned from API');
        }
    })
    .catch(error => {
        console.error(`‚ùå Shape rendering error for Q${index}:`, error);
        shapeContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                <p style="margin: 0 0 10px 0;">‚ö†Ô∏è Shape rendering failed</p>
                <p style="margin: 0; font-size: 12px;">${error.message}</p>
                <button onclick="retryShapeRender(${index})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                    üîÑ Retry
                </button>
            </div>
        `;
    });
}

function getShapeDetails(shapeData) {
    if (shapeData.shape_type === 'circle') {
        return `Radius: ${shapeData.radius}cm`;
    } else if (shapeData.shape_type === 'triangle') {
        return `Base: ${shapeData.base || 'N/A'}cm, Height: ${shapeData.height || 'N/A'}cm`;
    } else if (shapeData.shape_type === 'cube') {
        return `Side: ${shapeData.side}cm`;
    }
    return 'Geometry shape';
}

function retryShapeRender(questionIndex) {
    if (window.currentQuizData && window.currentQuizData.questions[questionIndex]) {
        renderGeometryShapeInPreview(window.currentQuizData.questions[questionIndex], questionIndex);
    }
}

function enlargeShapeImage(imageSrc, shapeTitle) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center;
        align-items: center; z-index: 10000; cursor: pointer;
    `;
    
    modal.innerHTML = `
        <div style="max-width: 90%; max-height: 90%; background: white; border-radius: 12px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0; text-align: center;">${shapeTitle}</h3>
            <img src="${imageSrc}" style="width: 100%; height: auto; border-radius: 8px;" alt="${shapeTitle}">
            <p style="text-align: center; margin: 15px 0 0 0; color: #666; font-size: 14px;">Click anywhere to close</p>
        </div>
    `;
    
    modal.addEventListener('click', () => document.body.removeChild(modal));
    document.body.appendChild(modal);
}

function retryShapeRender(questionIndex) {
    if (window.currentQuizData && window.currentQuizData.questions[questionIndex]) {
        renderGeometryShapeInPreview(window.currentQuizData.questions[questionIndex], questionIndex);
    }
}
// ADD these helper functions:
function analyzeQuestionForShape(questionText) {
    const text = questionText.toLowerCase();

    // Detect shape type - comprehensive detection for ALL shapes
    let shapeType = 'circle'; // default
    if (text.includes('sector') || (text.includes('central angle') && text.includes('circle'))) shapeType = 'sector';
    else if (text.includes('triangular prism') || text.includes('prism')) shapeType = 'triangular_prism';
    else if (text.includes('rectangular prism') || text.includes('cuboid')) shapeType = 'rectangular_prism';
    else if (text.includes('sphere')) shapeType = 'sphere';
    else if (text.includes('cone')) shapeType = 'cone';
    else if (text.includes('cylinder')) shapeType = 'cylinder';
    else if (text.includes('cube')) shapeType = 'cube';
    else if (text.includes('trapezium') || text.includes('trapezoid')) shapeType = 'trapezium';
    else if (text.includes('right') && text.includes('triangle')) shapeType = 'right_triangle';
    else if (text.includes('equilateral') && text.includes('triangle')) shapeType = 'equilateral_triangle';
    else if (text.includes('isosceles') && text.includes('triangle')) shapeType = 'isosceles_triangle';
    else if (text.includes('scalene') && text.includes('triangle')) shapeType = 'scalene_triangle';
    else if (text.includes('triangle')) shapeType = 'triangle';
    else if (text.includes('rectangle') || text.includes('rectangular')) shapeType = 'rectangle';
    else if (text.includes('square')) shapeType = 'square';
    else if (text.includes('pentagon')) shapeType = 'pentagon';
    else if (text.includes('hexagon')) shapeType = 'hexagon';
    else if (text.includes('octagon')) shapeType = 'octagon';
    else if (text.includes('polygon')) shapeType = 'polygon';
    else if (text.includes('circle')) shapeType = 'circle';
    else if (text.includes('parallel')) shapeType = 'parallel_lines';
    
    // Detect question type
    let questionType = 'DISPLAY_ONLY';
    if (text.includes('area of') && text.includes('sector')) questionType = 'FIND_SECTOR_AREA';
    else if (text.includes('length') && text.includes('arc')) questionType = 'FIND_ARC_LENGTH';
    else if (text.includes('area')) questionType = 'FIND_AREA';
    else if (text.includes('volume')) questionType = 'FIND_VOLUME';
    
    // Extract measurements
    const measurements = extractMeasurementsFromText(text);
    
    // Determine if answer should be hidden
    const hideAnswer = text.includes('what is') || text.includes('find') || text.includes('calculate');
    
    // Generate title
    const title = generateShapeTitle(shapeType, questionType);
    
    return {
        shapeType,
        questionType,
        measurements,
        hideAnswer,
        title
    };
}

function extractMeasurementsFromText(text) {
    const measurements = {};
    
    // Extract radius
    const radiusMatch = text.match(/radius\s*(?:of\s+)?(\d+(?:\.\d+)?)/i);
    if (radiusMatch) measurements.radius = parseFloat(radiusMatch[1]);
    
    // Extract diameter
    const diameterMatch = text.match(/diameter\s*(?:of\s+)?(\d+(?:\.\d+)?)/i);
    if (diameterMatch) {
        measurements.diameter = parseFloat(diameterMatch[1]);
        measurements.radius = measurements.diameter / 2;
    }
    
    // Extract circumference
    const circumferenceMatch = text.match(/circumference\s*(?:of\s+)?(\d+(?:\.\d+)?)/i);
    if (circumferenceMatch) {
        measurements.circumference = parseFloat(circumferenceMatch[1]);
        measurements.radius = measurements.circumference / (2 * Math.PI);
    }
    
    // Extract central angle
    const angleMatch = text.match(/(?:central\s*)?angle\s*(?:of\s+)?(\d+)/i);
    if (angleMatch) measurements.central_angle = parseFloat(angleMatch[1]);
    
    // Set defaults if no measurements found
    if (!measurements.radius && !measurements.diameter) {
        measurements.radius = 5; // default radius
    }
    
    return measurements;
}

function generateShapeTitle(shapeType, questionType) {
    const shapeTitles = {
        circle: 'Circle',
        sphere: 'Sphere',
        cone: 'Cone',
        cylinder: 'Cylinder',
        cube: 'Cube',
        triangle: 'Triangle',
        rectangle: 'Rectangle'
    };
    
    const baseTitle = shapeTitles[shapeType] || 'Geometric Shape';
    
    if (questionType === 'FIND_SECTOR_AREA') return `${baseTitle} - Sector Area`;
    if (questionType === 'FIND_ARC_LENGTH') return `${baseTitle} - Arc Length`;
    if (questionType === 'FIND_AREA') return `${baseTitle} - Area`;
    if (questionType === 'FIND_VOLUME') return `${baseTitle} - Volume`;
    
    return baseTitle;
}

function hasGeometryKeywords(questionText) {
    const geometryKeywords = [
        'circle', 'radius', 'diameter', 'circumference', 'sector', 'arc',
        'sphere', 'cone', 'cylinder', 'cube', 'triangle', 'rectangle',
        'square', 'trapezium', 'trapezoid', 'pentagon', 'hexagon', 'octagon',
        'polygon', 'prism', 'parallel', 'perimeter',
        'area', 'volume', 'angle', 'central angle'
    ];

    const text = questionText.toLowerCase();
    return geometryKeywords.some(keyword => text.includes(keyword));
}

function getHintMessage(shapeInfo) {
    if (shapeInfo.questionType === 'FIND_SECTOR_AREA') {
        return 'Use formula: A = (Œ∏/360¬∞) √ó œÄr¬≤ for sector area';
    } else if (shapeInfo.questionType === 'FIND_ARC_LENGTH') {
        return 'Use formula: L = (Œ∏/360¬∞) √ó 2œÄr for arc length';
    } else if (shapeInfo.questionType === 'FIND_AREA') {
        return 'Use formula: A = œÄr¬≤ for circle area';
    }
    return 'Study the given measurements carefully';
}

function enlargeShapeImage(imageSrc, shapeTitle) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center;
        align-items: center; z-index: 10000; cursor: pointer;
    `;
    
    modal.innerHTML = `
        <div style="max-width: 90%; max-height: 90%; background: white; border-radius: 12px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0; text-align: center;">${shapeTitle}</h3>
            <img src="${imageSrc}" style="width: 100%; height: auto; border-radius: 8px;" alt="${shapeTitle}">
        </div>
    `;
    
    modal.addEventListener('click', () => document.body.removeChild(modal));
    document.body.appendChild(modal);
}

function retryShapeRender(questionIndex) {
    if (window.currentQuizData && window.currentQuizData.questions[questionIndex]) {
        renderGeometryShapeInPreview(window.currentQuizData.questions[questionIndex], questionIndex);
    }
}

        // Function to regenerate a question
        function regenerateQuestion(quizId, questionId, topic, gradeLevel) {
            const questionDiv = document.getElementById(`question-${questionId}`);
            if (!questionDiv) {
                console.error(`Question element not found: question-${questionId}`);
                return;
            }
            
            // Store the original content in case of error
            const originalContent = questionDiv.innerHTML;
            
            // Show loading state
            questionDiv.innerHTML = '<div class="loading" style="display:block">Regenerating question...</div>';
            questionDiv.style.opacity = '0.7';
            
            // Get auth token
            const token = getAuthToken();
            if (!token) {
                console.error("No authentication token found");
                questionDiv.innerHTML = originalContent;
                questionDiv.style.opacity = '1';
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'Authentication required. Please log in.';
                questionDiv.appendChild(errorMsg);
                return;
            }
            
            // Prepare request data
            const requestData = {
                quiz_id: quizId,
                question_id: questionId,
                topic: topic,
                grade_level: gradeLevel
            };
            
            // Send regenerate request to API
            fetch('/api/regenerate-geometry-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.error || `Server error: ${response.status}`);
                        } catch (e) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.question) {
                    // Update the question in the UI
                    const question = data.question;
                    
                    let html = `
                        <div class="question-header">
                            <h4>Question</h4>
                            <div class="question-actions">
                                <button class="action-btn regenerate-btn" data-id="${question.id}" data-quiz="${quizId}" data-topic="${topic}" data-grade="${gradeLevel}">
                                    üîÑ Regenerate
                                </button>
                            </div>
                        </div>
                        <p class="question-text">${question.text}</p>
                    `;
                    
                    // Render based on question type
                    if (question.type === 'paragraph') {
                        html += `
                            <div class="paragraph-preview option-preview">
                                <em>Paragraph question - student will provide a written response</em>
                            </div>
                        `;
                    } 
                    else if (question.options && question.options.length > 0) {
                        html += `<div class="options-preview">`;
                        
                        question.options.forEach((option, optIndex) => {
                            const isCorrect = option.isCorrect ? 'correct-option' : '';
                            html += `
                                <div class="option-preview ${isCorrect}">
                                    <span class="option-letter">${String.fromCharCode(65 + optIndex)})</span>
                                    <span class="option-text">${option.text}</span>
                                    ${option.isCorrect ? '<span class="correct-marker">‚úì</span>' : ''}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    questionDiv.innerHTML = html;
                    questionDiv.style.opacity = '1';
                    
                    // Add event listener to the new regenerate button
                    const newRegenerateBtn = questionDiv.querySelector('.regenerate-btn');
                    if (newRegenerateBtn) {
                        newRegenerateBtn.addEventListener('click', function() {
                            const questionId = this.getAttribute('data-id');
                            const quizId = this.getAttribute('data-quiz');
                            const topic = this.getAttribute('data-topic');
                            const gradeLevel = this.getAttribute('data-grade');
                            regenerateQuestion(quizId, questionId, topic, gradeLevel);
                        });
                    }
                    
                    // Add animation to highlight the change
                    questionDiv.style.backgroundColor = '#e8f5e9';
                    setTimeout(() => {
                        questionDiv.style.backgroundColor = '';
                    }, 1000);
                } else {
                    throw new Error('No question data in response');
                }
            })
            .catch(error => {
                console.error('Error regenerating question:', error);
                
                // Restore original content
                questionDiv.innerHTML = originalContent;
                questionDiv.style.opacity = '1';
                
                // Add error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'Error regenerating question. Please try again.';
                questionDiv.appendChild(errorMsg);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (errorMsg.parentNode === questionDiv) {
                        questionDiv.removeChild(errorMsg);
                    }
                }, 5000);
            });
        }

        // Function to copy quiz link
        function copyQuizLink(url) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url)
                    .then(() => {
                        const copyButton = document.querySelector('.copy-button');
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        fallbackCopyText(url);
                    });
            } else {
                fallbackCopyText(url);
            }
        }

        // Fallback copy function
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                const copyButton = document.querySelector('.copy-button');
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Could not copy text. Please copy it manually.');
            }
            
            document.body.removeChild(textArea);
        }

        // Function to view quiz scores
        function viewQuizScores(quizId) {
            window.location.href = `/quiz-management-dashboard.html?view=scores&id=${quizId}&type=geometry`;
        }

        // Function to view performance chart
        function viewPerformanceChart(quizId) {
            window.location.href = `/quiz-performance.html?id=${quizId}`;
        }

        // Function to show scores dashboard
        function showScoresDashboard() {
            window.location.href = '/quiz-management-dashboard.html?view=scores';
        }

        // Function to show analytics dashboard
        function showAnalyticsDashboard() {
            window.location.href = '/quiz-management.html?view=analytics';
        }

        // Add content source tab styles
        const contentSourceStyle = document.createElement('style');
        contentSourceStyle.textContent = `
            .content-source-tabs {
                display: flex;
                margin-bottom: 15px;
                background: #f5f5f5;
                border-radius: 8px;
                padding: 4px;
            }

            .source-tab {
                flex: 1;
                padding: 10px 15px;
                text-align: center;
                background: white;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.3s ease;
                border: 1px solid transparent;
            }

            .source-tab:hover {
                background: #e8f5e9;
            }

            .source-tab.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .char-counter {
                text-align: right;
                font-size: 0.9em;
                margin-top: 5px;
                color: #666;
            }

            .form-hint {
                font-size: 0.9em;
                color: #666;
                font-style: italic;
                margin-top: 8px;
            }

            .grade-description {
                font-size: 0.9em;
                color: #666;
                font-style: italic;
                margin-top: 8px;
                padding: 8px;
                background: #f9f9f9;
                border-radius: 4px;
                border-left: 3px solid var(--primary-color);
            }

            .quiz-mode-options {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-top: 15px;
            }

            .mode-option input[type="radio"] {
                display: none;
            }

            .mode-option label {
                display: block;
                padding: 15px;
                background: white;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
            }

            .mode-option input[type="radio"]:checked + label {
                background: rgba(16, 185, 129, 0.1);
                border-color: var(--primary-color);
                color: var(--primary-color);
            }

            .mode-title {
                font-weight: 600;
                margin-bottom: 5px;
            }

            .mode-description {
                font-size: 0.9em;
                color: #666;
            }

            .dashboard-actions {
                display: flex;
                gap: 15px;
                margin-top: 15px;
            }

            .dashboard-btn {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
            }

            .dashboard-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

            @media (max-width: 768px) {
                .dashboard-actions {
                    flex-direction: column;
                }

                .quiz-mode-options {
                    grid-template-columns: 1fr;
                }
            }
        `;
        document.head.appendChild(contentSourceStyle);
    </script>
    <script>
// MISSING FUNCTIONS FIX - Add this to your geometry-quiz-creator.html

function getSelectedGeometryTypes() {
    const selectedTypes = [];
    const geometryCheckboxes = document.querySelectorAll('.geometry-type-checkbox:checked');
    
    geometryCheckboxes.forEach(checkbox => {
        selectedTypes.push(checkbox.value);
    });
    
    console.log(`üîí USER SELECTED GEOMETRY TYPES: [${selectedTypes.join(', ')}]`);
    return selectedTypes;
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({ behavior: 'smooth' });
    } else {
        alert(message);
    }
}

function setLoadingState(isLoading) {
    const generateBtn = document.getElementById('generate-btn');
    const loadingDiv = document.getElementById('loading');
    
    if (generateBtn) {
        generateBtn.disabled = isLoading;
        generateBtn.textContent = isLoading ? 'Generating...' : 'Generate Geometry Quiz';
    }
    
    if (loadingDiv) {
        loadingDiv.style.display = isLoading ? 'block' : 'none';
    }
}

// Enhanced authentication and quiz generation
async function generateGeometryQuizFixed() {
    console.log('üîê Starting geometry quiz generation...');
    
    try {
        // Get auth token
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
            alert('Please log in again');
            window.location.href = '/index.html';
            return;
        }
        
        // Get form values with null checks
        const gradeLevel = document.getElementById('grade-level')?.value;
        const topicInput = document.getElementById('topic-input');
        const topic = topicInput ? topicInput.value.trim() : '';
        const numQuestions = document.getElementById('num-questions')?.value || 5;
        const timeLimit = document.getElementById('time-limit')?.value || 30;
        
        // Validation
        if (!gradeLevel) {
            showError('Please select a grade level');
            return;
        }
        
        if (!topic) {
            showError('Please enter a topic');
            return;
        }
        
        // Get selected geometry types
        const selectedGeometryTypes = getSelectedGeometryTypes();
        
        // Show loading
        setLoadingState(true);
        
        // Prepare request
        const requestData = {
            topic: topic,
            grade_level: gradeLevel,
            time_limit: parseInt(timeLimit),
            numQuestions: parseInt(numQuestions),
            title: `${topic} Geometry Quiz`,
            types: ['multiple_choice'],
            mode: 'list',
            geometry_types: selectedGeometryTypes,
            strict_lockout: true
        };
        
        console.log('üì§ Sending request:', requestData);
        
        // Make request
       const response = await fetch('/api/generate-geometry-quiz-atomic', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(requestData)
});

if (response.status === 401) {
    alert('Session expired. Please log in again.');
    window.location.href = '/index.html';
    return;
}

if (!response.ok) {
    throw new Error(`Server error: ${response.status}`);
}

const data = await response.json();
console.log('‚úÖ Success:', data);

// Show results
if (data.quiz_data) {
    showQuizPreview(data.quiz_data, data.quiz_id);
    
    // ‚≠ê ADD THIS - Enable print functionality
    updateQuizDataForPrint(data.quiz_data);
} else if (data.quiz) {
    // Alternative structure
    showQuizPreview(data.quiz, data.quiz_id);
    updateQuizDataForPrint(data.quiz);
} else {
    // Data at root level
    showQuizPreview(data, data.quiz_id);
    updateQuizDataForPrint(data);
}

// Show quiz link
const quizUrl = `/geometry-quiz.html?id=${data.quiz_id}`;
document.getElementById('quiz-link').innerHTML = `
    <div class="success-message">
        <h3>Quiz Generated Successfully!</h3>
        <p>Quiz URL: <a href="${quizUrl}" target="_blank">${quizUrl}</a></p>
        <button onclick="window.open('${quizUrl}', '_blank')">Open Quiz</button>
    </div>
`;
document.getElementById('quiz-link').style.display = 'block';

} catch (error) {
    console.error('‚ùå Error:', error);
    showError(error.message || 'Failed to generate quiz');
    
    // ‚≠ê ADD THIS - Hide print buttons on error
    hidePrintButtons();
} finally {
    setLoadingState(false);
}}

// Replace the generate button handler
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-btn');
    if (generateBtn) {
        // Remove existing event listeners
        generateBtn.replaceWith(generateBtn.cloneNode(true));
        const newBtn = document.getElementById('generate-btn');
        
        // Add new event listener
        newBtn.addEventListener('click', generateGeometryQuizFixed);
        console.log('‚úÖ Fixed generate button initialized');
    }
});

console.log('üîß Missing functions fix loaded');
</script>
<script>
    /**
 * COMPREHENSIVE AUTHENTICATION FIX
 * Resolves session expiration issues in geometry quiz creator
 */

// 1. SIMPLIFIED TOKEN MANAGER (Replace the complex one)
class SimpleAuthManager {
    constructor() {
        this.tokenKey = 'token';
        this.userKey = 'user';
    }

    getToken() {
        // Try localStorage first, then sessionStorage
        return localStorage.getItem(this.tokenKey) || sessionStorage.getItem(this.tokenKey);
    }

    setToken(token) {
        localStorage.setItem(this.tokenKey, token);
        sessionStorage.setItem(this.tokenKey, token);
    }

    getUser() {
        const userStr = localStorage.getItem(this.userKey) || sessionStorage.getItem(this.userKey);
        try {
            return userStr ? JSON.parse(userStr) : null;
        } catch {
            return null;
        }
    }

    setUser(user) {
        const userStr = JSON.stringify(user);
        localStorage.setItem(this.userKey, userStr);
        sessionStorage.setItem(this.userKey, userStr);
    }

    clearAuth() {
        localStorage.removeItem(this.tokenKey);
        localStorage.removeItem(this.userKey);
        sessionStorage.removeItem(this.tokenKey);
        sessionStorage.removeItem(this.userKey);
        // Clear cookie
        document.cookie = `${this.tokenKey}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
    }

    isLoggedIn() {
        const token = this.getToken();
        return token && token.length > 0;
    }
}

// Initialize the auth manager
const authManager = new SimpleAuthManager();

// 2. FIXED QUIZ GENERATION FUNCTION
async function generateGeometryQuizFixed() {
    console.log('üîê Starting geometry quiz generation...');
    
    try {
        // Clear any previous errors
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        
        // Check authentication first
        if (!authManager.isLoggedIn()) {
            showAuthError('Please log in to generate quizzes');
            return;
        }

        // Get form values with validation
        const gradeLevel = document.getElementById('grade-level')?.value;
        const topicInput = document.getElementById('topic-input');
        const topic = topicInput ? topicInput.value.trim() : '';
        const numQuestions = document.getElementById('num-questions')?.value || 5;
        const timeLimit = document.getElementById('time-limit')?.value || 30;
        
        // Validate required fields
        if (!gradeLevel) {
            showError('Please select a grade level');
            return;
        }
        
        if (!topic) {
            showError('Please enter a topic');
            return;
        }
        
        // Get selected geometry types
        const selectedGeometryTypes = getSelectedGeometryTypes();
        
        // Show loading
        setLoadingState(true);
        
        // Prepare request data
        const requestData = {
            topic: topic,
            grade_level: gradeLevel,
            time_limit: parseInt(timeLimit),
            numQuestions: parseInt(numQuestions),
            title: `${topic} Geometry Quiz`,
            types: ['multiple_choice'],
            mode: 'list',
            geometry_types: selectedGeometryTypes,
            strict_lockout: true
        };
        
        console.log('üì§ Sending request:', requestData);
        
        // Make authenticated request
        const token = authManager.getToken();
        const response = await fetch('/api/generate-geometry-quiz-atomic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(requestData)
        });
        
        // Handle response
        if (response.status === 401) {
            console.error('‚ùå 401 Unauthorized');
            showAuthError('Your session has expired. Please log in again.');
            return;
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Server error:', errorText);
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Success:', data);
        
        // Show results
        if (data.quiz_data) {
            showQuizPreview(data.quiz_data, data.quiz_id);
        }
        
        showQuizSuccess(data);
        
    } catch (error) {
        console.error('‚ùå Error generating quiz:', error);
        
        if (error.message.includes('session') || error.message.includes('401')) {
            showAuthError('Your session has expired. Please log in again.');
        } else {
            showError(error.message || 'Failed to generate quiz. Please try again.');
        }
    } finally {
        setLoadingState(false);
    }
}

// 3. AUTHENTICATION ERROR HANDLER
function showAuthError(message) {
    const errorDiv = document.getElementById('error-message');
    if (errorDiv) {
        errorDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #dc3545; margin-bottom: 15px;">Authentication Required</h3>
                <p style="margin-bottom: 15px;">${message}</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="redirectToLogin()" 
                            style="background: #10B981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        Go to Login
                    </button>
                    <button onclick="location.reload()" 
                            style="background: #6B7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        Refresh Page
                    </button>
                </div>
            </div>
        `;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({ behavior: 'smooth' });
    } else {
        alert(message);
    }
}

// 4. REDIRECT TO LOGIN
function redirectToLogin() {
    authManager.clearAuth();
    sessionStorage.setItem('just_logged_out', 'true');
    window.location.href = '/index.html';
}

// 5. ENHANCED ERROR DISPLAY
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    if (errorDiv) {
        errorDiv.innerHTML = `
            <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                <strong>Error:</strong> ${message}
            </div>
        `;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({ behavior: 'smooth' });
    }
}

// 6. LOADING STATE MANAGER
function setLoadingState(isLoading) {
    const generateBtn = document.getElementById('generate-btn');
    const loadingDiv = document.getElementById('loading');
    
    if (generateBtn) {
        generateBtn.disabled = isLoading;
        generateBtn.textContent = isLoading ? 'Generating Quiz...' : 'Generate Geometry Quiz';
        generateBtn.style.opacity = isLoading ? '0.6' : '1';
    }
    
    if (loadingDiv) {
        loadingDiv.style.display = isLoading ? 'block' : 'none';
    }
    
    // Hide error when starting new request
    if (isLoading) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }
}

// 7. SUCCESS HANDLER - UPDATED WITH PRINT BUTTONS
function showQuizSuccess(data) {
    const quizUrl = `/geometry-quiz.html?id=${data.quiz_id}`;
    const fullUrl = `${window.location.origin}${quizUrl}`;
    
    const linkDiv = document.getElementById('quiz-link');
    if (linkDiv) {
        linkDiv.innerHTML = `
            <div class="success-message" style="background: #d1fae5; border: 2px solid #10B981; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="color: #047857; margin: 0 0 15px 0;">‚úÖ Quiz Generated Successfully!</h3>
                <p style="margin: 0 0 15px 0; color: #047857;">Share this link with your students:</p>
                <div style="display: flex; gap: 10px; margin: 15px 0;">
                    <input type="text" value="${fullUrl}" readonly 
                           style="flex: 1; padding: 10px; border: 2px solid #10B981; border-radius: 6px; font-family: monospace;"
                           onclick="this.select()">
                    <button onclick="copyToClipboard('${fullUrl}')" 
                            style="background: #10B981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; white-space: nowrap;">
                        üìã Copy
                    </button>
                </div>
                <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                    <button onclick="openQuizPreview('${quizUrl}')" 
                            style="background: #3B82F6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600;">
                        üëÅÔ∏è Preview Quiz
                    </button>
                
                    <button onclick="openPrintModal()" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);">
                        üëÅÔ∏è Preview & Print
                    </button>
                    <button onclick="printDirectly()" 
                            style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px rgba(79, 172, 254, 0.3);">
                        üñ®Ô∏è Quick Print
                    </button>
                </div>
            </div>
        `;
        linkDiv.style.display = 'block';
        linkDiv.scrollIntoView({ behavior: 'smooth' });
        
        // ‚≠ê IMPORTANT: Store quiz data for printing
        if (data.quiz_data) {
            updateQuizDataForPrint(data.quiz_data);
        } else if (data.quiz) {
            updateQuizDataForPrint(data.quiz);
        } else {
            updateQuizDataForPrint(data);
        }
    }
}

// 8. UTILITY FUNCTIONS
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showTempMessage('Link copied to clipboard!', 'success');
        }).catch(() => {
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showTempMessage('Link copied!', 'success');
    } catch (err) {
        console.error('Copy failed:', err);
        showTempMessage('Please copy the link manually', 'error');
    }
    
    document.body.removeChild(textArea);
}

function showTempMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

function openQuizPreview(quizUrl) {
    window.open(quizUrl, '_blank');
}

function viewQuizScores(quizId) {
    window.location.href = `/quiz-scores.html?id=${quizId}`;
}

// 9. GET SELECTED GEOMETRY TYPES
function getSelectedGeometryTypes() {
    const selectedTypes = [];
    document.querySelectorAll('.geometry-type-checkbox:checked').forEach(checkbox => {
        selectedTypes.push(checkbox.value);
    });
    
    console.log(`üîí Selected geometry types: [${selectedTypes.join(', ')}]`);
    return selectedTypes;
}

// 10. INITIALIZE ON PAGE LOAD
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîê Initializing fixed authentication system...');
    
    // Check if user is logged in
    if (!authManager.isLoggedIn()) {
        console.warn('‚ùå No authentication token found');
        showAuthError('Please log in to access the quiz creator');
        return;
    }
    
    // Display user info
    const user = authManager.getUser();
    if (user) {
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        
        if (userName) userName.textContent = user.name || 'User';
        if (userAvatar) userAvatar.textContent = (user.name || 'U').charAt(0).toUpperCase();
    }
    
    // Setup generate button
    const generateBtn = document.getElementById('generate-btn');
    if (generateBtn) {
        // Remove all existing event listeners by cloning the button
        const newBtn = generateBtn.cloneNode(true);
        generateBtn.parentNode.replaceChild(newBtn, generateBtn);
        
        // Add the fixed event listener
        newBtn.addEventListener('click', generateGeometryQuizFixed);
        
        console.log('‚úÖ Generate button initialized with fixed authentication');
    }
    
    // Setup dropdown functionality
    setupUserDropdown();
    
    console.log('‚úÖ Authentication system initialized successfully');
});

// 11. USER DROPDOWN SETUP
function setupUserDropdown() {
    const userInfoDropdown = document.getElementById('userInfoDropdown');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userInfoDropdown && userDropdown) {
        userInfoDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            userDropdown.classList.remove('active');
        });
        
        // Prevent dropdown from closing when clicking inside
        userDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Setup logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            redirectToLogin();
        });
    }
}

// 12. ADD REQUIRED CSS
const authStyles = document.createElement('style');
authStyles.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .success-message input:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .success-message button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .dropdown-menu.active {
        display: block;
        animation: slideIn 0.2s ease;
    }
`;

if (!document.getElementById('auth-styles')) {
    authStyles.id = 'auth-styles';
    document.head.appendChild(authStyles);
}

// 13. EXPOSE FUNCTIONS GLOBALLY
window.authManager = authManager;
window.generateGeometryQuizFixed = generateGeometryQuizFixed;
window.redirectToLogin = redirectToLogin;
window.copyToClipboard = copyToClipboard;
window.openQuizPreview = openQuizPreview;
window.viewQuizScores = viewQuizScores;

console.log('üîê AUTHENTICATION FIX LOADED!');
console.log('‚úÖ Features:');
console.log('   üîë Simplified token management');
console.log('   üö® Better error handling for 401 responses');
console.log('   üîÑ Automatic login redirect on auth failure');
console.log('   üìã Enhanced user feedback');
console.log('   ‚ö° Removed conflicting auth handlers');


</script>
<script>
    
</script>


   
   <script src="edit-question.js"></script>

<script>
// Enhanced shape rendering for quiz preview
function renderGeometryShapeInPreview(question, index) {
    const shapeContainer = document.getElementById(`shape-container-${index}`);
    if (!shapeContainer) {
        console.error(`Shape container not found: shape-container-${index}`);
        return;
    }
    
    console.log(`üéØ Checking question ${index} for shape data:`, question);
    
    // Check for shape data in the question
    let shapeData = question.shape_data ||
                   question.shapeData ||
                   question.geometry_data ||
                   question.geometryData;

    // If no shape data but has geometry info, try category mapping
    if (!shapeData && question.requires_geometry && question.geometry_type) {
        const categoryToShape = {
            'circles': 'circle', 'triangles': 'triangle', 'quadrilaterals': 'rectangle',
            'polygons': 'polygon', '3d_shapes': 'cube', 'angles': 'complementary_angles',
            'volume_surface': 'cylinder'
        };
        const mappedType = categoryToShape[question.geometry_type] || question.geometry_type;
        shapeData = { ai_assigned: true, shape_type: mappedType, validation_passed: true };
        console.log(`Created fallback shape data for Q${index} from category:`, shapeData);
    }

    // If no explicit shape data, analyze question text for geometry content
    if (!shapeData && question.text && hasGeometryKeywords(question.text)) {
        shapeData = analyzeQuestionForShapeData(question.text);
    }

    if (!shapeData) {
        shapeContainer.innerHTML = `
            <div style="padding: 15px; font-style: italic; color: #718096; text-align: center;">
                <span>No geometry shape required for this question</span>
            </div>
        `;
        return;
    }

    // Show loading
    shapeContainer.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; padding: 25px;">
            <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #10B981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 10px; color: #666;">Rendering geometry shape...</p>
        </div>
    `;

    // Determine the shape type to send - use the most specific available
    const shapeType = shapeData.shape_type || shapeData.type || 'circle';

    // Prepare API request
    const requestData = {
        type: shapeType,
        measurements: shapeData,
        question_context: {
            text: question.text,
            hide_answer: true,
            is_preview: true
        }
    };
    
    console.log(`üì§ Shape API request for Q${index}:`, requestData);
    
    // Make API call
    fetch('/api/geometry/render-shape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.image) {
            shapeContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                    <h4 style="color: #10B981; margin: 0 0 15px 0; text-align: center;">
                        ${(shapeData.shape_type || shapeData.type || 'Shape').charAt(0).toUpperCase() + 
                          (shapeData.shape_type || shapeData.type || 'Shape').slice(1)}
                    </h4>
                    <img src="${data.image}" style="width: 100%; height: auto; border-radius: 8px;" />
                </div>
            `;
        } else {
            throw new Error(data.error || 'Failed to render shape');
        }
    })
    .catch(error => {
        console.error(`‚ùå Shape error for Q${index}:`, error);
        shapeContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #dc3545; background: #f8d7da; border-radius: 8px;">
                <p>‚ö†Ô∏è Shape rendering failed</p>
                <p style="font-size: 12px;">${error.message}</p>
            </div>
        `;
    });
}

// Analyze question text to create shape data
// CRITICAL FIX: Added comprehensive shape detection for ALL shape types
function analyzeQuestionForShapeData(questionText) {
    const text = questionText.toLowerCase();

    // Detect shape type - comprehensive detection matching backend logic
    let shapeType = null;

    // Check for specific shapes in priority order
    if (text.includes('sector') || (text.includes('central angle') && text.includes('circle'))) shapeType = 'sector';
    else if (text.includes('triangular prism') || text.includes('prism')) shapeType = 'triangular_prism';
    else if (text.includes('rectangular prism') || text.includes('cuboid')) shapeType = 'rectangular_prism';
    else if (text.includes('cylinder')) shapeType = 'cylinder';
    else if (text.includes('cone')) shapeType = 'cone';
    else if (text.includes('sphere')) shapeType = 'sphere';
    else if (text.includes('cube')) shapeType = 'cube';
    else if (text.includes('trapezium') || text.includes('trapezoid')) shapeType = 'trapezium';
    else if (text.includes('right') && text.includes('triangle')) shapeType = 'right_triangle';
    else if (text.includes('equilateral') && text.includes('triangle')) shapeType = 'equilateral_triangle';
    else if (text.includes('isosceles') && text.includes('triangle')) shapeType = 'isosceles_triangle';
    else if (text.includes('scalene') && text.includes('triangle')) shapeType = 'scalene_triangle';
    else if (text.includes('triangle')) shapeType = 'triangle';
    else if (text.includes('rectangle')) shapeType = 'rectangle';
    else if (text.includes('square')) shapeType = 'square';
    else if (text.includes('pentagon')) shapeType = 'pentagon';
    else if (text.includes('hexagon')) shapeType = 'hexagon';
    else if (text.includes('octagon')) shapeType = 'octagon';
    else if (text.includes('polygon')) shapeType = 'polygon';
    else if (text.includes('circle')) shapeType = 'circle';
    else if (text.includes('parallel')) shapeType = 'parallel_lines';
    else shapeType = 'circle'; // Ultimate fallback

    // Extract basic measurements
    const measurements = { ai_assigned: true, shape_type: shapeType };

    // Extract numbers from question
    const numbers = text.match(/\d+(?:\.\d+)?/g);

    if (shapeType === 'pentagon' || shapeType === 'hexagon' || shapeType === 'octagon' || shapeType === 'polygon') {
        const shapeSides = { pentagon: 5, hexagon: 6, octagon: 8, polygon: 6 };
        measurements.sides = shapeSides[shapeType] || 6;
        if (numbers && numbers.length > 0) measurements.side_length = parseFloat(numbers[0]);
    } else if (shapeType === 'cube') {
        measurements.side = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 6;
    } else if (shapeType === 'circle' || shapeType === 'sphere') {
        measurements.radius = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 5;
    } else if (shapeType === 'cylinder' || shapeType === 'cone') {
        measurements.radius = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 5;
        measurements.height = (numbers && numbers.length > 1) ? parseFloat(numbers[1]) : 10;
    } else if (shapeType === 'rectangle' || shapeType === 'rectangular_prism') {
        measurements.length = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 10;
        measurements.width = (numbers && numbers.length > 1) ? parseFloat(numbers[1]) : 6;
    } else if (shapeType === 'square') {
        measurements.side = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 5;
    } else if (shapeType === 'trapezium') {
        measurements.parallel_side1 = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 10;
        measurements.parallel_side2 = (numbers && numbers.length > 1) ? parseFloat(numbers[1]) : 6;
        measurements.height = (numbers && numbers.length > 2) ? parseFloat(numbers[2]) : 8;
    } else if (shapeType.includes('triangle')) {
        measurements.base = (numbers && numbers.length > 0) ? parseFloat(numbers[0]) : 8;
        measurements.height = (numbers && numbers.length > 1) ? parseFloat(numbers[1]) : 6;
    }

    return measurements;
}

// Check if question has geometry keywords
function hasGeometryKeywords(questionText) {
    const keywords = [
        'pentagon', 'hexagon', 'octagon', 'cube', 'polygon', 'triangle', 'circle',
        'sphere', 'cylinder', 'cone', 'rectangle', 'square', 'trapezium', 'trapezoid',
        'prism', 'sector', 'parallel', 'angle', 'radius', 'diameter', 'area', 'volume',
        'perimeter', 'circumference'
    ];
    const text = questionText.toLowerCase();
    return keywords.some(keyword => text.includes(keyword));
}
</script>
<script>
// ==================== SIMPLIFIED PRINT FUNCTIONALITY ====================

// Global variable
let currentGeometryQuizDataForPrint = null;
let isEditMode = false;

// Simple function - just stores that quiz is ready
function updateQuizDataForPrint(data) {
    console.log('‚úÖ Quiz ready for printing');
    currentGeometryQuizDataForPrint = data; // Store for reference
}

// Open print modal - CLONES the rendered quiz
function openPrintModal() {
    console.log('=== OPENING PRINT MODAL ===');
    
    const modal = document.getElementById('printModal');
    const previewContainer = document.getElementById('printPreviewContainer');
    
    if (!modal || !previewContainer) {
        alert('Print modal not found. Please refresh the page.');
        return;
    }
    
    // Get the rendered quiz preview
    const quizPreview = document.getElementById('quiz-preview');
    
    if (!quizPreview || !quizPreview.innerHTML.trim()) {
        alert('Please generate a quiz first before printing.');
        return;
    }
    
    console.log('üìã Converting rendered quiz to printable format...');
    
    // Extract quiz metadata from page or use defaults
    const topic = extractTopicFromPage() || 'Geometry';
    const gradeLevel = extractGradeLevelFromPage() || 'High School';
    const questionCount = quizPreview.querySelectorAll('.question-item, .question, [class*="question"]').length;
    
    const printHTML = `
        <div class="print-quiz-header">
            <h1 class="print-quiz-title">Geometry Quiz</h1>
            <div class="print-quiz-metadata">
                <div><strong>Topic:</strong> ${topic}</div>
                <div><strong>Grade Level:</strong> ${gradeLevel}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                <div><strong>Total Questions:</strong> ${questionCount}</div>
            </div>
        </div>

        <div class="print-student-info">
            <table class="print-student-table">
                <tr>
                    <td class="print-info-label">Name:</td>
                    <td class="print-info-fill"></td>
                    <td class="print-info-label">Date:</td>
                    <td class="print-info-fill" style="width: 150px;"></td>
                </tr>
                <tr>
                    <td class="print-info-label">Class/Period:</td>
                    <td class="print-info-fill"></td>
                    <td class="print-info-label">Score:</td>
                    <td class="print-info-fill" style="width: 150px;"></td>
                </tr>
            </table>
        </div>

        <div class="print-instructions">
            <h3>Instructions</h3>
            <ul>
                <li>Read each question carefully before answering.</li>
                <li>For multiple choice questions, mark your answer clearly.</li>
                <li>Show all work for geometry calculations.</li>
                <li>Answer all questions before submitting.</li>
            </ul>
        </div>

        <div class="print-questions-container">
            ${convertQuizPreviewToPrintable(quizPreview)}
        </div>

        <div class="print-quiz-footer">
            <p><strong>End of Quiz</strong></p>
            <p style="margin-top: 10px; font-size: 14px;">Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
        </div>
    `;
    
    previewContainer.innerHTML = printHTML;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    console.log('‚úÖ Print preview generated successfully');
}

// Extract topic from the form or page
function extractTopicFromPage() {
    // Try to get topic from the form input
    const topicInput = document.getElementById('topic') || document.querySelector('input[name="topic"]');
    if (topicInput && topicInput.value) {
        return topicInput.value;
    }
    
    // Try to get from selected geometry types
    const selectedTypes = [];
    const typeCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked[id*="type-"]');
    typeCheckboxes.forEach(cb => {
        const label = document.querySelector(`label[for="${cb.id}"]`);
        if (label) {
            selectedTypes.push(label.textContent.trim());
        }
    });
    
    if (selectedTypes.length > 0) {
        return selectedTypes.join(', ');
    }
    
    return 'Geometry';
}

// Extract grade level from the form
function extractGradeLevelFromPage() {
    const gradeSelect = document.getElementById('grade-level') || document.querySelector('select[name="grade_level"]');
    if (gradeSelect && gradeSelect.value) {
        // Convert value to readable format
        const gradeMap = {
            'elementary': 'Elementary School',
            'middle': 'Middle School',
            'high': 'High School',
            'college': 'College'
        };
        return gradeMap[gradeSelect.value] || gradeSelect.value;
    }
    return 'High School';
}

// Convert rendered quiz preview to printable format - PERFECT FIX FOR YOUR STRUCTURE
function convertQuizPreviewToPrintable(quizPreviewElement) {
    let printableHTML = '';
    
    console.log('=== EXTRACTING QUESTIONS FROM GEOMETRY QUIZ ===');
    
    // Your structure: questions are in .questions-preview container
    const questionsContainer = quizPreviewElement.querySelector('.questions-preview');
    
    if (!questionsContainer) {
        console.error('‚ùå Could not find .questions-preview container');
        return '<p style="color: red; text-align: center; padding: 40px;">Quiz preview container not found.</p>';
    }
    
    // Each question is a .question-preview div
    const questionElements = questionsContainer.querySelectorAll('.question-preview');
    
    console.log(`‚úÖ Found ${questionElements.length} questions in .questions-preview`);
    
    if (questionElements.length === 0) {
        console.error('‚ùå No .question-preview elements found');
        return '<p style="color: red; text-align: center; padding: 40px;">No questions found in preview.</p>';
    }
    
    // Process each question
    questionElements.forEach((questionEl, index) => {
        const questionNumber = index + 1;
        console.log(`\n=== Processing Question ${questionNumber} ===`);
        console.log('Question ID:', questionEl.id);
        
        // Extract question text
        // Look for the actual question text (not the Q1 header)
        let questionText = '';
        
        // Try to find question text in common locations
        const textCandidates = [
            questionEl.querySelector('p:not(.question-type):not([class*="meta"])'),
            questionEl.querySelector('.question-text'),
            questionEl.querySelector('.question-content'),
            questionEl.querySelector('h4 + p'),
            questionEl.querySelector('h5')
        ];
        
        for (const candidate of textCandidates) {
            if (candidate && candidate.textContent.trim().length > 15) {
                questionText = candidate.textContent.trim();
                console.log('‚úÖ Found question text:', questionText.substring(0, 100));
                break;
            }
        }
        
        // Fallback: get all text and filter
        if (!questionText || questionText.length < 15) {
            const allText = questionEl.textContent;
            // Remove the Q1, Q2 etc headers and extract the actual question
            const lines = allText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 15 && !line.match(/^Q\d+$/));
            
            if (lines.length > 0) {
                questionText = lines[0];
                console.log('üìù Extracted from text:', questionText.substring(0, 100));
            }
        }
        
        // Clean up
        questionText = questionText
            .replace(/‚ôªÔ∏è\s*Regenerate/gi, '')
            .replace(/^\s*Q\d+\s*/g, '')
            .replace(/^\s*\d+\.\s*/, '')
            .trim();
        
        if (!questionText || questionText.length < 10) {
            console.warn(`‚ö†Ô∏è Could not extract valid question text for Q${questionNumber}`);
            questionText = `Question ${questionNumber}`;
        }
        
        // Find geometry shape image
        let shapeHTML = '';
        const shapeImg = questionEl.querySelector('img');
        
        if (shapeImg && shapeImg.src) {
            console.log('‚úÖ Found geometry shape image');
            shapeHTML = `
                <div class="print-geometry-shape" style="margin: 20px 0; text-align: center; background: #f9fafb; padding: 20px; border-radius: 8px;">
                    <img src="${shapeImg.src}" 
                         alt="Geometry Shape" 
                         style="max-width: 500px; width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 8px;" />
                </div>
            `;
        } else {
            console.log('‚ö†Ô∏è No geometry image found for this question');
        }
        
        let optionsHTML = '';

console.log('Looking for options in question...');

// Your structure: .options-preview container with .option-preview children
const optionsContainer = questionEl.querySelector('.options-preview');

if (optionsContainer) {
    console.log('‚úÖ Found .options-preview container');
    
    const optionElements = optionsContainer.querySelectorAll('.option-preview');
    console.log(`‚úÖ Found ${optionElements.length} option elements`);
    
    if (optionElements.length >= 2) {
        optionsHTML = '<div class="print-question-options">';
        
        optionElements.forEach((optEl, idx) => {
            let optionText = optEl.textContent.trim();
            
            // Clean up option text - remove extra whitespace
            optionText = optionText
                .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
                .replace(/^[A-D]\)\s*/, '')  // Remove A), B), C), D) prefix
                .replace(/‚úì/g, '')  // Remove checkmarks
                .replace(/‚úó/g, '')  // Remove X marks
                .trim();
            
            if (optionText && optionText.length > 0 && optionText.length < 300) {
                console.log(`  Option ${idx + 1}: ${optionText.substring(0, 60)}`);
                
                optionsHTML += `
                    <div class="print-option-item">
                        <div class="print-option-marker radio"></div>
                        <span class="print-option-text">${escapeHtml(optionText)}</span>
                    </div>
                `;
            }
        });
        
        optionsHTML += '</div>';
        console.log('‚úÖ Options HTML generated successfully');
    } else {
        console.log('‚ö†Ô∏è Not enough options found, treating as open-ended');
        optionsHTML = `
            <div class="print-answer-space">
                <div class="print-answer-line"></div>
                <div class="print-answer-line"></div>
                <div class="print-answer-line"></div>
                <div class="print-answer-line"></div>
            </div>
        `;
    }
} else {
    // No .options-preview container - might be a paragraph question
    console.log('‚ö†Ô∏è No .options-preview container found - treating as open-ended question');
    optionsHTML = `
        <div class="print-answer-space">
            <div class="print-answer-line"></div>
            <div class="print-answer-line"></div>
            <div class="print-answer-line"></div>
            <div class="print-answer-line"></div>
        </div>
    `;
}
        
        // Build the printable question
        printableHTML += `
            <div class="print-question-item">
                <div class="print-question-header">
                    <span class="print-question-number">${questionNumber}.</span>
                    <div class="print-question-text">${escapeHtml(questionText)}</div>
                </div>
                ${shapeHTML}
                ${optionsHTML}
            </div>
        `;
    });
    
    console.log(`\n‚úÖ Successfully converted ${questionElements.length} questions to printable format\n`);
    return printableHTML;
}

// Close print modal
function closePrintModal() {
    const modal = document.getElementById('printModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

// Print directly without preview
function printDirectly() {
    console.log('=== DIRECT PRINT ===');
    
    const quizPreview = document.getElementById('quiz-preview');
    if (!quizPreview || !quizPreview.innerHTML.trim()) {
        alert('Please generate a quiz first before printing.');
        return;
    }
    
    openPrintModal();
    setTimeout(() => {
        window.print();
    }, 500);
}

// Print from modal
function printFromModal() {
    window.print();
}

// HTML escape function
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Toggle edit mode (simplified - full edit functionality can be added later)
function toggleEditMode() {
    alert('Edit mode coming soon! For now, you can regenerate the quiz if changes are needed.');
}

function saveEditedPreview() {
    alert('Changes saved!');
}

function cancelEditing() {
    alert('Editing cancelled.');
}

// Close modal with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePrintModal();
    }
});

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('printModal');
    if (e.target === modal) {
        closePrintModal();
    }
});

console.log('‚úÖ Geometry Quiz Print Functionality Loaded (Clone Mode)');

</script>
<script>
    // ==================== IMAGE SIZE ADJUSTMENT ====================

let currentImageSize = 400; // Default medium size

// Adjust image size in preview
function adjustImageSize(size) {
    console.log('Adjusting image size to:', size);
    
    const customInput = document.getElementById('customImageSize');
    const applyBtn = document.getElementById('applyCustomBtn');
    
    // Update button active states
    document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
    
    let newSize;
    
    switch(size) {
        case 'small':
            newSize = 200;
            event.target.classList.add('active');
            customInput.style.display = 'none';
            applyBtn.style.display = 'none';
            break;
        case 'medium':
            newSize = 400;
            event.target.classList.add('active');
            customInput.style.display = 'none';
            applyBtn.style.display = 'none';
            break;
        case 'large':
            newSize = 600;
            event.target.classList.add('active');
            customInput.style.display = 'none';
            applyBtn.style.display = 'none';
            break;
        case 'custom':
            event.target.classList.add('active');
            customInput.style.display = 'inline-block';
            applyBtn.style.display = 'inline-block';
            customInput.focus();
            return; // Don't apply size yet, wait for user input
    }
    
    currentImageSize = newSize;
    applyImageSize(newSize);
}

// Apply custom size
function applyCustomSize() {
    const customInput = document.getElementById('customImageSize');
    const customSize = parseInt(customInput.value);
    
    if (customSize && customSize >= 100 && customSize <= 800) {
        currentImageSize = customSize;
        applyImageSize(customSize);
        console.log('Applied custom size:', customSize);
    } else {
        alert('Please enter a size between 100 and 800 pixels.');
    }
}

// Apply the size to all images
function applyImageSize(size) {
    const previewContainer = document.getElementById('printPreviewContainer');
    const images = previewContainer.querySelectorAll('.print-geometry-shape img');
    
    console.log(`Resizing ${images.length} images to ${size}px`);
    
    images.forEach(img => {
        img.style.maxWidth = `${size}px`;
        img.style.width = '100%';
        img.style.height = 'auto';
    });
    
    // Update the parent containers too
    const shapeContainers = previewContainer.querySelectorAll('.print-geometry-shape');
    shapeContainers.forEach(container => {
        container.style.maxWidth = `${size + 40}px`; // Add padding
        container.style.margin = '20px auto'; // Center it
    });
}

// Toggle edit mode with visual feedback
function toggleEditMode() {
    const previewContainer = document.getElementById('printPreviewContainer');
    const isEditable = previewContainer.getAttribute('contenteditable') === 'true';
    
    if (isEditable) {
        // Disable editing
        previewContainer.setAttribute('contenteditable', 'false');
        event.target.textContent = '‚úèÔ∏è Edit Mode';
        event.target.style.background = '#6B7280';
        console.log('Edit mode: OFF');
    } else {
        // Enable editing
        previewContainer.setAttribute('contenteditable', 'true');
        event.target.textContent = 'üîí Lock Editing';
        event.target.style.background = '#F59E0B';
        console.log('Edit mode: ON');
        
        // Show tip
        setTimeout(() => {
            alert('‚úèÔ∏è Edit Mode Enabled!\n\n‚Ä¢ Click any text to edit it\n‚Ä¢ Click images to see resize options\n‚Ä¢ All changes are temporary (for this print only)');
        }, 100);
    }
}

// Make images clickable for quick resize
function makeImagesInteractive() {
    const previewContainer = document.getElementById('printPreviewContainer');
    const images = previewContainer.querySelectorAll('.print-geometry-shape img');
    
    images.forEach(img => {
        img.style.cursor = 'pointer';
        img.title = 'Click to resize';
        
        img.addEventListener('click', function(e) {
            e.stopPropagation();
            const currentWidth = parseInt(this.style.maxWidth) || 400;
            
            const newSize = prompt(
                `Current image width: ${currentWidth}px\n\nEnter new width (100-800):`,
                currentWidth
            );
            
            if (newSize && !isNaN(newSize)) {
                const size = parseInt(newSize);
                if (size >= 100 && size <= 800) {
                    this.style.maxWidth = `${size}px`;
                    this.parentElement.style.maxWidth = `${size + 40}px`;
                    console.log('Image resized to:', size);
                } else {
                    alert('Size must be between 100 and 800 pixels.');
                }
            }
        });
    });
}

// Update openPrintModal to enable interactive features
function openPrintModal() {
    console.log('=== OPENING PRINT MODAL ===');
    
    const modal = document.getElementById('printModal');
    const previewContainer = document.getElementById('printPreviewContainer');
    
    if (!modal || !previewContainer) {
        alert('Print modal not found. Please refresh the page.');
        return;
    }
    
    const quizPreview = document.getElementById('quiz-preview');
    
    if (!quizPreview || !quizPreview.innerHTML.trim()) {
        alert('Please generate a quiz first before printing.');
        return;
    }
    
    console.log('üìã Converting rendered quiz to printable format...');
    
    const topic = extractTopicFromPage() || 'Geometry';
    const gradeLevel = extractGradeLevelFromPage() || 'High School';
    const questionsContainer = quizPreview.querySelector('.questions-preview');
    const questionElements = questionsContainer ? questionsContainer.querySelectorAll('.question-preview') : [];
    
    const printHTML = `
        <div class="print-quiz-header">
            <h1 class="print-quiz-title" contenteditable="true">Geometry Quiz</h1>
            <div class="print-quiz-metadata">
                <div><strong>Topic:</strong> <span contenteditable="true">${topic}</span></div>
                <div><strong>Grade Level:</strong> <span contenteditable="true">${gradeLevel}</span></div>
                <div><strong>Date:</strong> <span contenteditable="true">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span></div>
                <div><strong>Total Questions:</strong> ${questionElements.length}</div>
            </div>
        </div>

        <div class="print-student-info">
            <table class="print-student-table">
                <tr>
                    <td class="print-info-label">Name:</td>
                    <td class="print-info-fill" contenteditable="true"></td>
                    <td class="print-info-label">Date:</td>
                    <td class="print-info-fill" contenteditable="true" style="width: 150px;"></td>
                </tr>
                <tr>
                    <td class="print-info-label">Class/Period:</td>
                    <td class="print-info-fill" contenteditable="true"></td>
                    <td class="print-info-label">Score:</td>
                    <td class="print-info-fill" contenteditable="true" style="width: 150px;"></td>
                </tr>
            </table>
        </div>

        <div class="print-instructions">
            <h3>Instructions</h3>
            <ul contenteditable="true">
                <li>Read each question carefully before answering.</li>
                <li>For multiple choice questions, mark your answer clearly.</li>
                <li>Show all work for geometry calculations.</li>
                <li>Answer all questions before submitting.</li>
            </ul>
        </div>

        <div class="print-questions-container">
            ${convertQuizPreviewToPrintable(quizPreview)}
        </div>

        <div class="print-quiz-footer">
            <p><strong>End of Quiz</strong></p>
            <p style="margin-top: 10px; font-size: 14px;">Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
        </div>
    `;
    
    previewContainer.innerHTML = printHTML;
    previewContainer.setAttribute('contenteditable', 'true'); // Enable editing by default
    
    // Apply default medium size
    applyImageSize(currentImageSize);
    
    // Make images interactive
    makeImagesInteractive();
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    console.log('‚úÖ Print preview generated successfully');
}
</script>
<!-- Print Modal -->
<div id="printModal" class="print-modal">
    <div class="print-modal-content">
        <div class="print-modal-header">
            <h2>üìÑ Geometry Quiz Print Preview</h2>
            
            <!-- NEW: Image Size Controls -->
            <div class="print-controls" style="display: flex; align-items: center; gap: 15px; margin: 10px 0;">
                <label style="font-size: 14px; font-weight: 600;">Image Size:</label>
                <button onclick="adjustImageSize('small')" class="size-btn">Small (200px)</button>
                <button onclick="adjustImageSize('medium')" class="size-btn active">Medium (400px)</button>
                <button onclick="adjustImageSize('large')" class="size-btn">Large (600px)</button>
                <button onclick="adjustImageSize('custom')" class="size-btn">Custom</button>
                <input type="number" id="customImageSize" placeholder="Width (px)" 
                       style="width: 100px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; display: none;">
                <button onclick="applyCustomSize()" id="applyCustomBtn" 
                        style="display: none; padding: 8px 16px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Apply
                </button>
            </div>
            
            <button class="print-modal-close" onclick="closePrintModal()">√ó</button>
        </div>
        
        <!-- Editable Preview Container -->
        <div id="printPreviewContainer" class="print-preview-content" contenteditable="true">
            <!-- Quiz content will be inserted here -->
        </div>
        
        <div class="print-modal-footer">
            <button onclick="toggleEditMode()" id="editPreviewBtn" class="modal-btn modal-btn-secondary">
                ‚úèÔ∏è Edit Mode
            </button>
            <button onclick="closePrintModal()" class="modal-btn modal-btn-secondary">
                Close
            </button>
            <button onclick="printFromModal()" class="modal-btn modal-btn-primary">
                üñ®Ô∏è Print Now
            </button>
        </div>
    </div>
</div>
<script>
    /**
 * EDIT BUTTON FIX - Comprehensive solution for edit functionality
 *
 * This file ensures the edit button works correctly and addresses
 * common issues with modal rendering and event handling.
 */

(function() {
    'use strict';

    console.log('üîß Edit Button Fix - Initializing...');

    /**
     * Ensure edit-question.js functions are available
     */
    function ensureEditFunctionsExist() {
        // Check if main edit functions exist
        if (!window.openEditQuestionModal) {
            console.warn('‚ö†Ô∏è openEditQuestionModal not found - defining backup');

            window.openEditQuestionModal = function(questionIndex) {
                console.log('üìù Opening edit modal for question:', questionIndex);

                // Check if quizData exists
                if (!window.quizData || !window.quizData.questions) {
                    console.error('‚ùå Quiz data not found');
                    alert('Error: Quiz data not available. Please ensure questions are loaded.');
                    return;
                }

                const question = window.quizData.questions[questionIndex];
                if (!question) {
                    console.error('‚ùå Question not found:', questionIndex);
                    alert('Error: Question not found.');
                    return;
                }

                // Create and show modal
                createEditModal(question, questionIndex);
            };
        }

        if (!window.closeEditQuestionModal) {
            window.closeEditQuestionModal = function() {
                const modal = document.getElementById('edit-question-modal');
                if (modal) {
                    modal.remove();
                }
            };
        }

        if (!window.addNewOption) {
            window.addNewOption = function() {
                const container = document.getElementById('edit-options-container');
                if (!container) return;

                const currentOptions = container.querySelectorAll('.edit-option-row');
                const newIndex = currentOptions.length;

                const newOptionHTML = `
                    <div class="edit-option-row" data-option-index="${newIndex}">
                        <input type="text"
                               class="edit-option-input"
                               data-option-index="${newIndex}"
                               value=""
                               placeholder="Option ${newIndex + 1}">
                        <label class="edit-checkbox-label">
                            <input type="checkbox"
                                   class="edit-correct-checkbox"
                                   data-option-index="${newIndex}">
                            <span class="checkbox-text">Correct</span>
                        </label>
                        <button class="remove-option-btn" onclick="removeOption(${newIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', newOptionHTML);
            };
        }

        if (!window.removeOption) {
            window.removeOption = function(optionIndex) {
                const container = document.getElementById('edit-options-container');
                if (!container) return;

                const rows = container.querySelectorAll('.edit-option-row');

                if (rows.length <= 2) {
                    alert('A question must have at least 2 options.');
                    return;
                }

                const rowToRemove = container.querySelector(`.edit-option-row[data-option-index="${optionIndex}"]`);
                if (rowToRemove) {
                    rowToRemove.remove();

                    // Re-index remaining options
                    const remainingRows = container.querySelectorAll('.edit-option-row');
                    remainingRows.forEach((row, idx) => {
                        row.setAttribute('data-option-index', idx);
                        row.querySelector('.edit-option-input').setAttribute('data-option-index', idx);
                        row.querySelector('.edit-option-input').placeholder = `Option ${idx + 1}`;
                        row.querySelector('.edit-correct-checkbox').setAttribute('data-option-index', idx);

                        const removeBtn = row.querySelector('.remove-option-btn');
                        if (removeBtn) {
                            removeBtn.setAttribute('onclick', `removeOption(${idx})`);
                        }
                    });
                }
            };
        }

        if (!window.saveQuestionEdits) {
            window.saveQuestionEdits = async function(questionIndex) {
                console.log('üíæ Saving edits for question:', questionIndex);

                try {
                    const question = window.quizData.questions[questionIndex];

                    // Get edited question text
                    const newQuestionText = document.getElementById('edit-question-text').value.trim();
                    if (!newQuestionText) {
                        alert('Question text cannot be empty.');
                        return;
                    }

                    // Get edited options
                    const optionInputs = document.querySelectorAll('.edit-option-input');
                    const correctCheckboxes = document.querySelectorAll('.edit-correct-checkbox');

                    const newOptions = [];
                    let hasCorrectAnswer = false;

                    optionInputs.forEach((input, idx) => {
                        const optionText = input.value.trim();
                        if (optionText) {
                            const isCorrect = correctCheckboxes[idx].checked;
                            if (isCorrect) hasCorrectAnswer = true;

                            newOptions.push({
                                text: optionText,
                                isCorrect: isCorrect
                            });
                        }
                    });

                    if (newOptions.length < 2) {
                        alert('A question must have at least 2 options.');
                        return;
                    }

                    if (!hasCorrectAnswer) {
                        alert('Please mark at least one option as correct.');
                        return;
                    }

                    // Update question data
                    question.text = newQuestionText;
                    question.options = newOptions;

                    // Save shape parameters if available
                    if (question.shape_data) {
                        saveShapeParameters(question);
                    }

                    // Update UI
                    if (typeof updateQuestionUI === 'function') {
                        updateQuestionUI(questionIndex);
                    }

                    // Close modal
                    window.closeEditQuestionModal();

                    // Show success
                    showSuccessToast('Question updated successfully!');

                    console.log('‚úÖ Question updated:', question);

                } catch (error) {
                    console.error('‚ùå Error saving question edits:', error);
                    alert('Error saving changes. Please try again.');
                }
            };
        }

        console.log('‚úÖ Edit functions verified/created');
    }

    /**
     * Create edit modal
     */
    function createEditModal(question, questionIndex) {
        // Remove existing modal if any
        const existingModal = document.getElementById('edit-question-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
            <div id="edit-question-modal" class="edit-modal-overlay">
                <div class="edit-modal-container">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-edit"></i> Edit Question ${questionIndex + 1}</h3>
                        <button class="close-modal-btn" onclick="closeEditQuestionModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="edit-modal-content">
                        <!-- Question Text Section -->
                        <div class="edit-section">
                            <label class="edit-label">
                                <i class="fas fa-question-circle"></i> Question Text
                            </label>
                            <textarea id="edit-question-text" class="edit-textarea" rows="4">${escapeHtml(question.text)}</textarea>
                        </div>

                        <!-- Answer Options Section -->
                        <div class="edit-section">
                            <label class="edit-label">
                                <i class="fas fa-list"></i> Answer Options
                            </label>
                            <div id="edit-options-container">
                                ${question.options.map((option, idx) => `
                                    <div class="edit-option-row" data-option-index="${idx}">
                                        <input type="text"
                                               class="edit-option-input"
                                               data-option-index="${idx}"
                                               value="${escapeHtml(option.text)}"
                                               placeholder="Option ${idx + 1}">
                                        <label class="edit-checkbox-label">
                                            <input type="checkbox"
                                                   class="edit-correct-checkbox"
                                                   data-option-index="${idx}"
                                                   ${option.isCorrect ? 'checked' : ''}>
                                            <span class="checkbox-text">Correct</span>
                                        </label>
                                        ${question.options.length > 2 ? `
                                            <button class="remove-option-btn" onclick="removeOption(${idx})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option-btn" onclick="addNewOption()">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>

                        <!-- Shape Parameters Section -->
                        ${question.shape_data ? `
                            <div class="edit-section">
                                <label class="edit-label">
                                    <i class="fas fa-shapes"></i> Shape Parameters
                                    <span class="shape-type-badge-small">${question.shape_data.shape_type || 'shape'}</span>
                                </label>
                                <div id="edit-shape-params-container">
                                    ${renderShapeParametersForm(question.shape_data)}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="edit-modal-footer">
                        <button class="modal-btn cancel-btn" onclick="closeEditQuestionModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="modal-btn save-btn" onclick="saveQuestionEdits(${questionIndex})">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    /**
     * Render shape parameters form
     */
    function renderShapeParametersForm(shapeData) {
        if (!shapeData || !shapeData.shape_type) {
            return `<p class="no-params-message">No shape parameters available.</p>`;
        }

        const shapeType = shapeData.shape_type.toLowerCase();
        let html = '';

        // Triangle/Right Triangle
        if (shapeType.includes('triangle') || shapeType === 'right_triangle') {
            html = `
                <div class="shape-param-row">
                    <label>Side 1 (cm):</label>
                    <input type="number" id="edit-side1" value="${shapeData.side1 || shapeData.a || ''}" step="0.1" min="0">
                </div>
                <div class="shape-param-row">
                    <label>Side 2 (cm):</label>
                    <input type="number" id="edit-side2" value="${shapeData.side2 || shapeData.b || ''}" step="0.1" min="0">
                </div>
                <div class="shape-param-row">
                    <label>Hypotenuse (cm):</label>
                    <input type="number" id="edit-hypotenuse" value="${shapeData.hypotenuse || shapeData.c || ''}" step="0.1" min="0">
                </div>
            `;

            // Add marker fields if integration is available
            if (typeof addMarkerEditingFields === 'function') {
                html += addMarkerEditingFields(shapeData, shapeType);
            }
        }

        return html || `<p class="no-params-message">No editable parameters for this shape type.</p>`;
    }

    /**
     * Save shape parameters
     */
    function saveShapeParameters(question) {
        const shapeType = (question.shape_data.shape_type || '').toLowerCase();

        if (shapeType.includes('triangle') || shapeType === 'right_triangle') {
            const side1Input = document.getElementById('edit-side1');
            const side2Input = document.getElementById('edit-side2');
            const hypotenuseInput = document.getElementById('edit-hypotenuse');

            if (side1Input && side1Input.value) {
                question.shape_data.side1 = parseFloat(side1Input.value);
                question.shape_data.a = parseFloat(side1Input.value);
            }
            if (side2Input && side2Input.value) {
                question.shape_data.side2 = parseFloat(side2Input.value);
                question.shape_data.b = parseFloat(side2Input.value);
            }
            if (hypotenuseInput && hypotenuseInput.value) {
                question.shape_data.hypotenuse = parseFloat(hypotenuseInput.value);
                question.shape_data.c = parseFloat(hypotenuseInput.value);
            }

            // Save marker data if integration is available
            if (typeof saveMarkerData === 'function') {
                saveMarkerData(question);
            }
        }
    }

    /**
     * Show success toast
     */
    function showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'success-toast';
        toast.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        `;
        toast.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            z-index: 10001;
            animation: slideInUp 0.3s ease;
            opacity: 0;
        `;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.style.opacity = '1';
        }, 100);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    /**
     * Escape HTML to prevent XSS
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Set up enhanced event delegation
     */
    function setupEnhancedEventDelegation() {
        console.log('üéØ Setting up enhanced event delegation');

        // Remove any existing listeners
        document.removeEventListener('click', handleEditButtonClick);

        // Add new listener
        document.addEventListener('click', handleEditButtonClick);

        console.log('‚úÖ Enhanced event delegation set up');
    }

    /**
     * Handle edit button clicks
     */
    function handleEditButtonClick(e) {
        // Check if clicked element or parent is edit button
        const editBtn = e.target.closest('.edit-btn');

        if (editBtn) {
            e.preventDefault();
            e.stopPropagation();

            const questionIndex = parseInt(editBtn.getAttribute('data-index'));

            if (!isNaN(questionIndex)) {
                console.log('‚úèÔ∏è Edit button clicked for question:', questionIndex);
                window.openEditQuestionModal(questionIndex);
            } else {
                console.error('‚ùå Invalid question index:', editBtn.getAttribute('data-index'));
            }
        }
    }

    /**
     * Initialize fix
     */
    function initialize() {
        console.log('üöÄ Initializing edit button fix...');

        // Ensure edit functions exist
        ensureEditFunctionsExist();

        // Set up event delegation
        setupEnhancedEventDelegation();

        // Add CSS if needed
        addEditButtonStyles();

        console.log('‚úÖ Edit button fix initialized successfully!');
    }

    /**
     * Add edit button styles if not present
     */
    function addEditButtonStyles() {
        if (document.getElementById('edit-button-fix-styles')) {
            return; // Already added
        }

        const style = document.createElement('style');
        style.id = 'edit-button-fix-styles';
        style.textContent = `
            @keyframes slideInUp {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .shape-type-badge-small {
                background: #EFF6FF;
                color: #3B82F6;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                margin-left: 8px;
            }

            .no-params-message {
                color: #6B7280;
                font-style: italic;
                text-align: center;
                padding: 20px;
            }

            .shape-param-row {
                display: grid;
                grid-template-columns: 150px 1fr;
                gap: 10px;
                align-items: center;
                margin-bottom: 10px;
            }

            .shape-param-row label {
                font-weight: 600;
                color: #374151;
            }

            .shape-param-row input {
                padding: 8px 12px;
                border: 2px solid #E5E7EB;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.3s ease;
            }

            .shape-param-row input:focus {
                outline: none;
                border-color: #10B981;
            }
        `;

        document.head.appendChild(style);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }

    console.log('‚úÖ Edit Button Fix module loaded');

})();
</script>
<script>
/**
 * ENHANCED EDIT MODAL WITH FULL OPTION EDITING
 * Allows editing questions, options, and shape parameters
 */
(function() {
    'use strict';
    
    console.log('üöÄ Loading enhanced edit modal with full option editing...');
    
    // Add required CSS for modal
    function addModalStyles() {
        if (document.getElementById('edit-modal-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'edit-modal-styles';
        style.textContent = `
            /* Edit Modal Overlay */
            .edit-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex !important;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            /* Edit Modal Container */
            .edit-modal-container {
                background: white;
                border-radius: 16px;
                max-width: 800px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.3s ease;
            }
            
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            /* Modal Header */
            .edit-modal-header {
                padding: 20px 30px;
                border-bottom: 2px solid #E5E7EB;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                color: white;
                border-radius: 16px 16px 0 0;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            .edit-modal-header h3 {
                margin: 0;
                font-size: 20px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .close-modal-btn {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                line-height: 1;
            }
            
            .close-modal-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: rotate(90deg);
            }
            
            /* Modal Content */
            .edit-modal-content {
                padding: 30px;
            }
            
            .edit-section {
                margin-bottom: 30px;
                padding: 20px;
                background: #F9FAFB;
                border-radius: 12px;
                border: 1px solid #E5E7EB;
            }
            
            .edit-label {
                display: block;
                font-weight: 600;
                margin-bottom: 12px;
                color: #374151;
                font-size: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .edit-textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #E5E7EB;
                border-radius: 8px;
                font-size: 15px;
                font-family: inherit;
                resize: vertical;
                transition: border-color 0.3s ease;
                background: white;
            }
            
            .edit-textarea:focus {
                outline: none;
                border-color: #10B981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            }
            
            /* Options Container */
            #edit-options-container {
                margin-bottom: 15px;
            }
            
            .edit-option-row {
                display: grid;
                grid-template-columns: 1fr auto auto;
                gap: 10px;
                align-items: center;
                margin-bottom: 12px;
                padding: 12px;
                background: white;
                border-radius: 8px;
                border: 2px solid #E5E7EB;
                transition: all 0.3s ease;
            }
            
            .edit-option-row:hover {
                border-color: #10B981;
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
            }
            
            .edit-option-input {
                padding: 10px 12px;
                border: 2px solid #E5E7EB;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.3s ease;
                background: white;
            }
            
            .edit-option-input:focus {
                outline: none;
                border-color: #10B981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            }
            
            .edit-checkbox-label {
                display: flex;
                align-items: center;
                gap: 6px;
                white-space: nowrap;
                cursor: pointer;
                padding: 8px 12px;
                background: #F3F4F6;
                border-radius: 6px;
                transition: all 0.3s ease;
            }
            
            .edit-checkbox-label:hover {
                background: #E5E7EB;
            }
            
            .edit-correct-checkbox {
                width: 20px;
                height: 20px;
                cursor: pointer;
                accent-color: #10B981;
            }
            
            .checkbox-text {
                font-size: 14px;
                color: #374151;
                font-weight: 500;
            }
            
            .remove-option-btn {
                background: linear-gradient(135deg, #EF4444, #DC2626);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 20px;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .remove-option-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            }
            
            .add-option-btn {
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.3s ease;
                width: 100%;
                font-size: 15px;
            }
            
            .add-option-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
            }
            
            .option-counter {
                background: #EFF6FF;
                color: #3B82F6;
                padding: 4px 12px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                margin-left: auto;
            }
            
            /* Shape Parameters */
            .shape-param-row {
                display: grid;
                grid-template-columns: 180px 1fr;
                gap: 12px;
                align-items: center;
                margin-bottom: 12px;
                padding: 10px;
                background: white;
                border-radius: 8px;
            }
            
            .shape-param-row label {
                font-weight: 600;
                color: #374151;
                font-size: 14px;
            }
            
            .shape-param-row input {
                padding: 10px 12px;
                border: 2px solid #E5E7EB;
                border-radius: 6px;
                font-size: 14px;
                background: white;
            }
            
            .shape-param-row input:focus {
                outline: none;
                border-color: #10B981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            }
            
            /* Modal Footer */
            .edit-modal-footer {
                padding: 20px 30px;
                border-top: 2px solid #E5E7EB;
                display: flex;
                gap: 15px;
                justify-content: space-between;
                align-items: center;
                background: #F9FAFB;
                border-radius: 0 0 16px 16px;
                position: sticky;
                bottom: 0;
            }
            
            .modal-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .cancel-btn {
                background: #6B7280;
                color: white;
            }
            
            .cancel-btn:hover {
                background: #4B5563;
                transform: translateY(-2px);
            }
            
            .save-btn {
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                color: white;
            }
            
            .save-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
            }
            
            .regenerate-options-btn {
                background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
                color: white;
            }
            
            .regenerate-options-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3);
            }
            
            /* Success Toast */
            .success-toast {
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: linear-gradient(135deg, #10B981, #059669);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                z-index: 10001;
                animation: slideInUp 0.3s ease;
            }
            
            @keyframes slideInUp {
                from { transform: translateY(100px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            /* Loading State */
            .option-loading {
                text-align: center;
                padding: 20px;
                color: #6B7280;
            }
            
            .spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #10B981;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                margin: 0 auto 10px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* Responsive */
            @media (max-width: 768px) {
                .edit-modal-container {
                    width: 95%;
                    max-height: 95vh;
                }
                
                .edit-modal-header,
                .edit-modal-content,
                .edit-modal-footer {
                    padding: 15px 20px;
                }
                
                .shape-param-row {
                    grid-template-columns: 1fr;
                }
                
                .edit-option-row {
                    grid-template-columns: 1fr;
                    gap: 8px;
                }
                
                .edit-checkbox-label {
                    justify-content: center;
                }
                
                .remove-option-btn {
                    width: 100%;
                }
                
                .edit-modal-footer {
                    flex-direction: column;
                    gap: 10px;
                }
                
                .modal-btn {
                    width: 100%;
                    justify-content: center;
                }
            }
        `;
        document.head.appendChild(style);
        console.log('‚úÖ Modal styles added');
    }
    
    // Main edit modal function
    window.openEditQuestionModal = function(questionIndex) {
        console.log('üéØ OPENING EDIT MODAL FOR QUESTION:', questionIndex);
        
        // Verify quiz data exists
        if (!window.quizData || !window.quizData.questions) {
            console.error('‚ùå Quiz data not found');
            alert('Error: Quiz data not available. Please generate a quiz first.');
            return;
        }
        
        const question = window.quizData.questions[questionIndex];
        if (!question) {
            console.error('‚ùå Question not found at index:', questionIndex);
            alert('Error: Question not found.');
            return;
        }
        
        console.log('‚úÖ Question data:', question);
        
        // Remove any existing modal
        const existingModal = document.getElementById('edit-question-modal');
        if (existingModal) {
            console.log('üóëÔ∏è Removing existing modal');
            existingModal.remove();
        }
        
        // Ensure styles are added
        addModalStyles();
        
        // Create modal HTML
        const modalHTML = `
            <div id="edit-question-modal" class="edit-modal-overlay" style="display: flex !important;">
                <div class="edit-modal-container">
                    <div class="edit-modal-header">
                        <h3>‚úèÔ∏è Edit Question ${questionIndex + 1}</h3>
                        <button class="close-modal-btn" onclick="window.closeEditQuestionModal()">√ó</button>
                    </div>
                    
                    <div class="edit-modal-content">
                        <!-- Question Text -->
                        <div class="edit-section">
                            <label class="edit-label">
                                ‚ùì Question Text
                            </label>
                            <textarea id="edit-question-text" class="edit-textarea" rows="4" placeholder="Enter the question text...">${escapeHtml(question.text)}</textarea>
                        </div>
                        
                        <!-- Answer Options -->
                        <div class="edit-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label class="edit-label" style="margin-bottom: 0;">
                                    üìù Answer Options
                                </label>
                                <span class="option-counter">${question.options.length} options</span>
                            </div>
                            <div id="edit-options-container">
                                ${question.options.map((option, idx) => `
                                    <div class="edit-option-row" data-option-index="${idx}">
                                        <input type="text" 
                                               class="edit-option-input" 
                                               data-option-index="${idx}" 
                                               value="${escapeHtml(option.text)}" 
                                               placeholder="Enter option ${idx + 1} text...">
                                        <label class="edit-checkbox-label">
                                            <input type="checkbox" 
                                                   class="edit-correct-checkbox" 
                                                   data-option-index="${idx}" 
                                                   ${option.isCorrect ? 'checked' : ''}>
                                            <span class="checkbox-text">‚úì Correct</span>
                                        </label>
                                        ${question.options.length > 2 ? `
                                            <button class="remove-option-btn" 
                                                    onclick="window.removeOption(${idx})"
                                                    title="Remove this option">
                                                üóëÔ∏è
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option-btn" onclick="window.addNewOption()">
                                ‚ûï Add New Option
                            </button>
                        </div>
                        
                        <!-- Shape Parameters (if applicable) -->
                        ${question.shape_data ? `
                            <div class="edit-section">
                                <label class="edit-label">
                                    üìê Shape Parameters
                                </label>
                                <div id="edit-shape-params-container">
                                    ${renderShapeParams(question.shape_data)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="edit-modal-footer">
                        <button class="modal-btn cancel-btn" onclick="window.closeEditQuestionModal()">
                            ‚ùå Cancel
                        </button>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-btn regenerate-options-btn" onclick="window.regenerateOptions(${questionIndex})">
                                üîÑ Regenerate Options
                            </button>
                            <button class="modal-btn save-btn" onclick="window.saveQuestionEdits(${questionIndex})">
                                üíæ Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Insert modal into body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Verify modal was added
        const addedModal = document.getElementById('edit-question-modal');
        if (addedModal) {
            console.log('‚úÖ Modal added to DOM');
            
            // Force focus on first input
            setTimeout(() => {
                const firstInput = document.getElementById('edit-question-text');
                if (firstInput) firstInput.focus();
            }, 100);
            
            // Update option counter when options change
            updateOptionCounter();
        } else {
            console.error('‚ùå Modal was NOT added to DOM!');
        }
    };
    
    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }
    
    function renderShapeParams(shapeData) {
        const shapeType = (shapeData.shape_type || '').toLowerCase();
        
        if (shapeType.includes('triangle')) {
            return `
                <div class="shape-param-row">
                    <label>Side 1 (cm):</label>
                    <input type="number" id="edit-side1" value="${shapeData.side1 || shapeData.a || ''}" step="0.1" min="0" placeholder="Enter side 1 length">
                </div>
                <div class="shape-param-row">
                    <label>Side 2 (cm):</label>
                    <input type="number" id="edit-side2" value="${shapeData.side2 || shapeData.b || ''}" step="0.1" min="0" placeholder="Enter side 2 length">
                </div>
                <div class="shape-param-row">
                    <label>Hypotenuse (cm):</label>
                    <input type="number" id="edit-hypotenuse" value="${shapeData.hypotenuse || shapeData.c || ''}" step="0.1" min="0" placeholder="Enter hypotenuse length">
                </div>
            `;
        }
        
        return '<p style="color: #666; font-style: italic; padding: 15px; text-align: center;">No editable parameters for this shape type.</p>';
    }
    
    function updateOptionCounter() {
        const counter = document.querySelector('.option-counter');
        if (counter) {
            const optionCount = document.querySelectorAll('.edit-option-row').length;
            counter.textContent = `${optionCount} option${optionCount !== 1 ? 's' : ''}`;
        }
    }
    
    // Close modal function
    window.closeEditQuestionModal = function() {
        const modal = document.getElementById('edit-question-modal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => modal.remove(), 300);
            console.log('‚úÖ Modal closed');
        }
    };
    
    // Add new option
    window.addNewOption = function() {
        const container = document.getElementById('edit-options-container');
        if (!container) return;
        
        const currentOptions = container.querySelectorAll('.edit-option-row');
        const newIndex = currentOptions.length;
        
        const newOptionHTML = `
            <div class="edit-option-row" data-option-index="${newIndex}" style="animation: slideUp 0.3s ease;">
                <input type="text" 
                       class="edit-option-input" 
                       data-option-index="${newIndex}" 
                       value="" 
                       placeholder="Enter option ${newIndex + 1} text...">
                <label class="edit-checkbox-label">
                    <input type="checkbox" 
                           class="edit-correct-checkbox" 
                           data-option-index="${newIndex}">
                    <span class="checkbox-text">‚úì Correct</span>
                </label>
                <button class="remove-option-btn" 
                        onclick="window.removeOption(${newIndex})"
                        title="Remove this option">
                    üóëÔ∏è
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newOptionHTML);
        
        // Focus on new input
        setTimeout(() => {
            const newInput = container.querySelector(`.edit-option-input[data-option-index="${newIndex}"]`);
            if (newInput) newInput.focus();
        }, 100);
        
        updateOptionCounter();
        console.log('‚úÖ Added new option');
    };
    
    // Remove option
    window.removeOption = function(optionIndex) {
        const container = document.getElementById('edit-options-container');
        const rows = container.querySelectorAll('.edit-option-row');
        
        if (rows.length <= 2) {
            alert('‚ö†Ô∏è A question must have at least 2 options.');
            return;
        }
        
        const rowToRemove = container.querySelector(`.edit-option-row[data-option-index="${optionIndex}"]`);
        if (rowToRemove) {
            // Animate removal
            rowToRemove.style.animation = 'fadeOut 0.3s ease';
            
            setTimeout(() => {
                rowToRemove.remove();
                
                // Re-index remaining options
                const remainingRows = container.querySelectorAll('.edit-option-row');
                remainingRows.forEach((row, idx) => {
                    row.setAttribute('data-option-index', idx);
                    row.querySelector('.edit-option-input').setAttribute('data-option-index', idx);
                    row.querySelector('.edit-option-input').placeholder = `Enter option ${idx + 1} text...`;
                    row.querySelector('.edit-correct-checkbox').setAttribute('data-option-index', idx);
                    const removeBtn = row.querySelector('.remove-option-btn');
                    if (removeBtn) removeBtn.setAttribute('onclick', `window.removeOption(${idx})`);
                });
                
                updateOptionCounter();
                console.log('‚úÖ Removed option', optionIndex);
            }, 300);
        }
    };
    
    // Regenerate options using AI
    window.regenerateOptions = async function(questionIndex) {
        console.log('üîÑ Regenerating options for question:', questionIndex);
        
        const question = window.quizData.questions[questionIndex];
        const questionText = document.getElementById('edit-question-text').value.trim();
        
        if (!questionText) {
            alert('‚ö†Ô∏è Please enter a question text first.');
            return;
        }
        
        const container = document.getElementById('edit-options-container');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = `
            <div class="option-loading">
                <div class="spinner"></div>
                <p>Regenerating answer options...</p>
            </div>
        `;
        
        try {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            
            const response = await fetch('/api/regenerate-geometry-options', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    question_text: questionText,
                    question_id: question.id,
                    quiz_id: window.quizData.quiz_id,
                    grade_level: window.quizData.grade_level || 'high'
                })
            });
            
            if (!response.ok) throw new Error('Failed to regenerate options');
            
            const data = await response.json();
            
            if (data.options && data.options.length > 0) {
                // Update container with new options
                container.innerHTML = data.options.map((option, idx) => `
                    <div class="edit-option-row" data-option-index="${idx}" style="animation: slideUp 0.3s ease;">
                        <input type="text" 
                               class="edit-option-input" 
                               data-option-index="${idx}" 
                               value="${escapeHtml(option.text)}" 
                               placeholder="Enter option ${idx + 1} text...">
                        <label class="edit-checkbox-label">
                            <input type="checkbox" 
                                   class="edit-correct-checkbox" 
                                   data-option-index="${idx}" 
                                   ${option.isCorrect ? 'checked' : ''}>
                            <span class="checkbox-text">‚úì Correct</span>
                        </label>
                        ${data.options.length > 2 ? `
                            <button class="remove-option-btn" 
                                    onclick="window.removeOption(${idx})"
                                    title="Remove this option">
                                üóëÔ∏è
                            </button>
                        ` : ''}
                    </div>
                `).join('');
                
                updateOptionCounter();
                
                // Show success toast
                const toast = document.createElement('div');
                toast.className = 'success-toast';
                toast.innerHTML = '‚úÖ Options regenerated successfully!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
                
                console.log('‚úÖ Options regenerated');
            } else {
                throw new Error('No options returned');
            }
            
        } catch (error) {
            console.error('‚ùå Error regenerating options:', error);
            
            // Restore original options
            container.innerHTML = question.options.map((option, idx) => `
                <div class="edit-option-row" data-option-index="${idx}">
                    <input type="text" 
                           class="edit-option-input" 
                           data-option-index="${idx}" 
                           value="${escapeHtml(option.text)}" 
                           placeholder="Enter option ${idx + 1} text...">
                    <label class="edit-checkbox-label">
                        <input type="checkbox" 
                               class="edit-correct-checkbox" 
                               data-option-index="${idx}" 
                               ${option.isCorrect ? 'checked' : ''}>
                        <span class="checkbox-text">‚úì Correct</span>
                    </label>
                    ${question.options.length > 2 ? `
                        <button class="remove-option-btn" 
                                onclick="window.removeOption(${idx})"
                                title="Remove this option">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>
            `).join('');
            
            alert('‚ö†Ô∏è Failed to regenerate options. Please try again or edit them manually.');
        }
    };
    
    // Save edits
    window.saveQuestionEdits = function(questionIndex) {
        console.log('üíæ Saving edits for question:', questionIndex);
        
        const question = window.quizData.questions[questionIndex];
        
        // Get new question text
        const newText = document.getElementById('edit-question-text').value.trim();
        if (!newText) {
            alert('‚ö†Ô∏è Question text cannot be empty.');
            return;
        }
        
        // Get new options
        const optionInputs = document.querySelectorAll('.edit-option-input');
        const correctCheckboxes = document.querySelectorAll('.edit-correct-checkbox');
        
        const newOptions = [];
        let hasCorrect = false;
        
        optionInputs.forEach((input, idx) => {
            const text = input.value.trim();
            if (text) {
                const isCorrect = correctCheckboxes[idx].checked;
                if (isCorrect) hasCorrect = true;
                newOptions.push({ text, isCorrect });
            }
        });
        
        if (newOptions.length < 2) {
            alert('‚ö†Ô∏è A question must have at least 2 options.');
            return;
        }
        
        if (!hasCorrect) {
            alert('‚ö†Ô∏è Please mark at least one option as correct.');
            return;
        }
        
        // Update question
        question.text = newText;
        question.options = newOptions;
        
        // Update shape parameters if applicable
        if (question.shape_data) {
            const shapeType = (question.shape_data.shape_type || '').toLowerCase();
            if (shapeType.includes('triangle')) {
                const side1 = document.getElementById('edit-side1');
                const side2 = document.getElementById('edit-side2');
                const hyp = document.getElementById('edit-hypotenuse');
                
                if (side1 && side1.value) question.shape_data.side1 = parseFloat(side1.value);
                if (side2 && side2.value) question.shape_data.side2 = parseFloat(side2.value);
                if (hyp && hyp.value) question.shape_data.hypotenuse = parseFloat(hyp.value);
            }
        }
        
        // Update UI - refresh the entire quiz preview
        if (window.quizData && typeof showQuizPreview === 'function') {
            showQuizPreview(window.quizData, window.quizData.quiz_id);
        }
        
        // Close modal
        window.closeEditQuestionModal();
        
        // Show success
        const toast = document.createElement('div');
        toast.className = 'success-toast';
        toast.innerHTML = '‚úÖ Question and options updated successfully!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
        
        console.log('‚úÖ Question saved successfully');
    };
    
    // Close on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('edit-question-modal');
            if (modal) window.closeEditQuestionModal();
        }
    });
    
    // Close on overlay click
    document.addEventListener('click', function(e) {
        if (e.target.id === 'edit-question-modal') {
            window.closeEditQuestionModal();
        }
    });
    
    console.log('‚úÖ Enhanced edit modal with full option editing loaded successfully!');
})();
</script>
</body>
</html> 