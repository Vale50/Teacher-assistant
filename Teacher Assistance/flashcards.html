<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Study Session</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>" type="image/svg+xml">
    <style>
        :root {
            --primary-color: #00bfff;
            --secondary-color: #10B981;
            --accent-color: #F59E0B;
            --purple-color: #7c3aed;
            --text-color: #1F2937;
            --bg-color: #f0f2f5;
            --white: #FFFFFF;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            line-height: 1.6;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            width: 100%;
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .academy-name {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: none;
        }

        .flashcard-title {
            font-size: 2rem;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .flashcard-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .student-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            max-width: 900px;
            width: 90%;
            margin: 2rem auto;
            text-align: center;
        }

        .student-form h2 {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
            text-align: left;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(145deg, var(--primary-color), #0099cc);
        }

        .btn-secondary {
            background: linear-gradient(145deg, var(--secondary-color), #059669);
        }

        .btn-accent {
            background: linear-gradient(145deg, var(--accent-color), #d97706);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .flashcard-container {
            max-width: 1600px;
            width: 90%;
            margin: 0 auto;
            display: none;
        }

        .progress-container {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--purple-color));
            width: 0%;
            transition: width 0.5s ease;
        }

        .timer-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .timer.warning {
            color: #f59e0b;
        }

        .timer.danger {
            color: #ef4444;
        }

        /* Flashcard Flip Animation */
        .flashcard-wrapper {
            perspective: 1000px;
            width: 100%;
            height: 400px;
            margin: 0 auto;
            cursor: pointer;
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: auto;
        }

        .card-front {
            background: white;
        }

        .card-back {
            background: linear-gradient(145deg, var(--purple-color), #6d28d9);
            color: white;
            transform: rotateY(180deg);
        }

        .card-type {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .card-back .card-type {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .card-content {
            text-align: center;
            font-size: 1.5rem;
            max-width: 100%;
            word-wrap: break-word;
        }

        .card-label {
            position: absolute;
            bottom: 1rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .card-back .card-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            gap: 1rem;
        }

        .navigation .btn {
            flex: 1;
        }

        .results-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            max-width: 1600px;
            width: 90%;
            margin: 2rem auto;
            text-align: center;
            display: none;
        }

        .results-container h2 {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .results-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--purple-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        .results-message {
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .results-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .flashcard-wrapper {
                height: 300px;
            }

            .card-content {
                font-size: 1.2rem;
            }

            .results-stats {
                flex-direction: column;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .flashcard-wrapper {
                height: 250px;
            }

            .card-content {
                font-size: 1rem;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="academy-name" id="academy-name"></div>
        <h1 class="flashcard-title" id="flashcard-title">Flashcard Study Session</h1>
        <div class="flashcard-subtitle" id="flashcard-subtitle"></div>
    </div>

    <div class="student-form" id="student-form">
        <h2>Enter Your Information</h2>
        <div class="form-group">
            <label for="student-name">Your Name:</label>
            <input type="text" id="student-name" placeholder="Enter your name" required>
        </div>
        <button class="btn btn-primary" id="start-button">Start Studying</button>
    </div>

    <div class="flashcard-container" id="flashcard-container">
        <div class="progress-container">
            <div class="progress-text" id="progress-text">Card 1 of 10</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer" id="timer">00:30</div>
        </div>

        <div class="flashcard-wrapper" id="flashcard-wrapper">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front">
                    <div class="card-type" id="card-type">Definition</div>
                    <div class="card-content" id="card-front-content">Loading...</div>
                    <div class="card-label">Click to flip</div>
                </div>
                <div class="card-face card-back">
                    <div class="card-type">Answer</div>
                    <div class="card-content" id="card-back-content">Loading...</div>
                    <div class="card-label">Click to flip back</div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="btn btn-secondary" id="prev-button">Previous</button>
            <button class="btn btn-accent" id="flip-button">Flip Card</button>
            <button class="btn btn-secondary" id="next-button">Next</button>
        </div>
    </div>

    <div class="results-container" id="results-container">
        <h2>Study Session Complete!</h2>
        <div class="results-stats">
            <div class="stat-item">
                <div class="stat-value" id="cards-studied">0</div>
                <div class="stat-label">Cards Studied</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="time-spent">0:00</div>
                <div class="stat-label">Time Spent</div>
            </div>
        </div>
        <div class="results-message" id="results-message">
            Great job! You've completed your flashcard study session.
        </div>
        <div class="results-actions">
            <button class="btn btn-primary" id="restart-button">Study Again</button>
            <button class="btn btn-secondary" id="quiz-button" style="display: none;">Take Quiz</button>
        </div>
    </div>

    <script>
        // State variables
        let flashcards = [];
        let currentCardIndex = 0;
        let sessionStartTime = null;
        let cardTimer = null;
        let cardTimeRemaining = 30;
        let defaultCardTime = 30;
        let studentName = '';
        let isFlipped = false;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const flashcardSetId = urlParams.get('id');
        const academyName = urlParams.get('academy');

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const elements = {
                studentForm: document.getElementById('student-form'),
                flashcardContainer: document.getElementById('flashcard-container'),
                resultsContainer: document.getElementById('results-container'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                timer: document.getElementById('timer'),
                flashcard: document.getElementById('flashcard'),
                flashcardWrapper: document.getElementById('flashcard-wrapper'),
                cardType: document.getElementById('card-type'),
                cardFrontContent: document.getElementById('card-front-content'),
                cardBackContent: document.getElementById('card-back-content'),
                prevButton: document.getElementById('prev-button'),
                nextButton: document.getElementById('next-button'),
                flipButton: document.getElementById('flip-button'),
                startButton: document.getElementById('start-button'),
                restartButton: document.getElementById('restart-button'),
                quizButton: document.getElementById('quiz-button'),
                cardsStudied: document.getElementById('cards-studied'),
                timeSpent: document.getElementById('time-spent'),
                resultsMessage: document.getElementById('results-message'),
                academyNameEl: document.getElementById('academy-name'),
                flashcardTitle: document.getElementById('flashcard-title'),
                flashcardSubtitle: document.getElementById('flashcard-subtitle'),
                studentNameInput: document.getElementById('student-name')
            };

            // Set academy name if provided
            if (academyName) {
                elements.academyNameEl.textContent = decodeURIComponent(academyName) + ' Academy';
                elements.academyNameEl.style.display = 'block';
            }

            // Load flashcard set
            if (flashcardSetId) {
                loadFlashcardSet(flashcardSetId);
                checkQuizAvailability(flashcardSetId);
            } else {
                elements.flashcardTitle.textContent = 'No Flashcard Set';
                elements.flashcardSubtitle.textContent = 'Please provide a valid flashcard set ID';
            }

            // Event listeners
            elements.startButton.addEventListener('click', startSession);
            elements.prevButton.addEventListener('click', showPreviousCard);
            elements.nextButton.addEventListener('click', showNextCard);
            elements.flipButton.addEventListener('click', flipCard);
            elements.flashcardWrapper.addEventListener('click', flipCard);
            elements.restartButton.addEventListener('click', restartSession);
            elements.quizButton.addEventListener('click', goToQuiz);

            // Allow Enter key to start session
            elements.studentNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startSession();
                }
            });

            // Functions
            function loadFlashcardSet(setId) {
                elements.flashcardTitle.textContent = 'Loading Flashcards...';

                // Check localStorage first
                const cached = localStorage.getItem(`flashcards_${setId}`);
                if (cached) {
                    try {
                        const data = JSON.parse(cached);
                        processFlashcardData(data);
                        return;
                    } catch (e) {
                        console.error('Error parsing cached flashcards:', e);
                    }
                }

                // Fetch from server
                fetch(`/api/flashcard-set/${setId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load flashcards');
                        return response.json();
                    })
                    .then(data => {
                        localStorage.setItem(`flashcards_${setId}`, JSON.stringify(data));
                        processFlashcardData(data);
                    })
                    .catch(error => {
                        console.error('Error loading flashcards:', error);
                        createSampleFlashcards();
                    });
            }

            function checkQuizAvailability(setId) {
                fetch(`/api/flashcard-set/${setId}/quiz`)
                    .then(response => {
                        if (response.ok) {
                            elements.quizButton.style.display = '';
                        }
                    })
                    .catch(error => {
                        console.log('No quiz available for this flashcard set');
                    });
            }

            function processFlashcardData(data) {
                const cardArray = data.flashcards || data.cards || [];

                if (!cardArray.length) {
                    createSampleFlashcards();
                    return;
                }

                if (data.flashcard_set && data.flashcard_set.time_per_card) {
                    defaultCardTime = parseInt(data.flashcard_set.time_per_card);
                    cardTimeRemaining = defaultCardTime;
                }

                flashcards = cardArray.map((card, index) => ({
                    id: card.id || `card-${index}`,
                    front: card.front || card.question || 'Front content',
                    back: card.back || card.answer || 'Back content',
                    type: card.type || 'definition'
                }));

                const title = data.flashcard_set?.title || data.title || 'Flashcard Study Session';
                const topic = data.flashcard_set?.topic || data.topic || 'Study Session';

                elements.flashcardTitle.textContent = title;
                elements.flashcardSubtitle.textContent = `${topic} - ${flashcards.length} cards`;
            }

            function createSampleFlashcards() {
                flashcards = [
                    { id: '1', front: 'What is a flashcard?', back: 'A card with information on both sides used for learning', type: 'definition' },
                    { id: '2', front: 'How do flashcards help learning?', back: 'They use active recall and spaced repetition to improve memory', type: 'concept' },
                    { id: '3', front: 'What is active recall?', back: 'Testing yourself on material rather than passively reviewing it', type: 'definition' }
                ];
                elements.flashcardTitle.textContent = 'Sample Flashcards';
                elements.flashcardSubtitle.textContent = `Study Session - ${flashcards.length} cards`;
            }

            function startSession() {
                studentName = elements.studentNameInput.value.trim();
                if (!studentName) {
                    alert('Please enter your name to continue');
                    return;
                }

                elements.studentForm.style.display = 'none';
                elements.flashcardContainer.style.display = 'block';

                currentCardIndex = 0;
                sessionStartTime = new Date();

                updateProgress();
                showCard(currentCardIndex);
            }

            function showCard(index) {
                if (index < 0 || index >= flashcards.length) return;

                const card = flashcards[index];

                // Reset flip state
                isFlipped = false;
                elements.flashcard.classList.remove('flipped');

                // Update content
                elements.cardType.textContent = card.type || 'Definition';
                elements.cardFrontContent.textContent = card.front;
                elements.cardBackContent.textContent = card.back;

                // Update navigation
                elements.prevButton.disabled = index === 0;
                elements.nextButton.textContent = index === flashcards.length - 1 ? 'Finish' : 'Next';

                // Reset and start timer
                cardTimeRemaining = defaultCardTime;
                updateTimer();
                startCardTimer();
            }

            function flipCard() {
                isFlipped = !isFlipped;
                if (isFlipped) {
                    elements.flashcard.classList.add('flipped');
                } else {
                    elements.flashcard.classList.remove('flipped');
                }
            }

            function showPreviousCard() {
                if (currentCardIndex > 0) {
                    stopCardTimer();
                    currentCardIndex--;
                    updateProgress();
                    showCard(currentCardIndex);
                }
            }

            function showNextCard() {
                stopCardTimer();
                if (currentCardIndex < flashcards.length - 1) {
                    currentCardIndex++;
                    updateProgress();
                    showCard(currentCardIndex);
                } else {
                    endSession();
                }
            }

            function updateProgress() {
                elements.progressText.textContent = `Card ${currentCardIndex + 1} of ${flashcards.length}`;
                const percent = ((currentCardIndex + 1) / flashcards.length) * 100;
                elements.progressBar.style.width = `${percent}%`;
            }

            function startCardTimer() {
                stopCardTimer();
                cardTimer = setInterval(function() {
                    cardTimeRemaining--;
                    updateTimer();

                    if (cardTimeRemaining <= 0) {
                        stopCardTimer();
                        if (currentCardIndex < flashcards.length - 1) {
                            showNextCard();
                        } else {
                            endSession();
                        }
                    }
                }, 1000);
            }

            function stopCardTimer() {
                if (cardTimer) {
                    clearInterval(cardTimer);
                    cardTimer = null;
                }
            }

            function updateTimer() {
                const minutes = Math.floor(cardTimeRemaining / 60);
                const seconds = cardTimeRemaining % 60;
                elements.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                elements.timer.classList.remove('warning', 'danger');
                if (cardTimeRemaining <= 5) {
                    elements.timer.classList.add('danger');
                } else if (cardTimeRemaining <= 10) {
                    elements.timer.classList.add('warning');
                }
            }

            function endSession() {
                stopCardTimer();
                elements.flashcardContainer.style.display = 'none';
                elements.resultsContainer.style.display = 'block';

                // Calculate time spent
                const elapsed = Math.floor((new Date() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;

                elements.cardsStudied.textContent = flashcards.length;
                elements.timeSpent.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                elements.resultsMessage.textContent = `Great job, ${studentName}! You've completed all ${flashcards.length} flashcards.`;
            }

            function restartSession() {
                elements.resultsContainer.style.display = 'none';
                elements.studentForm.style.display = 'block';
            }

            function goToQuiz() {
                const quizUrl = `/flashcard-quiz?flashcard_set_id=${flashcardSetId}`;
                window.location.href = quizUrl;
            }
        });
    </script>
</body>
</html>