<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Deciph.AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüè´</text></svg>" type="image/svg+xml">
    <style>
        :root {
            --primary-color: #059669;
            --primary-dark: #047857;
            --secondary-color: #DC2626;
            --accent-color: #D97706;
            --text-color: #1F2937;
            --light-bg: #F9FAFB;
            --white: #FFFFFF;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --red-500: #EF4444;
            --green-500: #10B981;
            --blue-500: #3B82F6;
            --yellow-500: #F59E0B;
            --purple-500: #8B5CF6;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            z-index: 1000;
            transform: translateX(0);
            transition: var(--transition);
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-logo-icon {
            font-size: 2rem;
        }

        .sidebar-logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .grade-section-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            display: block;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: white;
            text-decoration: none;
            color: white;
        }

        .nav-item i {
            margin-right: 0.75rem;
            width: 20px;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        /* ADD THIS CSS */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.show {
            display: block;
            opacity: 1;
        }
        .admin-info {
            flex: 1;
        }

        .admin-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .admin-role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .logout-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

    .sidebar-toggle {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-600);
        padding: 0.5rem;
        border-radius: 8px;
        transition: var(--transition);
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
        }
        .sidebar-toggle:active {
            transform: scale(0.95);
            background: var(--gray-200);
        }

        .sidebar-toggle:hover {
            background: var(--gray-100);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .acard-limit-badge {
            background: var(--yellow-500);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.students::before { background: var(--blue-500); }
        .stat-card.resources::before { background: var(--purple-500); }
        .stat-card.tasks::before { background: var(--green-500); }
        .stat-card.acard::before { background: var(--yellow-500); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .stat-card.students .stat-icon { color: var(--blue-500); }
        .stat-card.resources .stat-icon { color: var(--purple-500); }
        .stat-card.tasks .stat-icon { color: var(--green-500); }
        .stat-card.acard .stat-icon { color: var(--yellow-500); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-increase {
            color: var(--green-500);
        }

        /* Grade Section Header */
        .grade-section-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .grade-section-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .grade-section-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Resources Section */
        .resources-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .resource-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .resource-card:hover {
            border-color: var(--primary-color);
            background: white;
            transform: translateY(-2px);
        }

        .resource-card.selected {
            border-color: var(--primary-color);
            background: rgba(5, 150, 105, 0.05);
        }

        .resource-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .resource-type-badge.internal_file {
            background: rgba(139, 92, 246, 0.1);
            color: var(--purple-500);
        }

        .resource-type-badge.external_link {
            background: rgba(59, 130, 246, 0.1);
            color: var(--blue-500);
        }

        .resource-type-badge.common_link {
            background: rgba(245, 158, 11, 0.1);
            color: var(--yellow-500);
        }

        .resource-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .resource-description {
            color: var(--gray-600);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .resource-category {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Students Table */
        .students-table-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green-500);
        }

        /* Task Assignment Form */
        .task-assignment-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        /* Selected Resources Panel */
        .selected-resources-panel {
            background: rgba(5, 150, 105, 0.05);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .selected-resources-panel.show {
            display: block;
        }

        .selected-resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .selected-resource-item:last-child {
            margin-bottom: 0;
        }

        .remove-resource-btn {
            background: var(--red-500);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 2rem;
        }

        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--green-500);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            z-index: 9999;
            transform: translateX(400px);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--red-500);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .resources-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 1rem;
            }
    
    .sidebar.show {
        transform: translateX(0);
    }

    .main-content {
        margin-left: 0;
    }
        }

        /* Task action buttons */
.task-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.task-action-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 500;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
}

.task-action-btn.view {
    background: var(--gray-500);
    color: white;
}

.task-action-btn.edit {
    background: var(--blue-500);
    color: white;
}

.task-action-btn.delete {
    background: var(--red-500);
    color: white;
}

.task-action-btn.complete {
    background: var(--green-500);
    color: white;
}

.task-action-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* Edit task modal specific styles */
.edit-link-section {
    background: var(--gray-50);
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.5rem;
}

.edit-link-info {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.5rem;
}

/* Bulk Assignment Styles */
.assignment-mode-toggle {
    text-align: center;
    margin-bottom: 2rem;
}

.task-builder {
    background: var(--gray-50);
    border: 2px dashed var(--gray-300);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.task-builder.has-tasks {
    border-color: var(--primary-color);
    background: rgba(5, 150, 105, 0.02);
}

.bulk-task-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    position: relative;
}

.bulk-task-card:hover {
    border-color: var(--primary-color);
}

.bulk-task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.bulk-task-number {
    background: var(--primary-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.bulk-remove-btn {
    background: var(--red-500);
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.75rem;
}

.bulk-student-card {
    background: var(--gray-50);
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: var(--transition);
}

.bulk-student-card:hover {
    border-color: var(--primary-color);
}

.bulk-student-card.selected {
    border-color: var(--primary-color);
    background: rgba(5, 150, 105, 0.05);
}

.assignment-summary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin: 2rem 0;
}
/* Add these styles to your admin dashboard CSS */

/* Messages Badge */
.message-count-badge {
    background: var(--red-500);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-left: 0.5rem;
}

.nav-item {
    position: relative;
}

/* Messages Page */
.messages-header {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-left h2 {
    margin: 0 0 0.5rem 0;
    color: var(--text-color);
}

.header-left p {
    margin: 0;
    color: var(--gray-600);
}

/* Message Tabs */
.message-tabs {
    background: white;
    border-radius: 16px;
    padding: 1rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    gap: 1rem;
}

.tab-btn {
    background: var(--gray-100);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn.active {
    background: var(--primary-color);
    color: white;
}

.tab-btn:hover:not(.active) {
    background: var(--gray-200);
}

.tab-count {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: bold;
}

.tab-btn:not(.active) .tab-count {
    background: var(--primary-color);
    color: white;
}

/* Message Filters */
.message-filters {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
}

/* Messages Container */
.messages-container {
    background: white;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    overflow: hidden;
}

.messages-list {
    max-height: 600px;
    overflow-y: auto;
}

.message-item {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.message-item:hover {
    background: var(--gray-50);
}

.message-item.unread {
    background: rgba(59, 130, 246, 0.05);
    border-left: 4px solid var(--blue-500);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.message-sender {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.message-subject {
    font-size: 1rem;
    color: var(--text-color);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.message-preview {
    color: var(--gray-600);
    font-size: 0.9rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.message-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.8rem;
    color: var(--gray-500);
}

.message-type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.message-type-general {
    background: rgba(107, 114, 128, 0.1);
    color: var(--gray-600);
}

.message-type-announcement {
    background: rgba(59, 130, 246, 0.1);
    color: var(--blue-500);
}

.message-type-urgent {
    background: rgba(239, 68, 68, 0.1);
    color: var(--red-500);
}

.message-type-reminder {
    background: rgba(245, 158, 11, 0.1);
    color: var(--yellow-500);
}

.priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 600;
}

.priority-high {
    background: rgba(245, 158, 11, 0.1);
    color: var(--yellow-500);
}

.priority-urgent {
    background: rgba(239, 68, 68, 0.1);
    color: var(--red-500);
}

.messages-empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-500);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Compose Modal Styles */
.message-modal {
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--gray-200);
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 1rem;
}

.recipient-tabs {
    display: flex;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--gray-200);
}

.recipient-tabs .tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--gray-600);
    cursor: pointer;
    transition: var(--transition);
    border-bottom: 2px solid transparent;
}

.recipient-tabs .tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: none;
}

.recipient-section {
    margin-top: 1rem;
}

.recipient-filters {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.recipient-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.recipients-grid {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 1rem;
}

.recipient-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 0.5rem;
}

.recipient-item:hover {
    background: var(--gray-50);
}

.recipient-item.selected {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid var(--blue-500);
}

.recipient-checkbox {
    margin-right: 1rem;
}

.recipient-info {
    flex: 1;
}

.recipient-name {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.recipient-details {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.selected-recipients {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.selected-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.selected-item {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.selected-item .remove-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 0;
    margin: 0;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
}

.character-count {
    text-align: right;
    font-size: 0.8rem;
    color: var(--gray-500);
    margin-top: 0.5rem;
}

/* Pagination */
.pagination-container {
    background: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--gray-200);
}

.page-info {
    color: var(--gray-600);
    font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .messages-header {
        flex-direction: column;
        align-items: stretch;
    }

    .message-tabs {
        flex-direction: column;
    }

    .message-filters {
        flex-direction: column;
        align-items: stretch;
    }

    .recipient-filters {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .message-modal {
        width: 95%;
        margin: 1rem;
    }

    .recipient-actions {
        flex-direction: column;
    }
}

/* Loading states */
.loading-messages {
    text-align: center;
    padding: 2rem;
    color: var(--gray-500);
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Link Type Selector Styles */
.link-type-selector {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.link-type-description {
    color: var(--gray-600);
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.link-type-tabs {
    display: flex;
    background: var(--gray-200);
    border-radius: 8px;
    padding: 0.25rem;
    margin-bottom: 1rem;
}

.link-type-tab {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--gray-600);
}

.link-type-tab.active {
    background: white;
    color: var(--primary-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.link-type-tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.7);
}

.link-option {
    display: none;
    margin-top: 1rem;
}

.link-option.active {
    display: block;
}

.task-file-section {
    background: rgba(59, 130, 246, 0.05);
    border-left: 3px solid var(--blue-500);
    padding: 0.75rem;
    margin-top: 0.75rem;
    border-radius: 0 4px 4px 0;
}

.task-file-info {
    font-size: 0.875rem;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.task-file-info code {
    background: rgba(0, 0, 0, 0.05);
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-size: 0.8125rem;
}

.url-validator {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.url-validator.valid {
    background: rgba(16, 185, 129, 0.1);
    color: var(--green-500);
}

.url-validator.invalid {
    background: rgba(239, 68, 68, 0.1);
    color: var(--red-500);
}

.url-validator.empty {
    background: rgba(59, 130, 246, 0.1);
    color: var(--blue-500);
}

.external-link-preview {
    display: none;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.external-link-preview.show {
    display: block;
}

.preview-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--primary-color);
}

.preview-url {
    font-family: monospace;
    color: var(--gray-600);
    word-break: break-all;
}

.common-links-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-top: 1rem;
}

.common-link-btn {
    padding: 0.75rem;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    font-size: 0.875rem;
}

.common-link-btn:hover {
    border-color: var(--blue-500);
    background: rgba(59, 130, 246, 0.05);
}

.common-link-btn.selected {
    border-color: var(--blue-500);
    background: rgba(59, 130, 246, 0.1);
    color: var(--blue-500);
}

.common-link-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.common-link-url {
    font-size: 0.75rem;
    color: var(--gray-500);
    font-family: monospace;
    word-break: break-all;
}

.common-link-description {
    font-size: 0.75rem;
    color: var(--gray-600);
    margin-top: 0.25rem;
}

/* Subject Assignment Styles */
.subject-checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.subject-checkbox-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
}

.subject-checkbox-item:hover {
    border-color: var(--primary-color);
    background: var(--gray-50);
}

.subject-checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 1rem;
    cursor: pointer;
}

.subject-checkbox-item.checked {
    border-color: var(--primary-color);
    background: rgba(5, 150, 105, 0.05);
}

.subject-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: var(--primary-color);
    color: white;
    border-radius: 20px;
    margin: 0.25rem;
    font-size: 0.875rem;
}

.subject-chip .remove-btn {
    margin-left: 0.5rem;
    cursor: pointer;
    font-weight: bold;
}

.subject-chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.student-checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
}

.student-checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    cursor: pointer;
    transition: var(--transition);
}

.student-checkbox-item:hover {
    border-color: var(--primary-color);
}

.student-checkbox-item input[type="checkbox"] {
    margin-right: 0.5rem;
}

.student-checkbox-item.checked {
    border-color: var(--primary-color);
    background: rgba(5, 150, 105, 0.05);
}
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
 <div class="mobile-overlay" id="mobileOverlay"></div>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span class="sidebar-logo-icon">üë®‚Äçüè´</span>
                <span class="sidebar-logo-text">Admin Portal</span>
            </div>
            <div class="sidebar-subtitle">Grade Section Admin</div>
            <div class="grade-section-badge" id="gradeSectionBadge">Loading...</div>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-page="dashboard">
                <i>üìä</i> Dashboard
            </a>
            <a href="#" class="nav-item" data-page="students">
                <i>üë•</i> My Students
            </a>
            <a href="#" class="nav-item" data-page="resources">
                <i>üìö</i> Assigned Resources
            </a>
            <a href="#" class="nav-item" data-page="assign-task">
                <i>üìù</i> Assign Tasks
            </a>
            <a href="#" class="nav-item" data-page="subject-assignment">
                <i>üìö</i> Subject Assignment
            </a>
            <!-- ADD THIS NEW LINE FOR SOCIAL MEDIA -->
            <a href="#" class="nav-item" data-page="social-media-assign">
                <i>üì±</i> Skills acquisition
            </a>
            <a href="#" class="nav-item" data-page="my-tasks">
                <i>üìã</i> Task Management
            </a>
            <a href="#" class="nav-item" data-page="coaches">
                <i>üë®‚Äçüè´</i> Coach Management
            </a>
            <a href="/support-dashboard" class="nav-item" target="_blank" rel="noopener noreferrer">
                <i>üí¨</i> Support
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-profile">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div class="admin-info">
                    <div class="admin-name" id="adminName">Admin User</div>
                    <div class="admin-role" id="adminRole">Grade Section Admin</div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i>üö™</i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="acard-limit-badge" id="acardLimitBadge">
                    A-Card Limit: ‚Ç≥0.00
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Dashboard Page -->
            <div class="page-content active" id="dashboard-page">
                <!-- Grade Section Header -->
                <div class="grade-section-header">
                    <h2 class="grade-section-title" id="gradeSectionTitle">Grade 1-3 Section</h2>
                    <p class="grade-section-subtitle">Manage your assigned students and resources</p>
                </div>

                <!-- Dashboard Stats -->
                <div class="stats-grid">
                    <div class="stat-card students">
                        <div class="stat-header">
                            <div class="stat-icon">üë•</div>
                        </div>
                        <div class="stat-value" id="totalAssignedStudents">0</div>
                        <div class="stat-label">Assigned Students</div>
                        <div class="stat-change stat-increase">
                            <span>üìö</span>
                            <span id="activeStudentsInfo">0 with pending tasks</span>
                        </div>
                    </div>

                    <div class="stat-card resources">
                        <div class="stat-header">
                            <div class="stat-icon">üìö</div>
                        </div>
                        <div class="stat-value" id="totalResources">0</div>
                        <div class="stat-label">Available Resources</div>
                        <div class="stat-change stat-increase">
                            <span>üîó</span>
                            <span id="resourceTypesInfo">0 types available</span>
                        </div>
                    </div>

                    <div class="stat-card tasks">
                        <div class="stat-header">
                            <div class="stat-icon">üìù</div>
                        </div>
                        <div class="stat-value" id="totalTasksAssigned">0</div>
                        <div class="stat-label">Tasks Assigned</div>
                        <div class="stat-change stat-increase">
                            <span>‚úÖ</span>
                            <span id="completedTasksInfo">0 completed</span>
                        </div>
                    </div>

                    <div class="stat-card acard">
                        <div class="stat-header">
                            <div class="stat-icon">üí≥</div>
                        </div>
                        <div class="stat-value" id="totalAcardUsed">‚Ç≥0</div>
                        <div class="stat-label">A-Card Distributed</div>
                        <div class="stat-change stat-increase">
                            <span>üí∞</span>
                            <span id="acardRemainingInfo">0% of limit used</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Page -->
            <div class="page-content" id="students-page">
                <div class="students-table-section">
                    <div class="table-header">
                        <h2 class="table-title">My Assigned Students</h2>
                        <div class="table-controls">
                            <input type="text" class="form-input" id="studentsSearch" placeholder="Search students..." style="width: 200px;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Grade</th>
                                    <th>School</th>
                                    <th>Points</th>
                                    <th>A-Card Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resources Page -->
            <div class="page-content" id="resources-page">
                <div class="resources-section">
                    <div class="section-header">
                        <h2 class="section-title">Assigned Resources</h2>
                        <p style="color: var(--gray-600);">Resources assigned to your grade section by Super Admin</p>
                    </div>
                    
                    <div class="resources-grid" id="resourcesGrid">
                        <!-- Resources will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Assign Task Page -->
<div class="page-content" id="assign-task-page">
    <div class="task-assignment-section">
        <div class="section-header">
            <h2 class="section-title">Task Assignment</h2>
            <p style="color: var(--gray-600);">Assign tasks to your students using available resources</p>
        </div>

        <!-- Assignment Mode Toggle -->
        <div class="assignment-mode-toggle" style="margin-bottom: 2rem; text-align: center;">
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" id="singleModeBtn" onclick="switchMode('single')">
                    Single Task
                </button>
                <button class="btn btn-secondary" id="bulkModeBtn" onclick="switchMode('bulk')">
                    Bulk Tasks
                </button>
            </div>
        </div>

        <!-- Single Task Mode (existing functionality) -->
        <div id="singleTaskMode">
            <!-- Selected Resources Panel -->
            <div class="selected-resources-panel" id="selectedResourcesPanel">
                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Selected Resource:</h4>
                <div id="selectedResourcesList"></div>
            </div>

            <form id="assignTaskForm">
                <div class="form-grid">
                    <!-- Resource Selection -->
                    <div class="form-group">
                        <label class="form-label">Select Resource (Optional)</label>
                        <select class="form-input" id="resourceSelect">
                            <option value="">Choose a resource to assign...</option>
                            <!-- Resources will be loaded here -->
                        </select>
                        <small style="color: var(--gray-600); margin-top: 0.25rem; display: block;">
                            You can select a resource or configure a custom task link below
                        </small>
                    </div>

                    <!-- Task Title -->
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" id="taskTitle" required placeholder="Enter task title">
                    </div>

                    <!-- Points and A-Card -->
                    <div class="form-group">
                        <label class="form-label">Points Reward</label>
                        <input type="number" class="form-input" id="pointsReward" min="0" placeholder="0" value="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">A-Card Credit (‚Ç≥)</label>
                        <input type="number" class="form-input" id="acardCredit" min="0" step="0.01" placeholder="0.00" value="1.00">
                        <small style="color: var(--gray-600); margin-top: 0.25rem; display: block;">
                            Maximum per task: ‚Ç≥<span id="maxAcardDisplay">0.00</span>
                        </small>
                    </div>

                    <!-- Due Date -->
                    <div class="form-group">
                        <label class="form-label">Due Date (Optional)</label>
                        <input type="datetime-local" class="form-input" id="dueDate">
                    </div>

                    <!-- Select Students -->
                    <div class="form-group">
                        <label class="form-label">Select Students</label>
                        <select class="form-input" id="studentSelect" multiple size="6" required>
                            <!-- Students will be loaded here -->
                        </select>
                        <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                            Hold Ctrl/Cmd to select multiple students
                        </small>
                    </div>
                </div>

                <!-- Task Description -->
                <div class="form-group">
                    <label class="form-label">Task Description</label>
                    <textarea class="form-input form-textarea" id="taskDescription" placeholder="Enter detailed task description..."></textarea>
                </div>

                <!-- Task Link Configuration -->
                <div class="form-group">
                    <label class="form-label">Task Link Configuration</label>
                    <div class="link-type-selector">
                        <div class="link-type-description">
                            Choose how students will access this task. You can use internal Deciph.AI files, external links, or common educational platforms.
                        </div>

                        <div class="link-type-tabs">
                            <button type="button" class="link-type-tab active" data-type="internal" onclick="switchLinkType('internal')">
                                üìÅ Internal File
                            </button>
                            <button type="button" class="link-type-tab" data-type="external" onclick="switchLinkType('external')">
                                üîó External Link
                            </button>
                            <button type="button" class="link-type-tab" data-type="common" onclick="switchLinkType('common')">
                                ‚≠ê Common Links
                            </button>
                        </div>

                        <!-- Internal File Option -->
                        <div class="link-option active" id="internal-option">
                            <input type="text" class="form-input" id="taskFile" placeholder="e.g., fractions, algebra, essay-writing">
                            <div class="task-file-section">
                                <div class="task-file-info">
                                    üí° <strong>Internal File Usage:</strong> Enter a specific topic/file name for Deciph.AI tasks.
                                </div>
                                <div class="task-file-info">
                                    Example: If you enter "fractions", students will be redirected to:
                                    <code>https://deciphersacad.online//fractions</code>
                                </div>
                            </div>
                        </div>

                        <!-- External Link Option -->
                        <div class="link-option" id="external-option">
                            <input type="url" class="form-input" id="externalTaskUrl" placeholder="https://example.com/your-task-link" oninput="validateExternalUrl()">
                            <div class="url-validator empty" id="urlValidator">
                                <span>üí° Enter any valid URL (must start with http:// or https://)</span>
                            </div>
                            <div class="external-link-preview" id="externalLinkPreview">
                                <div class="preview-header">
                                    üîó External Task Preview
                                </div>
                                <div class="preview-url" id="previewUrl"></div>
                            </div>
                        </div>

                        <!-- Common Links Option -->
                        <div class="link-option" id="common-option">
                            <div class="common-links-grid" id="commonLinksGrid">
                                <!-- Common links will be populated here -->
                            </div>
                            <div style="margin-top: 1rem;">
                                <input type="url" class="form-input" id="customCommonUrl" placeholder="Or enter a custom URL...">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        üìù Assign Task
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        üîÑ Reset Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Bulk Task Mode (new functionality) -->
        <div id="bulkTaskMode" style="display: none;">
            <!-- Task Builder -->
            <div class="task-builder" id="bulkTaskBuilder">
                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Tasks to Assign</h4>
                <div id="bulkTasksContainer"></div>
                <button type="button" class="btn btn-secondary" onclick="addBulkTask()" style="margin: 1rem 0;">
                    + Add Another Task
                </button>
            </div>

            <!-- Student Selection -->
            <div class="bulk-student-selection" style="margin: 2rem 0;">
                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Select Students</h4>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="selectAllBulkStudents()">Select All</button>
                    <button type="button" class="btn btn-secondary" onclick="deselectAllBulkStudents()">Deselect All</button>
                    <button type="button" class="btn btn-secondary" onclick="selectByGradeBulk()">Select by Grade</button>
                </div>
                <div id="bulkStudentGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;"></div>
            </div>

            <!-- Assignment Summary -->
            <div id="bulkAssignmentSummary" class="assignment-summary" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; margin-bottom: 1.5rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700;" id="bulkTotalTasks">0</div>
                        <div style="opacity: 0.9; font-size: 0.875rem;">Tasks</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700;" id="bulkTotalStudents">0</div>
                        <div style="opacity: 0.9; font-size: 0.875rem;">Students</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700;" id="bulkTotalAssignments">0</div>
                        <div style="opacity: 0.9; font-size: 0.875rem;">Total Assignments</div>
                    </div>
                </div>
                <button class="btn" onclick="performBulkAssignment()" id="bulkAssignBtn" style="background: white; color: var(--primary-color); margin: 0 auto; display: block;" disabled>
                    Assign All Tasks
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Subject Assignment Page -->
<div class="page-content" id="subject-assignment-page">
    <div class="subject-assignment-section">
        <div class="section-header">
            <h2 class="section-title">Subject Assignment</h2>
            <p style="color: var(--gray-600);">Assign subjects to students for their personalized dashboard</p>
        </div>

        <!-- Assignment Mode Toggle -->
        <div class="assignment-mode-toggle" style="margin-bottom: 2rem; text-align: center;">
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" id="subjectSingleModeBtn" onclick="switchSubjectMode('single')">
                    Single Student
                </button>
                <button class="btn btn-secondary" id="subjectBulkModeBtn" onclick="switchSubjectMode('bulk')">
                    Multiple Students
                </button>
            </div>
        </div>

        <!-- Single Student Mode -->
        <div id="singleStudentSubjectMode">
            <form id="assignSubjectForm">
                <div class="form-grid">
                    <!-- Student Selection -->
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-input" id="subjectStudentSelect" required onchange="loadStudentCurrentSubjects()">
                            <option value="">Choose a student...</option>
                            <!-- Students will be loaded here -->
                        </select>
                    </div>
                </div>

                <!-- Current Subjects Display -->
                <div id="currentSubjectsPanel" style="display: none; margin: 2rem 0; padding: 1.5rem; background: var(--background-color); border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Current Subjects:</h4>
                    <div id="currentSubjectsList" class="subject-chips-container"></div>
                </div>

                <!-- Subject Selection -->
                <div class="form-group">
                    <label class="form-label">Select Subjects to Assign</label>
                    <div id="subjectCheckboxGrid" class="subject-checkbox-grid">
                        <!-- Subject checkboxes will be loaded here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        Assign Selected Subjects
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearSubjectForm()">
                        Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Bulk Assignment Mode -->
        <div id="bulkStudentSubjectMode" style="display: none;">
            <form id="bulkAssignSubjectForm">
                <div class="form-grid">
                    <!-- Multiple Students Selection -->
                    <div class="form-group">
                        <label class="form-label">Select Students</label>
                        <div style="margin-bottom: 1rem;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllSubjectStudents()">
                                Select All
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllSubjectStudents()">
                                Clear All
                            </button>
                        </div>
                        <div id="bulkSubjectStudentCheckboxGrid" class="student-checkbox-grid" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px;">
                            <!-- Student checkboxes will be loaded here -->
                        </div>
                        <div id="selectedSubjectStudentCount" style="margin-top: 0.5rem; color: var(--gray-600); font-size: 0.875rem;"></div>
                    </div>

                    <!-- Subject Selection for Bulk -->
                    <div class="form-group">
                        <label class="form-label">Select Subjects to Assign</label>
                        <div id="bulkSubjectCheckboxGrid" class="subject-checkbox-grid">
                            <!-- Subject checkboxes will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        Bulk Assign Subjects
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearBulkSubjectForm()">
                        Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Assignment Results -->
        <div id="subjectAssignmentResults" style="display: none; margin-top: 2rem;"></div>
    </div>
</div>

<div class="page-content" id="social-media-assign-page">
    <div class="form-section">
        <div class="section-header">
            <h2 class="section-title">Assign Social Media Skill Task</h2>
            <p style="color: var(--gray-600); margin-top: 0.5rem;">
                Assign specialized tasks to social media management students
            </p>
        </div>

        <form id="assignSocialMediaTaskForm">
            <div class="form-grid">
                <!-- Skill Category -->
                <div class="form-group">
                    <label class="form-label">Skill Category</label>
                    <select class="form-input" id="smSkillCategory" required>
                        <option value="">Select Skill Category</option>
                        <option value="social-media">Social Media Management</option>
                        <option value="video-editing">Video Editing</option>
                        <option value="graphics-design">Graphics Design</option>
                        <option value="coding">Coding</option>
                    </select>
                </div>

                <!-- Task Title -->
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="smTaskTitle" required placeholder="Enter task title">
                </div>

                <!-- Week Number -->
                <div class="form-group">
                    <label class="form-label">Week Number (Optional)</label>
                    <select class="form-input" id="smWeekNumber">
                        <option value="">No specific week</option>
                        <option value="1">Week 1</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                    </select>
                </div>

                <!-- Day Number -->
                <div class="form-group">
                    <label class="form-label">Day Number (Optional)</label>
                    <select class="form-input" id="smDayNumber">
                        <option value="">No specific day</option>
                        <option value="1">Day 1</option>
                        <option value="2">Day 2</option>
                        <option value="3">Day 3</option>
                        <option value="4">Day 4</option>
                        <option value="5">Day 5</option>
                    </select>
                </div>

                <!-- Lesson Type -->
                <div class="form-group">
                    <label class="form-label">Lesson Type</label>
                    <select class="form-input" id="smLessonType">
                        <option value="lesson">Lesson</option>
                        <option value="live">Live Session</option>
                                <option value="practical">Practical</option>
                            </select>
                        </div>

                        <!-- Duration -->
                        <div class="form-group">
                            <label class="form-label">Duration</label>
                            <input type="text" class="form-input" id="smDuration" placeholder="e.g., 45 min">
                        </div>

                        <!-- Video URL -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Video/Content URL</label>
                            <input type="url" class="form-input" id="smVideoUrl" placeholder="https://example.com/video-lesson">
                        </div>

                        <!-- Zoom Passcode (for live sessions) -->
                        <div class="form-group">
                            <label class="form-label">Zoom Passcode (if applicable)</label>
                            <input type="text" class="form-input" id="smZoomPasscode" placeholder="Enter passcode">
                        </div>

                        <!-- Access Code -->
                        <div class="form-group">
                            <label class="form-label">Access Code (Optional)</label>
                            <input type="text" class="form-input" id="smAccessCode" placeholder="e.g., SMMC1">
                        </div>

                        <!-- Points Reward -->
                        <div class="form-group">
                            <label class="form-label">Points Reward</label>
                            <input type="number" class="form-input" id="smPointsReward" min="0" placeholder="0">
                        </div>

                        <!-- Due Date -->
                        <div class="form-group">
                            <label class="form-label">Due Date (Optional)</label>
                            <input type="datetime-local" class="form-input" id="smDueDate">
                        </div>
                    </div>

                    <!-- Social Media Students Selection -->
                    <div class="form-group" style="margin-top: 2rem;">
                        <label class="form-label">Select Social Media Students</label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-secondary" id="smSelectAllBtn">
                                ‚úÖ Select All
                            </button>
                            <button type="button" class="btn btn-secondary" id="smDeselectAllBtn">
                                ‚ùå Deselect All
                            </button>
                            <button type="button" class="btn btn-primary" id="smRefreshStudentsBtn">
                                üîÑ Refresh Students
                            </button>
                        </div>
                        <select class="form-input" id="smStudentSelect" multiple size="8" style="font-family: inherit;">
                            <!-- Social media students will be loaded here -->
                        </select>
                        <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">
                            Hold Ctrl/Cmd to select multiple students. Showing only Social Media Management students.
                        </small>
                        <div id="smSelectedCount" style="margin-top: 0.5rem; color: var(--primary-color); font-weight: 600;">
                            0 students selected
                        </div>
                    </div>

                    <!-- Task Description -->
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <textarea class="form-input form-textarea" id="smTaskDescription" placeholder="Enter detailed task description..." rows="4"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary">
                            üìù Assign Skill Task
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            üîÑ Reset Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Recent Social Media Assignments -->
            <div class="data-table">
                <div class="table-header">
                    <h2 class="table-title">Recent Social Media Assignments</h2>
                    <div class="table-controls">
                        <select class="filter-select" id="smStatusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-primary" id="smRefreshAssignments">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="smAssignmentsTable">
                  <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllTasks" onclick="toggleSelectAllTasks()">
                                </th>
                                <th>Task</th>
                                <th>Student</th>
                                <th>Category</th>
                                <th>Week/Day</th>
                                <th>Status</th>
                                <th>Points</th>
                                <th>Assigned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="smAssignmentsTableBody">
                            <!-- Assignments will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Social Media Student Management -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">Social Media Student Management</h2>
                    <button class="btn btn-success" id="createSMStudentBtn">
                        üë§ Create New Student
                    </button>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Social Media Students</h3>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="smStudentsSearch" placeholder="Search students...">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="smStudentsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Skill Level</th>
                                    <th>Tasks Completed</th>
                                    <th>Total Points</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="smStudentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

            <!-- My Tasks Page -->
            <div class="page-content" id="my-tasks-page">
                <div class="students-table-section">
                    <div class="table-header">
                        <h2 class="table-title">Tasks I've Assigned</h2>
                        <div class="table-controls">
                            <input type="text" class="form-input" id="tasksSearch" placeholder="Search tasks..." style="width: 200px;">
                            <select class="form-input" id="taskStatusFilter" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="myTasksTable">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Student</th>
                                    <th>Resource Used</th>
                                    <th>Status</th>
                                    <th>Points</th>
                                    <th>A-Card</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myTasksTableBody">
                                <!-- Tasks will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Coaches Management Page -->
            <div class="page-content" id="coaches-page">
                <div class="coaches-section">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Coach Management</h2>
                            <p style="color: var(--gray-600);">Manage coaches, courses, and permissions</p>
                        </div>
                        <button class="btn btn-primary" onclick="openCreateCoachModal()">
                            ‚ûï Create New Coach
                        </button>
                    </div>

                    <!-- Coach Stats -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">üë®‚Äçüè´</div>
                            </div>
                            <div class="stat-value" id="totalCoaches">0</div>
                            <div class="stat-label">Total Coaches</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">üìö</div>
                            </div>
                            <div class="stat-value" id="totalCourses">0</div>
                            <div class="stat-label">Total Courses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">üë•</div>
                            </div>
                            <div class="stat-value" id="totalEnrolledStudents">0</div>
                            <div class="stat-label">Enrolled Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">üíæ</div>
                            </div>
                            <div class="stat-value" id="totalStorage">0 GB</div>
                            <div class="stat-label">Storage Used</div>
                        </div>
                    </div>

                    <!-- Coaches Table -->
                    <div class="students-table-section">
                        <div class="table-header">
                            <h3 class="table-title">All Coaches</h3>
                            <div class="table-controls">
                                <input type="text" class="form-input" id="coachesSearch" placeholder="Search coaches..." style="width: 250px;">
                                <select class="form-input" id="coachStatusFilter" style="width: 150px;">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="coachesTable">
                                <thead>
                                    <tr>
                                        <th>Coach</th>
                                        <th>Email</th>
                                        <th>Specialization</th>
                                        <th>Courses</th>
                                        <th>Students</th>
                                        <th>Storage</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coachesTableBody">
                                    <!-- Coaches will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Create Coach Modal -->
<div class="modal" id="createCoachModal">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 class="modal-title">Create New Coach</h3>
            <button class="modal-close" onclick="closeCreateCoachModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createCoachForm">
                <div class="form-section">
                    <h4 style="margin-bottom: 1rem; color: var(--gray-900);">Basic Information</h4>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-input" id="coachFullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="coachEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-input" id="coachUsername" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-input" id="coachPassword" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="coachPhone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bio</label>
                        <textarea class="form-input" id="coachBio" rows="3" maxlength="500" placeholder="Brief description about the coach..."></textarea>
                    </div>
                </div>

                <div class="form-section" style="margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--gray-900);">Professional Details</h4>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">Specialization *</label>
                            <select class="form-input" id="coachSpecialization" required>
                                <option value="">Select...</option>
                                <option value="social-media">Social Media Management</option>
                                <option value="video-editing">Video Editing</option>
                                <option value="graphics-design">Graphics Design</option>
                                <option value="coding">Coding/Programming</option>
                                <option value="digital-marketing">Digital Marketing</option>
                                <option value="content-creation">Content Creation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Years of Experience</label>
                            <input type="number" class="form-input" id="coachExperience" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Professional Title</label>
                            <input type="text" class="form-input" id="coachTitle" placeholder="e.g., Senior Social Media Strategist">
                        </div>
                        <div class="form-group">
                            <label class="form-label">LinkedIn URL</label>
                            <input type="url" class="form-input" id="coachLinkedIn" placeholder="https://linkedin.com/in/...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Portfolio URL</label>
                            <input type="url" class="form-input" id="coachPortfolio" placeholder="https://...">
                        </div>
                    </div>
                </div>

                <div class="form-section" style="margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--gray-900);">Permissions & Limits</h4>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">Max Courses Allowed</label>
                            <input type="number" class="form-input" id="coachMaxCourses" min="1" value="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Storage Quota (GB)</label>
                            <input type="number" class="form-input" id="coachStorageQuota" min="1" value="50">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="coachCanUploadVideo" checked style="width: auto;">
                            <span>Can Upload Video Content</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="coachCanUploadPDF" checked style="width: auto;">
                            <span>Can Upload PDF Materials</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="coachCanCreateCodes" checked style="width: auto;">
                            <span>Can Create Access Codes</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="coachCanAssignTasks" checked style="width: auto;">
                            <span>Can Assign Tasks</span>
                        </label>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateCoachModal()">
                        ‚ùå Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ‚úÖ Create Coach
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal" id="editTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Task</h3>
            <button class="modal-close" data-modal="editTaskModal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" id="editTaskTitle" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="datetime-local" class="form-input" id="editDueDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Points Reward</label>
                        <input type="number" class="form-input" id="editPointsReward" min="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">A-Card Credit (‚Ç≥)</label>
                        <input type="number" class="form-input" id="editAcardCredit" min="0" step="0.01">
                        <small style="color: var(--gray-600); margin-top: 0.25rem; display: block;">
                            Maximum per task: ‚Ç≥<span id="editMaxAcardDisplay">0.00</span>
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Resource</label>
                    <select class="form-input" id="editResourceSelect">
                        <option value="">Choose a resource...</option>
                        <!-- Resources will be populated here -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Task Description</label>
                    <textarea class="form-input form-textarea" id="editTaskDescription" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" form="editTaskForm" class="btn btn-primary">
                üíæ Save Changes
            </button>
            <button class="btn btn-secondary" data-modal="editTaskModal">
                ‚ùå Cancel
            </button>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal" id="taskDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Task Details</h3>
            <button class="modal-close" data-modal="taskDetailsModal">&times;</button>
        </div>
        <div class="modal-body" id="taskDetailsBody">
            <!-- Task details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-modal="taskDetailsModal">
                Close
            </button>
        </div>
    </div>
</div>
    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        
// Token Management Module with Auto-Refresh
// Add this to your admin dashboard JavaScript

// ==================== TOKEN MANAGEMENT ====================

const TokenManager = {
    // Check if token is expiring soon (within 5 minutes)
    isTokenExpiringSoon: function(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const expTime = payload.exp * 1000; // Convert to milliseconds
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            
            return (expTime - now) < fiveMinutes;
        } catch (e) {
            console.error('Error checking token expiration:', e);
            return true; // Treat as expired if can't decode
        }
    },
    
    // Check if token is expired
    isTokenExpired: function(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const expTime = payload.exp * 1000;
            return Date.now() >= expTime;
        } catch (e) {
            console.error('Error checking token expiration:', e);
            return true;
        }
    },
    
    // Refresh admin token
    refreshAdminToken: async function() {
        try {
            const currentToken = getAdminToken();
            if (!currentToken) {
                throw new Error('No token to refresh');
            }
            
            console.log('üîÑ Refreshing admin token...');
            
            const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/auth/refresh-token', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Store new token
                storeAdminToken(data.token);
                
                // Update admin data if provided
                if (data.admin) {
                    localStorage.setItem('admin_user', JSON.stringify(data.admin));
                }
                
                console.log('‚úÖ Admin token refreshed successfully');
                return data.token;
            } else {
                throw new Error('Token refresh failed');
            }
        } catch (error) {
            console.error('‚ùå Token refresh error:', error);
            // If refresh fails, logout
            this.handleTokenExpiration();
            throw error;
        }
    },
    
    // Handle token expiration (logout)
    handleTokenExpiration: function() {
        console.warn('‚ö†Ô∏è Token expired - logging out');
        
        // Clear all tokens
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        sessionStorage.removeItem('admin_token');
        document.cookie = 'admin_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        
        // Set logout flag
        sessionStorage.setItem('admin_just_logged_out', 'true');
        sessionStorage.setItem('logout_reason', 'Session expired. Please login again.');
        
        // Redirect to login
        window.location.href = '/admin-login';
    },
    
    // Make authenticated request with auto-refresh
    makeAuthenticatedRequest: async function(url, options = {}) {
        let token = getAdminToken();
        
        if (!token) {
            this.handleTokenExpiration();
            throw new Error('No authentication token');
        }
        
        // Check if token is expiring soon
        if (this.isTokenExpiringSoon(token)) {
            console.log('üîÑ Token expiring soon, refreshing...');
            try {
                token = await this.refreshAdminToken();
            } catch (error) {
                console.error('Failed to refresh token:', error);
                this.handleTokenExpiration();
                throw error;
            }
        }
        
        // Make the request
        const headers = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
        };
        
        try {
            const response = await fetch(url, {
                ...options,
                headers
            });
            
            // If we get 401, try to refresh token once
            if (response.status === 401) {
                console.warn('‚ö†Ô∏è Got 401, attempting token refresh...');
                
                try {
                    token = await this.refreshAdminToken();
                    
                    // Retry the request with new token
                    headers.Authorization = `Bearer ${token}`;
                    const retryResponse = await fetch(url, {
                        ...options,
                        headers
                    });
                    
                    if (retryResponse.status === 401) {
                        // Still 401 after refresh, logout
                        this.handleTokenExpiration();
                        throw new Error('Authentication failed');
                    }
                    
                    return retryResponse;
                } catch (refreshError) {
                    console.error('Failed to refresh and retry:', refreshError);
                    this.handleTokenExpiration();
                    throw refreshError;
                }
            }
            
            return response;
        } catch (error) {
            console.error('Request error:', error);
            throw error;
        }
    },
    
    // Start periodic token refresh check (every 2 minutes)
    startAutoRefresh: function() {
        // Clear any existing interval
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
        
        // Check every 2 minutes
        this.refreshInterval = setInterval(() => {
            const token = getAdminToken();
            if (token && this.isTokenExpiringSoon(token)) {
                console.log('üîÑ Auto-refresh triggered');
                this.refreshAdminToken().catch(error => {
                    console.error('Auto-refresh failed:', error);
                });
            }
        }, 2 * 60 * 1000); // 2 minutes
        
        console.log('‚úÖ Auto-refresh started');
    },
    
    // Stop auto-refresh
    stopAutoRefresh: function() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
            console.log('‚èπÔ∏è Auto-refresh stopped');
        }
    }
};

// ==================== UPDATE EXISTING FUNCTIONS ====================

// Replace the existing makeAuthenticatedRequest function
async function makeAuthenticatedRequest(url, options = {}) {
    return TokenManager.makeAuthenticatedRequest(url, options);
}

// Update loadSocialMediaStudents to use token manager
async function loadSocialMediaStudents() {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/students'
        );

        if (response.ok) {
            const data = await response.json();
            socialMediaStudents = data.students || [];
            populateSMStudentSelect();
            renderSMStudentsTable();
            console.log(`‚úÖ Loaded ${socialMediaStudents.length} social media students`);
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to load social media students');
        }
    } catch (error) {
        console.error('Error loading social media students:', error);
        showNotification('Failed to load social media students', 'error');
    } finally {
        hideLoading();
    }
}

// Update loadSocialMediaAssignments to use token manager
async function loadSocialMediaAssignments() {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/tasks'
        );

        if (response.ok) {
            const data = await response.json();
            socialMediaTasks = data.tasks || [];
            renderSMAssignmentsTable(socialMediaTasks);
        } else {
            throw new Error('Failed to load assignments');
        }
    } catch (error) {
        console.error('Error loading assignments:', error);
        showNotification('Failed to load assignments', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== INITIALIZE ON PAGE LOAD ====================

document.addEventListener('DOMContentLoaded', function() {
    // Start auto-refresh when page loads
    TokenManager.startAutoRefresh();
    
    // Stop auto-refresh when page unloads
    window.addEventListener('beforeunload', function() {
        TokenManager.stopAutoRefresh();
    });
    
    // Check token immediately on load
    const token = getAdminToken();
    if (token) {
        if (TokenManager.isTokenExpired(token)) {
            console.warn('‚ö†Ô∏è Token expired on load');
            TokenManager.handleTokenExpiration();
        } else if (TokenManager.isTokenExpiringSoon(token)) {
            console.log('üîÑ Token expiring soon, refreshing on load...');
            TokenManager.refreshAdminToken().catch(error => {
                console.error('Initial token refresh failed:', error);
            });
        }
    }
});

// ==================== SKILL CATEGORY AUTO-LOAD ====================

// Add this to your skill category click handler
function handleSkillCategoryClick(category) {
    console.log(`üì± Loading students for category: ${category}`);
    
    showLoading();
    
    // Fetch students by category
    TokenManager.makeAuthenticatedRequest(
        `https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/students/by-category?category=${category}`
    )
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            socialMediaStudents = data.students;
            populateSMStudentSelect();
            showNotification(`Loaded ${data.total_count} ${category} students`, 'success');
        } else {
            throw new Error(data.error);
        }
    })
    .catch(error => {
        console.error('Error loading students by category:', error);
        showNotification(`Failed to load ${category} students`, 'error');
    })
    .finally(() => {
        hideLoading();
    });
}

// Add click listeners to skill category buttons/sections
document.addEventListener('DOMContentLoaded', function() {
    const skillCategorySelect = document.getElementById('smSkillCategory');
    if (skillCategorySelect) {
        skillCategorySelect.addEventListener('change', async function() {
            const selectedCategory = this.value;
            if (selectedCategory) {
                console.log(`Loading ${selectedCategory} students...`);
                
                try {
                    showLoading();
                    
                    const response = await TokenManager.makeAuthenticatedRequest(
                        `https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/students/by-category?category=${selectedCategory}`
                    );
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        socialMediaStudents = data.students;
                        populateSMStudentSelect();
                        showNotification(`Loaded ${data.total_count} ${selectedCategory} students`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Failed to load students', 'error');
                } finally {
                    hideLoading();
                }
            }
        });
    }
});

console.log('‚úÖ Token Management Module Loaded with Auto-Refresh');
       // Global variables
let currentAdmin = null;
let adminAssignment = null;
let assignedStudents = [];
let availableResources = [];
let selectedResource = null;
let myTasks = [];
let isMobileMenuOpen = false;

// Token management functions
function getAdminToken() {
    return localStorage.getItem('admin_token') || 
           sessionStorage.getItem('admin_token') || 
           getCookie('admin_token');
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    setupEventListeners();
    loadAdminData();
});

function checkAuthentication() {
    const token = getAdminToken();
    if (!token) {
        window.location.href = '/admin-login';
        return;
    }

    // Load admin data from localStorage
    const adminData = localStorage.getItem('admin_user');
    if (adminData) {
        currentAdmin = JSON.parse(adminData);
        
        // Check if this is the correct dashboard for the admin role
        const currentPath = window.location.pathname;
        
        if (currentAdmin.role === 'super_admin' && currentPath.includes('grade-admin')) {
            console.log('Super admin on grade admin dashboard - redirecting');
            window.location.href = '/admin-dashboard';
            return;
        }
        
        if (currentAdmin.role !== 'super_admin' && currentPath.includes('admin-dashboard') && !currentPath.includes('grade-admin')) {
            console.log('Grade admin on super admin dashboard - redirecting');
            window.location.href = '/grade-admin-dashboard';
            return;
        }
        
        updateAdminUI();
    }
}

function updateAdminUI() {
    if (currentAdmin) {
        const initials = currentAdmin.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        document.getElementById('adminAvatar').textContent = initials;
        document.getElementById('adminName').textContent = currentAdmin.name;
        document.getElementById('adminRole').textContent = 'Grade Section Admin';
        
        // Update grade section badge if it exists
        const gradeSectionBadge = document.getElementById('gradeSectionBadge');
        if (gradeSectionBadge && adminAssignment) {
            gradeSectionBadge.textContent = `Grade ${adminAssignment.grade_section}`;
        }
    }
}

function setupEventListeners() {
    // Sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            const page = this.getAttribute('data-page');
            if (page) {
                e.preventDefault();
                navigateToPage(page);
            }

            // Close mobile menu when clicking nav items
            if (window.innerWidth <= 768 && isMobileMenuOpen) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                sidebar.classList.add('collapsed');
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
                isMobileMenuOpen = false;
            }
        });
    });

    // Sidebar toggle
 // MOBILE MENU VARIABLES
let isMobileMenuOpen = false;

// IMPROVED SIDEBAR TOGGLE
document.getElementById('sidebarToggle').addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('Toggle clicked!');
    
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('mobileOverlay');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        isMobileMenuOpen = !isMobileMenuOpen;
        
        if (isMobileMenuOpen) {
            sidebar.classList.remove('collapsed');
            sidebar.classList.add('show');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        } else {
            sidebar.classList.add('collapsed');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }
    } else {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
    }
});

// CLOSE MENU WHEN CLICKING OVERLAY
document.getElementById('mobileOverlay').addEventListener('click', function() {
    if (window.innerWidth <= 768 && isMobileMenuOpen) {
        document.getElementById('sidebarToggle').click();
    }
});

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Form submission
    // Update the existing form submission handler
document.getElementById('assignTaskForm').addEventListener('submit', function(e) {
    if (currentMode === 'single') {
        handleAssignTask(e);
    } else {
        e.preventDefault(); // Bulk mode uses different submission
    }
});

    // Add edit task form event listener
    const editTaskForm = document.getElementById('editTaskForm');
    if (editTaskForm) {
        editTaskForm.addEventListener('submit', handleEditTask);
    }

    // Resource selection
    document.getElementById('resourceSelect').addEventListener('change', function() {
        const resourceId = this.value;
        if (resourceId) {
            const resource = availableResources.find(r => r.id == resourceId);
            if (resource) {
                selectResource(resource);
            }
        } else {
            clearSelectedResource();
        }
    });

    // Search and filters
    setupSearchAndFilters();
}

function navigateToPage(page) {
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        }
    });

    // Hide all pages
    document.querySelectorAll('.page-content').forEach(content => {
        content.classList.remove('active');
    });

    // Show selected page
    const pageElement = document.getElementById(page + '-page');
    if (pageElement) {
        pageElement.classList.add('active');
        
        // Update page title
        const pageTitle = document.getElementById('pageTitle');
        const pageTitles = {
            'dashboard': 'Dashboard',
            'students': 'My Students',
            'resources': 'Assigned Resources',
            'assign-task': 'Assign Tasks',
            'my-tasks': 'Task Management'
        };
        pageTitle.textContent = pageTitles[page] || 'Dashboard';

        // Load page-specific data
        loadPageData(page);
    }
}

function loadPageData(page) {
    console.log(`üìÑ Loading page: ${page}`);
    const currentAdmin = JSON.parse(localStorage.getItem('admin_user') || '{}');

    switch(page) {
        case 'dashboard':
            loadDashboardStats();
            break;
            
        case 'students':
            renderStudentsTable();
            break;
            
        case 'resources':
            renderResourcesGrid();
            break;
            
        case 'assign-task':
            console.log('üìù Loading assign-task page...');
            populateResourceSelect();
            
            // ‚úÖ CRITICAL FIX: Ensure students are populated in single mode
            if (currentMode === 'single' || !currentMode) {
                console.log('üîÑ Single mode detected - populating students...');
                
                // Immediate population
                populateStudentSelect();
                
                // Delayed re-population for safety
                setTimeout(() => {
                    console.log('üîÑ Re-populating after 100ms...');
                    populateStudentSelect();
                }, 100);
                
                setTimeout(() => {
                    console.log('üîÑ Final re-population after 500ms...');
                    populateStudentSelect();
                }, 500);
            }
            break;
            
        case 'my-tasks':
            if (currentAdmin.role === 'super_admin') {
                console.log('Super admin trying to access my-tasks - blocking');
                const tbody = document.getElementById('myTasksTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                <h3>Access Restricted</h3>
                                <p>Super admins should use the main Tasks section.</p>
                            </td>
                        </tr>
                    `;
                }
            } else {
                loadMyTasks();
            }
            break;
            
        case 'coaches':
            loadCoachesPage();
            break;
            
        case 'social-media-assign':
            console.log('üì± Loading social media page...');
            setTimeout(() => {
                initializeSocialMediaManagement();
            }, 100);
            break;
    }
}

async function loadAdminData() {
    console.log('üöÄ loadAdminData() started');
    showLoading();
    
    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/my-assignment', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            adminAssignment = data.assignment;
            assignedStudents = data.assigned_students;
            availableResources = data.available_resources;

            console.log('üì¶ Admin data loaded:');
            console.log('   Grade section:', adminAssignment?.grade_section);
            console.log('   Students count:', assignedStudents?.length || 0);
            console.log('   Resources count:', availableResources?.length || 0);

            // Update UI
            updateAssignmentUI();
            loadDashboardStats();
            
            // ‚úÖ CRITICAL FIX: Force populate student selects
            console.log('üîÑ Forcing student select population...');
            populateStudentSelect();
            renderBulkStudents();
            
            // ‚úÖ ADDITIONAL FIX: Re-populate after a delay
            setTimeout(() => {
                console.log('üîÑ Re-populating student select after delay...');
                populateStudentSelect();
            }, 500);
            
            console.log('‚úÖ Admin data loaded successfully');
        } else {
            const errorData = await response.json();
            console.error('‚ùå Failed to load admin assignment:', errorData);
            throw new Error(errorData.error || 'Failed to load admin data');
        }
    } catch (error) {
        console.error('‚ùå Error loading admin data:', error);
        showNotification('Failed to load admin data. Using demo data.', 'error');
        loadDemoData();
    } finally {
        hideLoading();
    }
}


function loadDemoData() {
    // Demo data for testing
    adminAssignment = {
        grade_section: '1-3',
        max_acard_amount: 50.00,
        permissions: {
            assign_tasks: true,
            credit_acard: true,
            max_acard_per_credit: 5.00
        }
    };

    assignedStudents = [
        {
            id: 1,
            name: "Alice Johnson",
            email: "alice@school.edu",
            grade_level: "2",
            school_name: "Lincoln Elementary",
            total_points: 150,
            acard_balance: 12.50
        },
        {
            id: 2,
            name: "Bob Smith",
            email: "bob@school.edu",
            grade_level: "3",
            school_name: "Lincoln Elementary",
            total_points: 200,
            acard_balance: 18.75
        }
    ];

    availableResources = [
        {
            id: 1,
            resource_type: 'internal_file',
            resource_title: 'Basic Addition Practice',
            task_file: 'addition-basics',
            subject_category: 'mathematics',
            description: 'Interactive addition exercises for early learners'
        },
        {
            id: 2,
            resource_type: 'external_link',
            resource_title: 'Khan Academy - Grade 2 Math',
            resource_url: 'https://www.khanacademy.org/math/cc-2nd-grade-math',
            subject_category: 'mathematics',
            description: 'Comprehensive math curriculum for grade 2'
        }
    ];

    updateAssignmentUI();
    loadDashboardStats();
    // Populate student select dropdowns
    populateStudentSelect();
    renderBulkStudents();
    console.log('Loaded demo assignment data');
}

function updateAssignmentUI() {
    if (adminAssignment) {
        // Update grade section displays
        const gradeSectionTitle = `Grade ${adminAssignment.grade_section} Section`;
        document.getElementById('gradeSectionTitle').textContent = gradeSectionTitle;
        document.getElementById('gradeSectionBadge').textContent = `Grade ${adminAssignment.grade_section}`;
        
        // Update A-Card limit display
        const maxAcard = adminAssignment.max_acard_amount || 0;
        document.getElementById('acardLimitBadge').textContent = `A-Card Limit: ‚Ç≥${maxAcard.toFixed(2)}`;
        document.getElementById('maxAcardDisplay').textContent = maxAcard.toFixed(2);
    }
}

function loadDashboardStats() {
    if (!adminAssignment || !assignedStudents) return;

    // Update student stats
    document.getElementById('totalAssignedStudents').textContent = assignedStudents.length;
    
    // Count students with pending tasks (demo calculation)
    const studentsWithTasks = Math.floor(assignedStudents.length * 0.6);
    document.getElementById('activeStudentsInfo').textContent = `${studentsWithTasks} with pending tasks`;

    // Update resource stats
    document.getElementById('totalResources').textContent = availableResources.length;
    const resourceTypes = [...new Set(availableResources.map(r => r.resource_type))].length;
    document.getElementById('resourceTypesInfo').textContent = `${resourceTypes} types available`;

    // Demo task stats
    const totalTasks = Math.floor(assignedStudents.length * 2.5);
    const completedTasks = Math.floor(totalTasks * 0.7);
    document.getElementById('totalTasksAssigned').textContent = totalTasks;
    document.getElementById('completedTasksInfo').textContent = `${completedTasks} completed`;

    // Demo A-Card stats
    const totalACardUsed = assignedStudents.reduce((sum, student) => sum + student.acard_balance, 0);
    document.getElementById('totalAcardUsed').textContent = `‚Ç≥${totalACardUsed.toFixed(2)}`;
    
    const maxLimit = adminAssignment.max_acard_amount * assignedStudents.length;
    const percentUsed = maxLimit > 0 ? Math.round((totalACardUsed / maxLimit) * 100) : 0;
    document.getElementById('acardRemainingInfo').textContent = `${percentUsed}% of limit used`;
}

function renderStudentsTable() {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = '';

    assignedStudents.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${student.email}</div>
                </div>
            </td>
            <td>Grade ${student.grade_level}</td>
            <td>${student.school_name}</td>
            <td>${student.total_points || 0}</td>
            <td>${(student.acard_balance || 0).toFixed(2)}</td>
            <td>
                <span class="status-badge status-active">Active</span>
            </td>
            <td>
                <button class="btn btn-secondary" onclick="viewStudentTasks(${student.id})" style="padding: 0.5rem 1rem; font-size: 0.75rem;">
                    üìã View Tasks
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderResourcesGrid() {
    const grid = document.getElementById('resourcesGrid');
    grid.innerHTML = '';

    if (availableResources.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--gray-500);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                <h3>No Resources Assigned</h3>
                <p>Your Super Admin hasn't assigned any resources to your grade section yet.</p>
            </div>
        `;
        return;
    }

    availableResources.forEach(resource => {
        const card = document.createElement('div');
        card.className = 'resource-card';
        card.innerHTML = `
            <div class="resource-type-badge ${resource.resource_type}">
                ${resource.resource_type.replace('_', ' ')}
            </div>
            <div class="resource-title">${resource.resource_title}</div>
            <div class="resource-description">${resource.description || 'No description available'}</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="resource-category">${resource.subject_category}</div>
                <button class="btn btn-primary" onclick="useResource(${resource.id})" style="padding: 0.5rem 1rem; font-size: 0.75rem;">
                    üìù Use Resource
                </button>
            </div>
        `;
        grid.appendChild(card);
    });
}

function populateResourceSelect() {
    const select = document.getElementById('resourceSelect');
    select.innerHTML = '<option value="">Choose a resource to assign...</option>';

    availableResources.forEach(resource => {
        const option = document.createElement('option');
        option.value = resource.id;
        option.textContent = `${resource.resource_title} (${resource.subject_category})`;
        select.appendChild(option);
    });
}

function populateStudentSelect() {
    console.log('üîÑ populateStudentSelect() called');
    console.log('   assignedStudents length:', assignedStudents?.length || 0);
    
    const select = document.getElementById('studentSelect');
    
    if (!select) {
        console.error('‚ùå Student select element NOT FOUND');
        return;
    }
    
    console.log('‚úÖ Student select element found');

    // Clear existing options
    select.innerHTML = '';

    if (!assignedStudents || assignedStudents.length === 0) {
        console.warn('‚ö†Ô∏è No students available to populate');
        const option = document.createElement('option');
        option.textContent = 'No students available';
        option.disabled = true;
        option.selected = true;
        select.appendChild(option);
        return;
    }

    console.log(`üìù Populating ${assignedStudents.length} students...`);

    // Populate with students
    assignedStudents.forEach((student, index) => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.name} (Grade ${student.grade_level})`;
        select.appendChild(option);
        
        if (index < 3) {
            console.log(`   ‚úì Added: ${student.name} (ID: ${student.id})`);
        }
    });
    
    if (assignedStudents.length > 3) {
        console.log(`   ... and ${assignedStudents.length - 3} more`);
    }

    console.log(`‚úÖ Successfully populated ${select.options.length} students`);
}


function selectResource(resource) {
    selectedResource = resource;
    
    // Show selected resource panel
    const panel = document.getElementById('selectedResourcesPanel');
    const list = document.getElementById('selectedResourcesList');
    
    let resourceUrl = '';
    if (resource.resource_type === 'internal_file' && resource.task_file) {
        resourceUrl = `https://deciphersacad.online//${resource.task_file}`;
    } else if (resource.resource_url) {
    resourceUrl = resource.resource_url;
    }

    list.innerHTML = `
        <div class="selected-resource-item">
            <div>
                <strong>${resource.resource_title}</strong><br>
                <small style="color: var(--gray-600);">${resource.subject_category} ‚Ä¢ ${resource.resource_type.replace('_', ' ')}</small><br>
                ${resourceUrl ? `<small style="color: var(--blue-500); font-family: monospace;">${resourceUrl}</small>` : ''}
            </div>
            <button type="button" class="remove-resource-btn" onclick="clearSelectedResource()">
                ‚úï Remove
            </button>
        </div>
    `;
    
    panel.classList.add('show');

    // Auto-fill task title
    document.getElementById('taskTitle').value = resource.resource_title;
    document.getElementById('taskDescription').value = resource.description || '';
}

function clearSelectedResource() {
    selectedResource = null;
    document.getElementById('selectedResourcesPanel').classList.remove('show');
    document.getElementById('resourceSelect').value = '';
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
}

function useResource(resourceId) {
    const resource = availableResources.find(r => r.id === resourceId);
    if (resource) {
        navigateToPage('assign-task');
        setTimeout(() => {
            document.getElementById('resourceSelect').value = resourceId;
            selectResource(resource);
        }, 500);
    }
}

async function handleAssignTask(e) {
    e.preventDefault();

    const currentAdmin = JSON.parse(localStorage.getItem('admin_user') || '{}');

    // Prevent super admin from using this endpoint
    if (currentAdmin.role === 'super_admin') {
        showNotification('Super admins should use the main task assignment interface', 'error');
        return;
    }

    // Get link configuration
    const linkConfig = getCurrentTaskLinkConfig();

    // Check if we have either a resource or link configuration
    if (!selectedResource && !linkConfig) {
        showNotification('Please select a resource or configure a task link', 'error');
        return;
    }

    const selectedStudentIds = Array.from(document.getElementById('studentSelect').selectedOptions)
        .map(option => parseInt(option.value));

    if (selectedStudentIds.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    const acardCredit = parseFloat(document.getElementById('acardCredit').value) || 0;
    const maxAllowed = adminAssignment?.permissions?.max_acard_per_credit || adminAssignment?.max_acard_amount || 0;

    if (acardCredit > maxAllowed) {
        showNotification(`A-Card credit cannot exceed ‚Ç≥${maxAllowed.toFixed(2)} per task`, 'error');
        return;
    }

    const taskData = {
        student_ids: selectedStudentIds,
        task_title: document.getElementById('taskTitle').value,
        task_description: document.getElementById('taskDescription').value,
        points_reward: parseInt(document.getElementById('pointsReward').value) || 0,
        acard_credit: acardCredit,
        due_date: document.getElementById('dueDate').value || null
    };

    // Add resource_id if resource is selected
    if (selectedResource) {
        taskData.resource_id = selectedResource.id;
    }

    // Add link configuration if available
    if (linkConfig) {
        taskData.link_config = linkConfig;
    }

    showLoading();
    try {
        // Use the resource-specific endpoint for grade admins
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/assign-resource-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(taskData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(`Task assigned to ${result.assigned_tasks.length} students successfully!`);
            document.getElementById('assignTaskForm').reset();
            clearSelectedResource();
            switchLinkType('internal'); // Reset to internal tab
            loadDashboardStats(); // Refresh stats
        } else {
            const error = await response.json();
            console.error('Task assignment failed:', error);
            throw new Error(error.error || 'Failed to assign task');
        }
    } catch (error) {
        console.error('Error assigning task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function loadMyTasks() {
    const currentAdmin = JSON.parse(localStorage.getItem('admin_user') || '{}');
    
    // Prevent super admin from accessing this view
    if (currentAdmin.role === 'super_admin') {
        console.log('Super admin detected - redirecting to main dashboard');
        myTasks = [];
        renderMyTasksTable(myTasks);
        showNotification('Super admins should use the main Task Management section', 'info');
        return;
    }
    
    showLoading();
    try {
        // CRITICAL: Use the correct endpoint for grade admins ONLY
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/my-tasks?per_page=100', {
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            myTasks = data.tasks || [];
            console.log(`Grade admin loaded ${myTasks.length} tasks (only their own)`);
            renderMyTasksTable(myTasks);
        } else {
            const errorData = await response.json();
            console.error('API Error:', errorData);
            
            // If the endpoint returns an error for super admin, show appropriate message
            if (errorData.error && errorData.error.includes('Super admins should use')) {
                showNotification('Super admins should use the main task management section', 'info');
                myTasks = [];
                renderMyTasksTable(myTasks);
                return;
            }
            
            throw new Error(errorData.error || 'Failed to load tasks');
        }
    } catch (error) {
        console.error('Error loading my tasks:', error);
        showNotification('Failed to load tasks. Using demo data.', 'error');
        loadDemoTasks();
    } finally {
        hideLoading();
    }
}



async function editTask(taskId) {
    const task = myTasks.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    // Populate edit modal with existing data
    document.getElementById('editTaskId').value = task.id;
    document.getElementById('editTaskTitle').value = task.task_title;
    document.getElementById('editTaskDescription').value = task.task_description || '';
    document.getElementById('editPointsReward').value = task.points_reward || 0;
    document.getElementById('editAcardCredit').value = task.acard_credit || 0;
    
    // Set due date
    if (task.due_date) {
        const dueDate = new Date(task.due_date);
        const localDateTime = new Date(dueDate.getTime() - dueDate.getTimezoneOffset() * 60000);
        document.getElementById('editDueDate').value = localDateTime.toISOString().slice(0, 16);
    } else {
        document.getElementById('editDueDate').value = '';
    }
    
    // Populate resource select
    populateEditResourceSelect();
    
    // Set current resource if available
    const taskData = task.task_data || {};
    if (taskData.resource_id) {
        document.getElementById('editResourceSelect').value = taskData.resource_id;
    }
    
    // Set max A-Card limit
    const maxAcard = adminAssignment?.permissions?.max_acard_per_credit || adminAssignment?.max_acard_amount || 0;
    document.getElementById('editMaxAcardDisplay').textContent = maxAcard.toFixed(2);
    
    openModal('editTaskModal');
}

async function handleEditTask(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('editTaskId').value;
    const selectedResourceId = document.getElementById('editResourceSelect').value;
    const acardCredit = parseFloat(document.getElementById('editAcardCredit').value) || 0;
    const maxAllowed = adminAssignment?.permissions?.max_acard_per_credit || adminAssignment?.max_acard_amount || 0;

    if (acardCredit > maxAllowed) {
        showNotification(`A-Card credit cannot exceed ‚Ç≥${maxAllowed.toFixed(2)} per task`, 'error');
        return;
    }
    
    // Build task data with resource information
    let taskData = {};
    
    if (selectedResourceId) {
        const selectedResource = availableResources.find(r => r.id == selectedResourceId);
        if (selectedResource) {
            taskData.resource_id = selectedResource.id;
            
            // Set up link configuration based on resource type
            const linkConfig = {
                type: selectedResource.resource_type === 'internal_file' ? 'internal' : 'external'
            };
            
if (selectedResource.resource_type === 'internal_file' && selectedResource.task_file) {
                linkConfig.task_file = selectedResource.task_file;
                linkConfig.external_url = `https://deciphersacad.online//${selectedResource.task_file}`;
                taskData.task_file = selectedResource.task_file;
                taskData.external_url = linkConfig.external_url;
            } else if (selectedResource.resource_url) {
                linkConfig.external_url = selectedResource.resource_url;
                taskData.external_url = selectedResource.resource_url;
            }
            
            taskData.link_config = linkConfig;
            taskData.link_type = linkConfig.type;
            taskData.is_external = true;
        }
    }
    
    const updateData = {
        task_title: document.getElementById('editTaskTitle').value,
        task_description: document.getElementById('editTaskDescription').value,
        points_reward: parseInt(document.getElementById('editPointsReward').value) || 0,
        acard_credit: acardCredit,
        due_date: document.getElementById('editDueDate').value || null,
        task_data: taskData
    };

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/task/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            const result = await response.json();
            showNotification('Task updated successfully!');
            closeModal('editTaskModal');
            loadMyTasks(); // Refresh tasks table
            loadDashboardStats(); // Refresh dashboard stats
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update task');
        }
    } catch (error) {
        console.error('Error updating task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function viewTaskDetails(taskId) {
    const task = myTasks.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    const taskData = task.task_data || {};
    const resourceId = taskData.resource_id;
    const resource = availableResources.find(r => r.id == resourceId);
    
    let resourceInfo = {
        title: 'Unknown Resource',
        type: 'unknown',
        url: taskData.external_url || ''
    };

    if (resource) {
        resourceInfo = {
            title: resource.resource_title,
            type: resource.resource_type.replace('_', ' '),
            category: resource.subject_category,
            description: resource.description,
            url: taskData.external_url || resource.resource_url || ''
        };
    } else if (taskData.external_url) {
        resourceInfo.title = taskData.link_type === 'internal' ? 'Internal Deciph.AI File' : 'External Link';
        resourceInfo.type = taskData.link_type || 'external';
    }

    const taskDetailsBody = document.getElementById('taskDetailsBody');
    taskDetailsBody.innerHTML = `
        <div style="margin-bottom: 2rem;">
            <h4>${task.task_title}</h4>
            <p style="margin: 1rem 0; color: var(--gray-600);">${task.task_description || 'No description provided'}</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
                <div>
                    <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Task Information</h5>
                    <p><strong>Student:</strong> ${task.student ? task.student.name : 'Unknown'}</p>
                    <p><strong>Grade:</strong> ${task.student ? task.student.grade_level : 'N/A'}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${task.status === 'completed' ? 'active' : 'pending'}">${task.status.charAt(0).toUpperCase() + task.status.slice(1)}</span></p>
                    <p><strong>Assigned:</strong> ${new Date(task.assigned_at).toLocaleDateString()}</p>
                    ${task.completed_at ? `<p><strong>Completed:</strong> ${new Date(task.completed_at).toLocaleDateString()}</p>` : ''}
                </div>
                <div>
                    <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Rewards & Due Date</h5>
                    <p><strong>Points:</strong> ${task.points_reward || 0}</p>
                    <p><strong>A-Card Credit:</strong> ‚Ç≥${(task.acard_credit || 0).toFixed(2)}</p>
                    <p><strong>Due Date:</strong> ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date'}</p>
                </div>
            </div>
            
            <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                <h5 style="color: var(--primary-color); margin-bottom: 1rem;">üìö Resource Information</h5>
                <p><strong>Title:</strong> ${resourceInfo.title}</p>
                <p><strong>Type:</strong> <span style="text-transform: capitalize;">${resourceInfo.type}</span></p>
                ${resourceInfo.category ? `<p><strong>Category:</strong> ${resourceInfo.category}</p>` : ''}
                ${resourceInfo.description ? `<p><strong>Description:</strong> ${resourceInfo.description}</p>` : ''}
                ${resourceInfo.url ? `<p><strong>URL:</strong> <a href="${resourceInfo.url}" target="_blank" style="color: var(--blue-500); text-decoration: none; word-break: break-all;">${resourceInfo.url}</a></p>` : ''}
            </div>
            
            ${task.completion_data && Object.keys(task.completion_data).length > 0 ? `
                <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                    <h5 style="color: var(--green-500); margin-bottom: 1rem;">üìä Completion Results</h5>
                    <p><strong>Score:</strong> ${task.completion_data.score || 0}/${task.completion_data.max_score || 100}</p>
                    <p><strong>Time Spent:</strong> ${task.completion_data.time_spent ? Math.floor(task.completion_data.time_spent / 60) + ' minutes' : 'N/A'}</p>
                </div>
            ` : ''}
        </div>
    `;
    
    openModal('taskDetailsModal');
}

async function deleteTask(taskId) {
    const task = myTasks.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    const confirmMessage = `Are you sure you want to delete the task "${task.task_title}" assigned to ${task.student ? task.student.name : 'Unknown Student'}?\n\nThis action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }

    showLoading();
    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/task/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(result.message);
            loadMyTasks(); // Refresh tasks table
            loadDashboardStats(); // Refresh dashboard stats
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete task');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function populateEditResourceSelect() {
    const select = document.getElementById('editResourceSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Choose a resource...</option>';

    availableResources.forEach(resource => {
        const option = document.createElement('option');
        option.value = resource.id;
        option.textContent = `${resource.resource_title} (${resource.subject_category})`;
        select.appendChild(option);
    });
}

function filterTasks() {
    const searchQuery = document.getElementById('tasksSearch')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('taskStatusFilter')?.value || '';
    
    let filtered = myTasks;
    
    // Apply search filter
    if (searchQuery) {
        filtered = filtered.filter(task => 
            task.task_title.toLowerCase().includes(searchQuery) ||
            (task.task_description && task.task_description.toLowerCase().includes(searchQuery)) ||
            (task.student && task.student.name.toLowerCase().includes(searchQuery))
        );
    }
    
    // Apply status filter
    if (statusFilter) {
        filtered = filtered.filter(task => task.status === statusFilter);
    }
    
    renderMyTasksTable(filtered);
}

function loadDemoTasks() {
    const currentAdmin = JSON.parse(localStorage.getItem('admin_user') || '{}');
    
    // Don't load demo tasks for super admin
    if (currentAdmin.role === 'super_admin') {
        myTasks = [];
        renderMyTasksTable(myTasks);
        return;
    }

    // Demo tasks for grade admin only
    myTasks = [
        {
            id: 1,
            task_title: "Grade 2 Math - Addition Practice",
            task_description: "Complete addition exercises using the assigned resource",
            status: "pending",
            points_reward: 20,
            acard_credit: 2.00,
            due_date: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
            assigned_at: new Date().toISOString(),
            student: {
                id: 1,
                name: "Alice Johnson",
                grade_level: "2"
            },
            task_data: {
                resource_id: 1,
                resource_type: 'internal_file',
                external_url: 'https://deciphersacad.online//addition-basics',
                assigned_by_grade_admin: true
            },
            resource: {
                id: 1,
                resource_title: "Basic Addition Practice",
                resource_type: "internal_file",
                subject_category: "mathematics"
            }
        },
        {
            id: 2,
            task_title: "Reading Comprehension - Story Time",
            task_description: "Read the assigned story and answer questions",
            status: "completed",
            points_reward: 15,
            acard_credit: 1.50,
            due_date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            assigned_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            completed_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
            student: {
                id: 2,
                name: "Bob Smith",
                grade_level: "3"
            },
            task_data: {
                resource_id: 2,
                resource_type: 'external_link',
                external_url: 'https://example.com/reading-story',
                assigned_by_grade_admin: true
            },
            resource: {
                id: 2,
                resource_title: "Interactive Story Reading",
                resource_type: "external_link",
                subject_category: "english"
            },
            completion_data: {
                score: 85,
                max_score: 100,
                time_spent: 1200
            }
        }
    ];
    
    console.log('Loaded demo tasks for grade admin:', myTasks.length);
    renderMyTasksTable(myTasks);
}

function showLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.classList.add('show');
    }
}

function hideLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.classList.remove('show');
    }
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    if (notification && notificationText) {
        notificationText.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    } else {
        // Fallback if notification elements don't exist
        console.log(`${type.toUpperCase()}: ${message}`);
        alert(message);
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

function setupSearchAndFilters() {
    // Students search
    const studentsSearch = document.getElementById('studentsSearch');
    if (studentsSearch) {
        studentsSearch.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = assignedStudents.filter(student => 
                student.name.toLowerCase().includes(query) ||
                student.email.toLowerCase().includes(query) ||
                student.school_name.toLowerCase().includes(query)
            );
            renderFilteredStudents(filtered);
        });
    }

    // Tasks search and filter
    const tasksSearch = document.getElementById('tasksSearch');
    const taskStatusFilter = document.getElementById('taskStatusFilter');
    
    if (tasksSearch) {
        tasksSearch.addEventListener('input', filterTasks);
    }
    if (taskStatusFilter) {
        taskStatusFilter.addEventListener('change', filterTasks);
    }
}

function renderFilteredStudents(students) {
    const tbody = document.getElementById('studentsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div>
                    <div style="font-weight: 600;">${student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-500);">${student.email}</div>
                </div>
            </td>
            <td>Grade ${student.grade_level}</td>
            <td>${student.school_name}</td>
            <td>${student.total_points || 0}</td>
            <td>${(student.acard_balance || 0).toFixed(2)}</td>
            <td>
                <span class="status-badge status-active">Active</span>
            </td>
            <td>
                <button class="btn btn-secondary" onclick="viewStudentTasks(${student.id})" style="padding: 0.5rem 1rem; font-size: 0.75rem;">
                    üìã View Tasks
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Bulk assignment variables
let bulkTasks = [];
let selectedBulkStudents = new Set();
let bulkTaskCounter = 0;
let currentMode = 'single';

// Mode switching
function switchMode(mode) {
    console.log(`üîÄ Switching mode to: ${mode}`);
    currentMode = mode;
    
    const singleMode = document.getElementById('singleTaskMode');
    const bulkMode = document.getElementById('bulkTaskMode');
    const singleBtn = document.getElementById('singleModeBtn');
    const bulkBtn = document.getElementById('bulkModeBtn');

    if (mode === 'single') {
        singleMode.style.display = 'block';
        bulkMode.style.display = 'none';
        singleBtn.className = 'btn btn-primary';
        bulkBtn.className = 'btn btn-secondary';
        
        // ‚úÖ CRITICAL FIX: Ensure students are populated when switching to single mode
        console.log('üîÑ Single mode activated - populating students...');
        
        // Immediate population
        populateStudentSelect();
        
        // Delayed re-population
        setTimeout(() => {
            console.log('üîÑ Re-populating after mode switch...');
            populateStudentSelect();
        }, 100);
        
    } else {
        singleMode.style.display = 'none';
        bulkMode.style.display = 'block';
        singleBtn.className = 'btn btn-secondary';
        bulkBtn.className = 'btn btn-primary';
        initializeBulkMode();
    }
}

function initializeBulkMode() {
    if (bulkTasks.length === 0) {
        addBulkTask();
    }
    renderBulkStudents();
    updateBulkSummary();
}

function addBulkTask() {
    bulkTaskCounter++;
    const task = {
        id: bulkTaskCounter,
        title: '',
        description: '',
        resource_id: '',
        task_type: 'mathematics',
        points_reward: 10,
        acard_credit: 1.0,
        due_date: '',
        link_type: 'internal',
        task_file: '',
        external_url: ''
    };

    bulkTasks.push(task);
    renderBulkTasks();
    updateBulkTaskBuilder();
}

function removeBulkTask(taskId) {
    bulkTasks = bulkTasks.filter(t => t.id !== taskId);
    renderBulkTasks();
    updateBulkTaskBuilder();
    updateBulkSummary();
}

function renderBulkTasks() {
    const container = document.getElementById('bulkTasksContainer');
    container.innerHTML = '';
    
    bulkTasks.forEach((task, index) => {
        const taskCard = document.createElement('div');
        taskCard.className = 'bulk-task-card';
        taskCard.innerHTML = `
            <div class="bulk-task-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="bulk-task-number">${index + 1}</div>
                    <h4 style="margin: 0;">Task ${index + 1}</h4>
                </div>
                ${bulkTasks.length > 1 ? `<button class="bulk-remove-btn" onclick="removeBulkTask(${task.id})">√ó</button>` : ''}
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Resource</label>
                    <select class="form-input" id="bulkResourceSelect_${task.id}" onchange="handleBulkResourceChange(${task.id}, this.value)">
                        <option value="">Select a resource</option>
                        ${availableResources.map(r => 
                            `<option value="${r.id}" ${task.resource_id == r.id ? 'selected' : ''}>
                                ${r.resource_title} (${r.subject_category})
                            </option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" value="${task.title}" 
                           onchange="updateBulkTask(${task.id}, 'title', this.value)" 
                           placeholder="Enter task title">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Task Type</label>
                    <select class="form-input" onchange="updateBulkTask(${task.id}, 'task_type', this.value)">
                        <option value="mathematics" ${task.task_type === 'mathematics' ? 'selected' : ''}>Mathematics</option>
                        <option value="english" ${task.task_type === 'english' ? 'selected' : ''}>English</option>
                        <option value="science" ${task.task_type === 'science' ? 'selected' : ''}>Science</option>
                        <option value="history" ${task.task_type === 'history' ? 'selected' : ''}>History</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="datetime-local" class="form-input" value="${task.due_date}" 
                           onchange="updateBulkTask(${task.id}, 'due_date', this.value)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Points</label>
                    <input type="number" class="form-input" value="${task.points_reward}" min="0"
                           onchange="updateBulkTask(${task.id}, 'points_reward', parseInt(this.value) || 0)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">A-Card (‚Ç≥)</label>
                    <input type="number" class="form-input" value="${task.acard_credit}" min="0" step="0.01"
                           onchange="updateBulkTask(${task.id}, 'acard_credit', parseFloat(this.value) || 0)">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input form-textarea" onchange="updateBulkTask(${task.id}, 'description', this.value)"
                          placeholder="Enter task description">${task.description}</textarea>
            </div>

            <!-- Task Link Configuration -->
            <div class="form-group">
                <label class="form-label">Task Link Configuration</label>
                <div class="link-type-selector">
                    <div class="link-type-description">
                        Choose how students will access this task. You can use internal Deciph.AI files, external links, or common educational platforms.
                    </div>

                    <div class="link-type-tabs">
                        <button type="button" class="link-type-tab ${task.link_type === 'internal' ? 'active' : ''}" data-type="internal" onclick="switchBulkLinkType(${task.id}, 'internal')">
                            üìÅ Internal File
                        </button>
                        <button type="button" class="link-type-tab ${task.link_type === 'external' ? 'active' : ''}" data-type="external" onclick="switchBulkLinkType(${task.id}, 'external')">
                            üîó External Link
                        </button>
                        <button type="button" class="link-type-tab ${task.link_type === 'common' ? 'active' : ''}" data-type="common" onclick="switchBulkLinkType(${task.id}, 'common')">
                            ‚≠ê Common Links
                        </button>
                    </div>

                    <!-- Internal File Option -->
                    <div class="link-option ${task.link_type === 'internal' ? 'active' : ''}" id="bulk-internal-option-${task.id}">
                        <input type="text" class="form-input" id="bulkTaskFile_${task.id}" value="${task.task_file || ''}"
                               onchange="updateBulkTask(${task.id}, 'task_file', this.value)"
                               placeholder="e.g., fractions, algebra, essay-writing">
                        <div class="task-file-section">
                            <div class="task-file-info">
                                üí° <strong>Internal File Usage:</strong> Enter a specific topic/file name for Deciph.AI tasks.
                            </div>
                            <div class="task-file-info">
                                Example: If you enter "fractions", students will be redirected to:
                                <code>https://deciphersacad.online//fractions</code>
                            </div>
                        </div>
                    </div>

                    <!-- External Link Option -->
                    <div class="link-option ${task.link_type === 'external' ? 'active' : ''}" id="bulk-external-option-${task.id}">
                        <input type="url" class="form-input" id="bulkExternalTaskUrl_${task.id}" value="${task.link_type === 'external' ? (task.external_url || '') : ''}"
                               onchange="updateBulkTask(${task.id}, 'external_url', this.value)"
                               placeholder="https://example.com/your-task-link" oninput="validateBulkExternalUrl(${task.id})">
                        <div class="url-validator empty" id="bulkUrlValidator_${task.id}">
                            <span>üí° Enter any valid URL (must start with http:// or https://)</span>
                        </div>
                        <div class="external-link-preview" id="bulkExternalLinkPreview_${task.id}">
                            <div class="preview-header">
                                üîó External Task Preview
                            </div>
                            <div class="preview-url" id="bulkPreviewUrl_${task.id}"></div>
                        </div>
                    </div>

                    <!-- Common Links Option -->
                    <div class="link-option ${task.link_type === 'common' ? 'active' : ''}" id="bulk-common-option-${task.id}">
                        <div class="common-links-grid" id="bulkCommonLinksGrid_${task.id}">
                            ${getCommonLinksHTML(task.id)}
                        </div>
                        <div style="margin-top: 1rem;">
                            <input type="url" class="form-input" id="bulkCustomCommonUrl_${task.id}"
                                   onchange="updateBulkTask(${task.id}, 'external_url', this.value)"
                                   placeholder="Or enter a custom URL...">
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(taskCard);
    });

    // Initialize common links for all tasks after rendering
    bulkTasks.forEach(task => {
        initializeBulkCommonLinks(task.id);
    });
}

function handleBulkResourceChange(taskId, resourceId) {
    updateBulkTask(taskId, 'resource_id', resourceId);
    
    if (resourceId) {
        const resource = availableResources.find(r => r.id == resourceId);
        if (resource) {
            // Auto-fill task title and description based on resource
            updateBulkTask(taskId, 'title', resource.resource_title);
            updateBulkTask(taskId, 'description', resource.description || `Complete task using ${resource.resource_title}`);
            
            // Set task type based on resource category
            const categoryToType = {
                'mathematics': 'mathematics',
                'english': 'english',
                'Design': 'Designüé®',
                'science': 'science',
                'Coding': 'Coding',
                'Video': 'Video',
                'history': 'history',
                'social_studies': 'history',
                'basic_science': 'science'
            };
            const taskType = categoryToType[resource.subject_category] || 'mathematics';
            updateBulkTask(taskId, 'task_type', taskType);
            
            // Re-render to show the updated values
            renderBulkTasks();
            updateBulkSummary();
        }
    } else {
        // Clear fields when no resource is selected
        updateBulkTask(taskId, 'title', '');
        updateBulkTask(taskId, 'description', '');
        renderBulkTasks();
        updateBulkSummary();
    }
}

function updateBulkTask(taskId, field, value) {
    const task = bulkTasks.find(t => t.id === taskId);
    if (task) {
        task[field] = value;
        updateBulkSummary();
    }
}

function updateBulkTaskBuilder() {
    const builder = document.getElementById('bulkTaskBuilder');
    builder.classList.toggle('has-tasks', bulkTasks.length > 0);
}

function renderBulkStudents() {
    const grid = document.getElementById('bulkStudentGrid');
    grid.innerHTML = '';
    
    assignedStudents.forEach(student => {
        const studentCard = document.createElement('div');
        studentCard.className = `bulk-student-card ${selectedBulkStudents.has(student.id) ? 'selected' : ''}`;
        studentCard.innerHTML = `
            <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                <input type="checkbox" ${selectedBulkStudents.has(student.id) ? 'checked' : ''} 
                       onchange="toggleBulkStudent(${student.id})" style="margin-right: 0.75rem;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${student.name}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-600);">Grade ${student.grade_level} ‚Ä¢ ${student.school_name}</div>
                </div>
            </label>
        `;
        grid.appendChild(studentCard);
    });
}

function toggleBulkStudent(studentId) {
    if (selectedBulkStudents.has(studentId)) {
        selectedBulkStudents.delete(studentId);
    } else {
        selectedBulkStudents.add(studentId);
    }
    renderBulkStudents();
    updateBulkSummary();
}

function selectAllBulkStudents() {
    assignedStudents.forEach(student => selectedBulkStudents.add(student.id));
    renderBulkStudents();
    updateBulkSummary();
}

function deselectAllBulkStudents() {
    selectedBulkStudents.clear();
    renderBulkStudents();
    updateBulkSummary();
}

function selectByGradeBulk() {
    const grade = prompt("Enter grade level:");
    if (grade) {
        assignedStudents.forEach(student => {
            if (student.grade_level === grade) {
                selectedBulkStudents.add(student.id);
            }
        });
        renderBulkStudents();
        updateBulkSummary();
    }
}

// Bulk Task Link Configuration Functions
function switchBulkLinkType(taskId, type) {
    const task = bulkTasks.find(t => t.id === taskId);
    if (task) {
        task.link_type = type;
        renderBulkTasks();
    }
}

function getCommonLinksHTML(taskId) {
    return ''; // Placeholder, will be populated by initializeBulkCommonLinks
}

function initializeBulkCommonLinks(taskId) {
    const commonLinks = [
        {
            name: 'Khan Academy Math',
            url: 'https://www.khanacademy.org/math',
            description: 'Math lessons and exercises'
        },
        {
            name: 'Coursera',
            url: 'https://www.coursera.org',
            description: 'Online courses'
        },
        {
            name: 'edX',
            url: 'https://www.edx.org',
            description: 'University-level courses'
        },
        {
            name: 'Duolingo',
            url: 'https://www.duolingo.com',
            description: 'Language learning'
        },
        {
            name: 'Code.org',
            url: 'https://code.org',
            description: 'Coding tutorials'
        },
        {
            name: 'TED-Ed',
            url: 'https://ed.ted.com',
            description: 'Educational videos'
        },
        {
            name: 'NASA Education',
            url: 'https://www.nasa.gov/stem',
            description: 'STEM resources'
        },
        {
            name: 'National Geographic Kids',
            url: 'https://kids.nationalgeographic.com',
            description: 'Science and nature'
        }
    ];

    const grid = document.getElementById(`bulkCommonLinksGrid_${taskId}`);
    if (!grid) return;

    grid.innerHTML = '';

    commonLinks.forEach(link => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'common-link-btn';
        btn.onclick = () => selectBulkCommonLink(taskId, btn, link.url);
        btn.innerHTML = `
            <div class="common-link-name">${link.name}</div>
            <div class="common-link-url">${link.url}</div>
            <div class="common-link-description">${link.description}</div>
        `;
        grid.appendChild(btn);
    });
}

function selectBulkCommonLink(taskId, button, url) {
    const wasSelected = button.classList.contains('selected');

    // Clear all selections in this task's grid
    const grid = document.getElementById(`bulkCommonLinksGrid_${taskId}`);
    if (grid) {
        grid.querySelectorAll('.common-link-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
    }

    // Clear custom URL input
    const customInput = document.getElementById(`bulkCustomCommonUrl_${taskId}`);
    if (customInput) customInput.value = '';

    // Toggle selection
    if (!wasSelected) {
        button.classList.add('selected');
        updateBulkTask(taskId, 'external_url', url);
    } else {
        updateBulkTask(taskId, 'external_url', '');
    }
}

function validateBulkExternalUrl(taskId) {
    const input = document.getElementById(`bulkExternalTaskUrl_${taskId}`);
    const validator = document.getElementById(`bulkUrlValidator_${taskId}`);
    const preview = document.getElementById(`bulkExternalLinkPreview_${taskId}`);
    const previewUrl = document.getElementById(`bulkPreviewUrl_${taskId}`);

    if (!input || !validator) return;

    const url = input.value.trim();

    if (!url) {
        validator.className = 'url-validator empty';
        validator.innerHTML = '<span>üí° Enter any valid URL (must start with http:// or https://)</span>';
        if (preview) preview.classList.remove('show');
        return;
    }

    try {
        const urlObj = new URL(url);
        if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
            validator.className = 'url-validator valid';
            validator.innerHTML = '<span>‚úÖ Valid URL</span>';
            if (previewUrl) previewUrl.textContent = url;
            if (preview) preview.classList.add('show');
        } else {
            throw new Error('Invalid protocol');
        }
    } catch (error) {
        validator.className = 'url-validator invalid';
        validator.innerHTML = '<span>‚ùå Please enter a valid URL starting with http:// or https://</span>';
        if (preview) preview.classList.remove('show');
    }
}

function getBulkTaskLinkConfig(taskId) {
    const task = bulkTasks.find(t => t.id === taskId);
    if (!task) return null;

    let config = { type: task.link_type };

    switch (task.link_type) {
        case 'internal':
            const taskFile = task.task_file?.trim();
            if (taskFile) {
                config.task_file = taskFile;
                config.external_url = `https://deciphersacad.online//${taskFile}`;
            }
            break;

        case 'external':
            const externalUrl = task.external_url?.trim();
            if (externalUrl) {
                try {
                    new URL(externalUrl); // Validate URL
                    config.external_url = externalUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;

        case 'common':
            const commonUrl = task.external_url?.trim();
            if (commonUrl) {
                try {
                    new URL(commonUrl); // Validate URL
                    config.external_url = commonUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;
    }

    return config;
}

function updateBulkSummary() {
    const summary = document.getElementById('bulkAssignmentSummary');
    const assignBtn = document.getElementById('bulkAssignBtn');
    
    const validTasks = bulkTasks.filter(t => t.title && t.task_type);
    const selectedStudentCount = selectedBulkStudents.size;
    const totalAssignments = validTasks.length * selectedStudentCount;
    
    if (validTasks.length === 0 || selectedStudentCount === 0) {
        summary.style.display = 'none';
        return;
    }
    
    document.getElementById('bulkTotalTasks').textContent = validTasks.length;
    document.getElementById('bulkTotalStudents').textContent = selectedStudentCount;
    document.getElementById('bulkTotalAssignments').textContent = totalAssignments;
    
    summary.style.display = 'block';
    assignBtn.disabled = totalAssignments === 0;
}

async function performBulkAssignment() {
    const validTasks = bulkTasks.filter(t => t.title && t.task_type);
    const selectedStudentIds = Array.from(selectedBulkStudents);
    
    if (validTasks.length === 0) {
        showNotification('Please create at least one valid task', 'error');
        return;
    }
    
    if (selectedStudentIds.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }
    
    const totalAssignments = validTasks.length * selectedStudentIds.length;
    const confirmMessage = `This will create ${totalAssignments} task assignments. Proceed?`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    showLoading();
    try {
        const bulkData = {
            tasks: validTasks.map(task => {
                const resource = availableResources.find(r => r.id == task.resource_id);
                let taskData = {};

                // Check for link configuration first
                const linkConfig = getBulkTaskLinkConfig(task.id);

                if (linkConfig && (linkConfig.external_url || linkConfig.task_file)) {
                    // Use link configuration from the bulk task
                    if (linkConfig.task_file) {
                        taskData.task_file = linkConfig.task_file;
                    }
                    if (linkConfig.external_url) {
                        taskData.external_url = linkConfig.external_url;
                    }
                    taskData.link_type = linkConfig.type;
                    taskData.is_external = true;
                } else if (resource) {
                    // Fallback to resource information if no link config
                    taskData.resource_id = task.resource_id;

                    if (resource.resource_type === 'internal_file' && resource.task_file) {
                        taskData.external_url = `https://deciphersacad.online//${resource.task_file}`;
                        taskData.task_file = resource.task_file;
                        taskData.link_type = 'internal';
                    } else if (resource.resource_url) {
                        taskData.external_url = resource.resource_url;
                        taskData.link_type = 'external';
                    }
                    taskData.is_external = true;
                }

                return {
                    task_type: task.task_type,
                    task_title: task.title,
                    task_description: task.description,
                    points_reward: task.points_reward || 0,
                    acard_credit: task.acard_credit || 0,
                    due_date: task.due_date || null,
                    task_data: taskData
                };
            }),
            student_ids: selectedStudentIds
        };
        
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/bulk-assign-tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(bulkData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification(`Successfully created ${result.total_assignments} task assignments!`);
            
            // Reset bulk form
            bulkTasks = [];
            selectedBulkStudents.clear();
            bulkTaskCounter = 0;
            addBulkTask(); // Start with one new task
            renderBulkStudents();
            updateBulkSummary();
            loadDashboardStats(); // Refresh stats
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to assign tasks');
        }
    } catch (error) {
        console.error('Error in bulk assignment:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function viewStudentTasks(studentId) {
    const student = assignedStudents.find(s => s.id === studentId);
    if (!student) {
        showNotification('Student not found', 'error');
        return;
    }
    
    // For now, just show a notification. This could be enhanced to show a modal with student tasks
    showNotification(`Viewing tasks for ${student.name}. Feature coming soon!`, 'info');
}

async function makeAuthenticatedRequest(url, options = {}) {
    const token = getAdminToken();
    if (!token) {
        throw new Error('No authentication token found');
    }

    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...options.headers
    };

    const response = await fetch(url, {
        ...options,
        headers
    });

    if (response.status === 401) {
        // Token expired or invalid
        localStorage.removeItem('admin_token');
        sessionStorage.removeItem('admin_token');
        window.location.href = '/admin-login';
        throw new Error('Authentication expired');
    }

    return response;
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        // Clear admin data
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        sessionStorage.removeItem('admin_token');
        sessionStorage.setItem('admin_just_logged_out', 'true');
        
        // Clear cookies
        document.cookie = 'admin_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        
        // Redirect to login
        window.location.href = '/admin-login';
    }
}

// =========================================
// Coach Management Functions
// =========================================

async function loadCoachesPage() {
    showLoading();
    try {
        // Load coach stats
        await loadCoachAnalytics();

        // Load coaches list
        await loadCoaches();
    } catch (error) {
        console.error('Error loading coaches page:', error);
        showNotification('Failed to load coaches page', 'error');
    } finally {
        hideLoading();
    }
}

async function loadCoachAnalytics() {
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/coach/admin/coaches/analytics/overview'
        );

        const data = await response.json();

        if (response.ok && data.success) {
            document.getElementById('totalCoaches').textContent = data.statistics.total_coaches || 0;
            document.getElementById('totalCourses').textContent = data.statistics.total_courses || 0;
            document.getElementById('totalEnrolledStudents').textContent = data.statistics.total_students || 0;
            document.getElementById('totalStorage').textContent = `${data.statistics.total_storage_gb.toFixed(2)} GB`;
        }
    } catch (error) {
        console.error('Error loading coach analytics:', error);
    }
}

async function loadCoaches() {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/coach/admin/coaches/list'
        );

        const data = await response.json();

        if (response.ok && data.success) {
            renderCoachesTable(data.coaches);
        } else {
            throw new Error(data.error || 'Failed to load coaches');
        }
    } catch (error) {
        console.error('Error loading coaches:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function renderCoachesTable(coaches) {
    const tbody = document.getElementById('coachesTableBody');

    if (!coaches || coaches.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üë®‚Äçüè´</div>
                    <h3>No coaches yet</h3>
                    <p>Create your first coach to get started!</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = coaches.map(coach => {
        const statusColors = {
            'active': 'background: #10b981; color: white;',
            'inactive': 'background: #6b7280; color: white;',
            'suspended': 'background: #ef4444; color: white;',
            'pending': 'background: #f59e0b; color: white;'
        };

        return `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                            ${coach.full_name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight: 600;">${coach.full_name}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">${coach.username}</div>
                        </div>
                    </div>
                </td>
                <td>${coach.email}</td>
                <td>
                    <span style="padding: 0.25rem 0.5rem; background: var(--gray-100); border-radius: 0.25rem; font-size: 0.875rem;">
                        ${coach.specialization || 'N/A'}
                    </span>
                </td>
                <td style="text-align: center;">${coach.total_courses || 0}</td>
                <td style="text-align: center;">${coach.total_students || 0}</td>
                <td style="text-align: center;">${coach.storage_used_gb || 0} / ${coach.storage_quota_gb || 50} GB</td>
                <td>
                    <span style="padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; ${statusColors[coach.account_status]}">
                        ${coach.account_status.toUpperCase()}
                    </span>
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="viewCoachDetails(${coach.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--primary-color); color: white;">
                            üëÅÔ∏è View
                        </button>
                        ${coach.account_status === 'active' ?
                            `<button class="btn" onclick="suspendCoach(${coach.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--warning-color); color: white;">
                                ‚è∏Ô∏è Suspend
                            </button>` :
                            `<button class="btn" onclick="activateCoach(${coach.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--secondary-color); color: white;">
                                ‚úÖ Activate
                            </button>`
                        }
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function openCreateCoachModal() {
    const modal = document.getElementById('createCoachModal');
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
    }
}

function closeCreateCoachModal() {
    const modal = document.getElementById('createCoachModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        document.getElementById('createCoachForm').reset();
    }
}

// Handle create coach form submission
document.addEventListener('DOMContentLoaded', function() {
    const createCoachForm = document.getElementById('createCoachForm');
    if (createCoachForm) {
        createCoachForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const coachData = {
                full_name: document.getElementById('coachFullName').value.trim(),
                email: document.getElementById('coachEmail').value.trim(),
                username: document.getElementById('coachUsername').value.trim(),
                password: document.getElementById('coachPassword').value,
                phone_number: document.getElementById('coachPhone').value.trim() || null,
                bio: document.getElementById('coachBio').value.trim() || null,
                specialization: document.getElementById('coachSpecialization').value,
                years_experience: parseInt(document.getElementById('coachExperience').value) || 0,
                professional_title: document.getElementById('coachTitle').value.trim() || null,
                linkedin_url: document.getElementById('coachLinkedIn').value.trim() || null,
                portfolio_url: document.getElementById('coachPortfolio').value.trim() || null,
                max_courses_allowed: parseInt(document.getElementById('coachMaxCourses').value) || 10,
                storage_quota_gb: parseFloat(document.getElementById('coachStorageQuota').value) || 50,
                can_upload_video: document.getElementById('coachCanUploadVideo').checked,
                can_upload_pdf: document.getElementById('coachCanUploadPDF').checked,
                can_create_access_codes: document.getElementById('coachCanCreateCodes').checked,
                can_assign_tasks: document.getElementById('coachCanAssignTasks').checked
            };

            // Validation
            if (!coachData.full_name || !coachData.email || !coachData.username || !coachData.password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (!coachData.specialization) {
                showNotification('Please select a specialization', 'error');
                return;
            }

            if (coachData.password.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }

            showLoading();

            try {
                const response = await TokenManager.makeAuthenticatedRequest(
                    'https://seashell-app-onfk3.ondigitalocean.app/api/coach/admin/coaches/create',
                    {
                        method: 'POST',
                        body: JSON.stringify(coachData)
                    }
                );

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Coach ${result.coach.full_name} created successfully!`);
                    closeCreateCoachModal();
                    loadCoaches(); // Refresh coaches list
                } else {
                    throw new Error(result.error || 'Failed to create coach');
                }
            } catch (error) {
                console.error('‚ùå Error creating coach:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoading();
            }
        });
    }
});

async function suspendCoach(coachId) {
    if (!confirm('Are you sure you want to suspend this coach? They will not be able to login.')) {
        return;
    }

    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/coach/admin/coaches/${coachId}/suspend`,
            {
                method: 'POST'
            }
        );

        const data = await response.json();

        if (response.ok && data.success) {
            showNotification('Coach suspended successfully');
            loadCoaches(); // Refresh list
        } else {
            throw new Error(data.error || 'Failed to suspend coach');
        }
    } catch (error) {
        console.error('Error suspending coach:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function activateCoach(coachId) {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/coach/admin/coaches/${coachId}/activate`,
            {
                method: 'POST'
            }
        );

        const data = await response.json();

        if (response.ok && data.success) {
            showNotification('Coach activated successfully');
            loadCoaches(); // Refresh list
        } else {
            throw new Error(data.error || 'Failed to activate coach');
        }
    } catch (error) {
        console.error('Error activating coach:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function viewCoachDetails(coachId) {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/coach/admin/coaches/${coachId}`
        );

        const data = await response.json();

        if (response.ok && data.success) {
            // Display coach details in a modal or navigate to details page
            alert(`Coach Details:\n\nName: ${data.coach.full_name}\nEmail: ${data.coach.email}\nCourses: ${data.coach.total_courses}\nStudents: ${data.coach.total_students}`);
        } else {
            throw new Error(data.error || 'Failed to load coach details');
        }
    } catch (error) {
        console.error('Error loading coach details:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Add modal event listeners
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
    }
    
    if (e.target.hasAttribute('data-modal')) {
        const modalId = e.target.getAttribute('data-modal');
        closeModal(modalId);
    }
});

// Add keyboard support for modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

// Initialize page data loading
loadAdminData();

console.log('‚úÖ All utility functions loaded for grade admin dashboard');

// =====================================================
// SUBJECT ASSIGNMENT MANAGEMENT
// =====================================================

let allSubjects = [];
let currentSubjectMode = 'single';

// Load all subjects from backend
async function loadSubjects() {
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/subjects'
        );
        const data = await response.json();

        if (response.ok && data.subjects) {
            allSubjects = data.subjects;
            renderSubjectCheckboxes();
            renderBulkSubjectCheckboxes();
        }
    } catch (error) {
        console.error('Error loading subjects:', error);
        showNotification('Failed to load subjects', 'error');
    }
}

// Render subject checkboxes for single mode
function renderSubjectCheckboxes() {
    const container = document.getElementById('subjectCheckboxGrid');
    if (!container) return;

    container.innerHTML = allSubjects.map(subject => `
        <label class="subject-checkbox-item" data-subject-id="${subject.id}">
            <input type="checkbox" name="subject_ids" value="${subject.id}"
                   onchange="toggleSubjectCheckbox(this)">
            <div>
                <div style="font-weight: 600;">${subject.name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-600);">${subject.description || ''}</div>
            </div>
        </label>
    `).join('');
}

// Render subject checkboxes for bulk mode
function renderBulkSubjectCheckboxes() {
    const container = document.getElementById('bulkSubjectCheckboxGrid');
    if (!container) return;

    container.innerHTML = allSubjects.map(subject => `
        <label class="subject-checkbox-item" data-subject-id="${subject.id}">
            <input type="checkbox" name="bulk_subject_ids" value="${subject.id}"
                   onchange="toggleSubjectCheckbox(this)">
            <div>
                <div style="font-weight: 600;">${subject.name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-600);">${subject.description || ''}</div>
            </div>
        </label>
    `).join('');
}

// Toggle subject checkbox visual state
function toggleSubjectCheckbox(checkbox) {
    const label = checkbox.closest('.subject-checkbox-item');
    if (checkbox.checked) {
        label.classList.add('checked');
    } else {
        label.classList.remove('checked');
    }
}

// Switch between single and bulk subject assignment modes
function switchSubjectMode(mode) {
    currentSubjectMode = mode;
    const singleBtn = document.getElementById('subjectSingleModeBtn');
    const bulkBtn = document.getElementById('subjectBulkModeBtn');
    const singleMode = document.getElementById('singleStudentSubjectMode');
    const bulkMode = document.getElementById('bulkStudentSubjectMode');

    if (mode === 'single') {
        singleBtn.classList.add('btn-primary');
        singleBtn.classList.remove('btn-secondary');
        bulkBtn.classList.remove('btn-primary');
        bulkBtn.classList.add('btn-secondary');
        singleMode.style.display = 'block';
        bulkMode.style.display = 'none';
    } else {
        bulkBtn.classList.add('btn-primary');
        bulkBtn.classList.remove('btn-secondary');
        singleBtn.classList.remove('btn-primary');
        singleBtn.classList.add('btn-secondary');
        bulkMode.style.display = 'block';
        singleMode.style.display = 'none';
        loadBulkSubjectStudents();
    }
}

// Load students for bulk subject assignment
async function loadBulkSubjectStudents() {
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/students?per_page=1000'
        );
        const data = await response.json();

        if (response.ok && data.students) {
            const container = document.getElementById('bulkSubjectStudentCheckboxGrid');
            container.innerHTML = data.students.map(student => `
                <label class="student-checkbox-item" data-student-id="${student.id}">
                    <input type="checkbox" name="bulk_student_ids" value="${student.id}"
                           onchange="toggleStudentCheckbox(this); updateSelectedStudentCount()">
                    <span>${student.name} (${student.email})</span>
                </label>
            `).join('');
            updateSelectedStudentCount();
        }
    } catch (error) {
        console.error('Error loading students:', error);
        showNotification('Failed to load students', 'error');
    }
}

// Toggle student checkbox visual state
function toggleStudentCheckbox(checkbox) {
    const label = checkbox.closest('.student-checkbox-item');
    if (checkbox.checked) {
        label.classList.add('checked');
    } else {
        label.classList.remove('checked');
    }
}

// Update selected student count
function updateSelectedStudentCount() {
    const checkboxes = document.querySelectorAll('input[name="bulk_student_ids"]:checked');
    const countEl = document.getElementById('selectedSubjectStudentCount');
    if (countEl) {
        countEl.textContent = `${checkboxes.length} student(s) selected`;
    }
}

// Select all students
function selectAllSubjectStudents() {
    document.querySelectorAll('input[name="bulk_student_ids"]').forEach(cb => {
        cb.checked = true;
        toggleStudentCheckbox(cb);
    });
    updateSelectedStudentCount();
}

// Clear all student selections
function clearAllSubjectStudents() {
    document.querySelectorAll('input[name="bulk_student_ids"]').forEach(cb => {
        cb.checked = false;
        toggleStudentCheckbox(cb);
    });
    updateSelectedStudentCount();
}

// Load current subjects for a student
async function loadStudentCurrentSubjects() {
    const studentSelect = document.getElementById('subjectStudentSelect');
    const studentId = studentSelect.value;

    const panel = document.getElementById('currentSubjectsPanel');
    const listContainer = document.getElementById('currentSubjectsList');

    if (!studentId) {
        panel.style.display = 'none';
        return;
    }

    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/subjects`
        );
        const data = await response.json();

        if (response.ok && data.subjects) {
            if (data.subjects.length > 0) {
                panel.style.display = 'block';
                listContainer.innerHTML = data.subjects.map(ss => `
                    <span class="subject-chip" style="background-color: ${ss.icon_color};">
                        ${ss.display_name}
                        <span class="remove-btn" onclick="removeSubject(${studentId}, ${ss.subject_id})">&times;</span>
                    </span>
                `).join('');
            } else {
                panel.style.display = 'block';
                listContainer.innerHTML = '<p style="color: var(--gray-500);">No subjects assigned yet</p>';
            }
        }
    } catch (error) {
        console.error('Error loading student subjects:', error);
    }
}

// Remove a subject from a student
async function removeSubject(studentId, subjectId) {
    if (!confirm('Are you sure you want to remove this subject?')) return;

    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/subjects/${subjectId}`,
            { method: 'DELETE' }
        );

        if (response.ok) {
            showNotification('Subject removed successfully', 'success');
            loadStudentCurrentSubjects();
        } else {
            throw new Error('Failed to remove subject');
        }
    } catch (error) {
        console.error('Error removing subject:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Handle single subject assignment form submission
document.getElementById('assignSubjectForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const studentId = document.getElementById('subjectStudentSelect').value;
    const subjectCheckboxes = document.querySelectorAll('input[name="subject_ids"]:checked');
    const subjectIds = Array.from(subjectCheckboxes).map(cb => parseInt(cb.value));

    if (!studentId) {
        showNotification('Please select a student', 'error');
        return;
    }

    if (subjectIds.length === 0) {
        showNotification('Please select at least one subject', 'error');
        return;
    }

    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/${studentId}/subjects/assign`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subject_ids: subjectIds })
            }
        );

        const data = await response.json();

        if (response.ok) {
            showNotification(`Successfully assigned ${data.assigned?.length || 0} subject(s)`, 'success');
            clearSubjectForm();
            loadStudentCurrentSubjects();
        } else {
            throw new Error(data.error || 'Failed to assign subjects');
        }
    } catch (error) {
        console.error('Error assigning subjects:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
});

// Handle bulk subject assignment form submission
document.getElementById('bulkAssignSubjectForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const studentCheckboxes = document.querySelectorAll('input[name="bulk_student_ids"]:checked');
    const studentIds = Array.from(studentCheckboxes).map(cb => parseInt(cb.value));

    const subjectCheckboxes = document.querySelectorAll('input[name="bulk_subject_ids"]:checked');
    const subjectIds = Array.from(subjectCheckboxes).map(cb => parseInt(cb.value));

    if (studentIds.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }

    if (subjectIds.length === 0) {
        showNotification('Please select at least one subject', 'error');
        return;
    }

    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/students/subjects/bulk-assign',
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_ids: studentIds,
                    subject_ids: subjectIds
                })
            }
        );

        const data = await response.json();

        if (response.ok) {
            const resultsDiv = document.getElementById('subjectAssignmentResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="padding: 1.5rem; background: white; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Bulk Assignment Results</h3>
                    <p><strong>Total Students:</strong> ${data.total_students}</p>
                    <p><strong>Successful Assignments:</strong> ${data.successful_assignments}</p>
                    <p><strong>Failed Assignments:</strong> ${data.failed_assignments}</p>
                    ${data.details && data.details.length > 0 ? `
                        <div style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                            ${data.details.map(d => `
                                <div style="padding: 0.5rem; margin: 0.5rem 0; background: ${
                                    d.status === 'success' ? '#dcfce7' : '#fee2e2'
                                }; border-radius: 4px;">
                                    <strong>${d.student_name}</strong>: ${d.status}
                                    ${d.subjects ? ` - ${d.subjects.join(', ')}` : ''}
                                    ${d.message ? ` - ${d.message}` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            showNotification('Bulk assignment completed', 'success');
            clearBulkSubjectForm();
        } else {
            throw new Error(data.error || 'Failed to bulk assign subjects');
        }
    } catch (error) {
        console.error('Error bulk assigning subjects:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
});

// Clear single subject form
function clearSubjectForm() {
    document.getElementById('subjectStudentSelect').value = '';
    document.querySelectorAll('input[name="subject_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSubjectCheckbox(cb);
    });
    document.getElementById('currentSubjectsPanel').style.display = 'none';
}

// Clear bulk subject form
function clearBulkSubjectForm() {
    clearAllSubjectStudents();
    document.querySelectorAll('input[name="bulk_subject_ids"]').forEach(cb => {
        cb.checked = false;
        toggleSubjectCheckbox(cb);
    });
    document.getElementById('subjectAssignmentResults').style.display = 'none';
}

// Initialize subject assignment when navigating to the page
const originalShowPage = window.showPage;
window.showPage = function(page) {
    if (typeof originalShowPage === 'function') {
        originalShowPage(page);
    }

    if (page === 'subject-assignment') {
        loadSubjects();
        // Load students for single mode
        loadStudentsIntoSelect('subjectStudentSelect');
    }
};

console.log('‚úÖ Subject assignment functions loaded');
    </script>
    <script>
      // =====================================================
// SOCIAL MEDIA MANAGEMENT - COMPLETE FIXED VERSION
// =====================================================

let socialMediaStudents = [];
let socialMediaTasks = [];
let currentSkillCategory = null;

// ==================== INITIALIZATION ====================

function initializeSocialMediaManagement() {
    console.log('üöÄ Initializing Social Media Management...');
    
    // Setup event listeners FIRST
    setupSocialMediaEventListeners();
    
    // Setup skill category handler
    setupSkillCategoryHandler();
    
    // Setup student selection buttons
    setupStudentSelectionButtons();
    
    // Then load initial data
    loadSocialMediaStudents();
    loadSocialMediaAssignments();
    
    console.log('‚úÖ Social Media Management initialized successfully!');
}

// ==================== EVENT LISTENERS ====================

function setupSocialMediaEventListeners() {
    console.log('üìù Setting up social media event listeners...');
    
    // Task assignment form - CRITICAL FIX
    const smTaskForm = document.getElementById('assignSocialMediaTaskForm');
    if (smTaskForm) {
        // Remove any existing listeners by cloning
        const newForm = smTaskForm.cloneNode(true);
        smTaskForm.parentNode.replaceChild(newForm, smTaskForm);
        
        // Add fresh listener
        newForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üéØ Social media form submitted!');
            await handleAssignSocialMediaTask(e);
        });
        console.log('‚úÖ Social media form handler attached');
    } else {
        console.error('‚ùå Social media form not found');
    }

    // Student select change
    const studentSelect = document.getElementById('smStudentSelect');
    if (studentSelect) {
        studentSelect.addEventListener('change', updateSelectedCount);
        console.log('‚úÖ Student select change handler attached');
    }

    // Refresh assignments
    const refreshAssignments = document.getElementById('smRefreshAssignments');
    if (refreshAssignments) {
        refreshAssignments.onclick = (e) => {
            e.preventDefault();
            loadSocialMediaAssignments();
        };
        console.log('‚úÖ Refresh assignments button configured');
    }

    // Status filter
    const statusFilter = document.getElementById('smStatusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', filterSocialMediaAssignments);
        console.log('‚úÖ Status filter configured');
    }

    // Students search
    const studentsSearch = document.getElementById('smStudentsSearch');
    if (studentsSearch) {
        studentsSearch.addEventListener('input', filterSocialMediaStudents);
        console.log('‚úÖ Students search configured');
    }
    
    console.log('‚úÖ All social media event listeners configured successfully!');
}

// ==================== SKILL CATEGORY HANDLING ====================

function setupSkillCategoryHandler() {
    const skillCategorySelect = document.getElementById('smSkillCategory');
    if (!skillCategorySelect) {
        console.error('Skill category select not found');
        return;
    }
    
    skillCategorySelect.addEventListener('change', async function() {
        const selectedCategory = this.value;
        console.log('üì± Skill category selected:', selectedCategory);
        
        if (!selectedCategory) {
            resetStudentSection();
            return;
        }
        
        currentSkillCategory = selectedCategory;
        updateSectionTitle(selectedCategory);
        await loadStudentsByCategory(selectedCategory);
    });
    
    console.log('‚úÖ Skill category handler configured');
}

function updateSectionTitle(category) {
    const sectionTitleElement = document.querySelector('label[for="smStudentSelect"]');
    if (!sectionTitleElement) {
        console.warn('Section title element not found');
        return;
    }
    
    const categoryNames = {
        'social-media': 'Social Media Management',
        'video-editing': 'Video Editing',
        'graphics-design': 'Graphics Design',
        'coding': 'Coding'
    };
    
    const displayName = categoryNames[category] || category;
    sectionTitleElement.textContent = `Select ${displayName} Students`;
    console.log(`üìù Section title updated to: Select ${displayName} Students`);
}

function resetStudentSection() {
    const sectionTitleElement = document.querySelector('label[for="smStudentSelect"]');
    if (sectionTitleElement) {
        sectionTitleElement.textContent = 'Select Social Media Students';
    }
    
    const studentSelect = document.getElementById('smStudentSelect');
    if (studentSelect) {
        studentSelect.innerHTML = '<option value="" disabled>Select a skill category first</option>';
    }
    
    updateSelectedCount();
    currentSkillCategory = null;
}

// ==================== STUDENT SELECTION BUTTONS ====================

function setupStudentSelectionButtons() {
    const selectAllBtn = document.getElementById('smSelectAllBtn');
    const deselectAllBtn = document.getElementById('smDeselectAllBtn');
    const refreshBtn = document.getElementById('smRefreshStudentsBtn');
    
    if (selectAllBtn) {
        selectAllBtn.onclick = (e) => {
            e.preventDefault();
            selectAllStudentsInCategory();
        };
    }
    
    if (deselectAllBtn) {
        deselectAllBtn.onclick = (e) => {
            e.preventDefault();
            deselectAllStudentsInCategory();
        };
    }
    
    if (refreshBtn) {
        refreshBtn.onclick = async (e) => {
            e.preventDefault();
            if (currentSkillCategory) {
                await loadStudentsByCategory(currentSkillCategory);
            } else {
                showNotification('‚ö†Ô∏è Please select a skill category first', 'info');
            }
        };
    }
}

function selectAllStudentsInCategory() {
    const studentSelect = document.getElementById('smStudentSelect');
    if (!studentSelect) return;
    
    if (!currentSkillCategory) {
        showNotification('‚ö†Ô∏è Please select a skill category first', 'info');
        return;
    }
    
    const options = studentSelect.options;
    for (let i = 0; i < options.length; i++) {
        if (!options[i].disabled) {
            options[i].selected = true;
        }
    }
    
    updateSelectedCount();
}

function deselectAllStudentsInCategory() {
    const studentSelect = document.getElementById('smStudentSelect');
    if (!studentSelect) return;
    
    const options = studentSelect.options;
    for (let i = 0; i < options.length; i++) {
        options[i].selected = false;
    }
    
    updateSelectedCount();
}

// ==================== LOAD STUDENTS ====================

async function loadSocialMediaStudents() {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/students'
        );

        if (response.ok) {
            const data = await response.json();
            socialMediaStudents = data.students || [];
            renderSMStudentsTable();
            console.log(`‚úÖ Loaded ${socialMediaStudents.length} social media students`);
        } else {
            throw new Error('Failed to load social media students');
        }
    } catch (error) {
        console.error('Error loading social media students:', error);
        showNotification('Failed to load social media students', 'error');
    } finally {
        hideLoading();
    }
}

async function loadStudentsByCategory(category) {
    const studentSelect = document.getElementById('smStudentSelect');
    const selectedCountDiv = document.getElementById('smSelectedCount');
    
    if (!studentSelect) {
        console.error('‚ùå Student select element not found');
        return;
    }
    
    studentSelect.disabled = true;
    studentSelect.innerHTML = '<option value="">Loading students...</option>';
    if (selectedCountDiv) {
        selectedCountDiv.textContent = 'Loading...';
    }
    
    try {
        console.log(`üîÑ Loading students for category: ${category}`);
        
        const response = await TokenManager.makeAuthenticatedRequest(
            `https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/students/by-category?category=${category}`
        );
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì• Received data:', data);
        
        if (data.success && data.students) {
            if (data.students.length === 0) {
                showEmptyStudentState(category);
            } else {
                populateSocialMediaStudentSelect(data.students, category);
                showNotification(`‚úÖ Loaded ${data.total_count} ${getCategoryDisplayName(category)} students`, 'success');
            }
        } else {
            throw new Error(data.error || 'No students data received');
        }
        
    } catch (error) {
        console.error('‚ùå Error loading students:', error);
        showEmptyStudentState(category);
        showNotification(`Failed to load students: ${error.message}`, 'error');
    } finally {
        studentSelect.disabled = false;
    }
}

function populateSocialMediaStudentSelect(students, category) {
    const studentSelect = document.getElementById('smStudentSelect');
    if (!studentSelect) return;

    studentSelect.innerHTML = '';

    if (!students || students.length === 0) {
        showEmptyStudentState(category);
        return;
    }

    students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.full_name} (${student.username}) - ${student.skill_level}`;

        if (!student.is_active) {
            option.textContent += ' [INACTIVE]';
            option.style.color = 'var(--gray-400)';
            option.disabled = true;
        }

        studentSelect.appendChild(option);
    });

    console.log(`‚úÖ Populated ${students.length} students`);
    updateSelectedCount();
}

function showEmptyStudentState(category) {
    const studentSelect = document.getElementById('smStudentSelect');
    if (!studentSelect) return;
    
    const categoryDisplayName = getCategoryDisplayName(category);
    studentSelect.innerHTML = `<option value="" disabled selected>No ${categoryDisplayName} students found</option>`;
    updateSelectedCount();
}

function getCategoryDisplayName(category) {
    const categoryNames = {
        'social-media': 'Social Media Management',
        'video-editing': 'Video Editing',
        'graphics-design': 'Graphics Design',
        'coding': 'Coding'
    };
    return categoryNames[category] || category;
}

function updateSelectedCount() {
    const studentSelect = document.getElementById('smStudentSelect');
    const countDisplay = document.getElementById('smSelectedCount');
    
    if (!studentSelect || !countDisplay) return;
    
    const selectedCount = Array.from(studentSelect.selectedOptions || []).length;
    const activeCount = Array.from(studentSelect.options).filter(opt => !opt.disabled).length;
    
    countDisplay.textContent = `${selectedCount} of ${activeCount} students selected`;
    
    if (selectedCount > 0) {
        countDisplay.style.color = 'var(--primary-color)';
        countDisplay.style.fontWeight = '600';
    } else {
        countDisplay.style.color = 'var(--gray-600)';
        countDisplay.style.fontWeight = '500';
    }
}

// ==================== TASK ASSIGNMENT - FIXED ====================

async function handleAssignSocialMediaTask(e) {
    if (e) e.preventDefault();
    console.log('üöÄ Task assignment initiated');
    
    // Get selected category
    const selectedCategory = document.getElementById('smSkillCategory')?.value;
    
    if (!selectedCategory) {
        showNotification('‚ö†Ô∏è Please select a skill category first', 'error');
        return;
    }
    
    // Verify category matches loaded students
    if (selectedCategory !== currentSkillCategory) {
        showNotification('‚ö†Ô∏è Skill category changed. Please refresh the students list.', 'error');
        document.getElementById('smSkillCategory').value = currentSkillCategory || '';
        return;
    }
    
    // Get selected students
    const studentSelect = document.getElementById('smStudentSelect');
    const selectedStudents = Array.from(studentSelect?.selectedOptions || [])
        .filter(opt => !opt.disabled)
        .map(option => parseInt(option.value));

    console.log('üìã Selected students:', selectedStudents);
    console.log('üìã Skill category:', selectedCategory);

    if (selectedStudents.length === 0) {
        showNotification('Please select at least one student', 'error');
        return;
    }
    
    // Validate task title
    const taskTitle = document.getElementById('smTaskTitle')?.value?.trim();
    if (!taskTitle) {
        showNotification('Please enter a task title', 'error');
        return;
    }

    // Build task data
    const taskData = {
        student_ids: selectedStudents,
        task_type: selectedCategory,
        skill_category: selectedCategory,
        task_title: taskTitle,
        task_description: document.getElementById('smTaskDescription')?.value?.trim() || '',
        week_number: parseInt(document.getElementById('smWeekNumber')?.value) || null,
        day_number: parseInt(document.getElementById('smDayNumber')?.value) || null,
        lesson_type: document.getElementById('smLessonType')?.value || 'lesson',
        video_url: document.getElementById('smVideoUrl')?.value?.trim() || null,
        zoom_passcode: document.getElementById('smZoomPasscode')?.value?.trim() || null,
        duration: document.getElementById('smDuration')?.value?.trim() || null,
        access_code: document.getElementById('smAccessCode')?.value?.trim() || null,
        points_reward: parseInt(document.getElementById('smPointsReward')?.value) || 0,
        due_date: document.getElementById('smDueDate')?.value || null
    };

    console.log('üì¶ Task data:', taskData);

    showLoading();
    
    try {
        console.log('üì° Sending request...');
        
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/assign-tasks',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            }
        );

        console.log('üì• Response status:', response.status);
        const result = await response.json();
        console.log('üì• Response data:', result);

        if (response.ok && result.success) {
            showNotification(`‚úÖ Task assigned to ${result.assigned_tasks.length} students!`);
            
            // Reset form
            document.getElementById('assignSocialMediaTaskForm').reset();
            updateSelectedCount();
            
            // Reload data
            await loadSocialMediaAssignments();
            
            // Reset category
            currentSkillCategory = null;
            resetStudentSection();
        } else {
            let errorMessage = result.error || 'Failed to assign task';
            
            if (result.missing_details) {
                errorMessage += '\n\nMissing students:';
                result.missing_details.forEach(detail => {
                    errorMessage += `\n‚Ä¢ ${detail.name || `ID ${detail.id}`}: ${detail.reason}`;
                });
            }
            
            throw new Error(errorMessage);
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ==================== LOAD ASSIGNMENTS ====================

async function loadSocialMediaAssignments() {
    showLoading();
    try {
        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/tasks'
        );

        if (response.ok) {
            const data = await response.json();
            socialMediaTasks = data.tasks || [];
            renderSMAssignmentsTable(socialMediaTasks);
            console.log(`‚úÖ Loaded ${socialMediaTasks.length} assignments`);
        } else {
            throw new Error('Failed to load assignments');
        }
    } catch (error) {
        console.error('Error loading assignments:', error);
        showNotification('Failed to load assignments', 'error');
    } finally {
        hideLoading();
    }
}

function renderSMAssignmentsTable(tasks) {
    const tbody = document.getElementById('smAssignmentsTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No assignments found</td></tr>';
        return;
    }

    tasks.forEach(task => {
        const row = document.createElement('tr');
        const statusClass = task.status === 'completed' ? 'status-completed' : 
                           task.status === 'in_progress' ? 'status-pending' : 'status-active';

        row.innerHTML = `
            <td><input type="checkbox" class="task-checkbox" value="${task.id}"></td>
            <td>
                <div style="font-weight: 600;">${task.task_title}</div>
                <div style="font-size: 0.875rem; color: var(--gray-500);">${task.lesson_type || 'Lesson'}</div>
            </td>
            <td>
                <div>${task.student_info?.name || 'Unknown'}</div>
                <div style="font-size: 0.875rem; color: var(--gray-500);">${task.student_info?.email || ''}</div>
            </td>
            <td style="text-transform: capitalize; font-weight: 600;">${task.skill_category.replace('-', ' ')}</td>
            <td>${task.week_number ? `Week ${task.week_number}` : '‚Äî'} / ${task.day_number ? `Day ${task.day_number}` : '‚Äî'}</td>
            <td><span class="status-badge ${statusClass}">${task.status === 'completed' ? 'Completed' : task.status === 'in_progress' ? 'In Progress' : 'Pending'}</span></td>
            <td>${task.points_reward || 0}</td>
            <td>${new Date(task.assigned_at).toLocaleDateString()}</td>
            <td>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-secondary btn-sm" onclick="viewSMTask(${task.id})" title="View">üëÅÔ∏è</button>
                    <button class="btn btn-primary btn-sm" onclick="editSMTask(${task.id})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSMTask(${task.id})" title="Delete">üóëÔ∏è</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// ==================== RENDER STUDENTS TABLE ====================

function renderSMStudentsTable() {
    const tbody = document.getElementById('smStudentsTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (socialMediaStudents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No students found</td></tr>';
        return;
    }

    socialMediaStudents.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div style="font-weight: 600;">${student.full_name}</div>
                <div style="font-size: 0.875rem; color: var(--gray-500);">ID: ${student.id}</div>
            </td>
            <td>${student.username}</td>
            <td>${student.email}</td>
            <td>
                <span class="status-badge" style="background: rgba(139, 92, 246, 0.1); color: var(--purple-500);">
                    ${student.skill_level}
                </span>
            </td>
            <td>${student.total_tasks_completed || 0}</td>
            <td>${student.total_points || 0}</td>
            <td>
                <span class="status-badge ${student.is_active ? 'status-active' : 'status-inactive'}">
                    ${student.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-secondary btn-sm" onclick="viewSMStudent(${student.id})">üëÅÔ∏è View</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// ==================== FILTER FUNCTIONS ====================

function filterSocialMediaAssignments() {
    const statusFilter = document.getElementById('smStatusFilter')?.value;
    const filtered = statusFilter ? 
        socialMediaTasks.filter(task => task.status === statusFilter) : 
        socialMediaTasks;
    renderSMAssignmentsTable(filtered);
}

function filterSocialMediaStudents() {
    const search = document.getElementById('smStudentsSearch')?.value.toLowerCase() || '';
    const tbody = document.getElementById('smStudentsTableBody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

// ==================== VIEW FUNCTIONS ====================

function viewSMTask(taskId) {
    const task = socialMediaTasks.find(t => t.id === taskId);
    if (!task) return;

    const details = `
Task: ${task.task_title}
Student: ${task.student_info?.name || 'Unknown'}
Category: ${task.skill_category}
Status: ${task.status}
Points: ${task.points_reward || 0}
Week/Day: ${task.week_number ? `Week ${task.week_number}` : '‚Äî'} / ${task.day_number ? `Day ${task.day_number}` : '‚Äî'}
Video URL: ${task.video_url || 'N/A'}
Assigned: ${new Date(task.assigned_at).toLocaleString()}
    `.trim();
    
    alert(details);
}

function viewSMStudent(studentId) {
    const student = socialMediaStudents.find(s => s.id === studentId);
    if (!student) return;

    const details = `
Name: ${student.full_name}
Username: ${student.username}
Email: ${student.email}
Skill Level: ${student.skill_level}
Tasks Completed: ${student.total_tasks_completed || 0}
Total Points: ${student.total_points || 0}
Status: ${student.is_active ? 'Active' : 'Inactive'}
    `.trim();
    
    alert(details);
}

// ==================== EDIT TASK ====================

function editSMTask(taskId) {
    const task = socialMediaTasks.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    document.getElementById('editSMTaskId').value = task.id;
    document.getElementById('editSMTaskTitle').value = task.task_title || '';
    document.getElementById('editSMSkillCategory').value = task.skill_category || 'social-media';
    document.getElementById('editSMWeekNumber').value = task.week_number || '';
    document.getElementById('editSMDayNumber').value = task.day_number || '';
    document.getElementById('editSMLessonType').value = task.lesson_type || 'lesson';
    document.getElementById('editSMDuration').value = task.duration || '';
    document.getElementById('editSMVideoUrl').value = task.video_url || '';
    document.getElementById('editSMZoomPasscode').value = task.zoom_passcode || '';
    document.getElementById('editSMAccessCode').value = task.access_code || '';
    document.getElementById('editSMPointsReward').value = task.points_reward || 0;
    document.getElementById('editSMTaskDescription').value = task.task_description || '';
    document.getElementById('editSMStatus').value = task.status || 'pending';

    if (task.due_date) {
        const dueDate = new Date(task.due_date);
        document.getElementById('editSMDueDate').value = dueDate.toISOString().slice(0, 16);
    } else {
        document.getElementById('editSMDueDate').value = '';
    }

    document.getElementById('editSMTaskModal').style.display = 'flex';
}

function closeEditSMTaskModal() {
    document.getElementById('editSMTaskModal').style.display = 'none';
    document.getElementById('editSMTaskForm').reset();
}

async function handleEditSMTaskSubmit() {
    const taskId = document.getElementById('editSMTaskId').value;

    const taskData = {
        task_title: document.getElementById('editSMTaskTitle').value,
        skill_category: document.getElementById('editSMSkillCategory').value,
        task_description: document.getElementById('editSMTaskDescription').value,
        week_number: parseInt(document.getElementById('editSMWeekNumber').value) || null,
        day_number: parseInt(document.getElementById('editSMDayNumber').value) || null,
        lesson_type: document.getElementById('editSMLessonType').value,
        video_url: document.getElementById('editSMVideoUrl').value || null,
        zoom_passcode: document.getElementById('editSMZoomPasscode').value || null,
        duration: document.getElementById('editSMDuration').value || null,
        access_code: document.getElementById('editSMAccessCode').value || null,
        points_reward: parseInt(document.getElementById('editSMPointsReward').value) || 0,
        due_date: document.getElementById('editSMDueDate').value || null,
        status: document.getElementById('editSMStatus').value
    };

    showLoading();

    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/task/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify(taskData)
        });

        if (response.ok) {
            showNotification('‚úÖ Task updated successfully!');
            closeEditSMTaskModal();
            loadSocialMediaAssignments();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update task');
        }
    } catch (error) {
        console.error('‚ùå Error updating task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ==================== DELETE TASK ====================

async function deleteSMTask(taskId) {
    const task = socialMediaTasks.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }

    if (!confirm(`Delete task "${task.task_title}"?\n\nStudent: ${task.student_info?.name || 'Unknown'}\n\nThis cannot be undone!`)) {
        return;
    }

    showLoading();

    try {
        const response = await fetch(`https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/task/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAdminToken()}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            showNotification('‚úÖ Task deleted successfully!');
            loadSocialMediaAssignments();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete task');
        }
    } catch (error) {
        console.error('‚ùå Error deleting task:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function bulkDeleteSMTasks() {
    const checkboxes = document.querySelectorAll('.task-checkbox:checked');
    const taskIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    if (taskIds.length === 0) {
        showNotification('Please select tasks to delete', 'error');
        return;
    }

    if (!confirm(`Delete ${taskIds.length} task(s)?\n\nThis cannot be undone!`)) {
        return;
    }

    showLoading();

    try {
        const response = await fetch('https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/tasks/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAdminToken()}`
            },
            body: JSON.stringify({ task_ids: taskIds })
        });

        if (response.ok) {
            const result = await response.json();
            showNotification(`‚úÖ Successfully deleted ${result.deleted_count} tasks!`);
            loadSocialMediaAssignments();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete tasks');
        }
    } catch (error) {
        console.error('‚ùå Error bulk deleting tasks:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ==================== NAVIGATION INTEGRATION ====================

const originalNavigateToPage = typeof navigateToPage !== 'undefined' ? navigateToPage : null;
if (originalNavigateToPage) {
    navigateToPage = function(page) {
        originalNavigateToPage(page);
        
        if (page === 'social-media-assign') {
            setTimeout(() => {
                initializeSocialMediaManagement();
            }, 100);
        }
    };
}

// ==================== EDIT FORM SETUP ====================

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editSMTaskForm');
    if (editForm) {
        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleEditSMTaskSubmit();
        });
    }

    // Setup create student button
    const createStudentBtn = document.getElementById('createSMStudentBtn');
    if (createStudentBtn) {
        createStudentBtn.addEventListener('click', openCreateStudentModal);
    }

    // Setup create student form
    const createStudentForm = document.getElementById('createStudentForm');
    if (createStudentForm) {
        createStudentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleCreateStudent();
        });
    }
});

// ==================== STUDENT CREATION ====================

function openCreateStudentModal() {
    document.getElementById('createStudentModal').style.display = 'flex';
    document.getElementById('createStudentForm').reset();
}

function closeCreateStudentModal() {
    document.getElementById('createStudentModal').style.display = 'none';
    document.getElementById('createStudentForm').reset();
}

async function handleCreateStudent() {
    showLoading();

    try {
        const studentData = {
            full_name: document.getElementById('newStudentName').value.trim(),
            username: document.getElementById('newStudentUsername').value.trim(),
            email: document.getElementById('newStudentEmail').value.trim(),
            password: document.getElementById('newStudentPassword').value,
            category: document.getElementById('newStudentCategory').value,
            skill_level: document.getElementById('newStudentSkillLevel').value || 'Beginner',
            phone_number: document.getElementById('newStudentPhone').value.trim() || null,
            location: document.getElementById('newStudentLocation').value.trim() || null,
            bio: document.getElementById('newStudentBio').value.trim() || null
        };

        // Validation
        if (!studentData.full_name || !studentData.username || !studentData.email || !studentData.password || !studentData.category) {
            showNotification('Please fill in all required fields', 'error');
            hideLoading();
            return;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(studentData.email)) {
            showNotification('Please enter a valid email address', 'error');
            hideLoading();
            return;
        }

        console.log('Creating student:', studentData);

        const response = await TokenManager.makeAuthenticatedRequest(
            'https://seashell-app-onfk3.ondigitalocean.app/api/admin/social-media/student/create',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            }
        );

        if (response.ok) {
            const result = await response.json();
            showNotification(`‚úÖ Student ${result.student.full_name} created successfully!`);
            closeCreateStudentModal();

            // Reload student list
            await loadSocialMediaStudents();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create student');
        }
    } catch (error) {
        console.error('‚ùå Error creating student:', error);
        showNotification(error.message, 'error');
    } finally {
        hideLoading();
    }
}

console.log('‚úÖ Social Media Management Module Loaded');

// ==================== LINK CONFIGURATION FUNCTIONS ====================

// Switch between link types (internal/external/common)
function switchLinkType(type) {
    // Update tabs
    document.querySelectorAll('.link-type-tab').forEach(tab => {
        tab.classList.toggle('active', tab.getAttribute('data-type') === type);
    });

    // Update options
    document.querySelectorAll('.link-option').forEach(option => {
        option.classList.remove('active');
    });

    const activeOption = document.getElementById(`${type}-option`);
    if (activeOption) {
        activeOption.classList.add('active');
    }

    // Clear other inputs when switching
    if (type !== 'internal') {
        const taskFileInput = document.getElementById('taskFile');
        if (taskFileInput) taskFileInput.value = '';
    }
    if (type !== 'external') {
        const externalUrlInput = document.getElementById('externalTaskUrl');
        if (externalUrlInput) {
            externalUrlInput.value = '';
            const preview = document.getElementById('externalLinkPreview');
            if (preview) preview.classList.remove('show');
        }
    }
    if (type !== 'common') {
        const customCommonInput = document.getElementById('customCommonUrl');
        if (customCommonInput) customCommonInput.value = '';
        document.querySelectorAll('.common-link-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
    }
}

// Validate external URL
function validateExternalUrl() {
    const input = document.getElementById('externalTaskUrl');
    const validator = document.getElementById('urlValidator');
    const preview = document.getElementById('externalLinkPreview');
    const previewUrl = document.getElementById('previewUrl');

    if (!input || !validator) return;

    const url = input.value.trim();

    if (!url) {
        validator.className = 'url-validator empty';
        validator.innerHTML = '<span>üí° Enter any valid URL (must start with http:// or https://)</span>';
        if (preview) preview.classList.remove('show');
        return;
    }

    try {
        const urlObj = new URL(url);
        if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
            validator.className = 'url-validator valid';
            validator.innerHTML = '<span>‚úÖ Valid URL</span>';
            if (previewUrl) previewUrl.textContent = url;
            if (preview) preview.classList.add('show');
        } else {
            throw new Error('Invalid protocol');
        }
    } catch (error) {
        validator.className = 'url-validator invalid';
        validator.innerHTML = '<span>‚ùå Please enter a valid URL starting with http:// or https://</span>';
        if (preview) preview.classList.remove('show');
    }
}

// Initialize common links
function initializeCommonLinks() {
    const commonLinks = [
        {
            name: 'Khan Academy Math',
            url: 'https://www.khanacademy.org/math',
            description: 'Math lessons and exercises'
        },
        {
            name: 'Coursera',
            url: 'https://www.coursera.org',
            description: 'Online courses'
        },
        {
            name: 'edX',
            url: 'https://www.edx.org',
            description: 'University-level courses'
        },
        {
            name: 'Duolingo',
            url: 'https://www.duolingo.com',
            description: 'Language learning'
        },
        {
            name: 'Code.org',
            url: 'https://code.org/learn',
            description: 'Learn to code'
        },
        {
            name: 'TED-Ed',
            url: 'https://ed.ted.com',
            description: 'Educational videos'
        },
        {
            name: 'NASA Education',
            url: 'https://www.nasa.gov/stem',
            description: 'STEM resources'
        },
        {
            name: 'National Geographic Kids',
            url: 'https://kids.nationalgeographic.com',
            description: 'Science and nature'
        }
    ];

    const grid = document.getElementById('commonLinksGrid');
    if (!grid) return;

    grid.innerHTML = '';

    commonLinks.forEach(link => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'common-link-btn';
        btn.onclick = () => selectCommonLink(btn);
        btn.innerHTML = `
            <div class="common-link-name">${link.name}</div>
            <div class="common-link-url">${link.url}</div>
            <div class="common-link-description">${link.description}</div>
        `;
        grid.appendChild(btn);
    });
}

// Select a common link
function selectCommonLink(button) {
    const wasSelected = button.classList.contains('selected');

    // Clear all selections
    document.querySelectorAll('.common-link-btn.selected').forEach(btn => {
        btn.classList.remove('selected');
    });

    // Clear custom URL input
    const customInput = document.getElementById('customCommonUrl');
    if (customInput) customInput.value = '';

    // Toggle selection
    if (!wasSelected) {
        button.classList.add('selected');
    }
}

// Get current task link  configuration
function getCurrentTaskLinkConfig() {
    const activeTab = document.querySelector('.link-type-tab.active');
    if (!activeTab) return null;

    const type = activeTab.getAttribute('data-type');
    let config = { type: type };

    switch (type) {
        case 'internal':
            const taskFile = document.getElementById('taskFile')?.value.trim();
            if (taskFile) {
                config.task_file = taskFile;
                config.external_url = `https://deciphersacad.online//${taskFile}`;
            }
            break;

        case 'external':
            const externalUrl = document.getElementById('externalTaskUrl')?.value.trim();
            if (externalUrl) {
                try {
                    new URL(externalUrl); // Validate URL
                    config.external_url = externalUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;

        case 'common':
            const selectedCommonLink = document.querySelector('.common-link-btn.selected');
            const customCommonUrl = document.getElementById('customCommonUrl')?.value.trim();

            if (selectedCommonLink) {
                const url = selectedCommonLink.querySelector('.common-link-url').textContent;
                config.external_url = url;
            } else if (customCommonUrl) {
                try {
                    new URL(customCommonUrl); // Validate URL
                    config.external_url = customCommonUrl;
                } catch (error) {
                    return null; // Invalid URL
                }
            }
            break;
    }

    return config;
}

// Initialize common links when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCommonLinks();
});

    </script>
    <!-- Edit Social Media Task Modal -->
<div class="modal" id="editSMTaskModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Edit Social Media Task</h3>
            <button class="modal-close" onclick="closeEditSMTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editSMTaskForm">
                <input type="hidden" id="editSMTaskId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" id="editSMTaskTitle" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Skill Category</label>
                        <select class="form-input" id="editSMSkillCategory" required>
                            <option value="social-media">Social Media Management</option>
                            <option value="video-editing">Video Editing</option>
                            <option value="graphics-design">Graphics Design</option>
                            <option value="coding">Coding</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Week Number</label>
                        <select class="form-input" id="editSMWeekNumber">
                            <option value="">No specific week</option>
                            <option value="1">Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                            <option value="4">Week 4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Day Number</label>
                        <select class="form-input" id="editSMDayNumber">
                            <option value="">No specific day</option>
                            <option value="1">Day 1</option>
                            <option value="2">Day 2</option>
                            <option value="3">Day 3</option>
                            <option value="4">Day 4</option>
                            <option value="5">Day 5</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lesson Type</label>
                        <select class="form-input" id="editSMLessonType">
                            <option value="lesson">Lesson</option>
                            <option value="live">Live Session</option>
                            <option value="practical">Practical</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-input" id="editSMDuration" placeholder="e.g., 45 min">
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">Video/Content URL</label>
                        <input type="url" class="form-input" id="editSMVideoUrl" placeholder="https://example.com/video-lesson">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Zoom Passcode</label>
                        <input type="text" class="form-input" id="editSMZoomPasscode" placeholder="Enter passcode">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Access Code</label>
                        <input type="text" class="form-input" id="editSMAccessCode" placeholder="e.g., SMMC1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Points Reward</label>
                        <input type="number" class="form-input" id="editSMPointsReward" min="0" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="datetime-local" class="form-input" id="editSMDueDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editSMStatus">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Task Description</label>
                    <textarea class="form-input form-textarea" id="editSMTaskDescription" rows="4"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        üíæ Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditSMTaskModal()">
                        ‚ùå Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Student Modal -->
<div class="modal" id="createStudentModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Create New Student</h3>
            <button class="modal-close" onclick="closeCreateStudentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createStudentForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="newStudentName" required placeholder="Enter student's full name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-input" id="newStudentUsername" required placeholder="Choose a username">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="newStudentEmail" required placeholder="student@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" id="newStudentPassword" required placeholder="Enter password">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Skill Category *</label>
                        <select class="form-input" id="newStudentCategory" required>
                            <option value="">Select Category</option>
                            <option value="social-media">Social Media Management</option>
                            <option value="video-editing">Video Editing</option>
                            <option value="graphics-design">Graphics Design</option>
                            <option value="coding">Coding</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Skill Level</label>
                        <select class="form-input" id="newStudentSkillLevel">
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="newStudentPhone" placeholder="+1234567890">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="newStudentLocation" placeholder="City, Country">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Bio (Optional)</label>
                    <textarea class="form-input form-textarea" id="newStudentBio" rows="3" placeholder="Brief description about the student"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        ‚úÖ Create Student
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateStudentModal()">
                        ‚ùå Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>